<?php

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Authentication and User Management
 * Handles signup, login, and designer role management
 */
class N88_RFQ_Auth {

    /**
     * Commit 2.3.7.1: System-invited route expiry window (in seconds)
     * Production: 172800 (48 hours)
     * Testing: 3600 (60 minutes = 1 hour)
     * 
     * To change from testing to production, update this constant to 172800
     */
    const N88_SYSTEM_INVITED_EXPIRY_SECONDS = 172800; // 60 minutes for testing (change to 172800 for 48 hours)

    public function __construct() {
        // Register shortcodes
        add_shortcode( 'n88_signup', array( $this, 'render_signup_form' ) );
        add_shortcode( 'n88_login', array( $this, 'render_login_form' ) );
        add_shortcode( 'n88_designer_dashboard', array( $this, 'render_designer_dashboard' ) );

        // Commit 2.2.1: Register new route shortcodes
        add_shortcode( 'n88_workspace', array( $this, 'render_workspace' ) );
        add_shortcode( 'n88_supplier_queue', array( $this, 'render_supplier_queue' ) );
        add_shortcode( 'n88_admin_queue', array( $this, 'render_admin_queue' ) );
        
        // Commit 2.3.9.1C: Operator Queue for CAD + Prototype requests
        add_shortcode( 'n88_operator_queue', array( $this, 'render_operator_queue' ) );
        
        // Commit 2.2.7: Supplier onboarding
        add_shortcode( 'n88_supplier_onboarding', array( $this, 'render_supplier_onboarding' ) );
        
        // Commit 2.2.8: Designer onboarding
        add_shortcode( 'n88_designer_onboarding', array( $this, 'render_designer_onboarding' ) );

        // AJAX handlers
        add_action( 'wp_ajax_n88_register_user', array( $this, 'ajax_register_user' ) );
        add_action( 'wp_ajax_nopriv_n88_register_user', array( $this, 'ajax_register_user' ) );
        add_action( 'wp_ajax_n88_login_user', array( $this, 'ajax_login_user' ) );
        add_action( 'wp_ajax_nopriv_n88_login_user', array( $this, 'ajax_login_user' ) );

        // Commit 2.2.7: Supplier profile save handler
        add_action( 'wp_ajax_n88_save_supplier_profile', array( $this, 'ajax_save_supplier_profile' ) );
        
        // Commit 2.2.7: AJAX handler to fetch keywords by category
        add_action( 'wp_ajax_n88_get_keywords_by_category', array( $this, 'ajax_get_keywords_by_category' ) );
        
        // Commit 2.2.8: Designer profile save handler
        add_action( 'wp_ajax_n88_save_designer_profile', array( $this, 'ajax_save_designer_profile' ) );
        
        // Commit 2.3.2: Supplier RFQ detail view (read-only)
        add_action( 'wp_ajax_n88_get_supplier_item_details', array( $this, 'ajax_get_supplier_item_details' ) );
        add_action( 'wp_ajax_n88_get_item_rfq_state', array( $this, 'ajax_get_item_rfq_state' ) );
        
        // Commit 2.3.3: Supplier bid validation (no persistence)
        add_action( 'wp_ajax_n88_validate_supplier_bid', array( $this, 'ajax_validate_supplier_bid' ) );
        // Commit 2.3.5: Supplier bid submission (persistence)
        add_action( 'wp_ajax_n88_submit_supplier_bid', array( $this, 'ajax_submit_supplier_bid' ) );
        // Commit 2.3.5: Withdraw bid (optional)
        add_action( 'wp_ajax_n88_withdraw_supplier_bid', array( $this, 'ajax_withdraw_supplier_bid' ) );
        
        // Commit 2.3.6: Save bid draft
        add_action( 'wp_ajax_n88_save_bid_draft', array( $this, 'ajax_save_bid_draft' ) );
        
        // Commit 2.4.1: Award bid (designer action)
        add_action( 'wp_ajax_n88_award_bid', array( $this, 'ajax_award_bid' ) );
        
        // Commit 2.6.1: Invite team member (designer action)
        add_action( 'wp_ajax_n88_invite_team_member', array( $this, 'ajax_invite_team_member' ) );
        // Commit 2.6.1: Accept team invitation (first-time login)
        add_action( 'wp_ajax_nopriv_n88_accept_team_invitation', array( $this, 'ajax_accept_team_invitation' ) );
        add_action( 'wp_ajax_n88_get_bid_draft', array( $this, 'ajax_get_bid_draft' ) );
        
        // G) Update bid to match new specs (create new draft from stale bid)
        add_action( 'wp_ajax_n88_update_bid_to_match_new_specs', array( $this, 'ajax_update_bid_to_match_new_specs' ) );
        
        // Commit 2.3.4: RFQ submission routing
        add_action( 'wp_ajax_n88_submit_rfq', array( $this, 'ajax_submit_rfq' ) );

        // Commit 2.3.9.1A: CAD + Prototype request endpoint
        add_action( 'wp_ajax_n88_create_cad_prototype_request', array( $this, 'ajax_create_cad_prototype_request' ) );
        
        // Commit 2.3.9.1C: Operator Queue - Get case details
        add_action( 'wp_ajax_n88_get_operator_case_details', array( $this, 'ajax_get_operator_case_details' ) );
        
        // Commit 2.3.9.1C-a: Item Messages - Get and Send messages
        add_action( 'wp_ajax_n88_get_item_messages', array( $this, 'ajax_get_item_messages' ) );
        add_action( 'wp_ajax_n88_send_item_message', array( $this, 'ajax_send_item_message' ) );
        
        // Commit 2.3.9.1C-a: Mark payment received
        add_action( 'wp_ajax_n88_mark_payment_received', array( $this, 'ajax_mark_payment_received' ) );

        // Fix #13/#26: Mark Resolved â€” clear Action Required for operator/supplier/designer
        add_action( 'wp_ajax_n88_mark_clarification_resolved', array( $this, 'ajax_mark_clarification_resolved' ) );
        // Supplier confirms clarification (operator sees via case_resolutions)
        add_action( 'wp_ajax_n88_supplier_confirm_clarification', array( $this, 'ajax_supplier_confirm_clarification' ) );

        // Payment receipt: designer upload (JPG/PDF); operator views before mark received
        add_action( 'wp_ajax_n88_upload_payment_receipt', array( $this, 'ajax_upload_payment_receipt' ) );
        add_action( 'wp_ajax_n88_get_payment_receipts', array( $this, 'ajax_get_payment_receipts' ) );

        // Commit 2.3.9.2A: CAD workflow v1
        add_action( 'wp_ajax_n88_upload_cad_files', array( $this, 'ajax_upload_cad_files' ) );
        add_action( 'wp_ajax_n88_request_cad_revision', array( $this, 'ajax_request_cad_revision' ) );
        add_action( 'wp_ajax_n88_approve_cad', array( $this, 'ajax_approve_cad' ) );
        add_action( 'wp_ajax_n88_release_cad_to_supplier', array( $this, 'ajax_release_cad_to_supplier' ) );
        // Commit 2.3.9.2B-S: Prototype video submission
        add_action( 'wp_ajax_n88_submit_prototype_video', array( $this, 'ajax_submit_prototype_video' ) );
        
        // Commit 2.3.9.2B-D: Designer prototype review AJAX handlers
        add_action( 'wp_ajax_n88_approve_prototype', array( $this, 'ajax_approve_prototype' ) );
        add_action( 'wp_ajax_n88_request_prototype_changes', array( $this, 'ajax_request_prototype_changes' ) );
        add_action( 'wp_ajax_n88_get_keyword_phrases', array( $this, 'ajax_get_keyword_phrases' ) );

        // Commit 3.A.1: Item timeline spine (read-only for designer/supplier; operator can start/complete)
        add_action( 'wp_ajax_n88_get_item_timeline', array( $this, 'ajax_get_item_timeline' ) );
        add_action( 'wp_ajax_n88_timeline_start_step', array( $this, 'ajax_timeline_start_step' ) );
        add_action( 'wp_ajax_n88_timeline_complete_step', array( $this, 'ajax_timeline_complete_step' ) );
        add_action( 'wp_ajax_n88_timeline_set_evidence_verified', array( $this, 'ajax_timeline_set_evidence_verified' ) );

        // Commit 3.A.2: Timeline step evidence (upload, list, serve watermarked)
        add_action( 'wp_ajax_n88_upload_timeline_step_evidence', array( $this, 'ajax_upload_timeline_step_evidence' ) );
        add_action( 'wp_ajax_n88_get_timeline_step_evidence', array( $this, 'ajax_get_timeline_step_evidence' ) );
        add_action( 'wp_ajax_n88_serve_timeline_evidence', array( $this, 'ajax_serve_timeline_evidence' ) );

        // Commit 3.A.3: Evidence comments (designer add; designer + operator/admin view)
        add_action( 'wp_ajax_n88_add_evidence_comment', array( $this, 'ajax_add_evidence_comment' ) );
        add_action( 'wp_ajax_n88_get_evidence_comments', array( $this, 'ajax_get_evidence_comments' ) );

        // Commit 3.A.2S: Supplier step evidence (video links, append-only)
        add_action( 'wp_ajax_n88_supplier_submit_step_evidence', array( $this, 'ajax_supplier_submit_step_evidence' ) );
        add_action( 'wp_ajax_n88_get_step_evidence', array( $this, 'ajax_get_step_evidence' ) );

        // Create custom roles on activation
        add_action( 'init', array( $this, 'create_custom_roles' ) );

        // Redirect designers to custom dashboard after login
        add_filter( 'login_redirect', array( $this, 'redirect_designer_after_login' ), 10, 3 );
        add_action( 'wp_login', array( $this, 'handle_designer_login' ), 10, 2 );

        // Redirect logout to custom login page
        add_filter( 'logout_url', array( $this, 'custom_logout_url' ), 10, 2 );
        add_action( 'wp_logout', array( $this, 'redirect_after_logout' ) );
        add_action( 'init', array( $this, 'handle_custom_logout' ) );

        // Hide WordPress admin menus for designers
        add_action( 'admin_menu', array( $this, 'hide_wp_menus_for_designer' ), 999 );
        add_action( 'admin_bar_menu', array( $this, 'remove_wp_admin_bar_items' ), 999 );
        
        // Hide WordPress admin bar completely for designers and suppliers
        add_filter( 'show_admin_bar', array( $this, 'hide_admin_bar_for_custom_roles' ) );

        // Redirect designers away from WordPress admin pages
        add_action( 'admin_init', array( $this, 'redirect_designer_from_wp_admin' ) );

        // Enqueue styles
        add_action( 'wp_enqueue_scripts', array( $this, 'enqueue_auth_styles' ) );

        // Route guards (Commit 2.2.1)
        add_action( 'template_redirect', array( $this, 'enforce_route_guards' ) );
        add_action( 'admin_init', array( $this, 'enforce_admin_route_guards' ) );
    }

    /**
     * Create custom roles with appropriate capabilities (Commit 2.2.1)
     */
    public function create_custom_roles() {
        // Create n88_designer role
        if ( ! get_role( 'n88_designer' ) ) {
        add_role(
                'n88_designer',
            __( 'Creator', 'n88-rfq' ),
            array(
                'read' => true,
                'upload_files' => true,
                    // Legacy capabilities for backward compatibility
                'n88_access_boards' => true,
                'n88_access_items' => true,
                'n88_access_projects' => true,
            )
        );
        }

        // Create n88_supplier_admin role
        if ( ! get_role( 'n88_supplier_admin' ) ) {
            add_role(
                'n88_supplier_admin',
                __( 'Maker', 'n88-rfq' ),
                array(
                    'read' => true,
                    'n88_view_supplier_queue' => true,
                )
            );
        }

        // Create n88_system_operator role
        if ( ! get_role( 'n88_system_operator' ) ) {
            add_role(
                'n88_system_operator',
                __( 'System Operator', 'n88-rfq' ),
                array(
                    'read' => true,
                    'n88_view_supplier_queue' => true,
                    'n88_view_global_queue' => true,
                    'manage_options' => true, // Full admin access
                )
            );
        }

        // Migrate existing 'designer' role to 'n88_designer' if it exists
        $old_designer_role = get_role( 'designer' );
        if ( $old_designer_role ) {
            // Get all users with old designer role
            $users = get_users( array( 'role' => 'designer' ) );
            foreach ( $users as $user ) {
                $user_obj = new WP_User( $user->ID );
                $user_obj->remove_role( 'designer' );
                $user_obj->add_role( 'n88_designer' );
            }
            // Remove old role (optional - keeping for backward compatibility during migration)
            // remove_role( 'designer' );
        }
    }

    /**
     * Enqueue authentication styles
     */
    public function enqueue_auth_styles() {
        if ( defined( 'N88_RFQ_PLUGIN_URL' ) ) {
            $plugin_url = trailingslashit( N88_RFQ_PLUGIN_URL );
        } else {
            $plugin_file = dirname( dirname( __FILE__ ) ) . '/n88-rfq-platform.php';
            $plugin_url = trailingslashit( plugin_dir_url( $plugin_file ) );
        }

        wp_enqueue_style(
            'n88-rfq-auth',
            $plugin_url . 'assets/css/n88-rfq-auth.css',
            array(),
            N88_RFQ_VERSION
        );
    }

    /**
     * Render signup form shortcode
     */
    public function render_signup_form( $atts = array() ) {
        // If user is already logged in, redirect or show message
        if ( is_user_logged_in() ) {
            $current_user = wp_get_current_user();
            if ( in_array( 'n88_designer', $current_user->roles ) || in_array( 'designer', $current_user->roles ) ) {
                return '<p>You are already logged in. <a href="' . esc_url( home_url( '/workspace' ) ) . '">Go to Workspace</a></p>';
            }
            return '<p>You are already logged in.</p>';
        }

        $message = '';
        $message_type = '';

        // Check for messages from redirect
        if ( isset( $_GET['n88_signup_error'] ) ) {
            $message_type = 'error';
            $message = isset( $_GET['n88_error_msg'] ) ? sanitize_text_field( wp_unslash( $_GET['n88_error_msg'] ) ) : 'Registration failed. Please try again.';
        }

        if ( isset( $_GET['n88_signup_success'] ) ) {
            $message_type = 'success';
            $message = 'Registration successful! Please log in.';
        }

        ob_start();
        ?>
        <div class="n88-auth-container n88-signup-container">
            <div class="n88-auth-form-wrapper">
                <h2 class="n88-auth-title">Create Account</h2>
                
                <?php if ( $message ) : ?>
                    <div class="n88-auth-message n88-auth-message-<?php echo esc_attr( $message_type ); ?>">
                        <?php echo esc_html( $message ); ?>
                    </div>
                <?php endif; ?>

                <form id="n88-signup-form" class="n88-auth-form" method="post">
                    <?php wp_nonce_field( 'n88_register_user', 'n88_signup_nonce' ); ?>
                    
                    <div class="n88-form-group">
                        <label>Account Type <span class="required">*</span></label>
                        <div style="display: flex; gap: 20px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="user_role" value="n88_designer" checked required style="margin: 0;">
                                <span>Creator</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="user_role" value="n88_supplier_admin" required style="margin: 0;">
                                <span>Maker</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="n88-form-group">
                        <label for="n88_signup_name">Full Name <span class="required">*</span></label>
                        <input type="text" id="n88_signup_name" name="name" required>
                    </div>

                    <div class="n88-form-group">
                        <label for="n88_signup_username">Username <span class="required">*</span></label>
                        <input type="text" id="n88_signup_username" name="username" required>
                    </div>

                    <div class="n88-form-group">
                        <label for="n88_signup_email">Email <span class="required">*</span></label>
                        <input type="email" id="n88_signup_email" name="email" required>
                    </div>

                    <div class="n88-form-group">
                        <label for="n88_signup_password">Password <span class="required">*</span></label>
                        <input type="password" id="n88_signup_password" name="password" required minlength="6">
                    </div>

                    <div class="n88-form-group">
                        <label for="n88_signup_company">Company Name <span class="required">*</span></label>
                        <input type="text" id="n88_signup_company" name="company_name" required>
                    </div>

                    <div class="n88-form-group">
                        <label for="n88_signup_country">Country <span class="required">*</span></label>
                        <select id="n88_signup_country" name="country" required>
                            <option value="">Select Country</option>
                            <?php
                            $countries = $this->get_countries_list();
                            foreach ( $countries as $code => $name ) {
                                echo '<option value="' . esc_attr( $code ) . '">' . esc_html( $name ) . '</option>';
                            }
                            ?>
                        </select>
                    </div>

                    <div class="n88-form-group">
                        <button type="submit" class="n88-auth-submit">Sign Up</button>
                    </div>

                    <div class="n88-auth-footer">
                        <p>Already have an account? <a href="<?php echo esc_url( home_url( '/login/' ) ); ?>">Log In</a></p>
                    </div>
                </form>
            </div>
        </div>

        <script>
        (function() {
            const form = document.getElementById('n88-signup-form');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                formData.append('action', 'n88_register_user');
                
                // Debug: Check if nonce is included
                if (!formData.has('n88_signup_nonce')) {
                    console.error('N88 RFQ: Nonce field missing from form data');
                    alert('Form error: Security token missing. Please refresh the page and try again.');
                    return;
                }

                const submitBtn = form.querySelector('.n88-auth-submit');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Signing Up...';

                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.data.redirect_url || '<?php echo esc_url( home_url( '/login/?n88_signup_success=1' ) ); ?>';
                    } else {
                        alert(data.data.message || 'Registration failed. Please try again.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            });
        })();
        </script>
        <?php
        return ob_get_clean();
    }

    /**
     * Handle logout on custom login page
     */
    public function handle_custom_logout() {
        // Only process on /login page
        if ( ! is_admin() && isset( $_GET['action'] ) && $_GET['action'] === 'logout' ) {
            // Check if we're on the login page (you may need to adjust this check based on your permalink structure)
            $request_uri = isset( $_SERVER['REQUEST_URI'] ) ? esc_url_raw( wp_unslash( $_SERVER['REQUEST_URI'] ) ) : '';
            
            // Check if URL contains /login/
            if ( strpos( $request_uri, '/login/' ) !== false || strpos( $request_uri, '/login' ) !== false ) {
                // Verify nonce
                if ( isset( $_GET['_wpnonce'] ) && wp_verify_nonce( $_GET['_wpnonce'], 'log-out' ) ) {
                    wp_logout();
                    wp_safe_redirect( home_url( '/login/' ) );
                    exit;
                }
            }
        }
    }

    /**
     * Render login form shortcode
     */
    public function render_login_form( $atts = array() ) {
        // If user is already logged in, redirect based on role (Commit 2.2.1)
        if ( is_user_logged_in() ) {
            $current_user = wp_get_current_user();
            $redirect_url = $this->get_role_redirect_url( $current_user );
            if ( $redirect_url ) {
                wp_redirect( $redirect_url );
                exit;
            }
            return '<p>You are already logged in.</p>';
        }

        $message = '';
        $message_type = '';

        // Commit 2.6.1: Check for invitation token
        $invite_token = isset( $_GET['invite_token'] ) ? sanitize_text_field( wp_unslash( $_GET['invite_token'] ) ) : '';
        $invite_email = isset( $_GET['email'] ) ? sanitize_email( wp_unslash( $_GET['email'] ) ) : '';
        $has_invitation = ! empty( $invite_token ) && ! empty( $invite_email );

        // Check for messages
        if ( isset( $_GET['n88_login_error'] ) ) {
            $message_type = 'error';
            $message = isset( $_GET['n88_error_msg'] ) ? sanitize_text_field( wp_unslash( $_GET['n88_error_msg'] ) ) : 'Login failed. Please try again.';
        }

        if ( isset( $_GET['n88_signup_success'] ) ) {
            $message_type = 'success';
            $message = 'Registration successful! Please log in.';
        }

        ob_start();
        ?>
        <div class="n88-auth-container n88-login-container">
            <div class="n88-auth-form-wrapper">
                <?php if ( $has_invitation ) : ?>
                    <!-- Commit 2.6.1: Invitation Acceptance Form -->
                    <h2 class="n88-auth-title">Accept Team Invitation</h2>
                    
                    <?php if ( $message ) : ?>
                        <div class="n88-auth-message n88-auth-message-<?php echo esc_attr( $message_type ); ?>">
                            <?php echo esc_html( $message ); ?>
                        </div>
                    <?php endif; ?>

                    <form id="n88-accept-invitation-form" class="n88-auth-form" method="post">
                        <?php wp_nonce_field( 'n88_accept_team_invitation', '_ajax_nonce' ); ?>
                        <input type="hidden" name="invitation_token" value="<?php echo esc_attr( $invite_token ); ?>">
                        <input type="hidden" name="email" value="<?php echo esc_attr( $invite_email ); ?>">
                        
                        <div class="n88-form-group">
                            <label for="n88_invite_email_display">Email</label>
                            <input type="email" id="n88_invite_email_display" value="<?php echo esc_attr( $invite_email ); ?>" disabled style="background-color: #f5f5f5;">
                            <small style="color: #666; font-size: 12px;">This email was used for your invitation</small>
                        </div>

                        <div class="n88-form-group">
                            <label for="n88_invite_display_name">Display Name (Optional)</label>
                            <input type="text" id="n88_invite_display_name" name="display_name" placeholder="Your name">
                        </div>

                        <div class="n88-form-group">
                            <label for="n88_invite_password">Create Password</label>
                            <input type="password" id="n88_invite_password" name="password" required minlength="8">
                            <small style="color: #666; font-size: 12px;">Password must be at least 8 characters</small>
                        </div>

                        <div class="n88-form-group">
                            <label for="n88_invite_password_confirm">Confirm Password</label>
                            <input type="password" id="n88_invite_password_confirm" name="password_confirm" required minlength="8">
                        </div>

                        <div class="n88-form-group">
                            <button type="submit" class="n88-auth-submit">Create Account & Join Team</button>
                        </div>
                    </form>
                <?php else : ?>
                    <!-- Regular Login Form -->
                    <h2 class="n88-auth-title">Login Your Account</h2>
                    
                    <?php if ( $message ) : ?>
                        <div class="n88-auth-message n88-auth-message-<?php echo esc_attr( $message_type ); ?>">
                            <?php echo esc_html( $message ); ?>
                        </div>
                    <?php endif; ?>

                    <form id="n88-login-form" class="n88-auth-form" method="post">
                        <?php wp_nonce_field( 'n88_login_user', 'n88_login_nonce' ); ?>
                        
                        <div class="n88-form-group">
                            <label for="n88_login_username">Username or Email</label>
                            <input type="text" id="n88_login_username" name="username" required>
                        </div>

                        <div class="n88-form-group">
                            <label for="n88_login_password">Password</label>
                            <input type="password" id="n88_login_password" name="password" required>
                        </div>

                        <div class="n88-form-group">
                            <label class="n88-checkbox-label">
                                <input type="checkbox" name="remember" value="1"> Remember me
                            </label>
                        </div>

                        <div class="n88-form-group">
                            <button type="submit" class="n88-auth-submit">Log In</button>
                        </div>

                        <div class="n88-auth-footer">
                            <p>Don't have an account? <a href="<?php echo esc_url( home_url( '/signup/' ) ); ?>">Sign Up</a></p>
                        </div>
                    </form>
                <?php endif; ?>
            </div>
        </div>

        <script>
        (function() {
            // Commit 2.6.1: Handle invitation acceptance form
            const acceptForm = document.getElementById('n88-accept-invitation-form');
            if (acceptForm) {
                acceptForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const password = document.getElementById('n88_invite_password').value;
                    const passwordConfirm = document.getElementById('n88_invite_password_confirm').value;
                    
                    if (password !== passwordConfirm) {
                        alert('Passwords do not match. Please try again.');
                        return;
                    }
                    
                    if (password.length < 8) {
                        alert('Password must be at least 8 characters long.');
                        return;
                    }
                    
                    const formData = new FormData(acceptForm);
                    formData.append('action', 'n88_accept_team_invitation');
                    
                    const submitBtn = acceptForm.querySelector('.n88-auth-submit');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating Account...';

                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        // Check if response is ok
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error('HTTP error! status: ' + response.status + ', body: ' + text);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            window.location.href = data.data.redirect_url || '<?php echo esc_url( admin_url( 'admin.php?page=n88-rfq-board-demo' ) ); ?>';
                        } else {
                            alert(data.data && data.data.message ? data.data.message : 'Failed to create account. Please try again.');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again. ' + (error.message || ''));
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
                });
            }
            
            // Regular login form
            const form = document.getElementById('n88-login-form');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                formData.append('action', 'n88_login_user');
                
                // Debug: Check if nonce is included
                if (!formData.has('n88_login_nonce')) {
                    console.error('N88 RFQ: Nonce field missing from form data');
                    alert('Form error: Security token missing. Please refresh the page and try again.');
                    return;
                }

                const submitBtn = form.querySelector('.n88-auth-submit');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Logging In...';

                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.data.redirect_url || '<?php echo esc_url( home_url( '/workspace' ) ); ?>';
                    } else {
                        alert(data.data.message || 'Login failed. Please check your credentials.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            });
        })();
        </script>
        <?php
        return ob_get_clean();
    }

    /**
     * AJAX handler for user registration
     */
    public function ajax_register_user() {
        // Verify nonce - check both POST and GET
        $nonce = isset( $_POST['n88_signup_nonce'] ) ? sanitize_text_field( wp_unslash( $_POST['n88_signup_nonce'] ) ) : '';
        
        if ( empty( $nonce ) || ! wp_verify_nonce( $nonce, 'n88_register_user' ) ) {
            // Log for debugging
            error_log( 'N88 RFQ: Registration nonce verification failed. Nonce: ' . ( empty( $nonce ) ? 'empty' : 'present' ) );
            wp_send_json_error( array( 
                'message' => 'Security check failed. Please refresh the page and try again.',
                'debug' => defined( 'WP_DEBUG' ) && WP_DEBUG ? 'Nonce verification failed' : ''
            ) );
        }

        // Get and sanitize form data
        $user_role = isset( $_POST['user_role'] ) ? sanitize_text_field( wp_unslash( $_POST['user_role'] ) ) : '';
        $name = isset( $_POST['name'] ) ? sanitize_text_field( wp_unslash( $_POST['name'] ) ) : '';
        $username = isset( $_POST['username'] ) ? sanitize_user( wp_unslash( $_POST['username'] ) ) : '';
        $email = isset( $_POST['email'] ) ? sanitize_email( wp_unslash( $_POST['email'] ) ) : '';
        $password = isset( $_POST['password'] ) ? $_POST['password'] : '';
        $company_name = isset( $_POST['company_name'] ) ? sanitize_text_field( wp_unslash( $_POST['company_name'] ) ) : '';
        $country = isset( $_POST['country'] ) ? sanitize_text_field( wp_unslash( $_POST['country'] ) ) : '';

        // Validate required fields
        if ( empty( $user_role ) || empty( $name ) || empty( $username ) || empty( $email ) || empty( $password ) || empty( $company_name ) || empty( $country ) ) {
            wp_send_json_error( array( 'message' => 'All fields are required.' ) );
        }

        // Validate role
        $allowed_roles = array( 'n88_designer', 'n88_supplier_admin' );
        if ( ! in_array( $user_role, $allowed_roles, true ) ) {
            wp_send_json_error( array( 'message' => 'Invalid account type selected.' ) );
        }

        // Validate email
        if ( ! is_email( $email ) ) {
            wp_send_json_error( array( 'message' => 'Invalid email address.' ) );
        }

        // Validate password length
        if ( strlen( $password ) < 6 ) {
            wp_send_json_error( array( 'message' => 'Password must be at least 6 characters long.' ) );
        }

        // Check if username already exists
        if ( username_exists( $username ) ) {
            wp_send_json_error( array( 'message' => 'Username already exists. Please choose another.' ) );
        }

        // Check if email already exists
        if ( email_exists( $email ) ) {
            wp_send_json_error( array( 'message' => 'Email already registered. Please use a different email or log in.' ) );
        }

        // Create user
        $user_id = wp_create_user( $username, $password, $email );

        if ( is_wp_error( $user_id ) ) {
            wp_send_json_error( array( 'message' => $user_id->get_error_message() ) );
        }

        // Update user display name
        wp_update_user( array(
            'ID' => $user_id,
            'display_name' => $name,
        ) );

        // Assign role based on user selection (Commit 2.2.1)
        $user = new WP_User( $user_id );
        $user->set_role( $user_role );

        // Save custom user meta
        update_user_meta( $user_id, 'company_name', $company_name );
        update_user_meta( $user_id, 'country', $country );

        // Log event if function exists
        if ( function_exists( 'n88_log_event' ) ) {
            n88_log_event(
                'user_registered',
                'user',
                array(
                    'object_id' => $user_id,
                    'user_id' => $user_id,
                )
            );
        }

        wp_send_json_success( array(
            'message' => 'Registration successful!',
            'redirect_url' => home_url( '/login/?n88_signup_success=1' ),
        ) );
    }

    /**
     * AJAX handler for user login
     */
    public function ajax_login_user() {
        // Verify nonce - check both POST and GET
        $nonce = isset( $_POST['n88_login_nonce'] ) ? sanitize_text_field( wp_unslash( $_POST['n88_login_nonce'] ) ) : '';
        
        if ( empty( $nonce ) || ! wp_verify_nonce( $nonce, 'n88_login_user' ) ) {
            // Log for debugging
            error_log( 'N88 RFQ: Login nonce verification failed. Nonce: ' . ( empty( $nonce ) ? 'empty' : 'present' ) );
            wp_send_json_error( array( 
                'message' => 'Security check failed. Please refresh the page and try again.',
                'debug' => defined( 'WP_DEBUG' ) && WP_DEBUG ? 'Nonce verification failed' : ''
            ) );
        }

        $username = isset( $_POST['username'] ) ? sanitize_text_field( wp_unslash( $_POST['username'] ) ) : '';
        $password = isset( $_POST['password'] ) ? $_POST['password'] : '';
        $remember = isset( $_POST['remember'] ) && $_POST['remember'] === '1';

        if ( empty( $username ) || empty( $password ) ) {
            wp_send_json_error( array( 'message' => 'Username and password are required.' ) );
        }

        // Attempt login
        $user = wp_authenticate( $username, $password );

        if ( is_wp_error( $user ) ) {
            wp_send_json_error( array( 'message' => 'Invalid username or password.' ) );
        }

        // Check if user has one of our custom roles (Commit 2.2.1)
        $allowed_roles = array( 'n88_designer', 'n88_supplier_admin', 'n88_system_operator', 'designer' ); // Include 'designer' for backward compatibility
        $user_has_role = false;
        foreach ( $allowed_roles as $role ) {
            if ( in_array( $role, $user->roles, true ) ) {
                $user_has_role = true;
                break;
            }
        }

        if ( ! $user_has_role ) {
            wp_send_json_error( array( 'message' => 'Access denied. Valid account required.' ) );
        }

        // Log the user in
        wp_set_current_user( $user->ID );
        wp_set_auth_cookie( $user->ID, $remember );

        // Determine redirect URL based on role (Commit 2.2.1)
        $redirect_url = $this->get_role_redirect_url( $user );

        wp_send_json_success( array(
            'message' => 'Login successful!',
            'redirect_url' => $redirect_url,
        ) );
    }

    /**
     * Get redirect URL based on user role (Commit 2.2.1, updated 2.2.7)
     * Commit 2.3.9.1C: System operators redirect to operator queue
     * Commit 2.6.1: Team members redirect to firm board
     */
    private function get_role_redirect_url( $user ) {
        if ( ! $user || ! isset( $user->roles ) ) {
            return null;
        }

        // Check roles in priority order
        // Commit 2.3.9.1C: System operators redirect to operator queue
        if ( in_array( 'n88_system_operator', $user->roles, true ) ) {
            $operator_queue_page_id = get_option( 'n88_rfq_operator_queue_page_id' );
            if ( $operator_queue_page_id ) {
                $operator_queue_url = get_permalink( $operator_queue_page_id );
                if ( $operator_queue_url ) {
                    return $operator_queue_url;
                }
            }
            // Fallback to /operator/queue if page ID not found
            return home_url( '/operator/queue/' );
        }
        
        if ( in_array( 'n88_supplier_admin', $user->roles, true ) ) {
            // Commit 2.2.7: Check if supplier profile is incomplete
            global $wpdb;
            $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
            $profile_exists = $wpdb->get_var( $wpdb->prepare(
                "SELECT supplier_id FROM {$supplier_profiles_table} WHERE supplier_id = %d",
                $user->ID
            ) );
            
            // If profile doesn't exist, redirect to onboarding
            if ( ! $profile_exists ) {
                return home_url( '/supplier/onboarding' );
            }
            
            // Otherwise, redirect to queue
            return home_url( '/supplier/queue' );
        }
        
        if ( in_array( 'n88_designer', $user->roles, true ) || in_array( 'designer', $user->roles, true ) ) {
            // Commit 2.6.1: Check if user is a view-only team member (MUST check first before profile check)
            // This prevents team members from being redirected to onboarding
            if ( self::is_view_only_team_member( $user->ID ) ) {
                // Team member: redirect to firm board
                global $wpdb;
                $firm_members_table = $wpdb->prefix . 'n88_firm_members';
                $boards_table = $wpdb->prefix . 'n88_boards';
                
                // Get user's firm
                $firm_member = $wpdb->get_row( $wpdb->prepare(
                    "SELECT firm_id FROM {$firm_members_table} 
                    WHERE user_id = %d 
                    AND status = 'active' 
                    AND left_at IS NULL 
                    LIMIT 1",
                    $user->ID
                ), ARRAY_A );
                
                if ( $firm_member && isset( $firm_member['firm_id'] ) ) {
                    // Get board owned by the firm owner (not just any board from firm)
                    // First get the firm owner's user_id
                    $firm_owner = $wpdb->get_row( $wpdb->prepare(
                        "SELECT user_id FROM {$firm_members_table} 
                        WHERE firm_id = %d 
                        AND role = 'owner' 
                        AND status = 'active' 
                        AND left_at IS NULL 
                        LIMIT 1",
                        $firm_member['firm_id']
                    ), ARRAY_A );
                    
                    if ( $firm_owner && isset( $firm_owner['user_id'] ) ) {
                        // Get the board owned by the firm owner
                        $board = $wpdb->get_row( $wpdb->prepare(
                            "SELECT id FROM {$boards_table} 
                            WHERE owner_user_id = %d 
                            AND deleted_at IS NULL 
                            ORDER BY created_at ASC 
                            LIMIT 1",
                            $firm_owner['user_id']
                        ), ARRAY_A );
                        
                        if ( $board && isset( $board['id'] ) ) {
                            return admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . intval( $board['id'] ) );
                        }
                    }
                    
                    // Fallback: get any board from the firm if owner's board not found
                    $board = $wpdb->get_row( $wpdb->prepare(
                        "SELECT id FROM {$boards_table} 
                        WHERE owner_firm_id = %d 
                        AND deleted_at IS NULL 
                        ORDER BY created_at ASC 
                        LIMIT 1",
                        $firm_member['firm_id']
                    ), ARRAY_A );
                    
                    if ( $board && isset( $board['id'] ) ) {
                        return admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . intval( $board['id'] ) );
                    }
                    // Fallback to board demo page if no board exists
                    return admin_url( 'admin.php?page=n88-rfq-board-demo' );
                }
            }
            
            // Commit 2.6.1: Double-check if user is a team member (in case is_view_only_team_member didn't catch it)
            // This prevents team members from being sent to onboarding
            global $wpdb;
            $firm_members_table = $wpdb->prefix . 'n88_firm_members';
            
            // Check if user is a firm member (even if not yet detected by is_view_only_team_member)
            $team_member_check = $wpdb->get_row( $wpdb->prepare(
                "SELECT firm_id FROM {$firm_members_table} 
                WHERE user_id = %d 
                AND status = 'active' 
                AND left_at IS NULL 
                LIMIT 1",
                $user->ID
            ), ARRAY_A );
            
            if ( $team_member_check && isset( $team_member_check['firm_id'] ) ) {
                // User is a team member - redirect to firm board (skip onboarding)
                $boards_table = $wpdb->prefix . 'n88_boards';
                
                // Get firm owner's board
                $firm_owner = $wpdb->get_row( $wpdb->prepare(
                    "SELECT user_id FROM {$firm_members_table} 
                    WHERE firm_id = %d 
                    AND role = 'owner' 
                    AND status = 'active' 
                    AND left_at IS NULL 
                    LIMIT 1",
                    $team_member_check['firm_id']
                ), ARRAY_A );
                
                if ( $firm_owner && isset( $firm_owner['user_id'] ) ) {
                    $board = $wpdb->get_row( $wpdb->prepare(
                        "SELECT id FROM {$boards_table} 
                        WHERE owner_user_id = %d 
                        AND deleted_at IS NULL 
                        ORDER BY created_at ASC 
                        LIMIT 1",
                        $firm_owner['user_id']
                    ), ARRAY_A );
                    
                    if ( $board && isset( $board['id'] ) ) {
                        return admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . intval( $board['id'] ) );
                    }
                }
            }
            
            // Commit 2.2.8: Check if designer profile is incomplete (only for non-team-member designers)
            global $wpdb;
            $designer_profiles_table = $wpdb->prefix . 'n88_designer_profiles_v2';
            
            // Check if profile exists - use COUNT for more reliable check
            // Suppress errors in case table doesn't exist yet
            $wpdb->suppress_errors( true );
            $profile_count = $wpdb->get_var( $wpdb->prepare(
                "SELECT COUNT(*) FROM {$designer_profiles_table} WHERE designer_id = %d",
                $user->ID
            ) );
            $wpdb->suppress_errors( false );
            
            // If profile doesn't exist (count is false, null, or 0), redirect to onboarding
            if ( $profile_count === false || $profile_count === null || (int) $profile_count === 0 ) {
                return home_url( '/designer/onboarding' );
            }
            
            // Otherwise, redirect to workspace
            return home_url( '/workspace' );
        }

        return null;
    }

    /**
     * Commit 2.6.1: Check if user is a view-only team member (not firm owner)
     * 
     * @param int|null $user_id User ID (defaults to current user)
     * @return bool True if user is a team member (view-only), false if owner or not a firm member
     */
    public static function is_view_only_team_member( $user_id = null ) {
        if ( ! $user_id ) {
            $current_user = wp_get_current_user();
            if ( ! $current_user || ! $current_user->ID ) {
                return false;
            }
            $user_id = $current_user->ID;
        }

        global $wpdb;
        $firm_members_table = $wpdb->prefix . 'n88_firm_members';

        // Check if table exists
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$firm_members_table}'" ) !== $firm_members_table ) {
            return false;
        }

        // Check if user is a firm member with role 'member' (not 'owner')
        $member = $wpdb->get_row( $wpdb->prepare(
            "SELECT role, status FROM {$firm_members_table} 
            WHERE user_id = %d 
            AND status = 'active' 
            AND left_at IS NULL
            LIMIT 1",
            $user_id
        ), ARRAY_A );

        // If user is a member (not owner), they're view-only
        if ( $member && $member['role'] === 'member' ) {
            return true;
        }

        return false;
    }

    /**
     * Redirect user after login based on role (Commit 2.2.1)
     * Commit 2.3.9.1C: Also redirect system operators to operator queue
     */
    public function redirect_designer_after_login( $redirect_to, $requested_redirect_to, $user ) {
        $role_redirect = $this->get_role_redirect_url( $user );
        if ( $role_redirect ) {
            return $role_redirect;
        }
        return $redirect_to;
    }

    /**
     * Handle user login (updated for all roles)
     */
    public function handle_designer_login( $user_login, $user ) {
        // Additional logic on login if needed
        // Can be used for logging, notifications, etc.
    }

    /**
     * Custom logout URL - redirect to /login instead of wp-login.php
     */
    public function custom_logout_url( $logout_url, $redirect ) {
        // Build custom logout URL pointing to /login
        $logout_url = wp_nonce_url( home_url( '/login/?action=logout' ), 'log-out' );
        
        // If a redirect was specified, append it
        if ( $redirect ) {
            $logout_url = add_query_arg( 'redirect_to', urlencode( $redirect ), $logout_url );
        }
        
        return $logout_url;
    }

    /**
     * Redirect after logout to custom login page
     */
    public function redirect_after_logout() {
        // Redirect to custom login page
        wp_safe_redirect( home_url( '/login/' ) );
        exit;
    }

    /**
     * Hide WordPress admin menus for designers (Commit 2.2.1)
     */
    public function hide_wp_menus_for_designer() {
        $current_user = wp_get_current_user();
        if ( ! $current_user || ! ( in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true ) ) ) {
            return;
        }

        // Remove all default WordPress menus except our plugin menus
        global $menu, $submenu;

        // Keep only our plugin menus
        $allowed_menus = array(
            'n88-rfq-dashboard',
            'n88-rfq-board-demo',
            'n88-rfq-items-boards-test',
        );

        if ( is_array( $menu ) ) {
            foreach ( $menu as $key => $item ) {
                if ( ! in_array( $item[2], $allowed_menus, true ) ) {
                    remove_menu_page( $item[2] );
                }
            }
        }
    }

    /**
     * Hide WordPress admin bar completely for designers and suppliers
     */
    public function hide_admin_bar_for_custom_roles( $show ) {
        if ( ! is_user_logged_in() ) {
            return $show;
        }
        
        $current_user = wp_get_current_user();
        if ( ! $current_user ) {
            return $show;
        }
        
        // Check if user is a designer/creator
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        // Check if user is a supplier/maker
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        
        // Check if user is a system operator (allow admin bar for system operators)
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        // Hide admin bar for designers and suppliers, but not for system operators
        if ( ( $is_designer || $is_supplier ) && ! $is_system_operator ) {
            // Also add inline CSS to forcefully hide admin bar
            add_action( 'wp_head', function() {
                echo '<style>#wpadminbar { display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important; } html { margin-top: 0 !important; } body.admin-bar { margin-top: 0 !important; }</style>';
            }, 999 );
            add_action( 'admin_head', function() {
                echo '<style>#wpadminbar { display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important; } html { margin-top: 0 !important; } body.admin-bar { margin-top: 0 !important; }</style>';
            }, 999 );
            return false;
        }
        
        return $show;
    }

    /**
     * Remove WordPress admin bar items for designers (Commit 2.2.1)
     */
    public function remove_wp_admin_bar_items( $wp_admin_bar ) {
        $current_user = wp_get_current_user();
        if ( ! $current_user || ! ( in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true ) ) ) {
            return;
        }

        // Remove WordPress logo
        $wp_admin_bar->remove_node( 'wp-logo' );

        // Remove comments
        $wp_admin_bar->remove_node( 'comments' );

        // Remove "New" menu items except for our plugin
        $wp_admin_bar->remove_node( 'new-content' );
        $wp_admin_bar->remove_node( 'new-post' );
        $wp_admin_bar->remove_node( 'new-page' );
        $wp_admin_bar->remove_node( 'new-media' );
    }

    /**
     * Redirect designers away from WordPress admin pages (Commit 2.2.1)
     */
    public function redirect_designer_from_wp_admin() {
        $current_user = wp_get_current_user();
        if ( ! $current_user || ! ( in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true ) ) ) {
            return;
        }

        // Get current screen
        $screen = get_current_screen();
        if ( ! $screen ) {
            return;
        }

        // Allow access to our plugin pages
        $allowed_pages = array(
            'n88-rfq-dashboard',
            'n88-rfq-board-demo',
            'n88-rfq-items-boards-test',
        );

        // If trying to access a non-allowed page, redirect to dashboard
        if ( ! in_array( $screen->id, $allowed_pages, true ) && strpos( $screen->id, 'n88-rfq' ) === false ) {
            wp_redirect( admin_url( 'admin.php?page=n88-rfq-dashboard' ) );
            exit;
        }
    }

    /**
     * Get designer's board (designers can only have 1 board)
     */
    private function get_designer_board( $user_id ) {
        global $wpdb;
        $boards_table = $wpdb->prefix . 'n88_boards';
        return $wpdb->get_row(
            $wpdb->prepare(
                "SELECT * FROM {$boards_table} WHERE owner_user_id = %d AND deleted_at IS NULL ORDER BY created_at ASC LIMIT 1",
                $user_id
            )
        );
    }

    /**
     * Check if designer has any items
     */
    private function designer_has_items( $user_id ) {
        global $wpdb;
        $items_table = $wpdb->prefix . 'n88_items';
        $count = $wpdb->get_var(
            $wpdb->prepare(
                "SELECT COUNT(*) FROM {$items_table} WHERE owner_user_id = %d AND deleted_at IS NULL",
                $user_id
            )
        );
        return $count > 0;
    }

    /**
     * Enforce route guards for frontend routes (Commit 2.2.1)
     * Only applies to frontend pages, not WordPress admin
     */
    public function enforce_route_guards() {
        // Only apply to frontend, not admin
        if ( is_admin() ) {
            return;
        }

        if ( ! is_user_logged_in() ) {
            return;
        }

        $current_user = wp_get_current_user();
        $request_uri = isset( $_SERVER['REQUEST_URI'] ) ? esc_url_raw( wp_unslash( $_SERVER['REQUEST_URI'] ) ) : '';
        $parsed_url = parse_url( $request_uri );
        $path = isset( $parsed_url['path'] ) ? $parsed_url['path'] : '';

        // Skip if this is a WordPress admin path (wp-admin, wp-login, etc.)
        if ( strpos( $path, '/wp-admin' ) !== false || strpos( $path, '/wp-login' ) !== false ) {
            return;
        }

        // Check if user is a designer
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        // Check if user is a supplier
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        
        // Check if user is a system operator
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );

        // Designers blocked from frontend /admin/* and /supplier/* routes (not WordPress admin)
        if ( $is_designer && ! $is_system_operator ) {
            // Only block if it's a frontend route, not WordPress admin
            if ( ( strpos( $path, '/admin/' ) !== false || strpos( $path, '/supplier/' ) !== false ) && strpos( $path, '/wp-admin' ) === false ) {
                self::render_403_error( 'Access Denied', 'You do not have permission to access this page. Creators are restricted from accessing super admin and maker areas.' );
                exit;
            }
        }

        // Suppliers blocked from global queue scope on frontend
        if ( $is_supplier && ! $is_system_operator ) {
            if ( strpos( $path, '/admin/queue' ) !== false && strpos( $path, '/wp-admin' ) === false ) {
                $query_params = isset( $parsed_url['query'] ) ? $parsed_url['query'] : '';
                parse_str( $query_params, $query_vars );
                if ( isset( $query_vars['scope'] ) && $query_vars['scope'] === 'global' ) {
                    self::render_403_error( 'Access Denied', 'You do not have permission to access the global queue. Makers can only access the maker queue.' );
                    exit;
                }
            }
        }
    }

    /**
     * Enforce route guards for admin routes (Commit 2.2.1)
     * Only applies to our plugin admin pages, not WordPress core admin (posts, pages, etc.)
     */
    public function enforce_admin_route_guards() {
        if ( ! is_user_logged_in() ) {
            return;
        }

        $current_user = wp_get_current_user();
        $request_uri = isset( $_SERVER['REQUEST_URI'] ) ? esc_url_raw( wp_unslash( $_SERVER['REQUEST_URI'] ) ) : '';
        $parsed_url = parse_url( $request_uri );
        $path = isset( $parsed_url['path'] ) ? $parsed_url['path'] : '';
        $query_params = isset( $parsed_url['query'] ) ? $parsed_url['query'] : '';
        parse_str( $query_params, $query_vars );

        // Only apply guards to our plugin admin pages (admin.php?page=n88-rfq-*)
        // Allow all WordPress core admin operations (post.php, post-new.php, edit.php, etc.)
        if ( strpos( $path, '/wp-admin/admin.php' ) === false ) {
            return; // Not our plugin admin page, allow it
        }

        // If it's our plugin page, check the page parameter
        if ( ! isset( $query_vars['page'] ) ) {
            return; // No page parameter, allow it
        }

        // Check if user is a designer
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        // Check if user is a supplier
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        
        // Check if user is a system operator
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );

        // Designers blocked from our plugin admin pages that aren't their workspace
        if ( $is_designer && ! $is_system_operator ) {
            // Allow access to their workspace board pages
            $allowed_pages = array( 'n88-rfq-dashboard', 'n88-rfq-board-demo', 'n88-rfq-items-boards-test', 'n88-rfq-materials' );
            if ( ! in_array( $query_vars['page'], $allowed_pages, true ) ) {
                // Check if it's a supplier or admin queue page
                if ( strpos( $query_vars['page'], 'supplier' ) !== false || strpos( $query_vars['page'], 'admin-queue' ) !== false ) {
                    self::render_403_error( 'Access Denied', 'You do not have permission to access this page. Creators are restricted from accessing super admin and maker areas.' );
                    exit;
                }
            }
        }

        // Suppliers blocked from global queue scope in our plugin admin
        if ( $is_supplier && ! $is_system_operator ) {
            if ( strpos( $query_vars['page'], 'admin-queue' ) !== false || strpos( $query_vars['page'], 'n88-rfq-role-management' ) !== false ) {
                if ( isset( $query_vars['scope'] ) && $query_vars['scope'] === 'global' ) {
                    self::render_403_error( 'Access Denied', 'You do not have permission to access the global queue. Makers can only access the maker queue.' );
                    exit;
                }
            }
        }
    }

    /**
     * Render designer dashboard
     */
    public function render_designer_dashboard( $atts = array() ) {
        // Check if user is logged in
        if ( ! is_user_logged_in() ) {
            return '<p>Please <a href="' . esc_url( home_url( '/login/' ) ) . '">log in</a> to access the dashboard.</p>';
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        // Allow designers and system operators
        if ( ! $is_designer && ! $is_system_operator ) {
            return '<p>Access denied. Creator or System Operator account required.</p>';
        }

        $user_id = $current_user->ID;
        $designer_board = $this->get_designer_board( $user_id );
        $has_items = $this->designer_has_items( $user_id );
        $has_board_and_items = $designer_board && $has_items;

        ob_start();
        ?>
        <div class="n88-designer-dashboard" style="max-width: 600px; margin: 50px auto; padding: 20px;">
            <div style="text-align: center;">
                
                <div style="margin-bottom: 20px;">
                    <a href="<?php echo esc_url( admin_url( 'admin.php?page=n88-rfq-dashboard' ) ); ?>" 
                       class="button button-primary button-large" 
                       style="padding: 15px 30px; font-size: 16px; text-decoration: none; display: inline-block;">
                        Create My Workspace
                    </a>
                </div>

                <?php if ( $has_board_and_items ) : ?>
                    <div style="margin-top: 20px;">
                        <a href="<?php echo esc_url( admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . $designer_board->id ) ); ?>" 
                           class="button button-secondary button-large" 
                           style="padding: 15px 30px; font-size: 16px; text-decoration: none; display: inline-block;">
                            Go to My Workspace
                        </a>
                    </div>
                <?php endif; ?>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }

    /**
     * Render workspace page for designers (Commit 2.2.1)
     */
    public function render_workspace( $atts = array() ) {
        // Allow admins to edit pages even if they don't have designer role
        if ( is_admin() && current_user_can( 'edit_pages' ) ) {
            return '<p><em>Workspace page - This shortcode will redirect designers to their workspace.</em></p>';
        }

        // Check if user is logged in
        if ( ! is_user_logged_in() ) {
            wp_redirect( home_url( '/login/' ) );
            exit;
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        // Allow designers and system operators
        if ( ! $is_designer && ! $is_system_operator ) {
            wp_die( 'Access denied. Creator or System Operator account required.', 'Access Denied', array( 'response' => 403 ) );
        }

        // Show workspace page (no automatic redirect to board)
        return $this->render_designer_dashboard( $atts );
    }

    /**
     * Determine action badge for a route item (M2)
     * Returns: 'submit_bid', 'continue_draft', 'specs_changed', 'submitted', or 'expired'
     */
    private function determine_action_badge( $item_data, $route_status, $item_current_revision, $has_revision_column = true ) {
        // Commit 2.4.1: Check if bid is awarded (highest priority)
        if ( ! empty( $item_data['bids'] ) ) {
            foreach ( $item_data['bids'] as $bid ) {
                if ( isset( $bid['status'] ) && $bid['status'] === 'awarded' ) {
                    return 'awarded';
                }
            }
        }
        
        // M6: If expired, return expired (read-only)
        if ( $route_status === 'expired' ) {
            return 'expired';
        }
        
        // Check if route is actionable
        if ( ! in_array( $route_status, array( 'queued', 'sent', 'viewed', 'bid_submitted' ), true ) ) {
            return 'expired'; // Treat non-actionable as expired
        }
        
        // Check for specs changed (M2.3)
        $has_stale_bid = false;
        $has_current_draft = false;
        $has_current_submitted = false;
        
        if ( ! empty( $item_data['bids'] ) ) {
            // If revision column doesn't exist, treat any submitted/draft bid as "current"
            // (since we can't determine if it's stale or not)
            if ( ! $has_revision_column || $item_current_revision === null ) {
                foreach ( $item_data['bids'] as $bid ) {
                    if ( $bid['status'] === 'draft' ) {
                        $has_current_draft = true;
                        break; // Draft takes priority
                    } elseif ( $bid['status'] === 'submitted' ) {
                        $has_current_submitted = true;
                        // Don't break - check for draft first
                    }
                }
            } else {
                // Revision column exists - use revision-based logic
                foreach ( $item_data['bids'] as $bid ) {
                    $bid_revision = isset( $bid['revision'] ) ? intval( $bid['revision'] ) : null;
                    
                    // Check for current revision bid FIRST (priority)
                    if ( $bid_revision === $item_current_revision ) {
                        if ( $bid['status'] === 'draft' ) {
                            $has_current_draft = true;
                        } elseif ( $bid['status'] === 'submitted' ) {
                            $has_current_submitted = true;
                        }
                    }
                    
                    // Check for stale bid (old revision OR NULL revision - when dims/qty changed, revision is set to NULL)
                    // Only if we don't already have a current revision bid
                    if ( ! $has_current_submitted && ! $has_current_draft ) {
                        if ( $bid_revision === null || ( $bid_revision !== null && $bid_revision < $item_current_revision ) ) {
                            if ( $bid['status'] === 'submitted' || $bid['status'] === 'draft' ) {
                                $has_stale_bid = true;
                            }
                        }
                    }
                }
            }
        }
        
        // Priority 1: M2.2: Continue Draft (draft exists for current revision)
        if ( $has_current_draft ) {
            return 'continue_draft';
        }
        
        // Priority 2: M2.1: Submitted (submitted bid exists for current revision)
        if ( $has_current_submitted ) {
            return 'submitted';
        }
        
        // Priority 3: M2.3: Specs Changed - Update Bid (stale bid exists but no current revision bid)
        // Only show resubmit when designer actually changed specs (stale bid exists)
        if ( $has_stale_bid ) {
            return 'specs_changed';
        }
        
        // Default: Submit Bid (no bids at all)
        return 'submit_bid';
    }
    
    /**
     * Calculate time remaining for a route (for system_invited routes)
     * Returns formatted string like "18h" or "2d 4h" or null if not applicable
     */
    private function calculate_time_remaining( $route_type, $eligible_after ) {
        // Only show for system_invited routes
        if ( $route_type !== 'system_invited' || ! $eligible_after ) {
            return null;
        }
        
        $now = current_time( 'timestamp' );
        $eligible_timestamp = strtotime( $eligible_after );
        
        if ( ! $eligible_timestamp || $eligible_timestamp <= $now ) {
            return null; // Already eligible or invalid
        }
        
        $diff_seconds = $eligible_timestamp - $now;
        $diff_hours = floor( $diff_seconds / 3600 );
        $diff_days = floor( $diff_hours / 24 );
        $remaining_hours = $diff_hours % 24;
        
        if ( $diff_days > 0 ) {
            return $diff_days . 'd ' . $remaining_hours . 'h';
        } else {
            return $diff_hours . 'h';
        }
    }
    
    /**
     * Parse time remaining string to hours for filtering
     */
    private function parse_time_remaining_hours( $time_str ) {
        if ( ! $time_str ) {
            return null;
        }
        
        $hours = 0;
        if ( preg_match( '/(\d+)d/', $time_str, $days_match ) ) {
            $hours += intval( $days_match[1] ) * 24;
        }
        if ( preg_match( '/(\d+)h/', $time_str, $hours_match ) ) {
            $hours += intval( $hours_match[1] );
        }
        
        return $hours > 0 ? $hours : null;
    }
    
    /**
     * Commit 2.3.7.1: Check and update expired routes (lazy evaluation)
     * 
     * For each system_invited or designer_invited route:
     * - If eligible_after IS NOT NULL
     * - AND NOW() > eligible_after + INTERVAL (N88_SYSTEM_INVITED_EXPIRY_SECONDS)
     * - OR if eligible_after IS NULL AND routed_at IS NOT NULL
     * - AND NOW() > routed_at + INTERVAL (N88_SYSTEM_INVITED_EXPIRY_SECONDS)
     * - AND status IN ('queued','sent','viewed')
     * - Then set status = 'expired'
     * 
     * @param int|null $item_id Optional item_id to check specific item, or null to check all
     * @param int|null $supplier_id Optional supplier_id to check specific supplier, or null to check all
     * @return int Number of routes updated to expired
     */
    private function check_and_update_expired_routes( $item_id = null, $supplier_id = null ) {
        global $wpdb;
        
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        
        // Build WHERE clause - include both system_invited and designer_invited routes
        $where_conditions = array( "route_type IN ('system_invited', 'designer_invited')" );
        $where_conditions[] = "status IN ('queued', 'sent', 'viewed')";
        
        // Calculate expiry timestamp
        // Route expires if: NOW() > eligible_after + INTERVAL (expiry_seconds) OR NOW() > routed_at + INTERVAL (expiry_seconds)
        // For routes with eligible_after (delayed routes): use eligible_after + expiry_seconds (expiry starts when route becomes eligible)
        // For routes without eligible_after (immediate routes): use routed_at + expiry_seconds (expiry starts when route is created)
        $expiry_seconds = self::N88_SYSTEM_INVITED_EXPIRY_SECONDS;
        
        // Handle both cases: routes with eligible_after and routes without (using routed_at)
        // Priority: If eligible_after exists, use it; otherwise use routed_at
        $expiry_condition = $wpdb->prepare(
            "(eligible_after IS NOT NULL AND DATE_ADD(eligible_after, INTERVAL %d SECOND) < NOW()) OR (eligible_after IS NULL AND routed_at IS NOT NULL AND DATE_ADD(routed_at, INTERVAL %d SECOND) < NOW())",
            $expiry_seconds,
            $expiry_seconds
        );
        $where_conditions[] = $expiry_condition;
        
        if ( $item_id !== null ) {
            $where_conditions[] = $wpdb->prepare( "item_id = %d", $item_id );
        }
        
        if ( $supplier_id !== null ) {
            $where_conditions[] = $wpdb->prepare( "supplier_id = %d", $supplier_id );
        }
        
        $where_clause = implode( ' AND ', $where_conditions );
        
        // Update expired routes
        $updated = $wpdb->query(
            "UPDATE {$rfq_routes_table} 
            SET status = 'expired' 
            WHERE {$where_clause}"
        );
        
        if ( $updated > 0 ) {
            error_log( sprintf( 
                'N88 RFQ: Updated %d route(s) (system_invited/designer_invited) to expired status (expiry window: %d seconds)',
                $updated,
                $expiry_seconds
            ) );
        }
        
        return $updated !== false ? intval( $updated ) : 0;
    }
    
    /**
     * Commit 2.3.7.1: Check if a route is expired
     * 
     * @param int $item_id Item ID
     * @param int $supplier_id Supplier ID
     * @return bool True if route is expired, false otherwise
     */
    private function is_route_expired( $item_id, $supplier_id ) {
        global $wpdb;
        
        // First, check and update expired routes (lazy evaluation)
        $this->check_and_update_expired_routes( $item_id, $supplier_id );
        
        // Then check if this specific route is expired
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        $route = $wpdb->get_row( $wpdb->prepare(
            "SELECT status, route_type, eligible_after 
            FROM {$rfq_routes_table} 
            WHERE item_id = %d AND supplier_id = %d",
            $item_id,
            $supplier_id
        ) );
        
        if ( ! $route ) {
            return false; // Route doesn't exist
        }
        
        // Both system_invited and designer_invited routes can expire
        if ( ! in_array( $route->route_type, array( 'system_invited', 'designer_invited' ), true ) ) {
            return false;
        }
        
        return $route->status === 'expired';
    }
    
    /**
     * Render supplier queue page (M) - Redesigned to match wireframe
     */
    public function render_supplier_queue( $atts = array() ) {
        // Allow admins to edit pages even if they don't have supplier role
        if ( is_admin() && current_user_can( 'edit_pages' ) ) {
            return '<p><em>Maker Queue page - This shortcode will display the maker queue for authorized users.</em></p>';
        }

        // Check if user is logged in and is a supplier or system operator
        if ( ! is_user_logged_in() ) {
            wp_redirect( home_url( '/login/' ) );
            exit;
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_system_operator ) {
            wp_die( 'Access denied. Maker or System Operator account required.', 'Access Denied', array( 'response' => 403 ) );
        }

        // Read filter values from URL query parameters (M5)
        $status_filter = isset( $_GET['status'] ) ? sanitize_text_field( wp_unslash( $_GET['status'] ) ) : 'needs_action';
        $time_remaining_filter = isset( $_GET['time_remaining'] ) ? sanitize_text_field( wp_unslash( $_GET['time_remaining'] ) ) : 'all';
        $category_filter = isset( $_GET['category'] ) ? sanitize_text_field( wp_unslash( $_GET['category'] ) ) : 'all';
        $search = isset( $_GET['search'] ) ? sanitize_text_field( wp_unslash( $_GET['search'] ) ) : '';

        // Pagination: 6 items per page
        $items_per_page = 6;
        $current_page = isset( $_GET['page'] ) ? max( 1, intval( $_GET['page'] ) ) : 1;

        // M3: Fetch routed items with proper eligibility rules
                        global $wpdb;
                        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
                        $items_table = $wpdb->prefix . 'n88_items';
                        $categories_table = $wpdb->prefix . 'n88_categories';
                        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
                        
        // Commit 2.3.7.1: Check and update expired routes (system_invited and designer_invited) (lazy evaluation)
        $this->check_and_update_expired_routes( null, $current_user->ID );
                        
        // M3: Build query with proper status filtering (include expired when needed)
        // M3.3: Exclude cancelled/closed routes
        $status_conditions = array();
        $status_conditions[] = "r.status NOT IN ('cancelled', 'closed')";
        
        // Commit 2.3.7.1: Always exclude expired routes by default (unless explicitly filtering for expired)
        if ( $status_filter === 'expired' ) {
            $status_conditions[] = "r.status = 'expired'";
        } else {
            // For all other filters (including 'all'), exclude expired routes
            // Expired routes should only appear when explicitly filtering for 'expired'
            $status_conditions[] = "r.status != 'expired'";
        }
        
        $status_where = ! empty( $status_conditions ) ? 'AND ' . implode( ' AND ', $status_conditions ) : '';
        
        // Check if rfq_revision_at_submit column exists in bids table
        $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
        $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
        
        // Get routed items with eligible_after for time calculation
                        $routed_items_base = $wpdb->get_results( $wpdb->prepare(
                            "SELECT DISTINCT
                                r.item_id,
                                r.status as route_status,
                                r.route_type,
                r.eligible_after,
                                i.id,
                                i.title,
                                i.item_type,
                                i.status as item_status,
                                i.meta_json,
                i.primary_image_id,
                                c.name as category_name
                            FROM {$rfq_routes_table} r
                            INNER JOIN {$items_table} i ON r.item_id = i.id
                            LEFT JOIN {$categories_table} c ON i.item_type = c.category_id OR i.item_type = c.name
                            WHERE r.supplier_id = %d
                            AND i.deleted_at IS NULL
            {$status_where}
                            ORDER BY r.route_id DESC",
                            $current_user->ID
                        ), ARRAY_A );
                        
        // Get all bids for these items
                        $routed_items = array();
                        foreach ( $routed_items_base as $item ) {
                            $item_id = intval( $item['id'] );
                            
                            // Get all bids for this item and supplier
                            // Only include revision column if it exists
                            $bid_select_fields = "status";
                            if ( $has_revision_column ) {
                                $bid_select_fields .= ", rfq_revision_at_submit";
                            }
                            
                            $bids = $wpdb->get_results( $wpdb->prepare(
                                "SELECT {$bid_select_fields}
                                FROM {$item_bids_table}
                                WHERE item_id = %d
                                AND supplier_id = %d",
                                $item_id,
                                $current_user->ID
                            ), ARRAY_A );
                            
                            // Add bids to item data
                            $item['bids'] = $bids;
                            $routed_items[] = $item;
                        }
                        
        // Process items and determine action badges
                            $items_by_id = array();
                            foreach ( $routed_items as $item ) {
                                $item_id = intval( $item['id'] );
                                
                                // Convert bids array to expected format
                                $bids_formatted = array();
                                if ( ! empty( $item['bids'] ) && is_array( $item['bids'] ) ) {
                                    foreach ( $item['bids'] as $bid ) {
                                        $bids_formatted[] = array(
                                            'status' => $bid['status'],
                                            'revision' => isset( $bid['rfq_revision_at_submit'] ) ? $bid['rfq_revision_at_submit'] : null,
                                        );
                                    }
                                }
                                
            $item_meta = ! empty( $item['meta_json'] ) ? json_decode( $item['meta_json'], true ) : array();
            $item_current_revision = isset( $item_meta['rfq_revision_current'] ) ? intval( $item_meta['rfq_revision_current'] ) : 1;
            
            $item_data = array(
                                    'id' => $item_id,
                                    'title' => $item['title'],
                                    'item_type' => $item['item_type'],
                                    'category_name' => $item['category_name'],
                                    'route_status' => $item['route_status'],
                'route_type' => $item['route_type'],
                'eligible_after' => $item['eligible_after'],
                                    'meta_json' => $item['meta_json'],
                'primary_image_id' => $item['primary_image_id'],
                                    'bids' => $bids_formatted,
                'item_current_revision' => $item_current_revision,
            );
            
            // Determine action badge (pass has_revision_column flag)
            $action_badge = $this->determine_action_badge( $item_data, $item['route_status'], $item_current_revision, $has_revision_column );
            $item_data['action_badge'] = $action_badge;
            
            // Calculate time remaining
            $time_remaining = $this->calculate_time_remaining( $item['route_type'], $item['eligible_after'] );
            $item_data['time_remaining'] = $time_remaining;
            
            // Check for unread operator messages (supplier_operator thread)
            // Action Required: Show when operator has sent messages that supplier hasn't replied to
            $messages_table = $wpdb->prefix . 'n88_item_messages';
            $unread_operator_messages = 0;
            $has_unread_operator_messages = false;
            
            // Check if messages table exists
            $messages_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$messages_table}'" ) === $messages_table;
            if ( $messages_table_exists ) {
                // Count unread operator messages (operator messages with no supplier reply after them)
                // For supplier_operator thread, we need to check by item_id and supplier_id
                $unread_operator_messages = intval( $wpdb->get_var( $wpdb->prepare(
                    "SELECT COUNT(DISTINCT m.message_id)
                    FROM {$messages_table} m
                    WHERE m.item_id = %d
                    AND m.thread_type = 'supplier_operator'
                    AND m.sender_role = 'operator'
                    AND m.supplier_id = %d
                    AND NOT EXISTS (
                        SELECT 1 FROM {$messages_table} m2
                        WHERE m2.item_id = m.item_id
                        AND m2.thread_type = 'supplier_operator'
                        AND m2.sender_role = 'supplier'
                        AND m2.supplier_id = %d
                        AND m2.created_at > m.created_at
                    )",
                    $item_id,
                    $current_user->ID,
                    $current_user->ID
                ) ) );
                $has_unread_operator_messages = $unread_operator_messages > 0;
                // Fix #13/#26: If operator marked resolved for any of this supplier's bids on this item, clear Action Required
                if ( $has_unread_operator_messages ) {
                    $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
                    $item_bids_table = $wpdb->prefix . 'n88_item_bids';
                    if ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) === $resolutions_table ) {
                        $resolved = $wpdb->get_var( $wpdb->prepare(
                            "SELECT 1 FROM {$resolutions_table} r
                            INNER JOIN {$item_bids_table} b ON b.item_id = r.item_id AND b.bid_id = r.bid_id AND b.supplier_id = %d
                            WHERE r.item_id = %d LIMIT 1",
                            $current_user->ID,
                            $item_id
                        ) );
                        if ( $resolved ) {
                            $has_unread_operator_messages = false;
                            $unread_operator_messages = 0;
                        }
                    }
                }
                // When supplier has marked as clarified (supplier clicked "Mark as Clarified"), do not show Action Required for operator message â€” show current item status instead
                $supplier_has_marked_clarified = false;
                if ( $has_unread_operator_messages ) {
                    $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
                    if ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) === $resolutions_table ) {
                        $supplier_has_marked_clarified = (bool) $wpdb->get_var( $wpdb->prepare(
                            "SELECT 1 FROM {$resolutions_table} WHERE item_id = %d AND actor_user_id = %d LIMIT 1",
                            $item_id,
                            $current_user->ID
                        ) );
                        if ( $supplier_has_marked_clarified ) {
                            $has_unread_operator_messages = false;
                            $unread_operator_messages = 0;
                        }
                    }
                }
            }
            
            $item_data['has_unread_operator_messages'] = $has_unread_operator_messages;
            $item_data['unread_operator_messages'] = $unread_operator_messages;
            
            // E) Fix #22, #25: Clear Action Required when CAD approved or prototype approved (supplier has no pending task)
            // F) Fix #28: Never show Action Required when awarded
            $cad_status = null;
            $prototype_status = null;
            $cad_released_to_supplier_at = null;
            $prototype_payment_status = null;
            $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
            if ( $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table ) {
                $pp_cols = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
                $has_cad = is_array( $pp_cols ) && in_array( 'cad_status', $pp_cols, true );
                $has_ps = is_array( $pp_cols ) && in_array( 'prototype_status', $pp_cols, true );
                $has_cad_released = is_array( $pp_cols ) && in_array( 'cad_released_to_supplier_at', $pp_cols, true );
                $has_pp_status = is_array( $pp_cols ) && in_array( 'status', $pp_cols, true );
                $sel = 'id' . ( $has_cad ? ', cad_status' : '' ) . ( $has_ps ? ', prototype_status' : '' ) . ( $has_cad_released ? ', cad_released_to_supplier_at' : '' ) . ( $has_pp_status ? ', status' : '' );
                $row = $wpdb->get_row( $wpdb->prepare(
                    "SELECT {$sel} FROM {$prototype_payments_table} WHERE item_id = %d AND supplier_id = %d ORDER BY id DESC LIMIT 1",
                    $item_id,
                    $current_user->ID
                ), ARRAY_A );
                if ( $row ) {
                    if ( $has_cad && isset( $row['cad_status'] ) ) {
                        $cad_status = $row['cad_status'];
                    }
                    if ( $has_ps && isset( $row['prototype_status'] ) ) {
                        $prototype_status = $row['prototype_status'];
                    }
                    if ( $has_cad_released && isset( $row['cad_released_to_supplier_at'] ) && $row['cad_released_to_supplier_at'] !== null && trim( (string) $row['cad_released_to_supplier_at'] ) !== '' ) {
                        $cad_released_to_supplier_at = $row['cad_released_to_supplier_at'];
                    }
                    if ( $has_pp_status && isset( $row['status'] ) ) {
                        $prototype_payment_status = $row['status'];
                    }
                }
            }
            // Override badge when designer sent video changes request or approved video
            if ( $action_badge !== 'awarded' && $prototype_status === 'approved' ) {
                $item_data['action_badge'] = 'cad_video_approved';
                $action_badge = 'cad_video_approved';
            } elseif ( $action_badge !== 'awarded' && $prototype_status === 'changes_requested' ) {
                $item_data['action_badge'] = 'changes_received';
                $action_badge = 'changes_received';
            }
            $show_action_required = $has_unread_operator_messages;
            if ( $action_badge === 'awarded' ) {
                $show_action_required = false;
            }
            if ( $prototype_status === 'approved' ) {
                $show_action_required = false;
            }
            if ( $cad_status === 'approved' && ( $prototype_status === null || $prototype_status === '' || $prototype_status === 'approved' ) ) {
                $show_action_required = false;
            }
            // When operator sent CAD and supplier has submitted prototype video: no reply needed â€” clear Action Required (unread)
            if ( $cad_released_to_supplier_at && $prototype_status === 'submitted' ) {
                $show_action_required = false;
            }
            $item_data['show_action_required'] = $show_action_required;
            $item_data['cad_released_to_supplier_at'] = $cad_released_to_supplier_at;
            $item_data['cad_status'] = $cad_status;
            $item_data['prototype_status'] = $prototype_status;
            $item_data['prototype_payment_status'] = $prototype_payment_status;

            // Compute single status label and color for supplier (each step clearly worded)
            $status_label = '';
            $status_color = '#fff';
            $is_action_required = false;
            $cad_released = ! empty( $cad_released_to_supplier_at ) && trim( (string) $cad_released_to_supplier_at ) !== '';
            $has_prototype_payment = $prototype_payment_status !== null && $prototype_payment_status !== '';

            if ( $action_badge === 'awarded' ) {
                $status_label = __( 'Awarded', 'n88-rfq-platform' );
                $status_color = '#00ff00';
            } elseif ( $action_badge === 'expired' ) {
                $status_label = __( 'Expired', 'n88-rfq-platform' );
                $status_color = '#999';
            } elseif ( $action_badge === 'changes_received' || $prototype_status === 'changes_requested' ) {
                $status_label = __( 'Action Required â€” Video Changes Received', 'n88-rfq-platform' );
                $status_color = '#ff8800';
                $is_action_required = true;
            } elseif ( $cad_released && ! in_array( (string) $prototype_status, array( 'submitted', 'approved', 'changes_requested' ), true ) ) {
                // CAD files sent to supplier; supplier must submit prototype video (any state except already submitted/approved/changes_requested)
                $status_label = __( 'Action Required â€” CAD Files approved', 'n88-rfq-platform' );
                $status_color = '#ff4500';
                $is_action_required = true;
            } elseif ( $show_action_required && $has_unread_operator_messages ) {
                $status_label = __( 'Action Required â€” Message from operator', 'n88-rfq-platform' );
                $status_color = '#ff4500';
                $is_action_required = true;
            } elseif ( $action_badge === 'submit_bid' ) {
                $status_label = __( 'Action Required â€” Submit proposal', 'n88-rfq-platform' );
                $status_color = '#ff4500';
                $is_action_required = true;
            } elseif ( $action_badge === 'continue_draft' ) {
                $status_label = __( 'Action Required â€” Continue draft', 'n88-rfq-platform' );
                $status_color = '#ff8800';
                $is_action_required = true;
            } elseif ( $action_badge === 'specs_changed' ) {
                $status_label = __( 'Action Required â€” Specs changed, update bid', 'n88-rfq-platform' );
                $status_color = '#ff8800';
                $is_action_required = true;
            } elseif ( $action_badge === 'cad_video_approved' || ( $cad_released && $prototype_status === 'approved' ) ) {
                $status_label = __( 'Video approved', 'n88-rfq-platform' );
                $status_color = '#00ff00';
            } elseif ( $action_badge === 'submitted' && $cad_released && $prototype_status === 'submitted' ) {
                $status_label = __( 'Prototype video submitted - Under review', 'n88-rfq-platform' );
                $status_color = '#66aaff';
            } elseif ( $action_badge === 'submitted' && $has_prototype_payment && $prototype_payment_status !== 'requested' && ! $cad_released ) {
                // Operator approved payment; CAD not yet released to supplier
                $status_label = __( 'Payment Received â€” CAD Pending', 'n88-rfq-platform' );
                $status_color = '#66aaff';
            } elseif ( $action_badge === 'submitted' && $has_prototype_payment && $prototype_payment_status === 'requested' ) {
                // Designer requested CAD; payment not yet approved
                $status_label = __( 'CAD Requested - Pending Payment', 'n88-rfq-platform' );
                $status_color = '#ff5722'; // red-orange for pending payment
            } elseif ( $action_badge === 'submitted' && $cad_released ) {
                $status_label = __( 'CAD received â€” Pending video', 'n88-rfq-platform' );
                $status_color = '#66aaff';
            } elseif ( $action_badge === 'submitted' ) {
                $status_label = __( 'Proposal submitted', 'n88-rfq-platform' );
                $status_color = '#ff9800'; // orange
            } else {
                if ( $cad_released && $prototype_status === 'approved' ) {
                    $status_label = __( 'Video approved', 'n88-rfq-platform' );
                    $status_color = '#00ff00';
                } elseif ( $cad_released && $prototype_status === 'changes_requested' ) {
                    $status_label = __( 'Action Required â€” Video Changes Received', 'n88-rfq-platform' );
                    $status_color = '#ff8800';
                    $is_action_required = true;
                } elseif ( $cad_released && ! in_array( (string) $prototype_status, array( 'submitted', 'approved', 'changes_requested' ), true ) ) {
                    $status_label = __( 'Action Required â€” CAD Files approved', 'n88-rfq-platform' );
                    $status_color = '#ff4500';
                    $is_action_required = true;
                } elseif ( $cad_released ) {
                    $status_label = __( 'CAD received â€” Pending video', 'n88-rfq-platform' );
                    $status_color = '#66aaff';
                } elseif ( $cad_status === 'approved' ) {
                    $status_label = __( 'CAD approved â€” Pending release', 'n88-rfq-platform' );
                    $status_color = '#66aaff';
                } elseif ( $cad_status ) {
                    $status_label = __( 'CAD in progress', 'n88-rfq-platform' );
                    $status_color = '#66aaff';
                } else {
                    $status_label = __( 'Bid request received', 'n88-rfq-platform' );
                    $status_color = '#fff';
                }
            }
            $item_data['supplier_status_label'] = $status_label;
            $item_data['supplier_status_color'] = $status_color;
            $item_data['supplier_is_action_required'] = $is_action_required;

            $items_by_id[ $item_id ] = $item_data;
        }

        // Apply filters (M5)
        $filtered_items = array();
        foreach ( $items_by_id as $item_id => $item_data ) {
            // Status filter
            $passes_status = false;
            if ( $status_filter === 'all' ) {
                $passes_status = true;
            } elseif ( $status_filter === 'needs_action' ) {
                // Show items where supplier must send something: proposal, draft, update bid, video, reply to operator, or submit video after CAD
                $passes_status = in_array( $item_data['action_badge'], array( 'submit_bid', 'continue_draft', 'specs_changed', 'changes_received' ), true )
                    || ! empty( $item_data['show_action_required'] )
                    || ! empty( $item_data['supplier_is_action_required'] );
            } elseif ( $status_filter === 'draft_saved' ) {
                $passes_status = $item_data['action_badge'] === 'continue_draft';
            } elseif ( $status_filter === 'submitted' ) {
                $passes_status = $item_data['action_badge'] === 'submitted';
            } elseif ( $status_filter === 'expired' ) {
                $passes_status = $item_data['action_badge'] === 'expired';
            } elseif ( $status_filter === 'awarded' ) {
                $passes_status = $item_data['action_badge'] === 'awarded';
            }
            
            if ( ! $passes_status ) {
                continue;
            }
            
            // Time remaining filter
            if ( $time_remaining_filter !== 'all' && $item_data['time_remaining'] ) {
                $hours_remaining = $this->parse_time_remaining_hours( $item_data['time_remaining'] );
                if ( $time_remaining_filter === 'due_soon' && $hours_remaining > 24 ) {
                    continue;
                } elseif ( $time_remaining_filter === 'active' && ( $hours_remaining <= 24 || $hours_remaining > 72 ) ) {
                    continue;
                } elseif ( $time_remaining_filter === 'later' && $hours_remaining <= 72 ) {
                    continue;
                }
            }
            
            // Category filter
            if ( $category_filter !== 'all' ) {
                $category_name_lower = strtolower( $item_data['category_name'] ?: '' );
                if ( $category_name_lower !== strtolower( $category_filter ) ) {
                    continue;
                }
            }
            
            // Search filter
            if ( ! empty( $search ) ) {
                $search_lower = strtolower( $search );
                $item_title_lower = strtolower( $item_data['title'] ?: '' );
                $item_id_str = (string) $item_id;
                if ( strpos( $item_title_lower, $search_lower ) === false && strpos( $item_id_str, $search ) === false ) {
                    continue;
                }
            }
            
            $filtered_items[ $item_id ] = $item_data;
        }
        
        // Pagination: Calculate total pages and slice items
        $total_items = count( $filtered_items );
        $total_pages = ceil( $total_items / $items_per_page );
        $offset = ( $current_page - 1 ) * $items_per_page;
        
        // Slice items for current page (preserve array keys for item IDs)
        $paginated_items = array_slice( $filtered_items, $offset, $items_per_page, true );
        
        // Get all categories for dropdown
        $all_categories = $wpdb->get_results( "SELECT DISTINCT name FROM {$categories_table} WHERE name IS NOT NULL ORDER BY name", ARRAY_A );
        
        ob_start();
        ?>
        <!-- Supplier Queue - Dark Theme Terminal Style (M) -->
        <div class="n88-supplier-queue" style="background-color: #000; color: #fff; font-family: 'Courier New', Courier, monospace; min-height: 100vh; padding: 20px;">
            <!-- Header Section -->
            <div style="border: 2px dashed #fff; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 style="margin: 0; font-size: 18px; font-weight: normal; color: #fff; font-family: 'Courier New', Courier, monospace;">Supplier Queue â€” RFQs Requiring Action</h1>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 14px; color: #fff;">Logged in as: <?php echo esc_html( strtolower( $current_user->display_name ) ); ?></span>
                        <a href="<?php echo esc_url( wp_logout_url( home_url( '/login/' ) ) ); ?>" style="padding: 4px 8px; border: 1px solid #fff; color: #fff; text-decoration: none; font-size: 12px; font-family: 'Courier New', Courier, monospace;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='transparent';">[ Logout ]</a>
                    </div>
                </div>
            </div>
            
            <!-- Filters Section -->
            <div style="border: 2px dashed #fff; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #fff; font-family: 'Courier New', Courier, monospace;">FILTERS</div>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div>
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Status:</label>
                        <select id="n88-supplier-status" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;">
                            <option value="needs_action" <?php selected( $status_filter, 'needs_action' ); ?>><?php esc_html_e( 'Action Required', 'n88-rfq-platform' ); ?></option>
                            <option value="draft_saved" <?php selected( $status_filter, 'draft_saved' ); ?>><?php esc_html_e( 'Draft Saved', 'n88-rfq-platform' ); ?></option>
                            <option value="submitted" <?php selected( $status_filter, 'submitted' ); ?>><?php esc_html_e( 'Submitted', 'n88-rfq-platform' ); ?></option>
                            <option value="awarded" <?php selected( $status_filter, 'awarded' ); ?>><?php esc_html_e( 'Awarded', 'n88-rfq-platform' ); ?></option>
                            <option value="expired" <?php selected( $status_filter, 'expired' ); ?>><?php esc_html_e( 'Expired', 'n88-rfq-platform' ); ?></option>
                            <option value="all" <?php selected( $status_filter, 'all' ); ?>><?php esc_html_e( 'All', 'n88-rfq-platform' ); ?></option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Time Remaining:</label>
                        <select id="n88-supplier-time-remaining" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;">
                            <option value="all" <?php selected( $time_remaining_filter, 'all' ); ?>>All</option>
                            <option value="due_soon" <?php selected( $time_remaining_filter, 'due_soon' ); ?>>Due Soon (â‰¤24h)</option>
                            <option value="active" <?php selected( $time_remaining_filter, 'active' ); ?>>Active (24â€“72h)</option>
                            <option value="later" <?php selected( $time_remaining_filter, 'later' ); ?>>Later (>72h)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Category:</label>
                        <select id="n88-supplier-category" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;">
                            <option value="all" <?php selected( $category_filter, 'all' ); ?>>All</option>
                            <?php foreach ( $all_categories as $cat ) : ?>
                                <option value="<?php echo esc_attr( $cat['name'] ); ?>" <?php selected( $category_filter, $cat['name'] ); ?>><?php echo esc_html( $cat['name'] ); ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Search:</label>
                        <input type="text" id="n88-supplier-search" value="<?php echo esc_attr( $search ); ?>" placeholder="Search item label / Item #" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; width: 100%; max-width: 300px;">
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: #ccc; font-style: italic;">
                    <?php esc_html_e( 'Action Required = Submit proposal | Continue draft | Specs changed | Video changes | Message from operator', 'n88-rfq-platform' ); ?>
                </div>
            </div>
            
            <!-- Routed Items Section -->
            <div style="border: 2px dashed #fff; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #fff; font-family: 'Courier New', Courier, monospace;">ROUTED ITEMS (ANONYMOUS RFQs)</div>
                <div style="font-size: 11px; color: #ccc; margin-bottom: 5px;">Supplier sees ONLY items routed to them</div>
                <div style="font-size: 11px; color: #ccc;">No designer identity shown anywhere</div>
            </div>
            
            <!-- Items Table -->
            <div style="border: 2px solid #fff; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-family: 'Courier New', Courier, monospace;">
                    <thead>
                        <tr style="border-bottom: 2px solid #fff;">
                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff; border-right: 1px solid #fff;">Thumbnail</th>
                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff; border-right: 1px solid #fff;">Item Label</th>
                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff; border-right: 1px solid #fff;">Category</th>
                            <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php if ( empty( $paginated_items ) ) : ?>
                            <tr>
                                <td colspan="4" style="padding: 20px; text-align: center; color: #999; font-size: 12px;">No items found matching the selected filters.</td>
                            </tr>
                        <?php else : ?>
                            <?php foreach ( $paginated_items as $item_id => $item_data ) : 
                                $item_title = $item_data['title'] ?: 'Item #' . $item_id;
                                $category = $item_data['category_name'] ?: $item_data['item_type'] ?: 'Uncategorized';
                                
                                // Get thumbnail
                                $thumbnail_url = '';
                                if ( ! empty( $item_data['primary_image_id'] ) ) {
                                    $thumbnail_url = wp_get_attachment_image_url( $item_data['primary_image_id'], 'thumbnail' );
                                    if ( ! $thumbnail_url ) {
                                        $thumbnail_url = wp_get_attachment_url( $item_data['primary_image_id'] );
                                    }
                                }
                                
                                // Determine action button text and badge
                                $action_button_text = '';
                                $action_badge_text = '';
                                $is_expired = $item_data['action_badge'] === 'expired';
                                
                                switch ( $item_data['action_badge'] ) {
                                    case 'awarded':
                                    case 'cad_video_approved':
                                    case 'changes_received':
                                    case 'submitted':
                                        $action_button_text = __( 'View', 'n88-rfq-platform' ) . ' â–º';
                                        break;
                                    case 'submit_bid':
                                        $action_button_text = __( 'Submit Proposal', 'n88-rfq-platform' ) . ' â–º';
                                        break;
                                    case 'continue_draft':
                                        $action_button_text = __( 'Continue Draft', 'n88-rfq-platform' ) . ' â–º';
                                        break;
                                    case 'specs_changed':
                                        $action_button_text = __( 'Update Bid', 'n88-rfq-platform' ) . ' â–º';
                                        break;
                                    case 'expired':
                                        $action_button_text = __( 'Expired', 'n88-rfq-platform' );
                                        break;
                                    default:
                                        $action_button_text = __( 'View', 'n88-rfq-platform' ) . ' â–º';
                                        break;
                                }
                            ?>
                                <tr style="border-bottom: 1px dashed #666;">
                                    <td style="padding: 12px; border-right: 1px solid #fff;">
                                        <?php if ( $thumbnail_url ) : ?>
                                            <img src="<?php echo esc_url( $thumbnail_url ); ?>" alt="Thumbnail" style="width: 60px; height: 60px; object-fit: cover; border: 1px solid #fff;">
                                        <?php else : ?>
                                            <div style="width: 60px; height: 60px; border: 1px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999;">[ img ]</div>
                                        <?php endif; ?>
                                    </td>
                                    <td style="padding: 12px; border-right: 1px solid #fff; font-size: 12px; color: #fff;">
                                        <?php echo esc_html( $item_title ); ?> (Item #<?php echo esc_html( $item_id ); ?>)
                                    </td>
                                    <td style="padding: 12px; border-right: 1px solid #fff; font-size: 12px; color: #fff;">
                                        <?php echo esc_html( $category ); ?>
                                    </td>
                                    <td style="padding: 12px; font-size: 12px;">
                                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                        <?php if ( ! $is_expired ) : ?>
                                            <button class="n88-open-bid-modal" 
                                                    data-item-id="<?php echo esc_attr( $item_id ); ?>" 
                                                    data-item-title="<?php echo esc_attr( $item_title ); ?>" 
                                                    data-category="<?php echo esc_attr( $category ); ?>"
                                                    data-action-badge="<?php echo esc_attr( $item_data['action_badge'] ); ?>"
                                                        style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 11px; cursor: pointer;" 
                                                    onmouseover="this.style.backgroundColor='#333';" 
                                                    onmouseout="this.style.backgroundColor='#000';">
                                                [ <?php echo esc_html( $action_button_text ); ?> ]
                                        </button>
                                        <?php else : ?>
                                            <span style="color: #999; font-size: 11px;">[ <?php echo esc_html( $action_button_text ); ?> ]</span>
                                        <?php endif; ?>
                                        </div>
                                        <div style="margin-top: 5px;">
                                            <?php
                                            $status_label = isset( $item_data['supplier_status_label'] ) ? $item_data['supplier_status_label'] : ucfirst( str_replace( '_', ' ', $item_data['action_badge'] ) );
                                            $status_color = isset( $item_data['supplier_status_color'] ) ? $item_data['supplier_status_color'] : '#fff';
                                            $is_action = ! empty( $item_data['supplier_is_action_required'] );
                                            ?>
                                            <span style="color: <?php echo esc_attr( $status_color ); ?>; font-size: 11px; font-weight: <?php echo $is_action ? '600' : 'normal'; ?>;"><?php echo $is_action ? 'âš  ' : ''; ?><?php echo esc_html( $status_label ); ?></span>
                                        <?php if ( $item_data['action_badge'] === 'specs_changed' ) : ?>
                                            <div style="color: #ff0; font-size: 10px; margin-top: 3px;">Revision mismatch</div>
                                        <?php endif; ?>
                                        <?php if ( $item_data['time_remaining'] ) : ?>
                                            <div style="color: #fff; font-size: 11px; margin-top: 3px;">Expires in: <?php echo esc_html( $item_data['time_remaining'] ); ?></div>
                                        <?php endif; ?>
                                        </div>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <?php if ( $total_pages > 1 ) : ?>
                <div style="border: 2px dashed #fff; padding: 15px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: #fff;">
                        Showing <?php echo esc_html( $offset + 1 ); ?>-<?php echo esc_html( min( $offset + $items_per_page, $total_items ) ); ?> of <?php echo esc_html( $total_items ); ?> items
            </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                                <?php
                        // Build pagination URLs preserving all query parameters
                        $query_params = array();
                        if ( $status_filter !== 'needs_action' ) {
                            $query_params['status'] = $status_filter;
                        }
                        if ( $time_remaining_filter !== 'all' ) {
                            $query_params['time_remaining'] = $time_remaining_filter;
                        }
                        if ( $category_filter !== 'all' ) {
                            $query_params['category'] = $category_filter;
                        }
                        if ( ! empty( $search ) ) {
                            $query_params['search'] = $search;
                        }
                        
                        if ( $current_page > 1 ) : 
                            $query_params['page'] = $current_page - 1;
                            $prev_url = add_query_arg( $query_params, home_url( '/supplier/queue' ) );
                        ?>
                            <a href="<?php echo esc_url( $prev_url ); ?>" 
                               style="padding: 4px 8px; border: 1px solid #fff; color: #fff; text-decoration: none; font-size: 12px; font-family: 'Courier New', Courier, monospace;" 
                               onmouseover="this.style.backgroundColor='#333';" 
                               onmouseout="this.style.backgroundColor='transparent';">
                                [ Previous ]
                            </a>
                        <?php else : ?>
                            <span style="padding: 4px 8px; border: 1px solid #666; color: #666; font-size: 12px; font-family: 'Courier New', Courier, monospace; cursor: not-allowed;">[ Previous ]</span>
                        <?php endif; ?>
                        
                        <span style="font-size: 12px; color: #fff; font-family: 'Courier New', Courier, monospace;">
                            Page <?php echo esc_html( $current_page ); ?> of <?php echo esc_html( $total_pages ); ?>
                        </span>
                        
                        <?php if ( $current_page < $total_pages ) : 
                            $query_params['page'] = $current_page + 1;
                            $next_url = add_query_arg( $query_params, home_url( '/supplier/queue' ) );
                        ?>
                            <a href="<?php echo esc_url( $next_url ); ?>" 
                               style="padding: 4px 8px; border: 1px solid #fff; color: #fff; text-decoration: none; font-size: 12px; font-family: 'Courier New', Courier, monospace;" 
                               onmouseover="this.style.backgroundColor='#333';" 
                               onmouseout="this.style.backgroundColor='transparent';">
                                [ Next ]
                            </a>
                        <?php else : ?>
                            <span style="padding: 4px 8px; border: 1px solid #666; color: #666; font-size: 12px; font-family: 'Courier New', Courier, monospace; cursor: not-allowed;">[ Next ]</span>
                        <?php endif; ?>
            </div>
                </div>
            <?php endif; ?>
        </div>
        
        <!-- Supplier RFQ Detail Modal - Contained layout with spacing and rounded corners (like designer modal) -->
        <div id="n88-supplier-bid-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 10000; overflow: hidden;">
            <div id="n88-supplier-bid-modal-content" style="position: fixed; top: 24px; left: 24px; right: 24px; bottom: 24px; max-width: calc(100vw - 48px); max-height: calc(100vh - 48px); background-color: #000 !important; z-index: 10001; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #555; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
                <!-- Modal content will be populated by JavaScript: header, then left (images) + right (tabs) -->
            </div>
        </div>
        
        <!-- Supplier Bid Form Modal (Commit 2.3.5.2: Dark theme with green accents) -->
        <div id="n88-supplier-bid-form-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 10002; overflow: hidden;">
            <div id="n88-supplier-bid-form-modal-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 700px; max-width: 95vw; max-height: 95vh; background-color: #000; box-shadow: 0 4px 20px rgba(0,255,0,0.3); z-index: 10003; display: flex; flex-direction: column; overflow: hidden; border: none; border-radius: 4px;">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Supplier Image Lightbox (Commit 2.3.5.1) -->
        <div id="n88-supplier-image-lightbox" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.9); z-index: 10004; overflow: hidden; cursor: pointer;" onclick="closeSupplierImageLightbox(event);">
            <div style="position: absolute; top: 20px; right: 20px; z-index: 10005;">
                <button onclick="closeSupplierImageLightbox(event); event.stopPropagation();" style="background: rgba(255, 255, 255, 0.9); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; color: #333; display: flex; align-items: center; justify-content: center; line-height: 1; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" onmouseover="this.style.background='rgba(255, 255, 255, 1)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.9)';" title="Close">Ã—</button>
            </div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90vw; max-height: 90vh; display: flex; align-items: center; justify-content: center;" onclick="event.stopPropagation();">
                <img id="n88-supplier-lightbox-image" src="" style="max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);" alt="Enlarged image" />
            </div>
        </div>
        
        <script>
        (function() {
            // Filter persistence via URL query parameters (M5)
            var searchTimeout;
            function updateSupplierQueueURL() {
                var status = document.getElementById('n88-supplier-status')?.value || 'needs_action';
                var timeRemaining = document.getElementById('n88-supplier-time-remaining')?.value || 'all';
                var category = document.getElementById('n88-supplier-category')?.value || 'all';
                var search = document.getElementById('n88-supplier-search')?.value || '';
                
                var params = new URLSearchParams(window.location.search);
                
                if (status && status !== 'needs_action') {
                    params.set('status', status);
                } else {
                    params.delete('status');
                }
                
                if (timeRemaining && timeRemaining !== 'all') {
                    params.set('time_remaining', timeRemaining);
                } else {
                    params.delete('time_remaining');
                }
                
                if (category && category !== 'all') {
                    params.set('category', category);
                } else {
                    params.delete('category');
                }
                
                if (search && search.trim()) {
                    params.set('search', search.trim());
                } else {
                    params.delete('search');
                }
                
                // Reset to page 1 when filters change
                params.delete('page');
                
                // Reload page to apply filters
                window.location.href = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            }
            
            // Attach event listeners to filter elements
            document.addEventListener('DOMContentLoaded', function() {
                var statusSelect = document.getElementById('n88-supplier-status');
                var timeRemainingSelect = document.getElementById('n88-supplier-time-remaining');
                var categorySelect = document.getElementById('n88-supplier-category');
                var searchInput = document.getElementById('n88-supplier-search');
                
                if (statusSelect) {
                    statusSelect.addEventListener('change', updateSupplierQueueURL);
                }
                if (timeRemainingSelect) {
                    timeRemainingSelect.addEventListener('change', updateSupplierQueueURL);
                }
                if (categorySelect) {
                    categorySelect.addEventListener('change', updateSupplierQueueURL);
                }
                if (searchInput) {
                    // Debounce search input
                    searchInput.addEventListener('input', function() {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(updateSupplierQueueURL, 500);
                    });
                }
                
                // Commit 2.3.9.1C-a: Attach event listeners to Operatorâ€“Supplier Messages (clarification) buttons
                var clarificationButtons = document.querySelectorAll('.n88-open-clarification-modal');
                clarificationButtons.forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var itemId = this.getAttribute('data-item-id');
                        var itemTitle = this.getAttribute('data-item-title') || 'Item #' + itemId;
                        openSupplierClarificationModal(itemId, itemTitle);
                    });
                });
            });
            
            // Commit 2.3.9.1C-a: Toggle Supplier Clarification Section
            function toggleSupplierClarification(itemId) {
                var formContainer = document.getElementById('n88-supplier-clarification-form-' + itemId);
                if (!formContainer) return;
                
                if (formContainer.style.display === 'none' || !formContainer.style.display) {
                    formContainer.style.display = 'flex';
                    loadSupplierMessagesInline(itemId);
                } else {
                    formContainer.style.display = 'none';
                }
            }
            
            // Commit 2.3.9.1C-a: Load Supplier Messages (Inline)
            function loadSupplierMessagesInline(itemId) {
                var messagesContainer = document.getElementById('n88-supplier-clarification-messages-' + itemId);
                if (!messagesContainer) return;
                
                messagesContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px; padding: 20px;">Loading conversation...</div>';
                
                var formData = new FormData();
                formData.append('action', 'n88_get_item_messages');
                formData.append('item_id', itemId);
                formData.append('thread_type', 'supplier_operator');
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_item_messages' ); ?>');
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.data && data.data.messages) {
                        var opts = {
                            has_operator_reply: !!(data.data.has_operator_reply),
                            supplier_confirmed_clarification: !!(data.data.supplier_confirmed_clarification),
                            has_operator_reply_after_confirmation: !!(data.data.has_operator_reply_after_confirmation),
                            supplier_has_submitted_bid: !!(data.data.supplier_has_submitted_bid),
                            bid_id: data.data.bid_id || 0
                        };
                        renderSupplierMessagesInline(data.data.messages, itemId, opts);
                    } else {
                        messagesContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px; padding: 20px;">No messages yet. Start the conversation!</div>';
                    }
                })
                .catch(function(error) {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div style="text-align: center; color: #ff0000; font-size: 12px; padding: 20px;">Error loading messages. Please try again.</div>';
                });
            }
            
            // Commit 2.3.9.1C-a: Render Supplier Messages (Inline) - WhatsApp Style
            function renderSupplierMessagesInline(messages, itemId, opts) {
                opts = opts || {};
                var messagesContainer = document.getElementById('n88-supplier-clarification-messages-' + itemId);
                if (!messagesContainer) return;
                
                if (!messages || messages.length === 0) {
                    messagesContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px; padding: 20px; margin: auto;">No messages yet. Start the conversation!</div>';
                    return;
                }
                
                // Sort messages chronologically
                var sortedMessages = messages.slice().sort(function(a, b) {
                    return new Date(a.created_at) - new Date(b.created_at);
                });
                
                var html = '';
                sortedMessages.forEach(function(msg) {
                    var isSupplier = msg.sender_role === 'supplier';
                    var senderName = isSupplier ? 'You' : 'Operator';
                    var categoryDisplay = msg.category ? ' [' + msg.category + ']' : '';
                    
                    var date = new Date(msg.created_at);
                    var dateStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    var rawText = msg.message_text || '';
                    
                    // Commit 2.3.9.2A: Detect "Approved CAD Released" message and parse files
                    var isCadReleasedMessage = !isSupplier &&
                        rawText.indexOf('Approved CAD Released') !== -1 &&
                        rawText.indexOf('CAD Files:') !== -1;
                    
                    var renderedText = rawText;
                    var cadFiles = [];
                    
                    if (isCadReleasedMessage) {
                        var lines = rawText.split('\n');
                        var filesStartIndex = -1;
                        for (var li = 0; li < lines.length; li++) {
                            if ((lines[li] || '').trim() === 'CAD Files:' || (lines[li] || '').trim() === 'Files:') {
                                filesStartIndex = li;
                                break;
                            }
                        }
                        if (filesStartIndex >= 0) {
                            // Find where files section ends (before "Direction Keywords" or end of message)
                            var filesEndIndex = filesStartIndex + 1;
                            for (var li = filesStartIndex + 1; li < lines.length; li++) {
                                if ((lines[li] || '').trim().indexOf('Direction Keywords') === 0 || (lines[li] || '').trim() === '') {
                                    filesEndIndex = li;
                                    break;
                                }
                            }
                            renderedText = lines.slice(0, filesStartIndex).join('\n');
                            var fileLines = lines.slice(filesStartIndex + 1, filesEndIndex);
                            for (var fi = 0; fi < fileLines.length; fi++) {
                                var line = (fileLines[fi] || '').trim();
                                if (line.indexOf('- ') === 0) {
                                    var withoutDash = line.slice(2);
                                    var sepIdx = withoutDash.indexOf(': ');
                                    if (sepIdx > 0) {
                                        var fileName = withoutDash.slice(0, sepIdx).trim();
                                        var fileUrl = withoutDash.slice(sepIdx + 2).trim();
                                        if (fileUrl.indexOf('http://') === 0 || fileUrl.indexOf('https://') === 0) {
                                            var ext = '';
                                            if (fileName.indexOf('.') !== -1) {
                                                ext = fileName.split('.').pop().toLowerCase();
                                            }
                                            cadFiles.push({ name: fileName, url: fileUrl, ext: ext });
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    html += '<div style="margin-bottom: 12px; display: flex; justify-content: ' + (isSupplier ? 'flex-end' : 'flex-start') + '; width: 100%;">';
                    html += '<div style="max-width: 75%; padding: 10px 14px; background-color: ' + (isSupplier ? '#1a1a1a' : '#0a0a0a') + '; border: 1px solid #555; border-radius: ' + (isSupplier ? '12px 12px 4px 12px' : '12px 12px 12px 4px') + '; font-size: 12px; color: #fff; word-wrap: break-word; white-space: pre-wrap;">';
                    html += '<div style="font-size: 10px; font-weight: 600; color: ' + (isSupplier ? '#00ff00' : '#00aa00') + '; margin-bottom: 4px;">' + senderName + categoryDisplay + '</div>';
                    html += '<div style="font-size: 12px; line-height: 1.4; margin-bottom: 4px;">' + renderedText.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                    
                    // Commit 2.3.9.2A: Render CAD file cards for "Approved CAD Released" messages
                    if (isCadReleasedMessage && cadFiles.length > 0) {
                        html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333; display: flex; flex-direction: column; gap: 8px;">';
                        cadFiles.forEach(function(file) {
                            var isPdf = file.ext === 'pdf';
                            var isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].indexOf(file.ext) !== -1;
                            var icon = isPdf ? 'ðŸ“„' : (isImage ? 'ðŸ–¼ï¸' : 'ðŸ“Ž');
                            html += '<a href="' + file.url.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 4px; text-decoration: none; color: #fff; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'#222\'; this.style.borderColor=\'#00ff00\';" onmouseout="this.style.backgroundColor=\'#0a0a0a\'; this.style.borderColor=\'#333\';">';
                            html += '<div style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: #000; border-radius: 4px; flex-shrink: 0;"><span style="font-size: 20px;">' + icon + '</span></div>';
                            html += '<div style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 11px;">' + file.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                            html += '<div style="font-size: 10px; color: #00ff00; flex-shrink: 0;">Open â†’</div>';
                            html += '</a>';
                        });
                        html += '</div>';
                    }
                    
                    html += '<div style="font-size: 9px; color: #666; text-align: right;">' + dateStr + '</div>';
                    html += '</div>';
                    html += '</div>';
                });
                
                // Supplier: "Mark as Clarified" when operator replied; after clarified show "Submit Proposal" (hide if already submitted). If operator replied again after clarify, show "Mark as Clarified" again.
                if (opts.has_operator_reply) {
                    html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333; display: flex; align-items: center; justify-content: flex-start; flex-wrap: wrap; gap: 8px;">';
                    if (opts.has_operator_reply_after_confirmation) {
                        var bidIdVal = (opts.bid_id || 0);
                        html += '<button type="button" class="n88-supplier-mark-clarified-btn" data-item-id="' + itemId + '" data-bid-id="' + bidIdVal + '" style="padding: 6px 12px; font-size: 11px; background-color: #1a1a1a; color: #00ff00; border: 1px solid #555; border-radius: 10px; cursor: pointer; font-family: \'Courier New\', Courier, monospace;" onmouseover="this.style.backgroundColor=\'#222\'; this.style.borderColor=\'#666\';" onmouseout="this.style.backgroundColor=\'#1a1a1a\'; this.style.borderColor=\'#555\';">Mark as Clarified</button>';
                    } else if (opts.supplier_confirmed_clarification) {
                        html += '<span style="font-size: 11px; color: #00aa00;">âœ“ Clarified</span>';
                        if (!opts.supplier_has_submitted_bid) {
                            html += '<button type="button" class="n88-supplier-submit-proposal-from-overview" data-item-id="' + itemId + '" style="padding: 8px 16px; font-size: 12px; background-color: #1a1a1a; color: #00ff00; border: 1px solid #555; border-radius: 10px; cursor: pointer; font-family: \'Courier New\', Courier, monospace; font-weight: 600;" onmouseover="this.style.backgroundColor=\'#222\'; this.style.borderColor=\'#666\';" onmouseout="this.style.backgroundColor=\'#1a1a1a\'; this.style.borderColor=\'#555\';">Submit Proposal</button>';
                        }
                    } else {
                        var bidIdVal = (opts.bid_id || 0);
                        html += '<button type="button" class="n88-supplier-mark-clarified-btn" data-item-id="' + itemId + '" data-bid-id="' + bidIdVal + '" style="padding: 6px 12px; font-size: 11px; background-color: #1a1a1a; color: #00ff00; border: 1px solid #555; border-radius: 10px; cursor: pointer; font-family: \'Courier New\', Courier, monospace;" onmouseover="this.style.backgroundColor=\'#222\'; this.style.borderColor=\'#666\';" onmouseout="this.style.backgroundColor=\'#1a1a1a\'; this.style.borderColor=\'#555\';">Mark as Clarified</button>';
                    }
                    html += '</div>';
                }
                
                messagesContainer.innerHTML = html;
                setTimeout(function() {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }
            
            // Supplier: confirm clarification (operator sees via case_resolutions)
            function supplierConfirmClarification(itemId, bidId) {
                var btn = document.querySelector('.n88-supplier-mark-clarified-btn[data-item-id="' + itemId + '"]');
                if (btn) { btn.disabled = true; btn.textContent = '...'; }
                var formData = new FormData();
                formData.append('action', 'n88_supplier_confirm_clarification');
                formData.append('item_id', itemId);
                formData.append('bid_id', bidId || '0');
                formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_supplier_confirm_clarification' ) ); ?>');
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', { method: 'POST', body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.success) {
                            loadSupplierMessagesInline(itemId);
                        } else {
                            if (btn) { btn.disabled = false; btn.textContent = 'Mark as Clarified'; }
                            alert(data.data && data.data.message ? data.data.message : 'Failed.');
                        }
                    })
                    .catch(function() {
                        if (btn) { btn.disabled = false; btn.textContent = 'Mark as Clarified'; }
                        alert('An error occurred. Please try again.');
                    });
            }
            
            // Delegated click for supplier "Mark as clarified" button (buttons are inside dynamically rendered messages)
            document.addEventListener('click', function(e) {
                var btn = e.target && e.target.closest ? e.target.closest('.n88-supplier-mark-clarified-btn') : null;
                if (!btn || btn.disabled) return;
                var itemId = btn.getAttribute('data-item-id');
                var bidId = btn.getAttribute('data-bid-id') || '0';
                if (itemId && typeof supplierConfirmClarification === 'function') {
                    supplierConfirmClarification(itemId, bidId);
                }
            });
            // Delegated click for "Submit Proposal" in Overview (after Mark as Clarified): go to Proposal tab and open form
            document.addEventListener('click', function(e) {
                var btn = e.target && e.target.closest ? e.target.closest('.n88-supplier-submit-proposal-from-overview') : null;
                if (!btn) return;
                var itemId = btn.getAttribute('data-item-id');
                if (!itemId) return;
                if (typeof n88SupplierModalSwitchTab === 'function') n88SupplierModalSwitchTab('bid');
                if (typeof toggleBidForm === 'function') toggleBidForm(itemId);
            });
            
            // Commit 2.3.9.1C-a: Send Supplier Clarification (Inline)
            function sendSupplierClarificationInline(event, itemId) {
                event.preventDefault();
                
                var messageText = document.getElementById('n88-clarification-message-' + itemId);
                var category = document.getElementById('n88-clarification-category-' + itemId);
                
                if (!messageText || !messageText.value.trim()) {
                    alert('Please enter a message.');
                    return false;
                }
                
                var formData = new FormData();
                formData.append('action', 'n88_send_item_message');
                formData.append('item_id', itemId);
                formData.append('thread_type', 'supplier_operator');
                formData.append('message_text', messageText.value.trim());
                formData.append('category', category ? category.value : '');
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_send_item_message' ); ?>');
                
                // Disable form
                var submitBtn = event.target.querySelector('button[type="submit"]');
                var originalText = submitBtn ? submitBtn.textContent : '';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = '[ Sending... ]';
                }
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        // Clear form
                        messageText.value = '';
                        if (category) category.value = '';
                        
                        // Reload messages
                        loadSupplierMessagesInline(itemId);
                    } else {
                        alert('Error: ' + (data.data?.message || 'Failed to send message. Please try again.'));
                    }
                    
                    // Re-enable form
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                })
                .catch(function(error) {
                    console.error('Error sending message:', error);
                    alert('An error occurred. Please try again.');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
                
                return false;
            }
            
            // Make functions globally available
            window.toggleSupplierClarification = toggleSupplierClarification;
            window.sendSupplierClarificationInline = sendSupplierClarificationInline;
            
            // Commit 2.3.9.2B-S: Prototype Video Submission Handlers
            function initPrototypeVideoForms() {
                // Handle Add Link button
                document.querySelectorAll('.n88-add-link-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var paymentId = this.getAttribute('id').replace('n88-add-link-btn-', '');
                        var container = document.getElementById('n88-video-links-container-' + paymentId);
                        if (!container) return;
                        
                        var currentRows = container.querySelectorAll('.n88-video-link-row');
                        if (currentRows.length >= 3) {
                            alert('Maximum 3 links allowed per submission.');
                            return;
                        }
                        
                        var newRow = document.createElement('div');
                        newRow.className = 'n88-video-link-row';
                        newRow.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
                        newRow.innerHTML = 
                            '<select class="n88-video-provider" style="flex: 0 0 120px; padding: 8px; background-color: #000; color: #fff; border: 1px solid #333; border-radius: 4px; font-family: monospace; font-size: 11px;">' +
                            '<option value="youtube">YouTube</option>' +
                            '<option value="vimeo">Vimeo</option>' +
                            '<option value="loom">Loom</option>' +
                            '</select>' +
                            '<input type="url" class="n88-video-url" placeholder="https://..." style="flex: 1; padding: 8px; background-color: #000; color: #fff; border: 1px solid #333; border-radius: 4px; font-family: monospace; font-size: 11px;" required />' +
                            '<button type="button" class="n88-remove-link-btn" style="padding: 8px 12px; background-color: #333; color: #ff6666; border: 1px solid #666; border-radius: 4px; font-family: monospace; font-size: 11px; cursor: pointer;">Remove</button>';
                        
                        container.appendChild(newRow);
                        
                        // Show remove buttons if more than 1 row
                        var allRows = container.querySelectorAll('.n88-video-link-row');
                        if (allRows.length > 1) {
                            allRows.forEach(function(row) {
                                var removeBtn = row.querySelector('.n88-remove-link-btn');
                                if (removeBtn) removeBtn.style.display = 'block';
                            });
                        }
                        
                        // Update add button visibility
                        if (allRows.length >= 3) {
                            btn.style.display = 'none';
                        }
                    });
                });
                
                // Handle Remove Link button
                document.querySelectorAll('.n88-remove-link-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var row = this.closest('.n88-video-link-row');
                        var container = row ? row.parentElement : null;
                        if (row && container) {
                            row.remove();
                            
                            // Hide remove buttons if only 1 row left
                            var remainingRows = container.querySelectorAll('.n88-video-link-row');
                            if (remainingRows.length <= 1) {
                                remainingRows.forEach(function(r) {
                                    var removeBtn = r.querySelector('.n88-remove-link-btn');
                                    if (removeBtn) removeBtn.style.display = 'none';
                                });
                            }
                            
                            // Show add button if less than 3 rows
                            var paymentId = container.getAttribute('id').replace('n88-video-links-container-', '');
                            var addBtn = document.getElementById('n88-add-link-btn-' + paymentId);
                            if (addBtn && remainingRows.length < 3) {
                                addBtn.style.display = 'block';
                            }
                        }
                    });
                });
                
                // Handle form submission (bind once per form to avoid double submit / double alert)
                document.querySelectorAll('[id^="n88-submit-prototype-video-form-"]').forEach(function(form) {
                    if (form.getAttribute('data-n88-prototype-form-initialized') === '1') return;
                    form.setAttribute('data-n88-prototype-form-initialized', '1');
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        var paymentId = this.getAttribute('data-payment-id');
                        var itemId = this.getAttribute('data-item-id');
                        var bidId = this.getAttribute('data-bid-id');
                        
                        if (!paymentId) {
                            alert('Invalid payment ID.');
                            return;
                        }
                        
                        var container = document.getElementById('n88-video-links-container-' + paymentId);
                        if (!container) {
                            alert('Form container not found.');
                            return;
                        }
                        
                        var rows = container.querySelectorAll('.n88-video-link-row');
                        if (rows.length === 0) {
                            alert('Please add at least one video link.');
                            return;
                        }
                        
                        var videoLinks = [];
                        rows.forEach(function(row) {
                            var provider = row.querySelector('.n88-video-provider');
                            var url = row.querySelector('.n88-video-url');
                            if (provider && url && url.value.trim()) {
                                videoLinks.push({
                                    provider: provider.value,
                                    url: url.value.trim()
                                });
                            }
                        });
                        
                        if (videoLinks.length === 0) {
                            alert('Please enter at least one valid video link.');
                            return;
                        }
                        
                        if (videoLinks.length > 3) {
                            alert('Maximum 3 links allowed per submission.');
                            return;
                        }
                        
                        var submitBtn = this.querySelector('button[type="submit"]');
                        var originalText = submitBtn ? submitBtn.textContent : 'Submit';
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Submitting...';
                        }
                        
                        var formData = new FormData();
                        formData.append('action', 'n88_submit_prototype_video');
                        formData.append('payment_id', paymentId);
                        formData.append('video_links', JSON.stringify(videoLinks));
                        formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_submit_prototype_video' ) ); ?>');
                        
                        fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) { return response.json(); })
                        .then(function(data) {
                            if (data.success) {
                                // Show success message
                                alert(data.data.message || 'Prototype video submitted successfully!');
                                // Reload item details to refresh UI and show submission status
                                if (typeof openBidModal === 'function') {
                                    // Close and reopen modal to refresh content
                                    var modal = document.getElementById('n88-supplier-bid-modal');
                                    if (modal) {
                                        modal.style.display = 'none';
                                        setTimeout(function() {
                                            openBidModal(itemId);
                                        }, 300);
                                    } else {
                                        window.location.reload();
                                    }
                                } else {
                                    window.location.reload();
                                }
                            } else {
                                alert('Error: ' + (data.data?.message || 'Failed to submit prototype video.'));
                            }
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        })
                        .catch(function(error) {
                            console.error('Error submitting prototype video:', error);
                            alert('An error occurred. Please try again.');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        });
                    });
                });
            }
            
            // Initialize on DOM ready and after modal content updates
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPrototypeVideoForms);
            } else {
                initPrototypeVideoForms();
            }
            
            // Re-initialize after modal content is updated (use MutationObserver or call after modal update)
            window.initPrototypeVideoForms = initPrototypeVideoForms;
            
            function openBidModal(itemId, preferredTab) {
                // preferredTab: optional 'bid' to open on Proposal tab (e.g. after submitting proposal)
                // Ensure lightbox functions are available before creating modal HTML
                if (typeof window.openSupplierImageLightbox !== 'function') {
                    window.openSupplierImageLightbox = openSupplierImageLightbox;
                }
                if (typeof window.closeSupplierImageLightbox !== 'function') {
                    window.closeSupplierImageLightbox = closeSupplierImageLightbox;
                }
                
                var modal = document.getElementById('n88-supplier-bid-modal');
                var modalContent = document.getElementById('n88-supplier-bid-modal-content');
                
                if (!modal || !modalContent) return;
                
                // Show loading state
                modalContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">Loading item details...</div>';
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                // Fetch item details via AJAX (Commit 2.3.2)
                var formData = new FormData();
                formData.append('action', 'n88_get_supplier_item_details');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_supplier_item_details' ); ?>');
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (!data.success) {
                        modalContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #d32f2f;">' + 
                            '<p style="margin-bottom: 20px;">' + (data.data && data.data.message ? data.data.message : 'Error loading item details') + '</p>' +
                            '<button onclick="closeBidModal()" style="padding: 8px 16px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Close</button>' +
                            '</div>';
                        return;
                    }
                    
                    var item = data.data;
                    
                    // Format dimensions (Commit 2.3.5.4: Format as W Ã— D Ã— H + unit)
                    var dimsText = 'â€”';
                    if (item.dimensions) {
                        // Support both formats: {w, d, h, unit} and {width, depth, height, unit}
                        var w = item.dimensions.width || item.dimensions.w || 'â€”';
                        var d = item.dimensions.depth || item.dimensions.d || 'â€”';
                        var h = item.dimensions.height || item.dimensions.h || 'â€”';
                        var unit = item.dimensions.unit || '';
                        if (w !== 'â€”' && d !== 'â€”' && h !== 'â€”') {
                            var unitStr = unit === 'in' ? '"' : unit;
                            dimsText = w + unitStr + 'W Ã— ' + d + unitStr + 'D Ã— ' + h + unitStr + 'H';
                        }
                    }
                    
                    // Format keywords (Commit 2.3.5.4: Display keywords or "â€”")
                    var keywordsText = 'â€”';
                    if (item.keywords && Array.isArray(item.keywords) && item.keywords.length > 0) {
                        keywordsText = item.keywords.join(', ');
                    }
                    
                    // Format sourcing_type and timeline_type
                    var sourcingTypeText = item.sourcing_type || 'â€”';
                    var timelineTypeText = item.timeline_type || 'â€”';
                    
                    // Build reference images HTML - improved with better click handling
                    var refImagesHTML = '';
                    var refImages = item.reference_images || item.inspiration_images || [];
                    if (refImages && refImages.length > 0) {
                        refImagesHTML = '<div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 8px;">';
                        refImages.forEach(function(img, index) {
                            // Handle both object format {url, full_url} and string format
                            var imgUrl = '';
                            var fullUrl = '';
                            
                            if (typeof img === 'string') {
                                imgUrl = img;
                                fullUrl = img;
                            } else if (typeof img === 'object') {
                                imgUrl = img.url || img.thumbnail || img.thumb_url || '';
                                fullUrl = img.full_url || img.url || img.thumbnail || img.thumb_url || '';
                            }
                            
                            // Only add image if we have a valid URL
                            if (imgUrl && imgUrl.trim() !== '' && (imgUrl.startsWith('http://') || imgUrl.startsWith('https://'))) {
                                var imgId = 'n88-ref-img-view-' + item.item_id + '-' + index;
                                // Commit 2.3.5.1: Use lightbox instead of opening in new tab
                                var escapedFullUrl = (fullUrl || imgUrl).replace(/'/g, "\\'").replace(/\\/g, '\\\\').replace(/"/g, '&quot;');
                                refImagesHTML += '<div style="position: relative;">' +
                                    '<img id="' + imgId + '" ' +
                                    'src="' + imgUrl.replace(/"/g, '&quot;') + '" ' +
                                    'data-full-url="' + (fullUrl || imgUrl).replace(/"/g, '&quot;') + '" ' +
                                    'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23f0f0f0\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'12\'%3EImage%3C/text%3E%3C/svg%3E\';" ' +
                                    'style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.2s; background-color: #f0f0f0;" ' +
                                    'onmouseover="this.style.borderColor=\'#0073aa\'; this.style.transform=\'scale(1.05)\';" ' +
                                    'onmouseout="this.style.borderColor=\'#e0e0e0\'; this.style.transform=\'scale(1)\';" ' +
                                    'onclick="event.preventDefault();event.stopPropagation();(function(elem){var url=elem.getAttribute(\'data-full-url\')||elem.src;if(url&&url.trim()){if(typeof window.openSupplierImageLightbox === \'function\'){window.openSupplierImageLightbox(url);}else{console.error(\'openSupplierImageLightbox not available\');}}else{console.error(\'No URL found for image\');}})(this);return false;" ' +
                                    'title="Click to enlarge" ' +
                                    'alt="Reference image ' + (index + 1) + '" />' +
                                    '</div>';
                            }
                        });
                        refImagesHTML += '</div>';
                        if (refImagesHTML === '<div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 8px;"></div>') {
                            refImagesHTML = '<div style="color: #999; font-size: 12px; padding: 8px;">No valid reference images available</div>';
                        }
                    } else {
                        refImagesHTML = '<div style="color: #999; font-size: 12px; padding: 8px;">No reference images available</div>';
                    }
                    
                    // Build media links HTML
                    var mediaLinksHTML = '';
                    if (item.media_links && item.media_links.length > 0) {
                        mediaLinksHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                        item.media_links.forEach(function(link) {
                            var url = link.url || link;
                            var provider = link.provider || 'external';
                            mediaLinksHTML += '<a href="' + url + '" target="_blank" style="color: #0073aa; text-decoration: none; font-size: 13px;">' + 
                                (provider === 'youtube' ? 'â–¶ YouTube' : provider === 'vimeo' ? 'â–¶ Vimeo' : provider === 'loom' ? 'â–¶ Loom' : 'â–¶ Media Link') + 
                                '</a>';
                        });
                        mediaLinksHTML += '</div>';
                    } else {
                        mediaLinksHTML = '<div style="color: #999; font-size: 12px;">No media links available</div>';
                    }
                    
                    // Build reference images and PDFs HTML (Commit 2.3.5.4: Handle PDFs)
                    var refImagesHTMLDark = '';
                    if (refImages && refImages.length > 0) {
                        refImagesHTMLDark = '<div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 8px;">';
                        refImages.forEach(function(img, index) {
                            var imgUrl = '';
                            var fullUrl = '';
                            var imgType = 'image';
                            var filename = '';
                            
                            if (typeof img === 'string') {
                                imgUrl = img;
                                fullUrl = img;
                                if (img.toLowerCase().endsWith('.pdf')) {
                                    imgType = 'pdf';
                                    filename = img.split('/').pop();
                                }
                            } else if (typeof img === 'object') {
                                imgUrl = img.url || img.thumbnail || img.thumb_url || '';
                                fullUrl = img.full_url || img.url || img.thumbnail || img.thumb_url || '';
                                imgType = img.type || (imgUrl.toLowerCase().endsWith('.pdf') ? 'pdf' : 'image');
                                filename = img.filename || img.title || (imgUrl ? imgUrl.split('/').pop() : '');
                            }
                            
                            if (imgUrl && imgUrl.trim() !== '' && (imgUrl.startsWith('http://') || imgUrl.startsWith('https://'))) {
                                var imgId = 'n88-ref-img-view-dark-' + item.item_id + '-' + index;
                                var escapedFullUrl = (fullUrl || imgUrl).replace(/'/g, "\\'").replace(/\\/g, '\\\\').replace(/"/g, '&quot;');
                                
                                // Commit 2.3.5.4: Handle PDFs differently - show as [PDF] filename.pdf link
                                if (imgType === 'pdf' || imgUrl.toLowerCase().endsWith('.pdf')) {
                                    refImagesHTMLDark += '<div style="padding: 8px 12px; background-color: #1a1a1a; border: 1px solid #00ff00; border-radius: 2px; cursor: pointer; font-family: monospace; font-size: 11px; color: #00ff00;" ' +
                                        'onclick="window.open(\'' + escapedFullUrl + '\', \'_blank\');" ' +
                                        'onmouseover="this.style.backgroundColor=\'#222\';" ' +
                                        'onmouseout="this.style.backgroundColor=\'#1a1a1a\';" ' +
                                        'title="Click to open PDF">' +
                                        '[PDF] ' + (filename || 'document.pdf') +
                                        '</div>';
                                } else {
                                    // Regular image
                                    refImagesHTMLDark += '<div style="position: relative;">' +
                                        '<img id="' + imgId + '" ' +
                                        'src="' + imgUrl.replace(/"/g, '&quot;') + '" ' +
                                        'data-full-url="' + (fullUrl || imgUrl).replace(/"/g, '&quot;') + '" ' +
                                        'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3EImage%3C/text%3E%3C/svg%3E\';" ' +
                                        'style="width: 100px; height: 100px; object-fit: cover; border-radius: 2px; border: 2px solid #00ff00; cursor: pointer; transition: all 0.2s; background-color: #1a1a1a;" ' +
                                        'onmouseover="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,255,0,0.5)\';" ' +
                                        'onmouseout="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                        'onclick="event.preventDefault();event.stopPropagation();(function(elem){var url=elem.getAttribute(\'data-full-url\')||elem.src;if(url&&url.trim()){if(typeof window.openSupplierImageLightbox === \'function\'){window.openSupplierImageLightbox(url);}else{console.error(\'openSupplierImageLightbox not available\');}}else{console.error(\'No URL found for image\');}})(this);return false;" ' +
                                        'title="Click to enlarge" ' +
                                        'alt="Reference image ' + (index + 1) + '" />' +
                                        '</div>';
                                }
                            }
                        });
                        refImagesHTMLDark += '</div>';
                        if (refImagesHTMLDark === '<div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 8px;"></div>') {
                            refImagesHTMLDark = '<div style="color: #999; font-size: 12px; padding: 8px; font-family: monospace;">No valid reference images available</div>';
                        }
                    } else {
                        refImagesHTMLDark = '<div style="color: #999; font-size: 12px; padding: 8px; font-family: monospace;">No reference images available</div>';
                    }
                    
                    // Build modal HTML - Full-width: left images + right tabs (Item Overview, Messages, Bid, Prototype)
                    var tabStyle = 'flex: 1; padding: 12px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: #888; font-size: 12px; font-weight: 400; cursor: pointer; font-family: monospace;';
                    var tabActiveStyle = 'flex: 1; padding: 12px 16px; background: #111111; border: none; border-bottom: 2px solid #00ff00; color: #00ff00; font-size: 12px; font-weight: 600; cursor: pointer; font-family: monospace;';
                    var leftColImages = (item.image_url || item.primary_image_url ? (function() {
                        var imgUrl = (item.primary_image_url || item.image_url).replace(/'/g, "\\'").replace(/\\/g, '\\\\').replace(/"/g, '&quot;');
                        return '<div style="margin-bottom: 16px;">' +
                            '<img src="' + (item.primary_image_url || item.image_url) + '" onclick="event.preventDefault();event.stopPropagation();if(typeof window.openSupplierImageLightbox === \'function\'){window.openSupplierImageLightbox(\'' + imgUrl + '\');}return false;" style="max-width: 100%; max-height: 280px; width: auto; height: auto; border-radius: 2px; border: 2px solid #00ff00; object-fit: contain; cursor: pointer; transition: all 0.2s; background-color: #1a1a1a; box-shadow: 0 2px 8px rgba(0,255,0,0.3);" onmouseover="this.style.opacity=\'0.9\'; this.style.borderColor=\'#00ff00\'; this.style.boxShadow=\'0 4px 12px rgba(0,255,0,0.5)\';" onmouseout="this.style.opacity=\'1\'; this.style.borderColor=\'#00ff00\'; this.style.boxShadow=\'0 2px 8px rgba(0,255,0,0.3)\';" title="Click to enlarge" />' +
                            '</div>' +
                            (refImages && refImages.length > 0 ? '<div style="margin-top: 16px;"><label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #00ff00;">References</label>' + refImagesHTMLDark + '</div>' : '');
                    })() : (refImages && refImages.length > 0 ? '<div><label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #00ff00;">References</label>' + refImagesHTMLDark + '</div>' : '<div style="min-height: 200px; display: flex; align-items: center; justify-content: center; color: #444; font-family: monospace; font-size: 12px;">[ Main Image ]</div>'));
                    // Item box only (for 40% column) â€” font 14px inside detail box
                    var itemBoxHTML = (item.show_dims_qty_warning ? '<div style="padding: 12px; background-color: #1a1a1a; border: 1px solid #ffc107; border-radius: 2px; font-size: 12px; color: #ffc107; margin-bottom: 16px; font-weight: 500; font-family: monospace;">' +
                            'âš ï¸ Dims/Qty changed after you submitted your bid. Your bid reflects the previous specs.' +
                            '</div>' : '') +
                        '<div style="padding: 16px; background-color: #1a1a1a; border-radius: 10px; border: 1px solid #555; font-family: monospace; height: 100%; box-sizing: border-box; font-size: 14px;">' +
                        '<div style="font-size: 12px; font-weight: 600; color: #00ff00; margin-bottom: 12px; text-transform: uppercase;">Item</div>' +
                        '<div style="font-size: 14px; color: #fff; line-height: 1.8;">' +
                        '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Item:</strong> <span style="color: #fff;">' + (item.title || 'â€”') + '</span></div>' +
                        '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Category:</strong> <span style="color: #fff;">' + (item.category || 'â€”') + '</span></div>' +
                        '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Dims:</strong> <span style="color: #fff;">' + dimsText + '</span></div>' +
                        '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Quantity:</strong> <span style="color: #fff;">' + (item.quantity || 'â€”') + '</span></div>' +
                        (item.route_label ? '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Routing:</strong> <span style="color: #00ff00;">' + item.route_label + '</span></div>' : '') +
                        '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Delivery:</strong> <span style="color: #fff;">' + (item.delivery_country || 'â€”') + '</span></div>' +
                        '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #555;"><strong style="color: #00ff00;">Description:</strong></div>' +
                        '<div style="margin-top: 8px; color: #fff; white-space: pre-wrap; font-size: 14px;">' + (item.description || 'â€”') + '</div>' +
                        (item.smart_alternatives_note && item.smart_alternatives_note.trim() ? 
                            '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #555;"><strong style="color: #00ff00;">Designer notes:</strong></div>' +
                            '<div style="margin-top: 8px; color: #fff; white-space: pre-wrap; font-size: 14px;">' + item.smart_alternatives_note.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' :
                            '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #555;"><strong style="color: #00ff00;">Designer notes:</strong> <span style="color: #fff;">â€”</span></div>'
                        ) +
                        '</div></div>';
                    // Support section: open by default (display: flex), in 70% column â€” light borders, 10px radius on input + Send
                    var supportSectionHTML = '<div style="display: flex; flex-direction: column; flex: 1; min-height: 0;">' +
                        '<button id="n88-supplier-clarification-toggle-' + itemId + '" onclick="toggleSupplierClarification(' + itemId + ');" style="flex-shrink: 0; width: 100%; padding: 12px; background-color: #111111; border: 1px solid #555; border-radius: 10px; color: #ccc; font-family: \'Courier New\', Courier, monospace; font-size: 14px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.backgroundColor=\'#222\'; this.style.borderColor=\'#666\';" onmouseout="this.style.backgroundColor=\'#111111\'; this.style.borderColor=\'#555\';">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;flex-shrink:0;"><path d="M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/></svg> Support' +
                        '</button>' +
                        '<div id="n88-supplier-clarification-form-' + itemId + '" style="display: flex; flex: 1; min-height: 0; margin-top: 16px; padding: 16px; background-color: #111111; border: 1px solid #555; border-radius: 10px; flex-direction: column; overflow: hidden;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0;">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #ccc; display: flex; align-items: center; gap: 8px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:middle;"><path d="M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/></svg> Support</div>' +
                        '<button onclick="toggleSupplierClarification(' + itemId + ');" style="background: none; border: none; color: #888; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">Ã—</button>' +
                        '</div>' +
                        '<form id="n88-supplier-clarification-form-inner-' + itemId + '" onsubmit="return sendSupplierClarificationInline(event, ' + itemId + ');" style="display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: hidden;">' +
                        '<input type="hidden" name="item_id" value="' + itemId + '">' +
                        '<div style="margin-bottom: 12px; flex-shrink: 0;">' +
                        '<label style="display: block; font-size: 11px; color: #888; margin-bottom: 5px;">Category (Optional):</label>' +
                        '<select id="n88-clarification-category-' + itemId + '" name="category" style="width: 100%; padding: 8px; background-color: #000; color: #ccc; border: 1px solid #555; font-family: \'Courier New\', Courier, monospace; font-size: 11px; border-radius: 10px;">' +
                        '<option value="">-- Select Category --</option>' +
                        '<option value="Specs">Specs</option>' +
                        '<option value="Dimensions">Dimensions</option>' +
                        '<option value="Materials">Materials</option>' +
                        '<option value="Timeline">Timeline</option>' +
                        '<option value="Other">Other</option>' +
                        '</select>' +
                        '</div>' +
                        '<div id="n88-supplier-clarification-messages-' + itemId + '" style="flex: 1; min-height: 120px; overflow-y: auto; padding: 16px; background-color: #0a0a0a; border-radius: 10px; margin-bottom: 12px; border: 1px solid #555; display: flex; flex-direction: column;">' +
                        '<div style="text-align: center; color: #666; font-size: 12px; padding: 20px; margin: auto;">Loading conversation...</div>' +
                        '</div>' +
                        '<div style="display: flex; gap: 8px; align-items: flex-end; flex-shrink: 0;">' +
                        '<textarea id="n88-clarification-message-' + itemId + '" name="message_text" required rows="2" style="flex: 1; padding: 10px 12px; background-color: #000; color: #fff; border: 1px solid #555; border-radius: 10px; font-family: \'Courier New\', Courier, monospace; font-size: 12px; resize: none; min-height: 40px; max-height: 100px;" placeholder="Type your messageâ€¦"></textarea>' +
                        '<button type="submit" style="padding: 10px 20px; background-color: #00ff00; color: #000; border: none; border-radius: 10px; font-family: \'Courier New\', Courier, monospace; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; flex-shrink: 0;" onmouseover="this.style.backgroundColor=\'#00cc00\';" onmouseout="this.style.backgroundColor=\'#00ff00\';">Send</button>' +
                        '</div>' +
                        '</form>' +
                        '</div></div>';
                    // Item Overview: 40% item box (left), 60% Support open (right)
                    overviewTabHTML = '<div style="display: flex; flex-direction: row; flex: 1; min-height: 0; gap: 20px;">' +
                        '<div style="width: 40%; flex: 0 0 40%; min-width: 0; overflow-y: auto;">' + itemBoxHTML + '</div>' +
                        '<div style="flex: 1; min-width: 0; display: flex; flex-direction: column; min-height: 0;">' + supportSectionHTML + '</div>' +
                        '</div>';
                        // Bid Details Box â€” returns { bidBox, prototypeBlock } for Bid and Prototype tabs
                        // Commit 2.3.9.2: Prototype block uses item.payment_notification OR bid_data.payment_notification so tab shows whenever CAD/prototype request exists
                        var paymentNotif = item.payment_notification || (item.bid_data && item.bid_data.payment_notification);
                        var protoFallback = { full: '', step1Box: '', step2Box: '', step3Box: '' };
                        var bidAndPrototype = (function() {
                            var bid = item.bid_data || {};
                            var isBidAwarded = item.bid_status === 'awarded' || bid.bid_status === 'awarded' || bid.is_awarded === true;
                            var protoResult = paymentNotif ? (function() {
                                var notif = paymentNotif;
                                var keywordsHTML = '';
                                if (notif.keywords && Array.isArray(notif.keywords) && notif.keywords.length > 0) {
                                    keywordsHTML = '<div style="margin-top: 12px; margin-bottom: 12px;">' +
                                        '<div style="font-size: 11px; color: #00ff00; margin-bottom: 8px; font-weight: 600;">Video Direction Keywords:</div>' +
                                        '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
                                    notif.keywords.forEach(function(keyword) {
                                        if (keyword && String(keyword).trim() !== '') {
                                            keywordsHTML += '<span style="display: inline-block; padding: 4px 10px; background-color: #003300; border: 1px solid #00ff00; border-radius: 12px; font-size: 11px; color: #00ff00; font-family: monospace;">' + String(keyword).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
                                        }
                                    });
                                    keywordsHTML += '</div></div>';
                                }
                                var noteHTML = '';
                                if (notif.note && notif.note.trim()) {
                                    noteHTML = '<div style="margin-top: 12px; padding: 10px; background-color: #0a0a0a; border-left: 3px solid #00ff00; border-radius: 2px;">' +
                                        '<div style="font-size: 11px; color: #00ff00; margin-bottom: 6px; font-weight: 600;">Note:</div>' +
                                        '<div style="font-size: 12px; color: #fff; line-height: 1.5; white-space: pre-wrap;">' + (notif.note || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' +
                                        '</div>';
                                }
                                var cadReleasedToSupplier = notif.cad_released_to_supplier_at && String(notif.cad_released_to_supplier_at).trim() !== '';
                                var cadFilesHTML = '';
                                if (notif.cad_status === 'approved' && cadReleasedToSupplier && notif.cad_files && Array.isArray(notif.cad_files) && notif.cad_files.length > 0) {
                                    cadFilesHTML = '<div style="margin-top: 12px; margin-bottom: 12px;">' +
                                        '<div style="font-size: 11px; color: #00ff00; margin-bottom: 8px; font-weight: 600;">Approved CAD Files:</div>' +
                                        '<div style="display: flex; flex-direction: column; gap: 6px;">';
                                    notif.cad_files.forEach(function(file) {
                                        var isPdf = file.ext === 'pdf';
                                        var isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].indexOf(file.ext) !== -1;
                                        var icon = isPdf ? 'ðŸ“„' : (isImage ? 'ðŸ–¼ï¸' : 'ðŸ“Ž');
                                        cadFilesHTML += '<a href="' + (file.url || '').replace(/"/g, '&quot;') + '" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 4px; text-decoration: none; color: #fff; cursor: pointer; transition: all 0.2s; font-size: 10px;" onmouseover="this.style.backgroundColor=\'#222\'; this.style.borderColor=\'#00ff00\';" onmouseout="this.style.backgroundColor=\'#0a0a0a\'; this.style.borderColor=\'#333\';">' +
                                            '<span style="font-size: 16px;">' + icon + '</span>' +
                                            '<span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + (file.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>' +
                                            '<span style="font-size: 9px; color: #00ff00;">Open â†’</span>' +
                                            '</a>';
                                    });
                                    cadFilesHTML += '</div></div>';
                                }
                                var isCadApprovedForSubmit = notif.cad_status === 'approved' && cadReleasedToSupplier && notif.payment_id && (notif.cad_files && notif.cad_files.length > 0 || (notif.cad_approved_version && notif.cad_approved_version > 0));
                                var statusText, statusMessage;
                                if (notif.status === 'requested' || (notif.status !== 'marked_received' && notif.cad_status !== 'approved')) {
                                    statusText = 'CAD Request Pending Payment';
                                    statusMessage = 'A CAD/prototype request has been made. Awaiting payment confirmation and final CAD approval. You will receive approved CAD and direction keywords before filming begins.';
                                } else if (notif.cad_status === 'approved' && !cadReleasedToSupplier) {
                                    statusText = 'CAD Approved â€” Awaiting Release';
                                    statusMessage = 'Payment has been confirmed and the designer has approved the CAD. The approved CAD and direction will be released to you by the operator shortly. You will be able to view files and submit your prototype video once they are released.';
                                } else if (notif.cad_status === 'approved') {
                                    statusText = 'Payment Received â€” CAD Approved';
                                    statusMessage = 'Payment has been confirmed. CAD has been approved and released to you. Please review the approved CAD files below and proceed with prototype video production according to the files and direction keywords provided.';
                                } else {
                                    statusText = 'Payment Received â€” CAD Pending';
                                    statusMessage = 'Payment has been confirmed. CAD drafting is in progress and will be sent to you after designer approval. You will receive approved CAD + direction before filming begins.';
                                }
                                var releasedContent = cadReleasedToSupplier ? (cadFilesHTML + keywordsHTML + noteHTML) : '';
                                var baseBlock = '<div style="background-color: rgba(255, 255, 255, 0.08); border: 2px solid #888; border-radius: 4px; padding: 16px; margin-bottom: 16px; font-family: monospace;">' +
                                    '<div style="font-size: 14px; font-weight: 600; color: #ccc; margin-bottom: 8px;">' + statusText + '</div>' +
                                    '<div style="font-size: 12px; color: #aaa; line-height: 1.5; margin-bottom: 12px;">' + statusMessage + '</div>' +
                                    '<div style="font-size: 11px; color: #999; margin-top: 12px; padding-top: 12px; border-top: 1px solid #666;">' +
                                    '<div style="margin-bottom: 4px;"><strong>Item #' + (notif.item_id || 'N/A') + '</strong> / <strong>Bid #' + (notif.bid_id || 'N/A') + '</strong></div>' +
                                    '</div>' + releasedContent + '</div>';
                                var step1Box = (notif.status === 'requested' || (notif.status !== 'marked_received' && notif.cad_status !== 'approved')) ?
                                    '<div style="background-color: #2a0a0a; border: 2px solid #e53935; border-radius: 4px; padding: 14px; margin-bottom: 16px; font-family: monospace;"><div style="font-size: 14px; color: #ff4444; font-weight: 700; margin-bottom: 6px;">CAD Request Pending Payment</div><div style="font-size: 12px; color: #ccc; line-height: 1.5;">A CAD/prototype request has been made. Awaiting payment confirmation and final CAD approval. You will receive approved CAD and direction before filming begins.</div></div>' :
                                    '<div style="background-color: rgba(255, 255, 255, 0.08); border: 2px solid #888; border-radius: 4px; padding: 16px; margin-bottom: 16px; font-family: monospace;"><div style="font-size: 14px; font-weight: 600; color: #ccc; margin-bottom: 8px;">Payment Received â€” CAD Pending</div><div style="font-size: 12px; color: #aaa; line-height: 1.5;">Payment has been confirmed. CAD drafting is in progress and will be sent to you after designer approval. You will receive approved CAD + direction before filming begins.</div>' + keywordsHTML + '</div>';
                                var step2BoxApproved = '<div style="background-color: rgba(255, 255, 255, 0.08); border: 2px solid #888; border-radius: 4px; padding: 16px; margin-bottom: 16px; font-family: monospace;"><div style="font-size: 14px; font-weight: 600; color: #ccc; margin-bottom: 8px;">Payment Received â€” CAD Approved</div><div style="font-size: 12px; color: #aaa; line-height: 1.5; margin-bottom: 12px;">Payment has been confirmed. CAD has been approved and released to you. Please review the approved CAD files below and proceed with prototype video production.</div>' + cadFilesHTML + keywordsHTML + noteHTML + '</div>';
                                var step2BoxAwaitingRelease = '<div style="background-color: rgba(255, 255, 255, 0.06); border: 2px solid #666; border-radius: 4px; padding: 16px; margin-bottom: 16px; font-family: monospace;"><div style="font-size: 14px; font-weight: 600; color: #888; margin-bottom: 8px;">CAD Approved â€” Awaiting Release</div><div style="font-size: 12px; color: #888; line-height: 1.5;">The designer has approved the CAD. The operator will release the approved CAD and direction to you shortly. You will then see the files here and can submit your prototype video.</div></div>';
                                var step2Box = (notif.cad_status === 'approved' && cadReleasedToSupplier) ? step2BoxApproved : (notif.cad_status === 'approved') ? step2BoxAwaitingRelease : '';
                                if (!isCadApprovedForSubmit) return { full: baseBlock, step1Box: step1Box, step2Box: step2Box, step3Box: '' };
                                var hasSubmission = notif.prototype_video_submission && notif.prototype_video_submission.version;
                                if (hasSubmission) {
                                    var submission = notif.prototype_video_submission;
                                    var submissionDate = submission.created_at ? new Date(submission.created_at).toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
                                    var linksHTML = '';
                                    if (submission.links && submission.links.length > 0) {
                                        linksHTML = '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #666;"><div style="font-size: 11px; color: #999; margin-bottom: 8px;">Submitted Links (v' + submission.version + '):</div><div style="display: flex; flex-direction: column; gap: 6px;">';
                                        submission.links.forEach(function(link) {
                                            linksHTML += '<a href="' + (link.url || '').replace(/"/g, '&quot;') + '" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background-color: #1a1a1a; border: 1px solid #444; border-radius: 4px; text-decoration: none; color: #fff; font-size: 11px;">' +
                                                '<span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + (link.url || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>' +
                                                '<span style="font-size: 10px; color: #888;">Open â†’</span></a>';
                                        });
                                        linksHTML += '</div></div>';
                                    }
                                    var statusBadge = '';
                                    var viewChangesBtn = '';
                                    var statusMessage = 'Awaiting designer review';
                                    var helpMessage = '';
                                    if (notif.prototype_status === 'changes_requested' && notif.prototype_feedback && notif.prototype_feedback.keywords) {
                                        statusBadge = '<div style="font-size: 11px; color: #ff8800; margin-bottom: 8px; padding: 6px 10px; background-color: #331100; border: 1px solid #ff8800; border-radius: 4px; display: inline-block;">âš ï¸ Changes Requested</div>';
                                        statusMessage = 'Designer has requested changes. Please review feedback and submit an updated version.';
                                        helpMessage = '<div style="font-size: 10px; color: #888; padding: 8px; background-color: #1a1a1a; border-radius: 3px; margin-bottom: 12px;">Review the feedback and submit an updated version.</div>';
                                        var feedbackId = 'feedback_' + (notif.payment_id || '') + '_' + Date.now();
                                        if (typeof window.prototypeFeedbackData === 'undefined') window.prototypeFeedbackData = {};
                                        window.prototypeFeedbackData[feedbackId] = notif.prototype_feedback;
                                        window.prototypeFeedbackData[feedbackId].payment_id = notif.payment_id;
                                        window.prototypeFeedbackData[feedbackId].item_id = notif.item_id;
                                        window.prototypeFeedbackData[feedbackId].bid_id = notif.bid_id;
                                        viewChangesBtn = '<button onclick="if(window.prototypeFeedbackData && window.prototypeFeedbackData[\'' + feedbackId + '\']){window.showPrototypeFeedbackModal(window.prototypeFeedbackData[\'' + feedbackId + '\'], true);}" style="margin-top: 12px; padding: 8px 16px; background-color: #331100; color: #ff8800; border: 1px solid #ff8800; border-radius: 4px; font-family: monospace; font-size: 11px; font-weight: 600; cursor: pointer;">View Changes</button>';
                                    } else if (notif.prototype_status === 'approved') {
                                        statusBadge = '<div style="font-size: 11px; color: #00ff00; margin-bottom: 8px; padding: 6px 10px; background-color: #003300; border: 1px solid #00ff00; border-radius: 4px; display: inline-block;">âœ“ CAD Video Approved</div>';
                                        statusMessage = 'Prototype video has been approved by the designer.';
                                    }
                                    var step3Box = '<div style="margin-top: 16px; padding: 16px; background-color: rgba(255, 255, 255, 0.08); border: 1px solid #888; border-radius: 4px;">' +
                                        '<div style="font-size: 13px; font-weight: 600; color: #ccc; margin-bottom: 8px;">âœ“ Prototype Video Submitted</div>' + statusBadge +
                                        '<div style="font-size: 11px; color: #aaa; margin-bottom: 12px;">Submitted on ' + submissionDate + ' â€” ' + statusMessage + '</div>' + helpMessage + linksHTML + viewChangesBtn + '</div>';
                                    return { full: baseBlock + step3Box, step1Box: step1Box, step2Box: step2Box, step3Box: step3Box };
                                }
                                var submissionHTML = '<div style="margin-top: 16px; padding: 16px; background-color: rgba(255, 255, 255, 0.08); border: 1px solid #888; border-radius: 4px;">' +
                                    '<div style="font-size: 13px; font-weight: 600; color: #ccc; margin-bottom: 12px;">Submit Prototype Video</div>' +
                                    '<div style="font-size: 11px; color: #aaa; margin-bottom: 12px;">Submit 1-3 video links (YouTube, Vimeo, or Loom only)</div>' +
                                    '<form id="n88-submit-prototype-video-form-' + (notif.payment_id || '') + '" data-payment-id="' + (notif.payment_id || '') + '" data-item-id="' + (notif.item_id || '') + '" data-bid-id="' + (notif.bid_id || '') + '" style="display: flex; flex-direction: column; gap: 10px;">' +
                                    '<div id="n88-video-links-container-' + (notif.payment_id || '') + '">' +
                                    '<div class="n88-video-link-row" style="display: flex; gap: 8px; margin-bottom: 8px;">' +
                                    '<select class="n88-video-provider" style="flex: 0 0 120px; padding: 8px; background-color: #000; color: #fff; border: 1px solid #333; border-radius: 4px; font-family: monospace; font-size: 11px;">' +
                                    '<option value="youtube">YouTube</option><option value="vimeo">Vimeo</option><option value="loom">Loom</option></select>' +
                                    '<input type="url" class="n88-video-url" placeholder="https://..." style="flex: 1; padding: 8px; background-color: #000; color: #fff; border: 1px solid #333; border-radius: 4px; font-family: monospace; font-size: 11px;" required />' +
                                    '<button type="button" class="n88-remove-link-btn" style="padding: 8px 12px; background-color: #333; color: #ff6666; border: 1px solid #666; border-radius: 4px; font-family: monospace; font-size: 11px; cursor: pointer; display: none;">Remove</button></div></div>' +
                                    '<button type="button" id="n88-add-link-btn-' + (notif.payment_id || '') + '" class="n88-add-link-btn" style="padding: 6px 12px; background-color: #000; color: #888; border: 1px solid #888; border-radius: 4px; font-family: monospace; font-size: 10px; cursor: pointer; align-self: flex-start;">+ Add Link (max 3)</button>' +
                                    '<button type="submit" style="padding: 10px 16px; background-color: #666; color: #fff; border: 1px solid #888; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 700; cursor: pointer;">Submit Prototype Video</button></form></div>';
                                return { full: baseBlock + submissionHTML, step1Box: step1Box, step2Box: step2Box + submissionHTML, step3Box: '' };
                            })() : protoFallback;
                            var bidBoxHTML = ((item.bid_status === 'submitted' || item.bid_status === 'awarded') && item.bid_data) ? (function() {
                            var videoLinksHTML = '';
                            if (bid.video_links && bid.video_links.length > 0) {
                                bid.video_links.forEach(function(link, index) {
                                    videoLinksHTML += '<div style="margin-bottom: 4px;"><a href="' + link.replace(/"/g, '&quot;') + '" target="_blank" style="color: #00ff00; text-decoration: none;">' + link + '</a></div>';
                                });
                            } else {
                                videoLinksHTML = '<span style="color: #999;">None</span>';
                            }
                            
                            var bidPhotosHTML = '';
                            if (bid.bid_photos && bid.bid_photos.length > 0) {
                                bidPhotosHTML = '<div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">';
                                bid.bid_photos.forEach(function(photoUrl) {
                                    bidPhotosHTML += '<img src="' + photoUrl.replace(/"/g, '&quot;') + '" style="width: 80px; height: 80px; object-fit: cover; border-radius: 2px; border: none; cursor: pointer;" onclick="if(typeof window.openSupplierImageLightbox === \'function\'){window.openSupplierImageLightbox(\'' + photoUrl.replace(/'/g, "\\'").replace(/\\/g, '\\\\').replace(/"/g, '&quot;') + '\');}" title="Click to enlarge" />';
                                });
                                bidPhotosHTML += '</div>';
                            } else {
                                bidPhotosHTML = '<span style="color: #999;">None</span>';
                            }
                            
                            // Build Smart Alternatives HTML if present
                            var smartAltHTML = '';
                            // Debug: Log bid data to see what we have
                            console.log('Bid data for Smart Alt check:', {
                                has_smart_alt: !!bid.smart_alternatives_suggestion,
                                smart_alt_type: typeof bid.smart_alternatives_suggestion,
                                smart_alt_value: bid.smart_alternatives_suggestion
                            });
                            
                            // Handle both string and object formats
                            var smartAltData = bid.smart_alternatives_suggestion;
                            if (!smartAltData) {
                                console.log('No smart_alternatives_suggestion in bid data');
                            } else {
                                if (typeof smartAltData === 'string') {
                                    try {
                                        smartAltData = JSON.parse(smartAltData);
                                        console.log('Parsed Smart Alt from string:', smartAltData);
                                    } catch(e) {
                                        console.error('Failed to parse Smart Alt JSON:', e);
                                        smartAltData = null;
                                    }
                                }
                                
                                if (smartAltData && typeof smartAltData === 'object' && smartAltData !== null) {
                                    console.log('Processing Smart Alt data:', smartAltData);
                                    // Check if ANY field has data (not just category)
                                    var hasCategory = smartAltData.category && String(smartAltData.category).trim() !== '';
                                    var hasFrom = smartAltData.from && String(smartAltData.from).trim() !== '';
                                    var hasTo = smartAltData.to && String(smartAltData.to).trim() !== '';
                                    var hasPrice = smartAltData.price_impact && String(smartAltData.price_impact).trim() !== '';
                                    var hasLeadTime = smartAltData.lead_time_impact && String(smartAltData.lead_time_impact).trim() !== '';
                                    var hasComparisons = smartAltData.comparison_points && Array.isArray(smartAltData.comparison_points) && smartAltData.comparison_points.length > 0;
                                    
                                    console.log('Smart Alt field checks:', {
                                        hasCategory: hasCategory,
                                        hasFrom: hasFrom,
                                        hasTo: hasTo,
                                        hasPrice: hasPrice,
                                        hasLeadTime: hasLeadTime,
                                        hasComparisons: hasComparisons
                                    });
                                    
                                    // Always show if we have any data, even if all checks fail (fallback)
                                    var shouldShow = hasCategory || hasFrom || hasTo || hasPrice || hasLeadTime || hasComparisons || Object.keys(smartAltData).length > 0;
                                    
                                    if (shouldShow) {
                                        console.log('Displaying Smart Alt HTML');
                                        var smartAlt = smartAltData;
                                        var categoryLabels = {
                                            'material': 'Material',
                                            'finish': 'Finish',
                                            'hardware': 'Hardware',
                                            'dimensions': 'Dimensions',
                                            'construction': 'Construction Method',
                                            'packaging': 'Packaging'
                                        };
                                        var fromLabels = {
                                            'solid-wood': 'Solid Wood', 'plywood': 'Plywood', 'mdf': 'MDF',
                                            'metal': 'Metal', 'plastic': 'Plastic', 'glass': 'Glass',
                                            'fabric': 'Fabric', 'leather': 'Leather', 'other': 'Other'
                                        };
                                        var toLabels = fromLabels;
                                        var comparisonLabels = {
                                            'cost-reduction': 'Cost Reduction',
                                            'faster-production': 'Faster Production',
                                            'better-durability': 'Better Durability',
                                            'easier-sourcing': 'Easier Sourcing',
                                            'lighter-weight': 'Lighter Weight',
                                            'eco-friendly': 'Eco-Friendly'
                                        };
                                        var priceLabels = {
                                            'reduces-10-20': 'Reduces 10-20%',
                                            'reduces-20-30': 'Reduces 20-30%',
                                            'reduces-30-plus': 'Reduces 30%+',
                                            'similar': 'Similar Price',
                                            'increases-10-20': 'Increases 10-20%',
                                            'increases-20-plus': 'Increases 20%+'
                                        };
                                        var leadTimeLabels = {
                                            'reduces-1-2w': 'Reduces 1-2 weeks',
                                            'reduces-2-4w': 'Reduces 2-4 weeks',
                                            'reduces-4w-plus': 'Reduces 4+ weeks',
                                            'similar': 'Similar Lead Time',
                                            'increases-1-2w': 'Increases 1-2 weeks',
                                            'increases-2w-plus': 'Increases 2+ weeks'
                                        };
                                        
                                        smartAltHTML = '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #00ff00;">' +
                                            '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Smart Alternative Suggestion:</strong></div>' +
                                            '<div style="padding-left: 12px; font-size: 13px; color: #fff; line-height: 1.6;">' +
                                            (hasCategory ? '<div style="margin-bottom: 4px;"><strong style="color: #00ff00;">Category:</strong> <span style="color: #fff;">' + (categoryLabels[smartAlt.category] || smartAlt.category) + '</span></div>' : '') +
                                            (hasFrom && hasTo ? '<div style="margin-bottom: 4px;"><strong style="color: #00ff00;">From:</strong> <span style="color: #fff;">' + (fromLabels[smartAlt.from] || smartAlt.from) + '</span> <strong style="color: #00ff00;">To:</strong> <span style="color: #fff;">' + (toLabels[smartAlt.to] || smartAlt.to) + '</span></div>' : '') +
                                            (hasComparisons ? '<div style="margin-bottom: 4px;"><strong style="color: #00ff00;">Comparison Points:</strong> <span style="color: #fff;">' + smartAlt.comparison_points.map(function(cp) { return comparisonLabels[cp] || cp; }).join(', ') + '</span></div>' : '') +
                                            (hasPrice ? '<div style="margin-bottom: 4px;"><strong style="color: #00ff00;">Price Impact:</strong> <span style="color: #fff;">' + (priceLabels[smartAlt.price_impact] || smartAlt.price_impact) + '</span></div>' : '') +
                                            (hasLeadTime ? '<div style="margin-bottom: 4px;"><strong style="color: #00ff00;">Lead Time Impact:</strong> <span style="color: #fff;">' + (leadTimeLabels[smartAlt.lead_time_impact] || smartAlt.lead_time_impact) + '</span></div>' : '') +
                                            '</div>' +
                                            '</div>';
                                    }
                                }
                            }
                            
                            // Commit 2.4.1: Check if bid is awarded
                            // Check multiple sources: item.bid_status, bid.bid_status, and bid.is_awarded
                            var isBidAwarded = item.bid_status === 'awarded' || bid.bid_status === 'awarded' || bid.is_awarded === true;
                            
                            return '<div style="padding: 16px; background-color: #1a1a1a; border-radius: 2px; border: 1px solid #00ff00; margin-bottom: 24px; font-family: monospace;">' +
                                '<div style="font-size: 16px; font-weight: 600; color: #00ff00; margin-bottom: 16px; border-bottom: 1px solid #00ff00; padding-bottom: 8px;">Your Submitted Bid' + (isBidAwarded ? ' <span style="color: #00ff00; font-size: 14px;">âœ“ AWARDED</span>' : '') + '</div>' +
                                // Commit 2.4.1: Awarded Status Message
                                (isBidAwarded ? '<div style="background-color: #003300; border: 2px solid #00ff00; border-radius: 4px; padding: 16px; margin-bottom: 16px; font-size: 14px; color: #00ff00; line-height: 1.6;">' +
                                    '<div style="font-weight: 600; margin-bottom: 8px; font-size: 16px;">ðŸŽ‰ Congratulations! Your Bid Has Been Awarded</div>' +
                                    '<div style="margin-bottom: 8px;"><strong>Item:</strong> ' + (item.title || 'Item #' + itemId) + '</div>' +
                                    '<div style="margin-bottom: 8px;"><strong>Status:</strong> <span style="color: #00ff00; font-weight: 600;">Awarded</span></div>' +
                                    '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #00ff00; font-size: 13px;">Your bid has been awarded. Please proceed according to the next workflow steps.</div>' +
                                    '</div>' : '') +
                                (bid.has_prototype_request && bid.prototype_request_status === 'requested' ? '<div style="background-color: #2a0a0a; border: 2px solid #e53935; border-radius: 4px; padding: 14px; margin-bottom: 16px;"><div style="font-size: 14px; color: #ff4444; font-weight: 700; margin-bottom: 6px;">CAD Request Pending Payment</div><div style="font-size: 12px; color: #ccc; line-height: 1.5;">A CAD/prototype request has been made. Awaiting payment confirmation and final CAD approval. You will receive approved CAD and direction before filming begins.</div></div>' : '') +
                                '<div style="font-size: 14px; color: #fff; line-height: 1.8;">' +
                                '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Video Links:</strong> <div style="margin-top: 4px;">' + videoLinksHTML + '</div></div>' +
                                '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Bid Photos:</strong> <div style="margin-top: 4px;">' + bidPhotosHTML + '</div></div>' +
                                '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Prototype:</strong> <span style="color: #fff;">' + (bid.prototype_video_yes ? 'YES' : 'NO') + '</span></div>' +
                                (bid.prototype_timeline ? '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Prototype Timeline:</strong> <span style="color: #fff;">' + bid.prototype_timeline + '</span></div>' : '') +
                                (bid.prototype_cost !== null && bid.prototype_cost !== undefined ? '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Prototype Cost:</strong> <span style="color: #fff;">$' + parseFloat(bid.prototype_cost).toFixed(2) + '</span></div>' : '') +
                                (bid.production_lead_time ? '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Production Lead Time:</strong> <span style="color: #fff;">' + bid.production_lead_time + '</span></div>' : '') +
                                (bid.unit_price !== null && bid.unit_price !== undefined ? (function() {
                                    var unitPriceHtml = '<div style="margin-bottom: 8px;"><strong style="color: #00ff00;">Unit Price:</strong> <span style="color: #00ff00; font-weight: 600;">$' + parseFloat(bid.unit_price).toFixed(2) + '</span></div>';
                                    if (bid.total_price && bid.item_quantity && bid.item_quantity > 1) {
                                        unitPriceHtml += '<div style="margin-bottom: 8px; margin-left: 16px; font-size: 12px;"><strong style="color: #00ff00;">Total Price:</strong> <span style="color: #00ff00; font-weight: 600;">$' + parseFloat(bid.total_price).toFixed(2) + '</span> <span style="color: #999; font-size: 11px;">(' + parseFloat(bid.unit_price).toFixed(2) + ' Ã— ' + bid.item_quantity + ')</span></div>';
                                    }
                                    return unitPriceHtml;
                                })() : '') +
                                smartAltHTML +
                            '</div></div>';
                            })() : '';
                            var prototypeBlockHTML = (protoResult && protoResult.full) ? protoResult.full : '';
                            return { bidBox: bidBoxHTML, prototypeBlock: prototypeBlockHTML, workflowStep1: (protoResult && protoResult.step1Box) ? protoResult.step1Box : '', workflowStep2: (protoResult && protoResult.step2Box) ? protoResult.step2Box : '', workflowStep3: (protoResult && protoResult.step3Box) ? protoResult.step3Box : '' };
                        })();
                    var bidTabHTML = bidAndPrototype.bidBox +
                        '<div style="padding: 20px; border-top: 1px solid #555; background-color: #000; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">' +
                        ((item.bid_status === 'submitted' || item.bid_status === 'awarded') && !item.has_revision_mismatch ? 
                            // Normal submitted/awarded state - check if resubmission
                            '<div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">' +
                            '<div style="padding: 12px 24px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 14px; font-weight: 600; font-family: monospace;">âœ“ ' + (item.bid_status === 'awarded' ? 'Bid Awarded' : (item.is_resubmission ? 'Bid Already Resubmitted' : 'Bid Already Submitted')) + '</div>' +
                            (item.bid_status !== 'awarded' ? '<button onclick="withdrawBid(' + item.item_id + ')" style="padding: 12px 24px; background-color: #dc3545; color: #fff; border: none; border-radius: 2px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: monospace;">Withdraw Bid</button>' : '') +
                            '</div>' :
                            ((item.bid_status === 'submitted' || item.bid_status === 'awarded') && item.has_revision_mismatch ?
                                // Specs changed - show resubmit button (opens form inside modal)
                                '<button onclick="toggleBidForm(' + item.item_id + ')" id="n88-resubmit-bid-btn-' + item.item_id + '" style="padding: 12px 24px; background-color: #ff9800; color: #000; border: none; border-radius: 2px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: monospace;">[ Resubmit Bid ]</button>' :
                                (item.bid_status === 'draft' && item.bid_status !== null && item.bid_status !== undefined ?
                                    // Draft exists - show continue draft button (only when valid draft is saved)
                                    '<button onclick="toggleBidForm(' + item.item_id + ')" id="n88-toggle-bid-form-btn-' + item.item_id + '" style="padding: 12px 24px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: monospace;">[ Continue Draft ]</button>' :
                                    // No bid yet or no valid draft - show submit proposal button (default)
                                    '<button onclick="toggleBidForm(' + item.item_id + ')" id="n88-toggle-bid-form-btn-' + item.item_id + '" style="padding: 12px 24px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: monospace;">[ Submit Proposal ]</button>'
                                )
                            )
                        ) +
                        '</div>' +  
                        '<div id="n88-bid-form-section-' + item.item_id + '" style="display: none; padding: 20px; background-color: #000; border-top: 1px solid #555;">' +
                        '<div id="n88-bid-form-content-' + item.item_id + '"></div></div>';
                    var m = item.workflow_milestones || { step1: {}, step2: {}, step3: {} };
                    var fmtDate = function(d) { return (d && (d = (typeof d === 'string' ? d : (d && d.toISOString ? d.toISOString() : '')))) ? new Date(d).toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' }) : 'â€”'; };
                    var step1Dates = (m.step1 && (m.step1.cad_requested_at || m.step1.payment_approved_at)) ? ('<div style="font-size: 11px; color: #888; margin-bottom: 8px;">CAD requested: ' + fmtDate(m.step1.cad_requested_at) + '</div>' + (m.step1.payment_approved_at ? '<div style="font-size: 11px; color: #888; margin-bottom: 12px;">Payment received: ' + fmtDate(m.step1.payment_approved_at) + '</div>' : '')) : '';
                    var step2Dates = '';
                    if (m.step2) {
                        if (m.step2.cad_approved_at) step2Dates += '<div style="font-size: 11px; color: #888; margin-bottom: 8px;">CAD approved by designer: ' + fmtDate(m.step2.cad_approved_at) + '</div>';
                        if (m.step2.cad_released_to_supplier_at) step2Dates += '<div style="font-size: 11px; color: #888; margin-bottom: 12px;">CAD released to you: ' + fmtDate(m.step2.cad_released_to_supplier_at) + '</div>';
                    }
                    var step3DatesArr = [];
                    var firstSubmittedAt = (m.step3 && m.step3.video_submitted_at) ? String(m.step3.video_submitted_at) : '';
                    if (m.step3 && m.step3.video_submitted_at) step3DatesArr.push('Video submitted: ' + fmtDate(m.step3.video_submitted_at));
                    if (m.step3 && m.step3.changes_requested_dates && m.step3.changes_requested_dates.length) m.step3.changes_requested_dates.forEach(function(d, i) { step3DatesArr.push('Changes requested ' + (m.step3.changes_requested_dates.length > 1 ? (i + 1) + ': ' : '') + fmtDate(d)); });
                    if (m.step3 && m.step3.video_resubmitted_dates && m.step3.video_resubmitted_dates.length) {
                        var resubDates = m.step3.video_resubmitted_dates.filter(function(d) { return String(d) !== firstSubmittedAt; });
                        resubDates.forEach(function(d, i) { step3DatesArr.push('Resubmitted video ' + (resubDates.length > 1 ? (i + 1) + ': ' : ': ') + fmtDate(d)); });
                    } else if (m.step3 && m.step3.video_resubmitted_at && String(m.step3.video_resubmitted_at) !== firstSubmittedAt) step3DatesArr.push('Resubmitted video: ' + fmtDate(m.step3.video_resubmitted_at));
                    if (m.step3 && m.step3.video_approved_at) step3DatesArr.push('Video approved: ' + fmtDate(m.step3.video_approved_at));
                    var step3Dates = step3DatesArr.length ? step3DatesArr.map(function(l) { return '<div style="font-size: 11px; color: #888; margin-bottom: 4px;">' + l + '</div>'; }).join('') : '';
                    var w1 = (paymentNotif ? '<div id="n88-supplier-workflow-step-0" style="margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid #555;">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">1. CAD Requested - payment received</div>' + step1Dates + (bidAndPrototype.workflowStep1 || '') + '</div>' : '');
                    var w2 = (paymentNotif ? '<div id="n88-supplier-workflow-step-1" style="margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid #555;">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">2. Approved CAD drawings</div>' + step2Dates + (bidAndPrototype.workflowStep2 || '') + '</div>' : '');
                    var w3Show = paymentNotif && (bidAndPrototype.workflowStep3 || (m.step3 && (m.step3.video_submitted_at || (m.step3.changes_requested_dates && m.step3.changes_requested_dates.length) || m.step3.video_approved_at)));
                    var w3 = w3Show ? '<div id="n88-supplier-workflow-step-2" class="n88-workflow-step-detail" style="margin-bottom: 28px;">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">3. Prototype videos</div>' + (step3Dates ? '<div style="margin-bottom: 12px;">' + step3Dates + '</div>' : '') + (bidAndPrototype.workflowStep3 || '<div style="padding: 12px; border: 1px solid #555; border-radius: 4px; font-size: 12px; color: #888;">Prototype video step.</div>') + '</div>' : '';
                    var activeStepIdx = (item.supplier_workflow_active_step != null && item.supplier_workflow_active_step !== undefined) ? parseInt(item.supplier_workflow_active_step, 10) : 0;
                    var green = '#00ff00';
                    var darkBorder = '#555';
                    var stepLabels = ['CAD Requested - payment received', 'Approved CAD drawings', 'Prototype videos', 'Production / Fabrication', 'Quality Review & Packing', 'Ready for Delivery'];
                    var w1WithClass = (paymentNotif ? '<div id="n88-supplier-workflow-step-0" class="n88-workflow-step-detail" style="margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid #555; display: ' + (activeStepIdx === 0 ? 'block' : 'none') + ';">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">1. CAD Requested - payment received</div>' + step1Dates + (bidAndPrototype.workflowStep1 || '') + '</div>' : '');
                    var w2WithClass = (paymentNotif ? '<div id="n88-supplier-workflow-step-1" class="n88-workflow-step-detail" style="margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid #555; display: ' + (activeStepIdx === 1 ? 'block' : 'none') + ';">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">2. Approved CAD drawings</div>' + step2Dates + (bidAndPrototype.workflowStep2 || '') + '</div>' : '');
                    var w3WithClass = (w3Show ? '<div id="n88-supplier-workflow-step-2" class="n88-workflow-step-detail" style="margin-bottom: 28px; display: ' + (activeStepIdx === 2 ? 'block' : 'none') + ';">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">3. Prototype videos</div>' + (step3Dates ? '<div style="margin-bottom: 12px;">' + step3Dates + '</div>' : '') + (bidAndPrototype.workflowStep3 || '<div style="padding: 12px; border: 1px solid #555; border-radius: 4px; font-size: 12px; color: #888;">Prototype video step.</div>') + '</div>' : '');
                    var w4WithClass = (paymentNotif ? '<div id="n88-supplier-workflow-step-3" class="n88-workflow-step-detail" style="margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid #555; display: ' + (activeStepIdx === 3 ? 'block' : 'none') + ';">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">4. Production / Fabrication</div><div style="padding: 12px; border: 1px solid #555; border-radius: 4px; font-size: 12px; color: #888;">Coming soon.</div></div>' : '');
                    var w5WithClass = (paymentNotif ? '<div id="n88-supplier-workflow-step-4" class="n88-workflow-step-detail" style="margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid #555; display: ' + (activeStepIdx === 4 ? 'block' : 'none') + ';">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">5. Quality Review & Packing</div><div style="padding: 12px; border: 1px solid #555; border-radius: 4px; font-size: 12px; color: #888;">Coming soon.</div></div>' : '');
                    var w6WithClass = (paymentNotif ? '<div id="n88-supplier-workflow-step-5" class="n88-workflow-step-detail" style="margin-bottom: 28px; display: ' + (activeStepIdx === 5 ? 'block' : 'none') + ';">' +
                        '<div style="font-size: 14px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">6. Ready for Delivery</div><div style="padding: 12px; border: 1px solid #555; border-radius: 4px; font-size: 12px; color: #888;">Coming soon.</div></div>' : '');
                    var stepRow = '';
                    if (paymentNotif) {
                        stepRow = '<div id="n88-supplier-workflow-step-row" data-active-idx="' + activeStepIdx + '" style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid ' + darkBorder + ';">';
                        for (var si = 0; si < 6; si++) {
                            var isCompleted = activeStepIdx > si;
                            var isActive = activeStepIdx === si;
                            var circleBg = isCompleted ? green : (isActive ? '#111' : '#444');
                            var circleBorder = isCompleted || isActive ? green : darkBorder;
                            var circleColor = isCompleted ? '#0a0a0a' : (isActive ? '#00ff00' : '#fff');
                            var labelColor = isActive ? green : '#ccc';
                            stepRow += '<div data-step-idx="' + si + '" style="flex: 1; display: flex; flex-direction: column; align-items: center; min-width: 0; cursor: pointer;" onclick="n88SupplierWorkflowShowStep(' + si + ');">';
                            stepRow += '<div style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid ' + circleBorder + '; background: ' + circleBg + '; color: ' + circleColor + '; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">' + (si + 1) + '</div>';
                            stepRow += '<div style="font-size: 10px; color: ' + labelColor + '; text-align: center; line-height: 1.2;">' + (stepLabels[si] || '') + '</div>';
                            stepRow += '</div>';
                            if (si < 5) stepRow += '<div style="flex: 0 0 24px; align-self: center; height: 2px; background: ' + darkBorder + '; margin-bottom: 28px;" aria-hidden="true"></div>';
                        }
                        stepRow += '</div>';
                    }
                    var workflowTabHTML = '<div id="n88-supplier-workflow-timeline-wrap" data-item-id="' + (itemId || item.item_id || '') + '" data-active-step="' + (item.supplier_workflow_active_step != null ? item.supplier_workflow_active_step : '') + '" style="margin-bottom: 24px; padding-bottom: 20px; font-family: monospace;">' +
                        (paymentNotif ? (stepRow + w1WithClass + w2WithClass + w3WithClass + w4WithClass + w5WithClass + w6WithClass) : '<div style="padding: 20px; color: #666; font-size: 12px;">No CAD/prototype workflow for this item yet. Submit a proposal and, if awarded, workflow steps will appear here.</div>') + '</div>';
                    var prototypeOnlyTabHTML = '<div style="padding: 20px; color: #888; font-family: monospace; font-size: 12px;">CAD and Prototype steps are in the <strong style="color: #00ff00;">The WorkFlow</strong> tab. Open The WorkFlow to see dates and actions.</div>';
                    var defaultTab = (preferredTab === 'bid') ? 'bid' : ((item.supplier_workflow_active_step !== null && item.supplier_workflow_active_step !== undefined) ? 'workflow' : 'overview');
                    var modalHTML = '<div style="padding: 16px 20px; border-bottom: 1px solid #555; background-color: #000; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">' +
                        '<h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #fff; font-family: monospace;">' + (item.title || 'Untitled Item') + '</h2>' +
                        '<button onclick="closeBidModal()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px 8px; color: #00ff00; font-family: monospace; line-height: 1;">[ x Close ]</button>' +
                        '</div>' +
                        '<div style="display: flex; flex: 1; overflow: hidden; min-height: 0;">' +
                        '<div style="width: 42%; min-width: 280px; border-right: 1px solid #555; padding: 20px; overflow-y: auto; background-color: #000;">' + leftColImages + '</div>' +
                        '<div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0;">' +
                        '<div style="display: flex; border-bottom: 1px solid #555; flex-shrink: 0;">' +
                        '<button type="button" onclick="n88SupplierModalSwitchTab(\'overview\');" id="n88-supplier-tab-overview" style="' + (defaultTab === 'overview' ? tabActiveStyle : tabStyle) + '">Item Overview</button>' +
                        '<button type="button" onclick="n88SupplierModalSwitchTab(\'bid\');" id="n88-supplier-tab-bid" style="' + (defaultTab === 'bid' ? tabActiveStyle : tabStyle) + '">Proposals</button>' +
                        '<button type="button" onclick="n88SupplierModalSwitchTab(\'workflow\');" id="n88-supplier-tab-workflow" style="' + (defaultTab === 'workflow' ? tabActiveStyle : tabStyle) + '">The WorkFlow</button>' +
                        '</div>' +
                        '<div id="n88-supplier-tab-content" style="flex: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; padding: 20px; font-family: monospace; background-color: #000;">' +
                        '<div id="n88-supplier-panel-overview" class="n88-supplier-tab-panel" style="' + (defaultTab === 'overview' ? 'flex: 1; min-height: 0; overflow-y: auto; display: flex; flex-direction: column;' : 'display: none; flex: 1; min-height: 0; overflow-y: auto;') + '">' + overviewTabHTML + '</div>' +
                        '<div id="n88-supplier-panel-bid" class="n88-supplier-tab-panel" style="' + (defaultTab === 'bid' ? 'flex: 1; min-height: 0; overflow-y: auto; display: flex; flex-direction: column;' : 'display: none; flex: 1; min-height: 0; overflow-y: auto;') + '">' + bidTabHTML + '</div>' +
                        '<div id="n88-supplier-panel-workflow" class="n88-supplier-tab-panel" style="' + (defaultTab === 'workflow' ? 'flex: 1; min-height: 0; overflow-y: auto; display: flex; flex-direction: column;' : 'display: none; flex: 1; min-height: 0; overflow-y: auto;') + '">' + workflowTabHTML + '</div>' +
                        '</div></div></div>';
                    
                    modalContent.innerHTML = modalHTML;
                    
                    // Support is in Overview and open by default; load messages for the Support box. When opening on Workflow tab, scroll to active step.
                    setTimeout(function() {
                        var tabContent = document.getElementById('n88-supplier-tab-content');
                        if (tabContent && defaultTab !== 'workflow') tabContent.scrollTop = 0;
                        if (defaultTab === 'workflow' && item.supplier_workflow_active_step >= 0 && item.supplier_workflow_active_step <= 5) {
                            var stepEl = document.getElementById('n88-supplier-workflow-step-' + item.supplier_workflow_active_step);
                            if (stepEl) stepEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        if (typeof loadSupplierMessagesInline === 'function') loadSupplierMessagesInline(itemId);
                    }, 100);
                    
                    // Commit 2.3.9.2B-S: Initialize prototype video submission forms (workflow tab now contains the form)
                    setTimeout(function() {
                        if (typeof window.initPrototypeVideoForms === 'function') {
                            window.initPrototypeVideoForms();
                        }
                    }, 200);
                    
                    // Commit 2.3.9.2B-D: Initialize prototype feedback modal function
                    if (typeof window.showPrototypeFeedbackModal === 'undefined') {
                        window.showPrototypeFeedbackModal = function(feedbackData, showResubmit) {
                            if (!feedbackData || !feedbackData.keywords) {
                                alert('No feedback data available.');
                                return;
                            }
                            
                            // Create modal overlay
                            var modalOverlay = document.createElement('div');
                            modalOverlay.id = 'n88-prototype-feedback-modal';
                            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.9); z-index: 20000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;';
                            
                            // Build feedback content
                            var feedbackHTML = '<div style="background-color: #111; border: 2px solid #ff8800; border-radius: 8px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 24px; font-family: monospace;">';
                            feedbackHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #333;">';
                            feedbackHTML += '<h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #ff8800;">Designer Feedback (v' + (feedbackData.submission_version || '?') + ')</h2>';
                            feedbackHTML += '<button onclick="document.getElementById(\'n88-prototype-feedback-modal\').remove(); document.body.style.overflow=\'\';" style="background: none; border: none; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #ff8800; line-height: 1;">Ã—</button>';
                            feedbackHTML += '</div>';
                            
                            feedbackHTML += '<div style="font-size: 11px; color: #888; margin-bottom: 20px; padding: 10px; background-color: #1a1a1a; border-radius: 4px; border: 1px solid #333;">';
                            feedbackHTML += 'Feedback provided on ' + (feedbackData.created_at ? new Date(feedbackData.created_at).toLocaleString() : 'N/A');
                            feedbackHTML += '</div>';
                            
                            // Display each keyword with its status and phrases
                            feedbackData.keywords.forEach(function(keywordFeedback, index) {
                                var statusIcon = keywordFeedback.keyword_status === 'satisfied' ? 'âœ…' : 
                                                keywordFeedback.keyword_status === 'needs_adjustment' ? 'âš ï¸' : 'âŒ';
                                var statusText = keywordFeedback.keyword_status === 'satisfied' ? 'Satisfied' : 
                                                keywordFeedback.keyword_status === 'needs_adjustment' ? 'Needs Adjustment' : 'Not Addressed';
                                var statusColor = keywordFeedback.keyword_status === 'satisfied' ? '#00ff00' : 
                                                 keywordFeedback.keyword_status === 'needs_adjustment' ? '#ff8800' : '#ff4444';
                                var severityText = keywordFeedback.severity ? 
                                    (keywordFeedback.severity === 'must_fix' ? ' (Must Fix)' : 
                                     keywordFeedback.severity === 'should_fix' ? ' (Should Fix)' : ' (Optional)') : '';
                                
                                feedbackHTML += '<div style="margin-bottom: 20px; padding: 16px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 4px;">';
                                feedbackHTML += '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">';
                                feedbackHTML += '<span style="font-size: 18px;">' + statusIcon + '</span>';
                                feedbackHTML += '<div style="flex: 1;">';
                                feedbackHTML += '<div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 4px;">' + (keywordFeedback.keyword_name || 'Keyword') + '</div>';
                                feedbackHTML += '<div style="font-size: 12px; color: ' + statusColor + ';">' + statusText + severityText + '</div>';
                                feedbackHTML += '</div>';
                                feedbackHTML += '</div>';
                                
                                // Show phrases if any
                                if (keywordFeedback.phrases && keywordFeedback.phrases.length > 0) {
                                    feedbackHTML += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333;">';
                                    feedbackHTML += '<div style="font-size: 11px; color: #888; margin-bottom: 8px;">Selected Phrases:</div>';
                                    feedbackHTML += '<div style="display: flex; flex-direction: column; gap: 6px;">';
                                    keywordFeedback.phrases.forEach(function(phrase) {
                                        feedbackHTML += '<div style="padding: 8px 12px; background-color: #1a1a1a; border: 1px solid #444; border-radius: 4px; font-size: 11px; color: #ccc; line-height: 1.4;">';
                                        feedbackHTML += 'â€¢ ' + (phrase.phrase_text || '');
                                        feedbackHTML += '</div>';
                                    });
                                    feedbackHTML += '</div>';
                                    feedbackHTML += '</div>';
                                }
                                
                                feedbackHTML += '</div>';
                            });
                            
                            // Add Resubmit Video section if showResubmit is true
                            var resubmitSection = '';
                            if (showResubmit && feedbackData.payment_id && feedbackData.item_id && feedbackData.bid_id) {
                                resubmitSection = '<div style="margin-top: 24px; padding-top: 20px; border-top: 2px solid #ff8800;">' +
                                    '<div style="font-size: 13px; font-weight: 600; color: #ff8800; margin-bottom: 12px;">Resubmit Video</div>' +
                                    '<div style="font-size: 11px; color: #aaa; margin-bottom: 16px; padding: 10px; background-color: #1a1a1a; border-radius: 4px; border: 1px solid #333;">After reviewing the feedback above, submit an updated video that addresses the requested changes.</div>' +
                                    '<div id="n88-resubmit-video-form-container-' + feedbackData.payment_id + '" style="display: none; padding: 16px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 4px; margin-bottom: 16px;">' +
                                    '<form id="n88-resubmit-prototype-video-form-' + feedbackData.payment_id + '" data-payment-id="' + feedbackData.payment_id + '" data-item-id="' + feedbackData.item_id + '" data-bid-id="' + feedbackData.bid_id + '" style="display: flex; flex-direction: column; gap: 10px;">' +
                                    '<div id="n88-resubmit-video-links-container-' + feedbackData.payment_id + '">' +
                                    '<div class="n88-video-link-row" style="display: flex; gap: 8px; margin-bottom: 8px;">' +
                                    '<select class="n88-video-provider" style="flex: 0 0 120px; padding: 8px; background-color: #000; color: #fff; border: 1px solid #333; border-radius: 4px; font-family: monospace; font-size: 11px;">' +
                                    '<option value="youtube">YouTube</option>' +
                                    '<option value="vimeo">Vimeo</option>' +
                                    '<option value="loom">Loom</option>' +
                                    '</select>' +
                                    '<input type="url" class="n88-video-url" placeholder="https://..." style="flex: 1; padding: 8px; background-color: #000; color: #fff; border: 1px solid #333; border-radius: 4px; font-family: monospace; font-size: 11px;" required />' +
                                    '<button type="button" class="n88-remove-link-btn" style="padding: 8px 12px; background-color: #333; color: #ff6666; border: 1px solid #666; border-radius: 4px; font-family: monospace; font-size: 11px; cursor: pointer; display: none;">Remove</button>' +
                                    '</div>' +
                                    '</div>' +
                                    '<button type="button" id="n88-resubmit-add-link-btn-' + feedbackData.payment_id + '" class="n88-add-link-btn" style="padding: 6px 12px; background-color: #000; color: #888; border: 1px solid #888; border-radius: 4px; font-family: monospace; font-size: 10px; cursor: pointer; align-self: flex-start;" onmouseover="this.style.borderColor=\'#aaa\'; this.style.color=\'#aaa\';" onmouseout="this.style.borderColor=\'#888\'; this.style.color=\'#888\';">+ Add Link (max 3)</button>' +
                                    '<button type="submit" style="padding: 10px 16px; background-color: #331100; color: #ff8800; border: 1px solid #ff8800; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 700; cursor: pointer;" onmouseover="this.style.backgroundColor=\'#442200\'; this.style.borderColor=\'#ffaa00\';" onmouseout="this.style.backgroundColor=\'#331100\'; this.style.borderColor=\'#ff8800\';">Resubmit Video</button>' +
                                    '</form>' +
                                    '</div>' +
                                    '<button onclick="var container = document.getElementById(\'n88-resubmit-video-form-container-' + feedbackData.payment_id + '\'); if(container.style.display === \'none\'){container.style.display=\'block\'; this.textContent=\'Hide Resubmit Form\';}else{container.style.display=\'none\'; this.textContent=\'Resubmit Video\';}" style="padding: 10px 20px; background-color: #331100; color: #ff8800; border: 1px solid #ff8800; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%;" onmouseover="this.style.backgroundColor=\'#442200\'; this.style.borderColor=\'#ffaa00\';" onmouseout="this.style.backgroundColor=\'#331100\'; this.style.borderColor=\'#ff8800\';">Resubmit Video</button>' +
                                    '</div>';
                            }
                            
                            feedbackHTML += '<div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #333; text-align: center; display: flex; flex-direction: column; gap: 12px;">';
                            if (showResubmit && feedbackData.payment_id) {
                                feedbackHTML += resubmitSection;
                            }
                            feedbackHTML += '<button onclick="document.getElementById(\'n88-prototype-feedback-modal\').remove(); document.body.style.overflow=\'\';" style="padding: 10px 24px; background-color: #331100; color: #ff8800; border: 1px solid #ff8800; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'#442200\'; this.style.borderColor=\'#ffaa00\';" onmouseout="this.style.backgroundColor=\'#331100\'; this.style.borderColor=\'#ff8800\';">Close</button>';
                            feedbackHTML += '</div>';
                            feedbackHTML += '</div>';
                            
                            modalOverlay.innerHTML = feedbackHTML;
                            document.body.appendChild(modalOverlay);
                            document.body.style.overflow = 'hidden';
                            
                            // Initialize resubmit form if shown
                            if (showResubmit && feedbackData.payment_id) {
                                setTimeout(function() {
                                    // Initialize add/remove link buttons for resubmit form
                                    var addBtn = document.getElementById('n88-resubmit-add-link-btn-' + feedbackData.payment_id);
                                    var container = document.getElementById('n88-resubmit-video-links-container-' + feedbackData.payment_id);
                                    var form = document.getElementById('n88-resubmit-prototype-video-form-' + feedbackData.payment_id);
                                    
                                    if (addBtn && container) {
                                        addBtn.addEventListener('click', function() {
                                            var rows = container.querySelectorAll('.n88-video-link-row');
                                            if (rows.length >= 3) {
                                                alert('Maximum 3 links allowed.');
                                                return;
                                            }
                                            var newRow = rows[0].cloneNode(true);
                                            var urlInput = newRow.querySelector('.n88-video-url');
                                            var removeBtn = newRow.querySelector('.n88-remove-link-btn');
                                            if (urlInput) urlInput.value = '';
                                            if (removeBtn) removeBtn.style.display = rows.length > 0 ? 'block' : 'none';
                                            container.appendChild(newRow);
                                            
                                            // Update remove buttons visibility
                                            container.querySelectorAll('.n88-remove-link-btn').forEach(function(btn, idx) {
                                                btn.style.display = container.querySelectorAll('.n88-video-link-row').length > 1 ? 'block' : 'none';
                                                btn.onclick = function() {
                                                    if (container.querySelectorAll('.n88-video-link-row').length > 1) {
                                                        this.closest('.n88-video-link-row').remove();
                                                        container.querySelectorAll('.n88-remove-link-btn').forEach(function(b) {
                                                            b.style.display = container.querySelectorAll('.n88-video-link-row').length > 1 ? 'block' : 'none';
                                                        });
                                                    }
                                                };
                                            });
                                        });
                                    }
                                    
                                    // Handle form submission
                                    if (form) {
                                        form.addEventListener('submit', function(e) {
                                            e.preventDefault();
                                            var paymentId = this.getAttribute('data-payment-id');
                                            var itemId = this.getAttribute('data-item-id');
                                            var bidId = this.getAttribute('data-bid-id');
                                            var linkRows = container.querySelectorAll('.n88-video-link-row');
                                            var videoLinks = [];
                                            
                                            linkRows.forEach(function(row) {
                                                var provider = row.querySelector('.n88-video-provider').value;
                                                var url = row.querySelector('.n88-video-url').value.trim();
                                                if (url) {
                                                    videoLinks.push({ provider: provider, url: url });
                                                }
                                            });
                                            
                                            if (videoLinks.length === 0) {
                                                alert('Please provide at least one video link.');
                                                return;
                                            }
                                            
                                            if (videoLinks.length > 3) {
                                                alert('Maximum 3 links allowed.');
                                                return;
                                            }
                                            
                                            var submitBtn = this.querySelector('button[type="submit"]');
                                            var originalText = submitBtn ? submitBtn.textContent : 'Resubmit Video';
                                            if (submitBtn) {
                                                submitBtn.disabled = true;
                                                submitBtn.textContent = 'Submitting...';
                                            }
                                            
                                            var formData = new FormData();
                                            formData.append('action', 'n88_submit_prototype_video');
                                            formData.append('payment_id', paymentId);
                                            formData.append('video_links', JSON.stringify(videoLinks));
                                            formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_submit_prototype_video' ) ); ?>');
                                            
                                            fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                                                method: 'POST',
                                                body: formData
                                            })
                                            .then(function(response) { return response.json(); })
                                            .then(function(data) {
                                                if (data.success) {
                                                    alert('Video resubmitted successfully! Version ' + (data.data?.version || '?') + ' has been submitted.');
                                                    // Close modal and reload
                                                    document.getElementById('n88-prototype-feedback-modal').remove();
                                                    document.body.style.overflow = '';
                                                    // Reload item details
                                                    if (typeof openBidModal === 'function') {
                                                        var modal = document.getElementById('n88-supplier-bid-modal');
                                                        if (modal) {
                                                            modal.style.display = 'none';
                                                            setTimeout(function() {
                                                                openBidModal(itemId);
                                                            }, 300);
                                                        } else {
                                                            window.location.reload();
                                                        }
                                                    } else {
                                                        window.location.reload();
                                                    }
                                                } else {
                                                    alert('Error: ' + (data.data?.message || 'Failed to resubmit video.'));
                                                    if (submitBtn) {
                                                        submitBtn.disabled = false;
                                                        submitBtn.textContent = originalText;
                                                    }
                                                }
                                            })
                                            .catch(function(error) {
                                                console.error('Error resubmitting video:', error);
                                                alert('An error occurred. Please try again.');
                                                if (submitBtn) {
                                                    submitBtn.disabled = false;
                                                    submitBtn.textContent = originalText;
                                                }
                                            });
                                        });
                                    }
                                }, 100);
                            }
                            
                            // Close on overlay click (but not on content click)
                            modalOverlay.addEventListener('click', function(e) {
                                if (e.target === modalOverlay) {
                                    modalOverlay.remove();
                                    document.body.style.overflow = '';
                                }
                            });
                        };
                    }
                    
                    // Store item data for inline bid form
                    window.currentItemData = item;
                })
                .catch(function(error) {
                    modalContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #d32f2f;">' +
                        '<p style="margin-bottom: 20px;">Error loading item details. Please try again.</p>' +
                        '<button onclick="closeBidModal()" style="padding: 8px 16px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Close</button>' +
                        '</div>';
                });
            }
            
            function closeBidModal() {
                var modal = document.getElementById('n88-supplier-bid-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }
            
            window.n88SupplierModalSwitchTab = function(tabName) {
                var tabs = ['overview', 'bid', 'workflow'];
                var tabStyle = 'flex: 1; padding: 12px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: #888; font-size: 12px; font-weight: 400; cursor: pointer; font-family: monospace;';
                var tabActiveStyle = 'flex: 1; padding: 12px 16px; background: #111111; border: none; border-bottom: 2px solid #00ff00; color: #00ff00; font-size: 12px; font-weight: 600; cursor: pointer; font-family: monospace;';
                tabs.forEach(function(name) {
                    var btn = document.getElementById('n88-supplier-tab-' + name);
                    var panel = document.getElementById('n88-supplier-panel-' + name);
                    if (btn) { btn.style.cssText = name === tabName ? tabActiveStyle : tabStyle; }
                    if (panel) {
                        if (name === tabName) {
                            panel.style.display = 'flex';
                            panel.style.flexDirection = 'column';
                            if (name === 'workflow' && typeof window.n88LoadSupplierWorkflowTimeline === 'function') {
                                window.n88LoadSupplierWorkflowTimeline();
                            }
                            if (name === 'prototype' && typeof window.initPrototypeVideoForms === 'function') {
                                window.initPrototypeVideoForms();
                            }
                        } else {
                            panel.style.display = 'none';
                        }
                    }
                });
            };

            window.n88SupplierWorkflowShowStep = function(idx) {
                var wrap = document.getElementById('n88-supplier-workflow-timeline-wrap');
                if (!wrap) return;
                var details = wrap.querySelectorAll('.n88-workflow-step-detail');
                for (var i = 0; i < details.length; i++) {
                    var stepId = details[i].getAttribute('id') || '';
                    var stepNum = parseInt(stepId.replace('n88-supplier-workflow-step-', ''), 10);
                    details[i].style.display = (stepNum === idx) ? 'block' : 'none';
                }
                var row = document.getElementById('n88-supplier-workflow-step-row');
                if (row) {
                    row.setAttribute('data-active-idx', String(idx));
                    var green = '#00ff00';
                    var darkBorder = '#555';
                    var stepLabels = ['CAD Requested - payment received', 'Approved CAD drawings', 'Prototype videos', 'Production / Fabrication', 'Quality Review & Packing', 'Ready for Delivery'];
                    var steps = row.querySelectorAll('[data-step-idx]');
                    for (var s = 0; s < steps.length; s++) {
                        var si = parseInt(steps[s].getAttribute('data-step-idx'), 10);
                        var isCompleted = idx > si;
                        var isActive = idx === si;
                        var circleBg = isCompleted ? green : (isActive ? '#111' : '#444');
                        var circleBorder = isCompleted || isActive ? green : darkBorder;
                        var circleColor = isCompleted ? '#0a0a0a' : (isActive ? '#00ff00' : '#fff');
                        var labelColor = isActive ? green : '#ccc';
                        var circle = steps[s].querySelector('div[style*="border-radius: 50%"]');
                        var label = steps[s].querySelector('div[style*="font-size: 10px"]');
                        if (circle) { circle.style.background = circleBg; circle.style.borderColor = circleBorder; circle.style.color = circleColor; }
                        if (label) label.style.color = labelColor;
                    }
                }
                if (typeof window.initPrototypeVideoForms === 'function') window.initPrototypeVideoForms();
            };

            window.n88LoadSupplierWorkflowTimeline = function() {
                var wrap = document.getElementById('n88-supplier-workflow-timeline-wrap');
                var container = document.getElementById('n88-supplier-workflow-timeline');
                if (!wrap || !container) return;
                if (wrap.getAttribute('data-timeline-loaded') === '1') return;
                var itemId = wrap.getAttribute('data-item-id');
                if (!itemId) return;
                var nonce = '<?php echo esc_js( wp_create_nonce( 'n88_get_item_rfq_state' ) ); ?>';
                if (!nonce) return;
                container.innerHTML = '<div style="padding: 12px; color: #888; font-size: 12px;">Loading timelineâ€¦</div>';
                var formData = new FormData();
                formData.append('action', 'n88_get_item_timeline');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', nonce);
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', { method: 'POST', body: formData, credentials: 'same-origin' })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (!data.success || !data.data || !data.data.timeline) {
                            container.innerHTML = '<div style="padding: 12px; color: #cc6666; font-size: 12px;">' + (data.message || 'Failed to load timeline.') + '</div>';
                            return;
                        }
                        var t = data.data.timeline;
                        var steps = t.steps || [];
                        if (steps.length < 6) {
                            container.innerHTML = '<div style="padding: 12px; color: #888;">Timeline data incomplete.</div>';
                            wrap.setAttribute('data-timeline-loaded', '1');
                            return;
                        }
                        var green = '#00ff00';
                        var darkText = '#ccc';
                        var darkBorder = '#555';
                        var selectedIdx = 0;
                        var supplierEvidenceByStep = data.data.supplier_step_evidence_by_step || {};
                        function buildSupplierStepEvidenceBlock(sel, itemId) {
                            if (!sel || !sel.step_id) return '';
                            var stepId = sel.step_id;
                            var ev = supplierEvidenceByStep[stepId] || supplierEvidenceByStep[String(stepId)];
                            var canSubmit = sel.display_status === 'in_progress' || sel.display_status === 'completed';
                            var block = '<div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid ' + darkBorder + ';"><div style="font-size: 12px; font-weight: 600; color: ' + green + '; margin-bottom: 8px;">Evidence</div>';
                            if (ev && ev.links && ev.links.length) {
                                block += '<div style="font-size: 11px; color: ' + darkText + '; margin-bottom: 8px;">Evidence submitted (v' + (ev.version || '') + ')</div>';
                                block += '<ul style="margin: 0 0 10px 18px; padding: 0; font-size: 11px;">';
                                for (var k = 0; k < ev.links.length; k++) {
                                    var link = ev.links[k];
                                    block += '<li><a href="' + (link.url || '').replace(/"/g, '&quot;') + '" target="_blank" rel="noopener noreferrer" style="color: ' + green + ';">' + (link.provider || 'Link') + '</a></li>';
                                }
                                block += '</ul>';
                                if (canSubmit) block += '<button type="button" onclick="n88SupplierOpenStepEvidenceForm(' + itemId + ',' + stepId + ', true);" style="padding: 6px 12px; font-size: 11px; background: #111; color: ' + green + '; border: 1px solid ' + green + '; border-radius: 4px; cursor: pointer; font-family: monospace;">[ Submit New Version ]</button>';
                            } else if (canSubmit) {
                                block += '<button type="button" onclick="n88SupplierOpenStepEvidenceForm(' + itemId + ',' + stepId + ', false);" style="padding: 6px 12px; font-size: 11px; background: #111; color: ' + green + '; border: 1px solid ' + green + '; border-radius: 4px; cursor: pointer; font-family: monospace;">[ Submit Step Video ]</button>';
                            } else {
                                block += '<div style="font-size: 11px; color: #888;">Submit evidence when step is In Progress or Completed.</div>';
                            }
                            block += '<div id="n88-supplier-step-evidence-form-wrap" style="display: none; margin-top: 12px; padding: 12px; border: 1px solid ' + darkBorder + '; border-radius: 4px; background: #0a0a0a;"></div></div>';
                            return block;
                        }
                        window.n88SupplierTimelineSelectStep = function(idx) {
                            var w = document.getElementById('n88-supplier-workflow-timeline-wrap');
                            if (!w || !w._n88StepsData) return;
                            w._n88SelectedStep = idx;
                            var st = w._n88StepsData;
                            var sel = st[idx];
                            if (!sel) return;
                            var detEl = document.getElementById('n88-supplier-timeline-detail');
                            var itemId = w.getAttribute('data-item-id');
                            if (detEl) {
                                var sl = sel.display_status === 'delayed' ? 'Delayed' : sel.display_status === 'in_progress' ? 'In Progress' : sel.display_status === 'completed' ? 'Completed' : 'Pending';
                                detEl.innerHTML = '<div style="font-size: 13px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">' + (sel.step_number || (idx + 1)) + '. ' + (sel.label || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' +
                                    '<div style="font-size: 12px; color: #ccc;">Â· State: <span style="color: ' + (sel.display_status === 'delayed' ? '#ff6666' : sel.display_status === 'completed' ? '#00ff00' : '#ccc') + ';">' + sl + '</span></div>' +
                                    (sel.started_at ? '<div style="font-size: 11px; color: #ccc; margin-top: 4px;">Started: ' + sel.started_at + '</div>' : '') +
                                    (sel.completed_at ? '<div style="font-size: 11px; color: #ccc; margin-top: 2px;">Completed: ' + sel.completed_at + '</div>' : '') +
                                    (sel.expected_by ? '<div style="font-size: 11px; color: #ccc;">Expected by: ' + sel.expected_by + '</div>' : '') +
                                    buildSupplierStepEvidenceBlock(sel, itemId);
                            }
                            var btns = document.querySelectorAll('[data-n88-step-btn]');
                            for (var j = 0; j < btns.length; j++) {
                                var b = btns[j];
                                var bidx = parseInt(b.getAttribute('data-idx'), 10);
                                b.style.borderColor = 'transparent';
                                b.style.color = bidx === idx ? green : darkText;
                                var lbl = b.querySelector('.n88-step-label');
                                if (lbl) lbl.style.color = bidx === idx ? green : darkText;
                            }
                        };
                        var row = '<div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid ' + darkBorder + ';">';
                        for (var i = 0; i < steps.length; i++) {
                            var s = steps[i];
                            var isActive = s.display_status === 'in_progress' || s.display_status === 'delayed';
                            var isCompleted = s.display_status === 'completed';
                            var isSelected = selectedIdx === i;
                            row += '<div onclick="if(typeof n88SupplierTimelineSelectStep===\'function\')n88SupplierTimelineSelectStep(' + i + ');" data-n88-step-btn data-idx="' + i + '" style="flex: 1; display: flex; flex-direction: column; align-items: center; min-width: 0; cursor: pointer; padding: 4px; border-radius: 4px; border: none;">';
                            row += '<div style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid ' + (isCompleted ? green : isActive ? green : darkBorder) + '; background: ' + (isCompleted ? green : isActive ? 'rgba(0,255,0,0.15)' : 'transparent') + '; color: ' + (isCompleted ? '#0a0a0a' : isActive ? green : darkText) + '; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; margin-bottom: 6px;">' + (s.step_number || (i + 1)) + '</div>';
                            row += '<div class="n88-step-label" style="font-size: 10px; color: ' + (isSelected ? green : darkText) + '; text-align: center; line-height: 1.2;">' + (s.label || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                            if (s.is_delayed) row += '<span style="font-size: 9px; color: #ff6666; margin-top: 2px;">[ ! Delayed ]</span>';
                            row += '</div>';
                            if (i < steps.length - 1) {
                                row += '<div style="flex: 0 0 20px; align-self: center; height: 2px; background: ' + darkBorder + '; margin-bottom: 20px;" aria-hidden="true"></div>';
                            }
                        }
                        row += '</div>';
                        var sel = steps[0];
                        var statusLabel = sel.display_status === 'delayed' ? 'Delayed' : sel.display_status === 'in_progress' ? 'In Progress' : sel.display_status === 'completed' ? 'Completed' : 'Pending';
                        var detail = '<div id="n88-supplier-timeline-detail" style="padding: 16px; border: 1px solid ' + darkBorder + '; border-radius: 4px; background: rgba(0,0,0,0.2); margin-bottom: 16px;">';
                        detail += '<div style="font-size: 13px; font-weight: 600; color: ' + green + '; margin-bottom: 12px;">' + (sel.step_number || 1) + '. ' + (sel.label || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                        detail += '<div style="font-size: 12px; color: ' + darkText + ';">Â· State: <span style="color: ' + (sel.display_status === 'delayed' ? '#ff6666' : sel.display_status === 'completed' ? green : darkText) + ';">' + statusLabel + '</span></div>';
                        if (sel.started_at) detail += '<div style="font-size: 11px; color: ' + darkText + '; margin-top: 4px;">Started: ' + sel.started_at + '</div>';
                        if (sel.completed_at) detail += '<div style="font-size: 11px; color: ' + darkText + '; margin-top: 2px;">Completed: ' + sel.completed_at + '</div>';
                        if (sel.expected_by) detail += '<div style="font-size: 11px; color: ' + darkText + ';">Expected by: ' + sel.expected_by + '</div>';
                        detail += buildSupplierStepEvidenceBlock(sel, itemId);
                        detail += '</div>';
                        if (t.show_prototype_mini) {
                            detail += '<div style="margin-top: 12px; padding: 12px; border: 1px solid ' + darkBorder + '; border-radius: 4px; font-size: 11px; color: ' + darkText + ';">';
                            detail += '<div style="margin-bottom: 8px; color: ' + green + ';">Prototype Mini-Timeline (visual only)</div>';
                            detail += '<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">Requested â†’ Paid â†’ CAD Approved â†’ Prototype Submitted â†’ Approved</div></div>';
                        }
                        container.innerHTML = row + detail;
                        wrap._n88SelectedStep = 0;
                        wrap._n88StepsData = steps;
                        wrap.setAttribute('data-timeline-loaded', '1');
                    })
                    .catch(function(err) {
                        container.innerHTML = '<div style="padding: 12px; color: #cc6666; font-size: 12px;">Failed to load timeline.</div>';
                    });
            };

            window.n88SupplierOpenStepEvidenceForm = function(itemId, stepId, isNewVersion) {
                var wrap = document.getElementById('n88-supplier-workflow-timeline-wrap');
                var formWrap = document.getElementById('n88-supplier-step-evidence-form-wrap');
                if (!formWrap) return;
                var darkBorder = '#555';
                var green = '#00ff00';
                var darkText = '#ccc';
                formWrap.style.display = 'block';
                formWrap.innerHTML = '<p style="font-size: 11px; color: ' + darkText + '; margin-bottom: 8px;">Allowed: YouTube / Vimeo / Loom</p>' +
                    '<div id="n88-step-evidence-url-rows" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">' +
                    '<input type="url" id="n88-step-evidence-url-1" placeholder="https://..." style="padding: 8px; background: #111; color: #fff; border: 1px solid ' + darkBorder + '; border-radius: 4px; font-size: 12px;" />' +
                    '<input type="url" id="n88-step-evidence-url-2" placeholder="https://..." style="padding: 8px; background: #111; color: #fff; border: 1px solid ' + darkBorder + '; border-radius: 4px; font-size: 12px;" />' +
                    '<input type="url" id="n88-step-evidence-url-3" placeholder="https://..." style="padding: 8px; background: #111; color: #fff; border: 1px solid ' + darkBorder + '; border-radius: 4px; font-size: 12px;" />' +
                    '</div>' +
                    '<div style="display: flex; gap: 8px;">' +
                    '<button type="button" id="n88-step-evidence-submit-btn" style="padding: 8px 16px; font-size: 12px; background: ' + green + '; color: #000; border: none; border-radius: 4px; cursor: pointer; font-family: monospace;">Submit Evidence</button>' +
                    '<button type="button" id="n88-step-evidence-cancel-btn" style="padding: 8px 16px; font-size: 12px; background: #333; color: #ccc; border: 1px solid ' + darkBorder + '; border-radius: 4px; cursor: pointer; font-family: monospace;">Cancel</button>' +
                    '</div>';
                document.getElementById('n88-step-evidence-cancel-btn').onclick = function() {
                    formWrap.style.display = 'none';
                    formWrap.innerHTML = '';
                };
                document.getElementById('n88-step-evidence-submit-btn').onclick = function() {
                    var u1 = (document.getElementById('n88-step-evidence-url-1').value || '').trim();
                    var u2 = (document.getElementById('n88-step-evidence-url-2').value || '').trim();
                    var u3 = (document.getElementById('n88-step-evidence-url-3').value || '').trim();
                    var urls = [u1, u2, u3].filter(function(u) { return u.length > 0; });
                    if (urls.length < 1 || urls.length > 3) {
                        alert('Please enter between 1 and 3 video links (YouTube, Vimeo, or Loom).');
                        return;
                    }
                    var btn = this;
                    btn.disabled = true;
                    btn.textContent = 'Submittingâ€¦';
                    var formData = new FormData();
                    formData.append('action', 'n88_supplier_submit_step_evidence');
                    formData.append('item_id', String(itemId));
                    formData.append('step_id', String(stepId));
                    formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_get_item_rfq_state' ) ); ?>');
                    if (urls[0]) formData.append('url_1', urls[0]);
                    if (urls[1]) formData.append('url_2', urls[1]);
                    if (urls[2]) formData.append('url_3', urls[2]);
                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', { method: 'POST', body: formData, credentials: 'same-origin' })
                        .then(function(r) { return r.json(); })
                        .then(function(data) {
                            if (data.success) {
                                formWrap.style.display = 'none';
                                formWrap.innerHTML = '';
                                if (wrap) wrap.removeAttribute('data-timeline-loaded');
                                if (typeof window.n88LoadSupplierWorkflowTimeline === 'function') window.n88LoadSupplierWorkflowTimeline();
                            } else {
                                alert(data.data && data.data.message ? data.data.message : 'Failed to submit evidence.');
                                btn.disabled = false;
                                btn.textContent = 'Submit Evidence';
                            }
                        })
                        .catch(function() {
                            alert('Request failed. Please try again.');
                            btn.disabled = false;
                            btn.textContent = 'Submit Evidence';
                        });
                };
            };

            // Toggle bid form section inside the modal
            function toggleBidForm(itemId) {
                var formSection = document.getElementById('n88-bid-form-section-' + itemId);
                var formContent = document.getElementById('n88-bid-form-content-' + itemId);
                var toggleBtn = document.getElementById('n88-toggle-bid-form-btn-' + itemId);
                var resubmitBtn = document.getElementById('n88-resubmit-bid-btn-' + itemId);
                var specsBanner = document.getElementById('n88-specs-changed-banner');
                var bidForm = document.getElementById('n88-bid-form');
                
                if (!formSection || !formContent) return;
                
                if (formSection.style.display === 'none' || !formSection.style.display) {
                    // Show form section
                    formSection.style.display = 'block';
                    if (toggleBtn) {
                        toggleBtn.textContent = '[ Hide Bid Form ]';
                        toggleBtn.style.backgroundColor = '#1a1a1a';
                        toggleBtn.style.color = '#00ff00';
                        toggleBtn.style.borderColor = '#00ff00';
                    }
                    if (resubmitBtn) {
                        resubmitBtn.textContent = '[ Hide Bid Form ]';
                        resubmitBtn.style.backgroundColor = '#1a1a1a';
                        resubmitBtn.style.color = '#00ff00';
                    }
                    
                    // Hide specs changed banner and show form when resubmitting
                    if (specsBanner) {
                        specsBanner.style.display = 'none';
                    }
                    if (bidForm) {
                        bidForm.style.display = 'block';
                    }
                    
                    // Commit 2.3.5.4: Ensure bid form visible without scrolling - scroll to top of form section
                    formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Load bid form content if not already loaded
                    if (!formContent.innerHTML || formContent.innerHTML.trim() === '') {
                        loadBidFormContent(itemId, formContent);
                    }
                } else {
                    // Hide form section
                    formSection.style.display = 'none';
                    if (toggleBtn) {
                        // Check if there's a valid draft bid to show "Continue Bid" instead
                        // Only show "Continue Bid" when bid_status is explicitly 'draft' (not null or undefined)
                        var item = window.currentItemData;
                        var hasDraft = item && item.bid_status === 'draft' && item.bid_status !== null && item.bid_status !== undefined;
                        toggleBtn.textContent = hasDraft ? '[ Continue Draft ]' : '[ Submit Proposal ]';
                        toggleBtn.style.backgroundColor = '#1a1a1a';
                        toggleBtn.style.color = '#00ff00';
                        toggleBtn.style.borderColor = '#00ff00';
                    }
                    if (resubmitBtn) {
                        resubmitBtn.textContent = '[ Resubmit Bid ]';
                        resubmitBtn.style.backgroundColor = '#ff9800';
                        resubmitBtn.style.color = '#000';
                    }
                }
            }
            
            // Load bid form content into the embedded section
            function loadBidFormContent(itemId, container) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #fff; font-family: monospace;">Loading bid form...</div>';
                
                // Fetch item details
                var formData = new FormData();
                formData.append('action', 'n88_get_supplier_item_details');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_supplier_item_details' ); ?>');
                
                // Add timeout to prevent hanging
                var timeoutPromise = new Promise(function(resolve, reject) {
                    setTimeout(function() {
                        reject(new Error('Request timeout'));
                    }, 30000); // 30 second timeout
                });
                
                Promise.race([
                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    }),
                    timeoutPromise
                ])
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    // Check if response is JSON
                    var contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        // If not JSON, try to get text to see what we got
                        return response.text().then(function(text) {
                            throw new Error('Response is not JSON. Got: ' + text.substring(0, 100));
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (!data || !data.success) {
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff0000; font-family: monospace;">Error loading item details: ' + (data && data.data && data.data.message ? data.data.message : 'Unknown error') + '</div>';
                        return;
                    }
                    
                    var item = data.data;
                    var bidFormHTML = buildEmbeddedBidFormHTML(item, itemId);
                    container.innerHTML = bidFormHTML;
                    
                    // Initialize form validation first
                    setTimeout(function() {
                        validateBidFormEmbedded(itemId);
                    }, 100);
                    
                    // Load draft or stale bid data if available (for resubmission when specs changed)
                    setTimeout(function() {
                        // First try to load from stale bid data if has_revision_mismatch
                        if (item.has_revision_mismatch && (item.latest_stale_bid_data || item.bid_data)) {
                            var staleBidData = item.latest_stale_bid_data || item.bid_data;
                            var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                            if (form && staleBidData) {
                                restoreBidDataToFormEmbedded(form, staleBidData, itemId);
                            }
                        } else {
                            // Otherwise load from draft
                            loadBidDraft(itemId);
                        }
                    }, 200);
                })
                .catch(function(error) {
                    console.error('Error loading bid form:', error);
                    // Check if error is due to JSON parsing (504 timeout returns HTML)
                    if (error.message && error.message.includes('JSON')) {
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff0000; font-family: monospace;">Server timeout. Please refresh and try again.</div>';
                    } else {
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff0000; font-family: monospace;">Network error. Please try again.</div>';
                    }
                });
            }
            
            // Build embedded bid form HTML (adapted from openBidFormModalInternal)
            function buildEmbeddedBidFormHTML(item, itemId) {
                // Get primary image URL
                var primaryImageUrl = item.primary_image_url || item.image_url || '';
                
                // Get inspiration images
                var inspirationImages = item.inspiration_images || item.reference_images || [];
                
                // Filter and prepare valid reference images
                var validReferenceImages = [];
                if (inspirationImages && inspirationImages.length > 0) {
                    inspirationImages.forEach(function(img) {
                        var imgUrl = '';
                        var fullUrl = '';
                        
                        if (typeof img === 'string') {
                            imgUrl = img;
                            fullUrl = img;
                        } else if (typeof img === 'object') {
                            imgUrl = img.url || img.thumbnail || img.thumb_url || '';
                            fullUrl = img.full_url || img.url || img.thumbnail || img.thumb_url || '';
                        }
                        
                        if (imgUrl && imgUrl.trim() !== '' && (imgUrl.startsWith('http://') || imgUrl.startsWith('https://'))) {
                            validReferenceImages.push({
                                url: imgUrl,
                                fullUrl: fullUrl || imgUrl
                            });
                        }
                    });
                }
                
                // Build image gallery layout
                var imageGalleryHTML = '';
                if (primaryImageUrl || validReferenceImages.length > 0) {
                    var leftImages = [];
                    var rightImages = [];
                    validReferenceImages.forEach(function(img, index) {
                        if (index % 2 === 0) {
                            leftImages.push(img);
                        } else {
                            rightImages.push(img);
                        }
                    });
                    
                    var leftColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                    leftImages.forEach(function(img, index) {
                        var imgId = 'n88-ref-left-embedded-' + itemId + '-' + index;
                        leftColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                            '<img id="' + imgId + '" ' +
                            'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                            'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                            'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                            'style="width: 100px; height: 100px; object-fit: cover; border-radius: 2px; border: 2px solid #00ff00; cursor: pointer; transition: all 0.2s; background-color: #1a1a1a;" ' +
                            'onmouseover="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,255,0,0.5)\';" ' +
                            'onmouseout="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                            'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\')||elem.src;if(url&&url.trim()){openSupplierImageLightbox(url);}else{console.error(\'No URL found for image\');}})(this);" ' +
                            'title="Click to view full size" ' +
                            'alt="Reference photo" />' +
                            '</div>';
                    });
                    leftColumnHTML += '</div>';
                    
                    var centerColumnHTML = '<div style="flex: 1; display: flex; align-items: center; justify-content: center; min-height: 300px; padding: 0 20px; max-width: 500px;">';
                    if (primaryImageUrl) {
                        centerColumnHTML += '<img src="' + primaryImageUrl.replace(/"/g, '&quot;') + '" ' +
                            'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23f0f0f0\' width=\'400\' height=\'300\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'14\'%3EItem Image%3C/text%3E%3C/svg%3E\';" ' +
                            'style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 2px; border: 2px solid #00ff00; object-fit: contain; box-shadow: 0 2px 8px rgba(0,255,0,0.3); cursor: pointer; transition: all 0.2s; background-color: #1a1a1a;" ' +
                            'onclick="event.preventDefault();event.stopPropagation();if(typeof window.openSupplierImageLightbox === \'function\'){window.openSupplierImageLightbox(\'' + primaryImageUrl.replace(/'/g, "\\'").replace(/\\/g, '\\\\').replace(/"/g, '&quot;') + '\');}return false;" ' +
                            'onmouseover="this.style.opacity=\'0.9\'; this.style.borderColor=\'#00ff00\'; this.style.boxShadow=\'0 4px 12px rgba(0,255,0,0.5)\';" ' +
                            'onmouseout="this.style.opacity=\'1\'; this.style.borderColor=\'#00ff00\'; this.style.boxShadow=\'0 2px 8px rgba(0,255,0,0.3)\';" ' +
                            'title="Click to enlarge" ' +
                            'alt="Item main image" />';
                    } else {
                        centerColumnHTML += '<div style="width: 100%; height: 300px; background-color: #1a1a1a; border-radius: 2px; border: none; display: flex; align-items: center; justify-content: center; color: #00ff00; font-family: monospace; font-size: 12px;">No main image available</div>';
                    }
                    centerColumnHTML += '</div>';
                    
                    var rightColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                    rightImages.forEach(function(img, index) {
                        var imgId = 'n88-ref-right-embedded-' + itemId + '-' + index;
                        rightColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                            '<img id="' + imgId + '" ' +
                            'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                            'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                            'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                            'style="width: 100px; height: 100px; object-fit: cover; border-radius: 2px; border: 2px solid #00ff00; cursor: pointer; transition: all 0.2s; background-color: #1a1a1a;" ' +
                            'onmouseover="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,255,0,0.5)\';" ' +
                            'onmouseout="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                            'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\')||elem.src;if(url&&url.trim()){openSupplierImageLightbox(url);}else{console.error(\'No URL found for image\');}})(this);" ' +
                            'title="Click to view full size" ' +
                            'alt="Reference photo" />' +
                            '</div>';
                    });
                    rightColumnHTML += '</div>';
                    
                    imageGalleryHTML = '<div style="margin-bottom: 24px; display: flex; gap: 16px; align-items: flex-start; justify-content: center; padding: 16px; background-color: #1a1a1a; border-radius: 4px; border: none;">' +
                        leftColumnHTML +
                        centerColumnHTML +
                        rightColumnHTML +
                        '</div>';
                }
                
                // Commit 2.3.5.4: Build bid form HTML - Remove images (shown only at top), remove Anonymous/No contact text
                var bidFormHTML = '<form id="n88-bid-form-embedded-' + itemId + '" style="font-family: monospace;" onsubmit="return validateAndSubmitBidEmbedded(event, ' + itemId + ');">' +
                    // Commit 2.3.5.4: Images removed from bid form (only shown at top of modal)
                    
                    // BID FORM Title (Commit 2.3.5.4: Remove "Anonymous â€¢ No contact info allowed")
                    '<div style="margin-bottom: 24px; padding: 12px 0; border-bottom: 1px solid #00ff00;">' +
                    '<h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #00ff00; font-family: monospace;">BID FORM</h2>' +
                        '</div>' +
                        
                    // 1. Video links (0-3, optional) - Commit 2.3.5.4: Field order 1
                        '<div style="margin-bottom: 24px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">VIDEO LINKS (Optional)</label>' +
                    '<div style="font-size: 11px; color: #fff; margin-bottom: 8px; font-family: monospace;">Min 0, Max 3. Allowed: YouTube / Vimeo / Loom</div>' +
                    '<div id="n88-video-links-container-embedded-' + itemId + '">' +
                    '<div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">' +
                    '<span style="color: #00ff00; font-family: monospace; font-size: 12px;">1)</span>' +
                    '<input type="url" name="video_links[]" class="n88-video-link-input-embedded" placeholder="https://youtube.com/watch?v=..." style="flex: 1; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; font-family: monospace;" onblur="validateVideoLinkEmbedded(this, ' + itemId + ');" oninput="validateBidFormEmbedded(' + itemId + ');" />' +
                    '<button type="button" onclick="removeVideoLinkEmbedded(this, ' + itemId + ')" style="padding: 8px 12px; background-color: #dc3545; color: #fff; border: none; border-radius: 2px; cursor: pointer; display: none; font-family: monospace; font-size: 11px;">Remove</button>' +
                        '</div>' +
                        '</div>' +
                    '<button type="button" onclick="addVideoLinkEmbedded(' + itemId + ')" id="n88-add-video-link-btn-embedded-' + itemId + '" style="margin-top: 8px; padding: 6px 12px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; cursor: pointer; font-size: 11px; font-family: monospace;">+ Add Another Link</button>' +
                    '<div id="n88-video-links-error-embedded-' + itemId + '" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        
                    // 2. Reference photo(s) (required, min 1, max 5) - Commit 2.3.5.4: Renamed from "BID PHOTOS" to "Reference photo(s)"
                        '<div style="margin-bottom: 24px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">Reference photo(s) <span style="color: #ff0000;">*</span></label>' +
                    '<div style="font-size: 11px; color: #fff; margin-bottom: 8px; font-family: monospace;">Upload photos of similar items or your work. Minimum 1 photo required (recommended 1-5).</div>' +
                    '<input type="file" id="n88-bid-photos-input-embedded-' + itemId + '" name="bid_photos[]" accept="image/*" multiple style="display: none;" onchange="handleBidPhotosChangeEmbedded(this, ' + itemId + ');" />' +
                    '<button type="button" onclick="document.getElementById(\'n88-bid-photos-input-embedded-' + itemId + '\').click();" style="padding: 8px 16px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; cursor: pointer; font-size: 12px; margin-bottom: 12px; font-family: monospace;">+ Add Photos</button>' +
                    '<div id="n88-bid-photos-preview-embedded-' + itemId + '" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;"></div>' +
                    '<div id="n88-bid-photos-error-embedded-' + itemId + '" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        
                    // 3. Prototype (Yes/No or required commitment) - Commit 2.3.5.4: Field order 3
                        '<div style="margin-bottom: 24px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">PROTOTYPE (Required)</label>' +
                    '<div style="font-size: 11px; color: #fff; margin-bottom: 8px; font-family: monospace;">Will you prepare and video a prototype?</div>' +
                    '<div style="display: flex; gap: 16px; margin-bottom: 8px;">' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">' +
                    '<input type="radio" name="prototype_video_yes" value="1" required style="width: 16px; height: 16px; cursor: pointer; accent-color: #00ff00;" onchange="validateBidFormEmbedded(' + itemId + ');" />' +
                    '<span style="font-size: 12px; color: #fff; font-family: monospace;">YES</span>' +
                    '</label>' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">' +
                    '<input type="radio" name="prototype_video_yes" value="0" style="width: 16px; height: 16px; cursor: pointer; accent-color: #00ff00;" onchange="validateBidFormEmbedded(' + itemId + ');" />' +
                    '<span style="font-size: 12px; color: #fff; font-family: monospace;">NO</span>' +
                    '</label>' +
                        '</div>' +
                    '<div style="font-size: 10px; color: #00ff00; margin-bottom: 12px; font-family: monospace; font-style: italic;">Helper: YES is required for this platform.</div>' +
                    '<div id="n88-prototype-video-error-embedded-' + itemId + '" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                    // Prototype timeline - white subheading
                        '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">Prototype timeline (Required):</label>' +
                    '<select name="prototype_timeline_option" required style="width: 100%; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="validateBidFormEmbedded(' + itemId + ');">' +
                    '<option value="">[ Select timeline... â–¼ ]</option>' +
                    '<option value="1-2w">1â€“2w</option>' +
                    '<option value="2-4w">2â€“4w</option>' +
                    '<option value="4-6w">4â€“6w</option>' +
                    '<option value="6-8w">6â€“8w</option>' +
                    '<option value="8-10w">8â€“10w</option>' +
                    '</select>' +
                    '<div id="n88-prototype-timeline-error-embedded-' + itemId + '" style="margin-top: 4px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                    // Prototype cost - white subheading
                    '<div style="margin-bottom: 0;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">Prototype cost (Required):</label>' +
                    '<input type="number" name="prototype_cost" step="0.01" min="0" required placeholder="0.00" style="width: 100%; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; font-family: monospace;" oninput="validateBidFormEmbedded(' + itemId + ');" />' +
                    '<div id="n88-prototype-cost-error-embedded-' + itemId + '" style="margin-top: 4px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        '</div>' +
                        
                    // 6. Production lead time (dropdown) - Commit 2.3.5.4: Field order 6
                        '<div style="margin-bottom: 24px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">Production lead time (Required) â€” Dropdown</label>' +
                    '<select name="production_lead_time_text" required style="width: 100%; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="validateBidFormEmbedded(' + itemId + ');">' +
                    '<option value="">[ Select lead time... â–¼ ]</option>' +
                    '<option value="2-4 weeks">2â€“4 weeks</option>' +
                    '<option value="4-6 weeks">4â€“6 weeks</option>' +
                    '<option value="6-8 weeks">6â€“8 weeks</option>' +
                    '<option value="8-12 weeks">8â€“12 weeks</option>' +
                    '<option value="12-16 weeks">12â€“16 weeks</option>' +
                    '</select>' +
                    '<div id="n88-lead-time-error-embedded-' + itemId + '" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        
                    // 7. Unit price - Commit 2.3.5.4: Field order 7
                        '<div style="margin-bottom: 24px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">Unit price (Required)</label>' +
                    '<input type="number" name="unit_price" step="0.01" min="0.01" required placeholder="0.00" style="width: 100%; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; font-family: monospace;" oninput="validateBidFormEmbedded(' + itemId + ');" />' +
                    '<div id="n88-unit-price-error-embedded-' + itemId + '" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                            '</div>' +
                    
                    // 8. SMART ALTERNATIVE (DFM) - Commit 2.3.5.5: Remove designer notes from Smart Alternatives (they belong in Item Context)
                    ((item.smart_alternatives_enabled) ? 
                    '<div style="margin-bottom: 24px; padding: 16px; background-color: #1a1a1a; border-radius: 2px; border: none;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #00ff00; font-family: monospace;">SMART ALTERNATIVE (DFM)</label>' +
                    // C1: Display designer's Smart Alternatives setting (read-only) - NO designer notes here
                    '<div style="padding: 12px; background-color: #000; border-radius: 2px; border: 1px solid #00ff00; margin-bottom: 12px;">' +
                    '<div style="font-size: 11px; color: #00ff00; font-family: monospace; margin-bottom: 8px;">' +
                    '<strong>Smart Alternatives:</strong> <span style="color: ' + (item.smart_alternatives_enabled ? '#00ff00' : '#666') + ';">' + (item.smart_alternatives_enabled ? 'Enabled' : 'Disabled') + '</span>' +
                        '</div>' +
                    (item.smart_alternatives_enabled ? '<div style="font-size: 11px; color: #00ff00; font-family: monospace; margin-bottom: 8px;">Creator is open to comparable material/spec alternatives.</div>' : '') +
                        '</div>' +
                    // C2: Supplier can add ONE structured Smart Alternative suggestion (only if enabled)
                    (item.smart_alternatives_enabled ? 
                    '<div style="padding: 12px; background-color: #000; border-radius: 2px; border: 1px solid #00ff00; margin-top: 12px;">' +
                    '<div style="font-size: 11px; color: #00ff00; font-family: monospace; margin-bottom: 12px; font-weight: 600;">Propose Smart Alternative (Optional):</div>' +
                    // Category dropdown
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">Category:</label>' +
                    '<select name="smart_alt_category" id="n88-smart-alt-category-' + itemId + '" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreview(' + itemId + ');">' +
                    '<option value="">[ Select category... ]</option>' +
                    '<option value="material">Material</option>' +
                    '<option value="finish">Finish</option>' +
                    '<option value="hardware">Hardware</option>' +
                    '<option value="dimensions">Dimensions</option>' +
                    '<option value="construction">Construction Method</option>' +
                    '<option value="packaging">Packaging</option>' +
                    '</select>' +
                        '</div>' +
                    // From dropdown
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">From:</label>' +
                    '<select name="smart_alt_from" id="n88-smart-alt-from-' + itemId + '" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreview(' + itemId + ');">' +
                    '<option value="">[ Select from... ]</option>' +
                    '<option value="solid-wood">Solid Wood</option>' +
                    '<option value="plywood">Plywood</option>' +
                    '<option value="mdf">MDF</option>' +
                    '<option value="metal">Metal</option>' +
                    '<option value="plastic">Plastic</option>' +
                    '<option value="glass">Glass</option>' +
                    '<option value="fabric">Fabric</option>' +
                    '<option value="leather">Leather</option>' +
                    '<option value="other">Other</option>' +
                    '</select>' +
                        '</div>' +
                    // To dropdown
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">To:</label>' +
                    '<select name="smart_alt_to" id="n88-smart-alt-to-' + itemId + '" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreview(' + itemId + ');">' +
                    '<option value="">[ Select to... ]</option>' +
                    '<option value="solid-wood">Solid Wood</option>' +
                    '<option value="plywood">Plywood</option>' +
                    '<option value="mdf">MDF</option>' +
                    '<option value="metal">Metal</option>' +
                    '<option value="plastic">Plastic</option>' +
                    '<option value="glass">Glass</option>' +
                    '<option value="fabric">Fabric</option>' +
                    '<option value="leather">Leather</option>' +
                    '<option value="other">Other</option>' +
                    '</select>' +
                    '</div>' +
                    // Comparison points (checkboxes, max 3)
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 6px; color: #fff; font-family: monospace;">Comparison Points (max 3):</label>' +
                    '<div style="display: flex; flex-direction: column; gap: 6px;">' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="cost-reduction" class="n88-smart-alt-checkbox" onchange="updateSmartAltPreview(' + itemId + ');" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Cost Reduction</span></label>' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="faster-production" class="n88-smart-alt-checkbox" onchange="updateSmartAltPreview(' + itemId + ');" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Faster Production</span></label>' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="better-durability" class="n88-smart-alt-checkbox" onchange="updateSmartAltPreview(' + itemId + ');" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Better Durability</span></label>' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="easier-sourcing" class="n88-smart-alt-checkbox" onchange="updateSmartAltPreview(' + itemId + ');" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Easier Sourcing</span></label>' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="lighter-weight" class="n88-smart-alt-checkbox" onchange="updateSmartAltPreview(' + itemId + ');" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Lighter Weight</span></label>' +
                    '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="eco-friendly" class="n88-smart-alt-checkbox" onchange="updateSmartAltPreview(' + itemId + ');" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Eco-Friendly</span></label>' +
                    '</div>' +
                    '</div>' +
                    // Price impact dropdown
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">Price Impact:</label>' +
                    '<select name="smart_alt_price_impact" id="n88-smart-alt-price-' + itemId + '" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreview(' + itemId + ');">' +
                    '<option value="">[ Select impact... ]</option>' +
                    '<option value="reduces-10-20">Reduces 10-20%</option>' +
                    '<option value="reduces-20-30">Reduces 20-30%</option>' +
                    '<option value="reduces-30-plus">Reduces 30%+</option>' +
                    '<option value="similar">Similar Price</option>' +
                    '<option value="increases-10-20">Increases 10-20%</option>' +
                    '<option value="increases-20-plus">Increases 20%+</option>' +
                    '</select>' +
                    '</div>' +
                    // Lead time impact dropdown
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">Lead Time Impact:</label>' +
                    '<select name="smart_alt_lead_time_impact" id="n88-smart-alt-leadtime-' + itemId + '" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreview(' + itemId + ');">' +
                    '<option value="">[ Select impact... ]</option>' +
                    '<option value="reduces-1-2w">Reduces 1-2 weeks</option>' +
                    '<option value="reduces-2-4w">Reduces 2-4 weeks</option>' +
                    '<option value="reduces-4w-plus">Reduces 4+ weeks</option>' +
                    '<option value="similar">Similar Lead Time</option>' +
                    '<option value="increases-1-2w">Increases 1-2 weeks</option>' +
                    '<option value="increases-2w-plus">Increases 2+ weeks</option>' +
                    '</select>' +
                    '</div>' +
                    // Preview sentence (read-only)
                    '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #00ff00;">' +
                    '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #00ff00; font-family: monospace; font-weight: 600;">Preview:</label>' +
                    '<div id="n88-smart-alt-preview-' + itemId + '" style="padding: 8px; background-color: #1a1a1a; border: none; border-radius: 2px; font-size: 11px; color: #999; font-family: monospace; min-height: 40px; font-style: italic;">Fill in the fields above to generate preview...</div>' +
                    '</div>' +
                    '</div>' : '') +
                    '</div>' : '') +
                    
                    // Footer buttons
                    '<div style="padding: 20px 0; border-top: 1px solid #00ff00; display: flex; justify-content: flex-end; gap: 12px; flex-wrap: wrap;">' +
                    '<button type="button" id="n88-validate-bid-btn-embedded-' + itemId + '" onclick="validateAndSubmitBidEmbedded(event, ' + itemId + ')" disabled style="padding: 10px 20px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 12px; font-weight: 600; cursor: not-allowed; font-family: monospace; opacity: 0.5;">[ Validate Bid ]</button>' +
                    // Commit 2.3.5.4: Buttons row - Validate, Cancel, Save for later
                    '<button type="button" id="n88-submit-bid-btn-embedded-' + itemId + '" onclick="submitBidEmbedded(event, ' + itemId + ')" disabled style="display: none; padding: 10px 20px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: monospace;">[ Submit Proposal ]</button>' +
                    '<button type="button" onclick="toggleBidForm(' + itemId + ')" style="padding: 10px 20px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 12px; cursor: pointer; font-family: monospace;">[ Cancel ]</button>' +
                    '<button type="button" onclick="saveBidDraftEmbedded(' + itemId + ')" style="padding: 10px 20px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 12px; cursor: pointer; font-family: monospace;">[ Save for later ]</button>' +
                        '</div>' +
                    '</form>';
                
                return bidFormHTML;
            }
            
            // Commit 2.3.3: Open bid form modal
            function openBidFormModal(itemId) {
                // Check if bid already submitted (Commit 2.3.5)
                var formData = new FormData();
                formData.append('action', 'n88_get_supplier_item_details');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_supplier_item_details' ); ?>');
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    // Allow opening form if:
                    // 1. No bid exists yet
                    // 2. Bid is stale (has_revision_mismatch) - dims/qty changed, can resubmit
                    // 3. Bid is draft (can continue/update)
                    // Only block if bid is submitted/awarded for current revision (no changes needed)
                    // Commit 2.4.1: Include 'awarded' status - can't resubmit an awarded bid
                    if (data.success && (data.data.bid_status === 'submitted' || data.data.bid_status === 'awarded') && !data.data.has_revision_mismatch && !data.data.is_resubmission) {
                        if (data.data.bid_status === 'awarded') {
                            alert('This bid has been awarded. You cannot modify an awarded bid.');
                        } else {
                            alert('You\'ve already submitted a bid for this item.');
                        }
                        return;
                    }
                    // Continue with opening modal (allows resubmission when dims/qty changed)
                    openBidFormModalInternal(itemId);
                })
                .catch(function(error) {
                    console.error('Error checking bid status:', error);
                    // Continue with opening modal if check fails
                    openBidFormModalInternal(itemId);
                });
            }
            
            function openBidFormModalInternal(itemId) {
                var modal = document.getElementById('n88-supplier-bid-form-modal');
                var modalContent = document.getElementById('n88-supplier-bid-form-modal-content');
                
                if (!modal || !modalContent) return;
                
                // Store item ID for form submission
                modal.setAttribute('data-item-id', itemId);
                
                // Show loading state
                modalContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">Loading item details...</div>';
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                // Fetch item details to get images
                var formData = new FormData();
                formData.append('action', 'n88_get_supplier_item_details');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_supplier_item_details' ); ?>');
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (!data.success) {
                        modalContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #d32f2f;">' + 
                            '<p style="margin-bottom: 20px;">' + (data.data && data.data.message ? data.data.message : 'Error loading item details') + '</p>' +
                            '<button onclick="closeBidFormModal()" style="padding: 8px 16px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Close</button>' +
                            '</div>';
                        return;
                    }
                    
                    var item = data.data;
                    
                    // Format dimensions for item header (Commit 2.3.5.2)
                    var dimsText = 'â€”';
                    if (item.dimensions) {
                        var w = item.dimensions.width || item.dimensions.w || 'â€”';
                        var d = item.dimensions.depth || item.dimensions.d || 'â€”';
                        var h = item.dimensions.height || item.dimensions.h || 'â€”';
                        var unit = item.dimensions.unit || '';
                        if (w !== 'â€”' && d !== 'â€”' && h !== 'â€”') {
                            dimsText = w + '"W Ã— ' + d + '"D Ã— ' + h + '"H';
                            if (unit && unit !== 'in') {
                                dimsText = w + unit + 'W Ã— ' + d + unit + 'D Ã— ' + h + unit + 'H';
                            }
                        }
                    }
                    
                    // Format delivery location
                    var deliveryText = 'â€”';
                    if (item.delivery_country && item.delivery_postal_code) {
                        deliveryText = item.delivery_country + ' ' + item.delivery_postal_code;
                    } else if (item.delivery_country) {
                        deliveryText = item.delivery_country;
                    }
                    
                    // Format item title with category
                    var itemTitleText = (item.title || 'Item #' + itemId);
                    if (item.category) {
                        itemTitleText += ' (' + item.category + ')';
                    }
                    
                    // Get primary image URL (use standardized key, fallback to legacy)
                    var primaryImageUrl = item.primary_image_url || item.image_url || '';
                    
                    // Get inspiration images (use standardized key, fallback to legacy)
                    var inspirationImages = item.inspiration_images || item.reference_images || [];
                    
                    // Filter and prepare valid reference images
                    var validReferenceImages = [];
                    if (inspirationImages && inspirationImages.length > 0) {
                        inspirationImages.forEach(function(img) {
                            var imgUrl = '';
                            var fullUrl = '';
                            
                            if (typeof img === 'string') {
                                imgUrl = img;
                                fullUrl = img;
                            } else if (typeof img === 'object') {
                                imgUrl = img.url || img.thumbnail || img.thumb_url || '';
                                fullUrl = img.full_url || img.url || img.thumbnail || img.thumb_url || '';
                            }
                            
                            // Only add image if we have a valid HTTP/HTTPS URL
                            if (imgUrl && imgUrl.trim() !== '' && (imgUrl.startsWith('http://') || imgUrl.startsWith('https://'))) {
                                validReferenceImages.push({
                                    url: imgUrl,
                                    fullUrl: fullUrl || imgUrl
                                });
                            }
                        });
                    }
                    
                    // Build image gallery layout: left reference images, center main image, right reference images
                    var imageGalleryHTML = '';
                    if (primaryImageUrl || validReferenceImages.length > 0) {
                        // Split reference images into left and right
                        var leftImages = [];
                        var rightImages = [];
                        validReferenceImages.forEach(function(img, index) {
                            if (index % 2 === 0) {
                                leftImages.push(img);
                            } else {
                                rightImages.push(img);
                            }
                        });
                        
                        // Build left column (reference images)
                        var leftColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                        if (leftImages.length > 0) {
                            leftImages.forEach(function(img, index) {
                                var imgId = 'n88-ref-left-' + itemId + '-' + index;
                                leftColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                                    '<img id="' + imgId + '" ' +
                                    'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                                    'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                                    'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                                    'style="width: 100px; height: 100px; object-fit: cover; border-radius: 2px; border: 2px solid #00ff00; cursor: pointer; transition: all 0.2s; background-color: #1a1a1a;" ' +
                                    'onmouseover="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,255,0,0.5)\';" ' +
                                    'onmouseout="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                    'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\')||elem.src;if(url&&url.trim()){openSupplierImageLightbox(url);}else{console.error(\'No URL found for image\');}})(this);" ' +
                                    'title="Click to view full size" ' +
                                    'alt="Reference photo" />' +
                                    '</div>';
                            });
                        } else {
                            // Placeholder if no left images
                            // leftColumnHTML += '<div style="width: 100px; height: 100px; background-color: #000; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 11px; text-align: center; padding: 4px;">reference photo</div>';
                        }
                        leftColumnHTML += '</div>';
                        
                        // Build center column (main image) - sized appropriately
                        var centerColumnHTML = '<div style="flex: 1; display: flex; align-items: center; justify-content: center; min-height: 300px; padding: 0 20px; max-width: 500px;">';
                        if (primaryImageUrl) {
                            centerColumnHTML += '<img src="' + primaryImageUrl.replace(/"/g, '&quot;') + '" ' +
                                'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23f0f0f0\' width=\'400\' height=\'300\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'14\'%3EItem Image%3C/text%3E%3C/svg%3E\';" ' +
                                'style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 2px; border: 2px solid #00ff00; object-fit: contain; box-shadow: 0 2px 8px rgba(0,255,0,0.3); cursor: pointer; transition: all 0.2s; background-color: #1a1a1a;" ' +
                                'onclick="event.preventDefault();event.stopPropagation();if(typeof window.openSupplierImageLightbox === \'function\'){window.openSupplierImageLightbox(\'' + primaryImageUrl.replace(/'/g, "\\'").replace(/\\/g, '\\\\').replace(/"/g, '&quot;') + '\');}return false;" ' +
                                'onmouseover="this.style.opacity=\'0.9\'; this.style.borderColor=\'#00ff00\'; this.style.boxShadow=\'0 4px 12px rgba(0,255,0,0.5)\';" ' +
                                'onmouseout="this.style.opacity=\'1\'; this.style.borderColor=\'#00ff00\'; this.style.boxShadow=\'0 2px 8px rgba(0,255,0,0.3)\';" ' +
                                'title="Click to enlarge" ' +
                                'alt="Item main image" />';
                        } else {
                            centerColumnHTML += '<div style="width: 100%; height: 300px; background-color: #1a1a1a; border-radius: 2px; border: none; display: flex; align-items: center; justify-content: center; color: #00ff00; font-family: monospace; font-size: 12px;">No main image available</div>';
                        }
                        centerColumnHTML += '</div>';
                        
                        // Build right column (reference images)
                        var rightColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                        if (rightImages.length > 0) {
                            rightImages.forEach(function(img, index) {
                                var imgId = 'n88-ref-right-' + itemId + '-' + index;
                                rightColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                                    '<img id="' + imgId + '" ' +
                                    'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                                    'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                                    'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                                    'style="width: 100px; height: 100px; object-fit: cover; border-radius: 2px; border: 2px solid #00ff00; cursor: pointer; transition: all 0.2s; background-color: #1a1a1a;" ' +
                                    'onmouseover="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,255,0,0.5)\';" ' +
                                    'onmouseout="this.style.borderColor=\'#00ff00\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                    'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\')||elem.src;if(url&&url.trim()){openSupplierImageLightbox(url);}else{console.error(\'No URL found for image\');}})(this);" ' +
                                    'title="Click to view full size" ' +
                                    'alt="Reference photo" />' +
                                    '</div>';
                            });
                        } else {
                            // Placeholder if no right images
                            // rightColumnHTML += '<div style="width: 100px; height: 100px; background-color: #000; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 11px; text-align: center; padding: 4px;">reference photo</div>';
                        }
                        rightColumnHTML += '</div>';
                        
                        // Combine into gallery layout (Commit 2.3.5.2: Dark theme)
                        imageGalleryHTML = '<div style="margin-bottom: 24px; display: flex; gap: 16px; align-items: flex-start; justify-content: center; padding: 16px; background-color: #1a1a1a; border-radius: 4px; border: 1px solid #00ff00;">' +
                            leftColumnHTML +
                            centerColumnHTML +
                            rightColumnHTML +
                            '</div>';
                    }
                    
                    // Build bid form modal HTML (Commit 2.3.5.2: Dark theme with green accents - terminal style)
                    var modalHTML = 
                        // Item Header Section (RFQ, Qty, Dims, Delivery)
                        '<div style="padding: 16px 20px; border-bottom: 1px solid #00ff00; background-color: #000; display: flex; justify-content: space-between; align-items: center;">' +
                        '<div style="flex: 1;">' +
                        '<div style="font-size: 12px; color: #00ff00; font-family: monospace; margin-bottom: 4px;">RFQ: <span style="color: #fff;">' + itemTitleText + '</span></div>' +
                        '<div style="display: flex; gap: 16px; font-size: 11px; color: #00ff00; font-family: monospace; flex-wrap: wrap;">' +
                        '<span>Qty: <span style="color: #fff;">' + (item.quantity || 'â€”') + '</span></span>' +
                        '<span>Dims: <span style="color: #fff;">' + dimsText + '</span></span>' +
                        '<span>Delivery: <span style="color: #fff;">' + deliveryText + '</span></span>' +
                        '</div>' +
                        '</div>' +
                        '<button onclick="closeBidFormModal()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px 8px; color: #00ff00; font-family: monospace; line-height: 1;">[x Close]</button>' +
                        '</div>' +
                        '<div style="flex: 1; overflow-y: auto; padding: 0; background-color: #000;">' +
                        
                        // G) Specs Changed Warning Banner (show but don't block form)
                        (item.has_revision_mismatch ? 
                            '<div id="n88-specs-changed-banner" style="margin: 20px; padding: 16px; background-color: #331100; border: 2px solid #ff9800; border-radius: 4px;">' +
                            '<div style="font-size: 14px; font-weight: 600; color: #ff9800; margin-bottom: 12px; font-family: monospace;">âš ï¸ Specs changed since your last bid.</div>' +
                            '<div style="font-size: 12px; color: #fff; margin-bottom: 16px; font-family: monospace; line-height: 1.5;">' +
                            'The item specifications have been updated. Please review and update your bid to match the new specs before submitting.' +
                            '</div>' +
                            '</div>' : '') +
                        
                        '<form id="n88-bid-form" style="padding: 20px; font-family: monospace;" onsubmit="return validateAndSubmitBid(event);">' +
                        
                        // Image gallery: left reference images, center main image, right reference images
                        imageGalleryHTML +
                        
                        // Commit 2.3.5.4: BID FORM Title - Remove "Anonymous â€¢ No contact info allowed"
                        '<div style="margin-bottom: 24px; padding: 12px 0; border-bottom: 1px solid #00ff00;">' +
                        '<h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #00ff00; font-family: monospace;">BID FORM</h2>' +
                        '</div>' +
                        
                        // 1. Video links (optional, 0-3) - Commit 2.3.5.4: Field order 1
                        '<div style="margin-bottom: 24px;">' +
                        '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #00ff00; font-family: monospace;">VIDEO LINKS (Optional)</label>' +
                        '<div style="font-size: 11px; color: #fff; margin-bottom: 8px; font-family: monospace;">Min 0, Max 3. Allowed: YouTube / Vimeo / Loom</div>' +
                        '<div id="n88-video-links-container">' +
                        '<div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">' +
                        '<span style="color: #00ff00; font-family: monospace; font-size: 12px;">1)</span>' +
                        '<input type="url" name="video_links[]" class="n88-video-link-input" placeholder="https://youtube.com/watch?v=..." style="flex: 1; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; font-family: monospace;" onblur="validateVideoLink(this);" oninput="validateBidForm();" />' +
                        '<button type="button" onclick="removeVideoLink(this)" style="padding: 8px 12px; background-color: #dc3545; color: #fff; border: none; border-radius: 2px; cursor: pointer; display: none; font-family: monospace; font-size: 11px;">Remove</button>' +
                        '</div>' +
                        '</div>' +
                        '<button type="button" onclick="addVideoLink()" id="n88-add-video-link-btn" style="margin-top: 8px; padding: 6px 12px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; cursor: pointer; font-size: 11px; font-family: monospace;">+ Add Another Link</button>' +
                        '<div id="n88-video-links-error" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        
                        // 2. Reference photo(s) (required, min 1, max 5) - Commit 2.3.5.4: Renamed from "BID PHOTOS"
                        '<div style="margin-bottom: 24px;">' +
                        '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">Reference photo(s) <span style="color: #ff0000;">*</span></label>' +
                        '<div style="font-size: 11px; color: #fff; margin-bottom: 8px; font-family: monospace;">Upload photos of similar items or your work. Minimum 1 photo required (recommended 1-5).</div>' +
                        '<input type="file" id="n88-bid-photos-input" name="bid_photos[]" accept="image/*" multiple style="display: none;" onchange="handleBidPhotosChange(this);" />' +
                        '<button type="button" onclick="document.getElementById(\'n88-bid-photos-input\').click();" style="padding: 8px 16px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; cursor: pointer; font-size: 12px; margin-bottom: 12px; font-family: monospace;">+ Add Photos</button>' +
                        '<div id="n88-bid-photos-preview" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;"></div>' +
                        '<div id="n88-bid-photos-error" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                    
                        // 2. Prototype video commitment (must be YES) - Commit 2.3.5.2: Dark theme
                        '<div style="margin-bottom: 24px;">' +
                        '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">PROTOTYPE (Required)</label>' +
                        '<div style="font-size: 11px; color: #fff; margin-bottom: 8px; font-family: monospace;">Will you prepare and video a prototype?</div>' +
                        '<div style="display: flex; gap: 16px; margin-bottom: 8px;">' +
                        '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">' +
                        '<input type="radio" name="prototype_video_yes" value="1" required style="width: 16px; height: 16px; cursor: pointer; accent-color: #00ff00;" onchange="validateBidForm();" />' +
                        '<span style="font-size: 12px; color: #fff; font-family: monospace;">(â—) YES</span>' +
                        '</label>' +
                        '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">' +
                        '<input type="radio" name="prototype_video_yes" value="0" style="width: 16px; height: 16px; cursor: pointer; accent-color: #00ff00;" onchange="validateBidForm();" />' +
                        '<span style="font-size: 12px; color: #fff; font-family: monospace;">() NO</span>' +
                        '</label>' +
                        '</div>' +
                        '<div style="font-size: 10px; color: #00ff00; margin-bottom: 12px; font-family: monospace; font-style: italic;">Helper: YES is required for this platform.</div>' +
                        '<div id="n88-prototype-video-error" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        // Prototype timeline
                        '<div style="margin-bottom: 12px;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #00ff00; font-family: monospace;">Prototype timeline (Required):</label>' +
                        '<select name="prototype_timeline_option" required style="width: 100%; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="validateBidForm();">' +
                        '<option value="">[ Select timeline... â–¼ ]</option>' +
                        '<option value="1-2w">1â€“2w</option>' +
                        '<option value="2-4w">2â€“4w</option>' +
                        '<option value="4-6w">4â€“6w</option>' +
                        '<option value="6-8w">6â€“8w</option>' +
                        '<option value="8-10w">8â€“10w</option>' +
                        '</select>' +
                        '<div id="n88-prototype-timeline-error" style="margin-top: 4px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        // Prototype cost
                        '<div style="margin-bottom: 0;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #00ff00; font-family: monospace;">Prototype cost (Required):</label>' +
                        '<input type="number" name="prototype_cost" step="0.01" min="0" required placeholder="0.00" style="width: 100%; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; font-family: monospace;" oninput="validateBidForm();" />' +
                        '<div id="n88-prototype-cost-error" style="margin-top: 4px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        '</div>' +
                        
                        // 3. Production lead time - Commit 2.3.5.2: Dark theme
                        '<div style="margin-bottom: 24px;">' +
                        '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">Production lead time (Required) â€” Dropdown</label>' +
                        '<select name="production_lead_time_text" required style="width: 100%; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="validateBidForm();">' +
                        '<option value="">[ Select lead time... â–¼ ]</option>' +
                        '<option value="2-4 weeks">2â€“4 weeks</option>' +
                        '<option value="4-6 weeks">4â€“6 weeks</option>' +
                        '<option value="6-8 weeks">6â€“8 weeks</option>' +
                        '<option value="8-12 weeks">8â€“12 weeks</option>' +
                        '<option value="12-16 weeks">12â€“16 weeks</option>' +
                        '</select>' +
                        '<div id="n88-lead-time-error" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        
                        // 4. Unit price - Commit 2.3.5.2: Dark theme
                        '<div style="margin-bottom: 24px;">' +
                        '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #fff; font-family: monospace;">Unit price (Required)</label>' +
                        '<input type="number" name="unit_price" step="0.01" min="0.01" required placeholder="0.00" style="width: 100%; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; font-family: monospace;" oninput="validateBidForm();" />' +
                        '<div id="n88-unit-price-error" style="margin-top: 6px; font-size: 11px; color: #ff0000; display: none; font-family: monospace;"></div>' +
                        '</div>' +
                        
                        // 8. SMART ALTERNATIVE (DFM) - Commit 2.3.5.5: Remove designer notes from Smart Alternatives (they belong in Item Context)
                        ((item.smart_alternatives_enabled) ? 
                        '<div style="margin-bottom: 24px; padding: 16px; background-color: #1a1a1a; border-radius: 2px; border: none;">' +
                        '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #00ff00; font-family: monospace;">SMART ALTERNATIVE (DFM)</label>' +
                        // C1: Display designer's Smart Alternatives setting (read-only) - NO designer notes here
                        '<div style="padding: 12px; background-color: #000; border-radius: 2px; border: 1px solid #00ff00; margin-bottom: 12px;">' +
                        '<div style="font-size: 11px; color: #00ff00; font-family: monospace; margin-bottom: 8px;">' +
                        '<strong>Smart Alternatives:</strong> <span style="color: ' + (item.smart_alternatives_enabled ? '#00ff00' : '#666') + ';">' + (item.smart_alternatives_enabled ? 'Enabled' : 'Disabled') + '</span>' +
                        '</div>' +
                        (item.smart_alternatives_enabled ? '<div style="font-size: 11px; color: #00ff00; font-family: monospace; margin-bottom: 8px;">Creator is open to comparable material/spec alternatives.</div>' : '') +
                        '</div>' +
                        // C2: Supplier can add ONE structured Smart Alternative suggestion (only if enabled)
                        (item.smart_alternatives_enabled ? 
                        '<div style="padding: 12px; background-color: #000; border-radius: 2px; border: 1px solid #00ff00; margin-top: 12px;">' +
                        '<div style="font-size: 11px; color: #00ff00; font-family: monospace; margin-bottom: 12px; font-weight: 600;">Propose Smart Alternative (Optional):</div>' +
                        // Category dropdown
                        '<div style="margin-bottom: 12px;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">Category:</label>' +
                        '<select name="smart_alt_category" id="n88-smart-alt-category-modal" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreviewModal();">' +
                        '<option value="">[ Select category... ]</option>' +
                        '<option value="material">Material</option>' +
                        '<option value="finish">Finish</option>' +
                        '<option value="hardware">Hardware</option>' +
                        '<option value="dimensions">Dimensions</option>' +
                        '<option value="construction">Construction Method</option>' +
                        '<option value="packaging">Packaging</option>' +
                        '</select>' +
                        '</div>' +
                        // From dropdown
                        '<div style="margin-bottom: 12px;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">From:</label>' +
                        '<select name="smart_alt_from" id="n88-smart-alt-from-modal" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreviewModal();">' +
                        '<option value="">[ Select from... ]</option>' +
                        '<option value="solid-wood">Solid Wood</option>' +
                        '<option value="plywood">Plywood</option>' +
                        '<option value="mdf">MDF</option>' +
                        '<option value="metal">Metal</option>' +
                        '<option value="plastic">Plastic</option>' +
                        '<option value="glass">Glass</option>' +
                        '<option value="fabric">Fabric</option>' +
                        '<option value="leather">Leather</option>' +
                        '<option value="other">Other</option>' +
                        '</select>' +
                        '</div>' +
                        // To dropdown
                        '<div style="margin-bottom: 12px;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">To:</label>' +
                        '<select name="smart_alt_to" id="n88-smart-alt-to-modal" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreviewModal();">' +
                        '<option value="">[ Select to... ]</option>' +
                        '<option value="solid-wood">Solid Wood</option>' +
                        '<option value="plywood">Plywood</option>' +
                        '<option value="mdf">MDF</option>' +
                        '<option value="metal">Metal</option>' +
                        '<option value="plastic">Plastic</option>' +
                        '<option value="glass">Glass</option>' +
                        '<option value="fabric">Fabric</option>' +
                        '<option value="leather">Leather</option>' +
                        '<option value="other">Other</option>' +
                        '</select>' +
                        '</div>' +
                        // Comparison points (checkboxes, max 3)
                        '<div style="margin-bottom: 12px;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 6px; color: #fff; font-family: monospace;">Comparison Points (max 3):</label>' +
                        '<div style="display: flex; flex-direction: column; gap: 6px;">' +
                        '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="cost-reduction" class="n88-smart-alt-checkbox-modal" onchange="updateSmartAltPreviewModal();" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Cost Reduction</span></label>' +
                        '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="faster-production" class="n88-smart-alt-checkbox-modal" onchange="updateSmartAltPreviewModal();" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Faster Production</span></label>' +
                        '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="better-durability" class="n88-smart-alt-checkbox-modal" onchange="updateSmartAltPreviewModal();" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Better Durability</span></label>' +
                        '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="easier-sourcing" class="n88-smart-alt-checkbox-modal" onchange="updateSmartAltPreviewModal();" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Easier Sourcing</span></label>' +
                        '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="lighter-weight" class="n88-smart-alt-checkbox-modal" onchange="updateSmartAltPreviewModal();" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Lighter Weight</span></label>' +
                        '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" name="smart_alt_comparison[]" value="eco-friendly" class="n88-smart-alt-checkbox-modal" onchange="updateSmartAltPreviewModal();" style="width: 14px; height: 14px; cursor: pointer; accent-color: #00ff00;" /><span style="font-size: 11px; color: #fff; font-family: monospace;">Eco-Friendly</span></label>' +
                        '</div>' +
                        '</div>' +
                        // Price impact dropdown
                        '<div style="margin-bottom: 12px;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">Price Impact:</label>' +
                        '<select name="smart_alt_price_impact" id="n88-smart-alt-price-modal" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreviewModal();">' +
                        '<option value="">[ Select impact... ]</option>' +
                        '<option value="reduces-10-20">Reduces 10-20%</option>' +
                        '<option value="reduces-20-30">Reduces 20-30%</option>' +
                        '<option value="reduces-30-plus">Reduces 30%+</option>' +
                        '<option value="similar">Similar Price</option>' +
                        '<option value="increases-10-20">Increases 10-20%</option>' +
                        '<option value="increases-20-plus">Increases 20%+</option>' +
                        '</select>' +
                        '</div>' +
                        // Lead time impact dropdown
                        '<div style="margin-bottom: 12px;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #fff; font-family: monospace;">Lead Time Impact:</label>' +
                        '<select name="smart_alt_lead_time_impact" id="n88-smart-alt-leadtime-modal" style="width: 100%; padding: 6px 10px; border: none; border-radius: 2px; font-size: 11px; background-color: #1a1a1a; color: #fff; cursor: pointer; font-family: monospace;" onchange="updateSmartAltPreviewModal();">' +
                        '<option value="">[ Select impact... ]</option>' +
                        '<option value="reduces-1-2w">Reduces 1-2 weeks</option>' +
                        '<option value="reduces-2-4w">Reduces 2-4 weeks</option>' +
                        '<option value="reduces-4w-plus">Reduces 4+ weeks</option>' +
                        '<option value="similar">Similar Lead Time</option>' +
                        '<option value="increases-1-2w">Increases 1-2 weeks</option>' +
                        '<option value="increases-2w-plus">Increases 2+ weeks</option>' +
                        '</select>' +
                        '</div>' +
                        // Preview sentence (read-only)
                        '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #00ff00;">' +
                        '<label style="display: block; font-size: 11px; margin-bottom: 4px; color: #00ff00; font-family: monospace; font-weight: 600;">Preview:</label>' +
                        '<div id="n88-smart-alt-preview-modal" style="padding: 8px; background-color: #1a1a1a; border: none; border-radius: 2px; font-size: 11px; color: #999; font-family: monospace; min-height: 40px; font-style: italic;">Fill in the fields above to generate preview...</div>' +
                        '</div>' +
                        '</div>' : '') +
                        '</div>' : '') +
                    
                        '</form>' +
                        '</div>' +
                        // Footer with submit button - Commit 2.3.5.2: Dark theme with green buttons
                        '<div style="padding: 20px; border-top: 1px solid #00ff00; background-color: #000; display: flex; justify-content: flex-end; gap: 12px; flex-wrap: wrap;">' +
                        '<div style="flex: 1; min-width: 200px;">' +
                        '<div style="font-size: 11px; color: #00ff00; font-family: monospace; margin-bottom: 8px;">Rules:</div>' +
                        '<div style="font-size: 10px; color: #fff; font-family: monospace;">Rules: No emails / phones / URLs / contact text. No uploads. No links here.</div>' +
                        '</div>' +
                        '<div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">' +
                        '<div style="font-size: 11px; color: #00ff00; font-family: monospace; margin-right: 8px;">ACTIONS:</div>' +
                        '<button type="button" id="n88-validate-bid-btn" onclick="validateAndSubmitBid(event)" disabled style="padding: 10px 20px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 12px; font-weight: 600; cursor: not-allowed; font-family: monospace; opacity: 0.5;">[ Validate Bid ]</button>' +
                        '<button type="button" id="n88-submit-bid-btn" onclick="submitBid(event)" disabled style="display: none; padding: 10px 20px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: monospace;">[ Submit Proposal ]</button>' +
                        '<button type="button" onclick="closeBidFormModal()" style="padding: 10px 20px; background-color: #1a1a1a; color: #00ff00; border: none; border-radius: 2px; font-size: 12px; cursor: pointer; font-family: monospace;">[ Cancel ]</button>' +
                        '</div>' +
                        '</div>';
                    
                    modalContent.innerHTML = modalHTML;
                    
                    // H) Load draft or submitted bid data for modal form
                    setTimeout(function() {
                        loadBidDraftModal(itemId, item);
                    }, 200);
                    
                    // Initial validation - use setTimeout to ensure DOM is ready
                    setTimeout(function() {
                        validateBidForm();
                    }, 100);
                    
                    // Commit 2.3.5.5: Reset button states - Validate button visible, Submit button hidden
                    setTimeout(function() {
                        var validateBtn = document.getElementById('n88-validate-bid-btn');
                        var submitBtn = document.getElementById('n88-submit-bid-btn');
                        if (validateBtn) {
                            validateBtn.style.display = 'inline-block';
                            validateBtn.disabled = true;
                            validateBtn.style.opacity = '0.5';
                        }
                        if (submitBtn) {
                            submitBtn.style.display = 'none';
                            submitBtn.disabled = true;
                        }
                        // Run validation to enable/disable validate button
                        if (typeof validateBidForm === 'function') {
                            validateBidForm();
                        }
                    }, 150);
                })
                .catch(function(error) {
                    console.error('Error loading item details:', error);
                    modalContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #d32f2f;">' + 
                        '<p style="margin-bottom: 20px;">Network error. Failed to load item details.</p>' +
                        '<button onclick="closeBidFormModal()" style="padding: 8px 16px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Close</button>' +
                        '</div>';
                });
            }
            
            // Close bid form modal
            function closeBidFormModal() {
                var modal = document.getElementById('n88-supplier-bid-form-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }
            
            // Commit 2.3.5.1: Supplier image lightbox functions
            function openSupplierImageLightbox(imageUrl) {
                var lightbox = document.getElementById('n88-supplier-image-lightbox');
                var lightboxImage = document.getElementById('n88-supplier-lightbox-image');
                if (lightbox && lightboxImage) {
                    lightboxImage.src = imageUrl;
                    lightbox.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
            }
            
            function closeSupplierImageLightbox(event) {
                if (event) {
                    event.stopPropagation();
                }
                var lightbox = document.getElementById('n88-supplier-image-lightbox');
                if (lightbox) {
                    lightbox.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }
            
            // Commit 2.3.5.1: Handle bid photos upload
            function handleBidPhotosChange(input) {
                var files = input.files;
                if (!files || files.length === 0) {
                    return;
                }
                
                // Validate file count (max 5)
                if (files.length > 5) {
                    alert('Maximum 5 photos allowed. Please select up to 5 photos.');
                    input.value = '';
                    return;
                }
                
                // Validate file types - support HEIC images
                var imageFiles = Array.from(files).filter(function(file) {
                    var fileName = file.name.toLowerCase();
                    return file.type.startsWith('image/') || 
                           fileName.endsWith('.heic') || 
                           fileName.endsWith('.heif');
                });
                
                if (imageFiles.length !== files.length) {
                    alert('Please select image files only.');
                    input.value = '';
                    return;
                }
                
                var previewContainer = document.getElementById('n88-bid-photos-preview');
                var errorDiv = document.getElementById('n88-bid-photos-error');
                
                if (!previewContainer) {
                    console.error('Bid photos preview container not found');
                    return;
                }
                
                // Clear previous previews
                previewContainer.innerHTML = '';
                
                // Get nonce for AJAX
                var nonce = '<?php echo wp_create_nonce( 'n88_upload_inspiration_image' ); ?>';
                var ajaxUrl = '<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>';
                
                // Upload each file
                var uploadPromises = imageFiles.map(function(file, index) {
                    return new Promise(function(resolve, reject) {
                        var formData = new FormData();
                        formData.append('action', 'n88_upload_inspiration_image');
                        formData.append('inspiration_image', file);
                        formData.append('nonce', nonce);
                        
                        // Show loading placeholder
                        var placeholderId = 'n88-bid-photo-placeholder-' + index;
                        var placeholder = document.createElement('div');
                        placeholder.id = placeholderId;
                        placeholder.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9;';
                        placeholder.innerHTML = '<div style="font-size: 11px; color: #999;">Uploading...</div>';
                        previewContainer.appendChild(placeholder);
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('HTTP error! status: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            // Remove placeholder
                            var placeholderEl = document.getElementById(placeholderId);
                            if (placeholderEl) {
                                placeholderEl.remove();
                            }
                            
                            if (data.success && data.data && data.data.id && data.data.url) {
                                // Create thumbnail
                                var thumbDiv = document.createElement('div');
                                thumbDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px solid #ddd; border-radius: 4px; overflow: hidden;';
                                thumbDiv.innerHTML = '<img src="' + data.data.url.replace(/"/g, '&quot;') + '" style="width: 100%; height: 100%; object-fit: cover;" alt="Bid photo" />' +
                                    '<button type="button" onclick="removeBidPhoto(this, ' + data.data.id + ');" style="position: absolute; top: 4px; right: 4px; background: rgba(255, 0, 0, 0.8); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;" title="Remove">Ã—</button>';
                                
                                // Add hidden input INSIDE THE FORM (not in preview container)
                                var form = document.getElementById('n88-bid-form');
                                if (form) {
                                    var hiddenInput = document.createElement('input');
                                    hiddenInput.type = 'hidden';
                                    hiddenInput.name = 'bid_photo_ids[]';
                                    hiddenInput.value = data.data.id;
                                    hiddenInput.setAttribute('data-photo-id', data.data.id);
                                    hiddenInput.setAttribute('data-thumb-div', 'photo-' + data.data.id); // Link to thumbDiv
                                    form.appendChild(hiddenInput);
                                    console.log('âœ“ Added hidden input to form - Photo ID:', data.data.id, 'Total inputs:', form.querySelectorAll('input[name="bid_photo_ids[]"]').length);
                                } else {
                                    console.error('âœ— Form #n88-bid-form not found when adding photo!');
                                }
                                
                                // Store reference in thumbDiv for easy removal
                                thumbDiv.setAttribute('data-photo-id', data.data.id);
                                previewContainer.appendChild(thumbDiv);
                                
                                resolve({ id: data.data.id, url: data.data.url });
                            } else {
                                var errorMsg = data.data && data.data.message ? data.data.message : 'Upload failed';
                                throw new Error(errorMsg);
                            }
                        })
                        .catch(function(error) {
                            // Remove placeholder
                            var placeholderEl = document.getElementById(placeholderId);
                            if (placeholderEl) {
                                placeholderEl.remove();
                            }
                            
                            console.error('Error uploading photo:', error);
                            if (errorDiv) {
                                errorDiv.textContent = 'Failed to upload ' + file.name + ': ' + error.message;
                                errorDiv.style.display = 'block';
                            }
                            reject(error);
                        });
                    });
                });
                
                // Clear error on success
                Promise.all(uploadPromises).then(function(results) {
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                    
                    // Verify inputs were added before validating
                    var form = document.getElementById('n88-bid-form');
                    if (form) {
                        var inputs = form.querySelectorAll('input[name="bid_photo_ids[]"]');
                        console.log('After upload - Total photo inputs in form:', inputs.length);
                        if (inputs.length > 0) {
                            inputs.forEach(function(input, idx) {
                                console.log('  Input ' + idx + ':', input.value);
                            });
                        }
                    }
                    
                    // Force validation after a delay to ensure DOM is fully updated
                    setTimeout(function() {
                        if (typeof validateBidForm === 'function') {
                            var validationResult = validateBidForm();
                            console.log('Validation result after upload:', validationResult);
                        }
                    }, 300);
                }).catch(function() {
                    // Errors already handled above
                });
            }
            
            // Remove bid photo
            function removeBidPhoto(button, photoId) {
                if (!confirm('Remove this photo?')) {
                    return;
                }
                
                var thumbDiv = button.parentElement;
                thumbDiv.remove();
                
                // Remove the hidden input from form
                var form = document.getElementById('n88-bid-form');
                if (form) {
                    var hiddenInput = form.querySelector('input[data-photo-id="' + photoId + '"]');
                    if (hiddenInput) {
                        hiddenInput.remove();
                    }
                }
                
                // Clear file input if no photos left
                var previewContainer = document.getElementById('n88-bid-photos-preview');
                var remainingPhotos = previewContainer.querySelectorAll('div[style*="position: relative"]').length;
                if (remainingPhotos === 0) {
                    var input = document.getElementById('n88-bid-photos-input');
                    if (input) {
                        input.value = '';
                    }
                }
                
                validateBidForm();
            }
            
            // Add video link input
            function addVideoLink() {
                var container = document.getElementById('n88-video-links-container');
                var linkCount = container.querySelectorAll('.n88-video-link-input').length;
                
                if (linkCount >= 3) {
                    alert('Maximum 3 video links allowed.');
                    return;
                }
                
                var newLinkDiv = document.createElement('div');
                newLinkDiv.style.cssText = 'margin-bottom: 8px; display: flex; gap: 8px;';
                newLinkDiv.innerHTML = '<input type="url" name="video_links[]" class="n88-video-link-input" placeholder="https://youtube.com/watch?v=..." style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" onblur="validateVideoLink(this);" />' +
                    '<button type="button" onclick="removeVideoLink(this)" style="padding: 10px 16px; background-color: #dc3545; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Remove</button>';
                
                container.appendChild(newLinkDiv);
                
                // Show remove buttons if more than 1 link
                updateVideoLinkButtons();
                validateBidForm();
            }
            
            // Remove video link input
            function removeVideoLink(button) {
                var container = document.getElementById('n88-video-links-container');
                var linkDiv = button.parentElement;
                container.removeChild(linkDiv);
                updateVideoLinkButtons();
                validateBidForm();
            }
            
            // Update video link remove buttons visibility
            function updateVideoLinkButtons() {
                var container = document.getElementById('n88-video-links-container');
                var links = container.querySelectorAll('.n88-video-link-input');
                var removeButtons = container.querySelectorAll('button[onclick*="removeVideoLink"]');
                
                if (links.length > 1) {
                    removeButtons.forEach(function(btn) { btn.style.display = 'block'; });
                } else {
                    removeButtons.forEach(function(btn) { btn.style.display = 'none'; });
                }
                
                // Show/hide add button
                var addBtn = document.getElementById('n88-add-video-link-btn');
                if (addBtn) {
                    addBtn.style.display = links.length >= 3 ? 'none' : 'block';
                }
            }
            
            // Validate individual video link
            function validateVideoLink(input) {
                var url = input.value.trim();
                var errorDiv = document.getElementById('n88-video-links-error');
                
                if (!url) {
                    input.style.borderColor = '#ddd';
                    return true; // Empty is OK if not the only link
                }
                
                // Allowed providers: YouTube, Vimeo, Loom
                var allowedDomains = [
                    'youtube.com', 'youtu.be', 'www.youtube.com',
                    'vimeo.com', 'www.vimeo.com',
                    'loom.com', 'www.loom.com'
                ];
                
                var urlObj;
                try {
                    urlObj = new URL(url);
                } catch (e) {
                    input.style.borderColor = '#d32f2f';
                    if (errorDiv) {
                        errorDiv.textContent = 'Invalid URL format.';
                        errorDiv.style.display = 'block';
                    }
                    return false;
                }
                
                var hostname = urlObj.hostname.toLowerCase().replace('www.', '');
                var isValid = allowedDomains.some(function(domain) {
                    return hostname === domain || hostname.endsWith('.' + domain);
                });
                
                if (!isValid) {
                    input.style.borderColor = '#d32f2f';
                    if (errorDiv) {
                        errorDiv.textContent = 'Only YouTube, Vimeo, or Loom links are allowed.';
                        errorDiv.style.display = 'block';
                    }
                    return false;
                }
                
                input.style.borderColor = '#28a745';
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
                // Don't call validateBidForm() here to avoid infinite recursion
                // Validation will be triggered by oninput/onchange events
                return true;
            }
            
            // Commit 2.3.5.1: Handle bid photos change - UPLOAD TO WORDPRESS MEDIA
            // This function is already defined above, but keeping this comment for reference
            
            // Validate entire bid form (client-side) - works with both modal and embedded forms
            function validateBidForm() {
                var form = document.getElementById('n88-bid-form');
                var isEmbedded = false;
                var itemId = null;
                
                // Check if it's an embedded form
                if (!form) {
                    var embeddedForms = document.querySelectorAll('[id^="n88-bid-form-embedded-"]');
                    if (embeddedForms.length > 0) {
                        form = embeddedForms[0];
                        isEmbedded = true;
                        var formId = form.id;
                        itemId = formId.replace('n88-bid-form-embedded-', '');
                    }
                }
                
                if (!form) return false;
                
                var isValid = true;
                // Commit 2.3.5.5: Get the correct button - Validate button for enabling/disabling, Submit button for after validation
                var validateBtn = isEmbedded ? 
                    document.getElementById('n88-validate-bid-btn-embedded-' + itemId) : 
                    document.getElementById('n88-validate-bid-btn');
                var submitBtn = isEmbedded ? 
                    document.getElementById('n88-submit-bid-btn-embedded-' + itemId) : 
                    document.getElementById('n88-submit-bid-btn');
                
                // 1. Video links: optional, max 3, all valid (Commit 2.3.5.1: Remove mandatory requirement)
                var videoLinks = form.querySelectorAll('.n88-video-link-input');
                var validVideoLinks = 0;
                var allowedDomains = [
                    'youtube.com', 'youtu.be', 'www.youtube.com',
                    'vimeo.com', 'www.vimeo.com',
                    'loom.com', 'www.loom.com'
                ];
                
                videoLinks.forEach(function(input) {
                    var url = input.value.trim();
                    if (url) {
                        // Validate URL format and domain
                        try {
                            var urlObj = new URL(url);
                            var hostname = urlObj.hostname.toLowerCase().replace('www.', '');
                            var isAllowed = allowedDomains.some(function(domain) {
                                var domainClean = domain.replace('www.', '');
                                return hostname === domainClean || hostname.endsWith('.' + domainClean);
                            });
                            if (isAllowed) {
                                validVideoLinks++;
                            }
                        } catch (e) {
                            // Invalid URL format - don't count
                        }
                    }
                });
                
                // Video links are optional now, but if provided, max 3
                if (validVideoLinks > 3) {
                    isValid = false;
                }
                
                // 1.5. Bid Photos: required, min 1, max 5 (Commit 2.3.5.1) - check uploaded photo IDs
                // Check in form first, then fallback to preview container, then check thumbnails
                var photoIdInputs = [];
                if (form) {
                    var formInputs = form.querySelectorAll('input[name="bid_photo_ids[]"]');
                    photoIdInputs = Array.from(formInputs);
                }
                
                // Also check preview container as fallback
                var previewContainer = isEmbedded ? 
                    document.getElementById('n88-bid-photos-preview-embedded-' + itemId) : 
                    document.getElementById('n88-bid-photos-preview');
                if (previewContainer) {
                    var previewInputs = previewContainer.querySelectorAll('input[name="bid_photo_ids[]"]');
                    Array.from(previewInputs).forEach(function(input) {
                        // Only add if not already in array
                        var alreadyExists = photoIdInputs.some(function(existing) {
                            return existing === input || existing.value === input.value;
                        });
                        if (!alreadyExists) {
                            photoIdInputs.push(input);
                        }
                    });
                }
                
                // Also count thumbnails as a last resort (if inputs somehow not found)
                var bidPhotosCount = 0;
                if (photoIdInputs.length > 0) {
                    photoIdInputs.forEach(function(input) {
                        var photoId = parseInt(input.value);
                        if (!isNaN(photoId) && photoId > 0) {
                            bidPhotosCount++;
                        }
                    });
                } else {
                    // Fallback: count thumbnails in preview container
                    if (previewContainer) {
                        var thumbnails = previewContainer.querySelectorAll('div[data-photo-id]');
                        bidPhotosCount = thumbnails.length;
                    }
                }
                
                var photosError = isEmbedded ? 
                    document.getElementById('n88-bid-photos-error-embedded-' + itemId) : 
                    document.getElementById('n88-bid-photos-error');
                var previewContainer = isEmbedded ? 
                    document.getElementById('n88-bid-photos-preview-embedded-' + itemId) : 
                    document.getElementById('n88-bid-photos-preview');
                
                console.log('Photo validation - Inputs found:', photoIdInputs.length, 'Photos counted:', bidPhotosCount, 'Form:', !!form, 'Preview container:', !!previewContainer);
                
                if (bidPhotosCount < 1) {
                    isValid = false;
                    if (photosError) {
                        photosError.textContent = 'At least 1 photo is required.';
                        photosError.style.display = 'block';
                    }
                    console.log('âœ— Photo validation FAILED - Need at least 1 photo');
                } else if (bidPhotosCount > 5) {
                    isValid = false;
                    if (photosError) {
                        photosError.textContent = 'Maximum 5 photos allowed.';
                        photosError.style.display = 'block';
                    }
                    console.log('âœ— Photo validation FAILED - Maximum 5 photos allowed');
                } else {
                    if (photosError) {
                        photosError.style.display = 'none';
                    }
                    console.log('âœ“ Photo validation PASSED -', bidPhotosCount, 'photo(s)');
                }
                
                // 2. Prototype video (optional - YES or NO)
                var prototypeYes = form.querySelector('input[name="prototype_video_yes"][value="1"]');
                var prototypeNo = form.querySelector('input[name="prototype_video_yes"][value="0"]');
                var isPrototypeYes = prototypeYes && prototypeYes.checked;
                var isPrototypeNo = prototypeNo && prototypeNo.checked;
                
                // Clear any previous error
                var prototypeError = isEmbedded ? 
                    document.getElementById('n88-prototype-video-error-embedded-' + itemId) : 
                    document.getElementById('n88-prototype-video-error');
                if (prototypeError) {
                    prototypeError.style.display = 'none';
                }
                
                // 3. Prototype timeline required ONLY if prototype is YES
                var timeline = form.querySelector('select[name="prototype_timeline_option"]');
                if (isPrototypeYes) {
                    if (!timeline || !timeline.value) {
                        isValid = false;
                        var timelineError = isEmbedded ? 
                            document.getElementById('n88-prototype-timeline-error-embedded-' + itemId) : 
                            document.getElementById('n88-prototype-timeline-error');
                        if (timelineError) {
                            timelineError.textContent = 'Prototype timeline is required.';
                            timelineError.style.display = 'block';
                        }
                    } else {
                        var timelineError = isEmbedded ? 
                            document.getElementById('n88-prototype-timeline-error-embedded-' + itemId) : 
                            document.getElementById('n88-prototype-timeline-error');
                        if (timelineError) {
                            timelineError.style.display = 'none';
                        }
                    }
                } else {
                    // Clear timeline error if prototype is NO
                    var timelineError = isEmbedded ? 
                        document.getElementById('n88-prototype-timeline-error-embedded-' + itemId) : 
                        document.getElementById('n88-prototype-timeline-error');
                    if (timelineError) {
                        timelineError.style.display = 'none';
                    }
                }
                
                // 4. Prototype cost required ONLY if prototype is YES
                var prototypeCost = form.querySelector('input[name="prototype_cost"]');
                if (isPrototypeYes) {
                    if (prototypeCost && prototypeCost.value) {
                        var costValue = parseFloat(prototypeCost.value);
                        if (isNaN(costValue) || costValue < 0) {
                            isValid = false;
                            var costError = isEmbedded ? 
                                document.getElementById('n88-prototype-cost-error-embedded-' + itemId) : 
                                document.getElementById('n88-prototype-cost-error');
                            if (costError) {
                                costError.textContent = 'Prototype cost must be a valid number >= 0.';
                                costError.style.display = 'block';
                            }
                        } else {
                            var costError = isEmbedded ? 
                                document.getElementById('n88-prototype-cost-error-embedded-' + itemId) : 
                                document.getElementById('n88-prototype-cost-error');
                            if (costError) {
                                costError.style.display = 'none';
                            }
                        }
                    } else {
                        isValid = false;
                        var costError = isEmbedded ? 
                            document.getElementById('n88-prototype-cost-error-embedded-' + itemId) : 
                            document.getElementById('n88-prototype-cost-error');
                        if (costError) {
                            costError.textContent = 'Prototype cost is required.';
                            costError.style.display = 'block';
                        }
                    }
                } else {
                    // Clear cost error if prototype is NO
                    var costError = isEmbedded ? 
                        document.getElementById('n88-prototype-cost-error-embedded-' + itemId) : 
                        document.getElementById('n88-prototype-cost-error');
                    if (costError) {
                        costError.style.display = 'none';
                    }
                }
                
                // 5. Production lead time: non-empty
                var leadTime = form.querySelector('select[name="production_lead_time_text"]');
                if (!leadTime || !leadTime.value || !leadTime.value.trim()) {
                    isValid = false;
                    var leadTimeError = isEmbedded ? 
                        document.getElementById('n88-lead-time-error-embedded-' + itemId) : 
                        document.getElementById('n88-lead-time-error');
                    if (leadTimeError) {
                        leadTimeError.textContent = 'Production lead time is required.';
                        leadTimeError.style.display = 'block';
                    }
                } else {
                    var leadTimeError = isEmbedded ? 
                        document.getElementById('n88-lead-time-error-embedded-' + itemId) : 
                        document.getElementById('n88-lead-time-error');
                    if (leadTimeError) {
                        leadTimeError.style.display = 'none';
                    }
                }
                
                // 6. Unit price: numeric > 0
                var unitPrice = form.querySelector('input[name="unit_price"]');
                if (unitPrice && unitPrice.value) {
                    var priceValue = parseFloat(unitPrice.value);
                    if (isNaN(priceValue) || priceValue <= 0) {
                        isValid = false;
                        var priceError = isEmbedded ? 
                            document.getElementById('n88-unit-price-error-embedded-' + itemId) : 
                            document.getElementById('n88-unit-price-error');
                        if (priceError) {
                            priceError.textContent = 'Unit price must be a valid number > 0.';
                            priceError.style.display = 'block';
                        }
                    } else {
                        var priceError = isEmbedded ? 
                            document.getElementById('n88-unit-price-error-embedded-' + itemId) : 
                            document.getElementById('n88-unit-price-error');
                        if (priceError) {
                            priceError.style.display = 'none';
                        }
                    }
                } else {
                    isValid = false;
                    var priceError = isEmbedded ? 
                        document.getElementById('n88-unit-price-error-embedded-' + itemId) : 
                        document.getElementById('n88-unit-price-error');
                    if (priceError) {
                        priceError.textContent = 'Unit price is required.';
                        priceError.style.display = 'block';
                    }
                }
                
                // Commit 2.3.5.5: Enable/disable Validate button based on form validity
                if (validateBtn) {
                    if (isValid) {
                        validateBtn.disabled = false;
                        validateBtn.style.opacity = '1';
                        validateBtn.style.cursor = 'pointer';
                    } else {
                        validateBtn.disabled = true;
                        validateBtn.style.opacity = '0.5';
                        validateBtn.style.cursor = 'not-allowed';
                    }
                }
                
                // Debug: Log validation status (remove in production)
                if (window.console && window.console.log) {
                    console.log('Bid form validation:', {
                        validVideoLinks: validVideoLinks,
                        prototypeYes: prototypeYes ? prototypeYes.checked : false,
                        timeline: timeline ? timeline.value : '',
                        prototypeCost: prototypeCost ? prototypeCost.value : '',
                        leadTime: leadTime ? leadTime.value : '',
                        unitPrice: unitPrice ? unitPrice.value : '',
                        isValid: isValid
                    });
                }
                
                return isValid;
            }
            
            // Validate and submit bid (server-side validation)
            function validateAndSubmitBid(event) {
                if (event) {
                    event.preventDefault();
                }
                
                var form = document.getElementById('n88-bid-form');
                if (!form) return false;
                
                // Client-side validation
                if (!validateBidForm()) {
                    alert('Please complete all required fields correctly.');
                    return false;
                }
                
                var modal = document.getElementById('n88-supplier-bid-form-modal');
                var itemId = modal ? modal.getAttribute('data-item-id') : null;
                
                if (!itemId) {
                    alert('Item ID not found.');
                    return false;
                }
                
                // Collect form data
                var formData = new FormData();
                formData.append('action', 'n88_validate_supplier_bid');
                formData.append('item_id', itemId);
                
                // Video links
                var videoLinks = form.querySelectorAll('.n88-video-link-input');
                var videoLinksArray = [];
                videoLinks.forEach(function(input) {
                    var url = input.value.trim();
                    if (url) {
                        videoLinksArray.push(url);
                    }
                });
                formData.append('video_links', JSON.stringify(videoLinksArray));
                
                // Commit 2.3.5.1: Bid photos (required) - use uploaded photo IDs
                var bidPhotoIds = [];
                var photoIdInputs = form.querySelectorAll('input[name="bid_photo_ids[]"]');
                photoIdInputs.forEach(function(input) {
                    var photoId = parseInt(input.value);
                    if (!isNaN(photoId) && photoId > 0) {
                        bidPhotoIds.push(photoId);
                    }
                });
                formData.append('bid_photo_ids', JSON.stringify(bidPhotoIds));
                
                // Other fields
                formData.append('prototype_video_yes', form.querySelector('input[name="prototype_video_yes"]:checked') ? form.querySelector('input[name="prototype_video_yes"]:checked').value : '');
                formData.append('prototype_timeline_option', form.querySelector('select[name="prototype_timeline_option"]').value);
                formData.append('prototype_cost', form.querySelector('input[name="prototype_cost"]').value);
                formData.append('production_lead_time_text', form.querySelector('select[name="production_lead_time_text"]').value);
                formData.append('unit_price', form.querySelector('input[name="unit_price"]').value);
                
                // Smart Alternatives suggestion (if enabled and ANY field is filled)
                var smartAltCategory = form.querySelector('select[name="smart_alt_category"]');
                var smartAltFrom = form.querySelector('select[name="smart_alt_from"]');
                var smartAltTo = form.querySelector('select[name="smart_alt_to"]');
                var smartAltPrice = form.querySelector('select[name="smart_alt_price_impact"]');
                var smartAltLeadTime = form.querySelector('select[name="smart_alt_lead_time_impact"]');
                var smartAltComparisons = form.querySelectorAll('input[name="smart_alt_comparison[]"]:checked');
                
                // Check if ANY Smart Alternatives field has a value
                var hasCategory = smartAltCategory && smartAltCategory.value;
                var hasFrom = smartAltFrom && smartAltFrom.value;
                var hasTo = smartAltTo && smartAltTo.value;
                var hasPrice = smartAltPrice && smartAltPrice.value;
                var hasLeadTime = smartAltLeadTime && smartAltLeadTime.value;
                var hasComparisons = smartAltComparisons && smartAltComparisons.length > 0;
                
                if (hasCategory || hasFrom || hasTo || hasPrice || hasLeadTime || hasComparisons) {
                    var smartAltData = {
                        category: hasCategory ? smartAltCategory.value : '',
                        from: hasFrom ? smartAltFrom.value : '',
                        to: hasTo ? smartAltTo.value : '',
                        comparison_points: hasComparisons ? Array.from(smartAltComparisons).map(function(cb) { return cb.value; }) : [],
                        price_impact: hasPrice ? smartAltPrice.value : '',
                        lead_time_impact: hasLeadTime ? smartAltLeadTime.value : ''
                    };
                    formData.append('smart_alternatives_suggestion', JSON.stringify(smartAltData));
                }
                
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_validate_supplier_bid' ); ?>');
                
                // Disable submit button during validation
                var submitBtn = document.getElementById('n88-validate-bid-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Validating...';
                }
                
                // Submit to server for validation
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Validate Bid';
                    }
                    
                    if (!data.success) {
                        // Show validation errors
                        if (data.data && data.data.errors) {
                            var errorHtml = '<div class="n88-validation-errors" style="padding: 12px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; margin-bottom: 20px;">' +
                                '<strong style="color: #d32f2f;">Validation Errors:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">';
                            for (var field in data.data.errors) {
                                errorHtml += '<li style="color: #d32f2f; margin: 4px 0;">' + data.data.errors[field] + '</li>';
                            }
                            errorHtml += '</ul></div>';
                            
                            var form = document.getElementById('n88-bid-form');
                            if (form) {
                                var existingError = form.querySelector('.n88-validation-errors');
                                if (existingError) {
                                    existingError.remove();
                                }
                                form.insertAdjacentHTML('afterbegin', errorHtml);
                                
                                // Scroll to top
                                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        } else {
                            alert(data.data && data.data.message ? data.data.message : 'Validation failed. Please check your inputs.');
                        }
                    } else {
                        // Validation passed - show Submit Bid button (Commit 2.3.5)
                        var validateBtn = document.getElementById('n88-validate-bid-btn');
                        var submitBtn = document.getElementById('n88-submit-bid-btn');
                        
                        if (validateBtn && submitBtn) {
                            validateBtn.style.display = 'none';
                            submitBtn.style.display = 'inline-block';
                            submitBtn.disabled = false;
                        }
                        
                        // Show success message
                        var form = document.getElementById('n88-bid-form');
                        if (form) {
                            var existingError = form.querySelector('.n88-validation-errors');
                            if (existingError) {
                                existingError.remove();
                            }
                            var successHtml = '<div class="n88-validation-errors" style="padding: 12px; background-color: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; margin-bottom: 20px; color: #2e7d32;">' +
                                '<strong>âœ“ Validation successful!</strong> Click "Submit Proposal" to save your bid.' +
                                '</div>';
                            form.insertAdjacentHTML('afterbegin', successHtml);
                            
                            // Scroll to top
                            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                })
                .catch(function(error) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Validate Bid';
                    }
                    alert('Error validating bid. Please try again.');
                    console.error('Validation error:', error);
                });
                
                return false;
            }
            
            // Commit 2.3.5: Submit bid function
            function submitBid(e) {
                e.preventDefault();
                
                var form = document.getElementById('n88-bid-form');
                if (!form) return false;
                
                var modal = document.getElementById('n88-supplier-bid-form-modal');
                var itemId = modal ? modal.getAttribute('data-item-id') : null;
                
                if (!itemId) {
                    alert('Item ID not found.');
                    return false;
                }
                
                // Collect form data (same as validation)
                var formData = new FormData();
                formData.append('action', 'n88_submit_supplier_bid');
                formData.append('item_id', itemId);
                
                // Video links
                var videoLinks = form.querySelectorAll('.n88-video-link-input');
                var videoLinksArray = [];
                videoLinks.forEach(function(input) {
                    var url = input.value.trim();
                    if (url) {
                        videoLinksArray.push(url);
                    }
                });
                formData.append('video_links', JSON.stringify(videoLinksArray));
                
                // Commit 2.3.5.1: Bid photos (required) - use uploaded photo IDs
                var bidPhotoIds = [];
                var photoIdInputs = form.querySelectorAll('input[name="bid_photo_ids[]"]');
                photoIdInputs.forEach(function(input) {
                    var photoId = parseInt(input.value);
                    if (!isNaN(photoId) && photoId > 0) {
                        bidPhotoIds.push(photoId);
                    }
                });
                formData.append('bid_photo_ids', JSON.stringify(bidPhotoIds));
                
                // Other fields
                formData.append('prototype_video_yes', form.querySelector('input[name="prototype_video_yes"]:checked') ? form.querySelector('input[name="prototype_video_yes"]:checked').value : '');
                formData.append('prototype_timeline_option', form.querySelector('select[name="prototype_timeline_option"]').value);
                formData.append('prototype_cost', form.querySelector('input[name="prototype_cost"]').value);
                formData.append('production_lead_time_text', form.querySelector('select[name="production_lead_time_text"]').value);
                formData.append('unit_price', form.querySelector('input[name="unit_price"]').value);
                
                // Smart Alternatives suggestion (if enabled and ANY field is filled)
                var smartAltCategory = form.querySelector('select[name="smart_alt_category"]');
                var smartAltFrom = form.querySelector('select[name="smart_alt_from"]');
                var smartAltTo = form.querySelector('select[name="smart_alt_to"]');
                var smartAltPrice = form.querySelector('select[name="smart_alt_price_impact"]');
                var smartAltLeadTime = form.querySelector('select[name="smart_alt_lead_time_impact"]');
                var smartAltComparisons = form.querySelectorAll('input[name="smart_alt_comparison[]"]:checked');
                
                // Check if ANY Smart Alternatives field has a value
                var hasCategory = smartAltCategory && smartAltCategory.value;
                var hasFrom = smartAltFrom && smartAltFrom.value;
                var hasTo = smartAltTo && smartAltTo.value;
                var hasPrice = smartAltPrice && smartAltPrice.value;
                var hasLeadTime = smartAltLeadTime && smartAltLeadTime.value;
                var hasComparisons = smartAltComparisons && smartAltComparisons.length > 0;
                
                if (hasCategory || hasFrom || hasTo || hasPrice || hasLeadTime || hasComparisons) {
                    var smartAltData = {
                        category: hasCategory ? smartAltCategory.value : '',
                        from: hasFrom ? smartAltFrom.value : '',
                        to: hasTo ? smartAltTo.value : '',
                        comparison_points: hasComparisons ? Array.from(smartAltComparisons).map(function(cb) { return cb.value; }) : [],
                        price_impact: hasPrice ? smartAltPrice.value : '',
                        lead_time_impact: hasLeadTime ? smartAltLeadTime.value : ''
                    };
                    formData.append('smart_alternatives_suggestion', JSON.stringify(smartAltData));
                }
                
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_submit_supplier_bid' ); ?>');
                
                // Disable submit button
                var submitBtn = document.getElementById('n88-submit-bid-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                }
                
                // Submit to server
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Proposal';
                    }
                    
                    if (!data.success) {
                        // Show errors
                        if (data.data && data.data.errors) {
                            var errorHtml = '<div style="padding: 12px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; margin-bottom: 20px;">' +
                                '<strong style="color: #d32f2f;">Submission Errors:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">';
                            for (var field in data.data.errors) {
                                errorHtml += '<li style="color: #d32f2f; margin: 4px 0;">' + data.data.errors[field] + '</li>';
                            }
                            errorHtml += '</ul></div>';
                            
                            var form = document.getElementById('n88-bid-form');
                            if (form) {
                                var existingError = form.querySelector('.n88-validation-errors');
                                if (existingError) {
                                    existingError.remove();
                                }
                                // Add class directly to HTML string
                                errorHtml = errorHtml.replace('<div style="', '<div class="n88-validation-errors" style="');
                                form.insertAdjacentHTML('afterbegin', errorHtml);
                                
                                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        } else {
                            alert(data.data && data.data.message ? data.data.message : 'Failed to submit bid. Please try again.');
                        }
                    } else {
                        // Success - close bid form modal and open item modal on Proposal tab (no reload)
                        alert(data.data && data.data.message || 'Bid submitted successfully!');
                        closeBidFormModal();
                        if (itemId && typeof openBidModal === 'function') {
                            openBidModal(itemId, 'bid');
                        } else if (window.location.href.indexOf('queue') > -1) {
                            window.location.reload();
                        }
                    }
                })
                .catch(function(error) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Proposal';
                    }
                    alert('Error submitting bid. Please try again.');
                    console.error('Submission error:', error);
                });
                
                return false;
            }
            
            // Embedded form helper functions
            function addVideoLinkEmbedded(itemId) {
                var container = document.getElementById('n88-video-links-container-embedded-' + itemId);
                if (!container) return;
                
                var linkCount = container.querySelectorAll('.n88-video-link-input').length;
                
                if (linkCount >= 3) {
                    alert('Maximum 3 video links allowed.');
                    return;
                }
                
                var newLinkDiv = document.createElement('div');
                newLinkDiv.style.cssText = 'margin-bottom: 8px; display: flex; gap: 8px; align-items: center;';
                newLinkDiv.innerHTML = '<input type="url" name="video_links[]" class="n88-video-link-input-embedded" placeholder="https://youtube.com/watch?v=..." style="flex: 1; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; font-family: monospace;" onblur="validateVideoLinkEmbedded(this, ' + itemId + ');" oninput="validateBidFormEmbedded(' + itemId + ');" />' +
                    '<button type="button" onclick="removeVideoLinkEmbedded(this, ' + itemId + ')" style="padding: 8px 12px; background-color: #dc3545; color: #fff; border: none; border-radius: 2px; cursor: pointer; font-family: monospace; font-size: 11px;">Remove</button>';
                
                container.appendChild(newLinkDiv);
                updateVideoLinkButtonsEmbedded(itemId);
                validateBidFormEmbedded(itemId);
            }
            
            function handleBidPhotosChangeEmbedded(input, itemId) {
                var files = input.files;
                if (!files || files.length === 0) {
                    return;
                }
                
                // Validate file count (max 5)
                if (files.length > 5) {
                    alert('Maximum 5 photos allowed. Please select up to 5 photos.');
                    input.value = '';
                    return;
                }
                
                // Validate file types - support HEIC images
                var imageFiles = Array.from(files).filter(function(file) {
                    var fileName = file.name.toLowerCase();
                    return file.type.startsWith('image/') || 
                           fileName.endsWith('.heic') || 
                           fileName.endsWith('.heif');
                });
                
                if (imageFiles.length !== files.length) {
                    alert('Please select image files only.');
                    input.value = '';
                    return;
                }
                
                var previewContainer = document.getElementById('n88-bid-photos-preview-embedded-' + itemId);
                var errorDiv = document.getElementById('n88-bid-photos-error-embedded-' + itemId);
                
                if (!previewContainer) {
                    console.error('Bid photos preview container not found');
                    return;
                }
                
                // Clear previous previews
                previewContainer.innerHTML = '';
                
                // Get nonce for AJAX
                var nonce = '<?php echo wp_create_nonce( 'n88_upload_inspiration_image' ); ?>';
                var ajaxUrl = '<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>';
                
                // Upload each file
                var uploadPromises = imageFiles.map(function(file, index) {
                    return new Promise(function(resolve, reject) {
                        var formData = new FormData();
                        formData.append('action', 'n88_upload_inspiration_image');
                        formData.append('inspiration_image', file);
                        formData.append('nonce', nonce);
                        
                        // Show loading placeholder
                        var placeholderId = 'n88-bid-photo-placeholder-embedded-' + itemId + '-' + index;
                        var placeholder = document.createElement('div');
                        placeholder.id = placeholderId;
                        placeholder.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px dashed #00ff00; border-radius: 4px; display: flex; align-items: center; justify-content: center; background-color: #1a1a1a;';
                        placeholder.innerHTML = '<div style="font-size: 11px; color: #00ff00; font-family: monospace;">Uploading...</div>';
                        previewContainer.appendChild(placeholder);
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        })
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('HTTP error! status: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            // Remove placeholder
                            var placeholderEl = document.getElementById(placeholderId);
                            if (placeholderEl) {
                                placeholderEl.remove();
                            }
                            
                            if (!data) {
                                throw new Error('No response data received');
                            }
                            
                            if (data.success && data.data && data.data.id && data.data.url) {
                                // Create thumbnail
                                var thumbDiv = document.createElement('div');
                                thumbDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px solid #00ff00; border-radius: 4px; overflow: hidden;';
                                thumbDiv.innerHTML = '<img src="' + data.data.url.replace(/"/g, '&quot;') + '" style="width: 100%; height: 100%; object-fit: cover;" alt="Bid photo" />' +
                                    '<button type="button" onclick="removeBidPhotoEmbedded(this, ' + data.data.id + ', ' + itemId + ');" style="position: absolute; top: 4px; right: 4px; background: rgba(220, 53, 69, 0.9); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;" title="Remove">Ã—</button>';
                                
                                // Add hidden input INSIDE THE FORM
                                var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                                if (form) {
                                    var hiddenInput = document.createElement('input');
                                    hiddenInput.type = 'hidden';
                                    hiddenInput.name = 'bid_photo_ids[]';
                                    hiddenInput.value = data.data.id;
                                    hiddenInput.setAttribute('data-photo-id', data.data.id);
                                    form.appendChild(hiddenInput);
                                    console.log('âœ“ Added hidden input to embedded form - Photo ID:', data.data.id);
                                } else {
                                    console.error('âœ— Embedded form #n88-bid-form-embedded-' + itemId + ' not found when adding photo!');
                                }
                                
                                // Store reference in thumbDiv for easy removal
                                thumbDiv.setAttribute('data-photo-id', data.data.id);
                                previewContainer.appendChild(thumbDiv);
                                
                                resolve({ id: data.data.id, url: data.data.url });
                            } else {
                                var errorMsg = data.data && data.data.message ? data.data.message : 'Upload failed';
                                throw new Error(errorMsg);
                            }
                        })
                        .catch(function(error) {
                            // Remove placeholder
                            var placeholderEl = document.getElementById(placeholderId);
                            if (placeholderEl) {
                                placeholderEl.remove();
                            }
                            
                            console.error('Error uploading photo:', error);
                            if (errorDiv) {
                                errorDiv.textContent = 'Failed to upload ' + file.name + ': ' + error.message;
                                errorDiv.style.display = 'block';
                            }
                            reject(error);
                        });
                    });
                });
                
                // Clear error on success
                Promise.all(uploadPromises).then(function(results) {
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                    
                    // Force validation after a delay to ensure DOM is fully updated
                    setTimeout(function() {
                        if (typeof validateBidFormEmbedded === 'function') {
                            validateBidFormEmbedded(itemId);
                        }
                    }, 300);
                }).catch(function() {
                    // Errors already handled above
                });
            }
            
            function removeBidPhotoEmbedded(button, photoId, itemId) {
                var thumbDiv = button.parentElement;
                var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                
                if (form) {
                    var hiddenInput = form.querySelector('input[name="bid_photo_ids[]"][value="' + photoId + '"]');
                    if (hiddenInput) {
                        hiddenInput.remove();
                    }
                }
                
                thumbDiv.remove();
                
                var previewContainer = document.getElementById('n88-bid-photos-preview-embedded-' + itemId);
                var remainingPhotos = previewContainer ? previewContainer.querySelectorAll('div[data-photo-id]').length : 0;
                if (remainingPhotos === 0) {
                    var input = document.getElementById('n88-bid-photos-input-embedded-' + itemId);
                    if (input) {
                        input.value = '';
                    }
                }
                
                validateBidFormEmbedded(itemId);
            }
            
            // Validate embedded bid form
            function validateBidFormEmbedded(itemId) {
                var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                if (!form) return false;
                
                var isValid = true;
                var validateBtn = document.getElementById('n88-validate-bid-btn-embedded-' + itemId);
                
                // 1. Video links: optional, max 3
                var videoLinks = form.querySelectorAll('.n88-video-link-input-embedded');
                var validVideoLinks = 0;
                var allowedDomains = [
                    'youtube.com', 'youtu.be', 'www.youtube.com',
                    'vimeo.com', 'www.vimeo.com',
                    'loom.com', 'www.loom.com'
                ];
                
                videoLinks.forEach(function(input) {
                    var url = input.value.trim();
                    if (url) {
                        try {
                            var urlObj = new URL(url);
                            var hostname = urlObj.hostname.toLowerCase().replace('www.', '');
                            var isAllowed = allowedDomains.some(function(domain) {
                                var domainClean = domain.replace('www.', '');
                                return hostname === domainClean || hostname.endsWith('.' + domainClean);
                            });
                            if (isAllowed) {
                                validVideoLinks++;
                            }
                        } catch (e) {
                            // Invalid URL format
                        }
                    }
                });
                
                if (validVideoLinks > 3) {
                    isValid = false;
                }
                
                // 1.5. Bid Photos: required, min 1, max 5
                var photoIdInputs = form.querySelectorAll('input[name="bid_photo_ids[]"]');
                var bidPhotosCount = 0;
                photoIdInputs.forEach(function(input) {
                    var photoId = parseInt(input.value);
                    if (!isNaN(photoId) && photoId > 0) {
                        bidPhotosCount++;
                    }
                });
                
                var photosError = document.getElementById('n88-bid-photos-error-embedded-' + itemId);
                if (bidPhotosCount < 1) {
                    isValid = false;
                    if (photosError) {
                        photosError.textContent = 'At least 1 photo is required.';
                        photosError.style.display = 'block';
                    }
                } else if (bidPhotosCount > 5) {
                    isValid = false;
                    if (photosError) {
                        photosError.textContent = 'Maximum 5 photos allowed.';
                        photosError.style.display = 'block';
                    }
                } else {
                    if (photosError) {
                        photosError.style.display = 'none';
                    }
                }
                
                // 2. Prototype video (optional - YES or NO)
                var prototypeYes = form.querySelector('input[name="prototype_video_yes"][value="1"]');
                var isPrototypeYes = prototypeYes && prototypeYes.checked;
                
                // 3. Prototype timeline required ONLY if prototype is YES
                var timeline = form.querySelector('select[name="prototype_timeline_option"]');
                if (isPrototypeYes && (!timeline || !timeline.value)) {
                    isValid = false;
                }
                
                // 4. Prototype cost required ONLY if prototype is YES
                var prototypeCost = form.querySelector('input[name="prototype_cost"]');
                if (isPrototypeYes) {
                    if (prototypeCost && prototypeCost.value) {
                        var costValue = parseFloat(prototypeCost.value);
                        if (isNaN(costValue) || costValue < 0) {
                            isValid = false;
                        }
                    } else {
                        isValid = false;
                    }
                }
                
                // 5. Production lead time: non-empty
                var leadTime = form.querySelector('select[name="production_lead_time_text"]');
                if (!leadTime || !leadTime.value || !leadTime.value.trim()) {
                    isValid = false;
                }
                
                // 6. Unit price: numeric > 0
                var unitPrice = form.querySelector('input[name="unit_price"]');
                if (unitPrice && unitPrice.value) {
                    var priceValue = parseFloat(unitPrice.value);
                    if (isNaN(priceValue) || priceValue <= 0) {
                        isValid = false;
                    }
                } else {
                    isValid = false;
                }
                
                // Enable/disable validate button
                if (validateBtn) {
                    if (isValid) {
                        validateBtn.disabled = false;
                        validateBtn.style.opacity = '1';
                        validateBtn.style.cursor = 'pointer';
                    } else {
                        validateBtn.disabled = true;
                        validateBtn.style.opacity = '0.5';
                        validateBtn.style.cursor = 'not-allowed';
                    }
                }
                
                return isValid;
            }
            
            // Add video link for embedded form
            function addVideoLinkEmbedded(itemId) {
                var container = document.getElementById('n88-video-links-container-embedded-' + itemId);
                if (!container) return;
                
                var linkCount = container.querySelectorAll('.n88-video-link-input-embedded').length;
                
                if (linkCount >= 3) {
                    alert('Maximum 3 video links allowed.');
                    return;
                }
                
                var newLinkDiv = document.createElement('div');
                newLinkDiv.style.cssText = 'margin-bottom: 8px; display: flex; gap: 8px; align-items: center;';
                var linkNum = linkCount + 1;
                newLinkDiv.innerHTML = '<span style="color: #00ff00; font-family: monospace; font-size: 12px;">' + linkNum + ')</span>' +
                    '<input type="url" name="video_links[]" class="n88-video-link-input-embedded" placeholder="https://youtube.com/watch?v=..." style="flex: 1; padding: 8px 12px; border: none; border-radius: 2px; font-size: 12px; background-color: #1a1a1a; color: #fff; font-family: monospace;" onblur="validateVideoLinkEmbedded(this, ' + itemId + ');" oninput="validateBidFormEmbedded(' + itemId + ');" />' +
                    '<button type="button" onclick="removeVideoLinkEmbedded(this, ' + itemId + ')" style="padding: 8px 12px; background-color: #dc3545; color: #fff; border: none; border-radius: 2px; cursor: pointer; font-family: monospace; font-size: 11px;">Remove</button>';
                
                container.appendChild(newLinkDiv);
                updateVideoLinkButtonsEmbedded(itemId);
                validateBidFormEmbedded(itemId);
            }
            
            // Remove video link for embedded form
            function removeVideoLinkEmbedded(button, itemId) {
                var container = document.getElementById('n88-video-links-container-embedded-' + itemId);
                if (!container) return;
                
                var linkDiv = button.parentElement;
                container.removeChild(linkDiv);
                updateVideoLinkButtonsEmbedded(itemId);
                validateBidFormEmbedded(itemId);
            }
            
            // Update video link buttons for embedded form
            function updateVideoLinkButtonsEmbedded(itemId) {
                var container = document.getElementById('n88-video-links-container-embedded-' + itemId);
                if (!container) return;
                
                var links = container.querySelectorAll('.n88-video-link-input-embedded');
                var removeButtons = container.querySelectorAll('button[onclick*="removeVideoLinkEmbedded"]');
                
                if (links.length > 1) {
                    removeButtons.forEach(function(btn) { btn.style.display = 'block'; });
                } else {
                    removeButtons.forEach(function(btn) { btn.style.display = 'none'; });
                }
                
                var addBtn = document.getElementById('n88-add-video-link-btn-embedded-' + itemId);
                if (addBtn) {
                    addBtn.style.display = links.length >= 3 ? 'none' : 'block';
                }
            }
            
            // Validate individual video link for embedded form
            function validateVideoLinkEmbedded(input, itemId) {
                var url = input.value.trim();
                var errorDiv = document.getElementById('n88-video-links-error-embedded-' + itemId);
                
                if (!url) {
                    input.style.borderColor = '#00ff00';
                    return true;
                }
                
                var allowedDomains = [
                    'youtube.com', 'youtu.be', 'www.youtube.com',
                    'vimeo.com', 'www.vimeo.com',
                    'loom.com', 'www.loom.com'
                ];
                
                var urlObj;
                try {
                    urlObj = new URL(url);
                } catch (e) {
                    input.style.borderColor = '#ff0000';
                    if (errorDiv) {
                        errorDiv.textContent = 'Invalid URL format.';
                        errorDiv.style.display = 'block';
                    }
                    return false;
                }
                
                var hostname = urlObj.hostname.toLowerCase().replace('www.', '');
                var isValid = allowedDomains.some(function(domain) {
                    return hostname === domain || hostname.endsWith('.' + domain);
                });
                
                if (!isValid) {
                    input.style.borderColor = '#ff0000';
                    if (errorDiv) {
                        errorDiv.textContent = 'Only YouTube, Vimeo, or Loom links are allowed.';
                        errorDiv.style.display = 'block';
                    }
                    return false;
                }
                
                input.style.borderColor = '#00ff00';
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
                validateBidFormEmbedded(itemId);
                return true;
            }
            
            // Save bid draft function - stores draft in user meta
            function saveBidDraftEmbedded(itemId) {
                var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                if (!form) {
                    alert('Bid form not found.');
                    return;
                }
                
                // Collect form data
                var formData = new FormData();
                formData.append('action', 'n88_save_bid_draft');
                formData.append('item_id', itemId);
                
                // Video links
                var videoLinks = form.querySelectorAll('.n88-video-link-input-embedded');
                var videoLinksArray = [];
                videoLinks.forEach(function(input) {
                    var url = input.value.trim();
                    if (url) {
                        videoLinksArray.push(url);
                    }
                });
                formData.append('video_links', JSON.stringify(videoLinksArray));
                
                // Bid photos (photo IDs)
                var bidPhotoIds = [];
                var photoIdInputs = form.querySelectorAll('input[name="bid_photo_ids[]"]');
                photoIdInputs.forEach(function(input) {
                    var photoId = parseInt(input.value);
                    if (!isNaN(photoId) && photoId > 0) {
                        bidPhotoIds.push(photoId);
                    }
                });
                formData.append('bid_photo_ids', JSON.stringify(bidPhotoIds));
                
                // Other fields
                var prototypeVideoYes = form.querySelector('input[name="prototype_video_yes"]:checked');
                formData.append('prototype_video_yes', prototypeVideoYes ? prototypeVideoYes.value : '');
                formData.append('prototype_timeline_option', form.querySelector('select[name="prototype_timeline_option"]') ? form.querySelector('select[name="prototype_timeline_option"]').value : '');
                formData.append('prototype_cost', form.querySelector('input[name="prototype_cost"]') ? form.querySelector('input[name="prototype_cost"]').value : '');
                formData.append('production_lead_time_text', form.querySelector('select[name="production_lead_time_text"]') ? form.querySelector('select[name="production_lead_time_text"]').value : '');
                formData.append('unit_price', form.querySelector('input[name="unit_price"]') ? form.querySelector('input[name="unit_price"]').value : '');
                
                // Smart Alternatives (if enabled and ANY field is filled)
                var smartAltCategory = form.querySelector('select[name="smart_alt_category"]');
                var smartAltFrom = form.querySelector('select[name="smart_alt_from"]');
                var smartAltTo = form.querySelector('select[name="smart_alt_to"]');
                var smartAltPrice = form.querySelector('select[name="smart_alt_price_impact"]');
                var smartAltLeadTime = form.querySelector('select[name="smart_alt_lead_time_impact"]');
                var smartAltComparisons = form.querySelectorAll('.n88-smart-alt-checkbox:checked');
                var comparisonValues = [];
                smartAltComparisons.forEach(function(cb) {
                    comparisonValues.push(cb.value);
                });
                
                // Check if ANY Smart Alternatives field has a value
                var hasCategory = smartAltCategory && smartAltCategory.value;
                var hasFrom = smartAltFrom && smartAltFrom.value;
                var hasTo = smartAltTo && smartAltTo.value;
                var hasPrice = smartAltPrice && smartAltPrice.value;
                var hasLeadTime = smartAltLeadTime && smartAltLeadTime.value;
                var hasComparisons = comparisonValues.length > 0;
                
                if (hasCategory || hasFrom || hasTo || hasPrice || hasLeadTime || hasComparisons) {
                    var smartAltData = {
                        category: hasCategory ? smartAltCategory.value : '',
                        from: hasFrom ? smartAltFrom.value : '',
                        to: hasTo ? smartAltTo.value : '',
                        price_impact: hasPrice ? smartAltPrice.value : '',
                        lead_time_impact: hasLeadTime ? smartAltLeadTime.value : '',
                        comparison_points: hasComparisons ? comparisonValues : []
                    };
                    formData.append('smart_alternatives_suggestion', JSON.stringify(smartAltData));
                }
                
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_save_bid_draft' ); ?>');
                
                // Show saving indicator
                var saveBtn = form.querySelector('button[onclick*="saveBidDraftEmbedded"]');
                var originalText = saveBtn ? saveBtn.textContent : '';
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                }
                
                // Save draft via AJAX
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    }
                    
                    if (data.success) {
                        // Show success message
                        var successMsg = document.createElement('div');
                        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 20px; background-color: #00ff00; color: #000; border-radius: 4px; font-family: monospace; font-size: 12px; z-index: 100000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);';
                        successMsg.textContent = 'âœ“ Draft saved successfully';
                        document.body.appendChild(successMsg);
                        
                        // Remove message after 3 seconds
                        setTimeout(function() {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 3000);
                        
                        // Update button text from "[ Start Bid ]" to "[ Continue Bid ]" after saving draft
                        var toggleBtn = document.getElementById('n88-toggle-bid-form-btn-' + itemId);
                        if (toggleBtn) {
                            toggleBtn.textContent = '[ Continue Bid ]';
                        }
                        
                        // Update window.currentItemData to reflect draft status for button text logic
                        if (window.currentItemData && window.currentItemData.item_id == itemId) {
                            window.currentItemData.bid_status = 'draft';
                        }
                    } else {
                        alert('Failed to save draft: ' + (data.data && data.data.message ? data.data.message : 'Unknown error'));
                    }
                })
                .catch(function(error) {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    }
                    console.error('Error saving draft:', error);
                    alert('Error saving draft. Please try again.');
                });
            }
            
            function validateAndSubmitBidEmbedded(event, itemId) {
                if (event) {
                    event.preventDefault();
                }
                
                var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                if (!form) return false;
                
                // Client-side validation
                if (!validateBidFormEmbedded(itemId)) {
                    alert('Please complete all required fields correctly.');
                    return false;
                }
                
                if (!itemId) {
                    alert('Item ID not found.');
                    return false;
                }
                
                // Collect form data
                var formData = new FormData();
                formData.append('action', 'n88_validate_supplier_bid');
                formData.append('item_id', itemId);
                
                // Video links
                var videoLinks = form.querySelectorAll('.n88-video-link-input');
                var videoLinksArray = [];
                videoLinks.forEach(function(input) {
                    var url = input.value.trim();
                    if (url) {
                        videoLinksArray.push(url);
                    }
                });
                formData.append('video_links', JSON.stringify(videoLinksArray));
                
                // Bid photos
                var bidPhotoIds = [];
                var photoIdInputs = form.querySelectorAll('input[name="bid_photo_ids[]"]');
                photoIdInputs.forEach(function(input) {
                    var photoId = parseInt(input.value);
                    if (!isNaN(photoId) && photoId > 0) {
                        bidPhotoIds.push(photoId);
                    }
                });
                formData.append('bid_photo_ids', JSON.stringify(bidPhotoIds));
                
                // Other fields
                formData.append('prototype_video_yes', form.querySelector('input[name="prototype_video_yes"]:checked') ? form.querySelector('input[name="prototype_video_yes"]:checked').value : '');
                formData.append('prototype_timeline_option', form.querySelector('select[name="prototype_timeline_option"]').value);
                formData.append('prototype_cost', form.querySelector('input[name="prototype_cost"]').value);
                formData.append('production_lead_time_text', form.querySelector('select[name="production_lead_time_text"]').value);
                formData.append('unit_price', form.querySelector('input[name="unit_price"]').value);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_validate_supplier_bid' ); ?>');
                
                // Disable submit button during validation
                var submitBtn = document.getElementById('n88-validate-bid-btn-embedded-' + itemId);
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Validating...';
                }
                
                // Submit to server for validation
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Validate Bid';
                    }
                    
                    if (!data.success) {
                        if (data.data && data.data.errors) {
                            var errorHtml = '<div class="n88-validation-errors" style="padding: 12px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; margin-bottom: 20px;">' +
                                '<strong style="color: #d32f2f;">Validation Errors:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">';
                            for (var field in data.data.errors) {
                                errorHtml += '<li style="color: #d32f2f; margin: 4px 0;">' + data.data.errors[field] + '</li>';
                            }
                            errorHtml += '</ul></div>';
                            
                            if (form) {
                                var existingError = form.querySelector('.n88-validation-errors');
                                if (existingError) {
                                    existingError.remove();
                                }
                                form.insertAdjacentHTML('afterbegin', errorHtml);
                                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        } else {
                            alert(data.data && data.data.message ? data.data.message : 'Validation failed. Please check your inputs.');
                        }
                    } else {
                        // Validation passed - show Submit Bid button
                        var validateBtn = document.getElementById('n88-validate-bid-btn-embedded-' + itemId);
                        var submitBtn = document.getElementById('n88-submit-bid-btn-embedded-' + itemId);
                        
                        if (validateBtn && submitBtn) {
                            validateBtn.style.display = 'none';
                            submitBtn.style.display = 'inline-block';
                            submitBtn.disabled = false;
                        }
                        
                        // Show success message
                        if (form) {
                            var existingError = form.querySelector('.n88-validation-errors');
                            if (existingError) {
                                existingError.remove();
                            }
                            var successHtml = '<div class="n88-validation-errors" style="padding: 12px; background-color: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; margin-bottom: 20px; color: #2e7d32;">' +
                                '<strong>âœ“ Validation successful!</strong> Click "Submit Proposal" to save your bid.' +
                                '</div>';
                            form.insertAdjacentHTML('afterbegin', successHtml);
                            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                })
                .catch(function(error) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Validate Bid';
                    }
                    alert('Error validating bid. Please try again.');
                    console.error('Validation error:', error);
                });
                
                return false;
            }
            
            function submitBidEmbedded(event, itemId) {
                if (event) {
                    event.preventDefault();
                }
                
                var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                if (!form) return false;
                
                if (!itemId) {
                    alert('Item ID not found.');
                    return false;
                }
                
                // Collect form data
                var formData = new FormData();
                formData.append('action', 'n88_submit_supplier_bid');
                formData.append('item_id', itemId);
                
                // Video links (use embedded class)
                var videoLinks = form.querySelectorAll('.n88-video-link-input-embedded');
                var videoLinksArray = [];
                videoLinks.forEach(function(input) {
                    var url = input.value.trim();
                    if (url) {
                        videoLinksArray.push(url);
                    }
                });
                formData.append('video_links', JSON.stringify(videoLinksArray));
                
                // Bid photos
                var bidPhotoIds = [];
                var photoIdInputs = form.querySelectorAll('input[name="bid_photo_ids[]"]');
                photoIdInputs.forEach(function(input) {
                    var photoId = parseInt(input.value);
                    if (!isNaN(photoId) && photoId > 0) {
                        bidPhotoIds.push(photoId);
                    }
                });
                formData.append('bid_photo_ids', JSON.stringify(bidPhotoIds));
                
                // Other fields
                formData.append('prototype_video_yes', form.querySelector('input[name="prototype_video_yes"]:checked') ? form.querySelector('input[name="prototype_video_yes"]:checked').value : '');
                formData.append('prototype_timeline_option', form.querySelector('select[name="prototype_timeline_option"]').value);
                formData.append('prototype_cost', form.querySelector('input[name="prototype_cost"]').value);
                formData.append('production_lead_time_text', form.querySelector('select[name="production_lead_time_text"]').value);
                formData.append('unit_price', form.querySelector('input[name="unit_price"]').value);
                
                // Smart Alternatives suggestion (if enabled and ANY field is filled)
                var smartAltCategory = form.querySelector('select[name="smart_alt_category"]');
                var smartAltFrom = form.querySelector('select[name="smart_alt_from"]');
                var smartAltTo = form.querySelector('select[name="smart_alt_to"]');
                var smartAltPrice = form.querySelector('select[name="smart_alt_price_impact"]');
                var smartAltLeadTime = form.querySelector('select[name="smart_alt_lead_time_impact"]');
                var smartAltComparisons = form.querySelectorAll('input[name="smart_alt_comparison[]"]:checked');
                
                // Check if ANY Smart Alternatives field has a value
                var hasCategory = smartAltCategory && smartAltCategory.value;
                var hasFrom = smartAltFrom && smartAltFrom.value;
                var hasTo = smartAltTo && smartAltTo.value;
                var hasPrice = smartAltPrice && smartAltPrice.value;
                var hasLeadTime = smartAltLeadTime && smartAltLeadTime.value;
                var hasComparisons = smartAltComparisons && smartAltComparisons.length > 0;
                
                if (hasCategory || hasFrom || hasTo || hasPrice || hasLeadTime || hasComparisons) {
                    var smartAltData = {
                        category: hasCategory ? smartAltCategory.value : '',
                        from: hasFrom ? smartAltFrom.value : '',
                        to: hasTo ? smartAltTo.value : '',
                        comparison_points: hasComparisons ? Array.from(smartAltComparisons).map(function(cb) { return cb.value; }) : [],
                        price_impact: hasPrice ? smartAltPrice.value : '',
                        lead_time_impact: hasLeadTime ? smartAltLeadTime.value : ''
                    };
                    formData.append('smart_alternatives_suggestion', JSON.stringify(smartAltData));
                }
                
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_submit_supplier_bid' ); ?>');
                
                // Disable submit button
                var submitBtn = document.getElementById('n88-submit-bid-btn-embedded-' + itemId);
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                }
                
                // Submit to server
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Proposal';
                    }
                    
                    if (!data.success) {
                        if (data.data && data.data.errors) {
                            var errorHtml = '<div style="padding: 12px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; margin-bottom: 20px;">' +
                                '<strong style="color: #d32f2f;">Submission Errors:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">';
                            for (var field in data.data.errors) {
                                errorHtml += '<li style="color: #d32f2f; margin: 4px 0;">' + data.data.errors[field] + '</li>';
                            }
                            errorHtml += '</ul></div>';
                            
                            if (form) {
                                var existingError = form.querySelector('.n88-validation-errors');
                                if (existingError) {
                                    existingError.remove();
                                }
                                errorHtml = errorHtml.replace('<div style="', '<div class="n88-validation-errors" style="');
                                form.insertAdjacentHTML('afterbegin', errorHtml);
                                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        } else {
                            alert(data.data && data.data.message ? data.data.message : 'Failed to submit bid. Please try again.');
                        }
                    } else {
                        // Success - close bid form section and reopen modal on Proposal tab
                        alert(data.data && data.data.message || 'Bid submitted successfully!');
                        toggleBidForm(itemId);
                        openBidModal(itemId, 'bid');
                    }
                })
                .catch(function(error) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Proposal';
                    }
                    alert('Error submitting bid. Please try again.');
                    console.error('Submission error:', error);
                });
                
                return false;
            }
            
            // Load bid draft from user meta
            function loadBidDraft(itemId) {
                // Wait a bit to ensure form is fully rendered
                setTimeout(function() {
                    var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                    if (!form) {
                        console.log('Form not found, skipping draft load');
                        return;
                    }
                    
                    var formData = new FormData();
                    formData.append('action', 'n88_get_bid_draft');
                    formData.append('item_id', itemId);
                    formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_bid_draft' ); ?>');
                    
                    // Add timeout to prevent hanging
                    var timeoutPromise = new Promise(function(resolve, reject) {
                        setTimeout(function() {
                            reject(new Error('Request timeout'));
                        }, 10000); // 10 second timeout
                    });
                    
                    Promise.race([
                        fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        }),
                        timeoutPromise
                    ])
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('HTTP error! status: ' + response.status);
                        }
                        // Check if response is JSON
                        var contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error('Response is not JSON');
                        }
                        return response.json();
                    })
                    .then(function(data) {
                    if (data.success && data.data && data.data.draft) {
                        var draft = data.data.draft;
                        var form = document.getElementById('n88-bid-form-embedded-' + itemId);
                        if (!form) return;
                        
                        // Restore video links
                        if (draft.video_links && draft.video_links.length > 0) {
                            draft.video_links.forEach(function(url, index) {
                                if (index === 0) {
                                    var firstInput = form.querySelector('.n88-video-link-input-embedded');
                                    if (firstInput) {
                                        firstInput.value = url;
                                    }
                                } else {
                                    addVideoLinkEmbedded(itemId);
                                    var inputs = form.querySelectorAll('.n88-video-link-input-embedded');
                                    if (inputs[index]) {
                                        inputs[index].value = url;
                                    }
                                }
                            });
                        }
                        
                        // Restore form fields
                        if (draft.prototype_video_yes) {
                            var radio = form.querySelector('input[name="prototype_video_yes"][value="' + draft.prototype_video_yes + '"]');
                            if (radio) radio.checked = true;
                        }
                        if (draft.prototype_timeline_option) {
                            var timelineSelect = form.querySelector('select[name="prototype_timeline_option"]');
                            if (timelineSelect) timelineSelect.value = draft.prototype_timeline_option;
                        }
                        if (draft.prototype_cost) {
                            var costInput = form.querySelector('input[name="prototype_cost"]');
                            if (costInput) costInput.value = draft.prototype_cost;
                        }
                        if (draft.production_lead_time_text) {
                            var leadTimeSelect = form.querySelector('select[name="production_lead_time_text"]');
                            if (leadTimeSelect) leadTimeSelect.value = draft.production_lead_time_text;
                        }
                        if (draft.unit_price) {
                            var priceInput = form.querySelector('input[name="unit_price"]');
                            if (priceInput) priceInput.value = draft.unit_price;
                        }
                        
                        // Restore Smart Alternatives
                        if (draft.smart_alternatives_suggestion) {
                            var sa = draft.smart_alternatives_suggestion;
                            if (sa.category) {
                                var catSelect = form.querySelector('select[name="smart_alt_category"]');
                                if (catSelect) catSelect.value = sa.category;
                            }
                            if (sa.from) {
                                var fromSelect = form.querySelector('select[name="smart_alt_from"]');
                                if (fromSelect) fromSelect.value = sa.from;
                            }
                            if (sa.to) {
                                var toSelect = form.querySelector('select[name="smart_alt_to"]');
                                if (toSelect) toSelect.value = sa.to;
                            }
                            if (sa.price_impact) {
                                var priceSelect = form.querySelector('select[name="smart_alt_price_impact"]');
                                if (priceSelect) priceSelect.value = sa.price_impact;
                            }
                            if (sa.lead_time_impact) {
                                var leadSelect = form.querySelector('select[name="smart_alt_lead_time_impact"]');
                                if (leadSelect) leadSelect.value = sa.lead_time_impact;
                            }
                            // Comparison Points: draft saves as comparison_points; support legacy comparisons
                            var comps = sa.comparison_points || sa.comparisons || [];
                            if (comps.length > 0) {
                                comps.forEach(function(comp) {
                                    var val = String(comp || '').trim();
                                    if (!val) return;
                                    var checkbox = form.querySelector('input.n88-smart-alt-checkbox[value="' + val.replace(/"/g, '&quot;') + '"]');
                                    if (!checkbox) {
                                        checkbox = form.querySelector('input[name="smart_alt_comparison[]"][value="' + val.replace(/"/g, '&quot;') + '"]');
                                    }
                                    if (checkbox) checkbox.checked = true;
                                });
                            }
                            if (typeof updateSmartAltPreview === 'function') {
                                updateSmartAltPreview(itemId);
                            }
                        }
                        
                        // Restore photos (H) - restore from URLs with proper image display
                        var previewContainer = document.getElementById('n88-bid-photos-preview-embedded-' + itemId);
                        if (previewContainer) {
                            previewContainer.innerHTML = '';
                            if (draft.bid_photo_urls && draft.bid_photo_urls.length > 0) {
                                draft.bid_photo_urls.forEach(function(photo) {
                                    var thumbDiv = document.createElement('div');
                                    thumbDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px solid #00ff00; border-radius: 4px; overflow: hidden; margin: 5px; display: inline-block;';
                                    thumbDiv.innerHTML = '<img src="' + photo.url.replace(/"/g, '&quot;') + '" style="width: 100%; height: 100%; object-fit: cover;" alt="Bid photo" />' +
                                        '<button type="button" onclick="removeBidPhotoEmbedded(this, ' + (photo.id || 'null') + ', ' + itemId + ');" style="position: absolute; top: 4px; right: 4px; background: rgba(255, 0, 0, 0.8); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;" title="Remove">Ã—</button>';
                                    thumbDiv.setAttribute('data-photo-id', photo.id || '');
                                    previewContainer.appendChild(thumbDiv);
                                    
                                    // Add hidden input for photo ID
                                    if (photo.id) {
                                        var hiddenInput = document.createElement('input');
                                        hiddenInput.type = 'hidden';
                                        hiddenInput.name = 'bid_photo_ids[]';
                                        hiddenInput.value = photo.id;
                                        hiddenInput.setAttribute('data-photo-id', photo.id);
                                        form.appendChild(hiddenInput);
                                    }
                                });
                            } else if (draft.bid_photos && draft.bid_photos.length > 0) {
                                // Fallback: restore from bid_photos URLs
                                draft.bid_photos.forEach(function(photoUrl) {
                                    var thumbDiv = document.createElement('div');
                                    thumbDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px solid #00ff00; border-radius: 4px; overflow: hidden; margin: 5px; display: inline-block;';
                                    thumbDiv.innerHTML = '<img src="' + photoUrl.replace(/"/g, '&quot;') + '" style="width: 100%; height: 100%; object-fit: cover;" alt="Bid photo" />' +
                                        '<button type="button" onclick="removeBidPhotoEmbedded(this, null, ' + itemId + ');" style="position: absolute; top: 4px; right: 4px; background: rgba(255, 0, 0, 0.8); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;" title="Remove">Ã—</button>';
                                    previewContainer.appendChild(thumbDiv);
                                });
                            }
                        }
                        
                        // Trigger validation
                        if (typeof validateBidFormEmbedded === 'function') {
                            validateBidFormEmbedded(itemId);
                        }
                        
                        // Show notification that draft was loaded
                        var notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 20px; background-color: #00ff00; color: #000; border-radius: 4px; font-family: monospace; font-size: 12px; z-index: 100000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);';
                        notification.textContent = 'âœ“ Draft loaded (saved ' + (draft.saved_at ? new Date(draft.saved_at).toLocaleString() : 'previously') + ')';
                        document.body.appendChild(notification);
                        setTimeout(function() {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 4000);
                    }
                })
                .catch(function(error) {
                    // Silently fail - draft loading is optional and shouldn't break the form
                    console.log('Draft not available or error loading draft:', error.message || error);
                });
                }, 500); // Wait 500ms for form to be fully rendered
            }
            
            // H) Load draft for modal form (n88-bid-form)
            function loadBidDraftModal(itemId, itemData) {
                var form = document.getElementById('n88-bid-form');
                if (!form) {
                    console.log('Modal form not found, skipping draft load');
                    return;
                }
                
                // First, try to load from submitted bid data (if specs changed and supplier needs to resubmit)
                if (itemData && itemData.has_revision_mismatch) {
                    // Use latest_stale_bid_data if available, otherwise use bid_data
                    var staleBidData = itemData.latest_stale_bid_data || itemData.bid_data;
                    if (staleBidData) {
                        restoreBidDataToForm(form, staleBidData, itemId);
                    return;
                    }
                }
                
                // Otherwise, load from draft
                var formData = new FormData();
                formData.append('action', 'n88_get_bid_draft');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_bid_draft' ); ?>');
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.success && data.data && data.data.draft) {
                        var draft = data.data.draft;
                        restoreBidDataToForm(form, draft, itemId);
                        
                        // Show notification
                        var notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 20px; background-color: #00ff00; color: #000; border-radius: 4px; font-family: monospace; font-size: 12px; z-index: 100000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);';
                        notification.textContent = 'âœ“ Draft loaded (saved ' + (draft.saved_at ? new Date(draft.saved_at).toLocaleString() : 'previously') + ')';
                        document.body.appendChild(notification);
                        setTimeout(function() {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 4000);
                    }
                })
                .catch(function(error) {
                    console.log('Draft not available or error loading draft:', error.message || error);
                });
            }
            
            // H) Restore bid data to form (works for both draft and submitted bid)
            function restoreBidDataToForm(form, bidData, itemId) {
                if (!form || !bidData) return;
                
                // Restore video links
                if (bidData.video_links && bidData.video_links.length > 0) {
                    var videoContainer = document.getElementById('n88-video-links-container');
                    if (videoContainer) {
                        // Clear existing inputs except first
                        var existingInputs = videoContainer.querySelectorAll('.n88-video-link-input');
                        for (var i = 1; i < existingInputs.length; i++) {
                            var parent = existingInputs[i].closest('div');
                            if (parent) parent.remove();
                        }
                        
                        // Set first input
                        var firstInput = videoContainer.querySelector('.n88-video-link-input');
                        if (firstInput && bidData.video_links[0]) {
                            firstInput.value = bidData.video_links[0];
                        }
                        
                        // Add additional inputs
                        for (var i = 1; i < bidData.video_links.length; i++) {
                            if (typeof addVideoLink === 'function') {
                                addVideoLink();
                                var inputs = videoContainer.querySelectorAll('.n88-video-link-input');
                                if (inputs[i]) {
                                    inputs[i].value = bidData.video_links[i];
                                }
                            }
                        }
                    }
                }
                
                // Restore photos (H) - restore from URLs
                if (bidData.bid_photo_urls && bidData.bid_photo_urls.length > 0) {
                    var previewContainer = document.getElementById('n88-bid-photos-preview');
                    if (previewContainer) {
                        previewContainer.innerHTML = '';
                        bidData.bid_photo_urls.forEach(function(photo) {
                            var thumbDiv = document.createElement('div');
                            thumbDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px solid #00ff00; border-radius: 4px; overflow: hidden;';
                            thumbDiv.innerHTML = '<img src="' + photo.url.replace(/"/g, '&quot;') + '" style="width: 100%; height: 100%; object-fit: cover;" alt="Bid photo" />' +
                                '<button type="button" onclick="removeBidPhoto(this, ' + photo.id + ');" style="position: absolute; top: 4px; right: 4px; background: rgba(255, 0, 0, 0.8); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;" title="Remove">Ã—</button>';
                            thumbDiv.setAttribute('data-photo-id', photo.id);
                            previewContainer.appendChild(thumbDiv);
                            
                            // Add hidden input
                            var hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'bid_photo_ids[]';
                            hiddenInput.value = photo.id;
                            hiddenInput.setAttribute('data-photo-id', photo.id);
                            hiddenInput.setAttribute('data-thumb-div', 'photo-' + photo.id);
                            form.appendChild(hiddenInput);
                        });
                    }
                } else if (bidData.bid_photos && bidData.bid_photos.length > 0) {
                    // Fallback: restore from URLs if photo_urls not available
                    var previewContainer = document.getElementById('n88-bid-photos-preview');
                    if (previewContainer) {
                        previewContainer.innerHTML = '';
                        bidData.bid_photos.forEach(function(photoUrl, index) {
                            var thumbDiv = document.createElement('div');
                            thumbDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px solid #00ff00; border-radius: 4px; overflow: hidden;';
                            thumbDiv.innerHTML = '<img src="' + photoUrl.replace(/"/g, '&quot;') + '" style="width: 100%; height: 100%; object-fit: cover;" alt="Bid photo" />' +
                                '<button type="button" onclick="removeBidPhoto(this, null);" style="position: absolute; top: 4px; right: 4px; background: rgba(255, 0, 0, 0.8); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;" title="Remove">Ã—</button>';
                            previewContainer.appendChild(thumbDiv);
                        });
                    }
                }
                
                // Restore form fields
                if (bidData.prototype_video_yes !== undefined && bidData.prototype_video_yes !== null) {
                    var radio = form.querySelector('input[name="prototype_video_yes"][value="' + bidData.prototype_video_yes + '"]');
                    if (radio) radio.checked = true;
                }
                if (bidData.prototype_timeline_option) {
                    var timelineSelect = form.querySelector('select[name="prototype_timeline_option"]');
                    if (timelineSelect) timelineSelect.value = bidData.prototype_timeline_option;
                }
                if (bidData.prototype_cost) {
                    var costInput = form.querySelector('input[name="prototype_cost"]');
                    if (costInput) costInput.value = bidData.prototype_cost;
                }
                if (bidData.production_lead_time_text) {
                    var leadTimeSelect = form.querySelector('select[name="production_lead_time_text"]');
                    if (leadTimeSelect) leadTimeSelect.value = bidData.production_lead_time_text;
                }
                if (bidData.unit_price) {
                    var priceInput = form.querySelector('input[name="unit_price"]');
                    if (priceInput) priceInput.value = bidData.unit_price;
                }
                
                // Restore Smart Alternatives (H) - fix comparison points
                if (bidData.smart_alternatives_suggestion) {
                    var sa = bidData.smart_alternatives_suggestion;
                    if (sa.category) {
                        var catSelect = form.querySelector('select[name="smart_alt_category"]');
                        if (catSelect) catSelect.value = sa.category;
                    }
                    if (sa.from) {
                        var fromSelect = form.querySelector('select[name="smart_alt_from"]');
                        if (fromSelect) fromSelect.value = sa.from;
                    }
                    if (sa.to) {
                        var toSelect = form.querySelector('select[name="smart_alt_to"]');
                        if (toSelect) toSelect.value = sa.to;
                    }
                    if (sa.price_impact) {
                        var priceSelect = form.querySelector('select[name="smart_alt_price_impact"]');
                        if (priceSelect) priceSelect.value = sa.price_impact;
                    }
                    if (sa.lead_time_impact) {
                        var leadSelect = form.querySelector('select[name="smart_alt_lead_time_impact"]');
                        if (leadSelect) leadSelect.value = sa.lead_time_impact;
                    }
                    // Comparison Points: draft/bid saves as comparison_points; support legacy comparisons
                    var compsModal = sa.comparison_points || sa.comparisons || [];
                    if (compsModal.length > 0) {
                        compsModal.forEach(function(comp) {
                            var val = String(comp || '').trim();
                            if (!val) return;
                            var checkbox = form.querySelector('input.n88-smart-alt-checkbox-modal[value="' + val.replace(/"/g, '&quot;') + '"]');
                            if (!checkbox) {
                                checkbox = form.querySelector('input[name="smart_alt_comparison[]"][value="' + val.replace(/"/g, '&quot;') + '"]');
                            }
                            if (!checkbox) {
                                checkbox = form.querySelector('input[type="checkbox"][value="' + val.replace(/"/g, '&quot;') + '"]');
                            }
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    // Update preview
                    if (typeof updateSmartAltPreviewModal === 'function') {
                        updateSmartAltPreviewModal();
                    }
                }
                
                // Trigger validation
                if (typeof validateBidForm === 'function') {
                    setTimeout(function() {
                        validateBidForm();
                    }, 100);
                }
            }
            
            // Restore bid data to embedded form (for resubmission)
            function restoreBidDataToFormEmbedded(form, bidData, itemId) {
                if (!form || !bidData) return;
                
                // Restore video links (embedded form uses different container ID)
                if (bidData.video_links && bidData.video_links.length > 0) {
                    var videoContainer = document.getElementById('n88-video-links-container-embedded-' + itemId);
                    if (videoContainer) {
                        // Clear existing inputs except first
                        var existingInputs = videoContainer.querySelectorAll('.n88-video-link-input-embedded');
                        for (var i = 1; i < existingInputs.length; i++) {
                            var parent = existingInputs[i].closest('div');
                            if (parent) parent.remove();
                        }
                        
                        // Set first input
                        var firstInput = videoContainer.querySelector('.n88-video-link-input-embedded');
                        if (firstInput && bidData.video_links[0]) {
                            firstInput.value = bidData.video_links[0];
                        }
                        
                        // Add additional inputs
                        for (var i = 1; i < bidData.video_links.length; i++) {
                            if (typeof addVideoLinkEmbedded === 'function') {
                                addVideoLinkEmbedded(itemId);
                                var inputs = videoContainer.querySelectorAll('.n88-video-link-input-embedded');
                                if (inputs[i]) {
                                    inputs[i].value = bidData.video_links[i];
                                }
                            }
                        }
                    }
                }
                
                // Restore photos (embedded form uses different preview container ID)
                var previewContainer = document.getElementById('n88-bid-photos-preview-embedded-' + itemId);
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                    if (bidData.bid_photo_urls && bidData.bid_photo_urls.length > 0) {
                        bidData.bid_photo_urls.forEach(function(photo) {
                            var thumbDiv = document.createElement('div');
                            thumbDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px solid #00ff00; border-radius: 4px; overflow: hidden;';
                            thumbDiv.innerHTML = '<img src="' + photo.url.replace(/"/g, '&quot;') + '" style="width: 100%; height: 100%; object-fit: cover;" alt="Bid photo" />' +
                                '<button type="button" onclick="removeBidPhotoEmbedded(this, ' + (photo.id || 'null') + ', ' + itemId + ');" style="position: absolute; top: 4px; right: 4px; background: rgba(255, 0, 0, 0.8); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;" title="Remove">Ã—</button>';
                            thumbDiv.setAttribute('data-photo-id', photo.id || '');
                            previewContainer.appendChild(thumbDiv);
                            
                            // Add hidden input
                            var hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'bid_photo_ids[]';
                            hiddenInput.value = photo.id || '';
                            hiddenInput.setAttribute('data-photo-id', photo.id || '');
                            form.appendChild(hiddenInput);
                        });
                    } else if (bidData.bid_photos && bidData.bid_photos.length > 0) {
                        bidData.bid_photos.forEach(function(photoUrl) {
                            var thumbDiv = document.createElement('div');
                            thumbDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border: 2px solid #00ff00; border-radius: 4px; overflow: hidden;';
                            thumbDiv.innerHTML = '<img src="' + photoUrl.replace(/"/g, '&quot;') + '" style="width: 100%; height: 100%; object-fit: cover;" alt="Bid photo" />' +
                                '<button type="button" onclick="removeBidPhotoEmbedded(this, null, ' + itemId + ');" style="position: absolute; top: 4px; right: 4px; background: rgba(255, 0, 0, 0.8); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;" title="Remove">Ã—</button>';
                            previewContainer.appendChild(thumbDiv);
                        });
                    }
                }
                
                // Restore form fields (same selectors work for embedded forms)
                if (bidData.prototype_video_yes !== undefined && bidData.prototype_video_yes !== null) {
                    var radio = form.querySelector('input[name="prototype_video_yes"][value="' + (bidData.prototype_video_yes ? '1' : '0') + '"]');
                    if (radio) radio.checked = true;
                }
                if (bidData.prototype_timeline_option) {
                    var timelineSelect = form.querySelector('select[name="prototype_timeline_option"]');
                    if (timelineSelect) timelineSelect.value = bidData.prototype_timeline_option;
                }
                if (bidData.prototype_cost) {
                    var costInput = form.querySelector('input[name="prototype_cost"]');
                    if (costInput) costInput.value = bidData.prototype_cost;
                }
                if (bidData.production_lead_time_text) {
                    var leadTimeSelect = form.querySelector('select[name="production_lead_time_text"]');
                    if (leadTimeSelect) leadTimeSelect.value = bidData.production_lead_time_text;
                }
                if (bidData.unit_price) {
                    var priceInput = form.querySelector('input[name="unit_price"]');
                    if (priceInput) priceInput.value = bidData.unit_price;
                }
                
                // Restore Smart Alternatives
                if (bidData.smart_alternatives_suggestion) {
                    var sa = bidData.smart_alternatives_suggestion;
                    if (sa.category) {
                        var catSelect = form.querySelector('select[name="smart_alt_category"]');
                        if (catSelect) catSelect.value = sa.category;
                    }
                    if (sa.from) {
                        var fromSelect = form.querySelector('select[name="smart_alt_from"]');
                        if (fromSelect) fromSelect.value = sa.from;
                    }
                    if (sa.to) {
                        var toSelect = form.querySelector('select[name="smart_alt_to"]');
                        if (toSelect) toSelect.value = sa.to;
                    }
                    if (sa.price_impact) {
                        var priceSelect = form.querySelector('select[name="smart_alt_price_impact"]');
                        if (priceSelect) priceSelect.value = sa.price_impact;
                    }
                    if (sa.lead_time_impact) {
                        var leadSelect = form.querySelector('select[name="smart_alt_lead_time_impact"]');
                        if (leadSelect) leadSelect.value = sa.lead_time_impact;
                    }
                    // Comparison Points: use comparison_points; support legacy comparisons; prefer .n88-smart-alt-checkbox
                    var compsEmb = sa.comparison_points || sa.comparisons || [];
                    if (compsEmb.length > 0) {
                        compsEmb.forEach(function(comp) {
                            var val = String(comp || '').trim();
                            if (!val) return;
                            var checkbox = form.querySelector('input.n88-smart-alt-checkbox[value="' + val.replace(/"/g, '&quot;') + '"]');
                            if (!checkbox) {
                                checkbox = form.querySelector('input[name="smart_alt_comparison[]"][value="' + val.replace(/"/g, '&quot;') + '"]');
                            }
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    // Update preview if function exists (embedded form uses updateSmartAltPreview(itemId))
                    if (typeof updateSmartAltPreview === 'function') {
                        updateSmartAltPreview(itemId);
                    }
                }
                
                // Trigger validation for embedded form
                if (typeof validateBidFormEmbedded === 'function') {
                    setTimeout(function() {
                        validateBidFormEmbedded(itemId);
                    }, 100);
                }
            }
            
            // G) Update bid to match new specs
            function updateBidToMatchNewSpecs(itemId) {
                var formData = new FormData();
                formData.append('action', 'n88_update_bid_to_match_new_specs');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_update_bid_to_match_new_specs' ); ?>');
                
                // Show loading state
                var banner = document.getElementById('n88-specs-changed-banner');
                if (banner) {
                    banner.innerHTML = '<div style="padding: 16px; text-align: center; color: #fff; font-family: monospace;">Creating new draft...</div>';
                }
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (!data.success) {
                        alert(data.data && data.data.message ? data.data.message : 'Failed to create draft. Please try again.');
                        if (banner) {
                            banner.innerHTML = '<div style="font-size: 14px; font-weight: 600; color: #ff9800; margin-bottom: 12px; font-family: monospace;">âš ï¸ Specs changed since your last bid.</div>' +
                                '<div style="font-size: 12px; color: #fff; margin-bottom: 16px; font-family: monospace; line-height: 1.5;">' +
                                'The item specifications have been updated. Please update your bid to match the new specs before submitting.' +
                                '</div>' +
                                '<button type="button" onclick="updateBidToMatchNewSpecs(' + itemId + ')" style="padding: 10px 20px; background-color: #ff9800; color: #000; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: monospace;">Update Bid to Match New Specs</button>';
                        }
                        return;
                    }
                    
                    // Hide banner and show form
                    if (banner) {
                        banner.style.display = 'none';
                    }
                    var form = document.getElementById('n88-bid-form');
                    if (form) {
                        form.style.display = 'block';
                    }
                    
                    // Reload item details to get pre-filled draft data
                    openBidFormModalInternal(itemId);
                })
                .catch(function(error) {
                    console.error('Error updating bid:', error);
                    alert('An error occurred. Please try again.');
                    if (banner) {
                        banner.innerHTML = '<div style="font-size: 14px; font-weight: 600; color: #ff9800; margin-bottom: 12px; font-family: monospace;">âš ï¸ Specs changed since your last bid.</div>' +
                            '<div style="font-size: 12px; color: #fff; margin-bottom: 16px; font-family: monospace; line-height: 1.5;">' +
                            'The item specifications have been updated. Please update your bid to match the new specs before submitting.' +
                            '</div>' +
                            '<button type="button" onclick="updateBidToMatchNewSpecs(' + itemId + ')" style="padding: 10px 20px; background-color: #ff9800; color: #000; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: monospace;">Update Bid to Match New Specs</button>';
                    }
                });
            }
            
            // Make functions globally accessible
            window.validateAndSubmitBid = validateAndSubmitBid;
            window.submitBid = submitBid;
            window.toggleBidForm = toggleBidForm;
            window.addVideoLinkEmbedded = addVideoLinkEmbedded;
            window.removeVideoLinkEmbedded = removeVideoLinkEmbedded;
            window.validateVideoLinkEmbedded = validateVideoLinkEmbedded;
            window.updateVideoLinkButtonsEmbedded = updateVideoLinkButtonsEmbedded;
            window.handleBidPhotosChangeEmbedded = handleBidPhotosChangeEmbedded;
            window.validateBidFormEmbedded = validateBidFormEmbedded;
            window.validateAndSubmitBidEmbedded = validateAndSubmitBidEmbedded;
            window.submitBidEmbedded = submitBidEmbedded;
            window.saveBidDraftEmbedded = saveBidDraftEmbedded;
            window.updateBidToMatchNewSpecs = updateBidToMatchNewSpecs;
            
            // Smart Alternatives preview update function
            function updateSmartAltPreview(itemId) {
                var category = document.getElementById('n88-smart-alt-category-' + itemId);
                var from = document.getElementById('n88-smart-alt-from-' + itemId);
                var to = document.getElementById('n88-smart-alt-to-' + itemId);
                var priceImpact = document.getElementById('n88-smart-alt-price-' + itemId);
                var leadTimeImpact = document.getElementById('n88-smart-alt-leadtime-' + itemId);
                var checkboxes = document.querySelectorAll('#n88-bid-form-embedded-' + itemId + ' .n88-smart-alt-checkbox:checked');
                var preview = document.getElementById('n88-smart-alt-preview-' + itemId);
                
                if (!preview) return;
                
                // Validate max 3 checkboxes
                if (checkboxes.length > 3) {
                    alert('Maximum 3 comparison points allowed. Please uncheck one.');
                    event.target.checked = false;
                    checkboxes = document.querySelectorAll('#n88-bid-form-embedded-' + itemId + ' .n88-smart-alt-checkbox:checked');
                }
                
                var parts = [];
                
                if (category && category.value) {
                    var categoryLabels = {
                        'material': 'Material',
                        'finish': 'Finish',
                        'hardware': 'Hardware',
                        'dimensions': 'Dimensions',
                        'construction': 'Construction Method',
                        'packaging': 'Packaging'
                    };
                    parts.push('Category: ' + (categoryLabels[category.value] || category.value));
                }
                
                if (from && from.value && to && to.value) {
                    var fromLabels = {
                        'solid-wood': 'Solid Wood', 'plywood': 'Plywood', 'mdf': 'MDF',
                        'metal': 'Metal', 'plastic': 'Plastic', 'glass': 'Glass',
                        'fabric': 'Fabric', 'leather': 'Leather', 'other': 'Other'
                    };
                    var toLabels = fromLabels;
                    parts.push('From ' + (fromLabels[from.value] || from.value) + ' to ' + (toLabels[to.value] || to.value));
                }
                
                if (checkboxes.length > 0) {
                    var comparisonLabels = {
                        'cost-reduction': 'Cost Reduction',
                        'faster-production': 'Faster Production',
                        'better-durability': 'Better Durability',
                        'easier-sourcing': 'Easier Sourcing',
                        'lighter-weight': 'Lighter Weight',
                        'eco-friendly': 'Eco-Friendly'
                    };
                    var comparisons = Array.from(checkboxes).map(function(cb) {
                        return comparisonLabels[cb.value] || cb.value;
                    });
                    parts.push('Benefits: ' + comparisons.join(', '));
                }
                
                if (priceImpact && priceImpact.value) {
                    var priceLabels = {
                        'reduces-10-20': 'Price: Reduces 10-20%',
                        'reduces-20-30': 'Price: Reduces 20-30%',
                        'reduces-30-plus': 'Price: Reduces 30%+',
                        'similar': 'Price: Similar',
                        'increases-10-20': 'Price: Increases 10-20%',
                        'increases-20-plus': 'Price: Increases 20%+'
                    };
                    parts.push(priceLabels[priceImpact.value] || priceImpact.value);
                }
                
                if (leadTimeImpact && leadTimeImpact.value) {
                    var leadTimeLabels = {
                        'reduces-1-2w': 'Lead Time: Reduces 1-2 weeks',
                        'reduces-2-4w': 'Lead Time: Reduces 2-4 weeks',
                        'reduces-4w-plus': 'Lead Time: Reduces 4+ weeks',
                        'similar': 'Lead Time: Similar',
                        'increases-1-2w': 'Lead Time: Increases 1-2 weeks',
                        'increases-2w-plus': 'Lead Time: Increases 2+ weeks'
                    };
                    parts.push(leadTimeLabels[leadTimeImpact.value] || leadTimeImpact.value);
                }
                
                if (parts.length > 0) {
                    preview.textContent = parts.join(' | ');
                    preview.style.color = '#00ff00';
                    preview.style.fontStyle = 'normal';
                } else {
                    preview.textContent = 'Fill in the fields above to generate preview...';
                    preview.style.color = '#999';
                    preview.style.fontStyle = 'italic';
                }
            }
            
            window.updateSmartAltPreview = updateSmartAltPreview;
            
            // Smart Alternatives preview update function for modal form
            function updateSmartAltPreviewModal() {
                var category = document.getElementById('n88-smart-alt-category-modal');
                var from = document.getElementById('n88-smart-alt-from-modal');
                var to = document.getElementById('n88-smart-alt-to-modal');
                var priceImpact = document.getElementById('n88-smart-alt-price-modal');
                var leadTimeImpact = document.getElementById('n88-smart-alt-leadtime-modal');
                var checkboxes = document.querySelectorAll('#n88-bid-form .n88-smart-alt-checkbox-modal:checked');
                var preview = document.getElementById('n88-smart-alt-preview-modal');
                
                if (!preview) return;
                
                // Validate max 3 checkboxes
                if (checkboxes.length > 3) {
                    alert('Maximum 3 comparison points allowed. Please uncheck one.');
                    event.target.checked = false;
                    checkboxes = document.querySelectorAll('#n88-bid-form .n88-smart-alt-checkbox-modal:checked');
                }
                
                var parts = [];
                
                if (category && category.value) {
                    var categoryLabels = {
                        'material': 'Material',
                        'finish': 'Finish',
                        'hardware': 'Hardware',
                        'dimensions': 'Dimensions',
                        'construction': 'Construction Method',
                        'packaging': 'Packaging'
                    };
                    parts.push('Category: ' + (categoryLabels[category.value] || category.value));
                }
                
                if (from && from.value && to && to.value) {
                    var fromLabels = {
                        'solid-wood': 'Solid Wood', 'plywood': 'Plywood', 'mdf': 'MDF',
                        'metal': 'Metal', 'plastic': 'Plastic', 'glass': 'Glass',
                        'fabric': 'Fabric', 'leather': 'Leather', 'other': 'Other'
                    };
                    var toLabels = fromLabels;
                    parts.push('From ' + (fromLabels[from.value] || from.value) + ' to ' + (toLabels[to.value] || to.value));
                }
                
                if (checkboxes.length > 0) {
                    var comparisonLabels = {
                        'cost-reduction': 'Cost Reduction',
                        'faster-production': 'Faster Production',
                        'better-durability': 'Better Durability',
                        'easier-sourcing': 'Easier Sourcing',
                        'lighter-weight': 'Lighter Weight',
                        'eco-friendly': 'Eco-Friendly'
                    };
                    var comparisons = Array.from(checkboxes).map(function(cb) {
                        return comparisonLabels[cb.value] || cb.value;
                    });
                    parts.push('Benefits: ' + comparisons.join(', '));
                }
                
                if (priceImpact && priceImpact.value) {
                    var priceLabels = {
                        'reduces-10-20': 'Price: Reduces 10-20%',
                        'reduces-20-30': 'Price: Reduces 20-30%',
                        'reduces-30-plus': 'Price: Reduces 30%+',
                        'similar': 'Price: Similar',
                        'increases-10-20': 'Price: Increases 10-20%',
                        'increases-20-plus': 'Price: Increases 20%+'
                    };
                    parts.push(priceLabels[priceImpact.value] || priceImpact.value);
                }
                
                if (leadTimeImpact && leadTimeImpact.value) {
                    var leadTimeLabels = {
                        'reduces-1-2w': 'Lead Time: Reduces 1-2 weeks',
                        'reduces-2-4w': 'Lead Time: Reduces 2-4 weeks',
                        'reduces-4w-plus': 'Lead Time: Reduces 4+ weeks',
                        'similar': 'Lead Time: Similar',
                        'increases-1-2w': 'Lead Time: Increases 1-2 weeks',
                        'increases-2w-plus': 'Lead Time: Increases 2+ weeks'
                    };
                    parts.push(leadTimeLabels[leadTimeImpact.value] || leadTimeImpact.value);
                }
                
                if (parts.length > 0) {
                    preview.textContent = parts.join(' | ');
                    preview.style.color = '#00ff00';
                    preview.style.fontStyle = 'normal';
                } else {
                    preview.textContent = 'Fill in the fields above to generate preview...';
                    preview.style.color = '#999';
                    preview.style.fontStyle = 'italic';
                }
            }
            
            window.updateSmartAltPreviewModal = updateSmartAltPreviewModal;
            window.removeBidPhotoEmbedded = removeBidPhotoEmbedded;
            
            // Attach event listeners
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.n88-open-bid-modal').forEach(function(button) {
                    button.addEventListener('click', function(e) {
                        var itemId = this.getAttribute('data-item-id');
                        var actionBadge = this.getAttribute('data-action-badge');
                        
                        // M6: Block if expired
                        if (actionBadge === 'expired') {
                            e.preventDefault();
                            e.stopPropagation();
                            alert('This RFQ is no longer accepting bids.');
                            return false;
                        }
                        
                        openBidModal(itemId);
                    });
                });
                
                // Close modal on backdrop click
                var modal = document.getElementById('n88-supplier-bid-modal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeBidModal();
                        }
                    });
                }
                
                // Close bid form modal on backdrop click
                var bidFormModal = document.getElementById('n88-supplier-bid-form-modal');
                if (bidFormModal) {
                    bidFormModal.addEventListener('click', function(e) {
                        if (e.target === bidFormModal) {
                            closeBidFormModal();
                        }
                    });
                }
            });
            
            // Expose to global scope
            window.openBidModal = openBidModal;
            window.closeBidModal = closeBidModal;
            // Withdraw bid function (Commit 2.3.5)
            function withdrawBid(itemId) {
                if (!confirm('Are you sure you want to withdraw your bid? You will be able to resubmit a new bid after withdrawal.')) {
                    return;
                }
                
                var formData = new FormData();
                formData.append('action', 'n88_withdraw_supplier_bid');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_withdraw_supplier_bid' ); ?>');
                
                var ajaxUrl = typeof ajaxurl !== 'undefined' ? ajaxurl : '<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>';
                fetch(ajaxUrl, {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        alert(data.data.message || 'Bid withdrawn successfully.');
                        // Commit 2.3.5.5: Refresh the item detail modal immediately to show updated state
                        closeBidModal();
                        setTimeout(function() {
                            openBidModal(itemId);
                        }, 100);
                    } else {
                        alert(data.data.message || 'Failed to withdraw bid. Please try again.');
                    }
                })
                .catch(function(error) {
                    console.error('Error withdrawing bid:', error);
                    alert('An error occurred while withdrawing the bid. Please try again.');
                });
            }
            
            window.openBidFormModal = openBidFormModal;
            window.closeBidFormModal = closeBidFormModal;
            window.addVideoLink = addVideoLink;
            window.removeVideoLink = removeVideoLink;
            window.validateVideoLink = validateVideoLink;
            window.validateBidForm = validateBidForm;
            window.withdrawBid = withdrawBid;
            window.validateAndSubmitBid = validateAndSubmitBid;
            window.openSupplierImageLightbox = openSupplierImageLightbox;
            window.closeSupplierImageLightbox = closeSupplierImageLightbox;
            window.handleBidPhotosChange = handleBidPhotosChange;
            window.removeBidPhoto = removeBidPhoto;
            window.removeBidPhotoEmbedded = removeBidPhotoEmbedded;
        })();
        </script>
        <?php
        return ob_get_clean();
    }

    /**
     * Render admin queue page (Commit 2.2.3)
     */
    public function render_admin_queue( $atts = array() ) {
        // Allow admins to edit pages even if they don't have system operator role
        if ( is_admin() && current_user_can( 'edit_pages' ) ) {
            return '<p><em>Admin Queue page - This shortcode will display the admin queue for system operators.</em></p>';
        }

        // Check if user is logged in and is a system operator
        if ( ! is_user_logged_in() ) {
            wp_redirect( home_url( '/login/' ) );
            exit;
        }

        $current_user = wp_get_current_user();
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_system_operator ) {
            wp_die( 'Access denied. System Operator account required.', 'Access Denied', array( 'response' => 403 ) );
        }

        $scope = isset( $_GET['scope'] ) ? sanitize_text_field( wp_unslash( $_GET['scope'] ) ) : 'global';
        
        // Read filter values from URL query parameters
        // These values are restored on page refresh, ensuring filter state persists across page reloads
        // This works for all user types: supplier, admin, and designer
        $queue_type = isset( $_GET['queue_type'] ) ? sanitize_text_field( wp_unslash( $_GET['queue_type'] ) ) : 'pricing';
        $status = isset( $_GET['status'] ) ? sanitize_text_field( wp_unslash( $_GET['status'] ) ) : 'all';
        $supplier_id = isset( $_GET['supplier_id'] ) ? sanitize_text_field( wp_unslash( $_GET['supplier_id'] ) ) : 'all';
        $designer_id = isset( $_GET['designer_id'] ) ? sanitize_text_field( wp_unslash( $_GET['designer_id'] ) ) : 'all';
        $search = isset( $_GET['search'] ) ? sanitize_text_field( wp_unslash( $_GET['search'] ) ) : '';

        ob_start();
        ?>
        <div class="n88-admin-queue" style="max-width: 1400px; margin: 0 auto; padding: 40px 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                <h1 style="margin: 0; font-size: 24px; font-weight: 600; color: #333;"> Super Admin Assembly Line</h1>
                <div style="font-size: 14px; color: #666;">
                    Logged in: <?php echo esc_html( $current_user->display_name ); ?>
                </div>
            </div>
            
            <!-- Filters Section -->
            <div style="margin-bottom: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 4px;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 15px; color: #333;">Filters:</div>
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 14px; color: #666;">Queue Type</label>
                        <select id="n88-admin-queue-type" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: #fff; cursor: pointer; min-width: 120px;">
                            <option value="pricing" <?php selected( $queue_type, 'pricing' ); ?>>Pricing</option>
                            <option value="prototype" <?php selected( $queue_type, 'prototype' ); ?>>Prototype</option>
                            <option value="shipping" <?php selected( $queue_type, 'shipping' ); ?>>Shipping</option>
                            <option value="all" <?php selected( $queue_type, 'all' ); ?>>All</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 14px; color: #666;">Status</label>
                        <select id="n88-admin-status" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: #fff; cursor: pointer; min-width: 120px;">
                            <option value="all" <?php selected( $status, 'all' ); ?>>All</option>
                            <option value="pending" <?php selected( $status, 'pending' ); ?>>Pending</option>
                            <option value="assigned" <?php selected( $status, 'assigned' ); ?>>Assigned</option>
                            <option value="in_progress" <?php selected( $status, 'in_progress' ); ?>>In Progress</option>
                            <option value="completed" <?php selected( $status, 'completed' ); ?>>Completed</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 14px; color: #666;">Maker</label>
                        <select id="n88-admin-supplier" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: #fff; cursor: pointer; min-width: 120px;">
                            <option value="all" <?php selected( $supplier_id, 'all' ); ?>>All</option>
                            <option value="supplier_x" <?php selected( $supplier_id, 'supplier_x' ); ?>>Supplier X</option>
                            <option value="supplier_y" <?php selected( $supplier_id, 'supplier_y' ); ?>>Supplier Y</option>
                            <option value="unassigned" <?php selected( $supplier_id, 'unassigned' ); ?>>Unassigned</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 14px; color: #666;">Creator</label>
                        <select id="n88-admin-designer" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: #fff; cursor: pointer; min-width: 120px;">
                            <option value="all" <?php selected( $designer_id, 'all' ); ?>>All</option>
                            <option value="sarah" <?php selected( $designer_id, 'sarah' ); ?>>Sarah (Firm A)</option>
                            <option value="vikram" <?php selected( $designer_id, 'vikram' ); ?>>Vikram (Firm B)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Queue Heading -->
            <div style="margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #333;">Global Item Queue (item-centric)</h2>
            </div>
            
            <!-- Items Table -->
            <div style="background-color: #fff; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 20px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                            <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #333; border-right: 1px solid #e0e0e0;">Item</th>
                            <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #333; border-right: 1px solid #e0e0e0;">Item Title</th>
                            <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #333; border-right: 1px solid #e0e0e0;">Request Type</th>
                            <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #333; border-right: 1px solid #e0e0e0;">Creator</th>
                            <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #333; border-right: 1px solid #e0e0e0;">Maker</th>
                            <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #333;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Demo data from wireframe -->
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 15px; font-size: 14px; color: #ff6600; font-weight: 500;">#1023</td>
                            <td style="padding: 15px; font-size: 14px; color: #333;">Curved Sofa</td>
                            <td style="padding: 15px; font-size: 14px; color: #666;">Pricing Req</td>
                            <td style="padding: 15px; font-size: 14px; color: #666;">Sarah (Firm A)</td>
                            <td style="padding: 15px; font-size: 14px; color: #999;">(Unassigned)</td>
                            <td style="padding: 15px;">
                                <button class="n88-open-admin-modal" data-item-id="1023" data-item-title="Curved Sofa" data-request-type="Pricing Req" data-supplier="Unassigned" style="padding: 6px 12px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                    Open â–º
                                </button>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 15px; font-size: 14px; color: #ff6600; font-weight: 500;">#1027</td>
                            <td style="padding: 15px; font-size: 14px; color: #333;">Dining Chair</td>
                            <td style="padding: 15px; font-size: 14px; color: #666;">Pricing Req</td>
                            <td style="padding: 15px; font-size: 14px; color: #666;">Sarah (Firm A)</td>
                            <td style="padding: 15px; font-size: 14px; color: #666;">Supplier X</td>
                            <td style="padding: 15px;">
                                <button class="n88-open-admin-modal" data-item-id="1027" data-item-title="Dining Chair" data-request-type="Pricing Req" data-supplier="Supplier X" style="padding: 6px 12px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                    Open â–º
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 15px; font-size: 14px; color: #ff6600; font-weight: 500;">#1031</td>
                            <td style="padding: 15px; font-size: 14px; color: #333;">Banquette</td>
                            <td style="padding: 15px; font-size: 14px; color: #666;">Prototype</td>
                            <td style="padding: 15px; font-size: 14px; color: #666;">Vikram (Firm B)</td>
                            <td style="padding: 15px; font-size: 14px; color: #666;">Supplier X</td>
                            <td style="padding: 15px;">
                                <button class="n88-open-admin-modal" data-item-id="1031" data-item-title="Banquette" data-request-type="Prototype" data-supplier="Supplier X" style="padding: 6px 12px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                    Open â–º
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Action Bar -->
            <div style="padding: 15px; background-color: #f9f9f9; border-radius: 4px; border-left: 4px solid #0073aa;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 14px; font-weight: 600; color: #333;">Action:</span>
                    <select class="n88-admin-action-select" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: #fff; cursor: pointer; min-width: 150px;">
                        <option value="open" selected>Open</option>
                        <option value="assign">Assign Supplier</option>
                        <option value="reject">Reject</option>
                    </select>
                    <span style="font-size: 12px; color: #666; font-style: italic;">(opens drawer; does not navigate away!)</span>
                </div>
            </div>
        </div>
        
        <!-- Admin Queue Modal -->
        <div id="n88-admin-queue-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 10000; overflow: hidden;">
            <div id="n88-admin-queue-modal-content" style="position: fixed; top: 0; right: 0; width: 480px; max-width: 90vw; height: 100vh; background-color: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.2); z-index: 10001; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
        
        <script>
        (function() {
            // Filter persistence via URL query parameters
            // When filters change, update the URL. On page refresh, PHP reads these params and restores filter values
            function updateAdminQueueURL() {
                var queueType = document.getElementById('n88-admin-queue-type')?.value || 'pricing';
                var status = document.getElementById('n88-admin-status')?.value || 'all';
                var supplier = document.getElementById('n88-admin-supplier')?.value || 'all';
                var designer = document.getElementById('n88-admin-designer')?.value || 'all';
                
                var params = new URLSearchParams(window.location.search);
                
                // Preserve scope parameter
                if (params.has('scope')) {
                    // Keep existing scope
                } else {
                    params.set('scope', '<?php echo esc_js( $scope ); ?>');
                }
                
                // Only add queue_type if it's not the default 'pricing'
                if (queueType && queueType !== 'pricing') {
                    params.set('queue_type', queueType);
                } else {
                    params.delete('queue_type');
                }
                
                if (status && status !== 'all') {
                    params.set('status', status);
                } else {
                    params.delete('status');
                }
                
                if (supplier && supplier !== 'all') {
                    params.set('supplier_id', supplier);
                } else {
                    params.delete('supplier_id');
                }
                
                if (designer && designer !== 'all') {
                    params.set('designer_id', designer);
                } else {
                    params.delete('designer_id');
                }
                
                var newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                window.history.replaceState({}, '', newURL);
            }
            
            // Attach event listeners to filter elements
            document.addEventListener('DOMContentLoaded', function() {
                var queueTypeSelect = document.getElementById('n88-admin-queue-type');
                var statusSelect = document.getElementById('n88-admin-status');
                var supplierSelect = document.getElementById('n88-admin-supplier');
                var designerSelect = document.getElementById('n88-admin-designer');
                
                if (queueTypeSelect) {
                    queueTypeSelect.addEventListener('change', updateAdminQueueURL);
                }
                if (statusSelect) {
                    statusSelect.addEventListener('change', updateAdminQueueURL);
                }
                if (supplierSelect) {
                    supplierSelect.addEventListener('change', updateAdminQueueURL);
                }
                if (designerSelect) {
                    designerSelect.addEventListener('change', updateAdminQueueURL);
                }
            });
            
            // Demo item data for admin queue
            var adminItems = {
                '1023': {
                    id: '1023',
                    title: 'Curved Sofa',
                    category: 'Upholstery',
                    requestType: 'Pricing Request',
                    supplier: 'Unassigned',
                    quantity: '--',
                    dims: { w: '--', d: '--', h: '--', unit: '--' },
                    normalized: { w: '--', d: '--', h: '--' },
                    cbm: '----',
                    sourcing_type: '--------',
                    timeline_type: '--------'
                },
                '1027': {
                    id: '1027',
                    title: 'Dining Chair',
                    category: 'Casegoods',
                    requestType: 'Pricing Request',
                    supplier: 'Supplier X',
                    quantity: '--',
                    dims: { w: '--', d: '--', h: '--', unit: '--' },
                    normalized: { w: '--', d: '--', h: '--' },
                    cbm: '----',
                    sourcing_type: '--------',
                    timeline_type: '--------'
                },
                '1031': {
                    id: '1031',
                    title: 'Banquette',
                    category: 'Upholstery',
                    requestType: 'Prototype',
                    supplier: 'Supplier X',
                    quantity: '--',
                    dims: { w: '--', d: '--', h: '--', unit: '--' },
                    normalized: { w: '--', d: '--', h: '--' },
                    cbm: '----',
                    sourcing_type: '--------',
                    timeline_type: '--------'
                }
            };
            
            function openAdminModal(itemId) {
                var item = adminItems[itemId];
                if (!item) {
                    // Try to get data from button attributes
                    var button = document.querySelector('.n88-open-admin-modal[data-item-id="' + itemId + '"]');
                    if (button) {
                        item = {
                            id: itemId,
                            title: button.getAttribute('data-item-title') || 'Item',
                            requestType: button.getAttribute('data-request-type') || 'Pricing Request',
                            supplier: button.getAttribute('data-supplier') || 'Unassigned',
                            quantity: '--',
                            dims: { w: '--', d: '--', h: '--', unit: '--' },
                            normalized: { w: '--', d: '--', h: '--' },
                            cbm: '----',
                            sourcing_type: '--------',
                            timeline_type: '--------'
                        };
                    } else {
                        return;
                    }
                }
                
                var modal = document.getElementById('n88-admin-queue-modal');
                var modalContent = document.getElementById('n88-admin-queue-modal-content');
                
                if (!modal || !modalContent) return;
                
                // Build modal HTML - Admin Queue Modal (matching wireframe exactly)
                var modalHTML = '<div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background-color: #fff;">' +
                    '<h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #333;">Item #' + item.id + ' <span style="color: #666; font-weight: 400;">(Operator View)</span></h2>' +
                    '<button onclick="closeAdminModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #666; line-height: 1;">Ã—</button>' +
                    '</div>' +
                    '<div style="flex: 1; overflow-y: auto; padding: 0; background-color: #fff;">' +
                    '<div style="padding: 20px;">' +
                    // READ-ONLY PLACEHOLDER text
                    '<div style="margin-bottom: 24px; padding: 12px; background-color: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">' +
                    '<div style="font-size: 13px; color: #856404; font-weight: 500;">READ-ONLY PLACEHOLDER <span style="color: #ff6600;">(Phase 2.2.x)</span></div>' +
                    '</div>' +
                    // Supplier
                    '<div style="margin-bottom: 16px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #666;">Supplier:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #333;">' + item.supplier + '</div>' +
                    '</div>' +
                    // Queue Type
                    '<div style="margin-bottom: 24px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #666;">Queue Type:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #333;">' + item.requestType + '</div>' +
                    '</div>' +
                    // Item Facts (read-only)
                    '<div style="margin-bottom: 24px;">' +
                    '<h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; color: #333; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px;">Item Facts (read-only)</h3>' +
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #666;">Title:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #333;">' + item.title + '</div>' +
                    '</div>' +
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #666;">Category:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #333;">' + (item.category || 'Upholstery') + '</div>' +
                    '</div>' +
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #666;">Qty:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #999;">' + item.quantity + '</div>' +
                    '</div>' +
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #666;">Dims:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #999;">W' + item.dims.w + ' D' + item.dims.d + ' H' + item.dims.h + ' Unit: ' + item.dims.unit + '</div>' +
                    '</div>' +
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #666;">Normalized (cm):</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #999;">W' + item.normalized.w + ' D' + item.normalized.d + ' H' + item.normalized.h + '</div>' +
                    '</div>' +
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #666;">CBM:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #999;">' + item.cbm + '</div>' +
                    '</div>' +
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #666;">sourcing_type:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #999;">' + item.sourcing_type + '</div>' +
                    '</div>' +
                    '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #666;">timeline_type:</label>' +
                    '<div style="padding: 10px 12px; background-color: #f5f5f5; border-radius: 4px; font-size: 14px; border: 1px solid #e0e0e0; color: #999;">' + item.timeline_type + '</div>' +
                    '</div>' +
                    '</div>' +
                    // References
                    '<div style="margin-bottom: 24px;">' +
                    '<label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #666;">References (thumbs if exist):</label>' +
                    '<div style="display: flex; gap: 12px; flex-wrap: wrap;">' +
                    '<div style="width: 100px; height: 100px; background-color: #f0f0f0; border: 2px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">[thumb]</div>' +
                    '<div style="width: 100px; height: 100px; background-color: #f0f0f0; border: 2px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">[thumb]</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    // Footer
                    '<div style="padding: 20px; border-top: 1px solid #e0e0e0; background-color: #fff;">' +
                    '<div style="font-size: 12px; color: #999; font-style: italic; text-align: center;">(No bids UI. No prototype payments UI.)</div>' +
                    '</div>';
                
                modalContent.innerHTML = modalHTML;
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeAdminModal() {
                var modal = document.getElementById('n88-admin-queue-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }
            
            // Attach event listeners
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.n88-open-admin-modal').forEach(function(button) {
                    button.addEventListener('click', function() {
                        var itemId = this.getAttribute('data-item-id');
                        openAdminModal(itemId);
                    });
                });
                
                // Close modal on backdrop click
                var modal = document.getElementById('n88-admin-queue-modal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeAdminModal();
                        }
                    });
                }
            });
            
            // Expose to global scope
            window.openAdminModal = openAdminModal;
            window.closeAdminModal = closeAdminModal;
        })();
        </script>
        <?php
        return ob_get_clean();
    }

    /**
     * Get countries list
     */
    private function get_countries_list() {
        return array(
            'US' => 'United States',
            'CA' => 'Canada',
            'GB' => 'United Kingdom',
            'AU' => 'Australia',
            'DE' => 'Germany',
            'FR' => 'France',
            'IT' => 'Italy',
            'ES' => 'Spain',
            'NL' => 'Netherlands',
            'BE' => 'Belgium',
            'CH' => 'Switzerland',
            'AT' => 'Austria',
            'SE' => 'Sweden',
            'NO' => 'Norway',
            'DK' => 'Denmark',
            'FI' => 'Finland',
            'PL' => 'Poland',
            'CZ' => 'Czech Republic',
            'IE' => 'Ireland',
            'PT' => 'Portugal',
            'GR' => 'Greece',
            'IN' => 'India',
            'CN' => 'China',
            'JP' => 'Japan',
            'KR' => 'South Korea',
            'SG' => 'Singapore',
            'MY' => 'Malaysia',
            'TH' => 'Thailand',
            'ID' => 'Indonesia',
            'PH' => 'Philippines',
            'VN' => 'Vietnam',
            'AE' => 'United Arab Emirates',
            'SA' => 'Saudi Arabia',
            'ZA' => 'South Africa',
            'BR' => 'Brazil',
            'MX' => 'Mexico',
            'AR' => 'Argentina',
            'CL' => 'Chile',
            'CO' => 'Colombia',
            'NZ' => 'New Zealand',
        );
    }

    /**
     * Get country name by code
     */
    private function get_country_name( $code ) {
        $countries = $this->get_countries_list();
        return isset( $countries[ $code ] ) ? $countries[ $code ] : $code;
    }

    /**
     * Commit 2.3.8: Map country code to origin_region for duty calculation
     * 
     * @param string $country_code 2-letter country code (e.g., 'US', 'CN', 'IN')
     * @return string|null Origin region: 'USA', 'CANADA', 'ASIA', 'EUROPE', 'MIDDLE_EAST', 'OTHER', or null
     */
    private function map_country_to_origin_region( $country_code ) {
        if ( empty( $country_code ) ) {
            return null;
        }
        
        $country_code = strtoupper( trim( $country_code ) );
        
        // USA
        if ( $country_code === 'US' ) {
            return 'USA';
        }
        
        // Canada
        if ( $country_code === 'CA' ) {
            return 'CANADA';
        }
        
        // Asia countries
        $asia_countries = array(
            'CN', // China
            'IN', // India
            'JP', // Japan
            'KR', // South Korea
            'SG', // Singapore
            'MY', // Malaysia
            'TH', // Thailand
            'ID', // Indonesia
            'PH', // Philippines
            'VN', // Vietnam
            'TW', // Taiwan
            'HK', // Hong Kong
            'BD', // Bangladesh
            'PK', // Pakistan
            'LK', // Sri Lanka
            'MM', // Myanmar
            'KH', // Cambodia
            'LA', // Laos
            'MN', // Mongolia
            'NP', // Nepal
        );
        if ( in_array( $country_code, $asia_countries, true ) ) {
            return 'ASIA';
        }
        
        // Europe countries
        $europe_countries = array(
            'GB', // United Kingdom
            'DE', // Germany
            'FR', // France
            'IT', // Italy
            'ES', // Spain
            'NL', // Netherlands
            'BE', // Belgium
            'CH', // Switzerland
            'AT', // Austria
            'SE', // Sweden
            'NO', // Norway
            'DK', // Denmark
            'FI', // Finland
            'PL', // Poland
            'CZ', // Czech Republic
            'IE', // Ireland
            'PT', // Portugal
            'GR', // Greece
            'RO', // Romania
            'HU', // Hungary
            'BG', // Bulgaria
            'HR', // Croatia
            'SK', // Slovakia
            'SI', // Slovenia
            'LT', // Lithuania
            'LV', // Latvia
            'EE', // Estonia
        );
        if ( in_array( $country_code, $europe_countries, true ) ) {
            return 'EUROPE';
        }
        
        // Middle East countries
        $middle_east_countries = array(
            'AE', // United Arab Emirates
            'SA', // Saudi Arabia
            'IL', // Israel
            'TR', // Turkey
            'IQ', // Iraq
            'IR', // Iran
            'JO', // Jordan
            'LB', // Lebanon
            'KW', // Kuwait
            'OM', // Oman
            'QA', // Qatar
            'BH', // Bahrain
            'YE', // Yemen
        );
        if ( in_array( $country_code, $middle_east_countries, true ) ) {
            return 'MIDDLE_EAST';
        }
        
        // Default to OTHER for all other countries
        return 'OTHER';
    }

    /**
     * Render a styled 403 error page (Commit 2.2.1)
     */
    private static function render_403_error( $title, $message ) {
        // Set HTTP status code
        status_header( 403 );
        nocache_headers();

        // Get site name
        $site_name = get_bloginfo( 'name' );
        $home_url = home_url( '/' );

        ?>
        <!DOCTYPE html>
        <html <?php language_attributes(); ?>>
        <head>
            <meta charset="<?php bloginfo( 'charset' ); ?>">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title><?php echo esc_html( $title ); ?> - <?php echo esc_html( $site_name ); ?></title>
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                .error-container {
                    background: #ffffff;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    max-width: 500px;
                    width: 100%;
                    padding: 50px 40px;
                    text-align: center;
                }
                .error-code {
                    font-size: 72px;
                    font-weight: bold;
                    color: #e74c3c;
                    line-height: 1;
                    margin-bottom: 20px;
                }
                .error-title {
                    font-size: 28px;
                    font-weight: 600;
                    color: #2c3e50;
                    margin-bottom: 15px;
                }
                .error-message {
                    font-size: 16px;
                    color: #7f8c8d;
                    line-height: 1.6;
                    margin-bottom: 30px;
                }
                .error-actions {
                    margin-top: 30px;
                }
                .btn {
                    display: inline-block;
                    padding: 12px 30px;
                    background: #667eea;
                    color: #ffffff;
                    text-decoration: none;
                    border-radius: 6px;
                    font-weight: 500;
                    transition: background 0.3s ease;
                }
                .btn:hover {
                    background: #5568d3;
                }
                .btn-secondary {
                    background: #95a5a6;
                    margin-left: 10px;
                }
                .btn-secondary:hover {
                    background: #7f8c8d;
                }
            </style>
        </head>
        <body>
            <div class="error-container">
                <div class="error-code">403</div>
                <h1 class="error-title"><?php echo esc_html( $title ); ?></h1>
                <p class="error-message"><?php echo esc_html( $message ); ?></p>
                <div class="error-actions">
                    <a href="<?php echo esc_url( $home_url ); ?>" class="btn">Go to Homepage</a>
                    <?php if ( is_user_logged_in() ) : ?>
                        <?php
                        $current_user = wp_get_current_user();
                        $redirect_url = self::get_role_redirect_url_static( $current_user );
                        if ( $redirect_url ) :
                        ?>
                            <a href="<?php echo esc_url( $redirect_url ); ?>" class="btn btn-secondary">Go to Dashboard</a>
                        <?php endif; ?>
                    <?php endif; ?>
                </div>
            </div>
        </body>
        </html>
        <?php
    }

    /**
     * Render supplier onboarding form (Commit 2.2.7)
     */
    public function render_supplier_onboarding( $atts = array() ) {
        // Allow admins to edit pages even if they don't have supplier role
        if ( is_admin() && current_user_can( 'edit_pages' ) ) {
            return '<p><em>Supplier Onboarding page - This shortcode will display the supplier onboarding form.</em></p>';
        }

        // Check if user is logged in and is a supplier admin
        if ( ! is_user_logged_in() ) {
            wp_redirect( home_url( '/login/' ) );
            exit;
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        
        if ( ! $is_supplier ) {
            wp_die( 'Access denied. Maker account required.', 'Access Denied', array( 'response' => 403 ) );
        }

        global $wpdb;
        $categories_table = $wpdb->prefix . 'n88_categories';
        $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
        $supplier_keyword_map_table = $wpdb->prefix . 'n88_supplier_keyword_map';
        
        // Fetch active categories
        $categories = $wpdb->get_results(
            "SELECT category_id, name FROM {$categories_table} WHERE is_active = 1 ORDER BY name"
        );

        // Check if profile exists and fetch existing data (Commit 2.2.7)
        $existing_profile = $wpdb->get_row( $wpdb->prepare(
            "SELECT * FROM {$supplier_profiles_table} WHERE supplier_id = %d",
            $current_user->ID
        ) );

        // Fetch existing selected keywords
        $existing_keyword_ids = array();
        if ( $existing_profile ) {
            $existing_keyword_ids = $wpdb->get_col( $wpdb->prepare(
                "SELECT keyword_id FROM {$supplier_keyword_map_table} WHERE supplier_id = %d",
                $current_user->ID
            ) );
        }

        $is_edit_mode = ! empty( $existing_profile );
        $form_title = $is_edit_mode ? 'Update Supplier Profile' : 'Supplier Onboarding';
        $form_description = $is_edit_mode ? 'Update your profile information.' : 'Complete your profile to enable routing and matching.';

        ob_start();
        ?>
        <div class="n88-supplier-onboarding" style="max-width: 800px; margin: 40px auto; padding: 40px 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;">
            <h1 style="margin: 0 0 30px 0; font-size: 28px; font-weight: 600; color: #333;"><?php echo esc_html( $form_title ); ?></h1>
            <p style="margin: 0 0 30px 0; font-size: 14px; color: #666;"><?php echo esc_html( $form_description ); ?></p>
            
            <form id="n88-supplier-onboarding-form" style="background-color: #fff; padding: 30px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <?php wp_nonce_field( 'n88_save_supplier_profile', 'n88_supplier_profile_nonce' ); ?>
                
                <!-- Primary Category -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Primary Category <span style="color: #d63638;">*</span>
                    </label>
                    <select id="n88-primary-category" name="primary_category_id" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: #fff; cursor: pointer;">
                        <option value="">Select a category...</option>
                        <?php foreach ( $categories as $category ) : ?>
                            <option value="<?php echo esc_attr( $category->category_id ); ?>" <?php selected( $existing_profile && $existing_profile->primary_category_id == $category->category_id ); ?>>
                                <?php echo esc_html( $category->name ); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <!-- Suggested Keywords (filtered by category) -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Suggested Keywords
                    </label>
                    <p style="margin: 0 0 12px 0; font-size: 13px; color: #666;">Select keywords that match your capabilities. Keywords are filtered by your selected category.</p>
                    <div id="n88-keywords-container" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9;">
                        <p style="margin: 0; color: #999; font-size: 13px; font-style: italic;">Select a category first to see keywords</p>
                    </div>
                </div>

                <!-- Freeform Keywords -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Additional Keywords
                    </label>
                    <p style="margin: 0 0 12px 0; font-size: 13px; color: #666;">Enter any additional keywords that describe your capabilities (one per line). These will be reviewed before approval.<?php echo $is_edit_mode ? ' New keywords will be added to your existing ones.' : ''; ?></p>
                    <textarea id="n88-freeform-keywords" name="freeform_keywords" rows="4" placeholder="Enter keywords, one per line..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                </div>

                <!-- Capability Flags -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 12px; font-size: 14px; font-weight: 600; color: #333;">
                        Capabilities
                    </label>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="n88-prototype-video-capable" name="prototype_video_capable" value="1" <?php checked( $existing_profile && $existing_profile->prototype_video_capable == 1 ); ?> required style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 14px; color: #333;">
                                Prototype Video Capable <span style="color: #d63638;">*</span>
                            </span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="n88-cad-capable" name="cad_capable" value="1" <?php checked( $existing_profile && $existing_profile->cad_capable == 1 ); ?> style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 14px; color: #333;">CAD Capable</span>
                        </label>
                    </div>
                </div>

                <!-- Optional Capacity Fields -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 12px; font-size: 14px; font-weight: 600; color: #333;">
                        Capacity (Optional)
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">Minimum Quantity</label>
                            <input type="number" id="n88-qty-min" name="qty_min" min="0" value="<?php echo $existing_profile && $existing_profile->qty_min ? esc_attr( $existing_profile->qty_min ) : ''; ?>" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">Maximum Quantity</label>
                            <input type="number" id="n88-qty-max" name="qty_max" min="0" value="<?php echo $existing_profile && $existing_profile->qty_max ? esc_attr( $existing_profile->qty_max ) : ''; ?>" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">Lead Time Min (Days)</label>
                            <input type="number" id="n88-lead-time-min" name="lead_time_min_days" min="0" value="<?php echo $existing_profile && $existing_profile->lead_time_min_days ? esc_attr( $existing_profile->lead_time_min_days ) : ''; ?>" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">Lead Time Max (Days)</label>
                            <input type="number" id="n88-lead-time-max" name="lead_time_max_days" min="0" value="<?php echo $existing_profile && $existing_profile->lead_time_max_days ? esc_attr( $existing_profile->lead_time_max_days ) : ''; ?>" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button type="submit" id="n88-submit-profile" style="padding: 12px 24px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%;">
                        Save Profile
                    </button>
                    <div id="n88-form-message" style="margin-top: 15px; font-size: 14px; display: none;"></div>
                </div>
            </form>
        </div>

        <script>
        (function() {
            var form = document.getElementById('n88-supplier-onboarding-form');
            var categorySelect = document.getElementById('n88-primary-category');
            var keywordsContainer = document.getElementById('n88-keywords-container');
            var submitButton = document.getElementById('n88-submit-profile');
            var messageDiv = document.getElementById('n88-form-message');

            // Existing keyword IDs for prefilling (Commit 2.2.7)
            var existingKeywordIds = <?php echo json_encode( array_map( 'intval', $existing_keyword_ids ) ); ?>;

            // Function to load keywords
            function loadKeywords(categoryId, prefillIds) {
                if (!categoryId) {
                    keywordsContainer.innerHTML = '<p style="margin: 0; color: #999; font-size: 13px; font-style: italic;">Select a category first to see keywords</p>';
                    return;
                }

                keywordsContainer.innerHTML = '<p style="margin: 0; color: #666; font-size: 13px;">Loading keywords...</p>';

                // Fetch keywords for selected category
                var formData = new FormData();
                formData.append('action', 'n88_get_keywords_by_category');
                formData.append('category_id', categoryId);
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_keywords' ); ?>');

                fetch('<?php echo admin_url( 'admin-ajax.php' ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.keywords) {
                        keywordsContainer.innerHTML = '';
                        data.data.keywords.forEach(function(keyword) {
                            var label = document.createElement('label');
                            label.style.cssText = 'display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background-color: #fff; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; font-size: 13px; margin: 0;';
                            
                            var checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'selected_keywords[]';
                            checkbox.value = keyword.keyword_id;
                            checkbox.style.cssText = 'width: 16px; height: 16px; cursor: pointer; margin: 0;';
                            
                            // Prefill if this keyword was previously selected
                            if (prefillIds && prefillIds.indexOf(parseInt(keyword.keyword_id)) !== -1) {
                                checkbox.checked = true;
                            }
                            
                            var span = document.createElement('span');
                            span.textContent = keyword.keyword;
                            span.style.color = '#333';
                            
                            label.appendChild(checkbox);
                            label.appendChild(span);
                            keywordsContainer.appendChild(label);
                        });

                        if (data.data.keywords.length === 0) {
                            keywordsContainer.innerHTML = '<p style="margin: 0; color: #999; font-size: 13px; font-style: italic;">No keywords available for this category</p>';
                        }
                    } else {
                        keywordsContainer.innerHTML = '<p style="margin: 0; color: #d63638; font-size: 13px;">Error loading keywords</p>';
                    }
                })
                .catch(error => {
                    keywordsContainer.innerHTML = '<p style="margin: 0; color: #d63638; font-size: 13px;">Error loading keywords</p>';
                });
            }

            // Load keywords when category changes
            categorySelect.addEventListener('change', function() {
                loadKeywords(this.value, existingKeywordIds);
            });

            // Load keywords on page load if category is already selected (edit mode)
            <?php if ( $existing_profile && $existing_profile->primary_category_id ) : ?>
            loadKeywords(<?php echo intval( $existing_profile->primary_category_id ); ?>, existingKeywordIds);
            <?php endif; ?>

            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                var formData = new FormData(form);
                formData.append('action', 'n88_save_supplier_profile');

                submitButton.disabled = true;
                submitButton.textContent = 'Saving...';
                messageDiv.style.display = 'none';

                fetch('<?php echo admin_url( 'admin-ajax.php' ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageDiv.style.cssText = 'margin-top: 15px; font-size: 14px; display: block; padding: 12px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 4px;';
                        messageDiv.textContent = data.data.message || 'Profile saved successfully!';
                        
                        // Redirect after 2 seconds
                        setTimeout(function() {
                            window.location.href = '<?php echo esc_url( home_url( '/supplier/queue' ) ); ?>';
                        }, 2000);
                    } else {
                        messageDiv.style.cssText = 'margin-top: 15px; font-size: 14px; display: block; padding: 12px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px;';
                        messageDiv.textContent = data.data.message || 'Error saving profile. Please try again.';
                        submitButton.disabled = false;
                        submitButton.textContent = 'Save Profile';
                    }
                })
                .catch(error => {
                    messageDiv.style.cssText = 'margin-top: 15px; font-size: 14px; display: block; padding: 12px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px;';
                    messageDiv.textContent = 'Error saving profile. Please try again.';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Save Profile';
                });
            });
        })();
        </script>
        <?php
        return ob_get_clean();
    }

    /**
     * AJAX handler to fetch keywords by category (Commit 2.2.7)
     */
    public function ajax_get_keywords_by_category() {
        check_ajax_referer( 'n88_get_keywords', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        // Commit 2.3.9.1B: Allow designers to access keywords for video direction
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_designer ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ) );
        }

        $category_id = isset( $_POST['category_id'] ) ? intval( $_POST['category_id'] ) : 0;
        $category_name = isset( $_POST['category_name'] ) ? sanitize_text_field( wp_unslash( $_POST['category_name'] ) ) : '';

        global $wpdb;
        $keywords_table = $wpdb->prefix . 'n88_keywords';
        $categories_table = $wpdb->prefix . 'n88_categories';

        // If category_id not provided, try to get it from category_name (Commit 2.3.9.1B)
        // Use case-insensitive matching and also try partial matches for flexibility
        if ( ! $category_id && ! empty( $category_name ) ) {
            // Define category name mappings FIRST (before trying database lookups)
            // This ensures we map to the correct category that has keywords
            // Maps ALL dropdown categories to your comprehensive keyword categories
            $category_mappings = array(
                // Upholstery keywords
                'upholstery' => 'Upholstery',
                'sofas & seating (indoor)' => 'Upholstery',
                'sofas and seating (indoor)' => 'Upholstery',
                'chairs & armchairs (indoor)' => 'Upholstery',
                'chairs and armchairs (indoor)' => 'Upholstery',
                
                // Indoor Furniture (Casegoods) keywords
                'casegoods' => 'Indoor Furniture (Casegoods)',
                'indoor furniture' => 'Indoor Furniture (Casegoods)',
                'casegoods (beds, nightstands, desks, consoles)' => 'Indoor Furniture (Casegoods)',
                'dining tables (indoor)' => 'Indoor Furniture (Casegoods)',
                
                // Outdoor Furniture keywords
                'outdoor furniture' => 'Outdoor Furniture',
                'outdoor seating' => 'Outdoor Furniture',
                'outdoor dining sets' => 'Outdoor Furniture',
                'outdoor loungers & daybeds' => 'Outdoor Furniture',
                'outdoor loungers and daybeds' => 'Outdoor Furniture',
                'pool furniture' => 'Outdoor Furniture',
                
                // Lighting keywords
                'lighting' => 'Lighting',
                'decorative lighting' => 'Lighting',
                'architectural lighting' => 'Lighting',
                'electrical / led components' => 'Lighting',
                'electrical and led components' => 'Lighting',
                
                // Stone (Marble / Granite / Quartz) keywords
                'stone' => 'Stone (Marble / Granite / Quartz)',
                'marble' => 'Stone (Marble / Granite / Quartz)',
                'marble / stone' => 'Stone (Marble / Granite / Quartz)',
                'granite' => 'Stone (Marble / Granite / Quartz)',
                'quartz' => 'Stone (Marble / Granite / Quartz)',
                'porcelain / ceramic slabs' => 'Stone (Marble / Granite / Quartz)',
                'porcelain and ceramic slabs' => 'Stone (Marble / Granite / Quartz)',
                'tile (wall / floor)' => 'Stone (Marble / Granite / Quartz)',
                'tile (wall and floor)' => 'Stone (Marble / Granite / Quartz)',
                'terrazzo' => 'Stone (Marble / Granite / Quartz)',
                
                // Metalwork keywords
                'metalwork' => 'Metalwork',
                'railings' => 'Metalwork',
                'screens / louvers' => 'Metalwork',
                'screens and louvers' => 'Metalwork',
                
                // Millwork / Cabinetry keywords
                'millwork' => 'Millwork / Cabinetry',
                'cabinetry' => 'Millwork / Cabinetry',
                'millwork / cabinetry' => 'Millwork / Cabinetry',
                'cabinetry / millwork (custom)' => 'Millwork / Cabinetry',
                'cabinetry and millwork (custom)' => 'Millwork / Cabinetry',
                
                // Flooring keywords
                'flooring' => 'Flooring',
                
                // Drapery / Window Treatments keywords
                'drapery' => 'Drapery / Window Treatments',
                'window treatments' => 'Drapery / Window Treatments',
                'window treatments / shades' => 'Drapery / Window Treatments',
                'drapery / window treatments' => 'Drapery / Window Treatments',
                
                // Glass / Mirrors keywords
                'glass' => 'Glass / Mirrors',
                'mirrors' => 'Glass / Mirrors',
                'glass / mirrors' => 'Glass / Mirrors',
                
                // Hardware / Accessories keywords
                'hardware' => 'Hardware / Accessories',
                'accessories' => 'Hardware / Accessories',
                'hardware / accessories' => 'Hardware / Accessories',
                'faucets / hardware (plumbing)' => 'Hardware / Accessories',
                'faucets and hardware (plumbing)' => 'Hardware / Accessories',
                'bathroom fixtures' => 'Hardware / Accessories',
                'kitchen fixtures' => 'Hardware / Accessories',
                'sinks / basins' => 'Hardware / Accessories',
                'sinks and basins' => 'Hardware / Accessories',
                'shower systems / accessories' => 'Hardware / Accessories',
                'shower systems and accessories' => 'Hardware / Accessories',
                'decorative accessories' => 'Hardware / Accessories',
                
                // Rugs / Carpets keywords
                'rugs' => 'Rugs / Carpets',
                'carpets' => 'Rugs / Carpets',
                'rugs / carpets' => 'Rugs / Carpets',
                
                // Wallcoverings / Finishes keywords
                'wallcoverings' => 'Wallcoverings / Finishes',
                'wallcoverings / finishes' => 'Wallcoverings / Finishes',
                'acoustic panels' => 'Wallcoverings / Finishes',
                
                // Appliances keywords
                'appliances' => 'Appliances',
                // Other (dropdown value OTHER)
                'other' => 'Other'
            );

            // Also map dropdown values (uppercase) to DB names (Title Case) so "UPHOLSTERY" -> "Upholstery"
            $dropdown_to_db = array(
                'upholstery' => 'Upholstery',
                'indoor furniture (casegoods)' => 'Indoor Furniture (Casegoods)',
                'outdoor furniture' => 'Outdoor Furniture',
                'lighting' => 'Lighting',
                'stone (marble / granite / quartz)' => 'Stone (Marble / Granite / Quartz)',
                'metalwork' => 'Metalwork',
                'millwork / cabinetry' => 'Millwork / Cabinetry',
                'flooring' => 'Flooring',
                'drapery / window treatments' => 'Drapery / Window Treatments',
                'glass / mirrors' => 'Glass / Mirrors',
                'hardware / accessories' => 'Hardware / Accessories',
                'rugs / carpets' => 'Rugs / Carpets',
                'wallcoverings / finishes' => 'Wallcoverings / Finishes',
                'appliances' => 'Appliances',
                'other' => 'Other',
            );
            
            $category_name_lower = strtolower( trim( $category_name ) );
            $mapped_name = null;
            
            // 1) Try dropdown-to-DB mapping first (exact match on lowercase)
            if ( isset( $dropdown_to_db[ $category_name_lower ] ) ) {
                $mapped_name = $dropdown_to_db[ $category_name_lower ];
            }
            // 2) Check legacy/alias mappings
            if ( ! $mapped_name && isset( $category_mappings[ $category_name_lower ] ) ) {
                $mapped_name = $category_mappings[ $category_name_lower ];
            }
            if ( ! $mapped_name ) {
                foreach ( $category_mappings as $key => $value ) {
                    if ( strpos( $category_name_lower, $key ) !== false || strpos( $key, $category_name_lower ) !== false ) {
                        $mapped_name = $value;
                        break;
                    }
                }
            }
            
            if ( $mapped_name ) {
                $category = $wpdb->get_row( $wpdb->prepare(
                    "SELECT category_id FROM {$categories_table} WHERE name = %s LIMIT 1",
                    $mapped_name
                ) );
            }
            
            if ( ! $category ) {
                $category = $wpdb->get_row( $wpdb->prepare(
                    "SELECT category_id FROM {$categories_table} WHERE LOWER(name) = LOWER(%s) LIMIT 1",
                    $category_name
                ) );
            }
            
            if ( ! $category ) {
                $search_term = '%' . $wpdb->esc_like( $category_name ) . '%';
                $category = $wpdb->get_row( $wpdb->prepare(
                    "SELECT category_id FROM {$categories_table} WHERE LOWER(name) LIKE LOWER(%s) LIMIT 1",
                    $search_term
                ) );
            }
            
            if ( $category ) {
                $category_id = intval( $category->category_id );
            }

            // Debug log: why keywords might be empty (helps when category_name is sent but DB has no keywords)
            if ( defined( 'WP_DEBUG' ) && WP_DEBUG && function_exists( 'error_log' ) ) {
                error_log( '[n88_get_keywords_by_category] category_name=' . $category_name . ' category_name_lower=' . $category_name_lower . ' mapped_name=' . ( $mapped_name ?: '(none)' ) . ' category_id=' . ( $category_id ?: 0 ) );
            }
        }

        if ( ! $category_id ) {
            if ( defined( 'WP_DEBUG' ) && WP_DEBUG && function_exists( 'error_log' ) ) {
                error_log( '[n88_get_keywords_by_category] No category found for category_name=' . ( isset( $category_name ) ? $category_name : '' ) . ' category_id=' . ( isset( $_POST['category_id'] ) ? intval( $_POST['category_id'] ) : 0 ) );
            }
            wp_send_json_error( array( 'message' => 'Category ID or Category Name required.' ) );
        }

        $keywords = $wpdb->get_results( $wpdb->prepare(
            "SELECT keyword_id, keyword FROM {$keywords_table} WHERE category_id = %d AND is_active = 1 ORDER BY keyword",
            $category_id
        ) );

        if ( empty( $keywords ) && defined( 'WP_DEBUG' ) && WP_DEBUG && function_exists( 'error_log' ) ) {
            $db_name = $wpdb->get_var( $wpdb->prepare( "SELECT name FROM {$categories_table} WHERE category_id = %d", $category_id ) );
            error_log( '[n88_get_keywords_by_category] No keywords in DB for category_id=' . $category_id . ' name=' . ( $db_name ?: '' ) . '. Ensure plugin activation/install has run so seed_keyword_library() inserts keywords for this category.' );
        }

        wp_send_json_success( array( 'keywords' => $keywords ) );
    }

    /**
     * AJAX handler to save supplier profile (Commit 2.2.7)
     */
    public function ajax_save_supplier_profile() {
        check_ajax_referer( 'n88_save_supplier_profile', 'n88_supplier_profile_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        if ( ! in_array( 'n88_supplier_admin', $current_user->roles, true ) ) {
            wp_send_json_error( array( 'message' => 'Access denied. Supplier Admin account required.' ) );
        }

        $user_id = $current_user->ID;

        // Get and sanitize form data
        $primary_category_id = isset( $_POST['primary_category_id'] ) ? intval( $_POST['primary_category_id'] ) : 0;
        $selected_keywords = isset( $_POST['selected_keywords'] ) ? array_map( 'intval', (array) $_POST['selected_keywords'] ) : array();
        $freeform_keywords = isset( $_POST['freeform_keywords'] ) ? sanitize_textarea_field( wp_unslash( $_POST['freeform_keywords'] ) ) : '';
        $prototype_video_capable = isset( $_POST['prototype_video_capable'] ) ? 1 : 0;
        $cad_capable = isset( $_POST['cad_capable'] ) ? 1 : 0;
        $qty_min = isset( $_POST['qty_min'] ) ? intval( $_POST['qty_min'] ) : null;
        $qty_max = isset( $_POST['qty_max'] ) ? intval( $_POST['qty_max'] ) : null;
        $lead_time_min_days = isset( $_POST['lead_time_min_days'] ) ? intval( $_POST['lead_time_min_days'] ) : null;
        $lead_time_max_days = isset( $_POST['lead_time_max_days'] ) ? intval( $_POST['lead_time_max_days'] ) : null;
        
        // Commit 2.3.8: Get origin_region from country selected during signup
        $country_code = get_user_meta( $user_id, 'country', true );
        $origin_region = $this->map_country_to_origin_region( $country_code );

        // Validate required fields
        if ( ! $primary_category_id ) {
            wp_send_json_error( array( 'message' => 'Primary category is required.' ) );
        }

        if ( ! $prototype_video_capable ) {
            wp_send_json_error( array( 'message' => 'Prototype video capability is required.' ) );
        }

        global $wpdb;
        $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
        $supplier_keyword_map_table = $wpdb->prefix . 'n88_supplier_keyword_map';
        $supplier_keyword_freeform_table = $wpdb->prefix . 'n88_supplier_keyword_freeform';
        $categories_table = $wpdb->prefix . 'n88_categories';

        // Verify category exists
        $category_exists = $wpdb->get_var( $wpdb->prepare(
            "SELECT category_id FROM {$categories_table} WHERE category_id = %d AND is_active = 1",
            $primary_category_id
        ) );

        if ( ! $category_exists ) {
            wp_send_json_error( array( 'message' => 'Invalid category selected.' ) );
        }

        // Verify selected keywords exist and belong to the selected category
        if ( ! empty( $selected_keywords ) ) {
            $keywords_table = $wpdb->prefix . 'n88_keywords';
            $placeholders = implode( ',', array_fill( 0, count( $selected_keywords ), '%d' ) );
            $query = $wpdb->prepare(
                "SELECT keyword_id FROM {$keywords_table} WHERE keyword_id IN ($placeholders) AND category_id = %d AND is_active = 1",
                array_merge( $selected_keywords, array( $primary_category_id ) )
            );
            $valid_keywords = $wpdb->get_col( $query );
            $selected_keywords = array_intersect( $selected_keywords, $valid_keywords );
        }

        // Start transaction (using WordPress transaction pattern)
        $wpdb->query( 'START TRANSACTION' );

        try {
            // Save or update supplier profile
            $existing_profile = $wpdb->get_var( $wpdb->prepare(
                "SELECT supplier_id FROM {$supplier_profiles_table} WHERE supplier_id = %d",
                $user_id
            ) );

            $profile_data = array(
                'supplier_id' => $user_id,
                'primary_category_id' => $primary_category_id,
                'prototype_video_capable' => $prototype_video_capable,
                'cad_capable' => $cad_capable,
                'qty_min' => $qty_min ? $qty_min : null,
                'qty_max' => $qty_max ? $qty_max : null,
                'lead_time_min_days' => $lead_time_min_days ? $lead_time_min_days : null,
                'lead_time_max_days' => $lead_time_max_days ? $lead_time_max_days : null,
                'origin_region' => $origin_region, // Commit 2.3.8: Save origin_region for duty calculation
            );

            if ( $existing_profile ) {
                // Update existing profile
                $wpdb->update(
                    $supplier_profiles_table,
                    $profile_data,
                    array( 'supplier_id' => $user_id ),
                    array( '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%s' ), // Added %s for origin_region
                    array( '%d' )
                );
            } else {
                // Insert new profile (minimal required fields)
                $profile_data['company_name'] = $current_user->display_name ? $current_user->display_name : 'Supplier';
                $wpdb->insert(
                    $supplier_profiles_table,
                    $profile_data,
                    array( '%d', '%s', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%s' ) // Added %s for origin_region
                );
            }

            // Delete existing keyword mappings for this supplier
            $wpdb->delete(
                $supplier_keyword_map_table,
                array( 'supplier_id' => $user_id ),
                array( '%d' )
            );

            // Insert new keyword mappings
            if ( ! empty( $selected_keywords ) ) {
                foreach ( $selected_keywords as $keyword_id ) {
                    $wpdb->insert(
                        $supplier_keyword_map_table,
                        array(
                            'supplier_id' => $user_id,
                            'keyword_id' => $keyword_id,
                        ),
                        array( '%d', '%d' )
                    );
                }
            }

            // Process freeform keywords
            if ( ! empty( $freeform_keywords ) ) {
                $freeform_lines = array_filter( array_map( 'trim', explode( "\n", $freeform_keywords ) ) );
                foreach ( $freeform_lines as $freeform_keyword ) {
                    if ( ! empty( $freeform_keyword ) ) {
                        $wpdb->insert(
                            $supplier_keyword_freeform_table,
                            array(
                                'supplier_id' => $user_id,
                                'freeform_keyword' => $freeform_keyword,
                                'status' => 'pending',
                                'created_at' => current_time( 'mysql' ),
                            ),
                            array( '%d', '%s', '%s', '%s' )
                        );
                    }
                }
            }

            $wpdb->query( 'COMMIT' );

            wp_send_json_success( array(
                'message' => 'Profile saved successfully!',
            ) );

        } catch ( Exception $e ) {
            $wpdb->query( 'ROLLBACK' );
            wp_send_json_error( array(
                'message' => 'Error saving profile. Please try again.',
            ) );
        }
    }

    /**
     * Static version of get_role_redirect_url for use in error pages (updated Commit 2.2.7)
     * Commit 2.3.9.1C: System operators redirect to operator queue
     */
    private static function get_role_redirect_url_static( $user ) {
        if ( ! $user || ! isset( $user->roles ) ) {
            return null;
        }

        // Check roles in priority order
        // Commit 2.3.9.1C: System operators redirect to operator queue
        if ( in_array( 'n88_system_operator', $user->roles, true ) ) {
            $operator_queue_page_id = get_option( 'n88_rfq_operator_queue_page_id' );
            if ( $operator_queue_page_id ) {
                $operator_queue_url = get_permalink( $operator_queue_page_id );
                if ( $operator_queue_url ) {
                    return $operator_queue_url;
                }
            }
            // Fallback to /operator/queue if page ID not found
            return home_url( '/operator/queue/' );
        }
        
        if ( in_array( 'n88_supplier_admin', $user->roles, true ) ) {
            // Commit 2.2.7: Check if supplier profile is incomplete
            global $wpdb;
            $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
            $profile_exists = $wpdb->get_var( $wpdb->prepare(
                "SELECT supplier_id FROM {$supplier_profiles_table} WHERE supplier_id = %d",
                $user->ID
            ) );
            
            // If profile doesn't exist, redirect to onboarding
            if ( ! $profile_exists ) {
                return home_url( '/supplier/onboarding' );
            }
            
            // Otherwise, redirect to queue
            return home_url( '/supplier/queue' );
        }
        
        if ( in_array( 'n88_designer', $user->roles, true ) || in_array( 'designer', $user->roles, true ) ) {
            // Commit 2.2.8: Check if designer profile is incomplete
            global $wpdb;
            $designer_profiles_table = $wpdb->prefix . 'n88_designer_profiles_v2';
            
            // Check if profile exists - use COUNT for more reliable check
            // Suppress errors in case table doesn't exist yet
            $wpdb->suppress_errors( true );
            $profile_count = $wpdb->get_var( $wpdb->prepare(
                "SELECT COUNT(*) FROM {$designer_profiles_table} WHERE designer_id = %d",
                $user->ID
            ) );
            $wpdb->suppress_errors( false );
            
            // If profile doesn't exist (count is false, null, or 0), redirect to onboarding
            if ( $profile_count === false || $profile_count === null || (int) $profile_count === 0 ) {
                return home_url( '/designer/onboarding' );
            }
            
            // Otherwise, redirect to workspace
            return home_url( '/workspace' );
        }

        return null;
    }


    /**
     * Render designer onboarding form (Commit 2.2.8)
     */
    public function render_designer_onboarding( $atts = array() ) {
        // Allow admins to edit pages even if they don't have designer role
        if ( is_admin() && current_user_can( 'edit_pages' ) ) {
            return '<p><em>Creator Onboarding page - This shortcode will display the creator onboarding form.</em></p>';
        }

        // Check if user is logged in and is a designer
        if ( ! is_user_logged_in() ) {
            wp_redirect( home_url( '/login/' ) );
            exit;
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        if ( ! $is_designer ) {
            wp_die( 'Access denied. Creator account required.', 'Access Denied', array( 'response' => 403 ) );
        }

        global $wpdb;
        $designer_profiles_table = $wpdb->prefix . 'n88_designer_profiles_v2';
        $designer_practice_map_table = $wpdb->prefix . 'n88_designer_practice_map';
        $practice_types_table = $wpdb->prefix . 'n88_practice_types';
        
        // Check if profile exists and fetch existing data
        $existing_profile = $wpdb->get_row( $wpdb->prepare(
            "SELECT * FROM {$designer_profiles_table} WHERE designer_id = %d",
            $current_user->ID
        ) );

        // Fetch existing selected practice types
        $existing_practice_ids = array();
        if ( $existing_profile ) {
            $existing_practice_ids = $wpdb->get_col( $wpdb->prepare(
                "SELECT practice_id FROM {$designer_practice_map_table} WHERE designer_id = %d",
                $current_user->ID
            ) );
        }

        // Fetch all practice types
        $practice_types = $wpdb->get_results(
            "SELECT practice_id, name FROM {$practice_types_table} ORDER BY name"
        );

        $is_edit_mode = ! empty( $existing_profile );
        $form_title = $is_edit_mode ? 'Update Designer Profile' : 'Designer Onboarding';
        $form_description = $is_edit_mode ? 'Update your profile information.' : 'Complete your profile to enable routing and matching.';

        ob_start();
        ?>
        <div class="n88-designer-onboarding" style="max-width: 800px; margin: 40px auto; padding: 40px 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;">
            <h1 style="margin: 0 0 30px 0; font-size: 28px; font-weight: 600; color: #333;"><?php echo esc_html( $form_title ); ?></h1>
            <p style="margin: 0 0 30px 0; font-size: 14px; color: #666;"><?php echo esc_html( $form_description ); ?></p>
            
            <form id="n88-designer-onboarding-form" style="background-color: #fff; padding: 30px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <?php wp_nonce_field( 'n88_save_designer_profile', 'n88_designer_profile_nonce' ); ?>
                
                <!-- Firm Name -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Firm Name <span style="color: #d63638;">*</span>
                    </label>
                    <input type="text" id="n88-firm-name" name="firm_name" value="<?php echo $existing_profile ? esc_attr( $existing_profile->firm_name ) : ''; ?>" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>

                <!-- Display Nickname -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Display Nickname
                    </label>
                    <input type="text" id="n88-display-nickname" name="display_nickname" value="<?php echo $existing_profile ? esc_attr( $existing_profile->display_nickname ) : ''; ?>" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>

                <!-- Contact Name -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Contact Name <span style="color: #d63638;">*</span>
                    </label>
                    <input type="text" id="n88-contact-name" name="contact_name" value="<?php echo $existing_profile ? esc_attr( $existing_profile->contact_name ) : ''; ?>" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>

                <!-- Email -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Email <span style="color: #d63638;">*</span>
                    </label>
                    <input type="email" id="n88-email" name="email" value="<?php echo $existing_profile ? esc_attr( $existing_profile->email ) : esc_attr( $current_user->user_email ); ?>" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>

                <!-- Address Fields -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 12px; font-size: 14px; font-weight: 600; color: #333;">
                        Address
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">Country Code (2 letters)</label>
                            <input type="text" id="n88-country-code" name="country_code" value="<?php echo $existing_profile ? esc_attr( $existing_profile->country_code ) : ''; ?>" maxlength="2" placeholder="US" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">State/Region</label>
                            <input type="text" id="n88-state-region" name="state_region" value="<?php echo $existing_profile ? esc_attr( $existing_profile->state_region ) : ''; ?>" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">City</label>
                            <input type="text" id="n88-city" name="city" value="<?php echo $existing_profile ? esc_attr( $existing_profile->city ) : ''; ?>" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">ZipCommit 2.3.2 â€” Supplier RFQ Detail View (Read-Only)</label>
                            <input type="text" id="n88-postal-code" name="postal_code" value="<?php echo $existing_profile ? esc_attr( $existing_profile->postal_code ) : ''; ?>" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #666;">Address Line 1</label>
                        <input type="text" id="n88-address-line1" name="address_line1" value="<?php echo $existing_profile ? esc_attr( $existing_profile->address_line1 ) : ''; ?>" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>
                </div>

                <!-- Practice Types -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Practice Types
                    </label>
                    <p style="margin: 0 0 12px 0; font-size: 13px; color: #666;">Select the practice types that apply to your firm.</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9;">
                        <?php foreach ( $practice_types as $practice ) : ?>
                            <label style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background-color: #fff; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" name="practice_types[]" value="<?php echo esc_attr( $practice->practice_id ); ?>" <?php checked( in_array( $practice->practice_id, $existing_practice_ids ) ); ?> style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                                <span style="color: #333;"><?php echo esc_html( $practice->name ); ?></span>
                            </label>
                        <?php endforeach; ?>
                    </div>
                </div>

                <!-- Default Allow System Invites -->
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="n88-default-allow-system-invites" name="default_allow_system_invites" value="1" <?php checked( $existing_profile && $existing_profile->default_allow_system_invites == 1 ); ?> style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 14px; color: #333;">Default Allow System Invites</span>
                    </label>
                </div>

                <!-- Submit Button -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button type="submit" id="n88-submit-designer-profile" style="padding: 12px 24px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%;">
                        Save Profile
                    </button>
                    <div id="n88-designer-form-message" style="margin-top: 15px; font-size: 14px; display: none;"></div>
                </div>
            </form>
        </div>

        <script>
        (function() {
            var form = document.getElementById('n88-designer-onboarding-form');
            var submitButton = document.getElementById('n88-submit-designer-profile');
            var messageDiv = document.getElementById('n88-designer-form-message');

            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                var formData = new FormData(form);
                formData.append('action', 'n88_save_designer_profile');

                submitButton.disabled = true;
                submitButton.textContent = 'Saving...';
                messageDiv.style.display = 'none';

                fetch('<?php echo admin_url( 'admin-ajax.php' ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageDiv.style.cssText = 'margin-top: 15px; font-size: 14px; display: block; padding: 12px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 4px;';
                        messageDiv.textContent = data.data.message || 'Profile saved successfully!';
                        
                        // Redirect after 2 seconds
                        setTimeout(function() {
                            window.location.href = '<?php echo esc_url( home_url( '/workspace' ) ); ?>';
                        }, 2000);
                    } else {
                        messageDiv.style.cssText = 'margin-top: 15px; font-size: 14px; display: block; padding: 12px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px;';
                        messageDiv.textContent = data.data.message || 'Error saving profile. Please try again.';
                        submitButton.disabled = false;
                        submitButton.textContent = 'Save Profile';
                    }
                })
                .catch(error => {
                    messageDiv.style.cssText = 'margin-top: 15px; font-size: 14px; display: block; padding: 12px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px;';
                    messageDiv.textContent = 'Error saving profile. Please try again.';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Save Profile';
                });
            });
        })();
        </script>
        <?php
        return ob_get_clean();
    }

    /**
     * AJAX handler to save designer profile (Commit 2.2.8)
     */
    public function ajax_save_designer_profile() {
        check_ajax_referer( 'n88_save_designer_profile', 'n88_designer_profile_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        if ( ! $is_designer ) {
            wp_send_json_error( array( 'message' => 'Access denied. Creator account required.' ) );
        }

        $user_id = $current_user->ID;

        // Get and sanitize form data
        $firm_name = isset( $_POST['firm_name'] ) ? sanitize_text_field( wp_unslash( $_POST['firm_name'] ) ) : '';
        $display_nickname = isset( $_POST['display_nickname'] ) ? sanitize_text_field( wp_unslash( $_POST['display_nickname'] ) ) : '';
        $contact_name = isset( $_POST['contact_name'] ) ? sanitize_text_field( wp_unslash( $_POST['contact_name'] ) ) : '';
        $email = isset( $_POST['email'] ) ? sanitize_email( wp_unslash( $_POST['email'] ) ) : '';
        $country_code = isset( $_POST['country_code'] ) ? strtoupper( sanitize_text_field( wp_unslash( $_POST['country_code'] ) ) ) : '';
        $state_region = isset( $_POST['state_region'] ) ? sanitize_text_field( wp_unslash( $_POST['state_region'] ) ) : '';
        $city = isset( $_POST['city'] ) ? sanitize_text_field( wp_unslash( $_POST['city'] ) ) : '';
        $postal_code = isset( $_POST['postal_code'] ) ? sanitize_text_field( wp_unslash( $_POST['postal_code'] ) ) : '';
        $address_line1 = isset( $_POST['address_line1'] ) ? sanitize_text_field( wp_unslash( $_POST['address_line1'] ) ) : '';
        $default_allow_system_invites = isset( $_POST['default_allow_system_invites'] ) ? 1 : 0;
        $practice_types = isset( $_POST['practice_types'] ) ? array_map( 'intval', (array) $_POST['practice_types'] ) : array();

        // Validate required fields
        if ( empty( $firm_name ) ) {
            wp_send_json_error( array( 'message' => 'Firm name is required.' ) );
        }

        if ( empty( $contact_name ) ) {
            wp_send_json_error( array( 'message' => 'Contact name is required.' ) );
        }

        if ( empty( $email ) || ! is_email( $email ) ) {
            wp_send_json_error( array( 'message' => 'Valid email is required.' ) );
        }

        global $wpdb;
        $designer_profiles_table = $wpdb->prefix . 'n88_designer_profiles_v2';
        $designer_practice_map_table = $wpdb->prefix . 'n88_designer_practice_map';
        $practice_types_table = $wpdb->prefix . 'n88_practice_types';

        // Verify practice types exist
        if ( ! empty( $practice_types ) ) {
            $placeholders = implode( ',', array_fill( 0, count( $practice_types ), '%d' ) );
            $query = $wpdb->prepare(
                "SELECT practice_id FROM {$practice_types_table} WHERE practice_id IN ($placeholders)",
                $practice_types
            );
            $valid_practice_types = $wpdb->get_col( $query );
            $practice_types = array_intersect( $practice_types, $valid_practice_types );
        }

        // Start transaction
        $wpdb->query( 'START TRANSACTION' );

        try {
            // Save or update designer profile
            $existing_profile = $wpdb->get_var( $wpdb->prepare(
                "SELECT designer_id FROM {$designer_profiles_table} WHERE designer_id = %d",
                $user_id
            ) );

            $profile_data = array(
                'designer_id' => $user_id,
                'firm_name' => $firm_name,
                'display_nickname' => $display_nickname ? $display_nickname : null,
                'contact_name' => $contact_name,
                'email' => $email,
                'country_code' => $country_code ? $country_code : null,
                'state_region' => $state_region ? $state_region : null,
                'city' => $city ? $city : null,
                'postal_code' => $postal_code ? $postal_code : null,
                'address_line1' => $address_line1 ? $address_line1 : null,
                'default_allow_system_invites' => $default_allow_system_invites,
            );

            if ( $existing_profile ) {
                // Update existing profile
                $wpdb->update(
                    $designer_profiles_table,
                    $profile_data,
                    array( 'designer_id' => $user_id ),
                    array( '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%d' ),
                    array( '%d' )
                );
            } else {
                // Insert new profile
                $wpdb->insert(
                    $designer_profiles_table,
                    $profile_data,
                    array( '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%d' )
                );
            }

            // Delete existing practice type mappings for this designer
            $wpdb->delete(
                $designer_practice_map_table,
                array( 'designer_id' => $user_id ),
                array( '%d' )
            );

            // Insert new practice type mappings
            if ( ! empty( $practice_types ) ) {
                foreach ( $practice_types as $practice_id ) {
                    $wpdb->insert(
                        $designer_practice_map_table,
                        array(
                            'designer_id' => $user_id,
                            'practice_id' => $practice_id,
                        ),
                        array( '%d', '%d' )
                    );
                }
            }

            $wpdb->query( 'COMMIT' );

            wp_send_json_success( array(
                'message' => 'Profile saved successfully!',
            ) );

        } catch ( Exception $e ) {
            $wpdb->query( 'ROLLBACK' );
            wp_send_json_error( array(
                'message' => 'Error saving profile. Please try again.',
            ) );
        }
    }

    /**
     * AJAX handler to fetch supplier item details (read-only) (Commit 2.3.2)
     * Returns item details only if supplier has a route for the item
     * No database writes - strictly read-only
     */
    public function ajax_get_supplier_item_details() {
        check_ajax_referer( 'n88_get_supplier_item_details', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_designer && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Maker, Creator, or Super Admin account required.' ) );
        }

        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }

        // DEMO ITEM FOR TESTING (Commit 2.3.2/2.3.3) - Remove when routing is implemented
        $demo_item_id = 9999;
        if ( $item_id === $demo_item_id ) {
            // Return demo item data
            $response = array(
                'item_id' => $demo_item_id,
                'title' => 'Demo Curved Sofa',
                'description' => 'Modern curved sofa for reception area. This is a demo item for testing the RFQ detail view and bid modal functionality.',
                'category' => 'Upholstery',
                'image_url' => '', // No image for demo
                'quantity' => 2,
                'dimensions' => array(
                    'w' => 240,
                    'd' => 100,
                    'h' => 85,
                    'unit' => 'cm'
                ),
                'sourcing_type' => 'furniture',
                'timeline_type' => '6-step furniture',
                'delivery_country' => 'US',
                'delivery_postal_code' => '10001',
                'shipping_mode_label' => 'Instant shipping estimate available',
                'route_label' => 'Designer-invited RFQ',
                'reference_images' => array(),
                'media_links' => array(),
            );
            wp_send_json_success( $response );
        }

        global $wpdb;
        $items_table = $wpdb->prefix . 'n88_items';
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        $item_delivery_context_table = $wpdb->prefix . 'n88_item_delivery_context';
        $categories_table = $wpdb->prefix . 'n88_categories';

        // CRITICAL: Permission check
        // - System operators can view any item
        // - Designers can view their own items
        // - Suppliers can only view items they have a route for
        if ( ! $is_system_operator ) {
            if ( $is_designer ) {
                // Designer can view their own items - check ownership
                $item_owner = $wpdb->get_var( $wpdb->prepare(
                    "SELECT owner_user_id FROM {$items_table} WHERE id = %d",
                    $item_id
                ) );
                
                if ( ! $item_owner || intval( $item_owner ) !== $current_user->ID ) {
                    wp_send_json_error( array( 'message' => 'Access denied. You can only view your own items.' ), 403 );
                }
            } else if ( $is_supplier ) {
                // Commit 2.3.7.1: Check and update expired routes (lazy evaluation)
                $this->check_and_update_expired_routes( $item_id, $current_user->ID );
                
                // Check if route is expired
                if ( $this->is_route_expired( $item_id, $current_user->ID ) ) {
                    wp_send_json_error( array( 'message' => 'This RFQ is no longer accepting bids.' ), 403 );
                }
                
                // Supplier can only view items they have a route for
                $route_exists = $wpdb->get_var( $wpdb->prepare(
                    "SELECT COUNT(*) FROM {$rfq_routes_table} 
                    WHERE item_id = %d 
                    AND supplier_id = %d 
                    AND status IN ('queued', 'sent', 'viewed', 'bid_submitted')",
                    $item_id,
                    $current_user->ID
                ) );

                if ( ! $route_exists || intval( $route_exists ) === 0 ) {
                    wp_send_json_error( array( 'message' => 'Access denied. You do not have permission to view this item.' ), 403 );
                }
            }
        }

        // Fetch item data
        // Check if meta_json column exists
        $items_columns = $wpdb->get_col( "DESCRIBE {$items_table}" );
        $has_meta_json = in_array( 'meta_json', $items_columns, true );
        
        // Build SELECT query - include owner_user_id and meta_json if column exists
        $select_fields = "id, title, description, item_type, primary_image_id, deleted_at, owner_user_id";
        if ( $has_meta_json ) {
            $select_fields .= ", meta_json";
        }
        
        // First check if item exists (even if deleted)
        $item_exists = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM {$items_table} WHERE id = %d",
            $item_id
        ) );
        
        if ( ! $item_exists || intval( $item_exists ) === 0 ) {
            wp_send_json_error( array( 'message' => 'Item not found. Item ID: ' . $item_id . ' does not exist in the database.' ) );
        }
        
        // Now fetch the item (must not be deleted)
        $item = $wpdb->get_row( $wpdb->prepare(
            "SELECT {$select_fields}
             FROM {$items_table}
             WHERE id = %d",
            $item_id
        ), ARRAY_A );

        if ( ! $item ) {
            wp_send_json_error( array( 'message' => 'Item not found.' ) );
        }
        
        // Check if item is soft-deleted
        if ( ! empty( $item['deleted_at'] ) ) {
            wp_send_json_error( array( 'message' => 'Item has been deleted. deleted_at: ' . esc_html( $item['deleted_at'] ) ) );
        }
        
        // Initialize meta_json if column doesn't exist
        if ( ! $has_meta_json ) {
            $item['meta_json'] = null;
        }

        // Parse meta_json for dimensions, sourcing_type, timeline_type, etc.
        $meta = array();
        if ( ! empty( $item['meta_json'] ) ) {
            $decoded_meta = json_decode( $item['meta_json'], true );
            if ( is_array( $decoded_meta ) ) {
                $meta = $decoded_meta;
            }
            // Debug: Log meta_json parsing
            error_log( 'Supplier Detail View - Parsed meta_json for item ' . $item_id . ': ' . wp_json_encode( $meta ) );
        } else {
            error_log( 'Supplier Detail View - meta_json is empty for item ' . $item_id );
        }

        // Get item image - ensure absolute URL
        $image_url = '';
        $primary_image_url = '';
        if ( ! empty( $item['primary_image_id'] ) ) {
            $image_url = wp_get_attachment_image_url( $item['primary_image_id'], 'full' );
            if ( ! $image_url ) {
                $image_url = wp_get_attachment_url( $item['primary_image_id'] );
            }
            // Ensure absolute URL (wp_get_attachment_image_url should already return absolute, but double-check)
            if ( $image_url ) {
                // If relative URL, convert to absolute
                if ( ! preg_match( '/^https?:\/\//', $image_url ) ) {
                    $image_url = home_url( $image_url );
                }
                $primary_image_url = $image_url;
            }
        }

        // Get category name
        $category_name = '';
        if ( ! empty( $item['item_type'] ) ) {
            $category = $wpdb->get_row( $wpdb->prepare(
                "SELECT name FROM {$categories_table} WHERE category_id = %d OR name = %s LIMIT 1",
                intval( $item['item_type'] ),
                $item['item_type']
            ) );
            if ( $category ) {
                $category_name = $category->name;
            } else {
                $category_name = $item['item_type'];
            }
        }

        // Get delivery context (including quantity and dimensions from RFQ submission)
        $delivery_columns = $wpdb->get_col( "DESCRIBE {$item_delivery_context_table}" );
        $has_quantity = in_array( 'quantity', $delivery_columns, true );
        $has_dimensions = in_array( 'dimensions_json', $delivery_columns, true );
        
        $select_fields = "delivery_country_code, delivery_postal_code, shipping_estimate_mode";
        if ( $has_quantity ) {
            $select_fields .= ", quantity";
        }
        if ( $has_dimensions ) {
            $select_fields .= ", dimensions_json";
        }
        
        $delivery_context = $wpdb->get_row( $wpdb->prepare(
            "SELECT {$select_fields}
             FROM {$item_delivery_context_table}
             WHERE item_id = %d",
            $item_id
        ), ARRAY_A );

        // Determine shipping mode label
        $shipping_mode_label = 'Shipping info not provided yet';
        if ( $delivery_context ) {
            if ( $delivery_context['shipping_estimate_mode'] === 'auto' ) {
                $shipping_mode_label = 'Instant shipping estimate available';
            } else {
                $shipping_mode_label = 'Shipping will be quoted manually';
            }
        }

        // Get routing context (for supplier only, system operators don't need this)
        $routing_context = null;
        $route_label = '';
        if ( ! $is_system_operator ) {
            $route = $wpdb->get_row( $wpdb->prepare(
                "SELECT route_type FROM {$rfq_routes_table}
                 WHERE item_id = %d AND supplier_id = %d
                 ORDER BY route_id DESC LIMIT 1",
                $item_id,
                $current_user->ID
            ), ARRAY_A );

            if ( $route ) {
                if ( $route['route_type'] === 'designer_invited' ) {
                    $route_label = 'Designer-invited RFQ';
                } elseif ( $route['route_type'] === 'system_invited' ) {
                    $route_label = 'System-invited RFQ';
                }
            }
        }

        // Get reference images (from item attachments or meta) - ensure absolute URLs
        $reference_images = array();
        $inspiration_images = array();
        
        // Debug: Check if inspiration exists in meta
        if ( ! isset( $meta['inspiration'] ) ) {
            error_log( 'Supplier Detail View - No inspiration key in meta for item ' . $item_id );
        } elseif ( ! is_array( $meta['inspiration'] ) ) {
            error_log( 'Supplier Detail View - Inspiration is not an array for item ' . $item_id . ', type: ' . gettype( $meta['inspiration'] ) );
        } elseif ( empty( $meta['inspiration'] ) ) {
            error_log( 'Supplier Detail View - Inspiration array is empty for item ' . $item_id );
        }
        
        if ( isset( $meta['inspiration'] ) && is_array( $meta['inspiration'] ) && ! empty( $meta['inspiration'] ) ) {
            // Debug: Log raw inspiration data
            error_log( 'Supplier Detail View - Processing ' . count( $meta['inspiration'] ) . ' inspiration items for item ' . $item_id );
            error_log( 'Supplier Detail View - Raw inspiration data for item ' . $item_id . ': ' . wp_json_encode( $meta['inspiration'] ) );
            foreach ( $meta['inspiration'] as $insp_item ) {
                $thumb_url = '';
                $full_url = '';
                $img_id = null;
                
                // Priority 1: Use attachment ID if available (most reliable)
                if ( isset( $insp_item['id'] ) && ! empty( $insp_item['id'] ) ) {
                    $img_id = intval( $insp_item['id'] );
                    
                    // Verify attachment exists in database
                    $attachment_exists = get_post( $img_id );
                    if ( $attachment_exists && $attachment_exists->post_type === 'attachment' ) {
                        // Try medium size first (better for thumbnails), fallback to thumbnail, then full
                        $thumb_url = wp_get_attachment_image_url( $img_id, 'medium' );
                        if ( ! $thumb_url ) {
                            $thumb_url = wp_get_attachment_image_url( $img_id, 'thumbnail' );
                        }
                        if ( ! $thumb_url ) {
                            $thumb_url = wp_get_attachment_url( $img_id );
                        }
                        
                        $full_url = wp_get_attachment_image_url( $img_id, 'full' );
                        if ( ! $full_url ) {
                            $full_url = wp_get_attachment_url( $img_id );
                        }
                        
                        // Ensure absolute URLs
                        if ( $thumb_url && ! preg_match( '/^https?:\/\//', $thumb_url ) ) {
                            $thumb_url = home_url( $thumb_url );
                        }
                        if ( $full_url && ! preg_match( '/^https?:\/\//', $full_url ) ) {
                            $full_url = home_url( $full_url );
                        }
                    } else {
                        // Attachment ID doesn't exist, log and try URL fallback
                        error_log( 'Supplier Detail View - Attachment ID ' . $img_id . ' does not exist for item ' . $item_id );
                        $img_id = null; // Reset so we don't include invalid ID
                    }
                }
                
                // Priority 2: Use URL from inspiration item if ID didn't work or URL is provided
                if ( empty( $thumb_url ) && isset( $insp_item['url'] ) && ! empty( $insp_item['url'] ) ) {
                    $img_url = trim( $insp_item['url'] );
                    
                    // Check if URL is incomplete (just domain, with or without trailing slash)
                    // Valid URLs must have a path component (not just domain or domain/)
                    $is_incomplete_url = false;
                    if ( preg_match( '/^https?:\/\/[^\/]+$/', $img_url ) ) {
                        // URL is just domain (no trailing slash)
                        $is_incomplete_url = true;
                    } elseif ( preg_match( '/^https?:\/\/[^\/]+\/$/', $img_url ) ) {
                        // URL is just domain with trailing slash (still incomplete)
                        $is_incomplete_url = true;
                    } elseif ( ! preg_match( '/^https?:\/\/.+\/.+/', $img_url ) && ! preg_match( '/^https?:\/\/.+\.[a-z]{2,4}\//i', $img_url ) ) {
                        // URL doesn't have a proper path component
                        $is_incomplete_url = true;
                    }
                    
                    if ( $is_incomplete_url ) {
                        // URL is incomplete, try to find attachment by other means
                        error_log( 'Supplier Detail View - Incomplete inspiration URL (domain only): ' . $img_url . ' for item ' . $item_id );
                        
                        // Try to find attachment by searching in post meta or by filename if we have title
                        if ( isset( $insp_item['title'] ) && ! empty( $insp_item['title'] ) ) {
                            global $wpdb;
                            $filename = sanitize_file_name( $insp_item['title'] );
                            // Try to find attachment by filename
                            $found_attachment = $wpdb->get_var( $wpdb->prepare(
                                "SELECT ID FROM {$wpdb->posts} 
                                WHERE post_type = 'attachment' 
                                AND (post_title LIKE %s OR guid LIKE %s)
                                LIMIT 1",
                                '%' . $wpdb->esc_like( $filename ) . '%',
                                '%' . $wpdb->esc_like( $filename ) . '%'
                            ) );
                            
                            if ( $found_attachment ) {
                                $img_id = intval( $found_attachment );
                                $thumb_url = wp_get_attachment_image_url( $img_id, 'medium' );
                                if ( ! $thumb_url ) {
                                    $thumb_url = wp_get_attachment_image_url( $img_id, 'thumbnail' );
                                }
                                if ( ! $thumb_url ) {
                                    $thumb_url = wp_get_attachment_url( $img_id );
                                }
                                $full_url = wp_get_attachment_image_url( $img_id, 'full' );
                                if ( ! $full_url ) {
                                    $full_url = wp_get_attachment_url( $img_id );
                                }
                                
                                // Ensure absolute URLs
                                if ( $thumb_url && ! preg_match( '/^https?:\/\//', $thumb_url ) ) {
                                    $thumb_url = home_url( $thumb_url );
                                }
                                if ( $full_url && ! preg_match( '/^https?:\/\//', $full_url ) ) {
                                    $full_url = home_url( $full_url );
                                }
                                
                                error_log( 'Supplier Detail View - Found attachment by filename: ' . $img_id . ' for item ' . $item_id );
                            }
                        }
                        
                        // Also try to find attachment by ID if we have one but URL is incomplete
                        if ( empty( $thumb_url ) && isset( $insp_item['id'] ) && ! empty( $insp_item['id'] ) ) {
                            $try_id = intval( $insp_item['id'] );
                            $try_attachment = get_post( $try_id );
                            if ( $try_attachment && $try_attachment->post_type === 'attachment' ) {
                                $thumb_url = wp_get_attachment_image_url( $try_id, 'medium' );
                                if ( ! $thumb_url ) {
                                    $thumb_url = wp_get_attachment_image_url( $try_id, 'thumbnail' );
                                }
                                if ( ! $thumb_url ) {
                                    $thumb_url = wp_get_attachment_url( $try_id );
                                }
                                $full_url = wp_get_attachment_image_url( $try_id, 'full' );
                                if ( ! $full_url ) {
                                    $full_url = wp_get_attachment_url( $try_id );
                                }
                                
                                // Ensure absolute URLs
                                if ( $thumb_url && ! preg_match( '/^https?:\/\//', $thumb_url ) ) {
                                    $thumb_url = home_url( $thumb_url );
                                }
                                if ( $full_url && ! preg_match( '/^https?:\/\//', $full_url ) ) {
                                    $full_url = home_url( $full_url );
                                }
                                
                                $img_id = $try_id;
                                error_log( 'Supplier Detail View - Found attachment by ID (from incomplete URL): ' . $img_id . ' for item ' . $item_id );
                            }
                        }
                        
                        // If still no valid URL, skip this inspiration item
                        if ( empty( $thumb_url ) ) {
                            error_log( 'Supplier Detail View - Skipping inspiration image with incomplete URL (item_id: ' . $item_id . ', url: ' . $img_url . ')' );
                            continue;
                        }
                    } else {
                        // URL has a proper path, validate and use it
                        $thumb_url = esc_url_raw( $img_url );
                        $full_url = esc_url_raw( $img_url );
                        
                        // Try to get attachment ID from URL if we don't have one
                        if ( ! $img_id ) {
                            $found_id = attachment_url_to_postid( $img_url );
                            if ( $found_id > 0 ) {
                                $img_id = $found_id;
                                // Prefer WordPress-generated URLs if we found the attachment
                                $better_thumb = wp_get_attachment_image_url( $img_id, 'medium' );
                                if ( $better_thumb ) {
                                    $thumb_url = $better_thumb;
                                }
                                $better_full = wp_get_attachment_image_url( $img_id, 'full' );
                                if ( $better_full ) {
                                    $full_url = $better_full;
                                }
                            }
                        }
                    }
                }
                
                // Only add if we have a valid URL with a proper path (not just domain or domain/)
                // Require at least one character after the domain and a slash, then more path
                if ( ! empty( $thumb_url ) && preg_match( '/^https?:\/\/.+\/.+/', $thumb_url ) ) {
                    // Ensure absolute URLs
                    if ( ! preg_match( '/^https?:\/\//', $thumb_url ) ) {
                        $thumb_url = home_url( $thumb_url );
                    }
                    if ( $full_url && ! preg_match( '/^https?:\/\//', $full_url ) ) {
                        $full_url = home_url( $full_url );
                    }
                    
                    $img_data = array();
                    if ( $img_id ) {
                        $img_data['id'] = $img_id;
                    }
                    $img_data['url'] = esc_url_raw( $thumb_url );
                    $img_data['full_url'] = esc_url_raw( $full_url ? $full_url : $thumb_url );
                    // Commit 2.3.5.4: Include type information for PDFs
                    $img_data['type'] = isset( $insp_item['type'] ) ? sanitize_text_field( $insp_item['type'] ) : 'image';
                    // Also check URL extension for PDF
                    if ( $img_data['type'] !== 'pdf' && preg_match( '/\.pdf$/i', $thumb_url ) ) {
                        $img_data['type'] = 'pdf';
                    }
                    // Get filename for PDF display
                    if ( $img_data['type'] === 'pdf' ) {
                        $img_data['filename'] = isset( $insp_item['title'] ) ? sanitize_text_field( $insp_item['title'] ) : ( isset( $insp_item['filename'] ) ? sanitize_text_field( $insp_item['filename'] ) : basename( $thumb_url ) );
                    }
                    
                    $reference_images[] = $img_data;
                    $inspiration_images[] = $img_data;
                    
                    error_log( 'Supplier Detail View - Added inspiration image (item_id: ' . $item_id . ', url: ' . $thumb_url . ', id: ' . ( $img_id ? $img_id : 'none' ) . ')' );
                } else {
                    error_log( 'Supplier Detail View - Skipping invalid inspiration image (item_id: ' . $item_id . ', url: ' . ( isset( $insp_item['url'] ) ? $insp_item['url'] : 'none' ) . ', id: ' . ( isset( $insp_item['id'] ) ? $insp_item['id'] : 'none' ) . ', resolved_thumb_url: ' . ( $thumb_url ? $thumb_url : 'empty' ) . ')' );
                }
            }
        }

        // Get media links (if stored in meta or separate table)
        $media_links = array();
        if ( isset( $meta['media_links'] ) && is_array( $meta['media_links'] ) ) {
            $media_links = $meta['media_links'];
        }

        // Get bid status and created_at FIRST (Commit 2.3.5 - check if bid already submitted)
        // Commit 2.3.5.1 Addendum: Also get created_at to detect if dims/qty changed after bid submission
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $bid_media_links_table = $wpdb->prefix . 'n88_bid_media_links';
        $bid_media_files_table = $wpdb->prefix . 'n88_bid_media_files';
        $bid_status = null;
        $bid_created_at = null;
        $show_dims_qty_warning = false;
        $has_submitted_bid = false;
        $bid_data = null;
        $bid_status = null; // Initialize bid_status
        $bid_revision = null; // Initialize bid_revision to prevent undefined variable
        $item_level_payment_notification = null; // Commit 2.3.9.2: Prototype tab â€” always send when supplier has prototype request
        if ( ! $is_system_operator ) {
            // Check if meta_json column exists in bids table
            $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
            $has_bid_meta_json = in_array( 'meta_json', $bids_columns, true );
            
            // G) Check for revision column in bids table
            $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
            
            $select_bid_fields = "bid_id, status, created_at, unit_price, production_lead_time_text, prototype_video_yes, prototype_timeline_option, prototype_cost";
            if ( $has_bid_meta_json ) {
                $select_bid_fields .= ", meta_json";
            }
            if ( $has_revision_column ) {
                $select_bid_fields .= ", rfq_revision_at_submit";
            }
            
            // Get item current revision to prioritize current revision bids
            $item_current_revision_for_bid = null;
            if ( $has_revision_column ) {
                $item_current_revision_for_bid = isset( $meta['rfq_revision_current'] ) ? intval( $meta['rfq_revision_current'] ) : null;
            }
            
            // CRITICAL: Always prioritize SUBMITTED/AWARDED bids over draft bids
            // Commit 2.4.1: Include 'awarded' status so supplier can see their awarded bid
            // First, try to get submitted or awarded bid (any revision)
            $submitted_bid = $wpdb->get_row( $wpdb->prepare(
                "SELECT {$select_bid_fields} FROM {$item_bids_table} 
                WHERE item_id = %d AND supplier_id = %d
                AND status IN ('submitted', 'awarded')
                ORDER BY 
                    CASE status
                        WHEN 'awarded' THEN 1
                        WHEN 'submitted' THEN 2
                    END,
                    created_at DESC, bid_id DESC
                LIMIT 1",
                $item_id,
                $current_user->ID
            ), ARRAY_A );
            
            if ( $submitted_bid ) {
                // Submitted bid exists - use it (ignore drafts)
                $existing_bid = $submitted_bid;
            } else {
                // No submitted bid - check for current revision bid or draft
                if ( $has_revision_column && $item_current_revision_for_bid !== null ) {
                    // First try to get current revision bid (could be draft)
                    $current_revision_bid = $wpdb->get_row( $wpdb->prepare(
                        "SELECT {$select_bid_fields} FROM {$item_bids_table} 
                        WHERE item_id = %d AND supplier_id = %d
                        AND rfq_revision_at_submit = %d
                        AND status = 'draft'
                        ORDER BY created_at DESC, bid_id DESC
                        LIMIT 1",
                        $item_id,
                        $current_user->ID,
                        $item_current_revision_for_bid
                    ), ARRAY_A );
                    
                    if ( $current_revision_bid ) {
                        $existing_bid = $current_revision_bid;
                    } else {
                        // No current revision draft, check for any draft bid
                        $draft_bid = $wpdb->get_row( $wpdb->prepare(
                            "SELECT {$select_bid_fields} FROM {$item_bids_table} 
                            WHERE item_id = %d AND supplier_id = %d
                            AND status = 'draft'
                            ORDER BY created_at DESC, bid_id DESC
                            LIMIT 1",
                            $item_id,
                            $current_user->ID
                        ), ARRAY_A );
                        
                        if ( $draft_bid ) {
                            $existing_bid = $draft_bid;
                        } else {
                            // No draft, get latest bid (any status - could be withdrawn)
                            $existing_bid = $wpdb->get_row( $wpdb->prepare(
                                "SELECT {$select_bid_fields} FROM {$item_bids_table} 
                                WHERE item_id = %d AND supplier_id = %d
                                ORDER BY created_at DESC, bid_id DESC
                                LIMIT 1",
                                $item_id,
                                $current_user->ID
                            ), ARRAY_A );
                        }
                    }
                } else {
                    // No revision column, check for draft bid
                    $draft_bid = $wpdb->get_row( $wpdb->prepare(
                        "SELECT {$select_bid_fields} FROM {$item_bids_table} 
                        WHERE item_id = %d AND supplier_id = %d
                        AND status = 'draft'
                        ORDER BY created_at DESC, bid_id DESC
                        LIMIT 1",
                        $item_id,
                        $current_user->ID
                    ), ARRAY_A );
                    
                    if ( $draft_bid ) {
                        $existing_bid = $draft_bid;
                    } else {
                        // No draft, get latest bid (any status)
                        $existing_bid = $wpdb->get_row( $wpdb->prepare(
                            "SELECT {$select_bid_fields} FROM {$item_bids_table} 
                            WHERE item_id = %d AND supplier_id = %d
                            ORDER BY created_at DESC, bid_id DESC
                            LIMIT 1",
                            $item_id,
                            $current_user->ID
                        ), ARRAY_A );
                    }
                }
            }
            // IMPORTANT: Check for draft in user meta FIRST (drafts are saved to user meta, not database)
            // Only set bid_status to 'draft' if there's a valid, non-empty draft saved
            $draft_meta_key = 'n88_bid_draft_' . $item_id;
            $draft_json = get_user_meta( $current_user->ID, $draft_meta_key, true );
            $has_user_meta_draft = false;
            
            // Validate that draft JSON exists and contains actual data
            if ( ! empty( $draft_json ) ) {
                $draft_data = json_decode( $draft_json, true );
                // Only consider it a valid draft if JSON is valid and contains at least one field
                if ( is_array( $draft_data ) && ! empty( $draft_data ) ) {
                    // Check if draft has at least one meaningful field (not just empty values)
                    $has_meaningful_data = false;
                    $meaningful_fields = array( 'unit_price', 'production_lead_time_text', 'prototype_video_yes', 'prototype_timeline_option', 'prototype_cost', 'video_links', 'bid_photo_ids', 'smart_alternatives_suggestion' );
                    foreach ( $meaningful_fields as $field ) {
                        if ( isset( $draft_data[ $field ] ) && ! empty( $draft_data[ $field ] ) ) {
                            $has_meaningful_data = true;
                            break;
                        }
                    }
                    if ( $has_meaningful_data ) {
                        $has_user_meta_draft = true;
                    }
                }
            }
            
            if ( $existing_bid ) {
                // CRITICAL: Priority must be SUBMITTED/AWARDED bid > Draft (user meta or database)
                // Commit 2.4.1: Include 'awarded' status so supplier can see their awarded bid
                // If there's a submitted or awarded bid, always use that status (ignore drafts)
if ( $existing_bid['status'] === 'submitted' || $existing_bid['status'] === 'awarded' ) {
                    // Submitted or awarded bid exists - use it (drafts are irrelevant when bid is submitted/awarded)
                    $bid_status = $existing_bid['status']; // Keep the actual status (submitted or awarded)
                    $bid_created_at = $existing_bid['created_at'];
                    $has_submitted_bid = true; // Treat awarded as submitted for display purposes
                    
                    // Populate bid_data for submitted bid (needed for "Your Submitted Bid" box display)                
                    $bid_id = intval( $existing_bid['bid_id'] );
                    
                    // Get video links for submitted bid
                    $video_links = $wpdb->get_results( $wpdb->prepare(
                        "SELECT url, provider FROM {$bid_media_links_table}
                        WHERE bid_id = %d
                        ORDER BY sort_order ASC, id ASC",
                        $bid_id
                    ), ARRAY_A );
                    
                    // Get bid photos for submitted bid
                    $bid_photos = $wpdb->get_results( $wpdb->prepare(
                        "SELECT file_url FROM {$bid_media_files_table}
                        WHERE bid_id = %d
                        ORDER BY sort_order ASC, id ASC",
                        $bid_id
                    ), ARRAY_A );
                    
                    $photo_urls = array();
                    foreach ( $bid_photos as $photo ) {
                        if ( isset( $photo['file_url'] ) && ! empty( $photo['file_url'] ) ) {
                            $photo_urls[] = esc_url_raw( $photo['file_url'] );
                        }
                    }
                    
                    // Get Smart Alternatives suggestion from meta_json for submitted bid
                    $smart_alternatives_suggestion = null;
                    if ( $has_bid_meta_json && ! empty( $existing_bid['meta_json'] ) ) {
                        $bid_meta = json_decode( $existing_bid['meta_json'], true );
                        if ( is_array( $bid_meta ) && isset( $bid_meta['smart_alternatives_suggestion'] ) ) {
                            $smart_alternatives_suggestion = $bid_meta['smart_alternatives_suggestion'];
                        }
                    }
                    
                    // Commit 2.3.9.1B: Check if CAD prototype request exists for this item + supplier
                    // Use item_id + supplier_id (not bid_id) so we find the record even when bid_id
                    // in prototype_payments differs from current submitted bid (e.g. resubmission)
                    $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
                    $has_prototype_request = false;
                    $prototype_request_status = null;
                    $payment_notification = null; // Commit 2.3.9.1E: Payment notification data
                    if ( $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table ) {
                        $prototype_request = $wpdb->get_row( $wpdb->prepare(
                            "SELECT id, bid_id, status, video_direction_json, notifications_sent_at, cad_status, cad_approved_version, cad_released_to_supplier_at FROM {$prototype_payments_table}
                            WHERE item_id = %d AND supplier_id = %d
                            ORDER BY created_at DESC
                            LIMIT 1",
                            $item_id,
                            $current_user->ID
                        ), ARRAY_A );
                        // Fallback: if no match by supplier_id, try by bid_id (catches payments linked to awarded bid where supplier_id may differ)
                        if ( ! $prototype_request && $bid_id > 0 ) {
                            $prototype_request = $wpdb->get_row( $wpdb->prepare(
                                "SELECT id, bid_id, status, video_direction_json, notifications_sent_at, cad_status, cad_approved_version, cad_released_to_supplier_at FROM {$prototype_payments_table}
                                WHERE item_id = %d AND bid_id = %d
                                ORDER BY created_at DESC
                                LIMIT 1",
                                $item_id,
                                $bid_id
                            ), ARRAY_A );
                        }
                        if ( $prototype_request ) {
                            $has_prototype_request = true;
                            $prototype_request_status = $prototype_request['status'];
                            $cad_status = isset( $prototype_request['cad_status'] ) ? $prototype_request['cad_status'] : null;
                            $cad_approved_version = isset( $prototype_request['cad_approved_version'] ) ? intval( $prototype_request['cad_approved_version'] ) : null;
                            $cad_released_to_supplier_at = isset( $prototype_request['cad_released_to_supplier_at'] ) ? $prototype_request['cad_released_to_supplier_at'] : null;
                            $payment_id_from_pp = isset( $prototype_request['id'] ) ? intval( $prototype_request['id'] ) : 0;
                            $pp_bid_id = isset( $prototype_request['bid_id'] ) ? intval( $prototype_request['bid_id'] ) : $bid_id;

                            // Commit 2.3.9.1E + Prototype tab: ALWAYS build payment_notification when prototype_request exists
                            // so Prototype tab can show: CAD Request Pending Payment | keywords after payment | CAD Approved + video box
                            $keywords_list = array();
                            $note = '';
                            $cad_files = array();
                            $payment_id_for_notification = $payment_id_from_pp;
                            $latest_submission = null;
                            $submission_links = array();
                            $prototype_status = null;
                            $prototype_feedback = null;

                            // Full data (keywords, CAD files, submission) when payment received (with or without notifications_sent_at) or CAD approved
                            // Commit 2.3.9.2B: Show keywords as soon as payment is marked_received so supplier sees direction after payment
                            $fetch_full_data = ( $prototype_request['status'] === 'marked_received' )
                                || ( $cad_status === 'approved' );
                            if ( $fetch_full_data ) {
                                $video_direction_json = $prototype_request['video_direction_json'];
                                $video_direction = array();
                                if ( ! empty( $video_direction_json ) ) {
                                    $video_direction = json_decode( $video_direction_json, true );
                                }
                                $selected_keywords = isset( $video_direction['selected_keywords'] ) ? $video_direction['selected_keywords'] : array();
                                $note = isset( $video_direction['note'] ) ? $video_direction['note'] : '';

                                // Get keyword names from keywords table
                                $keywords_table = $wpdb->prefix . 'n88_keywords';
                                if ( ! empty( $selected_keywords ) && is_array( $selected_keywords ) ) {
                                    $keyword_ids = array_map( 'intval', $selected_keywords );
                                    $keyword_ids = array_filter( $keyword_ids ); // Remove any zeros or invalid IDs
                                    if ( ! empty( $keyword_ids ) ) {
                                        // Use esc_sql for safety with IN clause
                                        $keyword_ids_safe = array_map( 'intval', $keyword_ids );
                                        $keyword_ids_string = implode( ',', $keyword_ids_safe );
                                        
                                        $keywords_data = $wpdb->get_results(
                                            "SELECT keyword_id, keyword FROM {$keywords_table} WHERE keyword_id IN ({$keyword_ids_string}) AND is_active = 1",
                                            ARRAY_A
                                        );
                                        
                                        if ( $keywords_data && is_array( $keywords_data ) ) {
                                            foreach ( $keywords_data as $kw ) {
                                                if ( isset( $kw['keyword'] ) && ! empty( $kw['keyword'] ) ) {
                                                    $keywords_list[] = sanitize_text_field( $kw['keyword'] );
                                                }
                                            }
                                        }
                                    }
                                }
                                
                                // Commit 2.3.9.2A: Get CAD approved files if CAD is approved (fetch files when approved, regardless of release status)
                                if ( $cad_status === 'approved' && $cad_approved_version && $cad_approved_version > 0 ) {
                                    $item_files_table = $wpdb->prefix . 'n88_item_files';
                                    $payment_id = $payment_id_from_pp;
                                    
                                    if ( $payment_id ) {
                                        $cad_file_records = $wpdb->get_results( $wpdb->prepare(
                                            "SELECT f.file_id, f.attachment_type, a.guid, a.post_title
                                            FROM {$item_files_table} f
                                            INNER JOIN {$wpdb->posts} a ON f.file_id = a.ID
                                            WHERE f.item_id = %d AND f.payment_id = %d AND f.attachment_type = 'cad' AND f.cad_version = %d AND f.detached_at IS NULL
                                            ORDER BY f.id ASC",
                                            $item_id,
                                            $payment_id,
                                            $cad_approved_version
                                        ), ARRAY_A );
                                        
                                        foreach ( $cad_file_records as $file_record ) {
                                            $file_url = isset( $file_record['guid'] ) ? esc_url_raw( $file_record['guid'] ) : '';
                                            $file_name = isset( $file_record['post_title'] ) ? sanitize_file_name( $file_record['post_title'] ) : '';
                                            if ( $file_url && $file_name ) {
                                                $file_ext = pathinfo( $file_name, PATHINFO_EXTENSION );
                                                $cad_files[] = array(
                                                    'name' => $file_name,
                                                    'url' => $file_url,
                                                    'ext' => strtolower( $file_ext ),
                                                );
                                            }
                                        }
                                    }
                                }

                                // Commit 2.3.9.2B-S: Get latest prototype video submission if exists
                                $latest_submission = null;
                                $submission_links = array();
                                if ( $payment_id_for_notification ) {
                                    $submissions_table = $wpdb->prefix . 'n88_prototype_video_submissions';
                                    $links_table = $wpdb->prefix . 'n88_prototype_video_links';
                                    
                                    // Check if table exists
                                    $table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$submissions_table}'" ) === $submissions_table;
                                    if ( $table_exists ) {
                                        $latest_submission = $wpdb->get_row( $wpdb->prepare(
                                            "SELECT id, version, link_count, created_at 
                                             FROM {$submissions_table} 
                                             WHERE payment_id = %d 
                                             ORDER BY version DESC 
                                             LIMIT 1",
                                            $payment_id_for_notification
                                        ), ARRAY_A );
                                        
                                        if ( $latest_submission ) {
                                            $submission_links = $wpdb->get_results( $wpdb->prepare(
                                                "SELECT provider, url, sort_order 
                                                 FROM {$links_table} 
                                                 WHERE submission_id = %d 
                                                 ORDER BY sort_order ASC",
                                                $latest_submission['id']
                                            ), ARRAY_A );
                                        }
                                    }
                                }
                                
                                // Commit 2.3.9.2B-D: Get prototype status and feedback packet if changes requested
                                $prototype_status = null;
                                $prototype_feedback = null;
                                $pp_columns = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
                                $has_prototype_status = in_array( 'prototype_status', $pp_columns, true );
                                
                                if ( $has_prototype_status && $payment_id_for_notification ) {
                                    $prototype_data = $wpdb->get_row( $wpdb->prepare(
                                        "SELECT prototype_status FROM {$prototype_payments_table} WHERE id = %d",
                                        $payment_id_for_notification
                                    ), ARRAY_A );
                                    
                                    if ( $prototype_data ) {
                                        $prototype_status = $prototype_data['prototype_status'];
                                        
                                        // If changes requested, fetch feedback packet
                                        if ( $prototype_status === 'changes_requested' ) {
                                            $feedback_packets_table = $wpdb->prefix . 'n88_prototype_feedback_packets';
                                            $feedback_packet_lines_table = $wpdb->prefix . 'n88_prototype_feedback_packet_lines';
                                            $keyword_phrases_table = $wpdb->prefix . 'n88_keyword_phrases';
                                            $keywords_table = $wpdb->prefix . 'n88_keywords';
                                            
                                            $table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$feedback_packets_table}'" ) === $feedback_packets_table;
                                            if ( $table_exists ) {
                                                // Get latest feedback packet for this payment
                                                $feedback_packet = $wpdb->get_row( $wpdb->prepare(
                                                    "SELECT id, submission_version, created_at 
                                                    FROM {$feedback_packets_table} 
                                                    WHERE payment_id = %d 
                                                    ORDER BY created_at DESC 
                                                    LIMIT 1",
                                                    $payment_id_for_notification
                                                ), ARRAY_A );
                                                
                                                if ( $feedback_packet ) {
                                                    // Get feedback lines with keyword info and phrases
                                                    $feedback_lines = $wpdb->get_results( $wpdb->prepare(
                                                        "SELECT fpl.keyword_id, fpl.keyword_status, fpl.severity, fpl.selected_phrase_ids,
                                                        k.keyword as keyword_name
                                                        FROM {$feedback_packet_lines_table} fpl
                                                        LEFT JOIN {$keywords_table} k ON fpl.keyword_id = k.keyword_id
                                                        WHERE fpl.feedback_packet_id = %d
                                                        ORDER BY fpl.id ASC",
                                                        $feedback_packet['id']
                                                    ), ARRAY_A );
                                                    
                                                    $feedback_data = array();
                                                    foreach ( $feedback_lines as $line ) {
                                                        $phrase_ids_json = $line['selected_phrase_ids'];
                                                        $phrase_ids = json_decode( $phrase_ids_json, true );
                                                        $phrases = array();
                                                        
                                                        if ( ! empty( $phrase_ids ) && is_array( $phrase_ids ) ) {
                                                            $phrase_ids_safe = array_map( 'intval', $phrase_ids );
                                                            $phrase_ids_string = implode( ',', $phrase_ids_safe );
                                                            $phrases_data = $wpdb->get_results(
                                                                "SELECT phrase_id, phrase_text 
                                                                FROM {$keyword_phrases_table} 
                                                                WHERE phrase_id IN ({$phrase_ids_string}) 
                                                                AND is_active = 1
                                                                ORDER BY FIELD(phrase_id, {$phrase_ids_string})",
                                                                ARRAY_A
                                                            );
                                                            foreach ( $phrases_data as $p ) {
                                                                $phrases[] = array(
                                                                    'phrase_id' => intval( $p['phrase_id'] ),
                                                                    'phrase_text' => $p['phrase_text'],
                                                                );
                                                            }
                                                        }
                                                        
                                                        $feedback_data[] = array(
                                                            'keyword_id' => intval( $line['keyword_id'] ),
                                                            'keyword_name' => $line['keyword_name'] ? sanitize_text_field( $line['keyword_name'] ) : 'Keyword ID: ' . $line['keyword_id'],
                                                            'keyword_status' => $line['keyword_status'],
                                                            'severity' => $line['severity'],
                                                            'phrases' => $phrases,
                                                        );
                                                    }
                                                    
                                                    $prototype_feedback = array(
                                                        'submission_version' => intval( $feedback_packet['submission_version'] ),
                                                        'created_at' => $feedback_packet['created_at'],
                                                        'keywords' => $feedback_data,
                                                    );
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            // Always set payment_notification when prototype_request exists (for Prototype tab)
                            $payment_notification = array(
                                    'status' => $prototype_request['status'], // requested | marked_received
                                    'payment_id' => $payment_id_for_notification ? intval( $payment_id_for_notification ) : null,
                                    'item_id' => $item_id,
                                    'bid_id' => $pp_bid_id,
                                    'keywords' => $keywords_list,
                                    'note' => $note,
                                    'cad_status' => $cad_status,
                                    'cad_approved_version' => $cad_approved_version,
                                    'cad_released_to_supplier_at' => $cad_released_to_supplier_at,
                                    'cad_files' => $cad_files,
                                    'prototype_status' => $prototype_status, // Commit 2.3.9.2B-D
                                    'prototype_feedback' => $prototype_feedback, // Commit 2.3.9.2B-D
                                    'prototype_video_submission' => $latest_submission ? array(
                                        'version' => intval( $latest_submission['version'] ),
                                        'link_count' => intval( $latest_submission['link_count'] ),
                                        'created_at' => $latest_submission['created_at'],
                                        'links' => $submission_links,
                                    ) : null,
                                );
                            $item_level_payment_notification = $payment_notification; // Commit 2.3.9.2: for Prototype tab (item-level)
                            }
                        }
                    }
                    
                    // Get item quantity for total price calculation
                    $item_quantity_for_bid = 1;
                    if ( isset( $meta['quantity'] ) && $meta['quantity'] > 0 ) {
                        $item_quantity_for_bid = (int) $meta['quantity'];
                    } elseif ( $delivery_context && isset( $delivery_context['quantity'] ) && $delivery_context['quantity'] > 0 ) {
                        $item_quantity_for_bid = (int) $delivery_context['quantity'];
                    }
                    
                    // Calculate total price = unit_price * quantity (for supplier - raw price)
                    $unit_price_raw_for_bid = $existing_bid['unit_price'] ? floatval( $existing_bid['unit_price'] ) : null;
                    $total_price_raw_for_bid = null;
                    if ( $unit_price_raw_for_bid !== null ) {
                        $total_price_raw_for_bid = $unit_price_raw_for_bid * $item_quantity_for_bid;
                    }
                    
                    $bid_data = array(
                        'unit_price' => $unit_price_raw_for_bid,
                        'total_price' => $total_price_raw_for_bid !== null ? number_format( $total_price_raw_for_bid, 2, '.', '' ) : null, // Supplier sees total raw price
                        'item_quantity' => $item_quantity_for_bid, // Quantity used for calculation
                        'production_lead_time' => $existing_bid['production_lead_time_text'] ? sanitize_text_field( $existing_bid['production_lead_time_text'] ) : null,
                        'prototype_video_yes' => intval( $existing_bid['prototype_video_yes'] ) === 1,
                        'prototype_timeline' => $existing_bid['prototype_timeline_option'] ? sanitize_text_field( $existing_bid['prototype_timeline_option'] ) : null,
                        'prototype_cost' => $existing_bid['prototype_cost'] ? floatval( $existing_bid['prototype_cost'] ) : null,
                        'video_links' => array_map( function( $link ) {
                            return esc_url_raw( $link['url'] );
                        }, $video_links ),
                        'bid_photos' => $photo_urls,
                        'created_at' => $bid_created_at,
                        'smart_alternatives_suggestion' => $smart_alternatives_suggestion,
                        'has_prototype_request' => $has_prototype_request, // Commit 2.3.9.1B: Flag for CAD prototype request
                        'prototype_request_status' => $prototype_request_status, // Commit 2.3.9.1B: Status of prototype request
                        'payment_notification' => $payment_notification, // Commit 2.3.9.1E: Payment notification data
                        // Commit 2.4.1: Bid status for supplier view
                        'bid_status' => isset( $existing_bid['status'] ) ? $existing_bid['status'] : 'submitted',
                        'is_awarded' => isset( $existing_bid['status'] ) && $existing_bid['status'] === 'awarded',
                    );
                } else {
                    // No submitted bid - check for drafts
                    $draft_bid_check = $wpdb->get_row( $wpdb->prepare(
                        "SELECT {$select_bid_fields} FROM {$item_bids_table} 
                        WHERE item_id = %d AND supplier_id = %d
                        AND status = 'draft'
                        ORDER BY created_at DESC, bid_id DESC
                        LIMIT 1",
                        $item_id,
                        $current_user->ID
                    ), ARRAY_A );
                    
                    // Only set to 'draft' if there's actually a valid draft AND no submitted bid
                    if ( $has_user_meta_draft || $draft_bid_check ) {
                        // If user meta draft exists, use it for status (button will show "Continue Bid")
                        if ( $has_user_meta_draft ) {
                            $bid_status = 'draft';
                        } elseif ( $draft_bid_check ) {
                            // Use database draft bid for both status AND data
                            $existing_bid = $draft_bid_check;
                            $bid_status = 'draft';
                        }
                    } else {
                        // No valid draft - use existing bid status
                        $bid_status = $existing_bid['status'];
                    }
                    
                    $bid_created_at = $existing_bid['created_at'];
                    $has_submitted_bid = false;
                }
            } elseif ( $has_user_meta_draft ) {
                // No database bid but user has saved a valid draft in meta - set status to draft
                $bid_status = 'draft';
                $bid_created_at = null;
                $has_submitted_bid = false;
                
                // G) Get bid revision for "Specs Changed" check (no existing_bid, so revision is null)
                $bid_revision = null;
                
                // No existing_bid, so no bid_data to populate (draft is in user meta, will be loaded via ajax_get_bid_draft)
                $bid_data = null;
            } elseif ( $existing_bid && isset( $bid_status ) && $bid_status === 'draft' ) {
                    // G) For draft bids, get basic data for pre-filling
                    $bid_id = intval( $existing_bid['bid_id'] );
                    
                    // Get video links for draft
                    $video_links = $wpdb->get_results( $wpdb->prepare(
                        "SELECT url, provider FROM {$bid_media_links_table}
                        WHERE bid_id = %d
                        ORDER BY sort_order ASC, id ASC",
                        $bid_id
                    ), ARRAY_A );
                    
                    // Get bid photos for draft
                    $bid_photos = $wpdb->get_results( $wpdb->prepare(
                        "SELECT file_url FROM {$bid_media_files_table}
                        WHERE bid_id = %d
                        ORDER BY sort_order ASC, id ASC",
                        $bid_id
                    ), ARRAY_A );
                    
                    $photo_urls = array();
                    // H) Get photo IDs and URLs for restoration (draft)
                    $bid_photo_ids = array();
                    $bid_photo_urls_array = array();
                    foreach ( $bid_photos as $photo ) {
                        if ( isset( $photo['file_url'] ) && ! empty( $photo['file_url'] ) ) {
                            $photo_urls[] = esc_url_raw( $photo['file_url'] );
                            // Try to get attachment ID from URL
                            $attachment_id = attachment_url_to_postid( $photo['file_url'] );
                            if ( $attachment_id ) {
                                $bid_photo_ids[] = $attachment_id;
                                $bid_photo_urls_array[] = array(
                                    'id' => $attachment_id,
                                    'url' => esc_url_raw( $photo['file_url'] ),
                                );
                            } else {
                                // If no attachment ID, just store URL
                                $bid_photo_urls_array[] = array(
                                    'id' => null,
                                    'url' => esc_url_raw( $photo['file_url'] ),
                                );
                            }
                        }
                    }
                    
                    // Get Smart Alternatives suggestion from meta_json for draft
                    $smart_alternatives_suggestion = null;
                    if ( $has_bid_meta_json && ! empty( $existing_bid['meta_json'] ) ) {
                        $bid_meta = json_decode( $existing_bid['meta_json'], true );
                        if ( is_array( $bid_meta ) && isset( $bid_meta['smart_alternatives_suggestion'] ) ) {
                            $smart_alternatives_suggestion = $bid_meta['smart_alternatives_suggestion'];
                        }
                    }
                    
                    $bid_data = array(
                        'unit_price' => $existing_bid['unit_price'] ? floatval( $existing_bid['unit_price'] ) : null,
                        'production_lead_time' => $existing_bid['production_lead_time_text'] ? sanitize_text_field( $existing_bid['production_lead_time_text'] ) : null,
                        'prototype_video_yes' => intval( $existing_bid['prototype_video_yes'] ) === 1,
                        'prototype_timeline' => $existing_bid['prototype_timeline_option'] ? sanitize_text_field( $existing_bid['prototype_timeline_option'] ) : null,
                        'prototype_cost' => $existing_bid['prototype_cost'] ? floatval( $existing_bid['prototype_cost'] ) : null,
                        'video_links' => array_map( function( $link ) {
                            return esc_url_raw( $link['url'] );
                        }, $video_links ),
                        'bid_photos' => $photo_urls,
                        'bid_photo_ids' => $bid_photo_ids, // H) Photo IDs for restoration
                        'bid_photo_urls' => $bid_photo_urls_array, // H) Photo URLs with IDs for restoration
                        'created_at' => $bid_created_at,
                        'smart_alternatives_suggestion' => $smart_alternatives_suggestion,
                    );
                }
                
                // Check if dims/qty changed after bid submission
                // Show warning only if latest submitted bid has stale revision (or NULL revision)
                // AND there's no current revision bid (meaning supplier hasn't resubmitted yet)
                // IMPORTANT: Only check submitted bids, NOT withdrawn bids
                // Column existence: status, created_at, bid_id are base columns (always exist)
                // rfq_revision_at_submit is optional (checked via $has_revision_column)
                // NOTE: This will be overridden later to align with has_revision_mismatch
                $show_dims_qty_warning = false;
                // Ensure item current revision is available before using it in this early warning check
                if ( ! isset( $item_current_revision ) ) {
                    $item_current_revision = isset( $meta['rfq_revision_current'] ) ? intval( $meta['rfq_revision_current'] ) : null;
                }
                if ( $has_revision_column && $item_current_revision !== null ) {
                    // First, check if supplier has a current revision bid (already resubmitted)
                    // Uses: item_id, supplier_id, rfq_revision_at_submit (checked), status (base), bid_id (base)
                    $current_revision_bid_check = $wpdb->get_var( $wpdb->prepare(
                        "SELECT COUNT(*) FROM {$item_bids_table}
                        WHERE item_id = %d
                        AND supplier_id = %d
                        AND rfq_revision_at_submit = %d
                        AND status = 'submitted'
                        LIMIT 1",
                        $item_id,
                        $current_user->ID,
                        $item_current_revision
                    ) );
                    
                    // Only show warning if there's NO current revision bid
                    if ( $current_revision_bid_check == 0 ) {
                        // Get latest submitted bid for this supplier (ONLY submitted, NOT withdrawn)
                        // Uses: rfq_revision_at_submit (checked), created_at (base), item_id, supplier_id, status (base), bid_id (base)
                        $latest_submitted_bid = $wpdb->get_row( $wpdb->prepare(
                            "SELECT rfq_revision_at_submit, created_at FROM {$item_bids_table}
                            WHERE item_id = %d
                            AND supplier_id = %d
                            AND status = 'submitted'
                            ORDER BY bid_id DESC
                            LIMIT 1",
                            $item_id,
                            $current_user->ID
                        ) );
                        
                        // Only show warning if there's actually a submitted bid (not withdrawn)
                        if ( $latest_submitted_bid ) {
                            $bid_revision = isset( $latest_submitted_bid->rfq_revision_at_submit ) ? intval( $latest_submitted_bid->rfq_revision_at_submit ) : null;
                            
                            // Show warning if bid revision is NULL or less than current revision
                            if ( $bid_revision === null || $bid_revision < $item_current_revision ) {
                                $show_dims_qty_warning = true;
                            }
                        }
                        // If no submitted bid exists (all withdrawn), no warning should show
                    }
                    // If current_revision_bid_check > 0, supplier has already resubmitted, so no warning
                } else {
                    // Fallback: Use event-based check if revision column doesn't exist
                    // IMPORTANT: Only check submitted bids, NOT withdrawn bids
                    // Column existence: created_at, status are base columns (always exist)
                    // item_id, supplier_id, bid_id are base columns (always exist)
                    $events_table = $wpdb->prefix . 'n88_events';
                    $latest_update_event = $wpdb->get_row( $wpdb->prepare(
                        "SELECT created_at FROM {$events_table}
                        WHERE event_type = 'item_facts_updated_after_rfq'
                        AND item_id = %d
                        ORDER BY created_at DESC
                        LIMIT 1",
                        $item_id
                    ) );
                    
                    // Only show warning if there's a submitted bid (not withdrawn)
                    // Get the latest submitted bid's creation date for comparison
                    // Uses: created_at (base), item_id, supplier_id, status (base), bid_id (base)
                    $latest_submitted_bid_for_fallback = $wpdb->get_row( $wpdb->prepare(
                        "SELECT created_at FROM {$item_bids_table}
                        WHERE item_id = %d
                        AND supplier_id = %d
                        AND status = 'submitted'
                        ORDER BY bid_id DESC
                        LIMIT 1",
                        $item_id,
                        $current_user->ID
                    ) );
                    
                    // If event exists and is newer than submitted bid creation, show warning
                    if ( $latest_update_event && $latest_submitted_bid_for_fallback ) {
                        $event_timestamp = strtotime( $latest_update_event->created_at );
                        $bid_timestamp = strtotime( $latest_submitted_bid_for_fallback->created_at );
                        if ( $event_timestamp > $bid_timestamp ) {
                            $show_dims_qty_warning = true;
                        }
                    }
                    // If no submitted bid exists (all withdrawn), no warning should show
                }

            // Commit 2.3.5.5: Always prioritize LATEST item meta values (from n88_items) over RFQ submission values
            // This ensures supplier always sees current dims/qty after designer edits
            $dims = null;
        // Always check item meta first (current item facts)
        if ( isset( $meta['dims'] ) && is_array( $meta['dims'] ) ) {
            $dims = $meta['dims'];
            error_log( 'Supplier Detail View - Using LATEST dimensions from item meta (dims) for item ' . $item_id );
        } elseif ( isset( $meta['dims_cm'] ) && is_array( $meta['dims_cm'] ) ) {
            $dims = $meta['dims_cm'];
            error_log( 'Supplier Detail View - Using LATEST dimensions from item meta (dims_cm) for item ' . $item_id );
        } elseif ( $delivery_context && $has_dimensions && ! empty( $delivery_context['dimensions_json'] ) ) {
            // Fallback to delivery context if item meta not available
            $decoded_dims = json_decode( $delivery_context['dimensions_json'], true );
            if ( is_array( $decoded_dims ) ) {
                $dims = array(
                    'w' => isset( $decoded_dims['width'] ) ? floatval( $decoded_dims['width'] ) : ( isset( $decoded_dims['w'] ) ? floatval( $decoded_dims['w'] ) : null ),
                    'd' => isset( $decoded_dims['depth'] ) ? floatval( $decoded_dims['depth'] ) : ( isset( $decoded_dims['d'] ) ? floatval( $decoded_dims['d'] ) : null ),
                    'h' => isset( $decoded_dims['height'] ) ? floatval( $decoded_dims['height'] ) : ( isset( $decoded_dims['h'] ) ? floatval( $decoded_dims['h'] ) : null ),
                    'unit' => isset( $decoded_dims['unit'] ) ? sanitize_text_field( $decoded_dims['unit'] ) : '',
                );
                error_log( 'Supplier Detail View - Using dimensions from delivery context (fallback) for item ' . $item_id );
            }
        } else {
            error_log( 'Supplier Detail View - No dimensions found for item ' . $item_id );
        }

        // Commit 2.3.5.5: Always prioritize LATEST item meta values (from n88_items) over RFQ submission values
        // This ensures supplier always sees current dims/qty after designer edits
        $quantity = null;
        // Always check item meta first (current item facts)
        if ( isset( $meta['quantity'] ) ) {
            $quantity = intval( $meta['quantity'] );
            error_log( 'Supplier Detail View - Using LATEST quantity from item meta for item ' . $item_id . ': ' . $quantity );
        } elseif ( $delivery_context && $has_quantity && ! empty( $delivery_context['quantity'] ) ) {
            // Fallback to delivery context if item meta not available
            $quantity = intval( $delivery_context['quantity'] );
            error_log( 'Supplier Detail View - Using quantity from delivery context (fallback) for item ' . $item_id );
        }

        // Get Smart Alternatives data from meta
        $smart_alternatives_enabled = isset( $meta['smart_alternatives'] ) && $meta['smart_alternatives'] === true;
        $smart_alternatives_note = isset( $meta['smart_alternatives_note'] ) ? sanitize_textarea_field( $meta['smart_alternatives_note'] ) : '';
        
        // Commit 2.3.5.4: Get keywords from meta (initialize as empty array if not present)
        $keywords = array();
        if ( isset( $meta['keywords'] ) && is_array( $meta['keywords'] ) ) {
            $keywords = $meta['keywords'];
        }
        
        // Commit 2.3.5.1 Addendum: Calculate Total CBM from current item facts
        $total_cbm = null;
        if ( $dims && isset( $dims['w'] ) && isset( $dims['d'] ) && isset( $dims['h'] ) && isset( $dims['unit'] ) && $quantity && $quantity > 0 ) {
            // Normalize dimensions to cm
            $w_cm = null;
            $d_cm = null;
            $h_cm = null;
            $unit = $dims['unit'];
            
            if ( $unit === 'mm' ) {
                $w_cm = floatval( $dims['w'] ) / 10;
                $d_cm = floatval( $dims['d'] ) / 10;
                $h_cm = floatval( $dims['h'] ) / 10;
            } elseif ( $unit === 'cm' ) {
                $w_cm = floatval( $dims['w'] );
                $d_cm = floatval( $dims['d'] );
                $h_cm = floatval( $dims['h'] );
            } elseif ( $unit === 'm' ) {
                $w_cm = floatval( $dims['w'] ) * 100;
                $d_cm = floatval( $dims['d'] ) * 100;
                $h_cm = floatval( $dims['h'] ) * 100;
            } elseif ( $unit === 'in' ) {
                $w_cm = floatval( $dims['w'] ) * 2.54;
                $d_cm = floatval( $dims['d'] ) * 2.54;
                $h_cm = floatval( $dims['h'] ) * 2.54;
            }
            
            if ( $w_cm && $d_cm && $h_cm ) {
                // Convert cm to meters, then calculate CBM per unit
                $w_m = $w_cm / 100;
                $d_m = $d_cm / 100;
                $h_m = $h_cm / 100;
                $item_cbm = $w_m * $d_m * $h_m;
                // Calculate Total CBM (item_cbm Ã— quantity)
                $total_cbm = round( $item_cbm * $quantity, 3 );
            }
        }

        // G) Get item current revision for "Specs Changed" check
        // Initialize early to prevent undefined variable warnings
        if ( ! isset( $item_current_revision ) ) {
            $item_current_revision = isset( $meta['rfq_revision_current'] ) ? intval( $meta['rfq_revision_current'] ) : null;
        }
        
        // G) Check if supplier has revision mismatch (stale bid but no current revision bid)
        // IMPORTANT: Only show "Resubmit Bid" when specs changed (has_revision_mismatch = true)
        // Otherwise show "Bid Already Submitted" + "Withdraw Bid"
        $has_revision_mismatch = false;
        $latest_stale_bid_data = null;
        $is_resubmission = false; // Flag to track if this is a resubmission (has current revision bid AND had stale bid)
        
        // Re-check column existence right before using it (in case it was just created)
        if ( $item_current_revision !== null ) {
            $bids_columns_recheck = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
            $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns_recheck, true );
        }
        
        if ( $item_current_revision !== null && $has_revision_column ) {
            // First, check if supplier has a current revision bid (already resubmitted or in progress)
            // Check for submitted bid first (takes priority)
            $current_revision_bid = $wpdb->get_row( $wpdb->prepare(
                "SELECT bid_id, status FROM {$item_bids_table} 
                WHERE item_id = %d 
                AND supplier_id = %d
                AND rfq_revision_at_submit = %d
                AND status = 'submitted'
                LIMIT 1",
                $item_id,
                $current_user->ID,
                $item_current_revision
            ), ARRAY_A );
            
            // If no submitted bid, check for draft bid
            if ( ! $current_revision_bid ) {
                $current_revision_bid = $wpdb->get_row( $wpdb->prepare(
                    "SELECT bid_id, status FROM {$item_bids_table} 
                    WHERE item_id = %d 
                    AND supplier_id = %d
                    AND rfq_revision_at_submit = %d
                    AND status = 'draft'
                    LIMIT 1",
                    $item_id,
                    $current_user->ID,
                    $item_current_revision
                ), ARRAY_A );
            }
            
            if ( $current_revision_bid ) {
                // Supplier has already resubmitted with current revision (or has draft) - NO resubmit button
                $has_revision_mismatch = false;
                
                // Check if there was a previous stale bid (to show "Bid Already Resubmitted" vs "Bid Already Submitted")
                $stale_bid_exists = $wpdb->get_var( $wpdb->prepare(
                    "SELECT COUNT(*) FROM {$item_bids_table} 
                    WHERE item_id = %d 
                    AND supplier_id = %d
                    AND (rfq_revision_at_submit IS NULL OR rfq_revision_at_submit < %d)
                    AND status IN ('submitted', 'draft', 'withdrawn')
                    LIMIT 1",
                    $item_id,
                    $current_user->ID,
                    $item_current_revision
                ) );
                if ( $stale_bid_exists > 0 ) {
                    $is_resubmission = true;
                }
            } else {
                // No current revision bid - check if there are any stale bids
                // This means specs changed and supplier hasn't resubmitted yet
                // IMPORTANT: Double-check that there's really no current revision bid
                // (in case of race condition or timing issue)
                $double_check_current = $wpdb->get_var( $wpdb->prepare(
                    "SELECT COUNT(*) FROM {$item_bids_table} 
                    WHERE item_id = %d 
                    AND supplier_id = %d
                    AND rfq_revision_at_submit = %d
                    AND status = 'submitted'",
                    $item_id,
                    $current_user->ID,
                    $item_current_revision
                ) );
                
                if ( $double_check_current > 0 ) {
                    // Actually has current revision bid - supplier has resubmitted
                    // FORCE has_revision_mismatch to false (supplier resubmitted, no mismatch)
                    $has_revision_mismatch = false;
                    $latest_stale_bid_data = null; // Clear stale bid data since supplier resubmitted
                    
                    // Check if there was a previous stale bid (to show "Bid Already Resubmitted")
                    $stale_bid_exists = $wpdb->get_var( $wpdb->prepare(
                        "SELECT COUNT(*) FROM {$item_bids_table} 
                        WHERE item_id = %d 
                        AND supplier_id = %d
                        AND (rfq_revision_at_submit IS NULL OR rfq_revision_at_submit < %d)
                        AND status IN ('submitted', 'draft', 'withdrawn')",
                        $item_id,
                        $current_user->ID,
                        $item_current_revision
                    ) );
                    if ( $stale_bid_exists > 0 ) {
                        $is_resubmission = true;
                    }
                } else {
                    // No current revision bid - check for stale bids
                    $stale_bid_check = $wpdb->get_row( $wpdb->prepare(
                        "SELECT rfq_revision_at_submit, bid_id, status FROM {$item_bids_table}
                        WHERE item_id = %d
                        AND supplier_id = %d
                        AND status = 'submitted'
                        AND (rfq_revision_at_submit IS NULL OR rfq_revision_at_submit < %d)
                        ORDER BY bid_id DESC
                        LIMIT 1",
                        $item_id,
                        $current_user->ID,
                        $item_current_revision
                    ), ARRAY_A );
                    
                    if ( $stale_bid_check ) {
                        // Stale bid exists and no current revision bid - show resubmit button
                        $has_revision_mismatch = true;
                        
                        // Get stale bid data for pre-filling (fetch fresh from database)
                        $stale_bid_id = intval( $stale_bid_check['bid_id'] );
                        $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
                        $has_bid_meta_json = in_array( 'meta_json', $bids_columns, true );
                        
                        $select_stale_fields = "bid_id, status, created_at, unit_price, production_lead_time_text, prototype_video_yes, prototype_timeline_option, prototype_cost";
                        if ( $has_bid_meta_json ) {
                            $select_stale_fields .= ", meta_json";
                        }
                        if ( $has_revision_column ) {
                            $select_stale_fields .= ", rfq_revision_at_submit";
                        }
                        
                        $stale_bid_full = $wpdb->get_row( $wpdb->prepare(
                            "SELECT {$select_stale_fields} FROM {$item_bids_table} WHERE bid_id = %d",
                            $stale_bid_id
                        ), ARRAY_A );
                        
                        if ( $stale_bid_full ) {
                            $latest_stale_bid_data = $stale_bid_full;
                        } elseif ( $bid_data ) {
                            // Fallback to bid_data if available
                            $latest_stale_bid_data = $bid_data;
                        }
                    }
                    // If no stale bids found, has_revision_mismatch stays false (no bids at all)
                }
            }
        } elseif ( ! $has_revision_column ) {
            // No revision column - fall back to event timestamps.
            // We treat "specs changed" as: latest item_facts_updated_after_rfq event is newer than the supplier's
            // latest submitted bid for this item. After the supplier submits again, their latest submitted bid will
            // be newer than the event, and the mismatch will clear automatically.
            $events_table = $wpdb->prefix . 'n88_events';
            $latest_update_event = $wpdb->get_row( $wpdb->prepare(
                "SELECT created_at FROM {$events_table}
                 WHERE event_type = 'item_facts_updated_after_rfq'
                 AND item_id = %d
                 ORDER BY created_at DESC
                 LIMIT 1",
                $item_id
            ) );

            // Latest submitted bid timestamp (ignore withdrawn/draft)
            // IMPORTANT: Order by created_at DESC to get the most recent bid (after resubmission)
            $latest_submitted_bid_for_mismatch = $wpdb->get_row( $wpdb->prepare(
                "SELECT bid_id, created_at FROM {$item_bids_table}
                 WHERE item_id = %d
                 AND supplier_id = %d
                 AND status = 'submitted'
                 ORDER BY created_at DESC, bid_id DESC
                 LIMIT 1",
                $item_id,
                $current_user->ID
            ) );

            if ( $latest_update_event && $latest_submitted_bid_for_mismatch ) {
                $event_ts = strtotime( $latest_update_event->created_at );
                $bid_ts = strtotime( $latest_submitted_bid_for_mismatch->created_at );
                // Only show mismatch if event is NEWER than bid (meaning specs changed AFTER bid was submitted)
                // If bid is NEWER than event (meaning supplier resubmitted AFTER specs changed), no mismatch
                // CRITICAL: Use >= comparison to handle edge case where timestamps are equal
                if ( $event_ts && $bid_ts && $event_ts > $bid_ts ) {
                    // Event is newer - specs changed after bid was submitted
                    $has_revision_mismatch = true;
                    
                    // Get stale bid data for pre-filling (fetch from the stale bid)
                    $stale_bid_id = intval( $latest_submitted_bid_for_mismatch->bid_id );
                    $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
                    $has_bid_meta_json = in_array( 'meta_json', $bids_columns, true );
                    
                    $select_stale_fields = "bid_id, status, created_at, unit_price, production_lead_time_text, prototype_video_yes, prototype_timeline_option, prototype_cost";
                    if ( $has_bid_meta_json ) {
                        $select_stale_fields .= ", meta_json";
                    }
                    
                    $stale_bid_full = $wpdb->get_row( $wpdb->prepare(
                        "SELECT {$select_stale_fields} FROM {$item_bids_table} WHERE bid_id = %d",
                        $stale_bid_id
                    ), ARRAY_A );
                    
                    if ( $stale_bid_full ) {
                        $latest_stale_bid_data = $stale_bid_full;
                    } elseif ( $bid_data ) {
                        // Fallback to bid_data if available
                        $latest_stale_bid_data = $bid_data;
                    }
                } else {
                    // Bid is newer than event OR timestamps are equal - supplier has already resubmitted
                    // FORCE has_revision_mismatch to false (supplier resubmitted, no mismatch)
                    $has_revision_mismatch = false;
                    $latest_stale_bid_data = null; // Clear stale bid data since supplier resubmitted
                    
                    // Check if there was a previous stale bid (to show "Bid Already Resubmitted")
                    $older_bid_check = $wpdb->get_var( $wpdb->prepare(
                        "SELECT COUNT(*) FROM {$item_bids_table}
                         WHERE item_id = %d
                         AND supplier_id = %d
                         AND status = 'submitted'
                         AND created_at < %s
                         LIMIT 1",
                        $item_id,
                        $current_user->ID,
                        $latest_submitted_bid_for_mismatch->created_at
                    ) );
                    if ( $older_bid_check > 0 ) {
                        $is_resubmission = true;
                    }
                }
            } else {
                // No event or no bid - no mismatch
                // FORCE has_revision_mismatch to false
                $has_revision_mismatch = false;
                $latest_stale_bid_data = null; // Clear stale bid data
            }
        }
        
        // IMPORTANT: Align show_dims_qty_warning with has_revision_mismatch
        // When specs change (has_revision_mismatch = true), show the warning AND resubmit button
        // When new bid is submitted (has_revision_mismatch = false), hide the warning
        // Only show warning if there's a submitted bid (not draft, not withdrawn)
        if ( $has_revision_mismatch && isset( $bid_status ) && $bid_status === 'submitted' ) {
            // Specs changed and supplier has a stale submitted bid - show warning
            $show_dims_qty_warning = true;
        } else {
            // No revision mismatch OR no submitted bid - hide warning
            $show_dims_qty_warning = false;
        }
        
        // has_operator_supplier_messages: true when operator has sent any message to this supplier (supplier_operator thread) â€” auto-expand Operatorâ€“Supplier Messages in modal
        $has_operator_supplier_messages = false;
        if ( $is_supplier ) {
            $messages_table = $wpdb->prefix . 'n88_item_messages';
            if ( $wpdb->get_var( "SHOW TABLES LIKE '{$messages_table}'" ) === $messages_table ) {
                $exists = $wpdb->get_var( $wpdb->prepare(
                    "SELECT 1 FROM {$messages_table} WHERE item_id = %d AND thread_type = 'supplier_operator' AND sender_role = 'operator' AND supplier_id = %d LIMIT 1",
                    $item_id,
                    $current_user->ID
                ) );
                $has_operator_supplier_messages = (bool) $exists;
            }
        }
        
        // Commit 2.3.9.2: When supplier has a prototype request but we didn't set item_level_payment_notification (e.g. no submitted/awarded bid in this path), fetch it so Prototype tab always shows
        if ( $is_supplier && $item_level_payment_notification === null ) {
            $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
            if ( $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table ) {
                $standalone_pp = $wpdb->get_row( $wpdb->prepare(
                    "SELECT id, bid_id, status, video_direction_json, cad_status, cad_approved_version, cad_released_to_supplier_at FROM {$prototype_payments_table}
                    WHERE item_id = %d AND supplier_id = %d
                    ORDER BY created_at DESC
                    LIMIT 1",
                    $item_id,
                    $current_user->ID
                ), ARRAY_A );
                if ( $standalone_pp ) {
                    $item_level_payment_notification = array(
                        'status' => $standalone_pp['status'],
                        'payment_id' => isset( $standalone_pp['id'] ) ? intval( $standalone_pp['id'] ) : null,
                        'item_id' => $item_id,
                        'bid_id' => isset( $standalone_pp['bid_id'] ) ? intval( $standalone_pp['bid_id'] ) : null,
                        'keywords' => array(),
                        'note' => '',
                        'cad_status' => isset( $standalone_pp['cad_status'] ) ? $standalone_pp['cad_status'] : null,
                        'cad_approved_version' => isset( $standalone_pp['cad_approved_version'] ) ? intval( $standalone_pp['cad_approved_version'] ) : null,
                        'cad_released_to_supplier_at' => isset( $standalone_pp['cad_released_to_supplier_at'] ) ? $standalone_pp['cad_released_to_supplier_at'] : null,
                        'cad_files' => array(),
                        'prototype_status' => null,
                        'prototype_feedback' => null,
                        'prototype_video_submission' => null,
                    );
                    // Load keywords/note/cad_files/submission when payment received or CAD approved (same as main path)
                    $fetch_full = ( $standalone_pp['status'] === 'marked_received' ) || ( isset( $standalone_pp['cad_status'] ) && $standalone_pp['cad_status'] === 'approved' );
                    if ( $fetch_full && ! empty( $standalone_pp['video_direction_json'] ) ) {
                        $vd = json_decode( $standalone_pp['video_direction_json'], true );
                        if ( is_array( $vd ) ) {
                            $item_level_payment_notification['note'] = isset( $vd['note'] ) ? $vd['note'] : '';
                            $kw_ids = isset( $vd['selected_keywords'] ) ? array_map( 'intval', (array) $vd['selected_keywords'] ) : array();
                            $kw_ids = array_filter( $kw_ids );
                            if ( ! empty( $kw_ids ) ) {
                                $keywords_table = $wpdb->prefix . 'n88_keywords';
                                $ids_str = implode( ',', array_map( 'intval', $kw_ids ) );
                                $kw_rows = $wpdb->get_results( "SELECT keyword FROM {$keywords_table} WHERE keyword_id IN ({$ids_str}) AND is_active = 1", ARRAY_A );
                                foreach ( $kw_rows as $kw ) {
                                    if ( ! empty( $kw['keyword'] ) ) {
                                        $item_level_payment_notification['keywords'][] = sanitize_text_field( $kw['keyword'] );
                                    }
                                }
                            }
                        }
                    }
                    if ( $fetch_full && isset( $standalone_pp['cad_status'] ) && $standalone_pp['cad_status'] === 'approved' && ! empty( $standalone_pp['cad_approved_version'] ) ) {
                        $item_files_table = $wpdb->prefix . 'n88_item_files';
                        $cad_records = $wpdb->get_results( $wpdb->prepare(
                            "SELECT f.file_id, f.attachment_type, a.guid, a.post_title FROM {$item_files_table} f INNER JOIN {$wpdb->posts} a ON f.file_id = a.ID WHERE f.item_id = %d AND f.payment_id = %d AND f.attachment_type = 'cad' AND f.cad_version = %d AND f.detached_at IS NULL ORDER BY f.id ASC",
                            $item_id,
                            $standalone_pp['id'],
                            intval( $standalone_pp['cad_approved_version'] )
                        ), ARRAY_A );
                        foreach ( $cad_records as $fr ) {
                            $url = isset( $fr['guid'] ) ? esc_url_raw( $fr['guid'] ) : '';
                            $name = isset( $fr['post_title'] ) ? sanitize_file_name( $fr['post_title'] ) : '';
                            if ( $url && $name ) {
                                $item_level_payment_notification['cad_files'][] = array( 'name' => $name, 'url' => $url, 'ext' => strtolower( pathinfo( $name, PATHINFO_EXTENSION ) ) );
                            }
                        }
                    }
                    $pp_columns = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
                    if ( in_array( 'prototype_status', $pp_columns, true ) ) {
                        $ps_row = $wpdb->get_row( $wpdb->prepare( "SELECT prototype_status FROM {$prototype_payments_table} WHERE id = %d", $standalone_pp['id'] ), ARRAY_A );
                        if ( $ps_row ) {
                            $item_level_payment_notification['prototype_status'] = $ps_row['prototype_status'];
                        }
                    }
                    $submissions_table = $wpdb->prefix . 'n88_prototype_video_submissions';
                    if ( $wpdb->get_var( "SHOW TABLES LIKE '{$submissions_table}'" ) === $submissions_table ) {
                        $lat = $wpdb->get_row( $wpdb->prepare( "SELECT id, version, link_count, created_at FROM {$submissions_table} WHERE payment_id = %d ORDER BY version DESC LIMIT 1", $standalone_pp['id'] ), ARRAY_A );
                        if ( $lat ) {
                            $links_table = $wpdb->prefix . 'n88_prototype_video_links';
                            $links = $wpdb->get_results( $wpdb->prepare( "SELECT provider, url, sort_order FROM {$links_table} WHERE submission_id = %d ORDER BY sort_order ASC", $lat['id'] ), ARRAY_A );
                            $item_level_payment_notification['prototype_video_submission'] = array(
                                'version' => intval( $lat['version'] ),
                                'link_count' => intval( $lat['link_count'] ),
                                'created_at' => $lat['created_at'],
                                'links' => $links ? $links : array(),
                            );
                        }
                    }
                }
            }
        }
        
        // Supplier Workflow tab: workflow_milestones and active step for 3-step view (CAD â†’ Approved CAD â†’ Prototype videos)
        $workflow_milestones = array(
            'step1' => array( 'cad_requested_at' => null, 'payment_sent_at' => null, 'payment_approved_at' => null ),
            'step2' => array( 'cad_received_at' => null, 'revision_submitted_at' => null, 'revision_sent_at' => null, 'cad_approved_at' => null, 'cad_released_to_supplier_at' => null ),
            'step3' => array( 'video_submitted_at' => null, 'changes_requested_at' => null, 'changes_requested_dates' => array(), 'video_resubmitted_at' => null, 'video_resubmitted_dates' => array(), 'video_approved_at' => null ),
        );
        $supplier_workflow_active_step = null; // 0, 1, or 2 when modal should open on Workflow tab
        if ( $item_level_payment_notification && ! empty( $item_level_payment_notification['payment_id'] ) ) {
            $workflow_milestones = $this->get_workflow_milestones_for_supplier( $item_id, (int) $item_level_payment_notification['payment_id'] );
            $notif = $item_level_payment_notification;
            $status = isset( $notif['status'] ) ? $notif['status'] : '';
            $cad_status = isset( $notif['cad_status'] ) ? $notif['cad_status'] : '';
            $has_submission = ! empty( $notif['prototype_video_submission'] );
            $prototype_status = isset( $notif['prototype_status'] ) ? $notif['prototype_status'] : '';
            if ( $status === 'requested' || ( $status === 'marked_received' && $cad_status !== 'approved' ) ) {
                $supplier_workflow_active_step = 0; // Step 1
            } elseif ( $cad_status === 'approved' && ! $has_submission ) {
                $supplier_workflow_active_step = 1; // Step 2
            } elseif ( $has_submission || $prototype_status === 'changes_requested' || $prototype_status === 'approved' ) {
                $supplier_workflow_active_step = 2; // Step 3
            }
        }

        // Build response (read-only, no writes)
        // Commit 2.3.5.4: Remove total_cbm from supplier response (CBM should not be visible to suppliers)
        // Commit 2.4.1: Include 'awarded' status so supplier can see their awarded bid
        // Ensure bid_status is only 'draft' when there's actually a valid draft, otherwise null (shows "Start Bid")
        // But keep 'submitted' and 'awarded' status so supplier can see their bid details
        if ( ! isset( $bid_status ) || ( $bid_status !== 'draft' && $bid_status !== 'submitted' && $bid_status !== 'awarded' ) ) {
            $bid_status = null; // Default to null - will show "Start Bid" button
        }
        
        $response = array(
            'item_id' => intval( $item['id'] ),
            'title' => sanitize_text_field( $item['title'] ),
            'description' => sanitize_textarea_field( $item['description'] ),
            'category' => $category_name,
            'keywords' => array_map( 'sanitize_text_field', $keywords ), // Commit 2.3.5.4: Add keywords
            'image_url' => $image_url ? esc_url_raw( $image_url ) : '', // Keep for backward compatibility
            'primary_image_url' => $primary_image_url ? esc_url_raw( $primary_image_url ) : '', // Standardized key
            'quantity' => $quantity,
            'dimensions' => $dims,
            // Commit 2.3.5.4: total_cbm removed - CBM should not be visible to suppliers
            'sourcing_type' => isset( $meta['sourcing_type'] ) ? sanitize_text_field( $meta['sourcing_type'] ) : null,
            'timeline_type' => isset( $meta['timeline_type'] ) ? sanitize_text_field( $meta['timeline_type'] ) : null,
            'delivery_country' => $delivery_context ? sanitize_text_field( $delivery_context['delivery_country_code'] ) : null,
            'delivery_postal_code' => $delivery_context && ! empty( $delivery_context['delivery_postal_code'] ) ? sanitize_text_field( $delivery_context['delivery_postal_code'] ) : null,
            'shipping_mode_label' => $shipping_mode_label,
            'route_label' => $route_label,
            'reference_images' => $reference_images, // Keep for backward compatibility
            'inspiration_images' => $inspiration_images, // Standardized key
            'media_links' => $media_links,
            'smart_alternatives_enabled' => $smart_alternatives_enabled,
            'smart_alternatives_note' => $smart_alternatives_note,
            'bid_status' => $bid_status, // Commit 2.3.5 - bid status: 'draft' (Continue Bid), 'submitted' (Bid Submitted), or null (Start Bid)
            'show_dims_qty_warning' => $show_dims_qty_warning, // Commit 2.3.5.1 Addendum: Flag to show warning banner
            'bid_data' => $bid_data, // Bid details when bid is submitted
            'payment_notification' => $item_level_payment_notification, // Commit 2.3.9.2: Prototype tab â€” always when supplier has prototype request (item-level so tab shows even without bid_data)
            'rfq_revision_current' => isset( $item_current_revision ) ? $item_current_revision : null, // G) Current item revision
            'bid_revision' => isset( $bid_revision ) ? $bid_revision : null, // G) Supplier's bid revision (ensure it's always set)
            'has_revision_mismatch' => $has_revision_mismatch, // G) Flag for "Specs Changed" banner
            'latest_stale_bid_data' => $latest_stale_bid_data, // G) Latest stale bid data for pre-filling
            'is_resubmission' => $is_resubmission, // G) Flag to show "Bid Already Resubmitted" instead of "Bid Already Submitted"
            'has_operator_supplier_messages' => $has_operator_supplier_messages, // Auto-expand Operatorâ€“Supplier Messages when any message exists
            'workflow_milestones' => $workflow_milestones, // Supplier Workflow tab: dates per step (step1/2/3)
            'supplier_workflow_active_step' => $supplier_workflow_active_step, // 0|1|2 when to open modal on Workflow tab
        );

        wp_send_json_success( $response );
    }

    /**
     * Build workflow_milestones for supplier (same structure as designer RFQ state). Used for supplier Workflow tab 3-step view.
     *
     * @param int $item_id
     * @param int $prototype_payment_id
     * @return array step1/step2/step3 with date keys
     */
    private function get_workflow_milestones_for_supplier( $item_id, $prototype_payment_id ) {
        global $wpdb;
        $item_id = absint( $item_id );
        $prototype_payment_id = absint( $prototype_payment_id );
        $out = array(
            'step1' => array( 'cad_requested_at' => null, 'payment_sent_at' => null, 'payment_approved_at' => null ),
            'step2' => array( 'cad_received_at' => null, 'revision_submitted_at' => null, 'revision_sent_at' => null, 'cad_approved_at' => null, 'cad_released_to_supplier_at' => null ),
            'step3' => array( 'video_submitted_at' => null, 'changes_requested_at' => null, 'changes_requested_dates' => array(), 'video_resubmitted_at' => null, 'video_resubmitted_dates' => array(), 'video_approved_at' => null ),
        );
        $payments_table = $wpdb->prefix . 'n88_prototype_payments';
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$payments_table}'" ) !== $payments_table || ! $prototype_payment_id ) {
            return $out;
        }
        $pp = $wpdb->get_row( $wpdb->prepare(
            "SELECT created_at, received_at, cad_approved_at, cad_released_to_supplier_at FROM {$payments_table} WHERE id = %d",
            $prototype_payment_id
        ), ARRAY_A );
        if ( ! $pp ) {
            return $out;
        }
        $out['step1']['cad_requested_at'] = isset( $pp['created_at'] ) ? $pp['created_at'] : null;
        $out['step1']['payment_approved_at'] = ( isset( $pp['received_at'] ) && trim( (string) $pp['received_at'] ) !== '' ) ? $pp['received_at'] : null;
        $out['step2']['cad_approved_at'] = isset( $pp['cad_approved_at'] ) ? $pp['cad_approved_at'] : null;
        $out['step2']['cad_released_to_supplier_at'] = isset( $pp['cad_released_to_supplier_at'] ) ? $pp['cad_released_to_supplier_at'] : null;

        $receipts_table = $wpdb->prefix . 'n88_prototype_payment_receipts';
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$receipts_table}'" ) === $receipts_table ) {
            $receipt_cols = $wpdb->get_col( "DESCRIBE {$receipts_table}" );
            $receipt_date_col = is_array( $receipt_cols ) && in_array( 'uploaded_at', $receipt_cols, true ) ? 'uploaded_at' : 'created_at';
            $first_receipt = $wpdb->get_var( $wpdb->prepare(
                "SELECT MIN({$receipt_date_col}) FROM {$receipts_table} WHERE payment_id = %d",
                $prototype_payment_id
            ) );
            if ( $first_receipt ) {
                $out['step1']['payment_sent_at'] = $first_receipt;
            }
        }

        $item_files_table = $wpdb->prefix . 'n88_item_files';
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$item_files_table}'" ) === $item_files_table ) {
            $files_date_col = 'attached_at';
            $cols = $wpdb->get_col( "DESCRIBE {$item_files_table}" );
            if ( is_array( $cols ) && in_array( 'created_at', $cols, true ) ) {
                $files_date_col = 'created_at';
            }
            $first_cad = $wpdb->get_var( $wpdb->prepare(
                "SELECT MIN({$files_date_col}) FROM {$item_files_table} WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
                $item_id,
                $prototype_payment_id
            ) );
            if ( $first_cad ) {
                $out['step2']['cad_received_at'] = $first_cad;
            }
            $cad_count = $wpdb->get_var( $wpdb->prepare(
                "SELECT COUNT(*) FROM {$item_files_table} WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
                $item_id,
                $prototype_payment_id
            ) );
            if ( $cad_count && (int) $cad_count > 1 ) {
                $revision_sent = $wpdb->get_var( $wpdb->prepare(
                    "SELECT MAX({$files_date_col}) FROM {$item_files_table} WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
                    $item_id,
                    $prototype_payment_id
                ) );
                if ( $revision_sent ) {
                    $out['step2']['revision_sent_at'] = $revision_sent;
                }
            }
        }

        $messages_table = $wpdb->prefix . 'n88_item_messages';
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$messages_table}'" ) === $messages_table ) {
            $revision_requested_at = $wpdb->get_var( $wpdb->prepare(
                "SELECT MIN(created_at) FROM {$messages_table} WHERE item_id = %d AND thread_type = 'designer_operator' AND sender_role = 'designer' AND message_text LIKE %s",
                $item_id,
                '%Revision requested%'
            ) );
            if ( $revision_requested_at ) {
                $out['step2']['revision_submitted_at'] = $revision_requested_at;
            }
        }

        $pvs_table = $wpdb->prefix . 'n88_prototype_video_submissions';
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$pvs_table}'" ) === $pvs_table ) {
            $first_sub = $wpdb->get_row( $wpdb->prepare(
                "SELECT created_at FROM {$pvs_table} WHERE payment_id = %d ORDER BY version ASC LIMIT 1",
                $prototype_payment_id
            ), ARRAY_A );
            if ( $first_sub && ! empty( $first_sub['created_at'] ) ) {
                $out['step3']['video_submitted_at'] = $first_sub['created_at'];
            }
            $resubmit_row = $wpdb->get_row( $wpdb->prepare(
                "SELECT created_at FROM {$pvs_table} WHERE payment_id = %d AND version > 1 ORDER BY version DESC LIMIT 1",
                $prototype_payment_id
            ), ARRAY_A );
            if ( $resubmit_row && ! empty( $resubmit_row['created_at'] ) ) {
                $out['step3']['video_resubmitted_at'] = $resubmit_row['created_at'];
            }
            $resubmitted_dates = $wpdb->get_col( $wpdb->prepare(
                "SELECT created_at FROM {$pvs_table} WHERE payment_id = %d AND version > 1 ORDER BY version ASC",
                $prototype_payment_id
            ) );
            $out['step3']['video_resubmitted_dates'] = is_array( $resubmitted_dates ) ? $resubmitted_dates : array();
        }

        $fb_table = $wpdb->prefix . 'n88_prototype_feedback_packets';
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$fb_table}'" ) === $fb_table ) {
            $changes_at = $wpdb->get_var( $wpdb->prepare(
                "SELECT MIN(created_at) FROM {$fb_table} WHERE payment_id = %d",
                $prototype_payment_id
            ) );
            if ( $changes_at ) {
                $out['step3']['changes_requested_at'] = $changes_at;
            }
            // All feedback packet dates (for multiple "changes requested" in step 3)
            $changes_dates = $wpdb->get_col( $wpdb->prepare(
                "SELECT created_at FROM {$fb_table} WHERE payment_id = %d ORDER BY created_at ASC",
                $prototype_payment_id
            ) );
            $out['step3']['changes_requested_dates'] = is_array( $changes_dates ) ? $changes_dates : array();
        } else {
            $out['step3']['changes_requested_dates'] = array();
        }

        $pp_columns = $wpdb->get_col( "DESCRIBE {$payments_table}" );
        if ( is_array( $pp_columns ) && in_array( 'prototype_approved_at', $pp_columns, true ) ) {
            $pa_row = $wpdb->get_row( $wpdb->prepare(
                "SELECT prototype_approved_at FROM {$payments_table} WHERE id = %d LIMIT 1",
                $prototype_payment_id
            ), ARRAY_A );
            if ( $pa_row && ! empty( $pa_row['prototype_approved_at'] ) ) {
                $out['step3']['video_approved_at'] = $pa_row['prototype_approved_at'];
            }
        }

        return $out;
    }

    /**
     * AJAX handler to get item RFQ and bid state for designer modal
     * Returns: has_rfq (boolean), has_bids (boolean), bids (array if has_bids)
     */
    public function ajax_get_item_rfq_state() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_designer && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer account required.' ) );
        }

        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }

        global $wpdb;
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $bid_media_links_table = $wpdb->prefix . 'n88_bid_media_links';
        $items_table = $wpdb->prefix . 'n88_items';

        // Check if item exists and user owns it (unless system operator)
        if ( ! $is_system_operator ) {
            $item_owner = $wpdb->get_var( $wpdb->prepare(
                "SELECT owner_user_id FROM {$items_table} WHERE id = %d",
                $item_id
            ) );
            
            if ( ! $item_owner || intval( $item_owner ) !== $current_user->ID ) {
                wp_send_json_error( array( 'message' => 'Access denied. You can only view your own items.' ), 403 );
            }
        }

        // Get item meta for Smart Alternatives (item-level setting, same for all bids)
        $item_meta = $wpdb->get_var( $wpdb->prepare(
            "SELECT meta_json FROM {$items_table} WHERE id = %d",
            $item_id
        ) );
        
        $smart_alternatives_enabled = false;
        $smart_alternatives_note = '';
        $rfq_revision_current = null;
        $revision_changed = false;
        $item_quantity = 1; // Default quantity
        if ( ! empty( $item_meta ) ) {
            $meta = json_decode( $item_meta, true );
            if ( is_array( $meta ) ) {
                $smart_alternatives_enabled = isset( $meta['smart_alternatives'] ) && $meta['smart_alternatives'] === true;
                $smart_alternatives_note = isset( $meta['smart_alternatives_note'] ) ? sanitize_textarea_field( $meta['smart_alternatives_note'] ) : '';
                // D5: Get revision info for Specs Updated panel
                if ( isset( $meta['rfq_revision_current'] ) ) {
                    $rfq_revision_current = intval( $meta['rfq_revision_current'] );
                }
                if ( isset( $meta['revision_changed'] ) ) {
                    $revision_changed = (bool) $meta['revision_changed'];
                }
                // Get item quantity for price calculation
                if ( isset( $meta['quantity'] ) && $meta['quantity'] > 0 ) {
                    $item_quantity = (int) $meta['quantity'];
                }
            }
        }
        
        // Fallback: Get quantity from delivery_context if not in item meta
        if ( $item_quantity === 1 ) {
            $delivery_context_table = $wpdb->prefix . 'n88_item_delivery_context';
            $delivery_quantity = $wpdb->get_var( $wpdb->prepare(
                "SELECT quantity FROM {$delivery_context_table} WHERE item_id = %d",
                $item_id
            ) );
            if ( $delivery_quantity && $delivery_quantity > 0 ) {
                $item_quantity = (int) $delivery_quantity;
            }
        }

        // Check if RFQ exists (has any routes for this item)
        $has_rfq = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM {$rfq_routes_table} 
            WHERE item_id = %d 
            AND status IN ('queued', 'sent', 'viewed', 'bid_submitted')",
            $item_id
        ) ) > 0;

        // Check if bids exist (submitted, awarded, or declined)
        $has_bids = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM {$item_bids_table} 
            WHERE item_id = %d 
            AND status IN ('submitted', 'awarded', 'declined')",
            $item_id
        ) ) > 0;
        
        // Commit 2.4.1: Check if any bid is already awarded
        $has_awarded_bid = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM {$item_bids_table} 
            WHERE item_id = %d 
            AND status = 'awarded'",
            $item_id
        ) ) > 0;

        $bids = array();
        if ( $has_bids ) {
            // Commit 2.3.6: Get all submitted bids with CAD flag, prototype commitment, and photos
            // Check if meta_json and rfq_revision_at_submit columns exist
            $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
            $has_bid_meta_json = in_array( 'meta_json', $bids_columns, true );
            $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
            
            $select_fields = "b.bid_id, b.supplier_id, b.unit_price, b.production_lead_time_text, b.prototype_timeline_option, b.prototype_cost, b.prototype_video_yes, b.cad_yes, b.status, b.created_at";
            if ( $has_bid_meta_json ) {
                $select_fields .= ", b.meta_json";
            }
            if ( $has_revision_column ) {
                $select_fields .= ", b.rfq_revision_at_submit";
            }
            
            $bids_data = $wpdb->get_results( $wpdb->prepare(
                "SELECT {$select_fields}
                FROM {$item_bids_table} b
                WHERE b.item_id = %d 
                AND b.status IN ('submitted', 'awarded', 'declined')
                ORDER BY 
                    CASE b.status
                        WHEN 'awarded' THEN 1
                        WHEN 'submitted' THEN 2
                        WHEN 'declined' THEN 3
                    END,
                    b.created_at ASC, b.bid_id ASC",
                $item_id
            ), ARRAY_A );

            // Commit 2.3.10: Get delivery cost for this item
            $delivery_context_table = $wpdb->prefix . 'n88_item_delivery_context';
            $delivery_cost_data = null;
            $delivery_shipping_mode = null;
            
            $table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$delivery_context_table}'" ) === $delivery_context_table;
            if ( $table_exists ) {
                $columns = $wpdb->get_col( "DESCRIBE {$delivery_context_table}" );
                $has_delivery_cost = in_array( 'delivery_cost_usd', $columns, true );
                $has_shipping_mode = in_array( 'shipping_mode', $columns, true );
                
                if ( $has_delivery_cost || $has_shipping_mode ) {
                    $select_delivery = 'delivery_country_code';
                    if ( $has_delivery_cost ) {
                        $select_delivery .= ', delivery_cost_usd';
                    }
                    if ( $has_shipping_mode ) {
                        $select_delivery .= ', shipping_mode';
                    }
                    
                    $delivery_context = $wpdb->get_row( $wpdb->prepare(
                        "SELECT {$select_delivery} FROM {$delivery_context_table} WHERE item_id = %d",
                        $item_id
                    ), ARRAY_A );
                    
                    if ( $delivery_context ) {
                        // Only show delivery cost for US
                        $delivery_country = isset( $delivery_context['delivery_country_code'] ) ? strtoupper( trim( $delivery_context['delivery_country_code'] ) ) : '';
                        if ( $delivery_country === 'US' ) {
                            $delivery_cost_data = isset( $delivery_context['delivery_cost_usd'] ) ? floatval( $delivery_context['delivery_cost_usd'] ) : null;
                            $delivery_shipping_mode = isset( $delivery_context['shipping_mode'] ) ? $delivery_context['shipping_mode'] : null;
                            
                            // Commit 2.3.10: If delivery cost is NULL but country is US, try to calculate it on-the-fly
                            if ( ( $delivery_cost_data === null || $delivery_cost_data === 0 ) && class_exists( 'N88_RFQ_Pricing' ) ) {
                                $calculation_result = N88_RFQ_Pricing::calculate_and_store_delivery_cost( $item_id );
                                if ( $calculation_result && isset( $calculation_result['delivery_cost_usd'] ) && $calculation_result['delivery_cost_usd'] !== null ) {
                                    $delivery_cost_data = floatval( $calculation_result['delivery_cost_usd'] );
                                    $delivery_shipping_mode = isset( $calculation_result['shipping_mode'] ) ? $calculation_result['shipping_mode'] : null;
                                }
                            }
                        }
                    }
                }
            }

            $bid_media_files_table = $wpdb->prefix . 'n88_bid_media_files';

            foreach ( $bids_data as $bid ) {
                // Get media links for this bid with provider information
                $media_links = $wpdb->get_results( $wpdb->prepare(
                    "SELECT url, provider 
                    FROM {$bid_media_links_table}
                    WHERE bid_id = %d
                    ORDER BY sort_order ASC, id ASC",
                    $bid['bid_id']
                ), ARRAY_A );

                // Commit 2.3.6: Get bid photos from n88_bid_media_files
                $bid_photos = $wpdb->get_results( $wpdb->prepare(
                    "SELECT file_url 
                    FROM {$bid_media_files_table}
                    WHERE bid_id = %d
                    ORDER BY sort_order ASC, id ASC",
                    $bid['bid_id']
                ), ARRAY_A );

                // Organize video links by provider
                $video_links_by_provider = array(
                    'youtube' => array(),
                    'vimeo' => array(),
                    'loom' => array(),
                );
                
                foreach ( $media_links as $link ) {
                    $provider = isset( $link['provider'] ) ? strtolower( $link['provider'] ) : 'youtube';
                    $url = esc_url_raw( $link['url'] );
                    
                    if ( in_array( $provider, array( 'youtube', 'vimeo', 'loom' ), true ) ) {
                        $video_links_by_provider[ $provider ][] = $url;
                    }
                }

                // Commit 2.3.6: Extract photo URLs (no metadata/filenames to prevent identity leakage)
                $photo_urls = array_map( function( $photo ) {
                    return esc_url_raw( $photo['file_url'] );
                }, $bid_photos );

                // Get Smart Alternatives suggestion and note from meta_json if available
                $smart_alternatives_suggestion = null;
                $bid_smart_alternatives_note = null;
                if ( $has_bid_meta_json && ! empty( $bid['meta_json'] ) ) {
                    $bid_meta = json_decode( $bid['meta_json'], true );
                    if ( is_array( $bid_meta ) ) {
                        if ( isset( $bid_meta['smart_alternatives_suggestion'] ) ) {
                            $smart_alternatives_suggestion = $bid_meta['smart_alternatives_suggestion'];
                        }
                        // Get supplier's note if stored in bid meta_json
                        if ( isset( $bid_meta['smart_alternatives_note'] ) ) {
                            $bid_smart_alternatives_note = sanitize_textarea_field( $bid_meta['smart_alternatives_note'] );
                        }
                    }
                }
                
                // Debug: Log if meta_json exists but smart_alternatives_suggestion is null
                if ( $has_bid_meta_json && ! empty( $bid['meta_json'] ) && $smart_alternatives_suggestion === null ) {
                    error_log( 'Bid ' . $bid['bid_id'] . ': meta_json exists but smart_alternatives_suggestion is null. meta_json: ' . substr( $bid['meta_json'], 0, 200 ) );
                }

                // D5: Get rfq_revision_at_submit for bid filtering
                $bid_revision = null;
                if ( $has_revision_column && isset( $bid['rfq_revision_at_submit'] ) && $bid['rfq_revision_at_submit'] !== null ) {
                    $bid_revision = intval( $bid['rfq_revision_at_submit'] );
                }
                
                // Commit 2.3.8: Get supplier profile for duty calculation
                $supplier_id = isset( $bid['supplier_id'] ) ? intval( $bid['supplier_id'] ) : 0;
                $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
                $supplier_profile = null;
                $origin_region = null;
                $duty_rate_override = null;
                
                if ( $supplier_id > 0 ) {
                    $supplier_profile = $wpdb->get_row( $wpdb->prepare(
                        "SELECT origin_region, duty_rate_override 
                        FROM {$supplier_profiles_table} 
                        WHERE supplier_id = %d",
                        $supplier_id
                    ), ARRAY_A );
                    
                    if ( $supplier_profile ) {
                        $origin_region = isset( $supplier_profile['origin_region'] ) ? $supplier_profile['origin_region'] : null;
                        $duty_rate_override = isset( $supplier_profile['duty_rate_override'] ) ? $supplier_profile['duty_rate_override'] : null;
                    } else {
                        // Debug: Log if supplier profile not found
                        error_log( sprintf( 
                            'N88 RFQ Commit 2.3.8: Supplier profile not found for supplier_id = %d (bid_id = %d)',
                            $supplier_id,
                            $bid['bid_id']
                        ) );
                    }
                } else {
                    // Debug: Log if supplier_id is missing
                    error_log( sprintf( 
                        'N88 RFQ Commit 2.3.8: supplier_id is 0 or missing for bid_id = %d',
                        $bid['bid_id']
                    ) );
                }
                
                // Commit 2.3.8: Calculate duty rate
                $duty_rate = N88_RFQ_Helpers::n88_calculate_duty_rate( $origin_region, $duty_rate_override );
                
                // Debug: Log duty calculation
                error_log( sprintf( 
                    'N88 RFQ Commit 2.3.8: Bid %d - supplier_id=%d, origin_region=%s, duty_rate_override=%s, calculated_duty_rate=%.4f',
                    $bid['bid_id'],
                    $supplier_id,
                    $origin_region ? $origin_region : 'NULL',
                    $duty_rate_override !== null ? $duty_rate_override : 'NULL',
                    $duty_rate
                ) );
                
                // Commit 2.3.8: Calculate landed cost with duty and margin
                // Store raw prices for reference
                $unit_price_raw = $bid['unit_price'] ? floatval( $bid['unit_price'] ) : null;
                $prototype_cost_raw = $bid['prototype_cost'] ? floatval( $bid['prototype_cost'] ) : null;
                
                // Calculate landed cost for unit_price
                $unit_price_landed = N88_RFQ_Helpers::n88_calculate_landed_cost( $unit_price_raw, $duty_rate );
                
                // Calculate landed cost for prototype_cost
                $prototype_cost_landed = N88_RFQ_Helpers::n88_calculate_landed_cost( $prototype_cost_raw, $duty_rate );
                
                // Get unit price display (after formulas for designer)
                $unit_price_display = $unit_price_landed ? $unit_price_landed['display_price'] : N88_RFQ_Helpers::n88_price_display_from_raw( $unit_price_raw );
                
                // Calculate total price = unit_price * quantity (for supplier - raw price)
                $total_price_raw = $unit_price_raw !== null ? (floatval( $unit_price_raw ) * $item_quantity) : null;
                
                // Calculate total price landed = unit_price_landed * quantity (for designer - after formulas)
                $total_price_landed = null;
                if ( $unit_price_landed && isset( $unit_price_landed['display_price'] ) ) {
                    $total_price_landed = floatval( $unit_price_landed['display_price'] ) * $item_quantity;
                } elseif ( $unit_price_raw !== null ) {
                    // Fallback: use raw price if landed calculation not available
                    $total_price_landed = floatval( $unit_price_raw ) * $item_quantity;
                }
                
                // Commit 2.4.1: Check prototype status for award gating
                $prototype_status_for_bid = null;
                $has_prototype_request_for_bid = false;
                $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
                $prototype_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table;
                
                if ( $prototype_table_exists ) {
                    $prototype_payment_for_bid = $wpdb->get_row( $wpdb->prepare(
                        "SELECT id, prototype_status 
                        FROM {$prototype_payments_table} 
                        WHERE bid_id = %d AND item_id = %d 
                        ORDER BY created_at DESC 
                        LIMIT 1",
                        $bid['bid_id'],
                        $item_id
                    ), ARRAY_A );
                    
                    if ( $prototype_payment_for_bid ) {
                        $has_prototype_request_for_bid = true;
                        $prototype_status_for_bid = isset( $prototype_payment_for_bid['prototype_status'] ) ? $prototype_payment_for_bid['prototype_status'] : null;
                    }
                }
                
                // Commit 2.4.1: Check if bid is already awarded
                $bid_status = isset( $bid['status'] ) ? $bid['status'] : 'submitted';
                $is_awarded = ( $bid_status === 'awarded' );
                $is_declined = ( $bid_status === 'declined' );
                
                // Award gating: Can award if no prototype request OR prototype is approved
                $can_award = ! $is_awarded && ! $is_declined && ( ! $has_prototype_request_for_bid || $prototype_status_for_bid === 'approved' );
                
                $bids[] = array(
                    'bid_id' => intval( $bid['bid_id'] ),
                    'unit_price' => $unit_price_display, // Designer sees landed cost (margin + duty)
                    'unit_price_raw' => $unit_price_raw, // Keep raw price for reference
                    'unit_price_duty_est' => $unit_price_landed ? $unit_price_landed['duty_est'] : null, // Duty estimate
                    'unit_price_duty_rate' => $duty_rate, // Duty rate used
                    // Commit 2.3.10: Total price (unit_price * quantity)
                    'total_price' => $total_price_landed !== null ? number_format( $total_price_landed, 2, '.', '' ) : null, // Designer sees total after formulas
                    'total_price_raw' => $total_price_raw !== null ? number_format( $total_price_raw, 2, '.', '' ) : null, // Supplier sees total raw price
                    'item_quantity' => $item_quantity, // Quantity used for calculation
                    'production_lead_time' => $bid['production_lead_time_text'] ? sanitize_text_field( $bid['production_lead_time_text'] ) : null,
                    'prototype_timeline' => $bid['prototype_timeline_option'] ? sanitize_text_field( $bid['prototype_timeline_option'] ) : null,
                    'prototype_cost' => $prototype_cost_landed ? $prototype_cost_landed['display_price'] : N88_RFQ_Helpers::n88_price_display_from_raw( $prototype_cost_raw ), // Designer sees landed cost (margin + duty)
                    'prototype_cost_raw' => $prototype_cost_raw, // Keep raw price for reference
                    'prototype_cost_duty_est' => $prototype_cost_landed ? $prototype_cost_landed['duty_est'] : null, // Duty estimate
                    'prototype_commitment' => isset( $bid['prototype_video_yes'] ) && intval( $bid['prototype_video_yes'] ) === 1 ? true : false,
                    'cad_yes' => isset( $bid['cad_yes'] ) && intval( $bid['cad_yes'] ) === 1 ? true : false,
                    'video_links' => array_map( function( $link ) {
                        return esc_url_raw( $link['url'] );
                    }, $media_links ),
                    'video_links_by_provider' => $video_links_by_provider,
                    'photo_urls' => $photo_urls,
                    'smart_alternatives_suggestion' => $smart_alternatives_suggestion,
                    'smart_alternatives_enabled' => $smart_alternatives_enabled,
                    'smart_alternatives_note' => $smart_alternatives_note, // Item-level note (designer's note)
                    'bid_smart_alternatives_note' => $bid_smart_alternatives_note, // Bid-level note (supplier's note)
                    'created_at' => $bid['created_at'],
                    'rfq_revision_at_submit' => $bid_revision, // D5: Revision tracking for bid filtering
                    // Commit 2.3.10: Delivery cost (door-to-door USA)
                    'delivery_cost_usd' => $delivery_cost_data,
                    'delivery_shipping_mode' => $delivery_shipping_mode,
                    // Commit 2.4.1: Prototype status and bid status for award gating
                    'has_prototype_request' => $has_prototype_request_for_bid,
                    'prototype_status' => $prototype_status_for_bid,
                    'bid_status' => $bid_status,
                    'is_awarded' => $is_awarded,
                    'is_declined' => $is_declined,
                    'can_award' => $can_award,
                );
            }
        }

        // Check for unread operator messages (designer_operator thread)
        // Action Required: Show when operator has sent messages that designer hasn't replied to
        $messages_table = $wpdb->prefix . 'n88_item_messages';
        $unread_operator_messages = 0;
        $has_unread_operator_messages = false;
        
        // Check if messages table exists
        $messages_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$messages_table}'" ) === $messages_table;
        if ( $messages_table_exists ) {
            // Count unread operator messages (operator messages with no designer reply after them)
                $unread_operator_messages = intval( $wpdb->get_var( $wpdb->prepare(
                    "SELECT COUNT(DISTINCT m.message_id)
                    FROM {$messages_table} m
                    WHERE m.item_id = %d
                    AND m.thread_type = 'designer_operator'
                    AND m.sender_role = 'operator'
                    AND NOT EXISTS (
                        SELECT 1 FROM {$messages_table} m2
                        WHERE m2.item_id = m.item_id
                        AND m2.thread_type = 'designer_operator'
                        AND m2.sender_role = 'designer'
                        AND m2.created_at > m.created_at
                    )",
                    $item_id
                ) ) );
            $has_unread_operator_messages = $unread_operator_messages > 0;
            // Fix #13/#26: If operator marked resolved (designer thread = item_id, bid_id NULL), clear Action Required
            if ( $has_unread_operator_messages ) {
                $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
                if ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) === $resolutions_table ) {
                    $resolved = $wpdb->get_var( $wpdb->prepare(
                        "SELECT 1 FROM {$resolutions_table} WHERE item_id = %d AND bid_id IS NULL LIMIT 1",
                        $item_id
                    ) );
                    if ( $resolved ) {
                        $has_unread_operator_messages = false;
                        $unread_operator_messages = 0;
                    }
                }
            }
        }

        // Commit 2.3.9.1C: Check for prototype payment status
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $prototype_payment_status = null;
        $prototype_payment_total_due = null;
        $has_prototype_payment = false;
        $prototype_payment_id = null;
        $prototype_payment_bid_id = null;
        $prototype_payment_supplier_id = null;
        $has_payment_receipt_uploaded = false;
        // Commit 2.3.9.2A: CAD workflow state
        $cad_status = null;
        $cad_revision_rounds_included = null;
        $cad_revision_rounds_used = null;
        $cad_approved_at = null;
        $cad_approved_version = null;
        $cad_released_to_supplier_at = null;
        $cad_current_version = null;
        // Commit 2.3.9.2B-D: Prototype review state
        $prototype_status = null;
        $prototype_current_version = null;
        $prototype_approved_version = null;
        $prototype_submission = null;
        $direction_keyword_ids = null;
        
        // Check if prototype payments table exists
        $prototype_payments_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table;
        if ( $prototype_payments_table_exists ) {
            $pp_columns = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
            $has_cad_status = in_array( 'cad_status', $pp_columns, true );
            $has_cad_approved_at = in_array( 'cad_approved_at', $pp_columns, true );
            $has_cad_approved_version = in_array( 'cad_approved_version', $pp_columns, true );
            $has_cad_released_to_supplier_at = in_array( 'cad_released_to_supplier_at', $pp_columns, true );
            $has_cad_revision_rounds_included = in_array( 'cad_revision_rounds_included', $pp_columns, true );
            $has_cad_revision_rounds_used = in_array( 'cad_revision_rounds_used', $pp_columns, true );

            // Get the most recent prototype payment for this item
            // For system operator: any request for this item (item_id only). For designer: own request only.
            $select_fields = "id, bid_id, supplier_id, status, total_due_usd, created_at";
            $has_received_at = in_array( 'received_at', $pp_columns, true );
            $select_fields .= $has_received_at ? ", received_at" : ", NULL as received_at";
            $select_fields .= $has_cad_status ? ", cad_status" : ", NULL as cad_status";
            $select_fields .= $has_cad_revision_rounds_included ? ", cad_revision_rounds_included" : ", NULL as cad_revision_rounds_included";
            $select_fields .= $has_cad_revision_rounds_used ? ", cad_revision_rounds_used" : ", NULL as cad_revision_rounds_used";
            $select_fields .= $has_cad_approved_at ? ", cad_approved_at" : ", NULL as cad_approved_at";
            $select_fields .= $has_cad_approved_version ? ", cad_approved_version" : ", NULL as cad_approved_version";
            $select_fields .= $has_cad_released_to_supplier_at ? ", cad_released_to_supplier_at" : ", NULL as cad_released_to_supplier_at";

            if ( $is_system_operator ) {
                $prototype_payment = $wpdb->get_row( $wpdb->prepare(
                    "SELECT {$select_fields}
                    FROM {$prototype_payments_table}
                    WHERE item_id = %d
                    ORDER BY created_at DESC
                    LIMIT 1",
                    $item_id
                ), ARRAY_A );
            } else {
                $prototype_payment = $wpdb->get_row( $wpdb->prepare(
                    "SELECT {$select_fields}
                    FROM {$prototype_payments_table}
                    WHERE item_id = %d
                    AND designer_user_id = %d
                    ORDER BY created_at DESC
                    LIMIT 1",
                    $item_id,
                    $current_user->ID
                ), ARRAY_A );
            }
            
            if ( $prototype_payment ) {
                $has_prototype_payment = true;
                $prototype_payment_id = isset( $prototype_payment['id'] ) ? absint( $prototype_payment['id'] ) : null;
                $prototype_payment_bid_id = isset( $prototype_payment['bid_id'] ) ? absint( $prototype_payment['bid_id'] ) : null;
                $prototype_payment_supplier_id = isset( $prototype_payment['supplier_id'] ) ? absint( $prototype_payment['supplier_id'] ) : null;
                $prototype_payment_status = $prototype_payment['status'];
                $prototype_payment_total_due = $prototype_payment['total_due_usd'] ? floatval( $prototype_payment['total_due_usd'] ) : null;

                // Designer uploaded receipt: item card shows "Awaiting payment confirmation"
                $has_payment_receipt_uploaded = false;
                if ( $prototype_payment_status === 'requested' && $prototype_payment_id ) {
                    $receipts_table = $wpdb->prefix . 'n88_prototype_payment_receipts';
                    if ( $wpdb->get_var( "SHOW TABLES LIKE '{$receipts_table}'" ) === $receipts_table ) {
                        $has_payment_receipt_uploaded = (bool) $wpdb->get_var( $wpdb->prepare(
                            "SELECT 1 FROM {$receipts_table} WHERE payment_id = %d LIMIT 1",
                            $prototype_payment_id
                        ) );
                    }
                }

                // Commit 2.3.9.2A: CAD workflow state
                $cad_status = isset( $prototype_payment['cad_status'] ) ? $prototype_payment['cad_status'] : null;
                $cad_revision_rounds_included = isset( $prototype_payment['cad_revision_rounds_included'] ) ? intval( $prototype_payment['cad_revision_rounds_included'] ) : null;
                $cad_revision_rounds_used = isset( $prototype_payment['cad_revision_rounds_used'] ) ? intval( $prototype_payment['cad_revision_rounds_used'] ) : null;
                $cad_approved_at = isset( $prototype_payment['cad_approved_at'] ) ? $prototype_payment['cad_approved_at'] : null;
                $cad_approved_version = isset( $prototype_payment['cad_approved_version'] ) ? ( $prototype_payment['cad_approved_version'] !== null ? intval( $prototype_payment['cad_approved_version'] ) : null ) : null;
                $cad_released_to_supplier_at = isset( $prototype_payment['cad_released_to_supplier_at'] ) ? $prototype_payment['cad_released_to_supplier_at'] : null;

                // Determine current CAD version (max cad_version for this payment)
                $item_files_table = $wpdb->prefix . 'n88_item_files';
                $item_files_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$item_files_table}'" ) === $item_files_table;
                if ( $item_files_table_exists && $prototype_payment_id ) {
                    $cad_current_version_raw = $wpdb->get_var( $wpdb->prepare(
                        "SELECT MAX(cad_version) FROM {$item_files_table}
                        WHERE item_id = %d
                        AND payment_id = %d
                        AND attachment_type = 'cad'
                        AND detached_at IS NULL",
                        $item_id,
                        $prototype_payment_id
                    ) );
                    if ( $cad_current_version_raw !== null ) {
                        $cad_current_version = intval( $cad_current_version_raw );
                    }
                }
                
                // Commit 2.3.9.2B-D: Get prototype status and submission data
                $has_prototype_status = in_array( 'prototype_status', $pp_columns, true );
                $has_prototype_current_version = in_array( 'prototype_current_version', $pp_columns, true );
                $has_prototype_approved_version = in_array( 'prototype_approved_version', $pp_columns, true );
                $has_direction_keyword_ids = in_array( 'direction_keyword_ids', $pp_columns, true );
                
                $prototype_status = null;
                $prototype_current_version = null;
                $prototype_approved_version = null;
                $direction_keyword_ids = null;
                
                if ( $has_prototype_status || $has_prototype_current_version || $has_prototype_approved_version || $has_direction_keyword_ids ) {
                    $select_prototype_fields = '';
                    if ( $has_prototype_status ) {
                        $select_prototype_fields .= ', prototype_status';
                    }
                    if ( $has_prototype_current_version ) {
                        $select_prototype_fields .= ', prototype_current_version';
                    }
                    if ( $has_prototype_approved_version ) {
                        $select_prototype_fields .= ', prototype_approved_version';
                    }
                    if ( $has_direction_keyword_ids ) {
                        $select_prototype_fields .= ', direction_keyword_ids';
                    }
                    
                    $prototype_data = $wpdb->get_row( $wpdb->prepare(
                        "SELECT id{$select_prototype_fields}
                        FROM {$prototype_payments_table}
                        WHERE id = %d
                        LIMIT 1",
                        $prototype_payment_id
                    ), ARRAY_A );
                    
                    if ( $prototype_data ) {
                        $prototype_status = isset( $prototype_data['prototype_status'] ) ? $prototype_data['prototype_status'] : null;
                        $prototype_current_version = isset( $prototype_data['prototype_current_version'] ) ? ( $prototype_data['prototype_current_version'] !== null ? intval( $prototype_data['prototype_current_version'] ) : null ) : null;
                        $prototype_approved_version = isset( $prototype_data['prototype_approved_version'] ) ? ( $prototype_data['prototype_approved_version'] !== null ? intval( $prototype_data['prototype_approved_version'] ) : null ) : null;
                        $direction_keyword_ids_json = isset( $prototype_data['direction_keyword_ids'] ) ? $prototype_data['direction_keyword_ids'] : null;
                        if ( $direction_keyword_ids_json ) {
                            $direction_keyword_ids_decoded = json_decode( $direction_keyword_ids_json, true );
                            $direction_keyword_ids = is_array( $direction_keyword_ids_decoded ) ? $direction_keyword_ids_decoded : null;
                        }
                    }
                }
                
                // Get latest prototype video submission
                $prototype_submission = null;
                $submissions_table = $wpdb->prefix . 'n88_prototype_video_submissions';
                $links_table = $wpdb->prefix . 'n88_prototype_video_links';
                $submissions_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$submissions_table}'" ) === $submissions_table;
                
                if ( $submissions_table_exists && $prototype_payment_id && $prototype_current_version ) {
                    $submission = $wpdb->get_row( $wpdb->prepare(
                        "SELECT version, created_at
                        FROM {$submissions_table}
                        WHERE payment_id = %d
                        AND version = %d
                        LIMIT 1",
                        $prototype_payment_id,
                        $prototype_current_version
                    ), ARRAY_A );
                    
                    if ( $submission ) {
                        $links = $wpdb->get_results( $wpdb->prepare(
                            "SELECT provider, url
                            FROM {$links_table}
                            WHERE submission_id IN (
                                SELECT id FROM {$submissions_table}
                                WHERE payment_id = %d AND version = %d
                            )
                            ORDER BY sort_order ASC",
                            $prototype_payment_id,
                            $prototype_current_version
                        ), ARRAY_A );
                        
                        $prototype_submission = array(
                            'version' => intval( $submission['version'] ),
                            'created_at' => $submission['created_at'],
                            'links' => array_map( function( $link ) {
                                return array(
                                    'provider' => $link['provider'],
                                    'url' => esc_url_raw( $link['url'] ),
                                );
                            }, $links ),
                        );
                    }
                }
            }
        }

        // Designer Workflow tab: milestone dates for Step 1 (Design & Specs), Step 2 (CAD), Step 3 (Prototype video)
        $workflow_milestones = array(
            'step1' => array(
                'cad_requested_at' => null,
                'payment_sent_at' => null,
                'payment_approved_at' => null,
            ),
            'step2' => array(
                'cad_received_at' => null,
                'revision_submitted_at' => null,
                'revision_sent_at' => null,
                'cad_approved_at' => $cad_approved_at,
                'cad_released_to_supplier_at' => $cad_released_to_supplier_at,
            ),
            'step3' => array(
                'video_submitted_at' => null,
                'changes_requested_at' => null,
                'video_resubmitted_at' => null,
                'video_approved_at' => null,
            ),
        );
        if ( $has_prototype_payment && $prototype_payment ) {
            $workflow_milestones['step1']['cad_requested_at'] = isset( $prototype_payment['created_at'] ) ? $prototype_payment['created_at'] : null;
            $workflow_milestones['step1']['payment_approved_at'] = isset( $prototype_payment['received_at'] ) && trim( (string) $prototype_payment['received_at'] ) !== '' ? $prototype_payment['received_at'] : null;
            if ( $prototype_payment_id ) {
                $receipts_table = $wpdb->prefix . 'n88_prototype_payment_receipts';
                    if ( $wpdb->get_var( "SHOW TABLES LIKE '{$receipts_table}'" ) === $receipts_table ) {
                        $receipt_cols = $wpdb->get_col( "DESCRIBE {$receipts_table}" );
                        $receipt_date_col = is_array( $receipt_cols ) && in_array( 'uploaded_at', $receipt_cols, true ) ? 'uploaded_at' : 'created_at';
                        $first_receipt = $wpdb->get_var( $wpdb->prepare(
                        "SELECT MIN({$receipt_date_col}) FROM {$receipts_table} WHERE payment_id = %d",
                        $prototype_payment_id
                    ) );
                    if ( $first_receipt ) {
                        $workflow_milestones['step1']['payment_sent_at'] = $first_receipt;
                    }
                }
                $item_files_table = $wpdb->prefix . 'n88_item_files';
                if ( $wpdb->get_var( "SHOW TABLES LIKE '{$item_files_table}'" ) === $item_files_table ) {
                    $files_date_col = 'attached_at';
                    $cols = $wpdb->get_col( "DESCRIBE {$item_files_table}" );
                    if ( is_array( $cols ) && in_array( 'created_at', $cols, true ) ) {
                        $files_date_col = 'created_at';
                    }
                    $first_cad = $wpdb->get_var( $wpdb->prepare(
                        "SELECT MIN({$files_date_col}) FROM {$item_files_table} WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
                        $item_id,
                        $prototype_payment_id
                    ) );
                    if ( $first_cad ) {
                        $workflow_milestones['step2']['cad_received_at'] = $first_cad;
                    }
                    $cad_upload_count = $wpdb->get_var( $wpdb->prepare(
                        "SELECT COUNT(*) FROM {$item_files_table} WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
                        $item_id,
                        $prototype_payment_id
                    ) );
                    if ( $cad_upload_count && (int) $cad_upload_count > 1 ) {
                        $revision_sent = $wpdb->get_var( $wpdb->prepare(
                            "SELECT MAX({$files_date_col}) FROM {$item_files_table} WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
                            $item_id,
                            $prototype_payment_id
                        ) );
                        if ( $revision_sent ) {
                            $workflow_milestones['step2']['revision_sent_at'] = $revision_sent;
                        }
                    }
                }
                $messages_table = $wpdb->prefix . 'n88_item_messages';
                if ( $wpdb->get_var( "SHOW TABLES LIKE '{$messages_table}'" ) === $messages_table ) {
                    $revision_requested_at = $wpdb->get_var( $wpdb->prepare(
                        "SELECT MIN(created_at) FROM {$messages_table} WHERE item_id = %d AND thread_type = 'designer_operator' AND sender_role = 'designer' AND message_text LIKE %s",
                        $item_id,
                        '%Revision requested%'
                    ) );
                    if ( $revision_requested_at ) {
                        $workflow_milestones['step2']['revision_submitted_at'] = $revision_requested_at;
                    }
                }
            }
            $workflow_milestones['step2']['cad_approved_at'] = $cad_approved_at;
            $workflow_milestones['step2']['cad_released_to_supplier_at'] = $cad_released_to_supplier_at;
            if ( $prototype_submission && isset( $prototype_submission['created_at'] ) ) {
                $workflow_milestones['step3']['video_submitted_at'] = $prototype_submission['created_at'];
            }
            $pvs_table = $wpdb->prefix . 'n88_prototype_video_submissions';
            if ( $wpdb->get_var( "SHOW TABLES LIKE '{$pvs_table}'" ) === $pvs_table && $prototype_payment_id ) {
                $resubmit_row = $wpdb->get_row( $wpdb->prepare(
                    "SELECT created_at FROM {$pvs_table} WHERE payment_id = %d AND version > 1 ORDER BY version DESC LIMIT 1",
                    $prototype_payment_id
                ), ARRAY_A );
                if ( $resubmit_row && ! empty( $resubmit_row['created_at'] ) ) {
                    $workflow_milestones['step3']['video_resubmitted_at'] = $resubmit_row['created_at'];
                }
            }
            if ( $prototype_status === 'changes_requested' && $prototype_payment_id ) {
                $fb_table = $wpdb->prefix . 'n88_prototype_feedback_packets';
                if ( $wpdb->get_var( "SHOW TABLES LIKE '{$fb_table}'" ) === $fb_table ) {
                    $changes_at = $wpdb->get_var( $wpdb->prepare(
                        "SELECT MIN(created_at) FROM {$fb_table} WHERE payment_id = %d",
                        $prototype_payment_id
                    ) );
                    if ( $changes_at ) {
                        $workflow_milestones['step3']['changes_requested_at'] = $changes_at;
                    }
                }
            }
            $has_prototype_approved_at = $prototype_payments_table_exists && isset( $pp_columns ) && is_array( $pp_columns ) && in_array( 'prototype_approved_at', $pp_columns, true );
            if ( $has_prototype_approved_at && $prototype_payment_id ) {
                $pa_row = $wpdb->get_row( $wpdb->prepare(
                    "SELECT prototype_approved_at FROM {$prototype_payments_table} WHERE id = %d LIMIT 1",
                    $prototype_payment_id
                ), ARRAY_A );
                if ( $pa_row && ! empty( $pa_row['prototype_approved_at'] ) ) {
                    $workflow_milestones['step3']['video_approved_at'] = $pa_row['prototype_approved_at'];
                }
            }
        }

        wp_send_json_success( array(
            'has_rfq' => $has_rfq,
            'has_bids' => $has_bids,
            'has_awarded_bid' => $has_awarded_bid, // Commit 2.4.1: Check if any bid is awarded
            'bids' => $bids,
            'rfq_revision_current' => $rfq_revision_current, // D5: Current revision for Specs Updated panel
            'revision_changed' => $revision_changed, // D5: Flag indicating specs were updated after RFQ
            'has_unread_operator_messages' => $has_unread_operator_messages, // Action Required: Unread operator messages
            'unread_operator_messages' => $unread_operator_messages, // Count of unread messages
            'has_prototype_payment' => $has_prototype_payment, // Commit 2.3.9.1C: Has prototype payment request
            'prototype_payment_id' => $prototype_payment_id, // Commit 2.3.9.2A: Payment record id for CAD actions
            'prototype_payment_bid_id' => $prototype_payment_bid_id, // Commit 2.3.9.2A
            'prototype_payment_supplier_id' => $prototype_payment_supplier_id, // Commit 2.3.9.2A
            'prototype_payment_status' => $prototype_payment_status, // Commit 2.3.9.1C: Payment status (requested, marked_received, etc.)
            'prototype_payment_total_due' => $prototype_payment_total_due, // Commit 2.3.9.1C: Total amount due
            'has_payment_receipt_uploaded' => $has_payment_receipt_uploaded, // Designer uploaded receipt; item card shows "Awaiting payment confirmation"
            // Commit 2.3.9.2A: CAD workflow state
            'cad_status' => $cad_status,
            'cad_revision_rounds_included' => $cad_revision_rounds_included,
            'cad_revision_rounds_used' => $cad_revision_rounds_used,
            'cad_approved_at' => $cad_approved_at,
            'cad_approved_version' => $cad_approved_version,
            'cad_released_to_supplier_at' => $cad_released_to_supplier_at,
            'cad_current_version' => $cad_current_version,
            // Commit 2.3.9.2B-D: Prototype review state
            'prototype_status' => $prototype_status,
            'prototype_current_version' => $prototype_current_version,
            'prototype_approved_version' => $prototype_approved_version,
            'prototype_submission' => $prototype_submission,
            'direction_keyword_ids' => $direction_keyword_ids,
            // Designer Workflow tab: milestone dates per step
            'workflow_milestones' => $workflow_milestones,
        ) );
    }

    /**
     * AJAX handler to validate supplier bid (Commit 2.3.3)
     * Server-side validation only - NO database writes
     */
    public function ajax_validate_supplier_bid() {
        check_ajax_referer( 'n88_validate_supplier_bid', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Maker account required.' ) );
        }

        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }

        // DEMO ITEM FOR TESTING (Commit 2.3.3) - Allow demo item without route check
        $demo_item_id = 9999;
        if ( $item_id === $demo_item_id ) {
            // Skip route check for demo item - allow validation
        } else {
            // Verify supplier has route for this item (unless system operator)
            if ( ! $is_system_operator ) {
                global $wpdb;
                $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
                $route_exists = $wpdb->get_var( $wpdb->prepare(
                    "SELECT COUNT(*) FROM {$rfq_routes_table} 
                    WHERE item_id = %d 
                    AND supplier_id = %d 
                    AND status IN ('queued', 'sent', 'viewed', 'bid_submitted')",
                    $item_id,
                    $current_user->ID
                ) );

                if ( ! $route_exists || intval( $route_exists ) === 0 ) {
                    wp_send_json_error( array( 'message' => 'Access denied. You do not have permission to bid on this item.' ), 403 );
                }
            }
        }

        $errors = array();

        // 1. Video links validation (min 1, max 3, allowed providers only)
        $video_links_json = isset( $_POST['video_links'] ) ? wp_unslash( $_POST['video_links'] ) : '[]';
        $video_links = json_decode( $video_links_json, true );
        
        if ( ! is_array( $video_links ) ) {
            $video_links = array();
        }
        
        // Filter out empty links
        $video_links = array_filter( array_map( 'trim', $video_links ) );
        
        // Commit 2.3.5.1: Video links are optional now, but if provided, max 3
        if ( count( $video_links ) > 3 ) {
            $errors['video_links'] = 'Maximum 3 video links allowed.';
        } else {
            // Validate each link against allowlist (only if provided)
            if ( count( $video_links ) > 0 ) {
                $allowed_domains = array(
                    'youtube.com', 'www.youtube.com', 'youtu.be',
                    'vimeo.com', 'www.vimeo.com',
                    'loom.com', 'www.loom.com'
                );
                
                foreach ( $video_links as $link ) {
                    $parsed_url = wp_parse_url( $link );
                    if ( ! $parsed_url || ! isset( $parsed_url['host'] ) ) {
                        $errors['video_links'] = 'Invalid URL format: ' . esc_html( $link );
                        break;
                    }
                    
                    $hostname = strtolower( $parsed_url['host'] );
                    $hostname = preg_replace( '/^www\./', '', $hostname );
                    
                    $is_allowed = false;
                    foreach ( $allowed_domains as $domain ) {
                        $domain_clean = preg_replace( '/^www\./', '', $domain );
                        if ( $hostname === $domain_clean || strpos( $hostname, '.' . $domain_clean ) !== false ) {
                            $is_allowed = true;
                            break;
                        }
                    }
                    
                    if ( ! $is_allowed ) {
                        $errors['video_links'] = 'Only YouTube, Vimeo, or Loom links are allowed. Invalid: ' . esc_html( $link );
                        break;
                    }
                }
            }
        }
        
        // 1.5. Bid Photos validation (required, min 1, max 5) - Commit 2.3.5.1
        // Check for bid_photo_ids (already uploaded to WordPress media library)
        $bid_photo_ids_raw = isset( $_POST['bid_photo_ids'] ) ? $_POST['bid_photo_ids'] : null;
        
        // Handle both JSON string and array formats
        $bid_photo_ids = array();
        if ( $bid_photo_ids_raw !== null ) {
            if ( is_string( $bid_photo_ids_raw ) ) {
                $decoded = json_decode( wp_unslash( $bid_photo_ids_raw ), true );
                if ( is_array( $decoded ) ) {
                    $bid_photo_ids = $decoded;
                }
            } elseif ( is_array( $bid_photo_ids_raw ) ) {
                $bid_photo_ids = $bid_photo_ids_raw;
            }
        }
        
        // Filter out invalid IDs
        $bid_photo_ids = array_filter( array_map( 'intval', $bid_photo_ids ), function( $id ) {
            return $id > 0;
        } );
        
        $bid_photos_count = count( $bid_photo_ids );
        
        if ( $bid_photos_count < 1 ) {
            $errors['bid_photos'] = 'At least 1 photo is required.';
        } elseif ( $bid_photos_count > 5 ) {
            $errors['bid_photos'] = 'Maximum 5 photos allowed.';
        } else {
            // Validate that all photo IDs exist in WordPress media library
            foreach ( $bid_photo_ids as $photo_id ) {
                $attachment = get_post( $photo_id );
                if ( ! $attachment || $attachment->post_type !== 'attachment' ) {
                    $errors['bid_photos'] = 'Invalid photo ID: ' . $photo_id;
                    break;
                }
                
                // Verify it's an image
                $mime_type = get_post_mime_type( $photo_id );
                if ( ! $mime_type || strpos( $mime_type, 'image/' ) !== 0 ) {
                    $errors['bid_photos'] = 'Photo ID ' . $photo_id . ' is not a valid image.';
                    break;
                }
            }
        }

        // 2. Prototype video commitment (optional - YES or NO)
        $prototype_video_yes = isset( $_POST['prototype_video_yes'] ) ? intval( $_POST['prototype_video_yes'] ) : 0;
        $is_prototype_yes = ( $prototype_video_yes === 1 );

        // 3. Prototype timeline (required ONLY if prototype is YES)
        $prototype_timeline_option = isset( $_POST['prototype_timeline_option'] ) ? sanitize_text_field( wp_unslash( $_POST['prototype_timeline_option'] ) ) : '';
        if ( $is_prototype_yes ) {
            $allowed_timelines = array( '1-2w', '2-4w', '4-6w', '6-8w', '8-10w' );
            if ( empty( $prototype_timeline_option ) || ! in_array( $prototype_timeline_option, $allowed_timelines, true ) ) {
                $errors['prototype_timeline_option'] = 'Please select a valid prototype timeline.';
            }
        }

        // 4. Prototype cost (required ONLY if prototype is YES)
        $prototype_cost = isset( $_POST['prototype_cost'] ) ? sanitize_text_field( wp_unslash( $_POST['prototype_cost'] ) ) : '';
        if ( $is_prototype_yes ) {
            if ( empty( $prototype_cost ) ) {
                $errors['prototype_cost'] = 'Prototype cost is required.';
            } else {
                $prototype_cost_float = floatval( $prototype_cost );
                if ( ! is_numeric( $prototype_cost ) || $prototype_cost_float < 0 ) {
                    $errors['prototype_cost'] = 'Prototype cost must be a number greater than or equal to 0.';
                }
            }
        }

        // 5. Production lead time (non-empty text)
        $production_lead_time_text = isset( $_POST['production_lead_time_text'] ) ? sanitize_text_field( wp_unslash( $_POST['production_lead_time_text'] ) ) : '';
        if ( empty( trim( $production_lead_time_text ) ) ) {
            $errors['production_lead_time_text'] = 'Production lead time is required.';
        }

        // 6. Unit price (numeric > 0)
        $unit_price = isset( $_POST['unit_price'] ) ? sanitize_text_field( wp_unslash( $_POST['unit_price'] ) ) : '';
        if ( empty( $unit_price ) ) {
            $errors['unit_price'] = 'Unit price is required.';
        } else {
            $unit_price_float = floatval( $unit_price );
            if ( ! is_numeric( $unit_price ) || $unit_price_float <= 0 ) {
                $errors['unit_price'] = 'Unit price must be a number greater than 0.';
            }
        }

        // If there are errors, return them
        if ( ! empty( $errors ) ) {
            wp_send_json_error( array(
                'message' => 'Validation failed. Please correct the errors below.',
                'errors' => $errors,
            ) );
        }

        // Validation passed (but NO database writes in 2.3.3)
        wp_send_json_success( array(
            'message' => 'Bid validation successful. (Note: Bid is not saved yet - this will be implemented in Commit 2.3.5)',
        ) );
    }

    /**
     * AJAX handler to submit supplier bid (Commit 2.3.5)
     * Persists validated bid to database and updates route status
     */
    public function ajax_submit_supplier_bid() {
        check_ajax_referer( 'n88_submit_supplier_bid', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Maker account required.' ) );
        }

        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }

        global $wpdb;
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $bid_media_links_table = $wpdb->prefix . 'n88_bid_media_links';

        // Verify supplier has route for this item (unless system operator)
        if ( ! $is_system_operator ) {
            // Commit 2.3.7.1: Check and update expired routes (lazy evaluation)
            $this->check_and_update_expired_routes( $item_id, $current_user->ID );
            
            // Check if route is expired
            if ( $this->is_route_expired( $item_id, $current_user->ID ) ) {
                wp_send_json_error( array( 'message' => 'This RFQ is no longer accepting bids.' ), 403 );
            }
            
            $route = $wpdb->get_row( $wpdb->prepare(
                "SELECT route_id, status FROM {$rfq_routes_table} 
                WHERE item_id = %d 
                AND supplier_id = %d",
                $item_id,
                $current_user->ID
            ) );

            if ( ! $route ) {
                wp_send_json_error( array( 'message' => 'Access denied. You do not have permission to bid on this item.' ), 403 );
            }

            // Block if route is still queued
            if ( $route->status === 'queued' ) {
                wp_send_json_error( array( 'message' => 'This RFQ is not yet available for bidding.' ) );
            }
        }

        // Re-validate using exact rules from 2.3.3
        $errors = array();

        // 1. Video links validation (min 1, max 3, allowed providers only)
        $video_links_json = isset( $_POST['video_links'] ) ? wp_unslash( $_POST['video_links'] ) : '[]';
        $video_links = json_decode( $video_links_json, true );
        
        if ( ! is_array( $video_links ) ) {
            $video_links = array();
        }
        
        // Filter out empty links
        $video_links = array_filter( array_map( 'trim', $video_links ) );
        
        // Commit 2.3.5.1: Video links are optional now, but if provided, max 3
        if ( count( $video_links ) > 3 ) {
            $errors['video_links'] = 'Maximum 3 video links allowed.';
        } else {
            // Validate each link against allowlist (only if provided)
            if ( count( $video_links ) > 0 ) {
                $allowed_domains = array(
                    'youtube.com', 'www.youtube.com', 'youtu.be',
                    'vimeo.com', 'www.vimeo.com',
                    'loom.com', 'www.loom.com'
                );
                
                foreach ( $video_links as $link ) {
                    $parsed_url = wp_parse_url( $link );
                    if ( ! $parsed_url || ! isset( $parsed_url['host'] ) ) {
                        $errors['video_links'] = 'Invalid URL format: ' . esc_html( $link );
                        break;
                    }
                    
                    $hostname = strtolower( $parsed_url['host'] );
                    $hostname = preg_replace( '/^www\./', '', $hostname );
                    
                    $is_allowed = false;
                    foreach ( $allowed_domains as $domain ) {
                        $domain_clean = preg_replace( '/^www\./', '', $domain );
                        if ( $hostname === $domain_clean || strpos( $hostname, '.' . $domain_clean ) !== false ) {
                            $is_allowed = true;
                            break;
                        }
                    }
                    
                    if ( ! $is_allowed ) {
                        $errors['video_links'] = 'Only YouTube, Vimeo, or Loom links are allowed. Invalid: ' . esc_html( $link );
                        break;
                    }
                }
            }
        }
        
        // 1.5. Bid Photos validation (required, min 1, max 5) - Commit 2.3.5.1
        // Check for bid_photo_ids (already uploaded to WordPress media library)
        $bid_photo_ids_raw = isset( $_POST['bid_photo_ids'] ) ? $_POST['bid_photo_ids'] : null;
        
        // Handle both JSON string and array formats
        $bid_photo_ids = array();
        if ( $bid_photo_ids_raw !== null ) {
            if ( is_string( $bid_photo_ids_raw ) ) {
                $decoded = json_decode( wp_unslash( $bid_photo_ids_raw ), true );
                if ( is_array( $decoded ) ) {
                    $bid_photo_ids = $decoded;
                }
            } elseif ( is_array( $bid_photo_ids_raw ) ) {
                $bid_photo_ids = $bid_photo_ids_raw;
            }
        }
        
        // Filter out invalid IDs
        $bid_photo_ids = array_filter( array_map( 'intval', $bid_photo_ids ), function( $id ) {
            return $id > 0;
        } );
        
        $bid_photos_count = count( $bid_photo_ids );
        
        if ( $bid_photos_count < 1 ) {
            $errors['bid_photos'] = 'At least 1 photo is required.';
        } elseif ( $bid_photos_count > 5 ) {
            $errors['bid_photos'] = 'Maximum 5 photos allowed.';
        } else {
            // Validate that all photo IDs exist in WordPress media library
            foreach ( $bid_photo_ids as $photo_id ) {
                $attachment = get_post( $photo_id );
                if ( ! $attachment || $attachment->post_type !== 'attachment' ) {
                    $errors['bid_photos'] = 'Invalid photo ID: ' . $photo_id;
                    break;
                }
                
                // Verify it's an image
                $mime_type = get_post_mime_type( $photo_id );
                if ( ! $mime_type || strpos( $mime_type, 'image/' ) !== 0 ) {
                    $errors['bid_photos'] = 'Photo ID ' . $photo_id . ' is not a valid image.';
                    break;
                }
            }
        }

        // 2. Prototype video commitment (optional - YES or NO)
        $prototype_video_yes = isset( $_POST['prototype_video_yes'] ) ? intval( $_POST['prototype_video_yes'] ) : 0;
        $is_prototype_yes = ( $prototype_video_yes === 1 );

        // 3. Prototype timeline (required ONLY if prototype is YES)
        $prototype_timeline_option = isset( $_POST['prototype_timeline_option'] ) ? sanitize_text_field( wp_unslash( $_POST['prototype_timeline_option'] ) ) : '';
        if ( $is_prototype_yes ) {
            $allowed_timelines = array( '1-2w', '2-4w', '4-6w', '6-8w', '8-10w' );
            if ( empty( $prototype_timeline_option ) || ! in_array( $prototype_timeline_option, $allowed_timelines, true ) ) {
                $errors['prototype_timeline_option'] = 'Please select a valid prototype timeline.';
            }
        }

        // 4. Prototype cost (required ONLY if prototype is YES)
        $prototype_cost = isset( $_POST['prototype_cost'] ) ? sanitize_text_field( wp_unslash( $_POST['prototype_cost'] ) ) : '';
        if ( $is_prototype_yes ) {
            if ( empty( $prototype_cost ) ) {
                $errors['prototype_cost'] = 'Prototype cost is required.';
            } else {
                $prototype_cost_float = floatval( $prototype_cost );
                if ( ! is_numeric( $prototype_cost ) || $prototype_cost_float < 0 ) {
                    $errors['prototype_cost'] = 'Prototype cost must be a number greater than or equal to 0.';
                }
            }
        }

        // 5. Production lead time (non-empty text)
        $production_lead_time_text = isset( $_POST['production_lead_time_text'] ) ? sanitize_text_field( wp_unslash( $_POST['production_lead_time_text'] ) ) : '';
        if ( empty( trim( $production_lead_time_text ) ) ) {
            $errors['production_lead_time_text'] = 'Production lead time is required.';
        }

        // 6. Unit price (numeric > 0)
        $unit_price = isset( $_POST['unit_price'] ) ? sanitize_text_field( wp_unslash( $_POST['unit_price'] ) ) : '';
        if ( empty( $unit_price ) ) {
            $errors['unit_price'] = 'Unit price is required.';
        } else {
            $unit_price_float = floatval( $unit_price );
            if ( ! is_numeric( $unit_price ) || $unit_price_float <= 0 ) {
                $errors['unit_price'] = 'Unit price must be a number greater than 0.';
            }
        }

        // 7. Smart Alternatives suggestion (optional, structured data)
        $smart_alternatives_suggestion = null;
        if ( isset( $_POST['smart_alternatives_suggestion'] ) && ! empty( $_POST['smart_alternatives_suggestion'] ) ) {
            $smart_alt_json = wp_unslash( $_POST['smart_alternatives_suggestion'] );
            error_log( 'Bid validation - Received smart_alternatives_suggestion: ' . $smart_alt_json );
            $smart_alt_data = json_decode( $smart_alt_json, true );
            if ( json_last_error() !== JSON_ERROR_NONE ) {
                error_log( 'Bid validation - JSON decode error: ' . json_last_error_msg() );
            } else {
                error_log( 'Bid validation - Decoded smart_alt_data: ' . print_r( $smart_alt_data, true ) );
                if ( is_array( $smart_alt_data ) ) {
                    // Check if ANY field has data (not just category)
                    $has_data = false;
                    if ( ! empty( $smart_alt_data['category'] ) ) $has_data = true;
                    if ( ! empty( $smart_alt_data['from'] ) ) $has_data = true;
                    if ( ! empty( $smart_alt_data['to'] ) ) $has_data = true;
                    if ( ! empty( $smart_alt_data['price_impact'] ) ) $has_data = true;
                    if ( ! empty( $smart_alt_data['lead_time_impact'] ) ) $has_data = true;
                    if ( ! empty( $smart_alt_data['comparison_points'] ) && is_array( $smart_alt_data['comparison_points'] ) && count( $smart_alt_data['comparison_points'] ) > 0 ) {
                        $has_data = true;
                        // Validate comparison points max 3
                        if ( count( $smart_alt_data['comparison_points'] ) > 3 ) {
                            $errors['smart_alternatives'] = 'Maximum 3 comparison points allowed.';
                        }
                    }
                    
                    error_log( 'Bid validation - has_data: ' . ( $has_data ? 'true' : 'false' ) . ', errors: ' . ( empty( $errors['smart_alternatives'] ) ? 'none' : $errors['smart_alternatives'] ) );
                    
                    if ( $has_data && empty( $errors['smart_alternatives'] ) ) {
                        $smart_alternatives_suggestion = $smart_alt_data;
                        error_log( 'Bid validation - Set smart_alternatives_suggestion: ' . print_r( $smart_alternatives_suggestion, true ) );
                    } else {
                        error_log( 'Bid validation - NOT setting smart_alternatives_suggestion (has_data: ' . ( $has_data ? 'true' : 'false' ) . ', has_errors: ' . ( empty( $errors['smart_alternatives'] ) ? 'false' : 'true' ) . ')' );
                    }
                } else {
                    error_log( 'Bid validation - smart_alt_data is not an array' );
                }
            }
        } else {
            error_log( 'Bid validation - smart_alternatives_suggestion not in POST or empty' );
        }

        // If validation errors, return them
        if ( ! empty( $errors ) ) {
            wp_send_json_error( array(
                'message' => 'Validation failed. Please correct the errors below.',
                'errors' => $errors,
            ) );
        }

        // D7: Revision guardrail - Check if item specs changed
        $items_table = $wpdb->prefix . 'n88_items';
        $item_meta_json = $wpdb->get_var( $wpdb->prepare(
            "SELECT meta_json FROM {$items_table} WHERE id = %d",
            $item_id
        ) );
        $item_meta = ! empty( $item_meta_json ) ? json_decode( $item_meta_json, true ) : array();
        if ( ! is_array( $item_meta ) ) {
            $item_meta = array();
        }
        
        // Get current item revision (default to 1 if not set)
        $item_current_revision = isset( $item_meta['rfq_revision_current'] ) ? intval( $item_meta['rfq_revision_current'] ) : 1;
        
        // Check if bids table has rfq_revision_at_submit column
        $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
        $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
        
        // Start transaction
        $wpdb->query( 'START TRANSACTION' );

        try {
            // First, check if there's a bid for the current revision
            $current_revision_bid = null;
            if ( $has_revision_column ) {
                $current_revision_bid = $wpdb->get_row( $wpdb->prepare(
                    "SELECT bid_id, status FROM {$item_bids_table} 
                    WHERE item_id = %d 
                    AND supplier_id = %d
                    AND rfq_revision_at_submit = %d
                    AND status = 'submitted'
                    LIMIT 1",
                    $item_id,
                    $current_user->ID,
                    $item_current_revision
                ) );
            }
            
            // If there's already a submitted bid for current revision, block (no changes needed)
            if ( $current_revision_bid && $current_revision_bid->status === 'submitted' ) {
                $wpdb->query( 'ROLLBACK' );
                wp_send_json_error( array(
                    'message' => 'You\'ve already submitted a bid for this item.',
                ) );
            }
            
            // Check for existing bid (stale or draft) to update
            $existing_bid_query = "SELECT bid_id, status";
            if ( $has_revision_column ) {
                $existing_bid_query .= ", rfq_revision_at_submit";
            }
            $existing_bid_query .= " FROM {$item_bids_table} WHERE item_id = %d AND supplier_id = %d ORDER BY bid_id DESC LIMIT 1";
            
            $existing_bid = $wpdb->get_row( $wpdb->prepare(
                $existing_bid_query,
                $item_id,
                $current_user->ID
            ) );

            $is_stale_bid = false;
            $should_update_existing = false;
            
            // Check if existing bid is stale (revision mismatch or NULL revision) or is a draft
            if ( $existing_bid && $has_revision_column ) {
                $existing_bid_revision = isset( $existing_bid->rfq_revision_at_submit ) ? intval( $existing_bid->rfq_revision_at_submit ) : null;
                
                // Bid is stale if: revision is NULL or revision < current revision
                if ( $existing_bid_revision === null || ( $existing_bid_revision !== null && $existing_bid_revision < $item_current_revision ) ) {
                    $is_stale_bid = true;
                    
                    // Allow resubmission if bid is submitted and stale - UPDATE it
                    if ( $existing_bid->status === 'submitted' || $existing_bid->status === 'draft' ) {
                        $should_update_existing = true;
                    }
                } elseif ( $existing_bid_revision === $item_current_revision ) {
                    // Same revision - only allow if it's a draft
                    if ( $existing_bid->status === 'draft' ) {
                        // Allow updating draft to submitted
                        $should_update_existing = true;
                    }
                    // If submitted, we already blocked above
                }
            } elseif ( $existing_bid ) {
                // If no revision column, check status
                if ( $existing_bid->status === 'draft' ) {
                    // Allow updating draft to submitted
                    $should_update_existing = true;
                }
                // If submitted and no revision column, we can't check for stale bids, so block
                // (This is legacy behavior - should not happen if revision column exists)
            }

            // Prepare bid data
            $bid_data = array(
                'item_id' => $item_id,
                'supplier_id' => $current_user->ID,
                'is_anonymous' => 1, // Default
                'unit_price' => $unit_price_float,
                'production_lead_time_text' => $production_lead_time_text,
                'prototype_video_yes' => 1, // Must be 1
                'prototype_timeline_option' => $prototype_timeline_option,
                'prototype_cost' => $prototype_cost_float,
                'cad_yes' => null, // CAD removed from bid process - set to NULL
                'status' => 'submitted',
            );
            
            // Add Smart Alternatives suggestion to meta_json if provided
            $meta_json = null;
            if ( $smart_alternatives_suggestion !== null ) {
                $meta_json = wp_json_encode( array( 'smart_alternatives_suggestion' => $smart_alternatives_suggestion ) );
                error_log( 'Bid submission - Smart Alt data: ' . print_r( $smart_alternatives_suggestion, true ) );
                error_log( 'Bid submission - meta_json to save: ' . $meta_json );
            } else {
                error_log( 'Bid submission - smart_alternatives_suggestion is null, not saving' );
            }
            
            // Check if table has meta_json column, and try to add it if it doesn't
            $item_bids_table_safe = preg_replace( '/[^a-zA-Z0-9_]/', '', $item_bids_table );
            $table_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table_safe}" );
            $has_bid_meta_json = in_array( 'meta_json', $table_columns, true );
            
            // If column doesn't exist, try to add it automatically
            if ( ! $has_bid_meta_json ) {
                $alter_result = $wpdb->query( "ALTER TABLE {$item_bids_table_safe} ADD COLUMN meta_json LONGTEXT NULL AFTER status" );
                if ( $alter_result !== false ) {
                    $has_bid_meta_json = true;
                    error_log( 'Bid submission - Successfully added meta_json column to bids table' );
                } else {
                    error_log( 'Bid submission - Failed to add meta_json column: ' . $wpdb->last_error );
                }
            }
            
            // Add meta_json to bid_data if column exists
            if ( $has_bid_meta_json ) {
                // Only add meta_json if it's not null (to avoid saving NULL)
                if ( $meta_json !== null ) {
                    $bid_data['meta_json'] = $meta_json;
                    error_log( 'Bid submission - meta_json column exists, adding to bid_data: ' . $meta_json );
                } else {
                    // Set to empty JSON object instead of NULL
                    $bid_data['meta_json'] = '{}';
                    error_log( 'Bid submission - meta_json column exists, but data is null, setting to empty JSON object' );
                }
            } else {
                error_log( 'Bid submission - meta_json column does NOT exist in table and could not be created' );
            }

            // D7: Revision guardrail - Final check before setting revision
            // Ensure bid.rfq_revision_at_submit will equal item.rfq_revision_current
            // (This check is already done above, but we verify again here before setting)
            
            // Check if rfq_revision_at_submit column exists, and try to add it if it doesn't
            $has_revision_column = in_array( 'rfq_revision_at_submit', $table_columns, true );
            
            // If column doesn't exist, try to add it automatically
            if ( ! $has_revision_column ) {
                // Determine position - add after meta_json if it exists, otherwise after status
                $after_column = $has_bid_meta_json ? 'meta_json' : 'status';
                $alter_result = $wpdb->query( "ALTER TABLE {$item_bids_table_safe} ADD COLUMN rfq_revision_at_submit INT UNSIGNED NULL AFTER {$after_column}" );
                if ( $alter_result !== false ) {
                    $has_revision_column = true;
                    $table_columns[] = 'rfq_revision_at_submit'; // Update local array
                    error_log( 'Bid submission - Successfully added rfq_revision_at_submit column to bids table' );
                } else {
                    error_log( 'Bid submission - Failed to add rfq_revision_at_submit column: ' . $wpdb->last_error );
                }
            }
            
            if ( $has_revision_column ) {
                // Set bid revision to current item revision (they should match at this point)
                $bid_data['rfq_revision_at_submit'] = $item_current_revision;
                error_log( 'Bid submission - Setting rfq_revision_at_submit to ' . $item_current_revision . ' for bid on item ' . $item_id );
            } else {
                error_log( 'Bid submission - rfq_revision_at_submit column does NOT exist in table and could not be created' );
            }

            // Prepare format array based on whether meta_json and rfq_revision_at_submit are included
            // Note: Use null in format array for NULL values (like cad_yes)
            $format_array = array( 
                '%d',  // item_id
                '%d',  // supplier_id
                '%d',  // is_anonymous
                '%f',  // unit_price
                '%s',  // production_lead_time_text
                '%d',  // prototype_video_yes
                '%s',  // prototype_timeline_option
                '%f',  // prototype_cost
                null,  // cad_yes (NULL)
                '%s',  // status
            );
            if ( isset( $bid_data['meta_json'] ) ) {
                $format_array[] = '%s';
            }
            if ( isset( $bid_data['rfq_revision_at_submit'] ) ) {
                $format_array[] = '%d';
            }
            
            // Validate that data and format arrays have matching counts
            $data_count = count( $bid_data );
            $format_count = count( $format_array );
            if ( $data_count !== $format_count ) {
                error_log( 'Bid submission - Data/Format mismatch! Data count: ' . $data_count . ', Format count: ' . $format_count );
                error_log( 'Bid submission - Data keys: ' . implode( ', ', array_keys( $bid_data ) ) );
                error_log( 'Bid submission - Format array: ' . print_r( $format_array, true ) );
                $wpdb->query( 'ROLLBACK' );
                throw new Exception( 'Internal error: Data and format arrays do not match. Please contact support.' );
            }

            if ( $should_update_existing && $existing_bid ) {
                // UPDATE existing stale submitted bid with new revision
                $update_result = $wpdb->update(
                    $item_bids_table,
                    $bid_data,
                    array( 'bid_id' => $existing_bid->bid_id ),
                    $format_array,
                    array( '%d' )
                );
                
                if ( $update_result === false ) {
                    error_log( 'Bid update failed - Database error: ' . $wpdb->last_error );
                    error_log( 'Bid update failed - Data: ' . print_r( $bid_data, true ) );
                    error_log( 'Bid update failed - Format: ' . print_r( $format_array, true ) );
                    $wpdb->query( 'ROLLBACK' );
                    throw new Exception( 'Failed to update bid: ' . $wpdb->last_error );
                }
                
                $bid_id = $existing_bid->bid_id;
                error_log( 'Bid resubmission - Updated existing stale bid (ID: ' . $bid_id . ') with new revision ' . $item_current_revision );
            } elseif ( $existing_bid && $existing_bid->status === 'withdrawn' ) {
                // UPDATE existing withdrawn bid
                $update_result = $wpdb->update(
                    $item_bids_table,
                    $bid_data,
                    array( 'bid_id' => $existing_bid->bid_id ),
                    $format_array,
                    array( '%d' )
                );
                
                if ( $update_result === false ) {
                    error_log( 'Bid update failed (withdrawn) - Database error: ' . $wpdb->last_error );
                    $wpdb->query( 'ROLLBACK' );
                    throw new Exception( 'Failed to update bid: ' . $wpdb->last_error );
                }
                
                $bid_id = $existing_bid->bid_id;
            } else {
                // INSERT new bid
                // Check one more time if a bid exists (in case it was created between our check and now)
                $final_check = $wpdb->get_row( $wpdb->prepare(
                    "SELECT bid_id, status FROM {$item_bids_table} WHERE item_id = %d AND supplier_id = %d LIMIT 1",
                    $item_id,
                    $current_user->ID
                ) );
                
                if ( $final_check ) {
                    // Bid exists - update it instead
                    $update_result = $wpdb->update(
                        $item_bids_table,
                        $bid_data,
                        array( 'bid_id' => $final_check->bid_id ),
                        $format_array,
                        array( '%d' )
                    );
                    
                    if ( $update_result === false ) {
                        error_log( 'Bid update failed (final check) - Database error: ' . $wpdb->last_error );
                        error_log( 'Bid update failed - Data: ' . print_r( $bid_data, true ) );
                        error_log( 'Bid update failed - Format: ' . print_r( $format_array, true ) );
                        $wpdb->query( 'ROLLBACK' );
                        throw new Exception( 'Failed to update bid: ' . ( $wpdb->last_error ? $wpdb->last_error : 'Unknown database error' ) );
                    }
                    
                    $bid_id = $final_check->bid_id;
                    error_log( 'Bid submission - Updated existing bid (ID: ' . $bid_id . ') found during final check' );
                } else {
                    // No bid exists - insert new one
                    $insert_result = $wpdb->insert(
                        $item_bids_table,
                        $bid_data,
                        $format_array
                    );
                    
                    if ( $insert_result === false ) {
                        $db_error = $wpdb->last_error ? $wpdb->last_error : 'Unknown database error';
                        error_log( 'Bid insert failed - Database error: ' . $db_error );
                        error_log( 'Bid insert failed - Last query: ' . $wpdb->last_query );
                        error_log( 'Bid insert failed - Data: ' . print_r( $bid_data, true ) );
                        error_log( 'Bid insert failed - Format: ' . print_r( $format_array, true ) );
                        error_log( 'Bid insert failed - Data count: ' . count( $bid_data ) . ', Format count: ' . count( $format_array ) );
                        $wpdb->query( 'ROLLBACK' );
                        throw new Exception( 'Failed to insert bid: ' . $db_error );
                    }
                    
                    $bid_id = $wpdb->insert_id;
                    
                    if ( ! $bid_id ) {
                        error_log( 'Bid insert succeeded but no insert_id returned' );
                        $wpdb->query( 'ROLLBACK' );
                        throw new Exception( 'Failed to insert bid: Insert succeeded but no bid ID returned.' );
                    }
                    
                    error_log( 'Bid submission - Inserted new bid (ID: ' . $bid_id . ')' );
                }
            }

            if ( ! $bid_id ) {
                error_log( 'Bid save failed - No bid_id returned. Last error: ' . $wpdb->last_error );
                $wpdb->query( 'ROLLBACK' );
                throw new Exception( 'Failed to save bid. No bid ID returned.' );
            }

            // Replace media links (DELETE old, INSERT new)
            $wpdb->delete(
                $bid_media_links_table,
                array( 'bid_id' => $bid_id ),
                array( '%d' )
            );

            // Insert new media links (optional, 0-3)
            $sort_order = 0;
            foreach ( $video_links as $link ) {
                // Determine provider from URL (matching validation logic)
                $parsed_url = wp_parse_url( $link );
                $hostname = strtolower( $parsed_url['host'] );
                $hostname = preg_replace( '/^www\./', '', $hostname );
                
                $provider = 'youtube'; // Default
                $hostname_clean = preg_replace( '/^www\./', '', $hostname );
                
                if ( $hostname_clean === 'vimeo.com' || strpos( $hostname_clean, '.vimeo.com' ) !== false ) {
                    $provider = 'vimeo';
                } elseif ( $hostname_clean === 'loom.com' || strpos( $hostname_clean, '.loom.com' ) !== false ) {
                    $provider = 'loom';
                } elseif ( $hostname_clean === 'youtube.com' || $hostname_clean === 'youtu.be' || strpos( $hostname_clean, '.youtube.com' ) !== false ) {
                    $provider = 'youtube';
                }

                $wpdb->insert(
                    $bid_media_links_table,
                    array(
                        'bid_id' => $bid_id,
                        'provider' => $provider,
                        'url' => $link,
                        'sort_order' => $sort_order,
                    ),
                    array( '%d', '%s', '%s', '%d' )
                );
                $sort_order++;
            }
            
            // Commit 2.3.5.1: Handle bid photos - support both file uploads and existing attachment IDs
            $bid_media_files_table = $wpdb->prefix . 'n88_bid_media_files';
            
            // Delete old bid photos
            $wpdb->delete(
                $bid_media_files_table,
                array( 'bid_id' => $bid_id ),
                array( '%d' )
            );
            
            $photo_sort_order = 0;
            
            // First, handle bid_photo_ids (already uploaded WordPress attachments)
            if ( ! empty( $bid_photo_ids ) && is_array( $bid_photo_ids ) ) {
                foreach ( $bid_photo_ids as $photo_id ) {
                    $photo_id = intval( $photo_id );
                    if ( $photo_id > 0 ) {
                        // Get attachment URL
                        $file_url = wp_get_attachment_url( $photo_id );
                        if ( $file_url ) {
                            // Save to n88_bid_media_files table
                            $wpdb->insert(
                                $bid_media_files_table,
                                array(
                                    'bid_id' => $bid_id,
                                    'file_url' => $file_url,
                                    'sort_order' => $photo_sort_order,
                                ),
                                array( '%d', '%s', '%d' )
                            );
                            
                            $photo_sort_order++;
                        }
                    }
                }
            }
            
            // Also handle file uploads if provided (fallback for direct file uploads)
            if ( ! empty( $_FILES['bid_photos'] ) ) {
                require_once( ABSPATH . 'wp-admin/includes/file.php' );
                require_once( ABSPATH . 'wp-admin/includes/media.php' );
                require_once( ABSPATH . 'wp-admin/includes/image.php' );
                
                $files_to_upload = array();
                if ( is_array( $_FILES['bid_photos']['name'] ) ) {
                    foreach ( $_FILES['bid_photos']['name'] as $index => $name ) {
                        if ( ! empty( $name ) ) {
                            $files_to_upload[] = array(
                                'name' => $name,
                                'type' => $_FILES['bid_photos']['type'][ $index ],
                                'tmp_name' => $_FILES['bid_photos']['tmp_name'][ $index ],
                                'error' => $_FILES['bid_photos']['error'][ $index ],
                                'size' => $_FILES['bid_photos']['size'][ $index ],
                            );
                        }
                    }
                } else {
                    if ( ! empty( $_FILES['bid_photos']['name'] ) ) {
                        $files_to_upload[] = $_FILES['bid_photos'];
                    }
                }
                
                foreach ( $files_to_upload as $file ) {
                    if ( $file['error'] === UPLOAD_ERR_OK ) {
                        $upload = wp_handle_upload( $file, array( 'test_form' => false ) );
                        if ( ! isset( $upload['error'] ) ) {
                            $attachment = array(
                                'post_mime_type' => $upload['type'],
                                'post_title'     => sanitize_file_name( pathinfo( $upload['file'], PATHINFO_FILENAME ) ),
                                'post_content'   => '',
                                'post_status'    => 'inherit'
                            );
                            $attach_id = wp_insert_attachment( $attachment, $upload['file'] );
                            $attach_data = wp_generate_attachment_metadata( $attach_id, $upload['file'] );
                            wp_update_attachment_metadata( $attach_id, $attach_data );
                            
                            $file_url = $upload['url'];
                            
                            // Save to n88_bid_media_files table
                            $wpdb->insert(
                                $bid_media_files_table,
                                array(
                                    'bid_id' => $bid_id,
                                    'file_url' => $file_url,
                                    'sort_order' => $photo_sort_order,
                                ),
                                array( '%d', '%s', '%d' )
                            );
                            
                            $photo_sort_order++;
                        }
                    }
                }
            }

            // Update route status to bid_submitted
            $wpdb->update(
                $rfq_routes_table,
                array( 'status' => 'bid_submitted' ),
                array(
                    'item_id' => $item_id,
                    'supplier_id' => $current_user->ID,
                ),
                array( '%s' ),
                array( '%d', '%d' )
            );

            $wpdb->query( 'COMMIT' );

            // Clear draft from user meta after successful submission
            $draft_meta_key = 'n88_bid_draft_' . $item_id;
            delete_user_meta( $current_user->ID, $draft_meta_key );
            
            // Also delete any database draft bids for this item (cleanup)
            $wpdb->delete(
                $item_bids_table,
                array(
                    'item_id' => $item_id,
                    'supplier_id' => $current_user->ID,
                    'status' => 'draft',
                ),
                array( '%d', '%d', '%s' )
            );

            wp_send_json_success( array(
                'message' => 'Bid submitted successfully!',
                'bid_id' => $bid_id,
            ) );

        } catch ( Exception $e ) {
            $wpdb->query( 'ROLLBACK' );
            wp_send_json_error( array(
                'message' => 'An error occurred while submitting the bid: ' . $e->getMessage(),
            ) );
        }
    }

    /**
     * AJAX handler to withdraw supplier bid (Commit 2.3.5 - Optional)
     */
    public function ajax_withdraw_supplier_bid() {
        check_ajax_referer( 'n88_withdraw_supplier_bid', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Maker account required.' ) );
        }

        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }

        global $wpdb;
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';

        // Find existing bid
        $existing_bid = $wpdb->get_row( $wpdb->prepare(
            "SELECT bid_id, status FROM {$item_bids_table} 
            WHERE item_id = %d AND supplier_id = %d",
            $item_id,
            $current_user->ID
        ) );

        if ( ! $existing_bid ) {
            wp_send_json_error( array( 'message' => 'No bid found to withdraw.' ) );
        }

        if ( $existing_bid->status === 'withdrawn' ) {
            wp_send_json_error( array( 'message' => 'This bid has already been withdrawn.' ) );
        }

        // Update bid status to withdrawn
        $updated = $wpdb->update(
            $item_bids_table,
            array( 'status' => 'withdrawn' ),
            array( 'bid_id' => $existing_bid->bid_id ),
            array( '%s' ),
            array( '%d' )
        );

        if ( $updated === false ) {
            wp_send_json_error( array( 'message' => 'Failed to withdraw bid. Please try again.' ) );
        }

        // Check if there are any other submitted bids for this item (from any supplier)
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        
        // Count remaining submitted bids for this item
        $remaining_submitted_bids = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM {$item_bids_table} 
            WHERE item_id = %d 
            AND status = 'submitted'",
            $item_id
        ) );
        
        // If no submitted bids remain: reset to State A so designer can request RFQ again.
        // - Delete all RFQ routes for this item (has_rfq becomes false).
        // - Clear item meta revision flags so Launch Brief form is fresh.
        if ( intval( $remaining_submitted_bids ) === 0 ) {
            $wpdb->delete( $rfq_routes_table, array( 'item_id' => $item_id ), array( '%d' ) );

            $items_table = $wpdb->prefix . 'n88_items';
            $item_meta_json = $wpdb->get_var( $wpdb->prepare(
                "SELECT meta_json FROM {$items_table} WHERE id = %d",
                $item_id
            ) );
            $item_meta = ! empty( $item_meta_json ) ? json_decode( $item_meta_json, true ) : array();
            if ( is_array( $item_meta ) ) {
                unset( $item_meta['revision_changed'], $item_meta['rfq_revision_current'] );
                $wpdb->update(
                    $items_table,
                    array( 'meta_json' => wp_json_encode( $item_meta ) ),
                    array( 'id' => $item_id ),
                    array( '%s' ),
                    array( '%d' )
                );
            }
        } else {
            // There are still other submitted bids - only update this supplier's route
            // Check if this supplier's route is 'bid_submitted' and there are no other submitted bids from this supplier
            $supplier_submitted_bids = $wpdb->get_var( $wpdb->prepare(
                "SELECT COUNT(*) FROM {$item_bids_table} 
                WHERE item_id = %d 
                AND supplier_id = %d 
                AND status = 'submitted'",
                $item_id,
                $current_user->ID
            ) );
            
            // If this supplier has no other submitted bids, update their route back to 'viewed'
            if ( intval( $supplier_submitted_bids ) === 0 ) {
                $wpdb->update(
                    $rfq_routes_table,
                    array( 'status' => 'viewed' ),
                    array(
                        'item_id' => $item_id,
                        'supplier_id' => $current_user->ID,
                        'status' => 'bid_submitted',
                    ),
                    array( '%s' ),
                    array( '%d', '%d', '%s' )
                );
            }
        }

        wp_send_json_success( array(
            'message' => 'Bid withdrawn successfully. You can resubmit a new bid.',
        ) );
    }

    /**
     * Commit 2.4.1: AJAX handler to award bid (designer action)
     * 
     * Award Gating Rules:
     * - Cannot award if prototype request exists UNLESS prototype_status = 'approved'
     * - If prototype was not requested, award is allowed
     * - If prototype was requested and approved, award is allowed
     * 
     * Actions:
     * - Selected bid â†’ status = 'awarded'
     * - All other bids â†’ status = 'declined'
     * - Create immutable snapshot of awarded bid
     * - Log bid_awarded and bid_declined events
     * - Update item status to 'Awarded'
     */
    public function ajax_award_bid() {
        check_ajax_referer( 'n88_award_bid', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_designer && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer account required.' ) );
        }

        // Commit 2.6.1: Check if user is view-only team member
        if ( self::is_view_only_team_member( $current_user->ID ) ) {
            wp_send_json_error( array( 'message' => 'Access denied. Team members have view-only access.' ) );
        }

        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? intval( $_POST['bid_id'] ) : 0;
        
        if ( ! $item_id || ! $bid_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID or bid ID.' ) );
        }

        global $wpdb;
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $items_table = $wpdb->prefix . 'n88_items';
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $events_table = $wpdb->prefix . 'n88_events';

        // Verify item ownership (unless system operator)
        if ( ! $is_system_operator ) {
            $item_owner = $wpdb->get_var( $wpdb->prepare(
                "SELECT owner_user_id FROM {$items_table} WHERE id = %d",
                $item_id
            ) );
            
            if ( ! $item_owner || intval( $item_owner ) !== $current_user->ID ) {
                wp_send_json_error( array( 'message' => 'Access denied. You can only award bids for your own items.' ), 403 );
            }
        }

        // Verify bid exists and belongs to this item
        $bid = $wpdb->get_row( $wpdb->prepare(
            "SELECT bid_id, supplier_id, status, unit_price, production_lead_time_text, 
                    prototype_video_yes, prototype_timeline_option, prototype_cost, 
                    cad_yes, created_at, meta_json
            FROM {$item_bids_table} 
            WHERE bid_id = %d AND item_id = %d",
            $bid_id,
            $item_id
        ), ARRAY_A );

        if ( ! $bid ) {
            wp_send_json_error( array( 'message' => 'Bid not found.' ) );
        }

        // Check if bid is already awarded
        if ( $bid['status'] === 'awarded' ) {
            wp_send_json_error( array( 'message' => 'This bid has already been awarded.' ) );
        }

        // Check if another bid is already awarded for this item
        $existing_awarded = $wpdb->get_var( $wpdb->prepare(
            "SELECT bid_id FROM {$item_bids_table} 
            WHERE item_id = %d AND status = 'awarded'",
            $item_id
        ) );

        if ( $existing_awarded ) {
            wp_send_json_error( array( 'message' => 'Another bid has already been awarded for this item. Only one bid can be awarded per item.' ) );
        }

        // Award Gating: Check prototype status
        $prototype_payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, status, prototype_status 
            FROM {$prototype_payments_table} 
            WHERE bid_id = %d AND item_id = %d 
            ORDER BY created_at DESC 
            LIMIT 1",
            $bid_id,
            $item_id
        ), ARRAY_A );

        if ( $prototype_payment ) {
            // Prototype request exists - check if approved
            $prototype_status = isset( $prototype_payment['prototype_status'] ) ? $prototype_payment['prototype_status'] : null;
            
            if ( $prototype_status !== 'approved' ) {
                wp_send_json_error( array( 
                    'message' => 'Cannot award bid. Prototype must be approved before awarding. Current status: ' . ( $prototype_status ? $prototype_status : 'pending' )
                ) );
            }
        }

        // Start transaction
        $wpdb->query( 'START TRANSACTION' );

        try {
            // 1. Update selected bid to 'awarded'
            $update_awarded = $wpdb->update(
                $item_bids_table,
                array( 'status' => 'awarded' ),
                array( 'bid_id' => $bid_id ),
                array( '%s' ),
                array( '%d' )
            );

            if ( $update_awarded === false ) {
                throw new Exception( 'Failed to update bid status to awarded.' );
            }

            // 2. Update all other submitted bids to 'declined'
            $update_declined = $wpdb->update(
                $item_bids_table,
                array( 'status' => 'declined' ),
                array(
                    'item_id' => $item_id,
                    'status' => 'submitted',
                ),
                array( '%s' ),
                array( '%d', '%s' )
            );

            // 3. Create immutable snapshot of awarded bid
            // Get all bid data including media links and photos
            $bid_media_links_table = $wpdb->prefix . 'n88_bid_media_links';
            $bid_media_files_table = $wpdb->prefix . 'n88_bid_media_files';
            
            $media_links = $wpdb->get_results( $wpdb->prepare(
                "SELECT url, provider, sort_order 
                FROM {$bid_media_links_table} 
                WHERE bid_id = %d 
                ORDER BY sort_order ASC, id ASC",
                $bid_id
            ), ARRAY_A );

            $bid_photos = $wpdb->get_results( $wpdb->prepare(
                "SELECT file_url, sort_order 
                FROM {$bid_media_files_table} 
                WHERE bid_id = %d 
                ORDER BY sort_order ASC, id ASC",
                $bid_id
            ), ARRAY_A );

            // Create snapshot JSON
            $snapshot_data = array(
                'bid_id' => intval( $bid['bid_id'] ),
                'item_id' => $item_id,
                'supplier_id' => intval( $bid['supplier_id'] ),
                'unit_price' => $bid['unit_price'] ? floatval( $bid['unit_price'] ) : null,
                'production_lead_time_text' => $bid['production_lead_time_text'],
                'prototype_video_yes' => intval( $bid['prototype_video_yes'] ) === 1,
                'prototype_timeline_option' => $bid['prototype_timeline_option'],
                'prototype_cost' => $bid['prototype_cost'] ? floatval( $bid['prototype_cost'] ) : null,
                'cad_yes' => $bid['cad_yes'] ? intval( $bid['cad_yes'] ) === 1 : null,
                'media_links' => $media_links,
                'bid_photos' => array_map( function( $photo ) {
                    return esc_url_raw( $photo['file_url'] );
                }, $bid_photos ),
                'meta_json' => $bid['meta_json'] ? $bid['meta_json'] : null,
                'awarded_at' => current_time( 'mysql' ),
                'awarded_by' => $current_user->ID,
            );

            // Store snapshot in item meta_json (or create separate table if needed)
            // For now, store in item meta_json under 'awarded_bid_snapshot'
            $item_meta = $wpdb->get_var( $wpdb->prepare(
                "SELECT meta_json FROM {$items_table} WHERE id = %d",
                $item_id
            ) );
            
            $meta = ! empty( $item_meta ) ? json_decode( $item_meta, true ) : array();
            if ( ! is_array( $meta ) ) {
                $meta = array();
            }
            
            $meta['awarded_bid_snapshot'] = $snapshot_data;
            $meta['item_status'] = 'Awarded'; // Update item status
            
            $wpdb->update(
                $items_table,
                array( 'meta_json' => wp_json_encode( $meta ) ),
                array( 'id' => $item_id ),
                array( '%s' ),
                array( '%d' )
            );

            // 4. Log bid_awarded event
            $wpdb->insert(
                $events_table,
                array(
                    'actor_user_id' => $current_user->ID,
                    'event_type' => 'bid_awarded',
                    'object_type' => 'bid',
                    'object_id' => $bid_id,
                    'item_id' => $item_id,
                    'payload_json' => wp_json_encode( array(
                        'bid_id' => $bid_id,
                        'item_id' => $item_id,
                        'designer_id' => $current_user->ID,
                        'supplier_id' => intval( $bid['supplier_id'] ),
                        'timestamp' => current_time( 'mysql' ),
                    ) ),
                    'created_at' => current_time( 'mysql' ),
                ),
                array( '%d', '%s', '%s', '%d', '%d', '%s', '%s' )
            );

            // 5. Log bid_declined events for all other bids
            $declined_bids = $wpdb->get_results( $wpdb->prepare(
                "SELECT bid_id FROM {$item_bids_table} 
                WHERE item_id = %d AND bid_id != %d AND status = 'declined'",
                $item_id,
                $bid_id
            ), ARRAY_A );

            foreach ( $declined_bids as $declined_bid ) {
                $wpdb->insert(
                    $events_table,
                    array(
                        'actor_user_id' => $current_user->ID,
                        'event_type' => 'bid_declined',
                        'object_type' => 'bid',
                        'object_id' => intval( $declined_bid['bid_id'] ),
                        'item_id' => $item_id,
                        'payload_json' => wp_json_encode( array(
                            'bid_id' => intval( $declined_bid['bid_id'] ),
                            'item_id' => $item_id,
                            'timestamp' => current_time( 'mysql' ),
                        ) ),
                        'created_at' => current_time( 'mysql' ),
                    ),
                    array( '%d', '%s', '%s', '%d', '%d', '%s', '%s' )
                );
            }

            // Commit transaction
            $wpdb->query( 'COMMIT' );

            wp_send_json_success( array(
                'message' => 'Bid awarded successfully!',
                'bid_id' => $bid_id,
                'item_id' => $item_id,
            ) );

        } catch ( Exception $e ) {
            $wpdb->query( 'ROLLBACK' );
            wp_send_json_error( array(
                'message' => 'Failed to award bid: ' . $e->getMessage(),
            ) );
        }
    }

    /**
     * Commit 2.6.1: AJAX handler to invite team member by email
     * 
     * Creates a pending firm member invitation and sends email
     */
    public function ajax_invite_team_member() {
        check_ajax_referer( 'n88_invite_team_member', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_designer && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer account required.' ) );
        }

        $email = isset( $_POST['email'] ) ? sanitize_email( wp_unslash( $_POST['email'] ) ) : '';
        
        if ( empty( $email ) || ! is_email( $email ) ) {
            wp_send_json_error( array( 'message' => 'Valid email address is required.' ) );
        }

        global $wpdb;
        $firms_table = $wpdb->prefix . 'n88_firms';
        $firm_members_table = $wpdb->prefix . 'n88_firm_members';
        $designer_profiles_table = $wpdb->prefix . 'n88_designer_profiles_v2';

        // First, check if user is already a firm owner (they might have created a firm when creating a board)
        $existing_firm_member = $wpdb->get_row( $wpdb->prepare(
            "SELECT fm.firm_id, f.name as firm_name 
            FROM {$firm_members_table} fm
            INNER JOIN {$firms_table} f ON fm.firm_id = f.id
            WHERE fm.user_id = %d 
            AND fm.role = 'owner' 
            AND fm.status = 'active' 
            AND fm.left_at IS NULL
            AND f.deleted_at IS NULL
            LIMIT 1",
            $current_user->ID
        ), ARRAY_A );

        if ( $existing_firm_member && ! empty( $existing_firm_member['firm_name'] ) ) {
            // User is already a firm owner - use that firm
            $firm_id = intval( $existing_firm_member['firm_id'] );
            $firm_name = $existing_firm_member['firm_name'];
        } else {
            // Check designer profile for firm_name
            $designer_profile = $wpdb->get_row( $wpdb->prepare(
                "SELECT firm_name FROM {$designer_profiles_table} WHERE designer_id = %d",
                $current_user->ID
            ), ARRAY_A );

            if ( ! $designer_profile || empty( $designer_profile['firm_name'] ) ) {
                wp_send_json_error( array( 'message' => 'Please complete your profile with a firm name before inviting team members, or create a board first.' ) );
            }

            $firm_name = $designer_profile['firm_name'];
            
            // Get or create firm based on firm_name
            $firm = $wpdb->get_row( $wpdb->prepare(
                "SELECT id, name FROM {$firms_table} WHERE name = %s AND deleted_at IS NULL",
                $firm_name
            ), ARRAY_A );

            if ( ! $firm ) {
                // Create firm if it doesn't exist
                $firm_slug = sanitize_title( $firm_name );
                $firm_slug_base = $firm_slug;
                $counter = 1;
                
                // Ensure unique slug
                while ( $wpdb->get_var( $wpdb->prepare(
                    "SELECT id FROM {$firms_table} WHERE slug = %s",
                    $firm_slug
                ) ) ) {
                    $firm_slug = $firm_slug_base . '-' . $counter;
                    $counter++;
                }

                $wpdb->insert(
                    $firms_table,
                    array(
                        'name' => $firm_name,
                        'slug' => $firm_slug,
                        'created_by_user_id' => $current_user->ID,
                        'created_at' => current_time( 'mysql' ),
                        'updated_at' => current_time( 'mysql' ),
                    ),
                    array( '%s', '%s', '%d', '%s', '%s' )
                );

                $firm_id = $wpdb->insert_id;
                
                // Add designer as firm owner
                $wpdb->insert(
                    $firm_members_table,
                    array(
                        'firm_id' => $firm_id,
                        'user_id' => $current_user->ID,
                        'role' => 'owner',
                        'status' => 'active',
                        'joined_at' => current_time( 'mysql' ),
                    ),
                    array( '%d', '%d', '%s', '%s', '%s' )
                );
            } else {
                $firm_id = intval( $firm['id'] );
                
                // Check if user is already a member of this firm
                $existing_member = $wpdb->get_row( $wpdb->prepare(
                    "SELECT id FROM {$firm_members_table} 
                    WHERE firm_id = %d AND user_id = %d AND left_at IS NULL",
                    $firm_id,
                    $current_user->ID
                ), ARRAY_A );
                
                if ( ! $existing_member ) {
                    // Add designer as firm owner
                    $wpdb->insert(
                        $firm_members_table,
                        array(
                            'firm_id' => $firm_id,
                            'user_id' => $current_user->ID,
                            'role' => 'owner',
                            'status' => 'active',
                            'joined_at' => current_time( 'mysql' ),
                        ),
                        array( '%d', '%d', '%s', '%s', '%s' )
                    );
                }
            }
        }

        // At this point, $firm_id should be set from either path above
        if ( ! isset( $firm_id ) || $firm_id === 0 ) {
            wp_send_json_error( array( 'message' => 'Failed to determine firm. Please try again.' ) );
        }

        // Check if user already exists with this email
        $existing_user = get_user_by( 'email', $email );
        
        if ( $existing_user ) {
            // User exists - check if already a member
            $existing_member = $wpdb->get_row( $wpdb->prepare(
                "SELECT id, status FROM {$firm_members_table} 
                WHERE firm_id = %d AND user_id = %d AND left_at IS NULL",
                $firm_id,
                $existing_user->ID
            ), ARRAY_A );

            if ( $existing_member ) {
                if ( $existing_member['status'] === 'pending' ) {
                    wp_send_json_error( array( 'message' => 'This email has already been invited. Please check your email for the invitation link.' ) );
                } else {
                    wp_send_json_error( array( 'message' => 'This user is already a member of your firm.' ) );
                }
            }
        }

        // Check if there's already a pending invitation for this email
        $pending_invitation = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, status FROM {$firm_members_table} 
            WHERE firm_id = %d AND email = %s AND status = 'pending' AND left_at IS NULL",
            $firm_id,
            $email
        ), ARRAY_A );

        if ( $pending_invitation ) {
            wp_send_json_error( array( 'message' => 'This email has already been invited. Please check your email for the invitation link.' ) );
        }

        // Generate invitation token
        $invitation_token = bin2hex( random_bytes( 32 ) );

        // Create pending invitation
        $insert_data = array(
            'firm_id' => $firm_id,
            'email' => $email,
            'role' => 'member',
            'status' => 'pending',
            'invitation_token' => $invitation_token,
            'invited_by_user_id' => $current_user->ID,
            'invited_at' => current_time( 'mysql' ),
        );

        // If user exists, also set user_id (otherwise will be 0 until account is created)
        if ( $existing_user ) {
            $insert_data['user_id'] = $existing_user->ID;
        } else {
            $insert_data['user_id'] = 0; // Will be updated when user creates account
        }

        // Note: joined_at is NOT set for pending invitations - only set when user accepts

        $wpdb->insert(
            $firm_members_table,
            $insert_data,
            array( '%d', '%s', '%d', '%s', '%s', '%s', '%d', '%s' )
        );

        if ( $wpdb->last_error ) {
            wp_send_json_error( array( 'message' => 'Failed to create invitation. Please try again.' ) );
        }

        // Send invitation email
        // Use custom login page URL instead of wp-login.php
        $login_url = home_url( '/login/' );
        $invitation_url = add_query_arg( array(
            'invite_token' => $invitation_token,
            'email' => urlencode( $email ),
        ), $login_url );

        $subject = sprintf( 'You\'ve been invited to join %s on N88 RFQ Platform', $firm_name );
        $message = sprintf(
            "Hello,\n\nYou've been invited by %s to join %s as a team member on the N88 RFQ Platform.\n\n" .
            "To accept this invitation and set up your account:\n" .
            "1. Click the link below or copy it to your browser\n" .
            "2. Enter your email address: %s\n" .
            "3. Create a password\n" .
            "4. You'll be automatically logged in and granted access to the firm's boards\n\n" .
            "Invitation Link: %s\n\n" .
            "This invitation link will remain valid until you create your account.\n\n" .
            "If you did not expect this invitation, please ignore this email.\n\n" .
            "Best regards,\nN88 RFQ Platform",
            $current_user->display_name,
            $firm_name,
            $email,
            $invitation_url
        );

        $headers = array( 'Content-Type: text/plain; charset=UTF-8' );
        $mail_sent = wp_mail( $email, $subject, $message, $headers );

        if ( ! $mail_sent ) {
            error_log( 'N88 Team Invite: Failed to send invitation email to ' . $email );
            // Don't fail the request if email fails - invitation is still created
        }

        wp_send_json_success( array(
            'message' => 'Team member invitation sent successfully to ' . $email,
            'email' => $email,
        ) );
    }

    /**
     * Commit 2.6.1: AJAX handler to accept team invitation (first-time login)
     * 
     * Creates user account, activates firm member, and auto-logs in
     */
    public function ajax_accept_team_invitation() {
        // Verify nonce - check both POST and GET
        $nonce = isset( $_POST['_ajax_nonce'] ) ? sanitize_text_field( wp_unslash( $_POST['_ajax_nonce'] ) ) : '';
        
        if ( empty( $nonce ) || ! wp_verify_nonce( $nonce, 'n88_accept_team_invitation' ) ) {
            // Log for debugging
            error_log( 'N88 RFQ: Accept invitation nonce verification failed. Nonce: ' . ( empty( $nonce ) ? 'empty' : 'present' ) );
            wp_send_json_error( array( 
                'message' => 'Security check failed. Please refresh the page and try again.',
                'debug' => defined( 'WP_DEBUG' ) && WP_DEBUG ? 'Nonce verification failed' : ''
            ) );
        }

        $email = isset( $_POST['email'] ) ? sanitize_email( wp_unslash( $_POST['email'] ) ) : '';
        $invitation_token = isset( $_POST['invitation_token'] ) ? sanitize_text_field( wp_unslash( $_POST['invitation_token'] ) ) : '';
        $password = isset( $_POST['password'] ) ? $_POST['password'] : '';
        $display_name = isset( $_POST['display_name'] ) ? sanitize_text_field( wp_unslash( $_POST['display_name'] ) ) : '';

        if ( empty( $email ) || ! is_email( $email ) ) {
            wp_send_json_error( array( 'message' => 'Valid email address is required.' ) );
        }

        if ( empty( $invitation_token ) ) {
            wp_send_json_error( array( 'message' => 'Invitation token is required.' ) );
        }

        if ( empty( $password ) || strlen( $password ) < 8 ) {
            wp_send_json_error( array( 'message' => 'Password must be at least 8 characters long.' ) );
        }

        global $wpdb;
        $firm_members_table = $wpdb->prefix . 'n88_firm_members';
        $firms_table = $wpdb->prefix . 'n88_firms';
        $boards_table = $wpdb->prefix . 'n88_boards';

        // Find pending invitation (include invited_by_user_id to get the designer who invited)
        $invitation = $wpdb->get_row( $wpdb->prepare(
            "SELECT fm.*, f.name as firm_name 
            FROM {$firm_members_table} fm
            INNER JOIN {$firms_table} f ON fm.firm_id = f.id
            WHERE fm.email = %s 
            AND fm.invitation_token = %s 
            AND fm.status = 'pending'
            AND fm.left_at IS NULL",
            $email,
            $invitation_token
        ), ARRAY_A );

        if ( ! $invitation ) {
            wp_send_json_error( array( 'message' => 'Invalid or expired invitation. Please contact the person who invited you.' ) );
        }

        // Check if user already exists
        $existing_user = get_user_by( 'email', $email );
        
        if ( $existing_user ) {
            // User exists - activate the invitation
            $user_id = $existing_user->ID;
            
            // Update firm member record
            $wpdb->update(
                $firm_members_table,
                array(
                    'user_id' => $user_id,
                    'status' => 'active',
                    'joined_at' => current_time( 'mysql' ),
                    'invitation_token' => null, // Clear token after use
                ),
                array( 'id' => $invitation['id'] ),
                array( '%d', '%s', '%s', '%s' ),
                array( '%d' )
            );

            // Log the user in
            wp_set_current_user( $user_id );
            wp_set_auth_cookie( $user_id, true );

            // Get board owned by the designer who invited them (invited_by_user_id)
            $inviter_user_id = isset( $invitation['invited_by_user_id'] ) ? intval( $invitation['invited_by_user_id'] ) : 0;
            
            if ( $inviter_user_id > 0 ) {
                // Get the board owned by the designer who invited them
                $board = $wpdb->get_row( $wpdb->prepare(
                    "SELECT id FROM {$boards_table} 
                    WHERE owner_user_id = %d 
                    AND deleted_at IS NULL 
                    ORDER BY created_at ASC 
                    LIMIT 1",
                    $inviter_user_id
                ), ARRAY_A );
                
                if ( $board && isset( $board['id'] ) ) {
                    $board_id = intval( $board['id'] );
                    $redirect_url = admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . $board_id );
                    error_log( 'N88 Team Invite: Redirecting to board_id=' . $board_id . ' for inviter_user_id=' . $inviter_user_id );
                } else {
                    error_log( 'N88 Team Invite: No board found for inviter_user_id=' . $inviter_user_id . ', trying firm owner fallback' );
                    // Fallback: try to get firm owner's board
                    $firm_owner = $wpdb->get_row( $wpdb->prepare(
                        "SELECT user_id FROM {$firm_members_table} 
                        WHERE firm_id = %d 
                        AND role = 'owner' 
                        AND status = 'active' 
                        AND left_at IS NULL 
                        LIMIT 1",
                        $invitation['firm_id']
                    ), ARRAY_A );
                    
                    if ( $firm_owner && isset( $firm_owner['user_id'] ) ) {
                        $board = $wpdb->get_row( $wpdb->prepare(
                            "SELECT id FROM {$boards_table} 
                            WHERE owner_user_id = %d 
                            AND deleted_at IS NULL 
                            ORDER BY created_at ASC 
                            LIMIT 1",
                            $firm_owner['user_id']
                        ), ARRAY_A );
                        
                        $redirect_url = $board && isset( $board['id'] ) ? admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . intval( $board['id'] ) ) : admin_url( 'admin.php?page=n88-rfq-board-demo' );
                    } else {
                        $redirect_url = admin_url( 'admin.php?page=n88-rfq-board-demo' );
                    }
                }
            } else {
                // No inviter user ID - fallback to firm owner
                $firm_owner = $wpdb->get_row( $wpdb->prepare(
                    "SELECT user_id FROM {$firm_members_table} 
                    WHERE firm_id = %d 
                    AND role = 'owner' 
                    AND status = 'active' 
                    AND left_at IS NULL 
                    LIMIT 1",
                    $invitation['firm_id']
                ), ARRAY_A );
                
                if ( $firm_owner && isset( $firm_owner['user_id'] ) ) {
                    $board = $wpdb->get_row( $wpdb->prepare(
                        "SELECT id FROM {$boards_table} 
                        WHERE owner_user_id = %d 
                        AND deleted_at IS NULL 
                        ORDER BY created_at ASC 
                        LIMIT 1",
                        $firm_owner['user_id']
                    ), ARRAY_A );
                    
                    $redirect_url = $board && isset( $board['id'] ) ? admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . intval( $board['id'] ) ) : admin_url( 'admin.php?page=n88-rfq-board-demo' );
                } else {
                    $redirect_url = admin_url( 'admin.php?page=n88-rfq-board-demo' );
                }
            }

            wp_send_json_success( array(
                'message' => 'Account activated successfully!',
                'redirect_url' => $redirect_url,
            ) );
        }

        // Create new user account
        $username = sanitize_user( $email, true );
        // Ensure username is unique
        $username_base = $username;
        $counter = 1;
        while ( username_exists( $username ) ) {
            $username = $username_base . $counter;
            $counter++;
        }

        $user_id = wp_create_user( $username, $password, $email );

        if ( is_wp_error( $user_id ) ) {
            wp_send_json_error( array( 'message' => 'Failed to create account: ' . $user_id->get_error_message() ) );
        }

        // Set display name
        if ( ! empty( $display_name ) ) {
            wp_update_user( array(
                'ID' => $user_id,
                'display_name' => $display_name,
            ) );
        } else {
            // Use email prefix as display name
            $email_parts = explode( '@', $email );
            wp_update_user( array(
                'ID' => $user_id,
                'display_name' => $email_parts[0],
            ) );
        }

        // Assign designer role (team members are designers with view-only access)
        $user = new WP_User( $user_id );
        $user->set_role( 'n88_designer' );

        // Activate firm member
        $wpdb->update(
            $firm_members_table,
            array(
                'user_id' => $user_id,
                'status' => 'active',
                'joined_at' => current_time( 'mysql' ),
                'invitation_token' => null, // Clear token after use
            ),
            array( 'id' => $invitation['id'] ),
            array( '%d', '%s', '%s', '%s' ),
            array( '%d' )
        );

        // Log the user in
        wp_set_current_user( $user_id );
        wp_set_auth_cookie( $user_id, true );

        // Get board owned by the designer who invited them (invited_by_user_id)
        $inviter_user_id = isset( $invitation['invited_by_user_id'] ) ? intval( $invitation['invited_by_user_id'] ) : 0;
        
        if ( $inviter_user_id > 0 ) {
            // Get the board owned by the designer who invited them
            $board = $wpdb->get_row( $wpdb->prepare(
                "SELECT id FROM {$boards_table} 
                WHERE owner_user_id = %d 
                AND deleted_at IS NULL 
                ORDER BY created_at ASC 
                LIMIT 1",
                $inviter_user_id
            ), ARRAY_A );
            
            if ( $board && isset( $board['id'] ) ) {
                $board_id = intval( $board['id'] );
                $redirect_url = admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . $board_id );
                error_log( 'N88 Team Invite: Redirecting new user to board_id=' . $board_id . ' for inviter_user_id=' . $inviter_user_id );
            } else {
                error_log( 'N88 Team Invite: No board found for inviter_user_id=' . $inviter_user_id . ', trying firm owner fallback' );
                // Fallback: try to get firm owner's board
                $firm_owner = $wpdb->get_row( $wpdb->prepare(
                    "SELECT user_id FROM {$firm_members_table} 
                    WHERE firm_id = %d 
                    AND role = 'owner' 
                    AND status = 'active' 
                    AND left_at IS NULL 
                    LIMIT 1",
                    $invitation['firm_id']
                ), ARRAY_A );
                
                if ( $firm_owner && isset( $firm_owner['user_id'] ) ) {
                    $board = $wpdb->get_row( $wpdb->prepare(
                        "SELECT id FROM {$boards_table} 
                        WHERE owner_user_id = %d 
                        AND deleted_at IS NULL 
                        ORDER BY created_at ASC 
                        LIMIT 1",
                        $firm_owner['user_id']
                    ), ARRAY_A );
                    
                    $redirect_url = $board && isset( $board['id'] ) ? admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . intval( $board['id'] ) ) : admin_url( 'admin.php?page=n88-rfq-board-demo' );
                } else {
                    $redirect_url = admin_url( 'admin.php?page=n88-rfq-board-demo' );
                }
            }
        } else {
            // No inviter user ID - fallback to firm owner
            $firm_owner = $wpdb->get_row( $wpdb->prepare(
                "SELECT user_id FROM {$firm_members_table} 
                WHERE firm_id = %d 
                AND role = 'owner' 
                AND status = 'active' 
                AND left_at IS NULL 
                LIMIT 1",
                $invitation['firm_id']
            ), ARRAY_A );
            
            if ( $firm_owner && isset( $firm_owner['user_id'] ) ) {
                $board = $wpdb->get_row( $wpdb->prepare(
                    "SELECT id FROM {$boards_table} 
                    WHERE owner_user_id = %d 
                    AND deleted_at IS NULL 
                    ORDER BY created_at ASC 
                    LIMIT 1",
                    $firm_owner['user_id']
                ), ARRAY_A );
                
                $redirect_url = $board && isset( $board['id'] ) ? admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . intval( $board['id'] ) ) : admin_url( 'admin.php?page=n88-rfq-board-demo' );
            } else {
                $redirect_url = admin_url( 'admin.php?page=n88-rfq-board-demo' );
            }
        }

        wp_send_json_success( array(
            'message' => 'Account created successfully!',
            'redirect_url' => $redirect_url,
        ) );
    }

    /**
     * AJAX handler to save bid draft (Commit 2.3.6)
     * Stores draft bid data in user meta for later retrieval
     */
    public function ajax_save_bid_draft() {
        check_ajax_referer( 'n88_save_bid_draft', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Maker account required.' ) );
        }

        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }

        // Verify supplier has route for this item (unless system operator)
        if ( ! $is_system_operator ) {
            global $wpdb;
            $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
            
            // Commit 2.3.7.1: Check and update expired routes (lazy evaluation)
            $this->check_and_update_expired_routes( $item_id, $current_user->ID );
            
            // Check if route is expired
            if ( $this->is_route_expired( $item_id, $current_user->ID ) ) {
                wp_send_json_error( array( 'message' => 'This RFQ is no longer accepting bids.' ), 403 );
            }
            
            $route_exists = $wpdb->get_var( $wpdb->prepare(
                "SELECT COUNT(*) FROM {$rfq_routes_table} 
                WHERE item_id = %d 
                AND supplier_id = %d 
                AND status IN ('queued', 'sent', 'viewed', 'bid_submitted')",
                $item_id,
                $current_user->ID
            ) );

            if ( ! $route_exists || intval( $route_exists ) === 0 ) {
                wp_send_json_error( array( 'message' => 'Access denied. You do not have permission to bid on this item.' ), 403 );
            }
        }

        // Collect draft data
        $draft_data = array(
            'item_id' => $item_id,
            'saved_at' => current_time( 'mysql' ),
        );

        // Video links
        $video_links_json = isset( $_POST['video_links'] ) ? wp_unslash( $_POST['video_links'] ) : '[]';
        $video_links = json_decode( $video_links_json, true );
        if ( is_array( $video_links ) ) {
            $draft_data['video_links'] = array_map( 'esc_url_raw', $video_links );
        } else {
            $draft_data['video_links'] = array();
        }

        // Bid photos - store both IDs and URLs for restoration
        $bid_photo_ids_json = isset( $_POST['bid_photo_ids'] ) ? wp_unslash( $_POST['bid_photo_ids'] ) : '[]';
        $bid_photo_ids = json_decode( $bid_photo_ids_json, true );
        if ( is_array( $bid_photo_ids ) ) {
            $draft_data['bid_photo_ids'] = array_map( 'intval', $bid_photo_ids );
            // Also store URLs for easy restoration
            $draft_data['bid_photo_urls'] = array();
            foreach ( $bid_photo_ids as $photo_id ) {
                $photo_url = wp_get_attachment_image_url( $photo_id, 'medium' );
                if ( ! $photo_url ) {
                    $photo_url = wp_get_attachment_url( $photo_id );
                }
                if ( $photo_url ) {
                    $draft_data['bid_photo_urls'][] = array(
                        'id' => $photo_id,
                        'url' => esc_url_raw( $photo_url ),
                    );
                }
            }
        } else {
            $draft_data['bid_photo_ids'] = array();
            $draft_data['bid_photo_urls'] = array();
        }

        // Form fields
        $draft_data['prototype_video_yes'] = isset( $_POST['prototype_video_yes'] ) ? sanitize_text_field( $_POST['prototype_video_yes'] ) : '';
        $draft_data['prototype_timeline_option'] = isset( $_POST['prototype_timeline_option'] ) ? sanitize_text_field( $_POST['prototype_timeline_option'] ) : '';
        $draft_data['prototype_cost'] = isset( $_POST['prototype_cost'] ) ? sanitize_text_field( $_POST['prototype_cost'] ) : '';
        $draft_data['production_lead_time_text'] = isset( $_POST['production_lead_time_text'] ) ? sanitize_text_field( $_POST['production_lead_time_text'] ) : '';
        $draft_data['unit_price'] = isset( $_POST['unit_price'] ) ? sanitize_text_field( $_POST['unit_price'] ) : '';

        // Smart Alternatives suggestion
        if ( isset( $_POST['smart_alternatives_suggestion'] ) && ! empty( $_POST['smart_alternatives_suggestion'] ) ) {
            $smart_alt_json = wp_unslash( $_POST['smart_alternatives_suggestion'] );
            $smart_alt_data = json_decode( $smart_alt_json, true );
            if ( is_array( $smart_alt_data ) ) {
                $draft_data['smart_alternatives_suggestion'] = $smart_alt_data;
            }
        }

        // Store draft in user meta (key: n88_bid_draft_{item_id})
        $meta_key = 'n88_bid_draft_' . $item_id;
        $meta_value = wp_json_encode( $draft_data );
        
        $updated = update_user_meta( $current_user->ID, $meta_key, $meta_value );

        if ( $updated === false ) {
            wp_send_json_error( array( 'message' => 'Failed to save draft. Please try again.' ) );
        }

        wp_send_json_success( array(
            'message' => 'Draft saved successfully.',
            'saved_at' => $draft_data['saved_at'],
        ) );
    }

    /**
     * AJAX handler to get bid draft (Commit 2.3.6)
     * Retrieves saved draft bid data from user meta OR database draft bid
     */
    public function ajax_get_bid_draft() {
        check_ajax_referer( 'n88_get_bid_draft', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Maker account required.' ) );
        }

        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }

        global $wpdb;
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $bid_media_links_table = $wpdb->prefix . 'n88_bid_media_links';
        $bid_media_files_table = $wpdb->prefix . 'n88_bid_media_files';
        
        // First, check for draft bid in database (takes priority)
        $draft_bid = $wpdb->get_row( $wpdb->prepare(
            "SELECT bid_id, unit_price, production_lead_time_text, prototype_video_yes, prototype_timeline_option, prototype_cost, meta_json
            FROM {$item_bids_table}
            WHERE item_id = %d
            AND supplier_id = %d
            AND status = 'draft'
            ORDER BY bid_id DESC
            LIMIT 1",
            $item_id,
            $current_user->ID
        ), ARRAY_A );
        
        if ( $draft_bid ) {
            // Draft bid exists in database - get full data including images
            $bid_id = intval( $draft_bid['bid_id'] );
            
            // Get video links
            $video_links = $wpdb->get_results( $wpdb->prepare(
                "SELECT url, provider FROM {$bid_media_links_table}
                WHERE bid_id = %d
                ORDER BY sort_order ASC, id ASC",
                $bid_id
            ), ARRAY_A );
            
            // Get bid photos
            $bid_photos = $wpdb->get_results( $wpdb->prepare(
                "SELECT file_url FROM {$bid_media_files_table}
                WHERE bid_id = %d
                ORDER BY sort_order ASC, id ASC",
                $bid_id
            ), ARRAY_A );
            
            $photo_urls = array();
            $bid_photo_ids = array();
            $bid_photo_urls_array = array();
            foreach ( $bid_photos as $photo ) {
                if ( isset( $photo['file_url'] ) && ! empty( $photo['file_url'] ) ) {
                    $photo_urls[] = esc_url_raw( $photo['file_url'] );
                    // Try to get attachment ID from URL
                    $attachment_id = attachment_url_to_postid( $photo['file_url'] );
                    if ( $attachment_id ) {
                        $bid_photo_ids[] = $attachment_id;
                        $bid_photo_urls_array[] = array(
                            'id' => $attachment_id,
                            'url' => esc_url_raw( $photo['file_url'] ),
                        );
                    } else {
                        // If no attachment ID, just store URL
                        $bid_photo_urls_array[] = array(
                            'id' => null,
                            'url' => esc_url_raw( $photo['file_url'] ),
                        );
                    }
                }
            }
            
            // Get Smart Alternatives from meta_json
            $smart_alternatives_suggestion = null;
            if ( ! empty( $draft_bid['meta_json'] ) ) {
                $bid_meta = json_decode( $draft_bid['meta_json'], true );
                if ( is_array( $bid_meta ) && isset( $bid_meta['smart_alternatives_suggestion'] ) ) {
                    $smart_alternatives_suggestion = $bid_meta['smart_alternatives_suggestion'];
                }
            }
            
            // Build draft data array
            $draft = array(
                'unit_price' => $draft_bid['unit_price'] ? floatval( $draft_bid['unit_price'] ) : null,
                'production_lead_time_text' => $draft_bid['production_lead_time_text'] ? sanitize_text_field( $draft_bid['production_lead_time_text'] ) : null,
                'prototype_video_yes' => intval( $draft_bid['prototype_video_yes'] ) === 1,
                'prototype_timeline_option' => $draft_bid['prototype_timeline_option'] ? sanitize_text_field( $draft_bid['prototype_timeline_option'] ) : null,
                'prototype_cost' => $draft_bid['prototype_cost'] ? floatval( $draft_bid['prototype_cost'] ) : null,
                'video_links' => array_map( function( $link ) {
                    return esc_url_raw( $link['url'] );
                }, $video_links ),
                'bid_photos' => $photo_urls,
                'bid_photo_ids' => $bid_photo_ids,
                'bid_photo_urls' => $bid_photo_urls_array,
                'smart_alternatives_suggestion' => $smart_alternatives_suggestion,
            );
            
            wp_send_json_success( array( 'draft' => $draft ) );
        }
        
        // Fallback: Get draft from user meta
        $meta_key = 'n88_bid_draft_' . $item_id;
        $draft_json = get_user_meta( $current_user->ID, $meta_key, true );

        if ( empty( $draft_json ) ) {
            wp_send_json_success( array( 'draft' => null ) );
        }

        $draft = json_decode( $draft_json, true );

        if ( ! is_array( $draft ) ) {
            wp_send_json_success( array( 'draft' => null ) );
        }

        wp_send_json_success( array( 'draft' => $draft ) );
    }

    /**
     * AJAX handler for RFQ submission routing (Commit 2.3.4)
     * Handles single-item and multi-item submissions
     * Creates routes and delivery context per item
     */
    public function ajax_submit_rfq() {
        check_ajax_referer( 'n88_submit_rfq', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );

        if ( ! $is_designer && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Creator or System Operator account required.' ) );
        }

        // Commit 2.6.1: Check if user is view-only team member
        if ( self::is_view_only_team_member( $current_user->ID ) ) {
            wp_send_json_error( array( 'message' => 'Access denied. Team members have view-only access.' ) );
        }

        global $wpdb;
        $items_table = $wpdb->prefix . 'n88_items';
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        $item_delivery_context_table = $wpdb->prefix . 'n88_item_delivery_context';
        $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
        $supplier_keyword_map_table = $wpdb->prefix . 'n88_supplier_keyword_map';
        $categories_table = $wpdb->prefix . 'n88_categories';
        $users_table = $wpdb->prefix . 'users';

        // Parse input: items array (each item has: item_id, quantity, dimensions, delivery)
        $items_json = isset( $_POST['items'] ) ? wp_unslash( $_POST['items'] ) : '[]';
        $items = json_decode( $items_json, true );

        if ( ! is_array( $items ) || empty( $items ) ) {
            wp_send_json_error( array( 'message' => 'At least one item is required.' ) );
        }

        // Routing options
        $invited_suppliers_raw = isset( $_POST['invited_suppliers'] ) ? wp_unslash( $_POST['invited_suppliers'] ) : '[]';
        $invited_suppliers = json_decode( $invited_suppliers_raw, true );
        if ( ! is_array( $invited_suppliers ) ) {
            $invited_suppliers = array();
        }
        // Sanitize each invited supplier
        $invited_suppliers = array_map( function( $supplier ) {
            return trim( sanitize_text_field( $supplier ) );
        }, $invited_suppliers );
        $invited_suppliers = array_filter( $invited_suppliers ); // Remove empty values
        
        // Validate max 5 invited suppliers
        if ( count( $invited_suppliers ) > 5 ) {
            wp_send_json_error( array(
                'message' => 'Maximum 5 invited makers allowed.',
                'errors' => array( 'invited_suppliers' => 'Maximum 5 invited makers allowed.' ),
            ) );
        }
        
        $allow_system_invites = isset( $_POST['allow_system_invites'] ) ? (bool) $_POST['allow_system_invites'] : false;

        // Validation: Case D - if no invite and toggle OFF, block
        if ( empty( $invited_suppliers ) && ! $allow_system_invites ) {
            wp_send_json_error( array(
                'message' => 'Invite at least one maker or allow the system to invite makers.',
                'errors' => array( 'routing' => 'At least one routing option must be selected.' ),
            ) );
        }

        $errors = array();
        $validated_items = array();

        // Validate each item
        foreach ( $items as $index => $item_data ) {
            $item_id = isset( $item_data['item_id'] ) ? intval( $item_data['item_id'] ) : 0;
            $quantity = isset( $item_data['quantity'] ) ? intval( $item_data['quantity'] ) : 0;
            $width = isset( $item_data['width'] ) ? floatval( $item_data['width'] ) : 0;
            $depth = isset( $item_data['depth'] ) ? floatval( $item_data['depth'] ) : 0;
            $height = isset( $item_data['height'] ) ? floatval( $item_data['height'] ) : 0;
            $dimension_unit = isset( $item_data['dimension_unit'] ) ? sanitize_text_field( $item_data['dimension_unit'] ) : 'in';
            $delivery_country = isset( $item_data['delivery_country'] ) ? strtoupper( trim( sanitize_text_field( $item_data['delivery_country'] ) ) ) : '';
            $delivery_postal = isset( $item_data['delivery_postal'] ) ? trim( sanitize_text_field( $item_data['delivery_postal'] ) ) : '';

            // Validate item exists and user owns it
            $item = $wpdb->get_row( $wpdb->prepare(
                "SELECT id, owner_user_id, item_type, deleted_at FROM {$items_table} WHERE id = %d",
                $item_id
            ) );

            if ( ! $item || $item->deleted_at !== null ) {
                $errors[ "item_{$index}" ] = "Item #{$item_id} not found or deleted.";
                continue;
            }

            if ( (int) $item->owner_user_id !== $current_user->ID && ! $is_system_operator ) {
                $errors[ "item_{$index}" ] = "You do not have permission to submit RFQ for item #{$item_id}.";
                continue;
            }

            // Validate quantity
            if ( $quantity < 1 ) {
                $errors[ "item_{$index}_quantity" ] = 'Quantity must be at least 1.';
            }

            // Validate dimensions
            if ( $width <= 0 || $depth <= 0 || $height <= 0 ) {
                $errors[ "item_{$index}_dimensions" ] = 'All dimensions (width, depth, height) must be greater than 0.';
            }

            // Allow all dimension units (in, cm, mm, m) - validation removed as requested
            // Default to 'in' if empty or invalid
            if ( empty( $dimension_unit ) || ! in_array( $dimension_unit, array( 'in', 'cm', 'mm', 'm' ), true ) ) {
                $dimension_unit = 'in'; // Default fallback
            }

            // Validate delivery country
            if ( empty( $delivery_country ) || strlen( $delivery_country ) !== 2 ) {
                $errors[ "item_{$index}_delivery_country" ] = 'Valid delivery country code (2 letters) is required.';
            }

            // Validate ZIP for US/CA
            if ( in_array( $delivery_country, array( 'US', 'CA' ), true ) && empty( $delivery_postal ) ) {
                $errors[ "item_{$index}_delivery_postal" ] = 'ZIP/postal code is required for US and Canada.';
            }

            if ( empty( $errors ) ) {
                $validated_items[] = array(
                    'item_id' => $item_id,
                    'item' => $item,
                    'quantity' => $quantity,
                    'width' => $width,
                    'depth' => $depth,
                    'height' => $height,
                    'dimension_unit' => $dimension_unit,
                    'delivery_country' => $delivery_country,
                    'delivery_postal' => $delivery_postal,
                );
            }
        }

        // If validation errors, return them
        if ( ! empty( $errors ) ) {
            wp_send_json_error( array(
                'message' => 'Validation failed. Please correct the errors below.',
                'errors' => $errors,
            ) );
        }

        // Start transaction
        $wpdb->query( 'START TRANSACTION' );

        try {
            $invited_supplier_ids = array(); // Array of supplier IDs that exist
            $invite_emails_sent = array(); // Array of emails that were sent (non-existent suppliers)

            // Handle multiple supplier invites
            foreach ( $invited_suppliers as $invite_value ) {
                if ( empty( $invite_value ) ) {
                    continue;
                }
                
                // Check if it's an email or username
                if ( is_email( $invite_value ) ) {
                    // Email: check if user exists
                    $user = get_user_by( 'email', $invite_value );
                    if ( $user && in_array( 'n88_supplier_admin', $user->roles, true ) ) {
                        $invited_supplier_ids[] = $user->ID;
                    } else {
                        // Email doesn't exist or user is not a supplier - send invite email
                        $subject = "You've been invited to bid on an RFQ";
                        $message = "You've been invited to submit a bid. Create your maker account to view details.\n\n";
                        $message .= "Sign up here: " . home_url( '/supplier/onboarding' ) . "\n";
                        wp_mail( $invite_value, $subject, $message );
                        $invite_emails_sent[] = $invite_value;
                        // Do NOT create route yet - wait for supplier to sign up
                    }
                } else {
                    // Username: find user
                    $user = get_user_by( 'login', $invite_value );
                    if ( $user && in_array( 'n88_supplier_admin', $user->roles, true ) ) {
                        $invited_supplier_ids[] = $user->ID;
                    } else {
                        $errors['invited_suppliers'] = 'Maker "' . esc_html( $invite_value ) . '" not found. Please enter a valid maker username or email.';
                    }
                }
            }
            
            // Remove duplicates from invited supplier IDs
            $invited_supplier_ids = array_unique( $invited_supplier_ids );

            // Check if quantity and dimensions columns exist, add them if they don't (once per submission)
            $delivery_columns = $wpdb->get_col( "DESCRIBE {$item_delivery_context_table}" );
            $has_quantity = in_array( 'quantity', $delivery_columns, true );
            $has_dimensions = in_array( 'dimensions_json', $delivery_columns, true );
            
            // Add quantity column if it doesn't exist
            if ( ! $has_quantity ) {
                $table_safe = esc_sql( $item_delivery_context_table );
                $result = $wpdb->query( "ALTER TABLE {$table_safe} ADD COLUMN quantity INT UNSIGNED NULL AFTER shipping_estimate_mode" );
                if ( $result !== false ) {
                    $has_quantity = true;
                    error_log( 'RFQ Submission - Successfully added quantity column to delivery context table' );
                } else {
                    error_log( 'RFQ Submission - Failed to add quantity column to delivery context table: ' . $wpdb->last_error );
                }
            }
            
            // Add dimensions_json column if it doesn't exist
            if ( ! $has_dimensions ) {
                $table_safe = esc_sql( $item_delivery_context_table );
                $result = $wpdb->query( "ALTER TABLE {$table_safe} ADD COLUMN dimensions_json TEXT NULL AFTER quantity" );
                if ( $result !== false ) {
                    $has_dimensions = true;
                    error_log( 'RFQ Submission - Successfully added dimensions_json column to delivery context table' );
                } else {
                    error_log( 'RFQ Submission - Failed to add dimensions_json column to delivery context table: ' . $wpdb->last_error );
                }
            }

            // Process each item
            foreach ( $validated_items as $item_data ) {
                $item_id = $item_data['item_id'];
                $item = $item_data['item'];

                // 1. Write/update delivery context (including quantity and dimensions from RFQ submission)
                $shipping_mode = in_array( $item_data['delivery_country'], array( 'US', 'CA' ), true ) ? 'auto' : 'manual';

                $existing_delivery = $wpdb->get_var( $wpdb->prepare(
                    "SELECT item_id FROM {$item_delivery_context_table} WHERE item_id = %d",
                    $item_id
                ) );

                $delivery_data = array(
                    'item_id' => $item_id,
                    'delivery_country_code' => $item_data['delivery_country'],
                    'delivery_postal_code' => ! empty( $item_data['delivery_postal'] ) ? $item_data['delivery_postal'] : null,
                    'shipping_estimate_mode' => $shipping_mode,
                );
                
                // Add quantity and dimensions if columns exist
                if ( $has_quantity ) {
                    $delivery_data['quantity'] = $item_data['quantity'];
                }
                if ( $has_dimensions ) {
                    $dimensions_data = array(
                        'width' => floatval( $item_data['width'] ),
                        'depth' => floatval( $item_data['depth'] ),
                        'height' => floatval( $item_data['height'] ),
                        'unit' => sanitize_text_field( $item_data['dimension_unit'] ),
                    );
                    $delivery_data['dimensions_json'] = wp_json_encode( $dimensions_data );
                    
                    // Debug: Log dimensions being stored
                    error_log( 'RFQ Submission - Storing dimensions for item ' . $item_id . ': ' . wp_json_encode( $dimensions_data ) );
                } else {
                    error_log( 'RFQ Submission - WARNING: dimensions_json column does not exist for item ' . $item_id );
                }

                // Build format array dynamically based on columns
                $format_array = array( '%d', '%s', '%s', '%s' );
                if ( $has_quantity ) {
                    $format_array[] = '%d';
                }
                if ( $has_dimensions ) {
                    $format_array[] = '%s';
                }

                if ( $existing_delivery ) {
                    $update_result = $wpdb->update(
                        $item_delivery_context_table,
                        $delivery_data,
                        array( 'item_id' => $item_id ),
                        $format_array,
                        array( '%d' )
                    );
                    if ( $update_result === false ) {
                        error_log( 'RFQ Submission - Failed to update delivery context for item ' . $item_id . ': ' . $wpdb->last_error );
                    }
                } else {
                    $insert_result = $wpdb->insert(
                        $item_delivery_context_table,
                        $delivery_data,
                        $format_array
                    );
                    if ( $insert_result === false ) {
                        error_log( 'RFQ Submission - Failed to insert delivery context for item ' . $item_id . ': ' . $wpdb->last_error );
                    } else {
                        error_log( 'RFQ Submission - Successfully inserted delivery context for item ' . $item_id . ' with dimensions: ' . ( isset( $delivery_data['dimensions_json'] ) ? $delivery_data['dimensions_json'] : 'none' ) );
                    }
                }

                // Commit 2.3.10: Calculate and store delivery cost after delivery context is set
                if ( class_exists( 'N88_RFQ_Pricing' ) ) {
                    error_log( sprintf( 'RFQ Submission - Triggering delivery cost calculation for item %d', $item_id ) );
                    $calc_result = N88_RFQ_Pricing::calculate_and_store_delivery_cost( $item_id );
                    if ( $calc_result ) {
                        error_log( sprintf( 'RFQ Submission - Delivery cost calculation result for item %d: %s', $item_id, wp_json_encode( $calc_result ) ) );
                    } else {
                        error_log( sprintf( 'RFQ Submission - Delivery cost calculation returned FALSE for item %d', $item_id ) );
                    }
                } else {
                    error_log( sprintf( 'RFQ Submission - N88_RFQ_Pricing class not found for item %d', $item_id ) );
                }

                // 2. Create designer_invited routes (for each invited supplier that exists)
                foreach ( $invited_supplier_ids as $invited_supplier_id ) {
                    // Check if route already exists (idempotent)
                    $existing_route = $wpdb->get_var( $wpdb->prepare(
                        "SELECT route_id FROM {$rfq_routes_table} WHERE item_id = %d AND supplier_id = %d",
                        $item_id,
                        $invited_supplier_id
                    ) );

                    if ( ! $existing_route ) {
                        $wpdb->insert(
                            $rfq_routes_table,
                            array(
                                'item_id' => $item_id,
                                'supplier_id' => $invited_supplier_id,
                                'route_type' => 'designer_invited',
                                'eligible_after' => null,
                                'routed_at' => current_time( 'mysql' ),
                                'status' => 'sent',
                            ),
                            array( '%d', '%d', '%s', '%s', '%s', '%s' )
                        );
                    }
                }

                // 3. Create system_invited routes (if toggle is ON)
                if ( $allow_system_invites ) {
                    // Exclude already invited suppliers from system matching
                    $exclude_supplier_ids = $invited_supplier_ids;
                    $system_suppliers = $this->match_suppliers_for_item( $item, $exclude_supplier_ids, $wpdb );

                    // Check if any invites were provided (existing suppliers OR emails sent)
                    $has_any_invites_for_delay = ! empty( $invited_supplier_ids ) || ! empty( $invite_emails_sent );

                    foreach ( $system_suppliers as $supplier_id ) {
                        // Check if route already exists (idempotent)
                        $existing_route = $wpdb->get_var( $wpdb->prepare(
                            "SELECT route_id FROM {$rfq_routes_table} WHERE item_id = %d AND supplier_id = %d",
                            $item_id,
                            $supplier_id
                        ) );

                        if ( ! $existing_route ) {
                            // Case B: If 1+ invited suppliers OR emails sent, system routes are delayed 24h
                            // Case C: If no invited suppliers, system routes are immediate
                            if ( $has_any_invites_for_delay ) {
                                // Case B: Delayed system routes (24h delay)
                                $eligible_after = date( 'Y-m-d H:i:s', strtotime( '+24 hours' ) );
                                $wpdb->insert(
                                    $rfq_routes_table,
                                    array(
                                        'item_id' => $item_id,
                                        'supplier_id' => $supplier_id,
                                        'route_type' => 'system_invited',
                                        'eligible_after' => $eligible_after,
                                        'routed_at' => null,
                                        'status' => 'queued',
                                    ),
                                    array( '%d', '%d', '%s', '%s', '%s', '%s' )
                                );
                            } else {
                                // Case C: Immediate system routes
                                $wpdb->insert(
                                    $rfq_routes_table,
                                    array(
                                        'item_id' => $item_id,
                                        'supplier_id' => $supplier_id,
                                        'route_type' => 'system_invited',
                                        'eligible_after' => null,
                                        'routed_at' => current_time( 'mysql' ),
                                        'status' => 'sent',
                                    ),
                                    array( '%d', '%d', '%s', '%s', '%s', '%s' )
                                );
                            }
                        }
                    }
                }
                
                // Initialize rfq_revision_current to 1 if not already set (first RFQ submission)
                $item_meta_json = $wpdb->get_var( $wpdb->prepare(
                    "SELECT meta_json FROM {$items_table} WHERE id = %d",
                    $item_id
                ) );
                $item_meta = ! empty( $item_meta_json ) ? json_decode( $item_meta_json, true ) : array();
                if ( ! is_array( $item_meta ) ) {
                    $item_meta = array();
                }
                
                // Only set revision if not already set (first RFQ submission)
                if ( ! isset( $item_meta['rfq_revision_current'] ) || empty( $item_meta['rfq_revision_current'] ) ) {
                    $item_meta['rfq_revision_current'] = 1;
                    $item_meta['revision_changed'] = false; // Reset revision_changed flag on new RFQ
                    
                    $updated_meta_json = wp_json_encode( $item_meta );
                    $wpdb->update(
                        $items_table,
                        array( 'meta_json' => $updated_meta_json ),
                        array( 'id' => $item_id ),
                        array( '%s' ),
                        array( '%d' )
                    );
                    
                    error_log( 'RFQ Submission - Initialized rfq_revision_current to 1 for item ' . $item_id );
                }
            }

            $wpdb->query( 'COMMIT' );

            // Build success message based on cases
            $message = 'RFQ submitted successfully.';
            $invited_count = count( $invited_supplier_ids );
            $email_count = count( $invite_emails_sent );
            $has_any_invites = $invited_count > 0 || $email_count > 0;
            
            if ( $allow_system_invites ) {
                // Toggle ON
                if ( $has_any_invites ) {
                    // Toggle ON + email added
                    $message .= ' Your invited maker(s) will receive this request.';
                } else {
                    // Toggle ON + NO email entered
                    $message .= ' We sent your request to makers that match your category and keywords.';
                }
            } else {
                // Toggle OFF - only invited suppliers
                if ( $has_any_invites ) {
                    // Only email added (toggle OFF)
                    $message .= ' Your invited maker(s) will receive this request.';
                }
            }

            wp_send_json_success( array(
                'message' => $message,
                'items_processed' => count( $validated_items ),
                'state_updated' => array(
                    'has_rfq' => true,
                    'has_bids' => false,
                ),
            ) );

        } catch ( Exception $e ) {
            $wpdb->query( 'ROLLBACK' );
            wp_send_json_error( array(
                'message' => 'An error occurred while submitting the RFQ: ' . $e->getMessage(),
            ) );
        }
    }

    /**
     * Match suppliers for an item based on category, keywords, geography, and status (Commit 2.3.4)
     * Returns up to 2 supplier IDs
     * 
     * @param object $item Item row from database
     * @param int|array|null $exclude_supplier_ids Supplier ID(s) to exclude (already invited) - can be single ID or array
     * @param wpdb $wpdb Database instance
     * @return array Array of supplier IDs (max 2)
     */
    private function match_suppliers_for_item( $item, $exclude_supplier_ids = null, $wpdb ) {
        $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
        $categories_table = $wpdb->prefix . 'n88_categories';
        $supplier_keyword_map_table = $wpdb->prefix . 'n88_supplier_keyword_map';

        // Map item_type to category (simplified - you may need to adjust based on your category structure)
        // For now, we'll match by item_type directly or find category by name
        $item_type = $item->item_type;

        // Find category ID by name (item_type should match category name)
        $category_id = $wpdb->get_var( $wpdb->prepare(
            "SELECT category_id FROM {$categories_table} WHERE name = %s AND is_active = 1 LIMIT 1",
            $item_type
        ) );

        // Build base query for supplier matching
        $where_conditions = array(
            "sp.is_active = 1",
            "sp.is_overloaded = 0",
            "sp.prototype_video_capable = 1",
            "sp.origin_region IN ('USA', 'ASIA', 'CANADA')",
        );

        $where_params = array();

        // Category match
        if ( $category_id ) {
            $where_conditions[] = "sp.primary_category_id = %d";
            $where_params[] = $category_id;
        }

        // Exclude already invited suppliers (can be single ID or array of IDs)
        if ( ! empty( $exclude_supplier_ids ) ) {
            if ( is_array( $exclude_supplier_ids ) ) {
                if ( count( $exclude_supplier_ids ) > 0 ) {
                    $placeholders = implode( ',', array_fill( 0, count( $exclude_supplier_ids ), '%d' ) );
                    $where_conditions[] = "sp.supplier_id NOT IN ({$placeholders})";
                    $where_params = array_merge( $where_params, $exclude_supplier_ids );
                }
            } else {
                $where_conditions[] = "sp.supplier_id != %d";
                $where_params[] = $exclude_supplier_ids;
            }
        }

        $where_clause = implode( ' AND ', $where_conditions );

        // Build query
        if ( ! empty( $where_params ) ) {
            $query = $wpdb->prepare(
                "SELECT sp.supplier_id FROM {$supplier_profiles_table} sp
                WHERE {$where_clause}
                LIMIT 2",
                $where_params
            );
        } else {
            $query = "SELECT sp.supplier_id FROM {$supplier_profiles_table} sp
                WHERE {$where_clause}
                LIMIT 2";
        }

        $supplier_ids = $wpdb->get_col( $query );

        return array_map( 'intval', $supplier_ids );
    }
    
    /**
     * G) AJAX handler to update bid to match new specs
     * Creates a new draft bid for current revision, pre-filled from latest stale bid
     */
    public function ajax_update_bid_to_match_new_specs() {
        check_ajax_referer( 'n88_update_bid_to_match_new_specs', '_ajax_nonce' );
        
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        
        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Maker account required.' ) );
        }
        
        $item_id = isset( $_POST['item_id'] ) ? intval( $_POST['item_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }
        
        global $wpdb;
        $items_table = $wpdb->prefix . 'n88_items';
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        $bid_media_links_table = $wpdb->prefix . 'n88_bid_media_links';
        $bid_media_files_table = $wpdb->prefix . 'n88_bid_media_files';
        
        // Verify supplier has route
        if ( ! $is_system_operator ) {
            $route_exists = $wpdb->get_var( $wpdb->prepare(
                "SELECT COUNT(*) FROM {$rfq_routes_table} 
                WHERE item_id = %d 
                AND supplier_id = %d 
                AND status IN ('queued', 'sent', 'viewed', 'bid_submitted')",
                $item_id,
                $current_user->ID
            ) );
            
            if ( ! $route_exists || intval( $route_exists ) === 0 ) {
                wp_send_json_error( array( 'message' => 'Access denied. You do not have permission to bid on this item.' ), 403 );
            }
        }
        
        // Get item current revision
        $item_meta_json = $wpdb->get_var( $wpdb->prepare(
            "SELECT meta_json FROM {$items_table} WHERE id = %d",
            $item_id
        ) );
        $item_meta = ! empty( $item_meta_json ) ? json_decode( $item_meta_json, true ) : array();
        if ( ! is_array( $item_meta ) ) {
            $item_meta = array();
        }
        $item_current_revision = isset( $item_meta['rfq_revision_current'] ) ? intval( $item_meta['rfq_revision_current'] ) : 1;
        
        // Check if current revision draft already exists
        $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
        $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
        
        $existing_current_draft = null;
        if ( $has_revision_column ) {
            $existing_current_draft = $wpdb->get_row( $wpdb->prepare(
                "SELECT bid_id FROM {$item_bids_table} 
                WHERE item_id = %d 
                AND supplier_id = %d
                AND rfq_revision_at_submit = %d
                AND status = 'draft'
                LIMIT 1",
                $item_id,
                $current_user->ID,
                $item_current_revision
            ) );
        }
        
        if ( $existing_current_draft ) {
            wp_send_json_success( array(
                'message' => 'Draft already exists for current revision.',
                'bid_id' => intval( $existing_current_draft->bid_id ),
            ) );
            return;
        }
        
        // Get latest stale bid (oldest revision, most recent created_at)
        $stale_bid_query = "SELECT bid_id, unit_price, production_lead_time_text, prototype_video_yes, prototype_timeline_option, prototype_cost";
        $bids_columns_check = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
        $has_bid_meta_json = in_array( 'meta_json', $bids_columns_check, true );
        if ( $has_bid_meta_json ) {
            $stale_bid_query .= ", meta_json";
        }
        if ( $has_revision_column ) {
            $stale_bid_query .= ", rfq_revision_at_submit";
        }
        $stale_bid_query .= " FROM {$item_bids_table} 
            WHERE item_id = %d 
            AND supplier_id = %d
            AND status IN ('submitted', 'draft')";
        
        if ( $has_revision_column ) {
            $stale_bid_query .= " AND (rfq_revision_at_submit IS NULL OR rfq_revision_at_submit < %d)";
            $stale_bid = $wpdb->get_row( $wpdb->prepare(
                $stale_bid_query . " ORDER BY created_at DESC, bid_id DESC LIMIT 1",
                $item_id,
                $current_user->ID,
                $item_current_revision
            ), ARRAY_A );
        } else {
            $stale_bid = $wpdb->get_row( $wpdb->prepare(
                $stale_bid_query . " ORDER BY created_at DESC, bid_id DESC LIMIT 1",
                $item_id,
                $current_user->ID
            ), ARRAY_A );
        }
        
        if ( ! $stale_bid ) {
            wp_send_json_error( array( 'message' => 'No stale bid found to copy from.' ) );
            return;
        }
        
        $stale_bid_id = intval( $stale_bid['bid_id'] );
        
        // Start transaction
        $wpdb->query( 'START TRANSACTION' );
        
        try {
            // Create new draft bid with current revision
            $new_draft_data = array(
                'item_id' => $item_id,
                'supplier_id' => $current_user->ID,
                'is_anonymous' => 1,
                'unit_price' => $stale_bid['unit_price'] ? floatval( $stale_bid['unit_price'] ) : null,
                'production_lead_time_text' => $stale_bid['production_lead_time_text'] ? sanitize_text_field( $stale_bid['production_lead_time_text'] ) : null,
                'prototype_video_yes' => intval( $stale_bid['prototype_video_yes'] ) === 1 ? 1 : 0,
                'prototype_timeline_option' => $stale_bid['prototype_timeline_option'] ? sanitize_text_field( $stale_bid['prototype_timeline_option'] ) : null,
                'prototype_cost' => $stale_bid['prototype_cost'] ? floatval( $stale_bid['prototype_cost'] ) : null,
                'cad_yes' => null,
                'status' => 'draft',
            );
            
            // Add meta_json if available
            if ( $has_bid_meta_json && ! empty( $stale_bid['meta_json'] ) ) {
                $new_draft_data['meta_json'] = $stale_bid['meta_json'];
            }
            
            // Add revision
            if ( $has_revision_column ) {
                $new_draft_data['rfq_revision_at_submit'] = $item_current_revision;
            }
            
            // Prepare format array
            $format_array = array( '%d', '%d', '%d', '%f', '%s', '%d', '%s', '%f', '%s', '%s' );
            if ( $has_bid_meta_json && isset( $new_draft_data['meta_json'] ) ) {
                $format_array[] = '%s';
            }
            if ( $has_revision_column ) {
                $format_array[] = '%d';
            }
            
            // Insert new draft
            $inserted = $wpdb->insert(
                $item_bids_table,
                $new_draft_data,
                $format_array
            );
            
            if ( ! $inserted ) {
                throw new Exception( 'Failed to create draft bid.' );
            }
            
            $new_draft_bid_id = $wpdb->insert_id;
            
            // Copy video links from stale bid
            $stale_video_links = $wpdb->get_results( $wpdb->prepare(
                "SELECT url, provider, sort_order FROM {$bid_media_links_table}
                WHERE bid_id = %d
                ORDER BY sort_order ASC, id ASC",
                $stale_bid_id
            ), ARRAY_A );
            
            foreach ( $stale_video_links as $link ) {
                $wpdb->insert(
                    $bid_media_links_table,
                    array(
                        'bid_id' => $new_draft_bid_id,
                        'url' => $link['url'],
                        'provider' => $link['provider'],
                        'sort_order' => $link['sort_order'],
                    ),
                    array( '%d', '%s', '%s', '%d' )
                );
            }
            
            // Copy bid photos from stale bid
            $stale_photos = $wpdb->get_results( $wpdb->prepare(
                "SELECT file_url, sort_order FROM {$bid_media_files_table}
                WHERE bid_id = %d
                ORDER BY sort_order ASC, id ASC",
                $stale_bid_id
            ), ARRAY_A );
            
            foreach ( $stale_photos as $photo ) {
                $wpdb->insert(
                    $bid_media_files_table,
                    array(
                        'bid_id' => $new_draft_bid_id,
                        'file_url' => $photo['file_url'],
                        'sort_order' => $photo['sort_order'],
                    ),
                    array( '%d', '%s', '%d' )
                );
            }
            
            $wpdb->query( 'COMMIT' );
            
            wp_send_json_success( array(
                'message' => 'New draft created successfully. Please update your bid to match the new specs.',
                'bid_id' => $new_draft_bid_id,
                'revision' => $item_current_revision,
            ) );
            
        } catch ( Exception $e ) {
            $wpdb->query( 'ROLLBACK' );
            wp_send_json_error( array(
                'message' => 'Failed to create draft: ' . $e->getMessage(),
            ) );
        }
    }

    /**
     * AJAX: Create CAD + Prototype Request (Commit 2.3.9.1A)
     * 
     * Creates a request for CAD + Prototype video with immutable evidence logging.
     * Designer-only endpoint.
     */
    public function ajax_create_cad_prototype_request() {
        // Nonce verification
        check_ajax_referer( 'n88-rfq-nonce', 'nonce' );

        // Login check
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ), 401 );
            return;
        }

        // Designer permission check
        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        if ( ! $is_designer ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer account required.' ) );
            return;
        }

        // Commit 2.6.1: Check if user is view-only team member
        if ( self::is_view_only_team_member( $current_user->ID ) ) {
            wp_send_json_error( array( 'message' => 'Access denied. Team members have view-only access.' ) );
            return;
        }

        $designer_user_id = get_current_user_id();

        // Get and validate input
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;
        
        // Handle selected_keywords as array (from FormData with selected_keywords[])
        $selected_keywords = array();
        if ( isset( $_POST['selected_keywords'] ) ) {
            if ( is_array( $_POST['selected_keywords'] ) ) {
                $selected_keywords = $_POST['selected_keywords'];
            } elseif ( is_string( $_POST['selected_keywords'] ) ) {
                // Handle JSON string format (fallback)
                $decoded = json_decode( wp_unslash( $_POST['selected_keywords'] ), true );
                if ( is_array( $decoded ) ) {
                    $selected_keywords = $decoded;
                }
            }
        }
        
        $note = isset( $_POST['note'] ) ? sanitize_textarea_field( wp_unslash( $_POST['note'] ) ) : '';

        // Validate required fields
        if ( ! $item_id || ! $bid_id ) {
            wp_send_json_error( array( 'message' => 'Item ID and Bid ID are required.' ) );
            return;
        }

        // Validate keywords array
        if ( ! is_array( $selected_keywords ) ) {
            $selected_keywords = array();
        }
        
        // Clean and validate keywords (must be integers)
        $selected_keywords = array_map( 'absint', $selected_keywords );
        $selected_keywords = array_filter( $selected_keywords ); // Remove zeros
        $selected_keywords = array_unique( $selected_keywords ); // Remove duplicates

        // Validate keyword count: 3-7
        $keyword_count = count( $selected_keywords );
        if ( $keyword_count < 3 || $keyword_count > 7 ) {
            wp_send_json_error( array( 'message' => 'Please select between 3 and 7 keywords.' ) );
            return;
        }

        // Validate note length: max 240 chars
        if ( strlen( $note ) > 240 ) {
            wp_send_json_error( array( 'message' => 'Note must not exceed 240 characters.' ) );
            return;
        }

        global $wpdb;
        $items_table = $wpdb->prefix . 'n88_items';
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $keywords_table = $wpdb->prefix . 'n88_keywords';

        // Validate item exists and belongs to designer
        $item = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, owner_user_id FROM {$items_table} WHERE id = %d AND deleted_at IS NULL",
            $item_id
        ) );

        if ( ! $item ) {
            wp_send_json_error( array( 'message' => 'Item not found.' ) );
            return;
        }

        if ( intval( $item->owner_user_id ) !== $designer_user_id ) {
            wp_send_json_error( array( 'message' => 'Access denied. Item does not belong to you.' ) );
            return;
        }

        // Validate bid exists and belongs to item
        $bid = $wpdb->get_row( $wpdb->prepare(
            "SELECT bid_id, item_id, supplier_id, prototype_cost FROM {$item_bids_table} WHERE bid_id = %d AND item_id = %d",
            $bid_id,
            $item_id
        ) );

        if ( ! $bid ) {
            wp_send_json_error( array( 'message' => 'Bid not found or does not belong to this item.' ) );
            return;
        }

        $supplier_id = intval( $bid->supplier_id );
        $prototype_video_cost_estimate = $bid->prototype_cost ? floatval( $bid->prototype_cost ) : null;

        // Validate keywords exist (optional check, but good for data integrity)
        // Note: $selected_keywords already cleaned above (lines 11115-11117)
        if ( ! empty( $selected_keywords ) ) {
            $keywords_placeholders = implode( ',', array_fill( 0, count( $selected_keywords ), '%d' ) );
            $valid_keywords = $wpdb->get_col( $wpdb->prepare(
                "SELECT keyword_id FROM {$keywords_table} WHERE keyword_id IN ({$keywords_placeholders})",
                ...$selected_keywords
            ) );

            if ( count( $valid_keywords ) !== $keyword_count ) {
                wp_send_json_error( array( 'message' => 'One or more selected keywords are invalid.' ) );
                return;
            }
        }

        // Get category_id from first keyword (for event logging)
        $category_id = null;
        if ( ! empty( $selected_keywords ) ) {
            $first_keyword = $wpdb->get_row( $wpdb->prepare(
                "SELECT category_id FROM {$keywords_table} WHERE keyword_id = %d",
                $selected_keywords[0]
            ) );
            if ( $first_keyword ) {
                $category_id = intval( $first_keyword->category_id );
            }
        }

        // Designer/operator Amount Due: CAD fee + prototype cost AFTER markup (landed), not supplier raw.
        $prototype_video_cost_for_total = 0.00;
        if ( $prototype_video_cost_estimate !== null && floatval( $prototype_video_cost_estimate ) > 0 ) {
            $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
            $origin_region = null;
            $duty_rate_override = null;
            if ( $supplier_id > 0 ) {
                $table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$supplier_profiles_table}'" ) === $supplier_profiles_table;
                if ( $table_exists ) {
                    $supplier_profile = $wpdb->get_row( $wpdb->prepare(
                        "SELECT origin_region, duty_rate_override FROM {$supplier_profiles_table} WHERE supplier_id = %d",
                        $supplier_id
                    ), ARRAY_A );
                    if ( $supplier_profile ) {
                        $origin_region = isset( $supplier_profile['origin_region'] ) ? $supplier_profile['origin_region'] : null;
                        $duty_rate_override = isset( $supplier_profile['duty_rate_override'] ) ? $supplier_profile['duty_rate_override'] : null;
                    }
                }
            }
            $duty_rate = N88_RFQ_Helpers::n88_calculate_duty_rate( $origin_region, $duty_rate_override );
            $prototype_landed = N88_RFQ_Helpers::n88_calculate_landed_cost( $prototype_video_cost_estimate, $duty_rate );
            $prototype_video_cost_for_total = ( $prototype_landed && isset( $prototype_landed['display_price'] ) )
                ? floatval( $prototype_landed['display_price'] )
                : floatval( $prototype_video_cost_estimate );
        }

        // Calculate costs
        $cad_fee_usd = 60.00;
        $cad_revision_rounds_included = 3;
        $cad_revision_round_fee_usd = 25.00;
        $cad_revision_rounds_used = 0;
        $total_due_usd = $cad_fee_usd + $prototype_video_cost_for_total;

        // Prepare video_direction_json
        $video_direction_data = array(
            'selected_keywords' => $selected_keywords,
            'note' => $note,
        );
        $video_direction_json = wp_json_encode( $video_direction_data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES );
        
        // Commit 2.3.9.2B-D: Store direction_keyword_ids as JSON array
        $direction_keyword_ids_json = wp_json_encode( $selected_keywords, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES );

        // Payment reference
        $payment_reference = "Item {$item_id} / Bid {$bid_id}";
        $payment_instructions_version = 'v1';

        // Insert into n88_prototype_payments
        $insert_result = $wpdb->insert(
            $prototype_payments_table,
            array(
                'item_id' => $item_id,
                'bid_id' => $bid_id,
                'designer_user_id' => $designer_user_id,
                'supplier_id' => $supplier_id,
                'status' => 'requested',
                'video_direction_json' => $video_direction_json,
                'direction_keyword_ids' => $direction_keyword_ids_json, // Commit 2.3.9.2B-D
                'cad_fee_usd' => $cad_fee_usd,
                'cad_revision_rounds_included' => $cad_revision_rounds_included,
                'cad_revision_round_fee_usd' => $cad_revision_round_fee_usd,
                'cad_revision_rounds_used' => $cad_revision_rounds_used,
                'prototype_video_cost_estimate_usd' => $prototype_video_cost_estimate,
                'total_due_usd' => $total_due_usd,
                'payment_reference' => $payment_reference,
                'payment_instructions_version' => $payment_instructions_version,
                'created_at' => current_time( 'mysql' ),
            ),
            array( '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%f', '%d', '%f', '%d', '%f', '%f', '%s', '%s', '%s' )
        );

        if ( $insert_result === false ) {
            error_log( 'CAD Prototype Request: Failed to insert payment record. Error: ' . $wpdb->last_error );
            wp_send_json_error( array( 'message' => 'Failed to create request. Please try again.' ) );
            return;
        }

        $prototype_payment_id = $wpdb->insert_id;

        // Event 1: cad_prototype_requested
        n88_log_event(
            'cad_prototype_requested',
            'prototype_payment',
            array(
                'object_id' => $prototype_payment_id,
                'item_id' => $item_id,
                'payload_json' => array(
                    'item_id' => $item_id,
                    'bid_id' => $bid_id,
                    'supplier_id' => $supplier_id,
                    'designer_user_id' => $designer_user_id,
                    'cad_fee_usd' => $cad_fee_usd,
                    'cad_rounds_included' => $cad_revision_rounds_included,
                    'cad_round_fee_usd' => $cad_revision_round_fee_usd,
                    'prototype_video_cost_estimate_usd' => $prototype_video_cost_estimate,
                    'total_due_usd' => $total_due_usd,
                    'keyword_count' => $keyword_count,
                    'note_present' => ! empty( $note ),
                ),
            )
        );
        // Commit 3.A.1: Timeline step 1 start when designer requests CAD/prototype
        if ( class_exists( 'N88_Item_Timeline' ) ) {
            N88_Item_Timeline::sync_from_cad_prototype_requested( $item_id );
        }

        // Event 2: video_direction_submitted
        n88_log_event(
            'video_direction_submitted',
            'prototype_payment',
            array(
                'object_id' => $prototype_payment_id,
                'item_id' => $item_id,
                'payload_json' => array(
                    'category_id' => $category_id,
                    'selected_keywords' => $selected_keywords,
                    'note_present' => ! empty( $note ),
                ),
            )
        );

        // Stub Notifications
        // Operator notification
        $operator_message = sprintf(
            'CAD + Prototype requested â€” Item %d, Bid %d. Status: requested. Total due: $%.2f',
            $item_id,
            $bid_id,
            $total_due_usd
        );
        error_log( 'CAD Prototype Request - Operator Notification: ' . $operator_message );

        // Supplier notification
        $supplier_message = 'Prototype requested. Awaiting payment confirmation and final CAD approval. You will receive approved CAD + direction before filming begins.';
        error_log( 'CAD Prototype Request - Supplier Notification (User ID: ' . $supplier_id . '): ' . $supplier_message );

        // Designer notification (optional)
        $designer_message = 'Request submitted. Please send payment. CAD drafting begins after payment confirmation.';
        error_log( 'CAD Prototype Request - Designer Notification (User ID: ' . $designer_user_id . '): ' . $designer_message );

        // Return success
        wp_send_json_success( array(
            'message' => 'CAD + Prototype request created successfully.',
            'prototype_payment_id' => $prototype_payment_id,
            'total_due_usd' => $total_due_usd,
        ) );
    }

    /**
     * Render Operator Queue v1 (Commit 2.3.9.1C)
     * 
     * Operator dashboard for viewing CAD + Prototype Video requests
     * Read-only intake and visibility - no status changes in this commit
     */
    public function render_operator_queue( $atts = array() ) {
        // Check if user is logged in and is a system operator
        if ( ! is_user_logged_in() ) {
            wp_redirect( home_url( '/login/' ) );
            exit;
        }

        $current_user = wp_get_current_user();
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_system_operator ) {
            wp_die( 'Access denied. System Operator account required.', 'Access Denied', array( 'response' => 403 ) );
        }

        global $wpdb;
        $prototype_payments_table   = $wpdb->prefix . 'n88_prototype_payments';
        $items_table                = $wpdb->prefix . 'n88_items';
        $item_bids_table            = $wpdb->prefix . 'n88_item_bids';
        $board_items_table          = $wpdb->prefix . 'n88_board_items';
        $categories_table           = $wpdb->prefix . 'n88_categories';
        $users_table                = $wpdb->prefix . 'users';
        $events_table               = $wpdb->prefix . 'n88_events';
        $rfq_routes_table           = $wpdb->prefix . 'n88_rfq_routes';
        $supplier_profiles_table    = $wpdb->prefix . 'n88_supplier_profiles';
        $messages_table             = $wpdb->prefix . 'n88_item_messages';

        // Check if prototype_payments table exists
        $table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table;
        if ( ! $table_exists ) {
            return '<div style="padding: 40px; text-align: center; font-family: monospace; color: #fff; background: #000;">
                <h2 style="color: #ff4444;">Table Not Found</h2>
                <p>n88_prototype_payments table does not exist. Please run plugin activation/upgrade.</p>
            </div>';
        }

        // Get filter values from URL (with defaults)
        // Default status filter is 'requested' per spec
        $status_filter = isset( $_GET['status'] ) ? sanitize_text_field( wp_unslash( $_GET['status'] ) ) : 'requested';
        $supplier_filter = isset( $_GET['supplier'] ) ? sanitize_text_field( wp_unslash( $_GET['supplier'] ) ) : 'all';
        $designer_filter = isset( $_GET['designer'] ) ? sanitize_text_field( wp_unslash( $_GET['designer'] ) ) : 'all';
        $category_filter = isset( $_GET['category'] ) ? sanitize_text_field( wp_unslash( $_GET['category'] ) ) : 'all';
        $time_filter = isset( $_GET['time'] ) ? sanitize_text_field( wp_unslash( $_GET['time'] ) ) : 'all';
        $needs_attention_filter = isset( $_GET['needs_attention'] ) ? sanitize_text_field( wp_unslash( $_GET['needs_attention'] ) ) : 'all';
        $search_filter = isset( $_GET['search'] ) ? sanitize_text_field( wp_unslash( $_GET['search'] ) ) : '';
        
        // Pagination
        $page = isset( $_GET['paged'] ) ? max( 1, intval( $_GET['paged'] ) ) : 1;
        $per_page = 20;
        $offset = ( $page - 1 ) * $per_page;

        // Build WHERE conditions array - query prototype_payments table
        $where_conditions = array();
        
        // Exclude deleted items: item must exist, not soft-deleted, and still on a board (not removed)
        $where_conditions[] = "i.id IS NOT NULL AND (i.deleted_at IS NULL OR i.deleted_at = '')";
        $where_conditions[] = "EXISTS (SELECT 1 FROM {$board_items_table} bi WHERE bi.item_id = pp.item_id AND (bi.removed_at IS NULL OR bi.removed_at = ''))";
        
        // Base condition: only show requested or marked_received status
        if ( $status_filter === 'requested' ) {
            $where_conditions[] = "pp.status = 'requested'";
        } elseif ( $status_filter === 'marked_received' ) {
            $where_conditions[] = "pp.status = 'marked_received'";
        } elseif ( $status_filter === 'all' ) {
            $where_conditions[] = "pp.status IN ('requested', 'marked_received')";
        } else {
            // Default to requested if invalid
            $where_conditions[] = "pp.status = 'requested'";
        }
        
        // Time filter
        if ( $time_filter === '24h' ) {
            $where_conditions[] = "pp.created_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR)";
        } elseif ( $time_filter === '7d' ) {
            $where_conditions[] = "pp.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)";
        } elseif ( $time_filter === '30d' ) {
            $where_conditions[] = "pp.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)";
        }

        // Search filter (item id / bid id / payment id)
        if ( ! empty( $search_filter ) ) {
            $where_conditions[] = $wpdb->prepare(
                "(pp.item_id = %d OR pp.bid_id = %d OR pp.id = %d)",
                intval( $search_filter ),
                intval( $search_filter ),
                intval( $search_filter )
            );
        }

        // Supplier filter
        if ( $supplier_filter !== 'all' ) {
            $where_conditions[] = $wpdb->prepare( "pp.supplier_id = %d", intval( $supplier_filter ) );
        }

        // Designer filter
        if ( $designer_filter !== 'all' ) {
            $where_conditions[] = $wpdb->prepare( "pp.designer_user_id = %d", intval( $designer_filter ) );
        }

        // Category filter
        if ( $category_filter !== 'all' ) {
            $where_conditions[] = $wpdb->prepare( "i.item_type = %s", $category_filter );
        }
        
        // Needs Attention filter (items with status = 'requested' OR clarification_needed need attention)
        // Note: This filter will be applied after UNION in the combined query
        $apply_needs_attention_filter = false;
        if ( $needs_attention_filter === 'yes' ) {
            $apply_needs_attention_filter = true;
            // For prototype payments, only show 'requested'
            $where_conditions[] = "pp.status = 'requested'";
        } elseif ( $needs_attention_filter === 'no' ) {
            // For prototype payments, only show 'marked_received'
            $where_conditions[] = "pp.status = 'marked_received'";
            // For clarifications, exclude them when filter is 'no'
            $clarification_where[] = "1=0"; // Exclude all clarifications
        }
        
        // Build WHERE clause
        $where_clause = ! empty( $where_conditions ) ? 'WHERE ' . implode( ' AND ', $where_conditions ) : '';

        // Queue Surfacing Fix: Build UNION query to include items with supplier clarification messages
        // Part 1: Items from prototype_payments (existing functionality)
        $prototype_query = "
            SELECT 
                pp.id as payment_id,
                pp.item_id,
                pp.bid_id,
                pp.supplier_id,
                pp.designer_user_id,
                pp.status,
                pp.video_direction_json,
                pp.cad_fee_usd,
                pp.cad_revision_rounds_included,
                pp.cad_revision_round_fee_usd,
                pp.cad_revision_rounds_used,
                pp.cad_status,
                pp.cad_approved_version,
                pp.cad_released_to_supplier_at,
                pp.prototype_video_cost_estimate_usd,
                pp.total_due_usd,
                pp.created_at,
                pp.payment_reference,
                i.title as item_title,
                i.primary_image_id,
                i.item_type,
                c.name as category_name,
                b.unit_price as bid_unit_price,
                b.prototype_cost as bid_prototype_cost,
                designer.display_name as designer_name,
                designer.user_login as designer_login,
                supplier.display_name as supplier_name,
                supplier.user_login as supplier_login,
                CASE WHEN (
                    (
                        SELECT COUNT(DISTINCT sm.message_id)
                        FROM {$messages_table} sm
                        WHERE sm.thread_type = 'supplier_operator'
                        AND sm.sender_role = 'supplier'
                        AND sm.item_id = pp.item_id
                        AND (sm.bid_id = pp.bid_id OR (sm.bid_id IS NULL AND pp.bid_id IS NULL))
                        AND sm.supplier_id = pp.supplier_id
                        AND NOT EXISTS (
                            SELECT 1 FROM {$messages_table} om
                            WHERE om.thread_type = 'supplier_operator'
                            AND om.sender_role = 'operator'
                            AND om.item_id = sm.item_id
                            AND (om.bid_id = sm.bid_id OR (om.bid_id IS NULL AND sm.bid_id IS NULL))
                            AND om.supplier_id = sm.supplier_id
                            AND om.created_at > sm.created_at
                        )
                    )
                    +
                    (
                        SELECT COUNT(DISTINCT dm.message_id)
                        FROM {$messages_table} dm
                        WHERE dm.thread_type = 'designer_operator'
                        AND dm.sender_role = 'designer'
                        AND dm.item_id = pp.item_id
                        AND dm.designer_id = pp.designer_user_id
                        AND NOT EXISTS (
                            SELECT 1 FROM {$messages_table} om2
                            WHERE om2.thread_type = 'designer_operator'
                            AND om2.sender_role = 'operator'
                            AND om2.item_id = dm.item_id
                            AND om2.designer_id = dm.designer_id
                            AND om2.created_at > dm.created_at
                        )
                    )
                ) > 0 THEN 1 ELSE 0 END as has_clarification,
                (
                    (
                        SELECT COUNT(DISTINCT sm.message_id)
                        FROM {$messages_table} sm
                        WHERE sm.thread_type = 'supplier_operator'
                        AND sm.sender_role = 'supplier'
                        AND sm.item_id = pp.item_id
                        AND (sm.bid_id = pp.bid_id OR (sm.bid_id IS NULL AND pp.bid_id IS NULL))
                        AND sm.supplier_id = pp.supplier_id
                        AND NOT EXISTS (
                            SELECT 1 FROM {$messages_table} om
                            WHERE om.thread_type = 'supplier_operator'
                            AND om.sender_role = 'operator'
                            AND om.item_id = sm.item_id
                            AND (om.bid_id = sm.bid_id OR (om.bid_id IS NULL AND sm.bid_id IS NULL))
                            AND om.supplier_id = sm.supplier_id
                            AND om.created_at > sm.created_at
                        )
                    )
                    +
                    (
                        SELECT COUNT(DISTINCT dm.message_id)
                        FROM {$messages_table} dm
                        WHERE dm.thread_type = 'designer_operator'
                        AND dm.sender_role = 'designer'
                        AND dm.item_id = pp.item_id
                        AND dm.designer_id = pp.designer_user_id
                        AND NOT EXISTS (
                            SELECT 1 FROM {$messages_table} om2
                            WHERE om2.thread_type = 'designer_operator'
                            AND om2.sender_role = 'operator'
                            AND om2.item_id = dm.item_id
                            AND om2.designer_id = dm.designer_id
                            AND om2.created_at > dm.created_at
                        )
                    )
                ) as clarification_count,
                (
                    SELECT COUNT(DISTINCT sm.message_id)
                    FROM {$messages_table} sm
                    WHERE sm.thread_type = 'supplier_operator'
                    AND sm.sender_role = 'supplier'
                    AND sm.item_id = pp.item_id
                    AND (sm.bid_id = pp.bid_id OR (sm.bid_id IS NULL AND pp.bid_id IS NULL))
                    AND sm.supplier_id = pp.supplier_id
                    AND NOT EXISTS (
                        SELECT 1 FROM {$messages_table} om
                        WHERE om.thread_type = 'supplier_operator'
                        AND om.sender_role = 'operator'
                        AND om.item_id = sm.item_id
                        AND (om.bid_id = sm.bid_id OR (om.bid_id IS NULL AND sm.bid_id IS NULL))
                        AND om.supplier_id = sm.supplier_id
                        AND om.created_at > sm.created_at
                    )
                ) as supplier_unread_count,
                (
                    SELECT COUNT(DISTINCT dm.message_id)
                    FROM {$messages_table} dm
                    WHERE dm.thread_type = 'designer_operator'
                    AND dm.sender_role = 'designer'
                    AND dm.item_id = pp.item_id
                    AND dm.designer_id = pp.designer_user_id
                    AND NOT EXISTS (
                        SELECT 1 FROM {$messages_table} om2
                        WHERE om2.thread_type = 'designer_operator'
                        AND om2.sender_role = 'operator'
                        AND om2.item_id = dm.item_id
                        AND om2.designer_id = dm.designer_id
                        AND om2.created_at > dm.created_at
                    )
                ) as designer_unread_count,
                (
                    (
                        SELECT COUNT(DISTINCT sm.message_id)
                        FROM {$messages_table} sm
                        WHERE sm.thread_type = 'supplier_operator'
                        AND sm.sender_role = 'supplier'
                        AND sm.item_id = pp.item_id
                        AND (sm.bid_id = pp.bid_id OR (sm.bid_id IS NULL AND pp.bid_id IS NULL))
                        AND sm.supplier_id = pp.supplier_id
                        AND NOT EXISTS (
                            SELECT 1 FROM {$messages_table} om
                            WHERE om.thread_type = 'supplier_operator'
                            AND om.sender_role = 'operator'
                            AND om.item_id = sm.item_id
                            AND (om.bid_id = sm.bid_id OR (om.bid_id IS NULL AND sm.bid_id IS NULL))
                            AND om.supplier_id = sm.supplier_id
                            AND om.created_at > sm.created_at
                        )
                    )
                    +
                    (
                        SELECT COUNT(DISTINCT dm.message_id)
                        FROM {$messages_table} dm
                        WHERE dm.thread_type = 'designer_operator'
                        AND dm.sender_role = 'designer'
                        AND dm.item_id = pp.item_id
                        AND dm.designer_id = pp.designer_user_id
                        AND NOT EXISTS (
                            SELECT 1 FROM {$messages_table} om2
                            WHERE om2.thread_type = 'designer_operator'
                            AND om2.sender_role = 'operator'
                            AND om2.item_id = dm.item_id
                            AND om2.designer_id = dm.designer_id
                            AND om2.created_at > dm.created_at
                        )
                    )
                ) as unread_messages
            FROM {$prototype_payments_table} pp
            LEFT JOIN {$items_table} i ON pp.item_id = i.id
            LEFT JOIN {$item_bids_table} b ON pp.bid_id = b.bid_id
            LEFT JOIN {$users_table} designer ON pp.designer_user_id = designer.ID
            LEFT JOIN {$users_table} supplier ON pp.supplier_id = supplier.ID
            LEFT JOIN {$categories_table} c ON i.item_type = c.category_id OR i.item_type = c.name
            {$where_clause}
        ";
        
        // Part 2: Items with supplier clarification messages (even without prototype payment)
        // Get items with unread supplier messages that don't have prototype payments
        $clarification_where = array();
        $clarification_where[] = "m.thread_type = 'supplier_operator'";
        $clarification_where[] = "m.sender_role = 'supplier'";
        $clarification_where[] = "i.id IS NOT NULL AND (i.deleted_at IS NULL OR i.deleted_at = '')";
        $clarification_where[] = "EXISTS (SELECT 1 FROM {$board_items_table} bi WHERE bi.item_id = m.item_id AND (bi.removed_at IS NULL OR bi.removed_at = ''))";
        
        // Apply filters to clarification query
        if ( $supplier_filter !== 'all' ) {
            $clarification_where[] = $wpdb->prepare( "m.supplier_id = %d", intval( $supplier_filter ) );
        }
        if ( $designer_filter !== 'all' ) {
            $clarification_where[] = $wpdb->prepare( "i.owner_user_id = %d", intval( $designer_filter ) );
        }
        if ( $category_filter !== 'all' ) {
            $clarification_where[] = $wpdb->prepare( "i.item_type = %s", $category_filter );
        }
        if ( ! empty( $search_filter ) ) {
            $clarification_where[] = $wpdb->prepare(
                "(m.item_id = %d OR m.bid_id = %d)",
                intval( $search_filter ),
                intval( $search_filter )
            );
        }
        
        // Only show items that don't already have prototype payments (to avoid duplicates)
        $clarification_where_clause = 'WHERE ' . implode( ' AND ', $clarification_where );
        
        $clarification_query = "
            SELECT 
                NULL as payment_id,
                m.item_id,
                m.bid_id,
                m.supplier_id,
                i.owner_user_id as designer_user_id,
                'clarification_needed' as status,
                NULL as video_direction_json,
                NULL as cad_fee_usd,
                NULL as cad_revision_rounds_included,
                NULL as cad_revision_round_fee_usd,
                NULL as cad_revision_rounds_used,
                NULL as cad_status,
                NULL as cad_approved_version,
                NULL as cad_released_to_supplier_at,
                NULL as prototype_video_cost_estimate_usd,
                NULL as total_due_usd,
                MAX(m.created_at) as created_at,
                NULL as payment_reference,
                i.title as item_title,
                i.primary_image_id,
                i.item_type,
                c.name as category_name,
                b.unit_price as bid_unit_price,
                b.prototype_cost as bid_prototype_cost,
                designer.display_name as designer_name,
                designer.user_login as designer_login,
                supplier.display_name as supplier_name,
                supplier.user_login as supplier_login,
                CASE 
                    WHEN unread_count.unread_messages > 0 THEN 1 
                    ELSE 0 
                END as has_clarification,
                COALESCE(unread_count.unread_messages, 0) as clarification_count,
                COALESCE(unread_count.unread_messages, 0) as supplier_unread_count,
                0 as designer_unread_count,
                COALESCE(unread_count.unread_messages, 0) as unread_messages
            FROM {$messages_table} m
            LEFT JOIN {$items_table} i ON m.item_id = i.id
            LEFT JOIN {$item_bids_table} b ON m.bid_id = b.bid_id AND m.item_id = b.item_id
            LEFT JOIN {$users_table} designer ON i.owner_user_id = designer.ID
            LEFT JOIN {$users_table} supplier ON m.supplier_id = supplier.ID
            LEFT JOIN {$categories_table} c ON i.item_type = c.category_id OR i.item_type = c.name
            LEFT JOIN {$prototype_payments_table} pp_check ON m.item_id = pp_check.item_id AND m.bid_id = pp_check.bid_id
            LEFT JOIN (
                SELECT 
                    m2.item_id,
                    COALESCE(m2.bid_id, 0) as bid_id,
                    m2.supplier_id,
                    COUNT(DISTINCT CASE 
                        WHEN m2.sender_role = 'supplier' AND (
                            -- Check if there's no operator reply after this supplier message
                            NOT EXISTS (
                                SELECT 1 FROM {$messages_table} m3 
                                WHERE m3.item_id = m2.item_id 
                                AND (m3.bid_id = m2.bid_id OR (m3.bid_id IS NULL AND m2.bid_id IS NULL))
                                AND m3.supplier_id = m2.supplier_id
                                AND m3.thread_type = 'supplier_operator'
                                AND m3.sender_role = 'operator'
                                AND m3.created_at > m2.created_at
                            )
                        ) THEN m2.message_id
                    END) as unread_messages
                FROM {$messages_table} m2
                WHERE m2.thread_type = 'supplier_operator'
                GROUP BY m2.item_id, COALESCE(m2.bid_id, 0), m2.supplier_id
            ) as unread_count ON m.item_id = unread_count.item_id 
                AND COALESCE(m.bid_id, 0) = unread_count.bid_id
                AND m.supplier_id = unread_count.supplier_id
            {$clarification_where_clause}
            AND pp_check.id IS NULL
            AND COALESCE(unread_count.unread_messages, 0) > 0
            GROUP BY m.item_id, COALESCE(m.bid_id, 0), m.supplier_id, i.owner_user_id, i.title, i.primary_image_id, i.item_type, c.name, b.unit_price, b.prototype_cost, designer.display_name, designer.user_login, supplier.display_name, supplier.user_login, unread_count.unread_messages
        ";

        // Part 3: Items with designer â†’ operator messages (even without prototype payment)
        $designer_where = array();
        $designer_where[] = "m.thread_type = 'designer_operator'";
        $designer_where[] = "m.sender_role = 'designer'";
        $designer_where[] = "i.id IS NOT NULL AND (i.deleted_at IS NULL OR i.deleted_at = '')";
        $designer_where[] = "EXISTS (SELECT 1 FROM {$board_items_table} bi WHERE bi.item_id = m.item_id AND (bi.removed_at IS NULL OR bi.removed_at = ''))";

        // If supplier filter is active, designer-only threads have no supplier context â†’ exclude
        if ( $supplier_filter !== 'all' ) {
            $designer_where[] = "1=0";
        }
        if ( $designer_filter !== 'all' ) {
            $designer_where[] = $wpdb->prepare( "m.designer_id = %d", intval( $designer_filter ) );
        }
        if ( $category_filter !== 'all' ) {
            $designer_where[] = $wpdb->prepare( "i.item_type = %s", $category_filter );
        }
        if ( ! empty( $search_filter ) ) {
            $designer_where[] = $wpdb->prepare( "m.item_id = %d", intval( $search_filter ) );
        }

        $designer_where_clause = 'WHERE ' . implode( ' AND ', $designer_where );

        $designer_query = "
            SELECT
                NULL as payment_id,
                m.item_id,
                m.bid_id,
                NULL as supplier_id,
                m.designer_id as designer_user_id,
                'clarification_needed' as status,
                NULL as video_direction_json,
                NULL as cad_fee_usd,
                NULL as cad_revision_rounds_included,
                NULL as cad_revision_round_fee_usd,
                NULL as cad_revision_rounds_used,
                NULL as cad_status,
                NULL as cad_approved_version,
                NULL as cad_released_to_supplier_at,
                NULL as prototype_video_cost_estimate_usd,
                NULL as total_due_usd,
                MAX(m.created_at) as created_at,
                NULL as payment_reference,
                i.title as item_title,
                i.primary_image_id,
                i.item_type,
                c.name as category_name,
                NULL as bid_unit_price,
                NULL as bid_prototype_cost,
                designer.display_name as designer_name,
                designer.user_login as designer_login,
                NULL as supplier_name,
                NULL as supplier_login,
                CASE
                    WHEN unread_d.unread_messages > 0 THEN 1
                    ELSE 0
                END as has_clarification,
                COALESCE(unread_d.unread_messages, 0) as clarification_count,
                0 as supplier_unread_count,
                COALESCE(unread_d.unread_messages, 0) as designer_unread_count,
                COALESCE(unread_d.unread_messages, 0) as unread_messages
            FROM {$messages_table} m
            LEFT JOIN {$items_table} i ON m.item_id = i.id
            LEFT JOIN {$users_table} designer ON m.designer_id = designer.ID
            LEFT JOIN {$categories_table} c ON i.item_type = c.category_id OR i.item_type = c.name
            LEFT JOIN {$prototype_payments_table} pp_check ON m.item_id = pp_check.item_id
            LEFT JOIN (
                SELECT
                    m2.item_id,
                    m2.designer_id,
                    COUNT(DISTINCT CASE
                        WHEN m2.sender_role = 'designer' AND (
                            NOT EXISTS (
                                SELECT 1 FROM {$messages_table} m3
                                WHERE m3.item_id = m2.item_id
                                AND m3.thread_type = 'designer_operator'
                                AND m3.sender_role = 'operator'
                                AND m3.designer_id = m2.designer_id
                                AND m3.created_at > m2.created_at
                            )
                        ) THEN m2.message_id
                    END) as unread_messages
                FROM {$messages_table} m2
                WHERE m2.thread_type = 'designer_operator'
                GROUP BY m2.item_id, m2.designer_id
            ) as unread_d ON m.item_id = unread_d.item_id AND m.designer_id = unread_d.designer_id
            {$designer_where_clause}
            AND pp_check.id IS NULL
            AND COALESCE(unread_d.unread_messages, 0) > 0
            GROUP BY m.item_id, m.designer_id, i.title, i.primary_image_id, i.item_type, c.name, designer.display_name, designer.user_login, unread_d.unread_messages
        ";
        
        // Combine both queries with UNION
        $union_query = "({$prototype_query}) UNION ({$clarification_query}) UNION ({$designer_query})";
        
        // Apply needs_attention filter after UNION if needed
        $combined_where = array();
        if ( $apply_needs_attention_filter ) {
            // Show only items that need attention (requested payments OR clarifications)
            $combined_where[] = "(status = 'requested' OR status = 'clarification_needed' OR has_clarification = 1)";
        }
        $combined_where_clause = ! empty( $combined_where ) ? 'WHERE ' . implode( ' AND ', $combined_where ) : '';
        
        $combined_query = "SELECT * FROM ({$union_query}) as combined_results {$combined_where_clause} ORDER BY created_at DESC";
        
        // Count total records for pagination
        $total_count_query = "
            SELECT COUNT(*) FROM (
                {$union_query}
            ) as combined_results
            {$combined_where_clause}
        ";
        $total_count = $wpdb->get_var( $total_count_query );
        $total_pages = ceil( $total_count / $per_page );
        
        // Apply pagination
        $query = $combined_query . " LIMIT {$per_page} OFFSET {$offset}";
        
        $requests = $wpdb->get_results( $query, ARRAY_A );

        // Get unique suppliers for filter dropdown (from prototype payments + clarifications)
        $suppliers_query = "
            SELECT DISTINCT supplier_id, display_name, user_login FROM (
                SELECT DISTINCT pp.supplier_id, u.display_name, u.user_login
                FROM {$prototype_payments_table} pp
                LEFT JOIN {$users_table} u ON pp.supplier_id = u.ID
                WHERE pp.status IN ('requested', 'marked_received')
                AND u.ID IS NOT NULL
                UNION
                SELECT DISTINCT m.supplier_id, u.display_name, u.user_login
                FROM {$messages_table} m
                LEFT JOIN {$users_table} u ON m.supplier_id = u.ID
                WHERE m.thread_type = 'supplier_operator' AND m.sender_role = 'supplier'
                AND u.ID IS NOT NULL
            ) as combined_suppliers
            ORDER BY display_name ASC
        ";
        $unique_suppliers = $wpdb->get_results( $suppliers_query, ARRAY_A );

        // Get unique designers for filter dropdown (from prototype payments + messages)
        $designers_query = "
            SELECT DISTINCT designer_user_id, display_name, user_login FROM (
                SELECT DISTINCT pp.designer_user_id, u.display_name, u.user_login
                FROM {$prototype_payments_table} pp
                LEFT JOIN {$users_table} u ON pp.designer_user_id = u.ID
                WHERE pp.status IN ('requested', 'marked_received')
                AND u.ID IS NOT NULL
                UNION
                SELECT DISTINCT i.owner_user_id as designer_user_id, u.display_name, u.user_login
                FROM {$messages_table} m
                LEFT JOIN {$items_table} i ON m.item_id = i.id
                LEFT JOIN {$users_table} u ON i.owner_user_id = u.ID
                WHERE m.thread_type = 'supplier_operator' AND m.sender_role = 'supplier'
                AND u.ID IS NOT NULL
                UNION
                SELECT DISTINCT m.designer_id as designer_user_id, u.display_name, u.user_login
                FROM {$messages_table} m
                LEFT JOIN {$users_table} u ON m.designer_id = u.ID
                WHERE m.thread_type = 'designer_operator' AND m.sender_role = 'designer'
                AND u.ID IS NOT NULL
            ) as combined_designers
            ORDER BY display_name ASC
        ";
        $unique_designers = $wpdb->get_results( $designers_query, ARRAY_A );

        // Get unique categories for filter dropdown (from items in prototype payments + messages)
        $categories_query = "
            SELECT DISTINCT item_type, category_name FROM (
                SELECT DISTINCT i.item_type, COALESCE(c.name, i.item_type) as category_name
                FROM {$prototype_payments_table} pp
                LEFT JOIN {$items_table} i ON pp.item_id = i.id
                LEFT JOIN {$categories_table} c ON i.item_type = c.category_id OR i.item_type = c.name
                WHERE pp.status IN ('requested', 'marked_received')
                AND i.item_type IS NOT NULL
                UNION
                SELECT DISTINCT i.item_type, COALESCE(c.name, i.item_type) as category_name
                FROM {$messages_table} m
                LEFT JOIN {$items_table} i ON m.item_id = i.id
                LEFT JOIN {$categories_table} c ON i.item_type = c.category_id OR i.item_type = c.name
                WHERE m.thread_type = 'supplier_operator' AND m.sender_role = 'supplier'
                AND i.item_type IS NOT NULL
                UNION
                SELECT DISTINCT i.item_type, COALESCE(c.name, i.item_type) as category_name
                FROM {$messages_table} m
                LEFT JOIN {$items_table} i ON m.item_id = i.id
                LEFT JOIN {$categories_table} c ON i.item_type = c.category_id OR i.item_type = c.name
                WHERE m.thread_type = 'designer_operator' AND m.sender_role = 'designer'
                AND i.item_type IS NOT NULL
            ) as combined_categories
            ORDER BY category_name ASC
        ";
        $unique_categories = $wpdb->get_results( $categories_query, ARRAY_A );

        ob_start();
        ?>
        <div class="n88-operator-queue" style="background-color: #000; color: #fff; font-family: 'Courier New', Courier, monospace; min-height: 100vh; padding: 20px;">
            <!-- Header Section -->
            <div style="border: 2px dashed #fff; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 style="margin: 0; font-size: 18px; font-weight: normal; color: #fff; font-family: 'Courier New', Courier, monospace;">WIRE FRAME OS â€” OPERATOR CONSOLE</h1>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 14px; color: #fff;">System Operator (Operational)</span>
                        <span style="font-size: 12px; color: #999;">Purpose: Monitor execution states, confirm payments, unblock suppliers</span>
                        <a href="<?php echo esc_url( wp_logout_url( home_url( '/login/' ) ) ); ?>" style="padding: 4px 8px; border: 1px solid #fff; color: #fff; text-decoration: none; font-size: 12px; font-family: 'Courier New', Courier, monospace;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='transparent';">[ Logout ]</a>
                    </div>
                </div>
            </div>

            <!-- Filter Bar Section -->
            <div style="border: 2px dashed #fff; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #fff; font-family: 'Courier New', Courier, monospace;">FILTER BAR</div>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Status:</label>
                        <select id="n88-operator-status-filter" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;">
                            <option value="prototype_requested" <?php selected( $status_filter, 'prototype_requested' ); ?>>Prototype Requested</option>
                            <option value="payment_requested" <?php selected( $status_filter, 'payment_requested' ); ?>>Payment Requested</option>
                            <option value="payment_received" <?php selected( $status_filter, 'payment_received' ); ?>>Payment Received</option>
                            <option value="in_production" <?php selected( $status_filter, 'in_production' ); ?>>In Production (future)</option>
                            <option value="all" <?php selected( $status_filter, 'all' ); ?>>All</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Supplier:</label>
                        <select id="n88-operator-supplier-filter" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;">
                            <option value="all" <?php selected( $supplier_filter, 'all' ); ?>>[ All ]</option>
                            <?php foreach ( $unique_suppliers as $sup ) : ?>
                                <option value="<?php echo esc_attr( $sup['supplier_id'] ); ?>" <?php selected( $supplier_filter, $sup['supplier_id'] ); ?>>
                                    <?php echo esc_html( $sup['display_name'] ?: $sup['user_login'] ?: 'Supplier #' . $sup['supplier_id'] ); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Category:</label>
                        <select id="n88-operator-category-filter" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;">
                            <option value="all" <?php selected( $category_filter, 'all' ); ?>>[ All ]</option>
                            <?php foreach ( $unique_categories as $cat ) : ?>
                                <?php if ( ! empty( $cat['item_type'] ) ) : ?>
                                    <option value="<?php echo esc_attr( $cat['item_type'] ); ?>" <?php selected( $category_filter, $cat['item_type'] ); ?>>
                                        <?php echo esc_html( $cat['item_type'] ); ?>
                                    </option>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Time:</label>
                        <select id="n88-operator-time-filter" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;">
                            <option value="all" <?php selected( $time_filter, 'all' ); ?>>All</option>
                            <option value="24h" <?php selected( $time_filter, '24h' ); ?>>24h</option>
                            <option value="7d" <?php selected( $time_filter, '7d' ); ?>>7d</option>
                            <option value="30d" <?php selected( $time_filter, '30d' ); ?>>30d</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Needs Attention:</label>
                        <select id="n88-operator-needs-attention-filter" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;">
                            <option value="all" <?php selected( $needs_attention_filter, 'all' ); ?>>All</option>
                            <option value="yes" <?php selected( $needs_attention_filter, 'yes' ); ?>>Yes (Clarifications + Payment Requested)</option>
                            <option value="no" <?php selected( $needs_attention_filter, 'no' ); ?>>No (Payment Received)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-size: 12px; color: #fff; margin-right: 5px;">Search:</label>
                        <input type="text" id="n88-operator-search-filter" value="<?php echo esc_attr( $search_filter ); ?>" placeholder="item id / bid id / payment id" style="padding: 4px 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; width: 100%; max-width: 300px;">
                    </div>
                </div>
            </div>

            <!-- Operator Queue - Item Case Files Section -->
            <div style="border: 2px dashed #fff; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #fff; font-family: 'Courier New', Courier, monospace;">OPERATOR QUEUE â€” ITEM CASE FILES</div>
                <div style="font-size: 11px; color: #ccc; margin-bottom: 10px;">One row = one item (source of truth)</div>

                <!-- Items Table -->
                <div style="border: 2px solid #fff; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-family: 'Courier New', Courier, monospace;">
                        <thead>
                            <tr style="border-bottom: 2px solid #fff; background-color: #1a1a1a;">
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff; border-right: 1px solid #fff;">ITEM / PROJECT</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff; border-right: 1px solid #fff;">DESIGNER</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff; border-right: 1px solid #fff;">SUPPLIER</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff; border-right: 1px solid #fff;">STATUS</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #fff;">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if ( empty( $requests ) ) : ?>
                                <tr>
                                    <td colspan="5" style="padding: 20px; text-align: center; color: #999; font-size: 12px;">No requests found matching the selected filters.</td>
                                </tr>
                            <?php else :
                                    $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
                                    $resolutions_table_exists = ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) === $resolutions_table );
                                ?>
                                <?php foreach ( $requests as $request ) : 
                                    $item_id = intval( $request['item_id'] );
                                    $bid_id = intval( $request['bid_id'] );
                                    $payment_id = intval( $request['payment_id'] );

                                    // Commit 2.3.9.2A: Fetch CAD workflow fields (always fetch from DB for accuracy)
                                    // Initialize with query values first
                                    $cad_status = isset( $request['cad_status'] ) ? $request['cad_status'] : null;
                                    $cad_approved_version = isset( $request['cad_approved_version'] ) && $request['cad_approved_version'] !== null ? intval( $request['cad_approved_version'] ) : null;
                                    $cad_released_to_supplier_at = isset( $request['cad_released_to_supplier_at'] ) ? $request['cad_released_to_supplier_at'] : null;
                                    
                                    // Always fetch from database to ensure we have latest values (especially after designer approval)
                                    if ( $payment_id ) {
                                        if ( ! isset( $n88_pp_columns_for_cad ) ) {
                                            $n88_pp_columns_for_cad = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
                                            $n88_pp_has_cad_status = in_array( 'cad_status', $n88_pp_columns_for_cad, true );
                                            $n88_pp_has_cad_approved_version = in_array( 'cad_approved_version', $n88_pp_columns_for_cad, true );
                                            $n88_pp_has_cad_released_to_supplier_at = in_array( 'cad_released_to_supplier_at', $n88_pp_columns_for_cad, true );
                                        }

                                        $select_fields = "id";
                                        $select_fields .= $n88_pp_has_cad_status ? ", cad_status" : ", NULL as cad_status";
                                        $select_fields .= $n88_pp_has_cad_approved_version ? ", cad_approved_version" : ", NULL as cad_approved_version";
                                        $select_fields .= $n88_pp_has_cad_released_to_supplier_at ? ", cad_released_to_supplier_at" : ", NULL as cad_released_to_supplier_at";

                                        $cad_row = $wpdb->get_row( $wpdb->prepare(
                                            "SELECT {$select_fields} FROM {$prototype_payments_table} WHERE id = %d LIMIT 1",
                                            $payment_id
                                        ), ARRAY_A );
                                        if ( $cad_row ) {
                                            // Always use database values (they are the source of truth)
                                            // Force override - always use DB value even if it's empty string
                                            if ( isset( $cad_row['cad_status'] ) ) {
                                                $cad_status = $cad_row['cad_status'];
                                            }
                                            if ( isset( $cad_row['cad_approved_version'] ) && $cad_row['cad_approved_version'] !== null ) {
                                                $cad_approved_version = intval( $cad_row['cad_approved_version'] );
                                            }
                                            if ( isset( $cad_row['cad_released_to_supplier_at'] ) ) {
                                                $cad_released_to_supplier_at = ( $cad_row['cad_released_to_supplier_at'] !== null && $cad_row['cad_released_to_supplier_at'] !== '' ) ? $cad_row['cad_released_to_supplier_at'] : null;
                                            } else {
                                                $cad_released_to_supplier_at = null;
                                            }
                                        }
                                    }
                                    
                                    // Get item thumbnail
                                    $thumbnail_url = '';
                                    if ( ! empty( $request['primary_image_id'] ) ) {
                                        $thumbnail_url = wp_get_attachment_image_url( $request['primary_image_id'], 'thumbnail' );
                                        if ( ! $thumbnail_url ) {
                                            $thumbnail_url = wp_get_attachment_url( $request['primary_image_id'] );
                                        }
                                    }
                                    
                                    $item_label = ! empty( $request['item_title'] ) ? esc_html( $request['item_title'] ) : 'Item #' . $item_id;
                                    $category = ! empty( $request['category_name'] ) ? esc_html( $request['category_name'] ) : ( ! empty( $request['item_type'] ) ? esc_html( $request['item_type'] ) : 'Uncategorized' );
                                    
                                    // Parse video direction JSON
                                    $video_direction = array();
                                    $keyword_count = 0;
                                    $has_note = false;
                                    $selected_keywords = array();
                                    if ( ! empty( $request['video_direction_json'] ) ) {
                                        $video_direction = json_decode( $request['video_direction_json'], true );
                                        if ( is_array( $video_direction ) && isset( $video_direction['selected_keywords'] ) ) {
                                            $selected_keywords = $video_direction['selected_keywords'];
                                            $keyword_count = count( $selected_keywords );
                                        }
                                        if ( is_array( $video_direction ) && isset( $video_direction['note'] ) && ! empty( $video_direction['note'] ) ) {
                                            $has_note = true;
                                        }
                                    }
                                    
                                    // Format costs for display
                                    $prototype_estimate_display = $request['prototype_video_cost_estimate_usd'] ? '$' . number_format( floatval( $request['prototype_video_cost_estimate_usd'] ), 2 ) : 'â€”';
                                    $cad_fee_display = '$' . number_format( floatval( $request['cad_fee_usd'] ), 2 );
                                    $total_due_display = '$' . number_format( floatval( $request['total_due_usd'] ), 2 );
                                    
                                    // Commit 2.3.8 / 2.3.9.1D: Calculate designer-facing (landed) bid prices for operator view
                                    $bid_unit_price_landed_display      = null;
                                    $bid_prototype_cost_landed_display  = null;
                                    
                                    // Use same margin + duty logic as designer item detail
                                    if ( isset( $request['bid_unit_price'] ) && $request['bid_unit_price'] !== null && $request['bid_unit_price'] !== '' ) {
                                        $unit_price_raw      = floatval( $request['bid_unit_price'] );
                                        $prototype_cost_raw  = isset( $request['bid_prototype_cost'] ) && $request['bid_prototype_cost'] !== null && $request['bid_prototype_cost'] !== ''
                                            ? floatval( $request['bid_prototype_cost'] )
                                            : null;
                                        
                                        $origin_region      = null;
                                        $duty_rate_override = null;
                                        
                                        if ( ! empty( $request['supplier_id'] ) ) {
                                            $supplier_profile = $wpdb->get_row(
                                                $wpdb->prepare(
                                                    "SELECT origin_region, duty_rate_override FROM {$supplier_profiles_table} WHERE supplier_id = %d",
                                                    intval( $request['supplier_id'] )
                                                ),
                                                ARRAY_A
                                            );
                                            
                                            if ( $supplier_profile ) {
                                                $origin_region      = isset( $supplier_profile['origin_region'] ) ? $supplier_profile['origin_region'] : null;
                                                $duty_rate_override = isset( $supplier_profile['duty_rate_override'] ) ? $supplier_profile['duty_rate_override'] : null;
                                            }
                                        }
                                        
                                        // Duty + margin calculation shared with designer view
                                        $duty_rate = N88_RFQ_Helpers::n88_calculate_duty_rate( $origin_region, $duty_rate_override );
                                        
                                        $unit_price_landed = N88_RFQ_Helpers::n88_calculate_landed_cost( $unit_price_raw, $duty_rate );
                                        if ( $unit_price_landed ) {
                                            $bid_unit_price_landed_display = $unit_price_landed['display_price'];
                                        } else {
                                            $bid_unit_price_landed_display = N88_RFQ_Helpers::n88_price_display_from_raw( $unit_price_raw );
                                        }
                                        
                                        if ( $prototype_cost_raw !== null ) {
                                            $prototype_cost_landed = N88_RFQ_Helpers::n88_calculate_landed_cost( $prototype_cost_raw, $duty_rate );
                                            if ( $prototype_cost_landed ) {
                                                $bid_prototype_cost_landed_display = $prototype_cost_landed['display_price'];
                                            } else {
                                                $bid_prototype_cost_landed_display = N88_RFQ_Helpers::n88_price_display_from_raw( $prototype_cost_raw );
                                            }
                                        }
                                    }
                                    // Operator display: use landed prototype and total = CAD + landed (matches designer; fixes legacy wrong total_due_usd)
                                    $prototype_estimate_display = ( $bid_prototype_cost_landed_display !== null )
                                        ? ( '$' . number_format( $bid_prototype_cost_landed_display, 2 ) )
                                        : ( $request['prototype_video_cost_estimate_usd'] ? '$' . number_format( floatval( $request['prototype_video_cost_estimate_usd'] ), 2 ) : 'â€”' );
                                    $total_due_for_display = floatval( $request['cad_fee_usd'] ) + ( $bid_prototype_cost_landed_display !== null ? $bid_prototype_cost_landed_display : ( $request['prototype_video_cost_estimate_usd'] ? floatval( $request['prototype_video_cost_estimate_usd'] ) : 0 ) );
                                    $total_due_display = '$' . number_format( $total_due_for_display, 2 );
                                    
                                    // Format dates
                                    $created_date = ! empty( $request['created_at'] ) ? date( 'M d, Y g:i A', strtotime( $request['created_at'] ) ) : 'â€”';
                                    
                                    // Map status to user-friendly display (per wireframe)
                                    $status_display = 'Payment Requested';
                                    $has_clarification = ! empty( $request['has_clarification'] );
                                    $clarification_count = ! empty( $request['clarification_count'] ) ? intval( $request['clarification_count'] ) : 0;
                                    $unread_messages = ! empty( $request['unread_messages'] ) ? intval( $request['unread_messages'] ) : 0;
                                    $supplier_unread_count = isset( $request['supplier_unread_count'] ) ? intval( $request['supplier_unread_count'] ) : 0;
                                    $designer_unread_count = isset( $request['designer_unread_count'] ) ? intval( $request['designer_unread_count'] ) : 0;
                                    $cad_status_val = isset( $request['cad_status'] ) ? (string) $request['cad_status'] : '';
                                    $is_cad_released = ! empty( $request['cad_released_to_supplier_at'] ) && trim( (string) $request['cad_released_to_supplier_at'] ) !== '';
                                    // When designer has approved CAD: designer "unread" needs no operator response â€” do NOT show "1 clarification message"
                                    $effective_designer_unread = ( $cad_status_val === 'approved' ) ? 0 : $designer_unread_count;
                                    $effective_unread = $unread_messages - $designer_unread_count + $effective_designer_unread;
                                    // Pending release: designer approved CAD but operator has not yet sent to supplier â€” Action Required
                                    $pending_release_to_supplier = ( $cad_status_val === 'approved' && ! $is_cad_released );
                                    
                                    // Fix #26 (operator half): Action Required only for real pending states:
                                    // - unread message (supplier/designer; excludes designer when CAD approved â€” no "1 clarification message")
                                    // - payment proof (designer uploaded receipt; operator must verify and mark received)
                                    // - pending CAD approval (payment received, CAD uploaded/revision â€” operator may follow up until designer approves)
                                    // - pending release to supplier (designer approved CAD; operator must send to supplier â€” hide only after operator sends)
                                    $payment_proof_pending = false;
                                    if ( $payment_id && ( $request['status'] === 'requested' ) ) {
                                        $receipts_tbl = $wpdb->prefix . 'n88_prototype_payment_receipts';
                                        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$receipts_tbl}'" ) === $receipts_tbl ) {
                                            $payment_proof_pending = (bool) $wpdb->get_var( $wpdb->prepare(
                                                "SELECT 1 FROM {$receipts_tbl} WHERE payment_id = %d LIMIT 1",
                                                $payment_id
                                            ) );
                                        }
                                    }
                                    $pending_cad_approval = ( $payment_id && isset( $request['status'] ) && $request['status'] === 'marked_received' && in_array( (string) $cad_status, array( 'uploaded', 'revision_requested' ), true ) );
                                    $show_action_required = ( $effective_unread > 0 ) || $payment_proof_pending || $pending_cad_approval || $pending_release_to_supplier;
                                    // Fix #13/#26: If operator marked this case resolved, clear only the unread-based Action Required (not payment proof, pending CAD, or pending release)
                                    if ( $show_action_required && $resolutions_table_exists ) {
                                        $bid_val = $bid_id ? $bid_id : 0;
                                        $resolved = $wpdb->get_var( $wpdb->prepare(
                                            "SELECT 1 FROM {$resolutions_table} WHERE item_id = %d AND ( bid_id IS NULL OR ( bid_id = %d AND %d > 0 ) ) LIMIT 1",
                                            $item_id, $bid_val, $bid_val
                                        ) );
                                        if ( $resolved && ( $effective_unread > 0 ) ) {
                                            $show_action_required = $payment_proof_pending || $pending_cad_approval || $pending_release_to_supplier;
                                        }
                                    }

                                    if ( ( $request['status'] === 'clarification_needed' || $has_clarification ) && $effective_unread > 0 ) {
                                        $status_display = 'Clarification Needed';
                                    } elseif ( $request['status'] === 'requested' ) {
                                        $status_display = 'Payment Requested';
                                    } elseif ( $request['status'] === 'marked_received' ) {
                                        $status_display = $is_cad_released ? 'CAD released' : 'Payment Received';
                                    }
                                    
                                    // Supplier label (per wireframe: "Supplier #482")
                                    $supplier_label = 'Supplier #' . $request['supplier_id'];
                                    if ( ! empty( $request['supplier_name'] ) ) {
                                        $supplier_label = esc_html( $request['supplier_name'] );
                                    } elseif ( ! empty( $request['supplier_login'] ) ) {
                                        $supplier_label = esc_html( $request['supplier_login'] );
                                    }
                                    
                                    // Designer label (per wireframe: "Sarah M.")
                                    $designer_label = ! empty( $request['designer_name'] ) ? esc_html( $request['designer_name'] ) : 'Designer #' . $request['designer_user_id'];
                                    // Extract first name + last initial if possible
                                    if ( ! empty( $request['designer_name'] ) ) {
                                        $name_parts = explode( ' ', $request['designer_name'] );
                                        if ( count( $name_parts ) > 1 ) {
                                            $designer_label = $name_parts[0] . ' ' . substr( $name_parts[count( $name_parts ) - 1], 0, 1 ) . '.';
                                        }
                                    }
                                    // Auto-open Message Threads when designer submitted CAD revision or designer message (prototype rows only; they have the section)
                                    $auto_open_threads = ( $payment_id && ( $designer_unread_count > 0 || $cad_status_val === 'revision_requested' ) ) ? '1' : '0';
                                ?>
                                    <tr style="border-bottom: 1px solid #333;" class="n88-operator-queue-row" data-payment-id="<?php echo esc_attr( $payment_id ?: '0' ); ?>" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-bid-id="<?php echo esc_attr( $bid_id ?: '0' ); ?>" data-has-clarification="<?php echo ( $effective_unread > 0 ) ? '1' : '0'; ?>" data-auto-open-threads="<?php echo esc_attr( $auto_open_threads ); ?>">
                                        <td style="padding: 12px; font-size: 12px; color: #fff; border-right: 1px solid #333;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <?php if ( $thumbnail_url ) : ?>
                                                    <img src="<?php echo esc_url( $thumbnail_url ); ?>" alt="" style="width: 40px; height: 40px; object-fit: cover; border: 1px solid #fff;">
                                                <?php endif; ?>
                                                <div>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <div style="font-weight: 600; color: #ff8800;">Item: <?php echo esc_html( $item_label ); ?></div>
                                                        <?php if ( $show_action_required ) : ?>
                                                            <span style="padding: 2px 6px; background-color: #ff0000; color: #fff; font-size: 10px; font-weight: 600; border-radius: 3px;">Action Required</span>
                                                        <?php endif; ?>
                                                    </div>
                                                    <div style="font-size: 11px; color: #999;">Project: â€”</div>
                                                    <div style="font-size: 11px; color: #999;">Category: <?php echo esc_html( $category ); ?></div>
                                                    <?php
                                                    // Show action hint when: (a) messages needing reply, (b) designer approved CAD but operator has not sent to supplier, or (c) operator has released CAD to supplier
                                                    if ( $effective_unread > 0 || $pending_release_to_supplier || $is_cad_released ) :
                                                    ?>
                                                        <div style="font-size: 11px; color: #00ff00; margin-top: 4px;">
                                                            <?php
                                                            $action_lines = array();
                                                            if ( $is_cad_released ) {
                                                                $action_lines[] = 'CAD released';
                                                            }
                                                            if ( $pending_release_to_supplier ) {
                                                                $action_lines[] = 'Release CAD to supplier';
                                                            }
                                                            if ( $effective_designer_unread > 0 ) {
                                                                if ( $cad_status_val === 'revision_requested' ) {
                                                                    $action_lines[] = 'Designer submitted CAD revision' . ( $effective_designer_unread > 1 ? ' (+ message)' : '' );
                                                                } else {
                                                                    $action_lines[] = $effective_designer_unread . ' Designer message' . ( $effective_designer_unread > 1 ? 's' : '' );
                                                                }
                                                            }
                                                            if ( $supplier_unread_count > 0 ) {
                                                                $action_lines[] = $supplier_unread_count . ' clarification message' . ( $supplier_unread_count > 1 ? 's' : '' );
                                                            }
                                                            // Fallback for UNION rows where only clarification_count/unread_messages exist
                                                            if ( empty( $action_lines ) && $effective_unread > 0 && $clarification_count > 0 ) {
                                                                $action_lines[] = $clarification_count . ' unread';
                                                            }
                                                            if ( ! empty( $action_lines ) ) {
                                                                echo esc_html( implode( ' | ', $action_lines ) );
                                                            }
                                                            ?>
                                                        </div>
                                                    <?php endif; ?>
                                                </div>
                                            </div>
                                        </td>
                                        <td style="padding: 12px; font-size: 12px; color: #fff; border-right: 1px solid #333;">
                                            <div><?php echo esc_html( $designer_label ); ?></div>
                                            <div style="font-size: 11px; color: #999;">Firm: â€”</div>
                                        </td>
                                        <td style="padding: 12px; font-size: 12px; color: #fff; border-right: 1px solid #333;">
                                            <div style="color: #ff8800; font-weight: 600;"><?php echo esc_html( $supplier_label ); ?></div>
                                            <div style="font-size: 11px; color: #999;">(Anonymous)</div>
                                            <?php if ( $bid_unit_price_landed_display !== null ) : ?>
                                                <div style="font-size: 11px; color: #ff8800;">
                                                    Bid: $<?php echo number_format( $bid_unit_price_landed_display, 2 ); ?>/unit
                                                </div>
                                            <?php endif; ?>
                                            <?php if ( $bid_prototype_cost_landed_display !== null ) : ?>
                                                <div style="font-size: 11px; color: #ff8800;">
                                                    Prototype: $<?php echo number_format( $bid_prototype_cost_landed_display, 2 ); ?>
                                                </div>
                                            <?php endif; ?>
                                        </td>
                                        <td style="padding: 12px; font-size: 12px; color: #fff; border-right: 1px solid #333;">
                                            <div><?php echo esc_html( $status_display ); ?></div>
                                            <?php if ( $effective_unread > 0 ) : ?>
                                                <div style="font-size: 11px; color: #00ff00;"><?php echo ( $effective_designer_unread > 0 && $cad_status_val === 'revision_requested' ) ? 'Designer CAD revision' : ( ( $effective_designer_unread > 0 ) ? 'Designer message' : 'Clarification Request' ); ?></div>
                                                <?php if ( $show_action_required ) : ?>
                                                    <div style="font-size: 10px; color: #ff0000; margin-top: 2px;"><?php echo esc_html( $effective_unread ); ?> unread</div>
                                                <?php endif; ?>
                                            <?php else : ?>
                                                <div style="font-size: 11px; color: #999;"><?php echo $request['status'] === 'marked_received' ? 'Received' : 'Requested'; ?></div>
                                            <?php endif; ?>
                                        </td>
                                        <td style="padding: 12px; font-size: 12px; color: #fff;">
                                            <button class="n88-view-case-btn" data-payment-id="<?php echo esc_attr( $payment_id ?: '0' ); ?>" data-item-id="<?php echo esc_attr( $item_id ); ?>" style="padding: 6px 12px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='#000';">
                                                ...
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Expanded Details Row (hidden by default) -->
                                    <tr class="n88-case-details-row" data-payment-id="<?php echo esc_attr( $payment_id ?: '0' ); ?>" data-item-id="<?php echo esc_attr( $item_id ); ?>" style="display: none; border-bottom: 2px solid #fff;">
                                        <td colspan="5" style="padding: 20px; background-color: #1a1a1a; border-top: 1px solid #333;">
                                            <?php if ( $has_clarification && ! $payment_id ) : ?>
                                                <!-- Clarification-Only Item Details -->
                                                <div style="margin-bottom: 16px;">
                                                    <div style="font-size: 13px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">âš ï¸ <?php echo ( $designer_unread_count > 0 ) ? 'Designer message' : 'Clarification Request'; ?></div>
                                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #fff; line-height: 1.8;">
                                                        <li>Item: <?php echo esc_html( $item_label ); ?> (ID: <?php echo esc_html( $item_id ); ?>)</li>
                                                        <?php if ( $bid_id ) : ?>
                                                            <li>Bid: #<?php echo esc_html( $bid_id ); ?></li>
                                                        <?php endif; ?>
                                                        <li>Supplier: <?php echo esc_html( $supplier_label ); ?></li>
                                                        <li>Designer: <?php echo esc_html( $designer_label ); ?></li>
                                                        <li>Messages: <?php echo ( $designer_unread_count > 0 ) ? ( esc_html( $designer_unread_count ) . ' Designer message' . ( $designer_unread_count > 1 ? 's' : '' ) ) : ( esc_html( $clarification_count ) . ' clarification message' . ( $clarification_count > 1 ? 's' : '' ) ); ?></li>
                                                        <li>Requested: <span style="color: #ff8800;"><?php echo esc_html( $created_date ); ?></span></li>
                                                    </ul>
                                                </div>
                                                <div style="margin-bottom: 16px;">
                                                    <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 8px;">ACTIONS â–¼</div>
                                                    <div style="padding-left: 20px;">
                                                        <button class="n88-message-threads-btn" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-bid-id="<?php echo esc_attr( $bid_id ?: '0' ); ?>" data-payment-id="0" style="display: block; padding: 8px 12px; margin-bottom: 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; text-align: left; width: 100%; max-width: 300px;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='#000';">
                                                            Message Threads
                                                        </button>
                                                        <button class="n88-mark-resolved-btn" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-bid-id="<?php echo esc_attr( $bid_id ?: '0' ); ?>" style="display: block; padding: 8px 12px; margin-bottom: 8px; background-color: #003300; color: #00ff00; border: 1px solid #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; text-align: left; width: 100%; max-width: 300px; font-weight: 600;" onmouseover="this.style.backgroundColor='#005500';" onmouseout="this.style.backgroundColor='#003300';">
                                                        Mark Clarification Resolved
                                                        </button>
                                                    </div>
                                                </div>
                                            <?php else : ?>
                                                <!-- Prototype Payment Item Details -->
                                                <div style="margin-bottom: 16px;">
                                                    <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 12px;">Prototype Request</div>
                                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #fff; line-height: 1.8;">
                                                        <li>Video Direction: <?php echo esc_html( $keyword_count ); ?> keywords selected</li>
                                                        <li>Note: <?php echo $has_note ? 'Present (âœ”)' : 'No'; ?></li>
                                                        <li>Requested: <span style="color: #ff8800;"><?php echo esc_html( $created_date ); ?></span></li>
                                                    </ul>
                                                </div>
                                                <div style="margin-bottom: 16px;">
                                                    <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 8px;">Costs (Read-Only)</div>
                                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #fff; line-height: 1.8;">
                                                        <li>Prototype Estimate: <?php echo esc_html( $prototype_estimate_display ); ?></li>
                                                        <li>CAD Fee: <?php echo esc_html( $cad_fee_display ); ?></li>
                                                        <li>Total Due: <span style="color: #ff8800; font-weight: 600;"><?php echo esc_html( $total_due_display ); ?></span></li>
                                                    </ul>
                                                </div>
                                                <div style="margin-bottom: 16px;">
                                                    <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 8px;">CAD Revision Policy (Read-Only)</div>
                                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #fff; line-height: 1.8;">
                                                        <li>Rounds Included: <?php echo esc_html( $request['cad_revision_rounds_included'] ); ?></li>
                                                        <li>Extra Round Fee: $<?php echo number_format( floatval( $request['cad_revision_round_fee_usd'] ), 2 ); ?> (round 4+)</li>
                                                        <li>Rounds Used: <?php echo esc_html( $request['cad_revision_rounds_used'] ); ?></li>
                                                    </ul>
                                                </div>
                                                <div style="margin-bottom: 16px;">
                                                    <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 8px;">Direction Summary Badge</div>
                                                    <div style="padding-left: 20px; font-size: 12px; color: #fff;">
                                                        <div>Direction: <?php echo esc_html( $keyword_count ); ?> keywords</div>
                                                        <div>Note: <?php echo $has_note ? 'Yes' : 'No'; ?></div>
                                                    </div>
                                                </div>
                                                <div style="margin-bottom: 16px;">
                                                    <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 8px;">ACTIONS â–¼</div>
                                                    <div style="padding-left: 20px;">
                                                        <button class="n88-view-case-full-btn" data-payment-id="<?php echo esc_attr( $payment_id ); ?>" style="display: block; padding: 8px 12px; margin-bottom: 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; text-align: left; width: 100%; max-width: 300px;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='#000';">
                                                            View Case (Read-Only)
                                                        </button>
                                                        <button class="n88-message-threads-btn" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-bid-id="<?php echo esc_attr( $bid_id ); ?>" data-payment-id="<?php echo esc_attr( $payment_id ); ?>" style="display: block; padding: 8px 12px; margin-bottom: 8px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; text-align: left; width: 100%; max-width: 300px;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='#000';">
                                                            Message Threads
                                                        </button>
                                                        <button class="n88-mark-resolved-btn" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-bid-id="<?php echo esc_attr( $bid_id ?: '0' ); ?>" style="display: block; padding: 8px 12px; margin-bottom: 8px; background-color: #003300; color: #00ff00; border: 1px solid #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; text-align: left; width: 100%; max-width: 300px; font-weight: 600;" onmouseover="this.style.backgroundColor='#005500';" onmouseout="this.style.backgroundColor='#003300';">
                                                        Mark Clarification Resolved                                                        </button>
                                                        <?php if ( $request['status'] === 'requested' ) : ?>
                                                            <button class="n88-mark-payment-received-btn" data-payment-id="<?php echo esc_attr( $payment_id ); ?>" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-bid-id="<?php echo esc_attr( $bid_id ); ?>" data-total-due="<?php echo esc_attr( $total_due_for_display ); ?>" style="display: block; padding: 8px 12px; margin-bottom: 8px; background-color: #003300; color: #00ff00; border: 1px solid #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; text-align: left; width: 100%; max-width: 300px; font-weight: 600;" onmouseover="this.style.backgroundColor='#005500';" onmouseout="this.style.backgroundColor='#003300';">
                                                            View Payment Receipt
                                                            </button>
                                                        <?php else : ?>
                                                            <div style="font-size: 11px; color: #00ff00; padding-left: 0; margin-bottom: 4px; font-weight: 600;">âœ“ Payment Confirmed</div>
                                                        <?php endif; ?>
                                                        <?php
                                                            // Commit 2.3.9.2A: Release Approved CAD to Supplier (Operator-only)
                                                            // Button shows when: payment is marked_received, CAD is approved, and not yet released
                                                            
                                                            // Normalize CAD status (handle string/null cases)
                                                            $cad_status_normalized = ( $cad_status === 'approved' || $cad_status === 'approved' ) ? 'approved' : '';
                                                            $is_released = ! empty( $cad_released_to_supplier_at ) && trim( $cad_released_to_supplier_at ) !== '';
                                                            
                                                            // Button visibility check
                                                            $show_release_cad_btn = ( ! empty( $payment_id ) && 
                                                                                     $request['status'] === 'marked_received' && 
                                                                                     $cad_status_normalized === 'approved' && 
                                                                                     ! $is_released );
                                                            
                                                        ?>
                                                        <?php if ( $show_release_cad_btn ) : ?>
                                                            <button class="n88-release-cad-btn"
                                                                data-payment-id="<?php echo esc_attr( $payment_id ); ?>"
                                                                data-item-id="<?php echo esc_attr( $item_id ); ?>"
                                                                data-bid-id="<?php echo esc_attr( $bid_id ); ?>"
                                                                data-supplier-id="<?php echo esc_attr( $request['supplier_id'] ); ?>"
                                                                data-approved-version="<?php echo esc_attr( $cad_approved_version ? $cad_approved_version : 0 ); ?>"
                                                                style="display: block; padding: 8px 12px; margin-bottom: 8px; background-color: #000033; color: #66aaff; border: 1px solid #66aaff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; text-align: left; width: 100%; max-width: 300px; font-weight: 600;"
                                                                onmouseover="this.style.backgroundColor='#000055';"
                                                                onmouseout="this.style.backgroundColor='#000033';"
                                                            >
                                                            Send Approved CAD to Supplier


                                                            </button>
                                                        <?php endif; ?>
                                                        <div style="font-size: 11px; color: #999; font-style: italic; padding-left: 0;">Send Notification (stub)</div>
                                                    </div>
                                                </div>
                                            <?php endif; ?>
                                            
                                            <!-- Message Threads Section (hidden by default) -->
                                            <div class="n88-message-threads-section" data-payment-id="<?php echo esc_attr( $payment_id ?: '0' ); ?>" data-item-id="<?php echo esc_attr( $item_id ); ?>" style="display: none; margin-top: 20px; padding: 16px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 4px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                                    <div style="font-size: 14px; font-weight: 600; color: #fff;">Message Threads</div>
                                                    <button class="n88-close-message-threads" data-payment-id="<?php echo esc_attr( $payment_id ?: '0' ); ?>" data-item-id="<?php echo esc_attr( $item_id ); ?>" style="background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                                                </div>
                                                
                                                <!-- Two Column Layout: Designer â‡„ Operator | Supplier â‡„ Operator -->
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                                    <!-- Designer â‡„ Operator Thread -->
                                                    <div style="border: 1px solid #333; border-radius: 4px; padding: 12px; background-color: #000; display: flex; flex-direction: column; height: 450px;">
                                                        <div style="font-size: 12px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">Designer â‡„ Operator</div>
                                                        <div id="n88-designer-thread-<?php echo esc_attr( $payment_id ); ?>" style="flex: 1; overflow-y: auto; padding: 16px; background-color: #0a0a0a; border-radius: 4px; margin-bottom: 12px; border: 1px solid #333; display: flex; flex-direction: column;">
                                                            <div style="text-align: center; color: #666; font-size: 11px; padding: 20px; margin: auto;">Loading messages...</div>
                                                        </div>
                                                        <?php 
                                                            // Commit 2.3.9.2A: Show CAD upload only when payment is marked_received AND CAD is not yet approved
                                                            $show_cad_upload = ( $payment_id && 
                                                                                $request['status'] === 'marked_received' && 
                                                                                $cad_status !== 'approved' );
                                                        ?>
                                                        <?php if ( $show_cad_upload ) : ?>
                                                            <!-- Commit 2.3.9.2A: CAD Upload (Operator-only) -->
                                                            <form class="n88-upload-cad-form" data-payment-id="<?php echo esc_attr( $payment_id ); ?>" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-bid-id="<?php echo esc_attr( $bid_id ); ?>" style="margin-bottom: 10px;">
                                                                <div class="n88-cad-dropzone" style="padding: 10px; border: 1px dashed #66aaff; border-radius: 6px; background: #05050a; color: #fff; font-size: 11px; text-align: center; margin-bottom: 8px; cursor: pointer;">
                                                                    Drag & drop CAD files here (PDF/JPG/PNG) or click to choose
                                                                </div>
                                                                <input type="file" name="cad_files[]" accept="application/pdf,image/jpeg,image/png" multiple style="display:none;" />
                                                                <button type="submit" style="width: 100%; padding: 8px 12px; background-color: #66aaff; color: #000; border: none; border-radius: 6px; font-family: 'Courier New', Courier, monospace; font-size: 11px; font-weight: 700; cursor: pointer;" onmouseover="this.style.backgroundColor='#4e94ff';" onmouseout="this.style.backgroundColor='#66aaff';">
                                                                    Upload CAD (New Version)
                                                                </button>
                                                            </form>
                                                        <?php elseif ( $payment_id && $request['status'] === 'marked_received' && $cad_status === 'approved' ) : ?>
                                                            <div style="font-size: 11px; color: #00ff00; padding: 8px; background-color: #003300; border: 1px solid #00ff00; border-radius: 4px; margin-bottom: 10px; text-align: center;">
                                                                âœ“ CAD Approved - No further uploads needed
                                                            </div>
                                                        <?php else : ?>
                                                            <div style="font-size: 10px; color: #666; margin-bottom: 10px;">CAD upload available after payment is marked received.</div>
                                                        <?php endif; ?>
                                                        <form class="n88-send-designer-message-form" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-payment-id="<?php echo esc_attr( $payment_id ); ?>" style="display: flex; gap: 8px; align-items: flex-end;">
                                                            <textarea name="message_text" required rows="2" placeholder="Type your message to designer..." style="flex: 1; padding: 10px 12px; background-color: #111; color: #fff; border: 1px solid #333; border-radius: 20px; font-family: 'Courier New', Courier, monospace; font-size: 11px; resize: none; min-height: 40px; max-height: 100px;"></textarea>
                                                            <button type="submit" style="padding: 10px 20px; background-color: #00ff00; color: #000; border: none; border-radius: 20px; font-family: 'Courier New', Courier, monospace; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap;" onmouseover="this.style.backgroundColor='#00cc00';" onmouseout="this.style.backgroundColor='#00ff00';">
                                                                Send
                                                            </button>
                                                        </form>
                                                    </div>
                                                    
                                                    <!-- Supplier â‡„ Operator Thread -->
                                                    <div style="border: 1px solid #333; border-radius: 4px; padding: 12px; background-color: #000; display: flex; flex-direction: column; height: 450px;">
                                                        <div style="font-size: 12px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">Supplier â‡„ Operator</div>
                                                        <div id="n88-supplier-thread-<?php echo esc_attr( $payment_id ); ?>" style="flex: 1; overflow-y: auto; padding: 16px; background-color: #0a0a0a; border-radius: 4px; margin-bottom: 12px; border: 1px solid #333; display: flex; flex-direction: column;">
                                                            <div style="text-align: center; color: #666; font-size: 11px; padding: 20px; margin: auto;">Loading messages...</div>
                                                        </div>
                                                        <form class="n88-send-supplier-message-form" data-item-id="<?php echo esc_attr( $item_id ); ?>" data-bid-id="<?php echo esc_attr( $bid_id ?: '0' ); ?>" data-payment-id="<?php echo esc_attr( $payment_id ?: '0' ); ?>" data-supplier-id="<?php echo esc_attr( $request['supplier_id'] ?: '0' ); ?>" style="display: flex; gap: 8px; align-items: flex-end;">
                                                            <textarea name="message_text" required rows="2" placeholder="Type your message to supplier..." style="flex: 1; padding: 10px 12px; background-color: #111; color: #fff; border: 1px solid #333; border-radius: 20px; font-family: 'Courier New', Courier, monospace; font-size: 11px; resize: none; min-height: 40px; max-height: 100px;"></textarea>
                                                            <button type="submit" style="padding: 10px 20px; background-color: #00ff00; color: #000; border: none; border-radius: 20px; font-family: 'Courier New', Courier, monospace; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap;" onmouseover="this.style.backgroundColor='#00cc00';" onmouseout="this.style.backgroundColor='#00ff00';">
                                                                Send
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <?php if ( $total_pages > 1 ) : ?>
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; padding: 15px; border-top: 1px solid #333;">
                        <div style="font-size: 12px; color: #fff;">
                            Showing <?php echo ( $offset + 1 ); ?>-<?php echo min( $offset + $per_page, $total_count ); ?> of <?php echo intval( $total_count ); ?> requests
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <?php if ( $page > 1 ) : ?>
                                <a href="<?php echo esc_url( add_query_arg( 'paged', $page - 1 ) ); ?>" style="padding: 6px 12px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; text-decoration: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='#000';">
                                    â† Previous
                                </a>
                            <?php endif; ?>
                            
                            <div style="font-size: 12px; color: #fff;">
                                Page <?php echo esc_html( $page ); ?> of <?php echo esc_html( $total_pages ); ?>
                            </div>
                            
                            <?php if ( $page < $total_pages ) : ?>
                                <a href="<?php echo esc_url( add_query_arg( 'paged', $page + 1 ) ); ?>" style="padding: 6px 12px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; text-decoration: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='#000';">
                                    Next â†’
                                </a>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endif; ?>
            </div>
        </div>

        <!-- Commit 2.3.9.1D: Payment Confirmation Modal -->
        <div id="n88-payment-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 10001; overflow-y: auto;">
            <div style="max-width: 500px; margin: 100px auto; padding: 20px; background-color: #000; border: 2px solid #00ff00; font-family: 'Courier New', Courier, monospace;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #00ff00; padding-bottom: 10px;">
                    <h2 style="margin: 0; font-size: 16px; font-weight: 600; color: #00ff00;">Confirm Payment Received</h2>
                    <button id="n88-close-payment-confirm-modal" style="background: none; border: none; color: #00ff00; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; line-height: 1;">Ã—</button>
                </div>
                <div style="color: #fff; font-size: 12px; margin-bottom: 20px;">
                    <div style="margin-bottom: 12px;">
                        <span style="color: #00ff00;">Item #</span><span id="n88-confirm-item-id" style="margin-left: 8px;"></span>
                        <span style="color: #00ff00; margin-left: 16px;">Bid #</span><span id="n88-confirm-bid-id" style="margin-left: 8px;"></span>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <span style="color: #00ff00;">Total Due:</span>
                        <span id="n88-confirm-total-due" style="margin-left: 8px; font-weight: 600; font-size: 14px;"></span>
                    </div>
                    <div style="padding: 12px; background-color: #1a1a1a; border: 1px solid #ff8800; border-radius: 4px; color: #ffaa00; font-size: 11px; line-height: 1.5;">
                        <strong>Warning:</strong> This confirms offline payment and unlocks the next CAD drafting step (future commit).
                    </div>
                    <div id="n88-payment-receipts-container" style="margin-top: 14px; padding: 10px; background-color: #0a1a0a; border: 1px solid #00ff00; border-radius: 4px; font-size: 12px; color: #ccc;">
                        <span style="color: #00ff00;">Payment receipts:</span> <span id="n88-receipts-list">â€”</span>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button id="n88-cancel-payment-confirm" style="padding: 8px 16px; background-color: #333; color: #fff; border: 1px solid #666; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;" onmouseover="this.style.backgroundColor='#444';" onmouseout="this.style.backgroundColor='#333';">
                        Cancel
                    </button>
                    <button id="n88-confirm-payment-received" style="padding: 8px 16px; background-color: #003300; color: #00ff00; border: 1px solid #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; font-weight: 600;" onmouseover="this.style.backgroundColor='#005500';" onmouseout="this.style.backgroundColor='#003300';">
                        Confirm Payment Received
                    </button>
                </div>
            </div>
        </div>

        <!-- Commit 2.3.9.2A: Release Approved CAD to Supplier Modal -->
        <div id="n88-release-cad-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 10002; overflow-y: auto;">
            <div style="max-width: 650px; margin: 80px auto; padding: 20px; background-color: #000; border: 2px solid #66aaff; font-family: 'Courier New', Courier, monospace;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid #66aaff; padding-bottom: 10px;">
                    <h2 style="margin: 0; font-size: 16px; font-weight: 600; color: #66aaff;">Release Approved CAD to Supplier</h2>
                    <button id="n88-close-release-cad-modal" style="background: none; border: none; color: #66aaff; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; line-height: 1;">Ã—</button>
                </div>
                <div style="color: #fff; font-size: 12px; margin-bottom: 14px;">
                    <div style="margin-bottom: 10px;">
                        <span style="color: #66aaff;">Item #</span><span id="n88-release-item-id" style="margin-left: 8px;"></span>
                        <span style="color: #66aaff; margin-left: 16px;">Bid #</span><span id="n88-release-bid-id" style="margin-left: 8px;"></span>
                        <span style="color: #66aaff; margin-left: 16px;">Supplier #</span><span id="n88-release-supplier-id" style="margin-left: 8px;"></span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <span style="color: #66aaff;">Approved Version:</span>
                        <span id="n88-release-approved-version" style="margin-left: 8px; font-weight: 700;"></span>
                    </div>
                    <div style="padding: 12px; background-color: #0a0a14; border: 1px solid #ff8800; border-radius: 4px; color: #ffaa00; font-size: 11px; line-height: 1.5;">
                        <strong>Warning:</strong> This will release approved drawings to supplier and trigger action required.
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 18px;">
                    <button id="n88-cancel-release-cad" style="padding: 8px 16px; background-color: #333; color: #fff; border: 1px solid #666; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;" onmouseover="this.style.backgroundColor='#444';" onmouseout="this.style.backgroundColor='#333';">
                        Cancel
                    </button>
                    <button id="n88-confirm-release-cad" style="padding: 8px 16px; background-color: #000033; color: #66aaff; border: 1px solid #66aaff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer; font-weight: 700;" onmouseover="this.style.backgroundColor='#000055';" onmouseout="this.style.backgroundColor='#000033';">
                        Confirm Release
                    </button>
                </div>
            </div>
        </div>

        <!-- View Case Modal (Read-Only) -->
        <div id="n88-operator-case-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 10000; overflow-y: auto;">
            <div style="max-width: 1200px; margin: 40px auto; padding: 20px; background-color: #000; border: 2px solid #fff; font-family: 'Courier New', Courier, monospace;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #fff; padding-bottom: 10px;">
                    <h2 style="margin: 0; font-size: 16px; font-weight: 600; color: #fff;">View Case (Read-Only)</h2>
                    <button id="n88-close-case-modal" style="padding: 8px 16px; background-color: #000; color: #fff; border: 1px solid #fff; font-family: 'Courier New', Courier, monospace; font-size: 12px; cursor: pointer;" onmouseover="this.style.backgroundColor='#333';" onmouseout="this.style.backgroundColor='#000';">
                        Close
                    </button>
                </div>
                <div id="n88-case-modal-content" style="color: #fff; font-size: 12px;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <script>
        var n88OperatorTimelineNonce = '<?php echo esc_js( wp_create_nonce( 'n88_get_item_rfq_state' ) ); ?>';
        var n88OperatorEvidenceNonce = '<?php echo esc_js( wp_create_nonce( 'n88_timeline_step_evidence' ) ); ?>';
        (function() {
            // Filter persistence and update
            function updateOperatorQueueURL() {
                var status = document.getElementById('n88-operator-status-filter')?.value || 'requested';
                var supplier = document.getElementById('n88-operator-supplier-filter')?.value || 'all';
                var designer = document.getElementById('n88-operator-designer-filter')?.value || 'all';
                var category = document.getElementById('n88-operator-category-filter')?.value || 'all';
                var time = document.getElementById('n88-operator-time-filter')?.value || 'all';
                var needsAttention = document.getElementById('n88-operator-needs-attention-filter')?.value || 'all';
                var search = document.getElementById('n88-operator-search-filter')?.value || '';

                var params = new URLSearchParams();
                if (status && status !== 'requested') params.set('status', status);
                if (supplier && supplier !== 'all') params.set('supplier', supplier);
                if (designer && designer !== 'all') params.set('designer', designer);
                if (category && category !== 'all') params.set('category', category);
                if (time && time !== 'all') params.set('time', time);
                if (needsAttention && needsAttention !== 'all') params.set('needs_attention', needsAttention);
                if (search) params.set('search', search);

                var newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                window.history.pushState({}, '', newUrl);
            }

            // Attach filter change handlers
            var statusFilter = document.getElementById('n88-operator-status-filter');
            var supplierFilter = document.getElementById('n88-operator-supplier-filter');
            var designerFilter = document.getElementById('n88-operator-designer-filter');
            var categoryFilter = document.getElementById('n88-operator-category-filter');
            var timeFilter = document.getElementById('n88-operator-time-filter');
            var needsAttentionFilter = document.getElementById('n88-operator-needs-attention-filter');
            var searchFilter = document.getElementById('n88-operator-search-filter');

            if (statusFilter) statusFilter.addEventListener('change', function() { updateOperatorQueueURL(); window.location.reload(); });
            if (supplierFilter) supplierFilter.addEventListener('change', function() { updateOperatorQueueURL(); window.location.reload(); });
            if (designerFilter) designerFilter.addEventListener('change', function() { updateOperatorQueueURL(); window.location.reload(); });
            if (categoryFilter) categoryFilter.addEventListener('change', function() { updateOperatorQueueURL(); window.location.reload(); });
            if (timeFilter) timeFilter.addEventListener('change', function() { updateOperatorQueueURL(); window.location.reload(); });
            if (needsAttentionFilter) needsAttentionFilter.addEventListener('change', function() { updateOperatorQueueURL(); window.location.reload(); });
            if (searchFilter) {
                var searchTimeout;
                searchFilter.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        updateOperatorQueueURL();
                        window.location.reload();
                    }, 500);
                });
            }

            // Row expansion toggle
            var viewCaseBtns = document.querySelectorAll('.n88-view-case-btn');
            viewCaseBtns.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var paymentId = this.getAttribute('data-payment-id');
                    var row = this.closest('.n88-operator-queue-row');
                    var itemId = row ? row.getAttribute('data-item-id') : null;
                    var bidId = row ? (row.getAttribute('data-bid-id') || '0') : '0';
                    // Try payment_id first, then item_id as fallback for clarification-only items
                    var detailsRow = document.querySelector('.n88-case-details-row[data-payment-id="' + paymentId + '"]') ||
                                    (itemId ? document.querySelector('.n88-case-details-row[data-item-id="' + itemId + '"]') : null);
                    if (detailsRow) {
                        if (detailsRow.style.display === 'none') {
                            detailsRow.style.display = 'table-row';
                            // Auto-open Message Threads when designer submitted CAD revision or designer message (Designerâ€“Operator thread)
                            if (row && row.getAttribute('data-auto-open-threads') === '1' && typeof loadMessageThreads === 'function') {
                                var threadsSection = detailsRow.querySelector('.n88-message-threads-section');
                                if (threadsSection && itemId) {
                                    threadsSection.style.display = 'block';
                                    loadMessageThreads(itemId, bidId, paymentId);
                                }
                            }
                        } else {
                            detailsRow.style.display = 'none';
                        }
                    }
                });
            });

            // View Case Full Modal
            var viewCaseFullBtns = document.querySelectorAll('.n88-view-case-full-btn');
            var caseModal = document.getElementById('n88-operator-case-modal');
            var caseModalContent = document.getElementById('n88-case-modal-content');
            var closeCaseModal = document.getElementById('n88-close-case-modal');

            viewCaseFullBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var paymentId = this.getAttribute('data-payment-id');
                    loadCaseDetails(paymentId);
                });
            });

            if (closeCaseModal) {
                closeCaseModal.addEventListener('click', function() {
                    if (caseModal) caseModal.style.display = 'none';
                });
            }

            // Fix #13/#26: Mark Resolved â€” delegated for expanded row and modal
            document.addEventListener('click', function(e) {
                var el = e.target && e.target.nodeType === 1 ? e.target : (e.target && e.target.parentElement) || null;
                var btn = el && el.closest ? el.closest('.n88-mark-resolved-btn') : null;
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                var itemId = btn.getAttribute('data-item-id');
                var bidId = btn.getAttribute('data-bid-id') || '0';
                if (!itemId) { alert('Missing item ID.'); return; }
                btn.disabled = true;
                var origText = btn.textContent;
                btn.textContent = 'Resolving...';
                var formData = new FormData();
                formData.append('action', 'n88_mark_clarification_resolved');
                formData.append('item_id', itemId);
                formData.append('bid_id', bidId);
                formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_mark_clarification_resolved' ) ); ?>');
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', { method: 'POST', body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.success) {
                            if (caseModal && caseModal.style) caseModal.style.display = 'none';
                            window.location.reload();
                        } else {
                            alert(data.data && data.data.message ? data.data.message : 'Failed to mark resolved.');
                            btn.disabled = false;
                            btn.textContent = origText;
                        }
                    })
                    .catch(function(err) {
                        console.error('Mark resolved error:', err);
                        alert('An error occurred. Please try again.');
                        btn.disabled = false;
                        btn.textContent = origText;
                    });
            });

            // Commit 2.3.9.1C-a: Message Threads Toggle
            var messageThreadsBtns = document.querySelectorAll('.n88-message-threads-btn');
            messageThreadsBtns.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var paymentId = this.getAttribute('data-payment-id');
                    var itemId = this.getAttribute('data-item-id');
                    var bidId = this.getAttribute('data-bid-id');
                    // Try payment_id first, then item_id as fallback for clarification-only items
                    var threadsSection = document.querySelector('.n88-message-threads-section[data-payment-id="' + paymentId + '"]') || 
                                        (itemId ? document.querySelector('.n88-message-threads-section[data-item-id="' + itemId + '"]') : null);
                    
                    if (threadsSection) {
                        if (threadsSection.style.display === 'none') {
                            threadsSection.style.display = 'block';
                            loadMessageThreads(itemId, bidId, paymentId);
                        } else {
                            threadsSection.style.display = 'none';
                        }
                    }
                });
            });
            
            // Close Message Threads
            var closeMessageThreadsBtns = document.querySelectorAll('.n88-close-message-threads');
            closeMessageThreadsBtns.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var paymentId = this.getAttribute('data-payment-id');
                    var itemId = this.getAttribute('data-item-id');
                    // Try payment_id first, then item_id as fallback for clarification-only items
                    var threadsSection = document.querySelector('.n88-message-threads-section[data-payment-id="' + paymentId + '"]') || 
                                        (itemId ? document.querySelector('.n88-message-threads-section[data-item-id="' + itemId + '"]') : null);
                    if (threadsSection) {
                        threadsSection.style.display = 'none';
                    }
                });
            });
            
            // Load Message Threads
            function loadMessageThreads(itemId, bidId, paymentId) {
                // Load Designer Thread
                loadThreadMessages(itemId, 'designer_operator', 'n88-designer-thread-' + paymentId);
                
                // Load Supplier Thread
                loadThreadMessages(itemId, 'supplier_operator', 'n88-supplier-thread-' + paymentId);
            }
            
            // Load Thread Messages
            function loadThreadMessages(itemId, threadType, containerId) {
                var container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; color: #666; font-size: 11px; padding: 20px;">Loading messages...</div>';
                
                var formData = new FormData();
                formData.append('action', 'n88_get_item_messages');
                formData.append('item_id', itemId);
                formData.append('thread_type', threadType);
                formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_get_item_messages' ) ); ?>');
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.data && data.data.messages) {
                        var opts = {};
                        if (threadType === 'supplier_operator' && data.data.supplier_confirmed_at) {
                            opts.supplier_confirmed_at = data.data.supplier_confirmed_at;
                        }
                        renderThreadMessages(data.data.messages, container, threadType, opts);
                    } else {
                        container.innerHTML = '<div style="text-align: center; color: #666; font-size: 11px; padding: 20px;">No messages yet.</div>';
                    }
                })
                .catch(function(error) {
                    console.error('Error loading thread messages:', error);
                    container.innerHTML = '<div style="text-align: center; color: #ff0000; font-size: 11px; padding: 20px;">Error loading messages.</div>';
                });
            }
            
            // Render Thread Messages - WhatsApp Style
            function renderThreadMessages(messages, container, threadType, opts) {
                opts = opts || {};
                if (!messages || messages.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; font-size: 11px; padding: 20px; margin: auto;">No messages yet.</div>';
                    return;
                }
                
                // Sort messages chronologically
                var sortedMessages = messages.slice().sort(function(a, b) {
                    return new Date(a.created_at) - new Date(b.created_at);
                });
                
                var html = '';
                sortedMessages.forEach(function(msg) {
                    var isOperator = msg.sender_role === 'operator';
                    var senderName = isOperator ? 'Operator' : (threadType === 'designer_operator' ? 'Designer' : 'Supplier');
                    // Show category for supplier messages only
                    var categoryDisplay = (!isOperator && threadType === 'supplier_operator' && msg.category) ? ' [' + msg.category + ']' : '';
                    
                    var date = new Date(msg.created_at);
                    var dateStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    var rawText = msg.message_text || '';
                    
                    // Commit 2.3.9.2A: Render CAD upload messages with clickable file cards
                    // Also render revision request messages and "Approved CAD Released" messages with files
                    var isCadUploadMessage = isOperator &&
                        rawText.indexOf('CAD v') !== -1 &&
                        rawText.indexOf('uploaded') !== -1 &&
                        rawText.indexOf('Files:') !== -1;
                    
                    var isRevisionRequestMessage = !isOperator &&
                        rawText.indexOf('Revision requested') !== -1 &&
                        rawText.indexOf('Files:') !== -1;
                    
                    // Detect "Approved CAD Released" message (operator to supplier)
                    var isCadReleasedMessage = isOperator &&
                        rawText.indexOf('Approved CAD Released') !== -1 &&
                        rawText.indexOf('CAD Files:') !== -1;
                    
                    var renderedText = rawText;
                    var cadFiles = [];
                    
                    if (isCadUploadMessage || isRevisionRequestMessage || isCadReleasedMessage) {
                        var lines = rawText.split('\n');
                        var filesStartIndex = -1;
                        // Look for "Files:" or "CAD Files:" depending on message type
                        var filesLabel = isCadReleasedMessage ? 'CAD Files:' : 'Files:';
                        for (var li = 0; li < lines.length; li++) {
                            if ((lines[li] || '').trim() === filesLabel || (lines[li] || '').trim() === 'Files:') {
                                filesStartIndex = li;
                                break;
                            }
                        }
                        if (filesStartIndex >= 0) {
                            renderedText = lines.slice(0, filesStartIndex).join('\n');
                            var fileLines = lines.slice(filesStartIndex + 1);
                            for (var fi = 0; fi < fileLines.length; fi++) {
                                var line = (fileLines[fi] || '').trim();
                                // Parse: "- filename.ext: https://..."
                                if (line.indexOf('- ') === 0) {
                                    var withoutDash = line.slice(2);
                                    var sepIdx = withoutDash.indexOf(': ');
                                    if (sepIdx > 0) {
                                        var fileName = withoutDash.slice(0, sepIdx).trim();
                                        var fileUrl = withoutDash.slice(sepIdx + 2).trim();
                                        if (fileUrl.indexOf('http://') === 0 || fileUrl.indexOf('https://') === 0) {
                                            var ext = '';
                                            if (fileName.indexOf('.') !== -1) {
                                                ext = fileName.split('.').pop().toLowerCase();
                                            }
                                            cadFiles.push({ name: fileName, url: fileUrl, ext: ext });
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    html += '<div style="margin-bottom: 12px; display: flex; justify-content: ' + (isOperator ? 'flex-end' : 'flex-start') + '; width: 100%;">';
                    html += '<div style="max-width: 75%; padding: 10px 14px; background-color: ' + (isOperator ? '#1a1a1a' : '#0a0a0a') + '; border: 1px solid ' + (isOperator ? '#00ff00' : '#333') + '; border-radius: ' + (isOperator ? '12px 12px 4px 12px' : '12px 12px 12px 4px') + '; font-size: 12px; color: #fff; word-wrap: break-word; white-space: pre-wrap;">';
                    html += '<div style="font-size: 10px; font-weight: 600; color: ' + (isOperator ? '#00ff00' : '#00aa00') + '; margin-bottom: 4px;">' + senderName + categoryDisplay + '</div>';
                    html += '<div style="font-size: 12px; line-height: 1.4; margin-bottom: 4px;">' + renderedText.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                    
                    // Commit 2.3.9.2A: Render CAD file cards (for CAD uploads, revision requests, and CAD released messages)
                    if ((isCadUploadMessage || isRevisionRequestMessage || isCadReleasedMessage) && cadFiles.length > 0) {
                        html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333; display: flex; flex-direction: column; gap: 8px;">';
                        cadFiles.forEach(function(file) {
                            var isPdf = file.ext === 'pdf';
                            var isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].indexOf(file.ext) !== -1;
                            var icon = isPdf ? 'ðŸ“„' : (isImage ? 'ðŸ–¼ï¸' : 'ðŸ“Ž');
                            
                            html += '<a href="' + file.url.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 4px; text-decoration: none; color: #fff; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'#222\'; this.style.borderColor=\'#00ff00\';" onmouseout="this.style.backgroundColor=\'#0a0a0a\'; this.style.borderColor=\'#333\';">';
                            html += '<div style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: #000; border-radius: 4px; flex-shrink: 0;"><span style="font-size: 20px;">' + icon + '</span></div>';
                            html += '<div style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 11px;">' + file.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                            html += '<div style="font-size: 10px; color: #00ff00; flex-shrink: 0;">Open â†’</div>';
                            html += '</a>';
                        });
                        html += '</div>';
                    }
                    
                    html += '<div style="font-size: 9px; color: #666; text-align: right;">' + dateStr + '</div>';
                    html += '</div>';
                    html += '</div>';
                });
                // Operator: after messages, one centered line "Supplier marked clarified"
                if (threadType === 'supplier_operator' && opts.supplier_confirmed_at) {
                    html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333; text-align: center; font-size: 11px; color: #888;">Supplier marked clarified</div>';
                }
                container.innerHTML = html;
                setTimeout(function() {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
            
            // Send Message to Designer
            var sendDesignerMessageForms = document.querySelectorAll('.n88-send-designer-message-form');
            sendDesignerMessageForms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var itemId = this.getAttribute('data-item-id');
                    var paymentId = this.getAttribute('data-payment-id');
                    var messageText = this.querySelector('textarea[name="message_text"]').value.trim();
                    
                    if (!messageText) {
                        alert('Please enter a message.');
                        return;
                    }
                    
                    var submitBtn = this.querySelector('button[type="submit"]');
                    var originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = '[ Sending... ]';
                    
                    var formData = new FormData();
                    formData.append('action', 'n88_send_item_message');
                    formData.append('item_id', itemId);
                    formData.append('thread_type', 'designer_operator');
                    formData.append('message_text', messageText);
                    formData.append('category', '');
                    formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_send_item_message' ) ); ?>');
                    
                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.success) {
                            this.querySelector('textarea[name="message_text"]').value = '';
                            loadThreadMessages(itemId, 'designer_operator', 'n88-designer-thread-' + paymentId);
                        } else {
                            alert('Error: ' + (data.data?.message || 'Failed to send message.'));
                        }
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }.bind(this))
                    .catch(function(error) {
                        console.error('Error sending message:', error);
                        alert('An error occurred. Please try again.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
                });
            });
            
            // Send Message to Supplier
            var sendSupplierMessageForms = document.querySelectorAll('.n88-send-supplier-message-form');
            sendSupplierMessageForms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var itemId = this.getAttribute('data-item-id');
                    var bidId = this.getAttribute('data-bid-id');
                    var paymentId = this.getAttribute('data-payment-id');
                    var supplierId = this.getAttribute('data-supplier-id');
                    var messageText = this.querySelector('textarea[name="message_text"]').value.trim();
                    
                    if (!messageText) {
                        alert('Please enter a message.');
                        return;
                    }
                    
                    // If supplier_id not in form, try to get it from the request data or bid
                    if (!supplierId || supplierId === '0' || supplierId === 'null') {
                        // Try to get supplier_id from the row data
                        var row = this.closest('.n88-operator-queue-row');
                        if (row) {
                            // Try to extract supplier_id from the row or query it from bid_id
                            // For now, we'll need to get it from the bid if available
                            if (bidId && bidId !== '0') {
                                // We'll need to fetch supplier_id from bid_id via AJAX or include it in the form
                                // For now, let's check if we can get it from the request data
                            }
                        }
                    }
                    
                    var submitBtn = this.querySelector('button[type="submit"]');
                    var originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = '[ Sending... ]';
                    
                    var formData = new FormData();
                    formData.append('action', 'n88_send_item_message');
                    formData.append('item_id', itemId);
                    formData.append('thread_type', 'supplier_operator');
                    formData.append('message_text', messageText);
                    formData.append('category', '');
                    if (bidId && bidId !== '0') formData.append('bid_id', bidId);
                    if (supplierId && supplierId !== '0' && supplierId !== 'null') formData.append('supplier_id', supplierId);
                    formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_send_item_message' ) ); ?>');
                    
                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.success) {
                            this.querySelector('textarea[name="message_text"]').value = '';
                            loadThreadMessages(itemId, 'supplier_operator', 'n88-supplier-thread-' + paymentId);
                        } else {
                            alert('Error: ' + (data.data?.message || 'Failed to send message.'));
                        }
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }.bind(this))
                    .catch(function(error) {
                        console.error('Error sending message:', error);
                        alert('An error occurred. Please try again.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
                });
            });

            // Commit 2.3.9.2A: CAD Upload (Operator-only) inside Designer â‡„ Operator thread
            var uploadCadForms = document.querySelectorAll('.n88-upload-cad-form');
            uploadCadForms.forEach(function(form) {
                var dropzone = form.querySelector('.n88-cad-dropzone');
                var fileInput = form.querySelector('input[type="file"]');
                var submitBtn = form.querySelector('button[type="submit"]');

                var resetDropzoneText = function() {
                    if (dropzone) dropzone.textContent = 'Drag & drop CAD files here (PDF/JPG/PNG) or click to choose';
                };

                if (dropzone && fileInput) {
                    resetDropzoneText();

                    dropzone.addEventListener('click', function() {
                        fileInput.click();
                    });

                    dropzone.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        dropzone.style.backgroundColor = '#0a0a20';
                    });

                    dropzone.addEventListener('dragleave', function() {
                        dropzone.style.backgroundColor = '#05050a';
                    });

                    dropzone.addEventListener('drop', function(e) {
                        e.preventDefault();
                        dropzone.style.backgroundColor = '#05050a';
                        if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
                            form._cadFiles = e.dataTransfer.files;
                            dropzone.textContent = e.dataTransfer.files.length + ' file(s) selected';
                        }
                    });

                    fileInput.addEventListener('change', function() {
                        if (fileInput.files && fileInput.files.length) {
                            form._cadFiles = fileInput.files;
                            dropzone.textContent = fileInput.files.length + ' file(s) selected';
                        } else {
                            resetDropzoneText();
                        }
                    });
                }

                form.addEventListener('submit', function(e) {
                    e.preventDefault();

                    var paymentId = form.getAttribute('data-payment-id');
                    var itemId = form.getAttribute('data-item-id');
                    var bidId = form.getAttribute('data-bid-id');
                    var files = form._cadFiles || (fileInput ? fileInput.files : null);

                    if (!files || !files.length) {
                        alert('Please select at least one CAD file (PDF/JPG/PNG).');
                        return;
                    }

                    var originalText = submitBtn ? submitBtn.textContent : '';
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Uploading...';
                    }

                    var formData = new FormData();
                    formData.append('action', 'n88_upload_cad_files');
                    formData.append('payment_id', paymentId);
                    formData.append('item_id', itemId);
                    formData.append('bid_id', bidId);
                    formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_upload_cad_files' ) ); ?>');

                    for (var i = 0; i < files.length; i++) {
                        formData.append('cad_files[]', files[i]);
                    }

                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.success) {
                            alert('CAD uploaded as v' + (data.data?.cad_version || '?') + ' (' + (data.data?.file_count || 0) + ' file(s))');
                            // Reset selection UI
                            form._cadFiles = null;
                            if (fileInput) fileInput.value = '';
                            resetDropzoneText();
                            // Reload designer thread messages
                            loadThreadMessages(itemId, 'designer_operator', 'n88-designer-thread-' + paymentId);
                        } else {
                            alert('Error: ' + (data.data?.message || 'Failed to upload CAD.'));
                        }
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    })
                    .catch(function(error) {
                        console.error('Error uploading CAD:', error);
                        alert('An error occurred. Please try again.');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    });
                });
            });
            
            // Load case details via AJAX
            function loadCaseDetails(paymentId) {
                if (!caseModalContent) return;

                caseModalContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">Loading case details...</div>';
                if (caseModal) caseModal.style.display = 'block';

                var formData = new FormData();
                formData.append('action', 'n88_get_operator_case_details');
                formData.append('payment_id', paymentId);
                formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_get_operator_case_details' ) ); ?>');

                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && caseModalContent) {
                        caseModalContent.innerHTML = data.data.html;
                        var opWrap = document.getElementById('n88-operator-workflow-timeline-wrap');
                        if (opWrap && opWrap.getAttribute('data-item-id') && typeof window.n88LoadOperatorWorkflowTimeline === 'function') {
                            window.n88LoadOperatorWorkflowTimeline();
                        }
                    } else {
                        if (caseModalContent) {
                            caseModalContent.innerHTML = '<div style="padding: 20px; color: #ff4444;">Error loading case details: ' + (data.data?.message || 'Unknown error') + '</div>';
                        }
                    }
                })
                .catch(function(error) {
                    console.error('Error loading case details:', error);
                    if (caseModalContent) {
                        caseModalContent.innerHTML = '<div style="padding: 20px; color: #ff4444;">Error loading case details. Please try again.</div>';
                    }
                });
            }

            window.n88LoadOperatorWorkflowTimeline = function() {
                var wrap = document.getElementById('n88-operator-workflow-timeline-wrap');
                var container = document.getElementById('n88-operator-workflow-timeline');
                if (!wrap || !container) return;
                if (wrap.getAttribute('data-timeline-loaded') === '1') return;
                var itemId = wrap.getAttribute('data-item-id');
                if (!itemId) return;
                var nonce = typeof n88OperatorTimelineNonce !== 'undefined' ? n88OperatorTimelineNonce : '';
                container.innerHTML = '<div style="padding: 12px; color: #888; font-size: 12px;">Loading timelineâ€¦</div>';
                var formData = new FormData();
                formData.append('action', 'n88_get_item_timeline');
                formData.append('item_id', itemId);
                formData.append('_ajax_nonce', nonce);
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', { method: 'POST', body: formData, credentials: 'same-origin' })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (!data.success || !data.data || !data.data.timeline) {
                            container.innerHTML = '<div style="padding: 12px; color: #cc6666; font-size: 12px;">' + (data.message || 'Failed to load timeline.') + '</div>';
                            return;
                        }
                        var t = data.data.timeline;
                        var steps = t.steps || [];
                        if (steps.length < 6) {
                            container.innerHTML = '<div style="padding: 12px; color: #888;">Timeline data incomplete.</div>';
                            wrap.setAttribute('data-timeline-loaded', '1');
                            return;
                        }
                        var green = '#00ff00';
                        var darkText = '#ccc';
                        var darkBorder = '#555';
                        var selectedIdx = 0;
                        var stepsWithSupplierEvidence = (data.data && data.data.steps_with_supplier_evidence) ? data.data.steps_with_supplier_evidence : {};
                        wrap._n88StepsWithSupplierEvidence = stepsWithSupplierEvidence;
                        function buildEvidenceBlockHtml() {
                            return '<div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid ' + darkBorder + ';"><div style="font-size: 12px; font-weight: 600; color: ' + green + '; margin-bottom: 8px;">Evidence</div>' +
                                '<div id="n88-operator-step-evidence-list" style="min-height: 24px; font-size: 11px; color: ' + darkText + '; margin-bottom: 12px;">Loadingâ€¦</div>' +
                                '<form id="n88-operator-add-evidence-form" enctype="multipart/form-data" style="font-size: 11px;"><div style="margin-bottom: 8px;"><label style="display:block; margin-bottom: 4px;">File (image/PDF)</label><input type="file" name="evidence_file" accept=".jpg,.jpeg,.png,.gif,.webp,.pdf" style="width:100%; max-width:280px; background:#111; color:#ccc; border:1px solid ' + darkBorder + ';"></div>' +
                                '<div style="margin-bottom: 8px;"><label style="display:block; margin-bottom: 4px;">Or YouTube URL</label><input type="url" name="youtube_url" placeholder="https://youtube.com/..." style="width:100%; max-width:280px; padding:4px; background:#111; color:#ccc; border:1px solid ' + darkBorder + ';"></div>' +
                                '<button type="submit" id="n88-operator-add-evidence-btn" style="padding: 6px 12px; background: ' + green + '; color: #000; border: none; font-weight: 600; cursor: pointer;">Add evidence</button></form></div>';
                        }
                        function buildSupplierEvidenceBlockHtml(stepId) {
                            if (!stepId) return '';
                            var hasSup = stepsWithSupplierEvidence[stepId] || stepsWithSupplierEvidence[String(stepId)];
                            if (!hasSup) return '';
                            return '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid ' + darkBorder + ';"><div style="font-size: 12px; font-weight: 600; color: ' + green + '; margin-bottom: 8px;">Supplier Evidence Received</div>' +
                                '<button type="button" class="n88-operator-view-supplier-evidence-btn" data-step-id="' + String(stepId).replace(/"/g, '&quot;') + '" style="padding: 6px 12px; font-size: 11px; background: #111; color: ' + green + '; border: 1px solid ' + green + '; border-radius: 4px; cursor: pointer; font-family: monospace;">[ View Step Evidence ]</button>' +
                                '<div id="n88-operator-supplier-evidence-content-' + String(stepId).replace(/"/g, '') + '" style="margin-top: 8px; min-height: 20px; font-size: 11px; color: ' + darkText + ';"></div></div>';
                        }
                        function updateOperatorStepDetail(idx) {
                            selectedIdx = idx;
                            wrap._n88OpSelectedIdx = idx;
                            var sel = steps[idx];
                            if (!sel) return;
                            var detEl = document.getElementById('n88-operator-timeline-detail');
                            if (detEl) {
                                var sl = sel.display_status === 'delayed' ? 'Delayed' : sel.display_status === 'in_progress' ? 'In Progress' : sel.display_status === 'completed' ? 'Completed' : 'Pending';
                                detEl.innerHTML = '<div style="font-size: 13px; font-weight: 600; color: #00ff00; margin-bottom: 12px;">' + (sel.step_number || (idx + 1)) + '. ' + (sel.label || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' +
                                    '<div style="font-size: 12px; color: #ccc;">Â· State: <span style="color: ' + (sel.display_status === 'delayed' ? '#ff6666' : sel.display_status === 'completed' ? '#00ff00' : '#ccc') + ';">' + sl + '</span></div>' +
                                    (sel.started_at ? '<div style="font-size: 11px; color: #ccc; margin-top: 4px;">Started: ' + sel.started_at + '</div>' : '') +
                                    (sel.completed_at ? '<div style="font-size: 11px; color: #ccc; margin-top: 2px;">Completed: ' + sel.completed_at + '</div>' : '') +
                                    (sel.expected_by ? '<div style="font-size: 11px; color: #ccc;">Expected by: ' + sel.expected_by + '</div>' : '') +
                                    buildEvidenceBlockHtml() +
                                    buildSupplierEvidenceBlockHtml(sel.step_id);
                            }
                            var btns = wrap.querySelectorAll('[data-n88-operator-step-btn]');
                            for (var j = 0; j < btns.length; j++) {
                                var b = btns[j];
                                var bidx = parseInt(b.getAttribute('data-idx'), 10);
                                var lbl = b.querySelector('.n88-operator-step-label');
                                if (lbl) lbl.style.color = bidx === idx ? green : darkText;
                            }
                            var itemId = wrap.getAttribute('data-item-id');
                            if (itemId && typeof window.n88LoadOperatorStepEvidence === 'function') window.n88LoadOperatorStepEvidence(itemId, sel.step_id);
                        }
                        var row = '<div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid ' + darkBorder + ';">';
                        for (var i = 0; i < steps.length; i++) {
                            var s = steps[i];
                            var isActive = s.display_status === 'in_progress' || s.display_status === 'delayed';
                            var isCompleted = s.display_status === 'completed';
                            var isSelected = selectedIdx === i;
                            row += '<div onclick="(function(idx){ var w=document.getElementById(\'n88-operator-workflow-timeline-wrap\'); if(w._n88OpUpdateDetail) w._n88OpUpdateDetail(idx); })(' + i + ');" data-n88-operator-step-btn data-idx="' + i + '" style="flex: 1; display: flex; flex-direction: column; align-items: center; min-width: 0; cursor: pointer; padding: 4px; border-radius: 4px; border: none;">';
                            row += '<div style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid ' + (isCompleted ? green : isActive ? green : darkBorder) + '; background: ' + (isCompleted ? green : isActive ? 'rgba(0,255,0,0.15)' : 'transparent') + '; color: ' + (isCompleted ? '#0a0a0a' : isActive ? green : darkText) + '; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; margin-bottom: 6px;">' + (s.step_number || (i + 1)) + '</div>';
                            row += '<div class="n88-operator-step-label" style="font-size: 10px; color: ' + (isSelected ? green : darkText) + '; text-align: center; line-height: 1.2;">' + (s.label || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                            if (s.is_delayed) row += '<span style="font-size: 9px; color: #ff6666; margin-top: 2px;">[ ! Delayed ]</span>';
                            row += '</div>';
                            if (i < steps.length - 1) {
                                row += '<div style="flex: 0 0 20px; align-self: center; height: 2px; background: ' + darkBorder + '; margin-bottom: 20px;" aria-hidden="true"></div>';
                            }
                        }
                        row += '</div>';
                        var sel = steps[0];
                        var statusLabel = sel.display_status === 'delayed' ? 'Delayed' : sel.display_status === 'in_progress' ? 'In Progress' : sel.display_status === 'completed' ? 'Completed' : 'Pending';
                        var detail = '<div id="n88-operator-timeline-detail" style="padding: 16px; border: 1px solid ' + darkBorder + '; border-radius: 4px; background: rgba(0,0,0,0.2); margin-bottom: 16px;">';
                        detail += '<div style="font-size: 13px; font-weight: 600; color: ' + green + '; margin-bottom: 12px;">' + (sel.step_number || 1) + '. ' + (sel.label || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                        detail += '<div style="font-size: 12px; color: ' + darkText + ';">Â· State: <span style="color: ' + (sel.display_status === 'delayed' ? '#ff6666' : sel.display_status === 'completed' ? green : darkText) + ';">' + statusLabel + '</span></div>';
                        if (sel.started_at) detail += '<div style="font-size: 11px; color: ' + darkText + '; margin-top: 4px;">Started: ' + sel.started_at + '</div>';
                        if (sel.completed_at) detail += '<div style="font-size: 11px; color: ' + darkText + '; margin-top: 2px;">Completed: ' + sel.completed_at + '</div>';
                        if (sel.expected_by) detail += '<div style="font-size: 11px; color: ' + darkText + ';">Expected by: ' + sel.expected_by + '</div>';
                        detail += buildEvidenceBlockHtml();
                        detail += buildSupplierEvidenceBlockHtml(sel.step_id);
                        detail += '</div>';
                        if (t.show_prototype_mini) {
                            detail += '<div style="margin-top: 12px; padding: 12px; border: 1px solid ' + darkBorder + '; border-radius: 4px; font-size: 11px; color: ' + darkText + ';">';
                            detail += '<div style="margin-bottom: 8px; color: ' + green + ';">Prototype Mini-Timeline (visual only)</div>';
                            detail += '<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">Requested â†’ Paid â†’ CAD Approved â†’ Prototype Submitted â†’ Approved</div></div>';
                        }
                        container.innerHTML = row + detail;
                        wrap._n88OpUpdateDetail = updateOperatorStepDetail;
                        wrap._n88StepsData = steps;
                        wrap._n88OpSelectedIdx = 0;
                        var ajaxUrl = '<?php echo esc_url( admin_url( "admin-ajax.php" ) ); ?>';
                        window.n88LoadOperatorStepEvidence = function(itId, stId) {
                            var listEl = document.getElementById('n88-operator-step-evidence-list');
                            if (!listEl) return;
                            listEl.innerHTML = 'Loadingâ€¦';
                            var fd = new FormData();
                            fd.append('action', 'n88_get_timeline_step_evidence');
                            fd.append('item_id', itId);
                            fd.append('step_id', stId);
                            fd.append('_ajax_nonce', typeof n88OperatorTimelineNonce !== 'undefined' ? n88OperatorTimelineNonce : '');
                            fetch(ajaxUrl, { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(data) {
                                if (!data.success || !data.data) { listEl.innerHTML = 'No evidence'; return; }
                                var arr = data.data.evidence || [];
                                var h = '';
                                var darkBorder = '#555';
                                var darkText = '#ccc';
                                for (var i = 0; i < arr.length; i++) {
                                    var e = arr[i];
                                    var url = e.view_url || e.original_url || '#';
                                    var mt = e.media_type || 'file';
                                    var ca = e.created_at || '';
                                    h += '<div style="margin-bottom:12px; padding:8px; border:1px solid ' + darkBorder + '; border-radius:4px; background:rgba(0,0,0,0.2);">';
                                    if (mt === 'youtube') h += '<div style="margin-bottom:4px;"><a href="' + url.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener" style="color:' + green + ';">YouTube</a> ' + ca + '</div>';
                                    else if (mt === 'image') h += '<div style="margin-bottom:4px;"><a href="' + url.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener" style="color:' + green + ';"><img src="' + url.replace(/"/g, '&quot;') + '" alt="" style="max-width:120px;max-height:80px;object-fit:contain;display:block;"></a> ' + ca + '</div>';
                                    else h += '<div style="margin-bottom:4px;"><a href="' + url.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener" style="color:' + green + ';">' + mt + '</a> ' + ca + '</div>';
                                    if (e.comments && e.comments.length) {
                                        h += '<div style="margin-top:8px; padding-top:8px; border-top:1px solid ' + darkBorder + '; font-size:10px; color:' + darkText + ';">Comments:</div>';
                                        for (var j = 0; j < e.comments.length; j++) {
                                            var c = e.comments[j];
                                            h += '<div style="font-size:11px; color:' + darkText + '; margin-top:4px; white-space:pre-wrap;">' + (c.comment_text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + (c.created_at ? '<div style="font-size:10px; opacity:0.8;">' + c.created_at + '</div>' : '') + '</div>';
                                        }
                                    }
                                    h += '</div>';
                                }
                                listEl.innerHTML = h || 'No evidence for this step.';
                            }).catch(function() { listEl.innerHTML = 'Error loading evidence.'; });
                        };
                        wrap.addEventListener('submit', function(ev) {
                            if (ev.target.id !== 'n88-operator-add-evidence-form') return;
                            ev.preventDefault();
                            var form = ev.target;
                            var btn = form.querySelector('#n88-operator-add-evidence-btn');
                            var itId = wrap.getAttribute('data-item-id');
                            var st = wrap._n88StepsData && wrap._n88StepsData[wrap._n88OpSelectedIdx];
                            if (!itId || !st) return;
                            var stepId = st.step_id;
                            var fd = new FormData();
                            fd.append('action', 'n88_upload_timeline_step_evidence');
                            fd.append('_ajax_nonce', typeof n88OperatorEvidenceNonce !== 'undefined' ? n88OperatorEvidenceNonce : '');
                            fd.append('item_id', itId);
                            fd.append('step_id', stepId);
                            var yUrl = (form.querySelector('input[name="youtube_url"]') || {}).value;
                            var fileInput = form.querySelector('input[name="evidence_file"]');
                            if (yUrl && yUrl.trim()) {
                                fd.append('media_type', 'youtube');
                                fd.append('youtube_url', yUrl.trim());
                            } else if (fileInput && fileInput.files && fileInput.files[0]) {
                                fd.append('evidence_file', fileInput.files[0]);
                                var fname = (fileInput.files[0].name || '').toLowerCase();
                                fd.append('media_type', fname.indexOf('.pdf') !== -1 ? 'pdf' : 'image');
                            } else {
                                alert('Please choose a file or enter a YouTube URL.');
                                return;
                            }
                            if (btn) { btn.textContent = 'Uploadingâ€¦'; btn.disabled = true; }
                            fetch(ajaxUrl, { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(data) {
                                var b = form.querySelector('#n88-operator-add-evidence-btn');
                                if (b) { b.textContent = 'Add evidence'; b.disabled = false; }
                                if (data.success) {
                                    if (fileInput) fileInput.value = '';
                                    var yIn = form.querySelector('input[name="youtube_url"]');
                                    if (yIn) yIn.value = '';
                                    if (typeof window.n88LoadOperatorStepEvidence === 'function') window.n88LoadOperatorStepEvidence(itId, stepId);
                                } else {
                                    alert(data.data && data.data.message ? data.data.message : 'Upload failed.');
                                }
                            }).catch(function() {
                                var b = form.querySelector('#n88-operator-add-evidence-btn');
                                if (b) { b.textContent = 'Add evidence'; b.disabled = false; }
                                alert('Upload failed.');
                            });
                        });
                        if (itemId && window.n88LoadOperatorStepEvidence) window.n88LoadOperatorStepEvidence(itemId, steps[0].step_id);
                        wrap.addEventListener('click', function(ev) {
                            if (!ev.target || !ev.target.classList || !ev.target.classList.contains('n88-operator-view-supplier-evidence-btn')) return;
                            var stepId = ev.target.getAttribute('data-step-id');
                            var itemIdClick = wrap.getAttribute('data-item-id');
                            var contentEl = document.getElementById('n88-operator-supplier-evidence-content-' + stepId);
                            if (!contentEl || !itemIdClick) return;
                            contentEl.innerHTML = 'Loadingâ€¦';
                            var fd = new FormData();
                            fd.append('action', 'n88_get_step_evidence');
                            fd.append('item_id', itemIdClick);
                            fd.append('step_id', stepId);
                            fd.append('_ajax_nonce', typeof n88OperatorTimelineNonce !== 'undefined' ? n88OperatorTimelineNonce : '');
                            fetch(ajaxUrl, { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(res) {
                                if (!contentEl) return;
                                if (!res.success || !res.data || !res.data.for_step) { contentEl.innerHTML = 'No data.'; return; }
                                var d = res.data.for_step;
                                var subs = d.submissions || [];
                                var h = '';
                                for (var si = 0; si < subs.length; si++) {
                                    var links = subs[si].links || [];
                                    for (var li = 0; li < links.length; li++) {
                                        var url = (links[li].url || '#').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                        var prov = (links[li].provider || 'Link').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                        h += '<div style="margin-bottom:4px;"><a href="' + url + '" target="_blank" rel="noopener" style="color:' + green + ';">' + prov + '</a></div>';
                                    }
                                }
                                contentEl.innerHTML = h || 'No links.';
                            }).catch(function() { if (contentEl) contentEl.innerHTML = 'Error loading.'; });
                        });
                        wrap.setAttribute('data-timeline-loaded', '1');
                    })
                    .catch(function(err) {
                        container.innerHTML = '<div style="padding: 12px; color: #cc6666; font-size: 12px;">Failed to load timeline.</div>';
                    });
            };

            // Commit 2.3.9.1D: Mark Payment Received with Confirmation Modal
            var paymentConfirmModal = document.getElementById('n88-payment-confirm-modal');
            var closePaymentConfirmModal = document.getElementById('n88-close-payment-confirm-modal');
            var cancelPaymentConfirm = document.getElementById('n88-cancel-payment-confirm');
            var confirmPaymentReceived = document.getElementById('n88-confirm-payment-received');
            var currentPaymentBtn = null;
            
            // Close modal handlers
            if (closePaymentConfirmModal) {
                closePaymentConfirmModal.addEventListener('click', function() {
                    if (paymentConfirmModal) paymentConfirmModal.style.display = 'none';
                });
            }
            
            if (cancelPaymentConfirm) {
                cancelPaymentConfirm.addEventListener('click', function() {
                    if (paymentConfirmModal) paymentConfirmModal.style.display = 'none';
                });
            }
            
            // Click outside modal to close
            if (paymentConfirmModal) {
                paymentConfirmModal.addEventListener('click', function(e) {
                    if (e.target === paymentConfirmModal) {
                        paymentConfirmModal.style.display = 'none';
                    }
                });
            }
            
            // Mark Payment Received button click
            var markPaymentBtns = document.querySelectorAll('.n88-mark-payment-received-btn');
            markPaymentBtns.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    var paymentId = this.getAttribute('data-payment-id');
                    var itemId = this.getAttribute('data-item-id');
                    var bidId = this.getAttribute('data-bid-id');
                    var totalDue = this.getAttribute('data-total-due');
                    
                    // Populate modal
                    document.getElementById('n88-confirm-item-id').textContent = itemId;
                    document.getElementById('n88-confirm-bid-id').textContent = bidId;
                    document.getElementById('n88-confirm-total-due').textContent = '$' + parseFloat(totalDue).toFixed(2);
                    
                    // Store button reference
                    currentPaymentBtn = this;
                    currentPaymentBtn.paymentId = paymentId;
                    currentPaymentBtn.itemId = itemId;
                    currentPaymentBtn.bidId = bidId;
                    
                    // Show modal
                    if (paymentConfirmModal) paymentConfirmModal.style.display = 'block';

                    // Load payment receipts (JPG/PDF) so operator can review before confirming
                    var listEl = document.getElementById('n88-receipts-list');
                    if (listEl) {
                        listEl.textContent = 'Loadingâ€¦';
                        var fd = new FormData();
                        fd.append('action', 'n88_get_payment_receipts');
                        fd.append('payment_id', paymentId);
                        fd.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_get_payment_receipts' ) ); ?>');
                        fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', { method: 'POST', body: fd })
                            .then(function(r) { return r.json(); })
                            .then(function(d) {
                                if (!listEl) return;
                                if (d.success && d.data.receipts && d.data.receipts.length > 0) {
                                    var receipts = d.data.receipts;
                                    var parts = receipts.map(function(x, index) {
                                        var isResubmitted = receipts.length > 1 && index < receipts.length - 1;
                                        var tag = isResubmitted ? '<span style="display:inline-block;margin-right:8px;padding:2px 6px;font-size:10px;font-weight:600;background-color:#331100;color:#ff8800;border:1px solid #ff8800;border-radius:2px;">Resubmitted</span>' : '';
                                        var name = (x.file_name || 'file').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                                        var msg = (x.message && String(x.message).trim()) ? ' <span style="color:#aaa;font-style:italic;display:block;margin-top:2px;">â€” ' + String(x.message).replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</span>' : '';
                                        return '<div style="margin-bottom:6px;">' + tag + '<a href="' + (x.url || '#') + '" target="_blank" rel="noopener" style="color:#00ff00">' + name + '</a>' + msg + '</div>';
                                    });
                                    listEl.innerHTML = parts.join('');
                                } else {
                                    listEl.textContent = 'None uploaded.';
                                }
                            })
                            .catch(function() { if (listEl) listEl.textContent = 'â€”'; });
                    }
                });
            });

            // Commit 2.3.9.2A: Release Approved CAD to Supplier Modal
            var releaseCadModal = document.getElementById('n88-release-cad-modal');
            var closeReleaseCadModal = document.getElementById('n88-close-release-cad-modal');
            var cancelReleaseCad = document.getElementById('n88-cancel-release-cad');
            var confirmReleaseCad = document.getElementById('n88-confirm-release-cad');
            var currentReleaseBtn = null;

            if (closeReleaseCadModal) {
                closeReleaseCadModal.addEventListener('click', function() {
                    if (releaseCadModal) releaseCadModal.style.display = 'none';
                });
            }
            if (cancelReleaseCad) {
                cancelReleaseCad.addEventListener('click', function() {
                    if (releaseCadModal) releaseCadModal.style.display = 'none';
                });
            }
            if (releaseCadModal) {
                releaseCadModal.addEventListener('click', function(e) {
                    if (e.target === releaseCadModal) {
                        releaseCadModal.style.display = 'none';
                    }
                });
            }

            var releaseCadBtns = document.querySelectorAll('.n88-release-cad-btn');
            releaseCadBtns.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    currentReleaseBtn = this;
                    var paymentId = this.getAttribute('data-payment-id');
                    var itemId = this.getAttribute('data-item-id');
                    var bidId = this.getAttribute('data-bid-id');
                    var supplierId = this.getAttribute('data-supplier-id');
                    var approvedVersion = this.getAttribute('data-approved-version');

                    document.getElementById('n88-release-item-id').textContent = itemId || '';
                    document.getElementById('n88-release-bid-id').textContent = bidId || '';
                    document.getElementById('n88-release-supplier-id').textContent = supplierId || '';
                    document.getElementById('n88-release-approved-version').textContent = 'v' + (approvedVersion || '?');

                    currentReleaseBtn.paymentId = paymentId;

                    if (releaseCadModal) releaseCadModal.style.display = 'block';
                });
            });

            if (confirmReleaseCad) {
                confirmReleaseCad.addEventListener('click', function() {
                    if (!currentReleaseBtn) return;

                    var paymentId = currentReleaseBtn.paymentId;

                    confirmReleaseCad.disabled = true;
                    var originalText = confirmReleaseCad.textContent;
                    confirmReleaseCad.textContent = 'Releasing...';

                    var formData = new FormData();
                    formData.append('action', 'n88_release_cad_to_supplier');
                    formData.append('payment_id', paymentId);
                    formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_release_cad_to_supplier' ) ); ?>');

                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.success) {
                            if (releaseCadModal) releaseCadModal.style.display = 'none';
                            alert('Approved CAD released to supplier.');
                            // Refresh page to update button visibility and counts
                            window.location.reload();
                        } else {
                            alert('Error: ' + (data.data?.message || 'Failed to release CAD.'));
                        }
                        confirmReleaseCad.disabled = false;
                        confirmReleaseCad.textContent = originalText;
                    })
                    .catch(function(error) {
                        console.error('Error releasing CAD:', error);
                        alert('An error occurred. Please try again.');
                        confirmReleaseCad.disabled = false;
                        confirmReleaseCad.textContent = originalText;
                    });
                });
            }
            
            // Confirm Payment Received button in modal
            if (confirmPaymentReceived) {
                confirmPaymentReceived.addEventListener('click', function() {
                    if (!currentPaymentBtn) return;
                    
                    var paymentId = currentPaymentBtn.paymentId;
                    var itemId = currentPaymentBtn.itemId;
                    var bidId = currentPaymentBtn.bidId;
                    var btn = currentPaymentBtn;
                    
                    // Close modal
                    if (paymentConfirmModal) paymentConfirmModal.style.display = 'none';
                    
                    // Disable button and show processing
                    var originalText = btn.textContent;
                    btn.disabled = true;
                    btn.textContent = '[ Processing... ]';
                    
                    var formData = new FormData();
                    formData.append('action', 'n88_mark_payment_received');
                    formData.append('payment_id', paymentId);
                    formData.append('item_id', itemId);
                    formData.append('bid_id', bidId);
                    formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_mark_payment_received' ) ); ?>');
                    
                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.success) {
                            // Update button to show confirmation
                            btn.style.backgroundColor = '#001100';
                            btn.style.borderColor = '#00ff00';
                            btn.style.color = '#00ff00';
                            btn.textContent = 'âœ“ Payment Confirmed';
                            btn.disabled = true;
                            
                            // Update status in the table row
                            var statusCell = btn.closest('tr').previousElementSibling.querySelector('td:nth-child(4)');
                            if (statusCell) {
                                statusCell.innerHTML = '<div>Payment Received</div><div style="font-size: 11px; color: #00ff00;">Confirmed</div>';
                            }
                            
                            // Reload page after 2 seconds to reflect changes
                            setTimeout(function() {
                                window.location.reload();
                            }, 2000);
                        } else {
                            alert('Error: ' + (data.data?.message || 'Failed to mark payment as received.'));
                            btn.disabled = false;
                            btn.textContent = originalText;
                        }
                    })
                    .catch(function(error) {
                        console.error('Error marking payment as received:', error);
                        alert('An error occurred. Please try again.');
                        btn.disabled = false;
                        btn.textContent = originalText;
                    });
                    
                    // Reset reference
                    currentPaymentBtn = null;
                });
            }
            
            // Auto-refresh every 30 seconds
            var autoRefreshInterval = setInterval(function() {
                // Only refresh if no modal is open and no filters are being edited
                if (!caseModal || caseModal.style.display === 'none') {
                    // Soft refresh - just reload the page
                    // In future, could be AJAX-based
                }
            }, 30000);
            
            // Commit 2.3.9.1C-a: Send Operator Message
            window.sendOperatorMessage = function(event, threadType, itemId, designerId, bidId, supplierId) {
                event.preventDefault();
                
                var form = event.target;
                var messageInput = form.querySelector('textarea[name="message_text"]');
                var messageText = messageInput ? messageInput.value.trim() : '';
                
                if (!messageText) {
                    alert('Please enter a message.');
                    return false;
                }
                
                var submitBtn = form.querySelector('button[type="submit"]');
                var originalText = submitBtn ? submitBtn.textContent : '';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = '[ Sending... ]';
                }
                
                var formData = new FormData();
                formData.append('action', 'n88_send_item_message');
                formData.append('item_id', itemId);
                formData.append('thread_type', threadType);
                formData.append('message_text', messageText);
                if (designerId) formData.append('designer_id', designerId);
                if (bidId) formData.append('bid_id', bidId);
                if (supplierId) formData.append('supplier_id', supplierId);
                formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_send_item_message' ) ); ?>');
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        // Clear form
                        if (messageInput) messageInput.value = '';
                        
                        // Reload case details to show new message
                        var paymentId = form.getAttribute('data-payment-id');
                        if (paymentId) {
                            loadCaseDetails(paymentId);
                        } else {
                            // Try to find payment ID from modal
                            var modalContent = document.getElementById('n88-case-modal-content');
                            if (modalContent) {
                                // Extract payment ID from somewhere or reload the modal
                                location.reload();
                            }
                        }
                    } else {
                        alert('Error: ' + (data.data?.message || 'Failed to send message. Please try again.'));
                    }
                    
                    // Re-enable form
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                })
                .catch(function(error) {
                    console.error('Error sending message:', error);
                    alert('An error occurred. Please try again.');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
                
                return false;
            };
            
            // Commit 2.3.9.1C-a: Copy Message to Other Side
            window.copyMessageToOtherSide = function(itemId, designerId, bidId, supplierId, paymentId) {
                // Get the last message from designer thread
                var designerMessages = document.getElementById('n88-operator-designer-messages');
                var supplierMessages = document.getElementById('n88-operator-supplier-messages');
                
                if (!designerMessages || !supplierMessages) {
                    alert('Message threads not found.');
                    return;
                }
                
                // Find last message in designer thread
                var designerLastMsg = designerMessages.querySelector('div[style*="margin-bottom: 12px"]:last-child');
                if (!designerLastMsg) {
                    alert('No messages in designer thread to copy.');
                    return;
                }
                
                var msgText = designerLastMsg.querySelector('div[style*="white-space: pre-wrap"]');
                if (!msgText) {
                    alert('Could not extract message text.');
                    return;
                }
                
                var textToCopy = msgText.textContent.trim();
                if (!textToCopy) {
                    alert('Message text is empty.');
                    return;
                }
                
                // Confirm action
                if (!confirm('Copy this message to the supplier thread?\n\n"' + textToCopy.substring(0, 100) + (textToCopy.length > 100 ? '...' : '') + '"')) {
                    return;
                }
                
                // Send to supplier thread
                var formData = new FormData();
                formData.append('action', 'n88_send_item_message');
                formData.append('item_id', itemId);
                formData.append('thread_type', 'supplier_operator');
                formData.append('message_text', textToCopy);
                formData.append('bid_id', bidId);
                formData.append('supplier_id', supplierId);
                formData.append('_ajax_nonce', '<?php echo esc_js( wp_create_nonce( 'n88_send_item_message' ) ); ?>');
                
                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        alert('Message copied to supplier thread.');
                        // Reload case details
                        if (paymentId) {
                            loadCaseDetails(paymentId);
                        } else {
                            location.reload();
                        }
                    } else {
                        alert('Error: ' + (data.data?.message || 'Failed to copy message.'));
                    }
                })
                .catch(function(error) {
                    console.error('Error copying message:', error);
                    alert('An error occurred. Please try again.');
                });
            };
        })();
        </script>
        <?php
        return ob_get_clean();
    }

    /**
     * AJAX: Get Operator Case Details (Read-Only) - Commit 2.3.9.1C
     */
    public function ajax_get_operator_case_details() {
        check_ajax_referer( 'n88_get_operator_case_details', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_system_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_system_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. System Operator account required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        if ( ! $payment_id ) {
            wp_send_json_error( array( 'message' => 'Invalid payment ID.' ) );
            return;
        }

        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $items_table = $wpdb->prefix . 'n88_items';
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $categories_table = $wpdb->prefix . 'n88_categories';
        $users_table = $wpdb->prefix . 'users';
        $events_table = $wpdb->prefix . 'n88_events';
        $keywords_table = $wpdb->prefix . 'n88_keywords';

        // Get prototype payment details
        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT pp.*, i.title as item_title, i.item_type, b.unit_price,
             designer.display_name as designer_name, supplier.display_name as supplier_name
             FROM {$prototype_payments_table} pp
             LEFT JOIN {$items_table} i ON pp.item_id = i.id
             LEFT JOIN {$item_bids_table} b ON pp.bid_id = b.bid_id
             LEFT JOIN {$users_table} designer ON pp.designer_user_id = designer.ID
             LEFT JOIN {$users_table} supplier ON pp.supplier_id = supplier.ID
             WHERE pp.id = %d",
            $payment_id
        ), ARRAY_A );

        if ( ! $payment ) {
            wp_send_json_error( array( 'message' => 'Payment record not found.' ) );
            return;
        }

        // Get item thumbnail
        $thumbnail_url = '';
        if ( ! empty( $payment['item_id'] ) ) {
            $item = $wpdb->get_row( $wpdb->prepare(
                "SELECT primary_image_id FROM {$items_table} WHERE id = %d",
                $payment['item_id']
            ), ARRAY_A );
            if ( $item && ! empty( $item['primary_image_id'] ) ) {
                $thumbnail_url = wp_get_attachment_image_url( $item['primary_image_id'], 'thumbnail' );
                if ( ! $thumbnail_url ) {
                    $thumbnail_url = wp_get_attachment_url( $item['primary_image_id'] );
                }
            }
        }

        // Parse video direction JSON
        $video_direction = array();
        $selected_keywords = array();
        $note = '';
        $keyword_count = 0;
        if ( ! empty( $payment['video_direction_json'] ) ) {
            $video_direction = json_decode( $payment['video_direction_json'], true );
            if ( is_array( $video_direction ) ) {
                if ( isset( $video_direction['selected_keywords'] ) && is_array( $video_direction['selected_keywords'] ) ) {
                    $selected_keywords = $video_direction['selected_keywords'];
                    $keyword_count = count( $selected_keywords );
                }
                if ( isset( $video_direction['note'] ) ) {
                    $note = sanitize_textarea_field( $video_direction['note'] );
                }
            }
        }

        // Get keyword names
        $keyword_names = array();
        if ( ! empty( $selected_keywords ) ) {
            $keyword_ids = array_map( 'absint', $selected_keywords );
            $keyword_ids = array_filter( $keyword_ids );
            if ( ! empty( $keyword_ids ) ) {
                $placeholders = implode( ',', array_fill( 0, count( $keyword_ids ), '%d' ) );
                $keywords = $wpdb->get_results( $wpdb->prepare(
                    "SELECT keyword_id, keyword FROM {$keywords_table} WHERE keyword_id IN ({$placeholders}) ORDER BY keyword",
                    ...$keyword_ids
                ), ARRAY_A );
                foreach ( $keywords as $kw ) {
                    $keyword_names[] = $kw['keyword'];
                }
            }
        }

        // Get category name
        $category_name = ! empty( $payment['item_type'] ) ? $payment['item_type'] : 'Uncategorized';
        if ( ! empty( $payment['item_type'] ) ) {
            $category = $wpdb->get_row( $wpdb->prepare(
                "SELECT name FROM {$categories_table} WHERE category_id = %d OR name = %s LIMIT 1",
                intval( $payment['item_type'] ),
                $payment['item_type']
            ) );
            if ( $category ) {
                $category_name = $category->name;
            }
        }

        // Get linked events
        $events = $wpdb->get_results( $wpdb->prepare(
            "SELECT event_type, created_at, payload_json 
             FROM {$events_table}
             WHERE object_type = 'prototype_payment' 
             AND object_id = %d
             AND event_type IN ('cad_prototype_requested', 'video_direction_submitted')
             ORDER BY created_at ASC",
            $payment_id
        ), ARRAY_A );

        // Operator display: landed prototype and total due (matches designer; fixes legacy wrong total_due_usd)
        $prototype_estimate_for_display = null;
        $total_due_for_display = floatval( $payment['cad_fee_usd'] );
        if ( $payment['prototype_video_cost_estimate_usd'] !== null && $payment['prototype_video_cost_estimate_usd'] !== '' && floatval( $payment['prototype_video_cost_estimate_usd'] ) > 0 ) {
            $supplier_profiles_table = $wpdb->prefix . 'n88_supplier_profiles';
            $origin_region = null;
            $duty_rate_override = null;
            if ( ! empty( $payment['supplier_id'] ) ) {
                $table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$supplier_profiles_table}'" ) === $supplier_profiles_table;
                if ( $table_exists ) {
                    $sp = $wpdb->get_row( $wpdb->prepare( "SELECT origin_region, duty_rate_override FROM {$supplier_profiles_table} WHERE supplier_id = %d", intval( $payment['supplier_id'] ) ), ARRAY_A );
                    if ( $sp ) {
                        $origin_region = isset( $sp['origin_region'] ) ? $sp['origin_region'] : null;
                        $duty_rate_override = isset( $sp['duty_rate_override'] ) ? $sp['duty_rate_override'] : null;
                    }
                }
            }
            $duty_rate = N88_RFQ_Helpers::n88_calculate_duty_rate( $origin_region, $duty_rate_override );
            $pl = N88_RFQ_Helpers::n88_calculate_landed_cost( floatval( $payment['prototype_video_cost_estimate_usd'] ), $duty_rate );
            $prototype_landed_val = ( $pl && isset( $pl['display_price'] ) ) ? floatval( $pl['display_price'] ) : floatval( $payment['prototype_video_cost_estimate_usd'] );
            $prototype_estimate_for_display = $prototype_landed_val;
            $total_due_for_display += $prototype_landed_val;
        }

        // Commit 2.3.9.1C-a: Get messages for both threads
        $messages_table = $wpdb->prefix . 'n88_item_messages';
        $users_table = $wpdb->prefix . 'users';
        
        // Get supplier thread messages
        $supplier_messages = array();
        if ( ! empty( $payment['bid_id'] ) && ! empty( $payment['supplier_id'] ) ) {
            $supplier_messages = $wpdb->get_results( $wpdb->prepare(
                "SELECT m.*, u.display_name as sender_name
                 FROM {$messages_table} m
                 LEFT JOIN {$users_table} u ON m.sender_user_id = u.ID
                 WHERE m.item_id = %d 
                 AND m.thread_type = 'supplier_operator'
                 AND m.bid_id = %d
                 AND m.supplier_id = %d
                 ORDER BY m.created_at ASC",
                $payment['item_id'],
                $payment['bid_id'],
                $payment['supplier_id']
            ), ARRAY_A );
        }
        
        // Get designer thread messages
        $designer_messages = array();
        if ( ! empty( $payment['designer_user_id'] ) ) {
            $designer_messages = $wpdb->get_results( $wpdb->prepare(
                "SELECT m.*, u.display_name as sender_name
                 FROM {$messages_table} m
                 LEFT JOIN {$users_table} u ON m.sender_user_id = u.ID
                 WHERE m.item_id = %d 
                 AND m.thread_type = 'designer_operator'
                 AND m.designer_id = %d
                 ORDER BY m.created_at ASC",
                $payment['item_id'],
                $payment['designer_user_id']
            ), ARRAY_A );
        }

        // Format dates
        $created_date = ! empty( $payment['created_at'] ) ? date( 'M d, Y g:i A', strtotime( $payment['created_at'] ) ) : 'â€”';

        // Build HTML
        ob_start();
        ?>
        <!-- Case Header -->
        <div style="margin-bottom: 24px; padding: 16px; background-color: #1a1a1a; border: 1px solid #fff; border-radius: 2px;">
            <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 12px;">Case Header</div>
            <div style="font-size: 12px; color: #fff; line-height: 1.8;">
                <div><strong>Item ID:</strong> <?php echo esc_html( $payment['item_id'] ); ?></div>
                <div><strong>Bid ID:</strong> <?php echo esc_html( $payment['bid_id'] ); ?></div>
                <div><strong>Supplier ID:</strong> <?php echo esc_html( $payment['supplier_id'] ); ?></div>
                <div><strong>Request Created:</strong> <span style="color: #ff8800;"><?php echo esc_html( $created_date ); ?></span></div>
                <div><strong>Payment Status:</strong> <?php echo esc_html( ucfirst( str_replace( '_', ' ', $payment['status'] ) ) ); ?></div>
            </div>
            <div style="margin-top: 12px;">
                <button type="button" class="n88-mark-resolved-btn" data-item-id="<?php echo esc_attr( $payment['item_id'] ); ?>" data-bid-id="<?php echo esc_attr( ! empty( $payment['bid_id'] ) ? $payment['bid_id'] : '0' ); ?>" style="padding: 8px 16px; background-color: #003300; color: #00ff00; border: 1px solid #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 12px; font-weight: 600; cursor: pointer;" onmouseover="this.style.backgroundColor='#005500';" onmouseout="this.style.backgroundColor='#003300';">
                Mark Clarification Resolved
                </button>
            </div>
        </div>

        <!-- Cost Block -->
        <div style="margin-bottom: 24px; padding: 16px; background-color: #1a1a1a; border: 1px solid #fff; border-radius: 2px;">
            <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 12px;">Cost Block (Read-Only)</div>
            <div style="font-size: 12px; color: #fff; line-height: 1.8;">
                <div><strong>CAD Fee:</strong> $<?php echo number_format( floatval( $payment['cad_fee_usd'] ), 2 ); ?></div>
                <div><strong>Prototype Estimate:</strong> <?php echo $prototype_estimate_for_display !== null ? '$' . number_format( $prototype_estimate_for_display, 2 ) : ( $payment['prototype_video_cost_estimate_usd'] ? '$' . number_format( floatval( $payment['prototype_video_cost_estimate_usd'] ), 2 ) : 'â€”' ); ?></div>
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #333;"><strong>Total Due:</strong> <span style="color: #ff8800; font-weight: 600;">$<?php echo number_format( $total_due_for_display, 2 ); ?></span></div>
            </div>
        </div>

        <!-- CAD Policy Block -->
        <div style="margin-bottom: 24px; padding: 16px; background-color: #1a1a1a; border: 1px solid #fff; border-radius: 2px;">
            <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 12px;">CAD Policy Block</div>
            <div style="font-size: 12px; color: #fff; line-height: 1.8;">
                <div><strong>Rounds Included:</strong> <?php echo esc_html( $payment['cad_revision_rounds_included'] ); ?></div>
                <div><strong>Extra Round Fee:</strong> $<?php echo number_format( floatval( $payment['cad_revision_round_fee_usd'] ), 2 ); ?> (round 4+)</div>
                <div><strong>Rounds Used:</strong> <?php echo esc_html( $payment['cad_revision_rounds_used'] ); ?></div>
            </div>
        </div>

        <!-- Video Direction Block -->
        <div style="margin-bottom: 24px; padding: 16px; background-color: #1a1a1a; border: 1px solid #fff; border-radius: 2px;">
            <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 12px;">Video Direction Block (Read-Only)</div>
            <div style="font-size: 12px; color: #fff; line-height: 1.8;">
                <?php if ( ! empty( $keyword_names ) ) : ?>
                    <div style="margin-bottom: 12px;">
                        <strong>Selected Keywords (<?php echo esc_html( $keyword_count ); ?>):</strong>
                        <ul style="margin: 8px 0 0 20px; padding: 0;">
                            <?php foreach ( $keyword_names as $kw_name ) : ?>
                                <li><?php echo esc_html( $kw_name ); ?></li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                <?php else : ?>
                    <div style="color: #999;">No keywords selected</div>
                <?php endif; ?>
                <?php if ( ! empty( $note ) ) : ?>
                    <div style="margin-top: 12px;">
                        <strong>Note:</strong>
                        <div style="margin-top: 4px; padding: 8px; background-color: #000; border: 1px solid #333; border-radius: 2px; white-space: pre-wrap;"><?php echo esc_html( $note ); ?></div>
                    </div>
                <?php else : ?>
                    <div style="margin-top: 12px; color: #999;">Note: None</div>
                <?php endif; ?>
            </div>
        </div>

        <!-- Evidence Log Preview -->
        <div style="margin-bottom: 24px; padding: 16px; background-color: #1a1a1a; border: 1px solid #fff; border-radius: 2px;">
            <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 12px;">Evidence Log Preview (Read-Only, Minimal)</div>
            <div style="font-size: 12px; color: #fff; line-height: 1.8;">
                <?php if ( ! empty( $events ) ) : ?>
                    <div style="margin-bottom: 8px;"><strong>Linked Events:</strong></div>
                    <ul style="margin: 0 0 0 20px; padding: 0;">
                        <?php foreach ( $events as $event ) : ?>
                            <li style="margin-bottom: 4px;">
                                <strong><?php echo esc_html( str_replace( '_', ' ', ucfirst( $event['event_type'] ) ) ); ?>:</strong>
                                <?php echo esc_html( date( 'M d, Y g:i A', strtotime( $event['created_at'] ) ) ); ?>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php else : ?>
                    <div style="color: #999;">No events found</div>
                <?php endif; ?>
            </div>
        </div>

        <!-- Workflow Timeline (Furniture 6-Step) - same as supplier queue -->
        <div id="n88-operator-workflow-timeline-wrap" data-item-id="<?php echo esc_attr( $payment['item_id'] ); ?>" style="margin-bottom: 24px; padding-bottom: 20px;">
            <div style="font-size: 11px; color: #888; margin-bottom: 8px;"></div>
            <div id="n88-operator-workflow-timeline" style="min-height: 60px; font-family: monospace;">Loading timelineâ€¦</div>
        </div>

        <!-- Commit 2.3.9.1C-a: Two-Column Message Threads (hidden in View Case modal) -->
        <div id="n88-operator-case-message-threads" style="display: none; margin-bottom: 24px; padding: 16px; background-color: #1a1a1a; border: 1px solid #fff; border-radius: 2px;">
            <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 16px;">Message Threads</div>
            
            <div style="display: flex; gap: 20px; min-height: 400px;">
                <!-- Left Column: Designer Thread -->
                <div style="flex: 1; border: 1px solid #333; border-radius: 2px; background-color: #000; display: flex; flex-direction: column;">
                    <div style="padding: 12px; border-bottom: 1px solid #333; background-color: #001100;">
                        <div style="font-size: 12px; font-weight: 600; color: #00ff00;">Designer â‡„ Operator</div>
                        <div style="font-size: 10px; color: #666; margin-top: 4px;">Item #<?php echo esc_html( $payment['item_id'] ); ?></div>
                    </div>
                    <div id="n88-operator-designer-messages" style="flex: 1; overflow-y: auto; padding: 12px; max-height: 350px;">
                        <?php if ( empty( $designer_messages ) ) : ?>
                            <div style="text-align: center; color: #666; font-size: 11px; padding: 20px;">No messages yet</div>
                        <?php else : ?>
                            <?php foreach ( $designer_messages as $msg ) : 
                                $is_designer = $msg['sender_role'] === 'designer';
                                $sender_name = $is_designer ? ( ! empty( $msg['sender_name'] ) ? esc_html( $msg['sender_name'] ) : 'Designer' ) : 'Operator';
                                $align_class = $is_designer ? 'right' : 'left';
                                $bg_color = $is_designer ? '#003300' : '#001100';
                                $border_color = $is_designer ? '#00ff00' : '#00aa00';
                                $msg_date = date( 'M d, Y g:i A', strtotime( $msg['created_at'] ) );
                            ?>
                                <div style="margin-bottom: 12px; text-align: <?php echo esc_attr( $align_class ); ?>;">
                                    <div style="display: inline-block; max-width: 80%; padding: 8px 12px; background-color: <?php echo esc_attr( $bg_color ); ?>; border: 1px solid <?php echo esc_attr( $border_color ); ?>; border-radius: 4px; font-size: 11px; color: #fff;">
                                        <div style="font-weight: bold; color: #00ff00; margin-bottom: 4px;"><?php echo esc_html( $sender_name ); ?><?php echo ! empty( $msg['category'] ) ? ' [' . esc_html( $msg['category'] ) . ']' : ''; ?></div>
                                        <div style="white-space: pre-wrap; word-wrap: break-word;"><?php echo esc_html( $msg['message_text'] ); ?></div>
                                        <div style="font-size: 10px; color: #666; margin-top: 4px;"><?php echo esc_html( $msg_date ); ?></div>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </div>
                    <div style="padding: 12px; border-top: 1px solid #333; background-color: #001100;">
                        <form id="n88-operator-designer-form" data-payment-id="<?php echo esc_attr( $payment_id ); ?>" onsubmit="return sendOperatorMessage(event, 'designer_operator', <?php echo esc_js( $payment['item_id'] ); ?>, <?php echo esc_js( $payment['designer_user_id'] ); ?>, null, null);">
                            <textarea id="n88-operator-designer-message" name="message_text" required rows="3" style="width: 100%; padding: 6px; background-color: #000; color: #fff; border: 1px solid #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 11px; resize: vertical; margin-bottom: 8px;" placeholder="Type your message..."></textarea>
                            <button type="submit" style="width: 100%; padding: 6px; background-color: #00ff00; color: #000; border: none; font-family: 'Courier New', Courier, monospace; font-size: 11px; font-weight: bold; cursor: pointer;" onmouseover="this.style.backgroundColor='#00cc00';" onmouseout="this.style.backgroundColor='#00ff00';">
                                [ Send to Designer ]
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Right Column: Supplier Thread -->
                <div style="flex: 1; border: 1px solid #333; border-radius: 2px; background-color: #000; display: flex; flex-direction: column;">
                    <div style="padding: 12px; border-bottom: 1px solid #333; background-color: #001100;">
                        <div style="font-size: 12px; font-weight: 600; color: #00ff00;">Supplier â‡„ Operator</div>
                        <div style="font-size: 10px; color: #666; margin-top: 4px;">Item #<?php echo esc_html( $payment['item_id'] ); ?> | Bid #<?php echo esc_html( $payment['bid_id'] ); ?></div>
                    </div>
                    <div id="n88-operator-supplier-messages" style="flex: 1; overflow-y: auto; padding: 12px; max-height: 350px;">
                        <?php if ( empty( $supplier_messages ) ) : ?>
                            <div style="text-align: center; color: #666; font-size: 11px; padding: 20px;">No messages yet</div>
                        <?php else : ?>
                            <?php foreach ( $supplier_messages as $msg ) : 
                                $is_supplier = $msg['sender_role'] === 'supplier';
                                $sender_name = $is_supplier ? 'Supplier' : 'Operator';
                                $align_class = $is_supplier ? 'right' : 'left';
                                $bg_color = $is_supplier ? '#003300' : '#001100';
                                $border_color = $is_supplier ? '#00ff00' : '#00aa00';
                                $msg_date = date( 'M d, Y g:i A', strtotime( $msg['created_at'] ) );
                            ?>
                                <div style="margin-bottom: 12px; text-align: <?php echo esc_attr( $align_class ); ?>;">
                                    <div style="display: inline-block; max-width: 80%; padding: 8px 12px; background-color: <?php echo esc_attr( $bg_color ); ?>; border: 1px solid <?php echo esc_attr( $border_color ); ?>; border-radius: 4px; font-size: 11px; color: #fff;">
                                        <div style="font-weight: bold; color: #00ff00; margin-bottom: 4px;"><?php echo esc_html( $sender_name ); ?><?php echo ! empty( $msg['category'] ) ? ' [' . esc_html( $msg['category'] ) . ']' : ''; ?></div>
                                        <div style="white-space: pre-wrap; word-wrap: break-word;"><?php echo esc_html( $msg['message_text'] ); ?></div>
                                        <div style="font-size: 10px; color: #666; margin-top: 4px;"><?php echo esc_html( $msg_date ); ?></div>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </div>
                    <div style="padding: 12px; border-top: 1px solid #333; background-color: #001100;">
                        <form id="n88-operator-supplier-form" data-payment-id="<?php echo esc_attr( $payment_id ); ?>" onsubmit="return sendOperatorMessage(event, 'supplier_operator', <?php echo esc_js( $payment['item_id'] ); ?>, null, <?php echo esc_js( $payment['bid_id'] ); ?>, <?php echo esc_js( $payment['supplier_id'] ); ?>);">
                            <textarea id="n88-operator-supplier-message" name="message_text" required rows="3" style="width: 100%; padding: 6px; background-color: #000; color: #fff; border: 1px solid #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 11px; resize: vertical; margin-bottom: 8px;" placeholder="Type your message..."></textarea>
                            <button type="submit" style="width: 100%; padding: 6px; background-color: #00ff00; color: #000; border: none; font-family: 'Courier New', Courier, monospace; font-size: 11px; font-weight: bold; cursor: pointer;" onmouseover="this.style.backgroundColor='#00cc00';" onmouseout="this.style.backgroundColor='#00ff00';">
                                [ Send to Supplier ]
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Copy to Other Side Button (Optional Feature) -->
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333;">
                <button onclick="copyMessageToOtherSide(<?php echo esc_js( $payment['item_id'] ); ?>, <?php echo esc_js( $payment['designer_user_id'] ); ?>, <?php echo esc_js( $payment['bid_id'] ); ?>, <?php echo esc_js( $payment['supplier_id'] ); ?>, <?php echo esc_js( $payment_id ); ?>);" style="padding: 6px 12px; background-color: #000; color: #00ff00; border: 1px solid #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 11px; cursor: pointer;" onmouseover="this.style.backgroundColor='#003300';" onmouseout="this.style.backgroundColor='#000';">
                    [ Copy to Other Side ]
                </button>
                <div style="font-size: 10px; color: #666; margin-top: 4px;">Forwards the last message from one thread to the other</div>
            </div>
        </div>
        <?php
        $html = ob_get_clean();

        wp_send_json_success( array( 'html' => $html ) );
    }
    
    /**
     * AJAX handler to get item messages (Commit 2.3.9.1C-a)
     */
    public function ajax_get_item_messages() {
        check_ajax_referer( 'n88_get_item_messages', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_designer && ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ) );
            return;
        }

        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $thread_type = isset( $_POST['thread_type'] ) ? sanitize_text_field( wp_unslash( $_POST['thread_type'] ) ) : '';
        
        if ( ! $item_id || ! in_array( $thread_type, array( 'supplier_operator', 'designer_operator' ), true ) ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters.' ) );
            return;
        }

        global $wpdb;
        $messages_table = $wpdb->prefix . 'n88_item_messages';
        $items_table = $wpdb->prefix . 'n88_items';
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $users_table = $wpdb->prefix . 'users';

        // Build WHERE clause based on thread type and user role
        $where_clauses = array();
        $where_clauses[] = $wpdb->prepare( 'm.item_id = %d', $item_id );
        $where_clauses[] = $wpdb->prepare( "m.thread_type = %s", $thread_type );

        // Access control: Users can only see their own thread
        if ( $thread_type === 'supplier_operator' ) {
            if ( $is_supplier ) {
                // Supplier can only see messages for their own bids
                $where_clauses[] = $wpdb->prepare( 'm.supplier_id = %d', $current_user->ID );
            } elseif ( $is_operator ) {
                // Operator can see all supplier threads for this item
                // No additional restriction needed
            } else {
                wp_send_json_error( array( 'message' => 'Access denied. Supplier or Operator only.' ) );
                return;
            }
        } elseif ( $thread_type === 'designer_operator' ) {
            if ( $is_designer ) {
                // Designer can only see messages for their own items
                $item_owner = $wpdb->get_var( $wpdb->prepare(
                    "SELECT owner_user_id FROM {$items_table} WHERE id = %d",
                    $item_id
                ) );
                if ( ! $item_owner || intval( $item_owner ) !== $current_user->ID ) {
                    wp_send_json_error( array( 'message' => 'Access denied. You can only view messages for your own items.' ) );
                    return;
                }
                $where_clauses[] = $wpdb->prepare( 'm.designer_id = %d', $current_user->ID );
            } elseif ( $is_operator ) {
                // Operator can see all designer threads for this item
                // No additional restriction needed
            } else {
                wp_send_json_error( array( 'message' => 'Access denied. Designer or Operator only.' ) );
                return;
            }
        }

        $where_sql = implode( ' AND ', $where_clauses );

        // Get messages with sender names
        $messages = $wpdb->get_results(
            "SELECT m.*, u.display_name as sender_name
             FROM {$messages_table} m
             LEFT JOIN {$users_table} u ON m.sender_user_id = u.ID
             WHERE {$where_sql}
             ORDER BY m.created_at ASC",
            ARRAY_A
        );

        $response = array( 'messages' => $messages );

        // Supplier thread: add flags for "Mark as clarified" button
        if ( $thread_type === 'supplier_operator' && $is_supplier && ! empty( $messages ) ) {
            $has_operator_reply = false;
            $thread_bid_id = null;
            foreach ( $messages as $m ) {
                if ( isset( $m['sender_role'] ) && $m['sender_role'] === 'operator' ) {
                    $has_operator_reply = true;
                }
                if ( isset( $m['bid_id'] ) && $m['bid_id'] ) {
                    $thread_bid_id = (int) $m['bid_id'];
                }
            }
            $response['has_operator_reply'] = $has_operator_reply;
            $response['bid_id'] = $thread_bid_id ?: 0;

            $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
            $supplier_confirmed = false;
            $last_resolved_at = null;
            if ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) === $resolutions_table ) {
                if ( $thread_bid_id ) {
                    $row = $wpdb->get_row( $wpdb->prepare(
                        "SELECT resolved_at FROM {$resolutions_table} WHERE item_id = %d AND bid_id = %d AND actor_user_id = %d ORDER BY resolved_at DESC LIMIT 1",
                        $item_id,
                        $thread_bid_id,
                        $current_user->ID
                    ), ARRAY_A );
                    if ( $row && ! empty( $row['resolved_at'] ) ) {
                        $supplier_confirmed = true;
                        $last_resolved_at = $row['resolved_at'];
                    }
                } else {
                    $row = $wpdb->get_row( $wpdb->prepare(
                        "SELECT resolved_at FROM {$resolutions_table} WHERE item_id = %d AND bid_id IS NULL AND actor_user_id = %d ORDER BY resolved_at DESC LIMIT 1",
                        $item_id,
                        $current_user->ID
                    ), ARRAY_A );
                    if ( $row && ! empty( $row['resolved_at'] ) ) {
                        $supplier_confirmed = true;
                        $last_resolved_at = $row['resolved_at'];
                    }
                }
            }
            $response['supplier_confirmed_clarification'] = $supplier_confirmed;

            // If operator replied after supplier last marked clarified, show "Mark as Clarified" again
            $has_operator_reply_after_confirmation = false;
            if ( $supplier_confirmed && $last_resolved_at && ! empty( $messages ) ) {
                foreach ( $messages as $m ) {
                    if ( isset( $m['sender_role'] ) && $m['sender_role'] === 'operator' && isset( $m['created_at'] ) && $m['created_at'] > $last_resolved_at ) {
                        $has_operator_reply_after_confirmation = true;
                        break;
                    }
                }
            }
            $response['has_operator_reply_after_confirmation'] = $has_operator_reply_after_confirmation;

            // Hide "Submit Proposal" in msg box when supplier has already submitted a proposal
            $supplier_has_submitted_bid = (bool) $wpdb->get_var( $wpdb->prepare(
                "SELECT 1 FROM {$item_bids_table} WHERE item_id = %d AND supplier_id = %d AND status IN ('submitted', 'awarded') LIMIT 1",
                $item_id,
                $current_user->ID
            ) );
            $response['supplier_has_submitted_bid'] = $supplier_has_submitted_bid;
        }

        // Operator viewing supplier thread: show if supplier has confirmed clarification
        if ( $thread_type === 'supplier_operator' && $is_operator && ! empty( $messages ) ) {
            $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
            $supplier_id_for_thread = null;
            $thread_bid_id_op = null;
            foreach ( $messages as $m ) {
                if ( isset( $m['supplier_id'] ) && $m['supplier_id'] ) {
                    $supplier_id_for_thread = (int) $m['supplier_id'];
                }
                if ( isset( $m['bid_id'] ) && $m['bid_id'] ) {
                    $thread_bid_id_op = (int) $m['bid_id'];
                }
            }
            if ( $supplier_id_for_thread && $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) === $resolutions_table ) {
                if ( $thread_bid_id_op ) {
                    $confirmed_at = $wpdb->get_var( $wpdb->prepare(
                        "SELECT resolved_at FROM {$resolutions_table} WHERE item_id = %d AND bid_id = %d AND actor_user_id = %d ORDER BY resolved_at DESC LIMIT 1",
                        $item_id,
                        $thread_bid_id_op,
                        $supplier_id_for_thread
                    ) );
                } else {
                    $confirmed_at = $wpdb->get_var( $wpdb->prepare(
                        "SELECT resolved_at FROM {$resolutions_table} WHERE item_id = %d AND bid_id IS NULL AND actor_user_id = %d ORDER BY resolved_at DESC LIMIT 1",
                        $item_id,
                        $supplier_id_for_thread
                    ) );
                }
                if ( $confirmed_at ) {
                    $response['supplier_confirmed_at'] = $confirmed_at;
                }
            }
        }

        wp_send_json_success( $response );
    }
    
    /**
     * AJAX handler to send item message (Commit 2.3.9.1C-a)
     */
    public function ajax_send_item_message() {
        check_ajax_referer( 'n88_send_item_message', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_supplier && ! $is_designer && ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ) );
            return;
        }

        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $thread_type = isset( $_POST['thread_type'] ) ? sanitize_text_field( wp_unslash( $_POST['thread_type'] ) ) : '';
        $message_text = isset( $_POST['message_text'] ) ? sanitize_textarea_field( wp_unslash( $_POST['message_text'] ) ) : '';
        $category = isset( $_POST['category'] ) ? sanitize_text_field( wp_unslash( $_POST['category'] ) ) : '';
        
        if ( ! $item_id || ! in_array( $thread_type, array( 'supplier_operator', 'designer_operator' ), true ) || empty( trim( $message_text ) ) ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters. Message text is required.' ) );
            return;
        }

        // Determine sender role
        $sender_role = '';
        if ( $is_operator ) {
            $sender_role = 'operator';
        } elseif ( $is_supplier ) {
            $sender_role = 'supplier';
        } elseif ( $is_designer ) {
            $sender_role = 'designer';
        }

        if ( ! $sender_role ) {
            wp_send_json_error( array( 'message' => 'Invalid user role.' ) );
            return;
        }

        global $wpdb;
        $messages_table = $wpdb->prefix . 'n88_item_messages';
        $items_table = $wpdb->prefix . 'n88_items';
        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
        $events_table = $wpdb->prefix . 'n88_events';

        // Validate item exists
        $item = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, owner_user_id FROM {$items_table} WHERE id = %d",
            $item_id
        ), ARRAY_A );

        if ( ! $item ) {
            wp_send_json_error( array( 'message' => 'Item not found.' ) );
            return;
        }

        $bid_id = null;
        $supplier_id = null;
        $designer_id = null;

        // Set thread-specific fields based on thread type
        if ( $thread_type === 'supplier_operator' ) {
            if ( $is_supplier ) {
                $supplier_id = $current_user->ID;
                // Get the most recent bid for this supplier and item
                $bid = $wpdb->get_row( $wpdb->prepare(
                    "SELECT bid_id FROM {$item_bids_table} WHERE item_id = %d AND supplier_id = %d ORDER BY created_at DESC LIMIT 1",
                    $item_id,
                    $current_user->ID
                ), ARRAY_A );
                if ( $bid ) {
                    $bid_id = intval( $bid['bid_id'] );
                }
            } elseif ( $is_operator ) {
                // Operator can specify supplier_id and bid_id when replying
                $supplier_id = isset( $_POST['supplier_id'] ) ? absint( $_POST['supplier_id'] ) : null;
                $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : null;
                
                // If supplier_id not provided, try to get it from bid_id or existing messages
                if ( ! $supplier_id ) {
                    if ( $bid_id ) {
                        // Get supplier_id from bid
                        $bid = $wpdb->get_row( $wpdb->prepare(
                            "SELECT supplier_id FROM {$item_bids_table} WHERE bid_id = %d AND item_id = %d LIMIT 1",
                            $bid_id,
                            $item_id
                        ), ARRAY_A );
                        if ( $bid && ! empty( $bid['supplier_id'] ) ) {
                            $supplier_id = intval( $bid['supplier_id'] );
                        }
                    }
                    
                    // If still no supplier_id, get it from existing messages for this item and thread
                    if ( ! $supplier_id ) {
                        $existing_message = $wpdb->get_row( $wpdb->prepare(
                            "SELECT supplier_id FROM {$messages_table} 
                            WHERE item_id = %d AND thread_type = 'supplier_operator' 
                            ORDER BY created_at DESC LIMIT 1",
                            $item_id
                        ), ARRAY_A );
                        if ( $existing_message && ! empty( $existing_message['supplier_id'] ) ) {
                            $supplier_id = intval( $existing_message['supplier_id'] );
                        }
                    }
                }
            }
        } elseif ( $thread_type === 'designer_operator' ) {
            if ( $is_designer ) {
                // Verify designer owns the item
                if ( intval( $item['owner_user_id'] ) !== $current_user->ID ) {
                    wp_send_json_error( array( 'message' => 'Access denied. You can only send messages for your own items.' ) );
                    return;
                }
                $designer_id = $current_user->ID;
            } elseif ( $is_operator ) {
                // Operator can specify designer_id when replying
                $designer_id = isset( $_POST['designer_id'] ) ? absint( $_POST['designer_id'] ) : intval( $item['owner_user_id'] );
            }
        }

        // Validate required fields for thread type
        if ( $thread_type === 'supplier_operator' && ! $supplier_id ) {
            wp_send_json_error( array( 'message' => 'Supplier ID is required for supplier_operator thread.' ) );
            return;
        }
        if ( $thread_type === 'designer_operator' && ! $designer_id ) {
            wp_send_json_error( array( 'message' => 'Designer ID is required for designer_operator thread.' ) );
            return;
        }

        // Insert message
        $insert_result = $wpdb->insert(
            $messages_table,
            array(
                'thread_type' => $thread_type,
                'item_id' => $item_id,
                'bid_id' => $bid_id,
                'supplier_id' => $supplier_id,
                'designer_id' => $designer_id,
                'sender_role' => $sender_role,
                'sender_user_id' => $current_user->ID,
                'message_text' => $message_text,
                'category' => $category ? $category : null,
                'created_at' => current_time( 'mysql' ),
            ),
            array( '%s', '%d', '%d', '%d', '%d', '%s', '%d', '%s', '%s', '%s' )
        );

        if ( ! $insert_result ) {
            wp_send_json_error( array( 'message' => 'Failed to save message.' ) );
            return;
        }

        $message_id = $wpdb->insert_id;

        // Queue Surfacing Fix: When supplier sends clarification, mark item for operator attention
        // This ensures items with clarification requests appear in operator queue even if no prototype payment exists
        if ( $thread_type === 'supplier_operator' && $sender_role === 'supplier' ) {
            // Check if this is the first supplier message for this item (to mark as needing attention)
            $first_message_check = $wpdb->get_var( $wpdb->prepare(
                "SELECT COUNT(*) FROM {$messages_table} 
                WHERE item_id = %d 
                AND thread_type = 'supplier_operator' 
                AND sender_role = 'supplier'",
                $item_id
            ) );
            
            // If this is the first supplier message, the item now needs operator attention
            // This will be picked up by the operator queue query below
        }

        // Log event (Commit 2.3.9.1C-a)
        require_once plugin_dir_path( __FILE__ ) . 'class-n88-events.php';
        N88_Events::insert_event( array(
            'event_type' => 'item_message_sent',
            'object_type' => 'item_message',
            'object_id' => $message_id,
            'item_id' => $item_id,
            'payload_json' => array(
                'message_id' => $message_id,
                'thread_type' => $thread_type,
                'item_id' => $item_id,
                'bid_id' => $bid_id,
                'supplier_id' => $supplier_id,
                'designer_id' => $designer_id,
                'sender_role' => $sender_role,
                'sender_user_id' => $current_user->ID,
                'timestamp' => current_time( 'mysql' ),
            ),
        ) );

        wp_send_json_success( array( 'message_id' => $message_id ) );
    }

    /**
     * Commit 2.3.9.2A: Helper to insert an item message (system/operator/designer/supplier).
     *
     * @return int|false Inserted message_id or false on failure
     */
    private function n88_insert_item_message( $thread_type, $item_id, $sender_role, $sender_user_id, $message_text, $category = null, $bid_id = null, $supplier_id = null, $designer_id = null ) {
        global $wpdb;
        $messages_table = $wpdb->prefix . 'n88_item_messages';

        $insert_result = $wpdb->insert(
            $messages_table,
            array(
                'thread_type'    => $thread_type,
                'item_id'        => $item_id,
                'bid_id'         => $bid_id,
                'supplier_id'    => $supplier_id,
                'designer_id'    => $designer_id,
                'sender_role'    => $sender_role,
                'sender_user_id' => $sender_user_id,
                'message_text'   => $message_text,
                'category'       => $category ? $category : null,
                'created_at'     => current_time( 'mysql' ),
            ),
            array( '%s', '%d', '%d', '%d', '%d', '%s', '%d', '%s', '%s', '%s' )
        );

        if ( ! $insert_result ) {
            return false;
        }

        return $wpdb->insert_id;
    }

    /**
     * Commit 2.3.9.2A: Operator uploads versioned CAD files into Designerâ†”Operator thread.
     * Accepts: PDF, JPG, PNG.
     */
    public function ajax_upload_cad_files() {
        check_ajax_referer( 'n88_upload_cad_files', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        if ( ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator access required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;

        if ( ! $payment_id || ! $item_id || ! $bid_id ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters.' ) );
            return;
        }

        if ( empty( $_FILES['cad_files'] ) ) {
            wp_send_json_error( array( 'message' => 'No CAD files uploaded.' ) );
            return;
        }

        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $item_files_table = $wpdb->prefix . 'n88_item_files';

        // Validate payment preconditions (paid-gated)
        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, item_id, bid_id, designer_user_id, supplier_id, status, received_at, cad_status
             FROM {$prototype_payments_table}
             WHERE id = %d",
            $payment_id
        ), ARRAY_A );

        if ( ! $payment || intval( $payment['item_id'] ) !== $item_id || intval( $payment['bid_id'] ) !== $bid_id ) {
            wp_send_json_error( array( 'message' => 'Payment record not found or mismatched.' ) );
            return;
        }

        if ( $payment['status'] !== 'marked_received' || empty( $payment['received_at'] ) ) {
            wp_send_json_error( array( 'message' => 'Payment is not in marked_received state.' ) );
            return;
        }

        // Determine next CAD version (append-only)
        $max_version = $wpdb->get_var( $wpdb->prepare(
            "SELECT MAX(cad_version) FROM {$item_files_table}
             WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
            $item_id,
            $payment_id
        ) );
        $next_version = $max_version ? ( intval( $max_version ) + 1 ) : 1;

        // Normalize multi-file array
        $files = $_FILES['cad_files'];
        $file_count = 0;
        $uploaded_files_lines = array();

        require_once ABSPATH . 'wp-admin/includes/file.php';
        require_once ABSPATH . 'wp-admin/includes/image.php';
        require_once ABSPATH . 'wp-admin/includes/media.php';

        $allowed_mimes = array(
            'application/pdf',
            'image/jpeg',
            'image/png',
        );

        // Support both single and multi upload forms
        $is_multi = is_array( $files['name'] );
        $total = $is_multi ? count( $files['name'] ) : 1;

        for ( $i = 0; $i < $total; $i++ ) {
            $file = array(
                'name'     => $is_multi ? $files['name'][ $i ] : $files['name'],
                'type'     => $is_multi ? $files['type'][ $i ] : $files['type'],
                'tmp_name' => $is_multi ? $files['tmp_name'][ $i ] : $files['tmp_name'],
                'error'    => $is_multi ? $files['error'][ $i ] : $files['error'],
                'size'     => $is_multi ? $files['size'][ $i ] : $files['size'],
            );

            if ( ! empty( $file['error'] ) ) {
                continue;
            }

            $mime = isset( $file['type'] ) ? sanitize_text_field( $file['type'] ) : '';
            if ( ! in_array( $mime, $allowed_mimes, true ) ) {
                continue;
            }

            $upload = wp_handle_upload( $file, array( 'test_form' => false ) );
            if ( empty( $upload['file'] ) || empty( $upload['url'] ) ) {
                continue;
            }

            $attachment = array(
                'post_mime_type' => $upload['type'],
                'post_title'     => sanitize_file_name( wp_basename( $upload['file'] ) ),
                'post_content'   => '',
                'post_status'    => 'inherit',
            );
            $attach_id = wp_insert_attachment( $attachment, $upload['file'] );
            if ( ! $attach_id ) {
                continue;
            }

            $attach_data = wp_generate_attachment_metadata( $attach_id, $upload['file'] );
            if ( ! is_wp_error( $attach_data ) ) {
                wp_update_attachment_metadata( $attach_id, $attach_data );
            }

            // Insert CAD artifact record (append-only, versioned)
            $inserted = $wpdb->insert(
                $item_files_table,
                array(
                    'item_id'            => $item_id,
                    'file_id'            => $attach_id,
                    'attached_by_user_id'=> $current_user->ID,
                    'attachment_type'    => 'cad',
                    'payment_id'         => $payment_id,
                    'bid_id'             => $bid_id,
                    'cad_version'        => $next_version,
                    'file_name'          => sanitize_text_field( wp_basename( $upload['file'] ) ),
                    'mime_type'          => sanitize_text_field( $upload['type'] ),
                    'display_order'      => 0,
                    'attached_at'        => current_time( 'mysql' ),
                    'detached_at'        => null,
                ),
                array( '%d', '%d', '%d', '%s', '%d', '%d', '%d', '%s', '%s', '%d', '%s', '%s' )
            );

            if ( ! $inserted ) {
                continue;
            }

            $file_count++;
            $file_url = wp_get_attachment_url( $attach_id );
            if ( ! $file_url ) {
                $file_url = $upload['url'];
            }
            $uploaded_files_lines[] = '- ' . sanitize_text_field( wp_basename( $upload['file'] ) ) . ': ' . esc_url_raw( $file_url );
        }

        if ( $file_count < 1 ) {
            wp_send_json_error( array( 'message' => 'No valid CAD files uploaded. Please upload PDF/JPG/PNG.' ) );
            return;
        }

        // Update payment CAD state
        $pp_columns = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
        $update_data = array(
            'cad_status' => 'uploaded',
        );
        $update_format = array( '%s' );
        if ( in_array( 'updated_at', $pp_columns, true ) ) {
            $update_data['updated_at'] = current_time( 'mysql' );
            $update_format[] = '%s';
        }

        $wpdb->update(
            $prototype_payments_table,
            $update_data,
            array( 'id' => $payment_id ),
            $update_format,
            array( '%d' )
        );

        // Post system message into Designerâ†”Operator thread
        $message_text = "CAD v{$next_version} uploaded\nFiles:\n" . implode( "\n", $uploaded_files_lines );
        $this->n88_insert_item_message(
            'designer_operator',
            $item_id,
            'operator',
            $current_user->ID,
            $message_text,
            'CAD',
            null,
            null,
            absint( $payment['designer_user_id'] )
        );

        // Immutable event: cad_uploaded
        if ( function_exists( 'n88_log_event' ) ) {
            n88_log_event(
                'cad_uploaded',
                'prototype_payment',
                array(
                    'object_id' => $payment_id,
                    'item_id'   => $item_id,
                    'payload_json' => array(
                        'payment_id'        => $payment_id,
                        'item_id'           => $item_id,
                        'bid_id'            => $bid_id,
                        'operator_user_id'  => $current_user->ID,
                        'cad_version'       => $next_version,
                        'file_count'        => $file_count,
                        'timestamp'         => current_time( 'mysql' ),
                    ),
                )
            );
        }
        // Commit 3.A.1: Timeline step 2 starts when operator sends CAD to designer
        if ( class_exists( 'N88_Item_Timeline' ) ) {
            N88_Item_Timeline::sync_from_cad_uploaded( $item_id );
        }

        wp_send_json_success( array(
            'cad_version' => $next_version,
            'file_count'  => $file_count,
        ) );
    }

    /**
     * Commit 2.3.9.2A: Designer requests CAD revision.
     */
    public function ajax_request_cad_revision() {
        check_ajax_referer( 'n88_request_cad_revision', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        if ( ! $is_designer ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer account required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;

        if ( ! $payment_id || ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters.' ) );
            return;
        }

        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $item_files_table = $wpdb->prefix . 'n88_item_files';

        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, item_id, bid_id, designer_user_id, status, received_at, cad_revision_rounds_included, cad_revision_rounds_used
             FROM {$prototype_payments_table}
             WHERE id = %d AND item_id = %d AND designer_user_id = %d",
            $payment_id,
            $item_id,
            $current_user->ID
        ), ARRAY_A );

        if ( ! $payment ) {
            wp_send_json_error( array( 'message' => 'Payment record not found.' ) );
            return;
        }

        if ( $payment['status'] !== 'marked_received' || empty( $payment['received_at'] ) ) {
            wp_send_json_error( array( 'message' => 'Payment is not in marked_received state.' ) );
            return;
        }

        $current_version = $wpdb->get_var( $wpdb->prepare(
            "SELECT MAX(cad_version) FROM {$item_files_table}
             WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
            $item_id,
            $payment_id
        ) );
        $current_version = $current_version ? intval( $current_version ) : 0;
        if ( $current_version < 1 ) {
            wp_send_json_error( array( 'message' => 'No CAD uploaded yet.' ) );
            return;
        }

        $rounds_included = isset( $payment['cad_revision_rounds_included'] ) ? intval( $payment['cad_revision_rounds_included'] ) : 0;
        $rounds_used = isset( $payment['cad_revision_rounds_used'] ) ? intval( $payment['cad_revision_rounds_used'] ) : 0;
        $rounds_used_new = $rounds_used + 1;

        // Handle file uploads for revision request
        $uploaded_files_lines = array();
        if ( ! empty( $_FILES['revision_files'] ) ) {
            require_once ABSPATH . 'wp-admin/includes/file.php';
            require_once ABSPATH . 'wp-admin/includes/image.php';
            require_once ABSPATH . 'wp-admin/includes/media.php';

            $allowed_mimes = array(
                'application/pdf',
                'image/jpeg',
                'image/png',
            );

            $files = $_FILES['revision_files'];
            $is_multi = is_array( $files['name'] );
            $total = $is_multi ? count( $files['name'] ) : 1;

            for ( $i = 0; $i < $total; $i++ ) {
                $file = array(
                    'name'     => $is_multi ? $files['name'][ $i ] : $files['name'],
                    'type'     => $is_multi ? $files['type'][ $i ] : $files['type'],
                    'tmp_name' => $is_multi ? $files['tmp_name'][ $i ] : $files['tmp_name'],
                    'error'    => $is_multi ? $files['error'][ $i ] : $files['error'],
                    'size'     => $is_multi ? $files['size'][ $i ] : $files['size'],
                );

                if ( ! empty( $file['error'] ) ) {
                    continue;
                }

                $mime = isset( $file['type'] ) ? sanitize_text_field( $file['type'] ) : '';
                if ( ! in_array( $mime, $allowed_mimes, true ) ) {
                    continue;
                }

                $upload = wp_handle_upload( $file, array( 'test_form' => false ) );
                if ( empty( $upload['file'] ) || empty( $upload['url'] ) ) {
                    continue;
                }

                $attachment = array(
                    'post_mime_type' => $upload['type'],
                    'post_title'     => sanitize_file_name( wp_basename( $upload['file'] ) ),
                    'post_content'   => '',
                    'post_status'    => 'inherit',
                );
                $attach_id = wp_insert_attachment( $attachment, $upload['file'] );
                if ( ! $attach_id ) {
                    continue;
                }

                $attach_data = wp_generate_attachment_metadata( $attach_id, $upload['file'] );
                if ( ! is_wp_error( $attach_data ) ) {
                    wp_update_attachment_metadata( $attach_id, $attach_data );
                }

                // Store file reference (not as CAD version, but as revision request attachment)
                $wpdb->insert(
                    $item_files_table,
                    array(
                        'item_id'            => $item_id,
                        'file_id'            => $attach_id,
                        'attached_by_user_id' => $current_user->ID,
                        'attachment_type'    => 'general', // Not CAD version, just attachment
                        'display_order'      => 0,
                        'attached_at'        => current_time( 'mysql' ),
                        'payment_id'         => $payment_id,
                        'bid_id'             => isset( $payment['bid_id'] ) ? absint( $payment['bid_id'] ) : null,
                    ),
                    array( '%d', '%d', '%d', '%s', '%d', '%s', '%d', '%d' )
                );

                $uploaded_files_lines[] = '- ' . sanitize_file_name( wp_basename( $upload['file'] ) ) . ': ' . esc_url( $upload['url'] );
            }
        }

        $pp_columns = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
        $update_data = array(
            'cad_status' => 'revision_requested',
            'cad_revision_rounds_used' => $rounds_used_new,
        );
        $update_format = array( '%s', '%d' );
        if ( in_array( 'updated_at', $pp_columns, true ) ) {
            $update_data['updated_at'] = current_time( 'mysql' );
            $update_format[] = '%s';
        }

        $wpdb->update(
            $prototype_payments_table,
            $update_data,
            array( 'id' => $payment_id ),
            $update_format,
            array( '%d' )
        );

        $msg = "Revision requested (Round {$rounds_used_new} of {$rounds_included})";
        if ( $rounds_included > 0 && $rounds_used_new >= $rounds_included ) {
            $msg .= "\nAdditional fee required (future commit)";
        }
        if ( ! empty( $uploaded_files_lines ) ) {
            $msg .= "\nFiles:\n" . implode( "\n", $uploaded_files_lines );
        }

        $this->n88_insert_item_message(
            'designer_operator',
            $item_id,
            'designer',
            $current_user->ID,
            $msg,
            'CAD',
            null,
            null,
            $current_user->ID
        );

        if ( function_exists( 'n88_log_event' ) ) {
            n88_log_event(
                'cad_revision_requested',
                'prototype_payment',
                array(
                    'object_id' => $payment_id,
                    'item_id'   => $item_id,
                    'payload_json' => array(
                        'payment_id'      => $payment_id,
                        'item_id'         => $item_id,
                        'bid_id'          => isset( $payment['bid_id'] ) ? absint( $payment['bid_id'] ) : null,
                        'designer_user_id'=> $current_user->ID,
                        'rounds_used'     => $rounds_used_new,
                        'timestamp'       => current_time( 'mysql' ),
                    ),
                )
            );
        }

        wp_send_json_success( array(
            'rounds_used' => $rounds_used_new,
        ) );
    }

    /**
     * Commit 2.3.9.2A: Designer approves current CAD version.
     */
    public function ajax_approve_cad() {
        check_ajax_referer( 'n88_approve_cad', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        if ( ! $is_designer ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer account required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;

        if ( ! $payment_id || ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters.' ) );
            return;
        }

        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $item_files_table = $wpdb->prefix . 'n88_item_files';

        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, item_id, bid_id, designer_user_id, status, received_at
             FROM {$prototype_payments_table}
             WHERE id = %d AND item_id = %d AND designer_user_id = %d",
            $payment_id,
            $item_id,
            $current_user->ID
        ), ARRAY_A );

        if ( ! $payment ) {
            wp_send_json_error( array( 'message' => 'Payment record not found.' ) );
            return;
        }

        if ( $payment['status'] !== 'marked_received' || empty( $payment['received_at'] ) ) {
            wp_send_json_error( array( 'message' => 'Payment is not in marked_received state.' ) );
            return;
        }

        $current_version = $wpdb->get_var( $wpdb->prepare(
            "SELECT MAX(cad_version) FROM {$item_files_table}
             WHERE item_id = %d AND payment_id = %d AND attachment_type = 'cad' AND detached_at IS NULL",
            $item_id,
            $payment_id
        ) );
        $current_version = $current_version ? intval( $current_version ) : 0;
        if ( $current_version < 1 ) {
            wp_send_json_error( array( 'message' => 'No CAD uploaded yet.' ) );
            return;
        }

        $pp_columns = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
        $update_data = array(
            'cad_status' => 'approved',
            'cad_approved_at' => current_time( 'mysql' ),
            'cad_approved_version' => $current_version,
        );
        $update_format = array( '%s', '%s', '%d' );
        if ( in_array( 'updated_at', $pp_columns, true ) ) {
            $update_data['updated_at'] = current_time( 'mysql' );
            $update_format[] = '%s';
        }

        $wpdb->update(
            $prototype_payments_table,
            $update_data,
            array( 'id' => $payment_id ),
            $update_format,
            array( '%d' )
        );

        $this->n88_insert_item_message(
            'designer_operator',
            $item_id,
            'designer',
            $current_user->ID,
            "CAD approved (v{$current_version})",
            'CAD',
            null,
            null,
            $current_user->ID
        );

        if ( function_exists( 'n88_log_event' ) ) {
            n88_log_event(
                'cad_approved',
                'prototype_payment',
                array(
                    'object_id' => $payment_id,
                    'item_id'   => $item_id,
                    'payload_json' => array(
                        'payment_id'       => $payment_id,
                        'item_id'          => $item_id,
                        'bid_id'           => isset( $payment['bid_id'] ) ? absint( $payment['bid_id'] ) : null,
                        'designer_user_id' => $current_user->ID,
                        'approved_version' => $current_version,
                        'timestamp'        => current_time( 'mysql' ),
                    ),
                )
            );
        }
        // Commit 3.A.1: Timeline step 2 complete, step 3 start
        if ( class_exists( 'N88_Item_Timeline' ) ) {
            N88_Item_Timeline::sync_from_cad_approved( $item_id );
        }

        wp_send_json_success( array(
            'approved_version' => $current_version,
        ) );
    }

    /**
     * Commit 2.3.9.2A: Operator releases approved CAD package to supplier (one-time handoff).
     */
    public function ajax_release_cad_to_supplier() {
        check_ajax_referer( 'n88_release_cad_to_supplier', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        if ( ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator access required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;

        if ( ! $payment_id ) {
            wp_send_json_error( array( 'message' => 'Invalid payment ID.' ) );
            return;
        }

        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $item_files_table = $wpdb->prefix . 'n88_item_files';
        $keywords_table = $wpdb->prefix . 'n88_keywords';

        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, item_id, bid_id, supplier_id, status, received_at, cad_status, cad_approved_version, cad_released_to_supplier_at, video_direction_json
             FROM {$prototype_payments_table}
             WHERE id = %d",
            $payment_id
        ), ARRAY_A );

        if ( ! $payment ) {
            wp_send_json_error( array( 'message' => 'Payment record not found.' ) );
            return;
        }

        if ( $payment['status'] !== 'marked_received' || empty( $payment['received_at'] ) ) {
            wp_send_json_error( array( 'message' => 'Payment is not in marked_received state.' ) );
            return;
        }

        if ( isset( $payment['cad_status'] ) && $payment['cad_status'] !== 'approved' ) {
            wp_send_json_error( array( 'message' => 'CAD is not approved yet.' ) );
            return;
        }

        if ( ! empty( $payment['cad_released_to_supplier_at'] ) ) {
            wp_send_json_error( array( 'message' => 'Approved CAD has already been released to supplier.' ) );
            return;
        }

        $approved_version = isset( $payment['cad_approved_version'] ) ? intval( $payment['cad_approved_version'] ) : 0;
        if ( $approved_version < 1 ) {
            wp_send_json_error( array( 'message' => 'Approved CAD version not found.' ) );
            return;
        }

        $item_id = absint( $payment['item_id'] );
        $bid_id = absint( $payment['bid_id'] );
        $supplier_id = absint( $payment['supplier_id'] );

        // Fetch CAD files for approved version
        $cad_files = $wpdb->get_results( $wpdb->prepare(
            "SELECT file_id, file_name, mime_type
             FROM {$item_files_table}
             WHERE item_id = %d
             AND payment_id = %d
             AND bid_id = %d
             AND attachment_type = 'cad'
             AND cad_version = %d
             AND detached_at IS NULL
             ORDER BY id ASC",
            $item_id,
            $payment_id,
            $bid_id,
            $approved_version
        ), ARRAY_A );

        if ( empty( $cad_files ) ) {
            wp_send_json_error( array( 'message' => 'No CAD files found for approved version.' ) );
            return;
        }

        $file_lines = array();
        foreach ( $cad_files as $f ) {
            $url = wp_get_attachment_url( absint( $f['file_id'] ) );
            $name = ! empty( $f['file_name'] ) ? $f['file_name'] : ( $url ? wp_basename( $url ) : 'CAD File' );
            $file_lines[] = '- ' . sanitize_text_field( $name ) . ': ' . ( $url ? esc_url_raw( $url ) : '' );
        }

        // Parse video direction for keyword count + note presence + keyword names
        $video_direction = array();
        $selected_keywords = array();
        $direction_note = '';
        if ( ! empty( $payment['video_direction_json'] ) ) {
            $video_direction = json_decode( $payment['video_direction_json'], true );
            if ( is_array( $video_direction ) ) {
                if ( isset( $video_direction['selected_keywords'] ) && is_array( $video_direction['selected_keywords'] ) ) {
                    $selected_keywords = array_filter( array_map( 'absint', $video_direction['selected_keywords'] ) );
                }
                if ( isset( $video_direction['note'] ) ) {
                    $direction_note = sanitize_textarea_field( $video_direction['note'] );
                }
            }
        }
        $direction_keyword_count = is_array( $selected_keywords ) ? count( $selected_keywords ) : 0;
        $note_present = ! empty( $direction_note ) && trim( $direction_note ) !== '';

        $keyword_names = array();
        if ( ! empty( $selected_keywords ) ) {
            $placeholders = implode( ',', array_fill( 0, count( $selected_keywords ), '%d' ) );
            $keywords = $wpdb->get_results( $wpdb->prepare(
                "SELECT keyword FROM {$keywords_table} WHERE keyword_id IN ({$placeholders}) AND is_active = 1 ORDER BY keyword",
                ...$selected_keywords
            ), ARRAY_A );
            foreach ( $keywords as $kw ) {
                if ( isset( $kw['keyword'] ) ) {
                    $keyword_names[] = sanitize_text_field( $kw['keyword'] );
                }
            }
        }

        // Compose supplier handoff message (queue-level, thread-only)
        $msg_lines = array();
        $msg_lines[] = "Approved CAD Released";
        $msg_lines[] = "Item #{$item_id} / Bid #{$bid_id}";
        $msg_lines[] = "CAD Version: v{$approved_version}";
        $msg_lines[] = "";
        $msg_lines[] = "CAD Files:";
        $msg_lines = array_merge( $msg_lines, $file_lines );
        $msg_lines[] = "";
        $msg_lines[] = "Direction Keywords (" . intval( $direction_keyword_count ) . "):";
        if ( ! empty( $keyword_names ) ) {
            foreach ( $keyword_names as $kw_name ) {
                $msg_lines[] = '- ' . $kw_name;
            }
        } else {
            $msg_lines[] = '- (none)';
        }
        if ( $note_present ) {
            $msg_lines[] = "";
            $msg_lines[] = "Direction Note:";
            $msg_lines[] = $direction_note;
        }

        $message_text = implode( "\n", $msg_lines );

        $this->n88_insert_item_message(
            'supplier_operator',
            $item_id,
            'operator',
            $current_user->ID,
            $message_text,
            'CAD',
            $bid_id,
            $supplier_id,
            null
        );

        // Update payment release marker (idempotency guard)
        $pp_columns = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
        $update_data = array(
            'cad_released_to_supplier_at' => current_time( 'mysql' ),
        );
        $update_format = array( '%s' );
        if ( in_array( 'updated_at', $pp_columns, true ) ) {
            $update_data['updated_at'] = current_time( 'mysql' );
            $update_format[] = '%s';
        }

        $wpdb->update(
            $prototype_payments_table,
            $update_data,
            array( 'id' => $payment_id ),
            $update_format,
            array( '%d' )
        );

        // Immutable event: cad_released_to_supplier (once per payment_id by released_at guard)
        if ( function_exists( 'n88_log_event' ) ) {
            n88_log_event(
                'cad_released_to_supplier',
                'prototype_payment',
                array(
                    'object_id' => $payment_id,
                    'item_id'   => $item_id,
                    'payload_json' => array(
                        'payment_id'             => $payment_id,
                        'item_id'                => $item_id,
                        'bid_id'                 => $bid_id,
                        'supplier_id'            => $supplier_id,
                        'operator_user_id'       => $current_user->ID,
                        'approved_version'       => $approved_version,
                        'direction_keyword_count'=> $direction_keyword_count,
                        'note_present'           => $note_present,
                        'timestamp'              => current_time( 'mysql' ),
                    ),
                )
            );
        }

        wp_send_json_success( array(
            'released_at' => current_time( 'mysql' ),
        ) );
    }

    /**
     * Commit 2.3.9.2B-S: Supplier submits prototype video links (append-only, versioned)
     */
    public function ajax_submit_prototype_video() {
        check_ajax_referer( 'n88_submit_prototype_video', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        
        if ( ! $is_supplier ) {
            wp_send_json_error( array( 'message' => 'Access denied. Supplier access required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        $video_links_json = isset( $_POST['video_links'] ) ? wp_unslash( $_POST['video_links'] ) : '';
        $video_links = array();
        
        if ( ! empty( $video_links_json ) ) {
            $decoded = json_decode( $video_links_json, true );
            if ( is_array( $decoded ) ) {
                $video_links = $decoded;
            }
        }

        if ( ! $payment_id ) {
            wp_send_json_error( array( 'message' => 'Invalid payment ID.' ) );
            return;
        }

        if ( ! is_array( $video_links ) || empty( $video_links ) ) {
            wp_send_json_error( array( 'message' => 'At least one video link is required.' ) );
            return;
        }

        if ( count( $video_links ) > 3 ) {
            wp_send_json_error( array( 'message' => 'Maximum 3 video links allowed per submission.' ) );
            return;
        }

        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $submissions_table = $wpdb->prefix . 'n88_prototype_video_submissions';
        $links_table = $wpdb->prefix . 'n88_prototype_video_links';

        // Check preconditions: payment marked_received + CAD approved
        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, item_id, bid_id, supplier_id, status, received_at, cad_status, cad_approved_at
             FROM {$prototype_payments_table}
             WHERE id = %d",
            $payment_id
        ), ARRAY_A );

        if ( ! $payment ) {
            wp_send_json_error( array( 'message' => 'Payment record not found.' ) );
            return;
        }

        if ( $payment['status'] !== 'marked_received' || empty( $payment['received_at'] ) ) {
            wp_send_json_error( array( 'message' => 'Payment must be marked as received before submitting prototype video.' ) );
            return;
        }

        if ( $payment['cad_status'] !== 'approved' || empty( $payment['cad_approved_at'] ) ) {
            wp_send_json_error( array( 'message' => 'CAD must be approved before submitting prototype video.' ) );
            return;
        }

        // Verify supplier owns this payment
        if ( intval( $payment['supplier_id'] ) !== $current_user->ID ) {
            wp_send_json_error( array( 'message' => 'Access denied. You can only submit videos for your own payments.' ) );
            return;
        }

        $item_id = absint( $payment['item_id'] );
        $bid_id = absint( $payment['bid_id'] );
        $supplier_id = absint( $payment['supplier_id'] );

        // Validate and parse video links
        $validated_links = array();
        $allowed_providers = array( 'youtube', 'vimeo', 'loom' );
        
        foreach ( $video_links as $index => $link_data ) {
            if ( ! is_array( $link_data ) || ! isset( $link_data['provider'] ) || ! isset( $link_data['url'] ) ) {
                continue;
            }

            $provider = sanitize_text_field( $link_data['provider'] );
            $url = esc_url_raw( trim( $link_data['url'] ) );

            if ( ! in_array( $provider, $allowed_providers, true ) ) {
                wp_send_json_error( array( 'message' => 'Invalid provider. Only YouTube, Vimeo, and Loom are allowed.' ) );
                return;
            }

            if ( empty( $url ) ) {
                continue; // Skip empty URLs
            }

            // Validate URL format for each provider
            $is_valid = false;
            if ( $provider === 'youtube' ) {
                // YouTube: youtube.com/watch?v=, youtu.be/, youtube.com/embed/
                $is_valid = ( preg_match( '/youtube\.com\/(watch\?v=|embed\/)/', $url ) || preg_match( '/youtu\.be\//', $url ) );
            } elseif ( $provider === 'vimeo' ) {
                // Vimeo: vimeo.com/
                $is_valid = preg_match( '/vimeo\.com\//', $url );
            } elseif ( $provider === 'loom' ) {
                // Loom: loom.com/share/
                $is_valid = preg_match( '/loom\.com\/share\//', $url );
            }

            if ( ! $is_valid ) {
                wp_send_json_error( array( 'message' => 'Invalid ' . ucfirst( $provider ) . ' URL format. Please check the URL.' ) );
                return;
            }

            $validated_links[] = array(
                'provider' => $provider,
                'url' => $url,
                'sort_order' => $index,
            );
        }

        if ( empty( $validated_links ) ) {
            wp_send_json_error( array( 'message' => 'No valid video links provided.' ) );
            return;
        }

        // Get next version number (append-only)
        $max_version = $wpdb->get_var( $wpdb->prepare(
            "SELECT MAX(version) FROM {$submissions_table} WHERE payment_id = %d",
            $payment_id
        ) );
        $next_version = $max_version ? ( intval( $max_version ) + 1 ) : 1;
        $link_count = count( $validated_links );

        // Insert submission record
        $submission_result = $wpdb->insert(
            $submissions_table,
            array(
                'payment_id' => $payment_id,
                'item_id' => $item_id,
                'bid_id' => $bid_id,
                'supplier_id' => $supplier_id,
                'version' => $next_version,
                'link_count' => $link_count,
                'created_at' => current_time( 'mysql' ),
            ),
            array( '%d', '%d', '%d', '%d', '%d', '%d', '%s' )
        );

        if ( ! $submission_result ) {
            wp_send_json_error( array( 'message' => 'Failed to create submission record.' ) );
            return;
        }

        $submission_id = $wpdb->insert_id;

        // Insert link records
        foreach ( $validated_links as $link ) {
            $link_result = $wpdb->insert(
                $links_table,
                array(
                    'submission_id' => $submission_id,
                    'provider' => $link['provider'],
                    'url' => $link['url'],
                    'sort_order' => $link['sort_order'],
                    'created_at' => current_time( 'mysql' ),
                ),
                array( '%d', '%s', '%s', '%d', '%s' )
            );

            if ( ! $link_result ) {
                // Rollback: delete submission if links fail
                $wpdb->delete( $submissions_table, array( 'id' => $submission_id ), array( '%d' ) );
                wp_send_json_error( array( 'message' => 'Failed to save video links.' ) );
                return;
            }
        }

        // Update prototype_status to 'submitted' (or update if was 'changes_requested')
        $wpdb->update(
            $prototype_payments_table,
            array(
                'prototype_status' => 'submitted',
                'prototype_current_version' => $next_version,
                'updated_at' => current_time( 'mysql' ),
            ),
            array( 'id' => $payment_id ),
            array( '%s', '%d', '%s' ),
            array( '%d' )
        );
        
        // Immutable event: prototype_video_submitted
        if ( function_exists( 'n88_log_event' ) ) {
            n88_log_event(
                'prototype_video_submitted',
                'prototype_payment',
                array(
                    'object_id' => $payment_id,
                    'item_id'   => $item_id,
                    'payload_json' => array(
                        'payment_id'  => $payment_id,
                        'item_id'     => $item_id,
                        'bid_id'      => $bid_id,
                        'supplier_id' => $supplier_id,
                        'version'     => $next_version,
                        'link_count'  => $link_count,
                        'timestamp'   => current_time( 'mysql' ),
                    ),
                )
            );
        }

        wp_send_json_success( array(
            'submission_id' => $submission_id,
            'version' => $next_version,
            'link_count' => $link_count,
            'message' => 'Prototype video submitted successfully (v' . $next_version . ').',
        ) );
    }
    
    /**
     * Commit 2.3.9.2B-D: AJAX handler to approve prototype video
     */
    public function ajax_approve_prototype() {
        check_ajax_referer( 'n88_approve_prototype', '_ajax_nonce' );
        
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }
        
        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        if ( ! $is_designer ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer access required.' ) );
            return;
        }
        
        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;
        $version = isset( $_POST['version'] ) ? absint( $_POST['version'] ) : 0;
        
        if ( ! $payment_id || ! $item_id || ! $bid_id || ! $version ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters.' ) );
            return;
        }
        
        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        
        // Verify payment belongs to designer
        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, designer_user_id, prototype_status FROM {$prototype_payments_table}
            WHERE id = %d AND item_id = %d AND bid_id = %d",
            $payment_id, $item_id, $bid_id
        ), ARRAY_A );
        
        if ( ! $payment || intval( $payment['designer_user_id'] ) !== $current_user->ID ) {
            wp_send_json_error( array( 'message' => 'Access denied or payment not found.' ) );
            return;
        }
        
        // Update prototype status
        $wpdb->update(
            $prototype_payments_table,
            array(
                'prototype_status' => 'approved',
                'prototype_approved_at' => current_time( 'mysql' ),
                'prototype_approved_version' => $version,
                'updated_at' => current_time( 'mysql' ),
            ),
            array( 'id' => $payment_id ),
            array( '%s', '%s', '%d', '%s' ),
            array( '%d' )
        );
        
        // Log event
        if ( function_exists( 'n88_log_event' ) ) {
            n88_log_event(
                'prototype_video_approved',
                'prototype_payment',
                array(
                    'object_id' => $payment_id,
                    'item_id' => $item_id,
                    'payload_json' => array(
                        'payment_id' => $payment_id,
                        'item_id' => $item_id,
                        'bid_id' => $bid_id,
                        'designer_id' => $current_user->ID,
                        'approved_version' => $version,
                        'timestamp' => current_time( 'mysql' ),
                    ),
                )
            );
        }
        // Commit 3.A.1: Timeline step 3 complete
        if ( class_exists( 'N88_Item_Timeline' ) ) {
            N88_Item_Timeline::sync_from_prototype_approved( $item_id );
        }
        
        wp_send_json_success( array(
            'message' => 'Prototype approved successfully.',
        ) );
    }
    
    /**
     * Commit 2.3.9.2B-D: AJAX handler to request prototype changes
     */
    public function ajax_request_prototype_changes() {
        check_ajax_referer( 'n88_request_prototype_changes', '_ajax_nonce' );
        
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }
        
        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        if ( ! $is_designer ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer access required.' ) );
            return;
        }
        
        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;
        $submission_version = isset( $_POST['submission_version'] ) ? absint( $_POST['submission_version'] ) : 0;
        $feedback_packet_raw = isset( $_POST['feedback_packet'] ) ? wp_unslash( $_POST['feedback_packet'] ) : '';
        
        if ( ! $payment_id || ! $item_id || ! $bid_id || ! $submission_version ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters.' ) );
            return;
        }
        
        $feedback_packet = json_decode( $feedback_packet_raw, true );
        if ( ! is_array( $feedback_packet ) || empty( $feedback_packet ) ) {
            wp_send_json_error( array( 'message' => 'Invalid feedback packet.' ) );
            return;
        }
        
        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $feedback_packets_table = $wpdb->prefix . 'n88_prototype_feedback_packets';
        $feedback_packet_lines_table = $wpdb->prefix . 'n88_prototype_feedback_packet_lines';
        
        // Verify payment belongs to designer
        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, designer_user_id FROM {$prototype_payments_table}
            WHERE id = %d AND item_id = %d AND bid_id = %d",
            $payment_id, $item_id, $bid_id
        ), ARRAY_A );
        
        if ( ! $payment || intval( $payment['designer_user_id'] ) !== $current_user->ID ) {
            wp_send_json_error( array( 'message' => 'Access denied or payment not found.' ) );
            return;
        }
        
        // Validate feedback packet (max 18 phrases total)
        $total_phrases = 0;
        $keyword_results = array();
        foreach ( $feedback_packet as $keyword_id => $data ) {
            $keyword_id_int = absint( $keyword_id );
            $status = isset( $data['status'] ) ? sanitize_text_field( $data['status'] ) : '';
            $severity = isset( $data['severity'] ) ? sanitize_text_field( $data['severity'] ) : null;
            $phrase_ids = isset( $data['phrase_ids'] ) && is_array( $data['phrase_ids'] ) ? array_map( 'absint', $data['phrase_ids'] ) : array();
            
            if ( ! in_array( $status, array( 'satisfied', 'needs_adjustment', 'not_addressed' ), true ) ) {
                wp_send_json_error( array( 'message' => 'Invalid keyword status.' ) );
                return;
            }
            
            if ( $status !== 'satisfied' && count( $phrase_ids ) > 3 ) {
                wp_send_json_error( array( 'message' => 'Maximum 3 phrases per keyword.' ) );
                return;
            }
            
            if ( $status !== 'satisfied' && $severity && ! in_array( $severity, array( 'must_fix', 'should_fix', 'optional' ), true ) ) {
                wp_send_json_error( array( 'message' => 'Invalid severity.' ) );
                return;
            }
            
            $total_phrases += count( $phrase_ids );
            $keyword_results[] = array(
                'keyword_id' => $keyword_id_int,
                'keyword_status' => $status,
                'severity' => $severity,
                'selected_phrase_ids' => $phrase_ids,
            );
        }
        
        if ( $total_phrases > 18 ) {
            wp_send_json_error( array( 'message' => 'Maximum 18 phrases total per packet.' ) );
            return;
        }
        
        // Insert feedback packet
        $wpdb->insert(
            $feedback_packets_table,
            array(
                'payment_id' => $payment_id,
                'item_id' => $item_id,
                'bid_id' => $bid_id,
                'designer_id' => $current_user->ID,
                'submission_version' => $submission_version,
                'created_at' => current_time( 'mysql' ),
            ),
            array( '%d', '%d', '%d', '%d', '%d', '%s' )
        );
        
        $feedback_packet_id = $wpdb->insert_id;
        if ( ! $feedback_packet_id ) {
            wp_send_json_error( array( 'message' => 'Failed to create feedback packet.' ) );
            return;
        }
        
        // Insert feedback packet lines
        foreach ( $keyword_results as $result ) {
            $wpdb->insert(
                $feedback_packet_lines_table,
                array(
                    'feedback_packet_id' => $feedback_packet_id,
                    'keyword_id' => $result['keyword_id'],
                    'keyword_status' => $result['keyword_status'],
                    'severity' => $result['severity'],
                    'selected_phrase_ids' => wp_json_encode( $result['selected_phrase_ids'] ),
                    'created_at' => current_time( 'mysql' ),
                ),
                array( '%d', '%d', '%s', '%s', '%s', '%s' )
            );
        }
        
        // Update prototype status
        $wpdb->update(
            $prototype_payments_table,
            array(
                'prototype_status' => 'changes_requested',
                'updated_at' => current_time( 'mysql' ),
            ),
            array( 'id' => $payment_id ),
            array( '%s', '%s' ),
            array( '%d' )
        );
        
        // Log event
        if ( function_exists( 'n88_log_event' ) ) {
            n88_log_event(
                'prototype_video_changes_requested',
                'prototype_payment',
                array(
                    'object_id' => $payment_id,
                    'item_id' => $item_id,
                    'payload_json' => array(
                        'payment_id' => $payment_id,
                        'item_id' => $item_id,
                        'bid_id' => $bid_id,
                        'designer_id' => $current_user->ID,
                        'submission_version' => $submission_version,
                        'keyword_results' => $keyword_results,
                        'timestamp' => current_time( 'mysql' ),
                    ),
                )
            );
        }
        
        wp_send_json_success( array(
            'message' => 'Changes requested successfully.',
        ) );
    }
    
    /**
     * Commit 2.3.9.2B-D: AJAX handler to get keyword phrases for selected keywords
     */
    public function ajax_get_keyword_phrases() {
        check_ajax_referer( 'n88_get_keyword_phrases', '_ajax_nonce' );
        
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }
        
        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        
        if ( ! $is_designer ) {
            wp_send_json_error( array( 'message' => 'Access denied. Designer access required.' ) );
            return;
        }
        
        $keyword_ids_raw = isset( $_POST['keyword_ids'] ) ? wp_unslash( $_POST['keyword_ids'] ) : '';
        $keyword_ids = json_decode( $keyword_ids_raw, true );
        
        if ( ! is_array( $keyword_ids ) || empty( $keyword_ids ) ) {
            wp_send_json_error( array( 'message' => 'Invalid keyword IDs.' ) );
            return;
        }
        
        $keyword_ids = array_map( 'absint', $keyword_ids );
        
        global $wpdb;
        $keyword_phrases_table = $wpdb->prefix . 'n88_keyword_phrases';
        $keywords_table = $wpdb->prefix . 'n88_keywords';
        
        // Get keyword names
        $placeholders = implode( ',', array_fill( 0, count( $keyword_ids ), '%d' ) );
        $keywords = $wpdb->get_results( $wpdb->prepare(
            "SELECT keyword_id, keyword FROM {$keywords_table}
            WHERE keyword_id IN ({$placeholders})",
            ...$keyword_ids
        ), ARRAY_A );
        
        $keyword_names = array();
        foreach ( $keywords as $keyword ) {
            $keyword_names[ intval( $keyword['keyword_id'] ) ] = $keyword['keyword'];
        }
        
        // Get phrases
        $phrases = $wpdb->get_results( $wpdb->prepare(
            "SELECT phrase_id, keyword_id, phrase_text
            FROM {$keyword_phrases_table}
            WHERE keyword_id IN ({$placeholders})
            AND is_active = 1
            ORDER BY keyword_id, sort_order ASC, phrase_id ASC",
            ...$keyword_ids
        ), ARRAY_A );
        
        // Group phrases by keyword_id
        $phrases_by_keyword = array();
        foreach ( $phrases as $phrase ) {
            $keyword_id = intval( $phrase['keyword_id'] );
            if ( ! isset( $phrases_by_keyword[ $keyword_id ] ) ) {
                $phrases_by_keyword[ $keyword_id ] = array();
            }
            $phrases_by_keyword[ $keyword_id ][] = array(
                'phrase_id' => intval( $phrase['phrase_id'] ),
                'phrase_text' => $phrase['phrase_text'],
            );
        }
        
        wp_send_json_success( array(
            'phrases_by_keyword' => $phrases_by_keyword,
            'keyword_names' => $keyword_names,
        ) );
    }

    /**
     * Commit 3.A.1: Return true if current user can view item timeline (designer owner, operator, or supplier with route/bid/prototype).
     */
    private function user_can_view_item_timeline( $item_id ) {
        global $wpdb;
        $user_id = get_current_user_id();
        if ( ! $user_id ) {
            return false;
        }
        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        if ( $is_operator || current_user_can( 'manage_options' ) ) {
            return true;
        }
        $items_table = $wpdb->prefix . 'n88_items';
        $item = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, owner_user_id FROM {$items_table} WHERE id = %d AND deleted_at IS NULL",
            $item_id
        ) );
        if ( ! $item ) {
            return false;
        }
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        if ( $is_designer && (int) $item->owner_user_id === $user_id ) {
            return true;
        }
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true ) || in_array( 'n88_supplier', $current_user->roles, true ) || in_array( 'supplier', $current_user->roles, true );
        if ( $is_supplier ) {
            $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
            $item_bids_table = $wpdb->prefix . 'n88_item_bids';
            $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';

            $has_route = $wpdb->get_var( $wpdb->prepare(
                "SELECT 1 FROM {$rfq_routes_table} WHERE item_id = %d AND supplier_id = %d LIMIT 1",
                $item_id,
                $user_id
            ) );
            if ( $has_route ) {
                return true;
            }
            $has_bid = $wpdb->get_var( $wpdb->prepare(
                "SELECT 1 FROM {$item_bids_table} WHERE item_id = %d AND supplier_id = %d LIMIT 1",
                $item_id,
                $user_id
            ) );
            if ( $has_bid ) {
                return true;
            }
            if ( $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table ) {
                $has_prototype = $wpdb->get_var( $wpdb->prepare(
                    "SELECT 1 FROM {$prototype_payments_table} WHERE item_id = %d AND supplier_id = %d LIMIT 1",
                    $item_id,
                    $user_id
                ) );
                if ( $has_prototype ) {
                    return true;
                }
            }
        }
        return false;
    }

    /**
     * Commit 3.A.1: AJAX get item timeline (read-only). Designer, supplier, operator.
     */
    public function ajax_get_item_timeline() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
        }
        if ( ! $this->user_can_view_item_timeline( $item_id ) ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ), 403 );
        }
        if ( ! class_exists( 'N88_Item_Timeline' ) ) {
            wp_send_json_error( array( 'message' => 'Timeline not available.' ) );
        }
        $timeline = N88_Item_Timeline::get_timeline_for_item( $item_id );
        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        $evidence_by_step = array();
        if ( class_exists( 'N88_Timeline_Step_Evidence' ) ) {
            $for_designer = ! $is_operator && ! current_user_can( 'manage_options' );
            $evidence_by_step = N88_Timeline_Step_Evidence::get_evidence_for_item( $item_id, $for_designer );
            if ( class_exists( 'N88_Evidence_Comments' ) ) {
                $evidence_by_step = $this->evidence_attach_comments( $evidence_by_step );
            }
        }
        $can_add_evidence_comment = $this->user_is_designer_owner_of_item( $item_id );
        $steps_with_supplier_evidence = array();
        $supplier_step_evidence_by_step = array();
        if ( class_exists( 'N88_Step_Evidence_Submissions' ) ) {
            $steps_with_supplier_evidence = N88_Step_Evidence_Submissions::get_steps_with_supplier_evidence( $item_id );
            $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true ) || in_array( 'n88_supplier', $current_user->roles, true ) || in_array( 'supplier', $current_user->roles, true );
            if ( $is_supplier && $this->supplier_has_route_to_item( $item_id, $current_user->ID ) ) {
                $supplier_step_evidence_by_step = N88_Step_Evidence_Submissions::get_by_item_for_supplier( $item_id, $current_user->ID );
            }
        }
        wp_send_json_success( array(
            'timeline'                       => $timeline,
            'is_operator'                    => $is_operator,
            'evidence_by_step'               => $evidence_by_step,
            'can_add_evidence_comment'       => $can_add_evidence_comment,
            'steps_with_supplier_evidence'   => $steps_with_supplier_evidence,
            'supplier_step_evidence_by_step' => $supplier_step_evidence_by_step,
        ) );
    }

    /**
     * Commit 3.A.3: True if current user is the designer (item owner) who may add evidence comments.
     */
    private function user_is_designer_owner_of_item( $item_id ) {
        global $wpdb;
        $user_id = get_current_user_id();
        if ( ! $item_id || ! $user_id ) {
            return false;
        }
        $items_table = $wpdb->prefix . 'n88_items';
        $owner = $wpdb->get_var( $wpdb->prepare( "SELECT owner_user_id FROM {$items_table} WHERE id = %d AND deleted_at IS NULL", $item_id ) );
        return $owner && (int) $owner === (int) $user_id;
    }

    /**
     * Commit 3.A.1: AJAX timeline start step (operator only).
     */
    public function ajax_timeline_start_step() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $current_user = wp_get_current_user();
        if ( ! in_array( 'n88_system_operator', $current_user->roles, true ) && ! current_user_can( 'manage_options' ) ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator only.' ), 403 );
        }
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $step_number = isset( $_POST['step_number'] ) ? absint( $_POST['step_number'] ) : 0;
        if ( ! $item_id || $step_number < 1 || $step_number > 6 ) {
            wp_send_json_error( array( 'message' => 'Invalid item or step.' ) );
        }
        if ( ! class_exists( 'N88_Item_Timeline' ) ) {
            wp_send_json_error( array( 'message' => 'Timeline not available.' ) );
        }
        $result = N88_Item_Timeline::start_step( $item_id, $step_number, $current_user->ID );
        if ( ! empty( $result['success'] ) ) {
            wp_send_json_success( array( 'message' => $result['message'] ) );
        }
        wp_send_json_error( array( 'message' => isset( $result['message'] ) ? $result['message'] : 'Action failed.' ) );
    }

    /**
     * Commit 3.A.1: AJAX timeline complete step (operator only). Evidence enforced.
     */
    public function ajax_timeline_complete_step() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $current_user = wp_get_current_user();
        if ( ! in_array( 'n88_system_operator', $current_user->roles, true ) && ! current_user_can( 'manage_options' ) ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator only.' ), 403 );
        }
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $step_number = isset( $_POST['step_number'] ) ? absint( $_POST['step_number'] ) : 0;
        $evidence_override = isset( $_POST['evidence_override'] ) && $_POST['evidence_override'] === '1';
        if ( ! $item_id || $step_number < 1 || $step_number > 6 ) {
            wp_send_json_error( array( 'message' => 'Invalid item or step.' ) );
        }
        if ( ! class_exists( 'N88_Item_Timeline' ) ) {
            wp_send_json_error( array( 'message' => 'Timeline not available.' ) );
        }
        $result = N88_Item_Timeline::complete_step( $item_id, $step_number, $current_user->ID, $evidence_override );
        if ( ! empty( $result['success'] ) ) {
            wp_send_json_success( array( 'message' => $result['message'] ) );
        }
        wp_send_json_error( array(
            'message' => isset( $result['message'] ) ? $result['message'] : 'Action failed.',
            'blocked' => ! empty( $result['blocked'] ),
        ) );
    }

    /**
     * Commit 3.A.1: AJAX timeline set evidence verified (operator only).
     */
    public function ajax_timeline_set_evidence_verified() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $current_user = wp_get_current_user();
        if ( ! in_array( 'n88_system_operator', $current_user->roles, true ) && ! current_user_can( 'manage_options' ) ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator only.' ), 403 );
        }
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $step_number = isset( $_POST['step_number'] ) ? absint( $_POST['step_number'] ) : 0;
        if ( ! $item_id || $step_number < 1 || $step_number > 6 ) {
            wp_send_json_error( array( 'message' => 'Invalid item or step.' ) );
        }
        if ( ! class_exists( 'N88_Item_Timeline' ) ) {
            wp_send_json_error( array( 'message' => 'Timeline not available.' ) );
        }
        $result = N88_Item_Timeline::set_evidence_verified( $item_id, $step_number, $current_user->ID );
        if ( ! empty( $result['success'] ) ) {
            wp_send_json_success( array( 'message' => $result['message'] ) );
        }
        wp_send_json_error( array( 'message' => isset( $result['message'] ) ? $result['message'] : 'Action failed.' ) );
    }

    /**
     * Commit 3.A.2: Upload timeline step evidence (operator/admin only). Append-only.
     */
    public function ajax_upload_timeline_step_evidence() {
        check_ajax_referer( 'n88_timeline_step_evidence', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        $is_admin   = current_user_can( 'manage_options' );
        if ( ! $is_operator && ! $is_admin ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator or Admin only.' ), 403 );
        }
        $item_id   = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $step_id   = isset( $_POST['step_id'] ) ? absint( $_POST['step_id'] ) : 0;
        $media_type = isset( $_POST['media_type'] ) ? sanitize_text_field( $_POST['media_type'] ) : 'image';
        if ( ! $item_id || ! $step_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item or step.' ) );
        }
        if ( ! class_exists( 'N88_Timeline_Step_Evidence' ) ) {
            wp_send_json_error( array( 'message' => 'Evidence not available.' ) );
        }
        // Commit 3.A.2: Evidence automatically goes to media library and material bank (no optional flags).
        $options = array(
            'add_to_media_library' => true,
            'add_to_material_bank' => true,
        );
        if ( $media_type === 'youtube' ) {
            $options['youtube_url'] = isset( $_POST['youtube_url'] ) ? esc_url_raw( trim( $_POST['youtube_url'] ) ) : '';
            $result = N88_Timeline_Step_Evidence::add_evidence( $item_id, $step_id, 'youtube', $options, $current_user->ID );
        } else {
            $allowed_image = array( 'image/jpeg', 'image/png', 'image/gif', 'image/webp' );
            $allowed_pdf  = array( 'application/pdf' );
            if ( ! empty( $_FILES['evidence_file']['tmp_name'] ) && is_uploaded_file( $_FILES['evidence_file']['tmp_name'] ) ) {
                require_once ABSPATH . 'wp-admin/includes/file.php';
                require_once ABSPATH . 'wp-admin/includes/image.php';
                require_once ABSPATH . 'wp-admin/includes/media.php';
                $file = $_FILES['evidence_file'];
                $type = wp_check_filetype( $file['name'], null )['type'];
                $is_image = in_array( $type, $allowed_image, true );
                $is_pdf   = in_array( $type, $allowed_pdf, true );
                if ( ! $is_image && ! $is_pdf ) {
                    wp_send_json_error( array( 'message' => 'Allowed: images (JPEG, PNG, GIF, WebP) or PDF.' ) );
                }
                $upload = wp_handle_upload( $file, array( 'test_form' => false ) );
                if ( isset( $upload['error'] ) ) {
                    wp_send_json_error( array( 'message' => $upload['error'] ) );
                }
                $attachment = array(
                    'post_mime_type' => $upload['type'],
                    'post_title'     => sanitize_file_name( $file['name'] ),
                    'post_content'   => '',
                    'post_status'   => 'inherit',
                );
                $attach_id = wp_insert_attachment( $attachment, $upload['file'] );
                if ( is_wp_error( $attach_id ) ) {
                    wp_send_json_error( array( 'message' => $attach_id->get_error_message() ) );
                }
                $attach_data = wp_generate_attachment_metadata( $attach_id, $upload['file'] );
                if ( is_array( $attach_data ) ) {
                    wp_update_attachment_metadata( $attach_id, $attach_data );
                }
                $options['attachment_id'] = $attach_id;
                $options['file_path']     = null;
                $result = N88_Timeline_Step_Evidence::add_evidence( $item_id, $step_id, $is_pdf ? 'pdf' : 'image', $options, $current_user->ID );
            } else {
                wp_send_json_error( array( 'message' => 'Upload a file or provide a YouTube URL.' ) );
            }
        }
        if ( ! empty( $result['success'] ) ) {
            wp_send_json_success( array( 'message' => $result['message'], 'evidence_id' => isset( $result['evidence_id'] ) ? $result['evidence_id'] : 0 ) );
        }
        wp_send_json_error( array( 'message' => isset( $result['message'] ) ? $result['message'] : 'Upload failed.' ) );
    }

    /**
     * Commit 3.A.2: Get timeline step evidence. Designers get watermarked view URLs only.
     */
    public function ajax_get_timeline_step_evidence() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $step_id = isset( $_POST['step_id'] ) ? absint( $_POST['step_id'] ) : 0;
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item.' ) );
        }
        if ( ! $this->user_can_view_item_timeline( $item_id ) ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ), 403 );
        }
        if ( ! class_exists( 'N88_Timeline_Step_Evidence' ) ) {
            wp_send_json_success( array( 'evidence' => array(), 'by_step' => array() ) );
            return;
        }
        $current_user = wp_get_current_user();
        $for_designer = ! in_array( 'n88_system_operator', $current_user->roles, true ) && ! current_user_can( 'manage_options' );
        if ( $step_id ) {
            $evidence = N88_Timeline_Step_Evidence::get_evidence_for_step( $item_id, $step_id, $for_designer );
            if ( class_exists( 'N88_Evidence_Comments' ) ) {
                $evidence = $this->evidence_attach_comments_list( $evidence );
            }
            wp_send_json_success( array( 'evidence' => $evidence ) );
        }
        $by_step = N88_Timeline_Step_Evidence::get_evidence_for_item( $item_id, $for_designer );
        if ( class_exists( 'N88_Evidence_Comments' ) ) {
            $by_step = $this->evidence_attach_comments( $by_step );
        }
        wp_send_json_success( array( 'by_step' => $by_step ) );
    }

    /**
     * Commit 3.A.3: Attach comments to evidence_by_step (step_id => list of evidence). Mutates and returns.
     */
    private function evidence_attach_comments( $evidence_by_step ) {
        if ( ! is_array( $evidence_by_step ) || ! class_exists( 'N88_Evidence_Comments' ) ) {
            return $evidence_by_step;
        }
        $all_ids = array();
        foreach ( $evidence_by_step as $list ) {
            foreach ( $list as $ev ) {
                if ( ! empty( $ev['id'] ) ) {
                    $all_ids[] = (int) $ev['id'];
                }
            }
        }
        if ( empty( $all_ids ) ) {
            return $evidence_by_step;
        }
        $comments_by_evidence = N88_Evidence_Comments::get_comments_for_evidence_batch( $all_ids );
        foreach ( $evidence_by_step as $step_id => $list ) {
            foreach ( $list as $i => $ev ) {
                $eid = isset( $ev['id'] ) ? (int) $ev['id'] : 0;
                $evidence_by_step[ $step_id ][ $i ]['comments'] = isset( $comments_by_evidence[ $eid ] ) ? $comments_by_evidence[ $eid ] : array();
            }
        }
        return $evidence_by_step;
    }

    /**
     * Commit 3.A.3: Attach comments to a flat evidence list.
     */
    private function evidence_attach_comments_list( $evidence_list ) {
        if ( ! is_array( $evidence_list ) || ! class_exists( 'N88_Evidence_Comments' ) ) {
            return $evidence_list;
        }
        $all_ids = array();
        foreach ( $evidence_list as $ev ) {
            if ( ! empty( $ev['id'] ) ) {
                $all_ids[] = (int) $ev['id'];
            }
        }
        if ( empty( $all_ids ) ) {
            return $evidence_list;
        }
        $comments_by_evidence = N88_Evidence_Comments::get_comments_for_evidence_batch( $all_ids );
        foreach ( $evidence_list as $i => $ev ) {
            $eid = isset( $ev['id'] ) ? (int) $ev['id'] : 0;
            $evidence_list[ $i ]['comments'] = isset( $comments_by_evidence[ $eid ] ) ? $comments_by_evidence[ $eid ] : array();
        }
        return $evidence_list;
    }

    /**
     * Commit 3.A.2: Serve evidence file (watermarked for designers, original for operator/admin).
     */
    public function ajax_serve_timeline_evidence() {
        $evidence_id = isset( $_GET['id'] ) ? absint( $_GET['id'] ) : 0;
        $nonce = isset( $_GET['nonce'] ) ? sanitize_text_field( $_GET['nonce'] ) : '';
        if ( ! $evidence_id || ! wp_verify_nonce( $nonce, 'n88_serve_timeline_evidence_' . $evidence_id ) ) {
            status_header( 404 );
            exit;
        }
        if ( ! is_user_logged_in() ) {
            status_header( 403 );
            exit;
        }
        if ( ! class_exists( 'N88_Timeline_Step_Evidence' ) ) {
            status_header( 404 );
            exit;
        }
        $row = N88_Timeline_Step_Evidence::get_evidence_by_id( $evidence_id );
        if ( ! $row ) {
            status_header( 404 );
            exit;
        }
        $item_id = (int) $row['item_id'];
        if ( ! $this->user_can_view_item_timeline( $item_id ) ) {
            status_header( 403 );
            exit;
        }
        $current_user = wp_get_current_user();
        $force_watermark = ! in_array( 'n88_system_operator', $current_user->roles, true ) && ! current_user_can( 'manage_options' );
        N88_Timeline_Step_Evidence::serve_evidence( $evidence_id, $force_watermark );
    }

    /**
     * Commit 3.A.3: Add comment to evidence. Designer (item owner) only. Immutable.
     */
    public function ajax_add_evidence_comment() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $evidence_id  = isset( $_POST['evidence_id'] ) ? absint( $_POST['evidence_id'] ) : 0;
        $comment_text = isset( $_POST['comment_text'] ) ? trim( (string) $_POST['comment_text'] ) : '';
        if ( ! $evidence_id ) {
            wp_send_json_error( array( 'message' => 'Invalid evidence.' ) );
        }
        if ( ! class_exists( 'N88_Timeline_Step_Evidence' ) || ! class_exists( 'N88_Evidence_Comments' ) ) {
            wp_send_json_error( array( 'message' => 'Comments not available.' ) );
        }
        $row = N88_Timeline_Step_Evidence::get_evidence_by_id( $evidence_id );
        if ( ! $row ) {
            wp_send_json_error( array( 'message' => 'Evidence not found.' ) );
        }
        $item_id = (int) $row['item_id'];
        if ( ! $this->user_can_view_item_timeline( $item_id ) ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ), 403 );
        }
        $current_user = wp_get_current_user();
        global $wpdb;
        $items_table = $wpdb->prefix . 'n88_items';
        $item = $wpdb->get_row( $wpdb->prepare( "SELECT owner_user_id FROM {$items_table} WHERE id = %d AND deleted_at IS NULL", $item_id ), ARRAY_A );
        $is_designer_owner = $item && (int) $item['owner_user_id'] === (int) $current_user->ID;
        if ( ! $is_designer_owner ) {
            wp_send_json_error( array( 'message' => 'Only the item owner (designer) may add comments.' ), 403 );
        }
        $result = N88_Evidence_Comments::add_comment( $evidence_id, $comment_text, $current_user->ID );
        if ( ! empty( $result['success'] ) ) {
            wp_send_json_success( array( 'message' => $result['message'], 'comment_id' => isset( $result['comment_id'] ) ? $result['comment_id'] : 0 ) );
        }
        wp_send_json_error( array( 'message' => isset( $result['message'] ) ? $result['message'] : 'Failed to add comment.' ) );
    }

    /**
     * Commit 3.A.3: Get comments for evidence. Designer + Operator/Admin (anyone who can view item timeline).
     */
    public function ajax_get_evidence_comments() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $evidence_id = isset( $_POST['evidence_id'] ) ? absint( $_POST['evidence_id'] ) : 0;
        if ( ! $evidence_id ) {
            wp_send_json_success( array( 'comments' => array() ) );
            return;
        }
        if ( ! class_exists( 'N88_Timeline_Step_Evidence' ) || ! class_exists( 'N88_Evidence_Comments' ) ) {
            wp_send_json_success( array( 'comments' => array() ) );
            return;
        }
        $row = N88_Timeline_Step_Evidence::get_evidence_by_id( $evidence_id );
        if ( ! $row ) {
            wp_send_json_error( array( 'message' => 'Evidence not found.' ) );
        }
        $item_id = (int) $row['item_id'];
        if ( ! $this->user_can_view_item_timeline( $item_id ) ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ), 403 );
        }
        $comments = N88_Evidence_Comments::get_comments_for_evidence( $evidence_id );
        wp_send_json_success( array( 'comments' => $comments ) );
    }

    /**
     * Commit 3.A.2S: Supplier submit step evidence (1â€“3 video links). Supplier must be routed; step in_progress or completed.
     */
    public function ajax_supplier_submit_step_evidence() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true ) || in_array( 'n88_supplier', $current_user->roles, true ) || in_array( 'supplier', $current_user->roles, true );
        if ( ! $is_supplier ) {
            wp_send_json_error( array( 'message' => 'Supplier access required.' ), 403 );
        }
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $step_id = isset( $_POST['step_id'] ) ? absint( $_POST['step_id'] ) : 0;
        $bid_id  = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : null;
        if ( ! $item_id || ! $step_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item or step.' ) );
        }
        if ( ! $this->supplier_has_route_to_item( $item_id, $current_user->ID ) ) {
            wp_send_json_error( array( 'message' => 'You are not routed to this item.' ), 403 );
        }
        if ( ! class_exists( 'N88_Step_Evidence_Submissions' ) ) {
            wp_send_json_error( array( 'message' => 'Step evidence not available.' ) );
        }
        if ( ! N88_Step_Evidence_Submissions::step_allows_submission( $step_id ) ) {
            wp_send_json_error( array( 'message' => 'Evidence can only be submitted when the step is In Progress or Completed.' ), 403 );
        }
        $urls = array();
        if ( ! empty( $_POST['url_1'] ) ) {
            $urls[] = trim( (string) $_POST['url_1'] );
        }
        if ( ! empty( $_POST['url_2'] ) ) {
            $urls[] = trim( (string) $_POST['url_2'] );
        }
        if ( ! empty( $_POST['url_3'] ) ) {
            $urls[] = trim( (string) $_POST['url_3'] );
        }
        $result = N88_Step_Evidence_Submissions::submit( $item_id, $step_id, $current_user->ID, $bid_id, $urls );
        if ( ! empty( $result['success'] ) ) {
            wp_send_json_success( array( 'message' => $result['message'], 'submission_id' => isset( $result['submission_id'] ) ? $result['submission_id'] : 0, 'version' => isset( $result['version'] ) ? $result['version'] : 0 ) );
        }
        wp_send_json_error( array( 'message' => isset( $result['message'] ) ? $result['message'] : 'Submit failed.' ) );
    }

    /**
     * Commit 3.A.2S: Get step evidence. Supplier: own only (by_item or by step). Designer: has_evidence + links (no identity). Operator: full.
     */
    public function ajax_get_step_evidence() {
        check_ajax_referer( 'n88_get_item_rfq_state', '_ajax_nonce' );
        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
        }
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $step_id = isset( $_POST['step_id'] ) ? absint( $_POST['step_id'] ) : 0;
        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        $is_admin   = current_user_can( 'manage_options' );
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true ) || in_array( 'n88_supplier', $current_user->roles, true ) || in_array( 'supplier', $current_user->roles, true );

        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item.' ) );
        }
        if ( ! class_exists( 'N88_Step_Evidence_Submissions' ) ) {
            wp_send_json_success( array( 'by_step' => array(), 'for_step' => null ) );
            return;
        }

        if ( $is_supplier ) {
            if ( ! $this->supplier_has_route_to_item( $item_id, $current_user->ID ) ) {
                wp_send_json_error( array( 'message' => 'Access denied.' ), 403 );
            }
            if ( $step_id ) {
                $latest = N88_Step_Evidence_Submissions::get_latest_for_supplier_step( $item_id, $step_id, $current_user->ID );
                wp_send_json_success( array( 'for_step' => $latest ) );
            }
            $by_step = N88_Step_Evidence_Submissions::get_by_item_for_supplier( $item_id, $current_user->ID );
            wp_send_json_success( array( 'by_step' => $by_step ) );
        }

        if ( ! $this->user_can_view_item_timeline( $item_id ) ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ), 403 );
        }
        $for_designer = ! $is_operator && ! $is_admin;
        if ( $step_id ) {
            $data = N88_Step_Evidence_Submissions::get_for_step_view( $item_id, $step_id, $for_designer );
            wp_send_json_success( array( 'for_step' => $data ) );
        }
        wp_send_json_success( array( 'for_step' => null ) );
    }

    /**
     * Commit 3.A.2S: True if supplier has a non-expired route to the item.
     */
    private function supplier_has_route_to_item( $item_id, $supplier_id ) {
        global $wpdb;
        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
        $this->check_and_update_expired_routes( $item_id, $supplier_id );
        $count = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM {$rfq_routes_table} WHERE item_id = %d AND supplier_id = %d AND (status IS NULL OR status != 'expired')",
            $item_id,
            $supplier_id
        ) );
        return $count > 0;
    }
    
    /**
     * AJAX handler to mark payment as received (Commit 2.3.9.1D)
     */
    public function ajax_mark_payment_received() {
        check_ajax_referer( 'n88_mark_payment_received', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator access required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;
        
        if ( ! $payment_id || ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters.' ) );
            return;
        }

        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        
        // Fetch current payment record to check status and get total_due_usd
        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT status, total_due_usd FROM {$prototype_payments_table} WHERE id = %d",
            $payment_id
        ), ARRAY_A );
        
        if ( ! $payment ) {
            wp_send_json_error( array( 'message' => 'Payment record not found.' ) );
            return;
        }
        
        // Idempotency check: status must be 'requested'
        if ( $payment['status'] !== 'requested' ) {
            wp_send_json_error( array( 'message' => 'Payment has already been confirmed or is in an invalid state.' ) );
            return;
        }
        
        $total_due_usd = floatval( $payment['total_due_usd'] );
        
        // Check if updated_at column exists
        $columns = $wpdb->get_col( "DESCRIBE {$prototype_payments_table}" );
        $has_updated_at = in_array( 'updated_at', $columns, true );
        
        // Prepare update data
        $update_data = array( 
            'status' => 'marked_received',
            'received_at' => current_time( 'mysql' )
        );
        $update_format = array( '%s', '%s' );
        
        if ( $has_updated_at ) {
            $update_data['updated_at'] = current_time( 'mysql' );
            $update_format[] = '%s';
        }
        
        // Update payment status and set received_at timestamp
        $update_result = $wpdb->update(
            $prototype_payments_table,
            $update_data,
            array( 'id' => $payment_id ),
            $update_format,
            array( '%d' )
        );

        if ( $update_result === false ) {
            wp_send_json_error( array( 'message' => 'Failed to update payment status.' ) );
            return;
        }

        // Log event (Commit 2.3.9.1D: Exact payload structure)
        n88_log_event(
            'payment_marked_received',
            'prototype_payment',
            array(
                'object_id' => $payment_id,
                'item_id' => $item_id,
                'payload_json' => array(
                    'payment_id' => $payment_id,
                    'item_id' => $item_id,
                    'bid_id' => $bid_id,
                    'operator_user_id' => $current_user->ID,
                    'total_due_usd' => $total_due_usd,
                    'timestamp' => current_time( 'mysql' ),
                ),
            )
        );

        // Commit 2.3.9.1F: Immutable Evidence Logging (idempotent - only if not already logged)
        $payment_evidence_logged_at = $wpdb->get_var( $wpdb->prepare(
            "SELECT payment_evidence_logged_at FROM {$prototype_payments_table} WHERE id = %d",
            $payment_id
        ) );
        
        if ( empty( $payment_evidence_logged_at ) ) {
            // Fetch payment details including CAD policy and video direction
            $payment_details = $wpdb->get_row( $wpdb->prepare(
                "SELECT cad_fee_usd, cad_revision_rounds_included, cad_revision_round_fee_usd, video_direction_json 
                FROM {$prototype_payments_table} 
                WHERE id = %d",
                $payment_id
            ), ARRAY_A );
            
            if ( $payment_details ) {
                $cad_fee_usd = isset( $payment_details['cad_fee_usd'] ) ? floatval( $payment_details['cad_fee_usd'] ) : 0.00;
                $cad_revision_rounds_included = isset( $payment_details['cad_revision_rounds_included'] ) ? intval( $payment_details['cad_revision_rounds_included'] ) : 0;
                $cad_revision_round_fee_usd = isset( $payment_details['cad_revision_round_fee_usd'] ) ? floatval( $payment_details['cad_revision_round_fee_usd'] ) : 0.00;
                $video_direction_json = isset( $payment_details['video_direction_json'] ) ? $payment_details['video_direction_json'] : '';
                
                // Parse video direction to get keyword count and note presence
                $video_direction = array();
                $video_direction_keyword_count = 0;
                $note_present = false;
                
                if ( ! empty( $video_direction_json ) ) {
                    $video_direction = json_decode( $video_direction_json, true );
                    if ( is_array( $video_direction ) ) {
                        $selected_keywords = isset( $video_direction['selected_keywords'] ) ? $video_direction['selected_keywords'] : array();
                        $video_direction_keyword_count = is_array( $selected_keywords ) ? count( $selected_keywords ) : 0;
                        $note = isset( $video_direction['note'] ) ? $video_direction['note'] : '';
                        $note_present = ! empty( $note ) && trim( $note ) !== '';
                    }
                }
                
                // Get operator_user_id (best effort; else null + source=system)
                $operator_user_id = $current_user->ID;
                if ( $operator_user_id === 0 || ! $is_operator ) {
                    $operator_user_id = null;
                }
                
                // Log immutable evidence event (Commit 2.3.9.1F)
                $evidence_event_result = n88_log_event(
                    'prototype_payment_marked_received',
                    'prototype_payment',
                    array(
                        'object_id' => $payment_id,
                        'item_id' => $item_id,
                        'payload_json' => array(
                            'payment_id' => $payment_id,
                            'item_id' => $item_id,
                            'bid_id' => $bid_id,
                            'operator_user_id' => $operator_user_id,
                            'cad_fee_usd' => $cad_fee_usd,
                            'cad_revision_rounds_included' => $cad_revision_rounds_included,
                            'cad_revision_round_fee_usd' => $cad_revision_round_fee_usd,
                            'video_direction_keyword_count' => $video_direction_keyword_count,
                            'note_present' => $note_present,
                            'timestamp' => current_time( 'mysql' ),
                        ),
                    )
                );
                
                // Set payment_evidence_logged_at to mark as logged (idempotency)
                if ( $evidence_event_result !== false ) {
                    $wpdb->update(
                        $prototype_payments_table,
                        array( 'payment_evidence_logged_at' => current_time( 'mysql' ) ),
                        array( 'id' => $payment_id ),
                        array( '%s' ),
                        array( '%d' )
                    );
                }
                // Commit 3.A.1: Timeline step 1 complete, step 2 start
                if ( class_exists( 'N88_Item_Timeline' ) ) {
                    N88_Item_Timeline::sync_from_payment_marked_received( $item_id );
                }
            }
        }

        // Commit 2.3.9.1E: Send notifications (idempotent - only if not already sent)
        $notifications_sent_at = $wpdb->get_var( $wpdb->prepare(
            "SELECT notifications_sent_at FROM {$prototype_payments_table} WHERE id = %d",
            $payment_id
        ) );
        
        if ( empty( $notifications_sent_at ) ) {
            // Fetch payment details including video direction
            $payment_details = $wpdb->get_row( $wpdb->prepare(
                "SELECT supplier_id, designer_user_id, video_direction_json, total_due_usd 
                FROM {$prototype_payments_table} 
                WHERE id = %d",
                $payment_id
            ), ARRAY_A );
            
            if ( $payment_details ) {
                $supplier_id = intval( $payment_details['supplier_id'] );
                $designer_user_id = intval( $payment_details['designer_user_id'] );
                $video_direction_json = $payment_details['video_direction_json'];
                $total_due_usd = floatval( $payment_details['total_due_usd'] );
                
                // Parse video direction to get keywords and note
                $video_direction = array();
                if ( ! empty( $video_direction_json ) ) {
                    $video_direction = json_decode( $video_direction_json, true );
                }
                $selected_keywords = isset( $video_direction['selected_keywords'] ) ? $video_direction['selected_keywords'] : array();
                $note = isset( $video_direction['note'] ) ? $video_direction['note'] : '';
                
                // Get keyword names from keywords table
                $keywords_table = $wpdb->prefix . 'n88_keywords';
                $keywords_list = array();
                if ( ! empty( $selected_keywords ) && is_array( $selected_keywords ) ) {
                    $keyword_ids = array_map( 'intval', $selected_keywords );
                    $keyword_ids = array_filter( $keyword_ids ); // Remove any zeros or invalid IDs
                    if ( ! empty( $keyword_ids ) ) {
                        $keyword_ids_safe = array_map( 'intval', $keyword_ids );
                        $keyword_ids_string = implode( ',', $keyword_ids_safe );
                        
                        $keywords_data = $wpdb->get_results(
                            "SELECT keyword_id, keyword FROM {$keywords_table} WHERE keyword_id IN ({$keyword_ids_string}) AND is_active = 1",
                            ARRAY_A
                        );
                        
                        if ( $keywords_data && is_array( $keywords_data ) ) {
                            foreach ( $keywords_data as $kw ) {
                                if ( isset( $kw['keyword'] ) && ! empty( $kw['keyword'] ) ) {
                                    $keywords_list[] = sanitize_text_field( $kw['keyword'] );
                                }
                            }
                        }
                    }
                }
                
                // Commit 2.3.9.1E: Notifications are shown in modals (not email)
                // Store notification data in payment record for frontend to display
                // This is idempotent - notifications_sent_at will be set after this
                
                // Set notifications_sent_at to mark as sent
                $wpdb->update(
                    $prototype_payments_table,
                    array( 'notifications_sent_at' => current_time( 'mysql' ) ),
                    array( 'id' => $payment_id ),
                    array( '%s' ),
                    array( '%d' )
                );
                
                // Log notification sent (for debugging)
                error_log( sprintf(
                    'Commit 2.3.9.1E: Payment notifications sent for payment_id=%d, item_id=%d, bid_id=%d, supplier_id=%d, designer_user_id=%d',
                    $payment_id,
                    $item_id,
                    $bid_id,
                    $supplier_id,
                    $designer_user_id
                ) );
            }
        }

        wp_send_json_success( array( 
            'message' => 'Payment marked as received successfully.',
            'status' => 'marked_received'
        ) );
    }
    
    /**
     * AJAX handler to create clarification request (Commit 2.3.9.1C-B)
     */
    public function ajax_create_clarification() {
        check_ajax_referer( 'n88_create_clarification', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        
        if ( ! $is_supplier ) {
            wp_send_json_error( array( 'message' => 'Access denied. Supplier access required.' ) );
            return;
        }

        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;
        $question_text = isset( $_POST['question_text'] ) ? sanitize_textarea_field( wp_unslash( $_POST['question_text'] ) ) : '';
        $category = isset( $_POST['category'] ) ? sanitize_text_field( wp_unslash( $_POST['category'] ) ) : '';
        
        if ( ! $item_id || empty( trim( $question_text ) ) ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters. Question text is required.' ) );
            return;
        }

        // Check if payment is marked_received (read-only lock)
        global $wpdb;
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table ) {
            $payment_status = $wpdb->get_var( $wpdb->prepare(
                "SELECT status FROM {$prototype_payments_table}
                WHERE item_id = %d AND bid_id = %d
                ORDER BY created_at DESC LIMIT 1",
                $item_id,
                $bid_id
            ) );
            
            if ( $payment_status === 'marked_received' ) {
                wp_send_json_error( array( 'message' => 'Clarifications are read-only after payment is confirmed.' ) );
                return;
            }
        }

        $clarifications_table = $wpdb->prefix . 'n88_rfq_clarifications';
        
        $insert_result = $wpdb->insert(
            $clarifications_table,
            array(
                'item_id' => $item_id,
                'bid_id' => $bid_id,
                'supplier_id' => $current_user->ID,
                'question_text' => $question_text,
                'status' => 'open',
                'created_at' => current_time( 'mysql' ),
            ),
            array( '%d', '%d', '%d', '%s', '%s', '%s' )
        );

        if ( ! $insert_result ) {
            wp_send_json_error( array( 'message' => 'Failed to create clarification request.' ) );
            return;
        }

        wp_send_json_success( array( 'clarification_id' => $wpdb->insert_id ) );
    }
    
    /**
     * AJAX handler to get clarifications (Commit 2.3.9.1C-B)
     */
    public function ajax_get_clarifications() {
        check_ajax_referer( 'n88_get_clarifications', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;
        
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
            return;
        }

        global $wpdb;
        $clarifications_table = $wpdb->prefix . 'n88_rfq_clarifications';
        
        $where = array( 'item_id = %d' );
        $where_values = array( $item_id );
        
        if ( $bid_id ) {
            $where[] = 'bid_id = %d';
            $where_values[] = $bid_id;
        }
        
        // Access control
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $is_supplier = in_array( 'n88_supplier_admin', $current_user->roles, true );
        
        if ( $is_supplier ) {
            $where[] = 'supplier_id = %d';
            $where_values[] = $current_user->ID;
        }
        
        $query = "SELECT * FROM {$clarifications_table} WHERE " . implode( ' AND ', $where ) . " ORDER BY created_at DESC";
        $clarifications = $wpdb->get_results( $wpdb->prepare( $query, $where_values ), ARRAY_A );
        
        wp_send_json_success( array( 'clarifications' => $clarifications ) );
    }
    
    /**
     * AJAX handler to reply to clarification (Commit 2.3.9.1C-B)
     */
    public function ajax_reply_to_clarification() {
        check_ajax_referer( 'n88_reply_to_clarification', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator access required.' ) );
            return;
        }

        $clarification_id = isset( $_POST['clarification_id'] ) ? absint( $_POST['clarification_id'] ) : 0;
        $answer_text = isset( $_POST['answer_text'] ) ? sanitize_textarea_field( wp_unslash( $_POST['answer_text'] ) ) : '';
        
        if ( ! $clarification_id || empty( trim( $answer_text ) ) ) {
            wp_send_json_error( array( 'message' => 'Invalid parameters. Answer text is required.' ) );
            return;
        }

        global $wpdb;
        $clarifications_table = $wpdb->prefix . 'n88_rfq_clarifications';
        
        // Check if payment is marked_received (read-only lock)
        $clarification = $wpdb->get_row( $wpdb->prepare(
            "SELECT * FROM {$clarifications_table} WHERE id = %d",
            $clarification_id
        ), ARRAY_A );
        
        if ( ! $clarification ) {
            wp_send_json_error( array( 'message' => 'Clarification not found.' ) );
            return;
        }
        
        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table ) {
            $payment_status = $wpdb->get_var( $wpdb->prepare(
                "SELECT status FROM {$prototype_payments_table}
                WHERE item_id = %d AND bid_id = %d
                ORDER BY created_at DESC LIMIT 1",
                $clarification['item_id'],
                $clarification['bid_id']
            ) );
            
            if ( $payment_status === 'marked_received' ) {
                wp_send_json_error( array( 'message' => 'Clarifications are read-only after payment is confirmed.' ) );
                return;
            }
        }
        
        $update_result = $wpdb->update(
            $clarifications_table,
            array(
                'answer_text' => $answer_text,
                'status' => 'answered',
                'answered_at' => current_time( 'mysql' ),
                'operator_user_id' => $current_user->ID,
            ),
            array( 'id' => $clarification_id ),
            array( '%s', '%s', '%s', '%d' ),
            array( '%d' )
        );

        if ( $update_result === false ) {
            wp_send_json_error( array( 'message' => 'Failed to update clarification.' ) );
            return;
        }

        wp_send_json_success( array( 'message' => 'Clarification answered successfully.' ) );
    }
    
    /**
     * AJAX handler to forward clarification to designer (Commit 2.3.9.1C-B)
     */
    public function ajax_forward_clarification_to_designer() {
        check_ajax_referer( 'n88_forward_clarification_to_designer', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator access required.' ) );
            return;
        }

        $clarification_id = isset( $_POST['clarification_id'] ) ? absint( $_POST['clarification_id'] ) : 0;
        $rephrased_question = isset( $_POST['rephrased_question'] ) ? sanitize_textarea_field( wp_unslash( $_POST['rephrased_question'] ) ) : '';
        
        if ( ! $clarification_id ) {
            wp_send_json_error( array( 'message' => 'Invalid clarification ID.' ) );
            return;
        }

        global $wpdb;
        $clarifications_table = $wpdb->prefix . 'n88_rfq_clarifications';
        $items_table = $wpdb->prefix . 'n88_items';
        
        $clarification = $wpdb->get_row( $wpdb->prepare(
            "SELECT * FROM {$clarifications_table} WHERE id = %d",
            $clarification_id
        ), ARRAY_A );
        
        if ( ! $clarification ) {
            wp_send_json_error( array( 'message' => 'Clarification not found.' ) );
            return;
        }
        
        // Get designer ID from item
        $designer_id = $wpdb->get_var( $wpdb->prepare(
            "SELECT owner_user_id FROM {$items_table} WHERE id = %d",
            $clarification['item_id']
        ) );
        
        if ( ! $designer_id ) {
            wp_send_json_error( array( 'message' => 'Designer not found for this item.' ) );
            return;
        }
        
        // Update clarification status
        $wpdb->update(
            $clarifications_table,
            array(
                'status' => 'needs_designer',
                'operator_user_id' => $current_user->ID,
            ),
            array( 'id' => $clarification_id ),
            array( '%s', '%d' ),
            array( '%d' )
        );
        
        // Send message to designer via item_messages
        $messages_table = $wpdb->prefix . 'n88_item_messages';
        $question_to_forward = ! empty( $rephrased_question ) ? $rephrased_question : $clarification['question_text'];
        $designer_message = "Clarification Request:\n\n" . $question_to_forward;
        
        $wpdb->insert(
            $messages_table,
            array(
                'item_id' => $clarification['item_id'],
                'bid_id' => $clarification['bid_id'],
                'sender_user_id' => $current_user->ID,
                'recipient_user_id' => $designer_id,
                'sender_type' => 'operator',
                'recipient_type' => 'designer',
                'thread_type' => 'designer_operator',
                'message' => $designer_message,
                'category' => 'Clarification Request',
                'is_read' => 0,
                'created_at' => current_time( 'mysql' ),
            ),
            array( '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s', '%s', '%d', '%s' )
        );

        wp_send_json_success( array( 'message' => 'Clarification forwarded to designer.' ) );
    }
    
    /**
     * AJAX handler to close clarification (Commit 2.3.9.1C-B)
     */
    public function ajax_close_clarification() {
        check_ajax_referer( 'n88_close_clarification', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        
        if ( ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator access required.' ) );
            return;
        }

        $clarification_id = isset( $_POST['clarification_id'] ) ? absint( $_POST['clarification_id'] ) : 0;
        
        if ( ! $clarification_id ) {
            wp_send_json_error( array( 'message' => 'Invalid clarification ID.' ) );
            return;
        }

        global $wpdb;
        $clarifications_table = $wpdb->prefix . 'n88_rfq_clarifications';
        
        $update_result = $wpdb->update(
            $clarifications_table,
            array( 'status' => 'closed' ),
            array( 'id' => $clarification_id ),
            array( '%s' ),
            array( '%d' )
        );

        if ( $update_result === false ) {
            wp_send_json_error( array( 'message' => 'Failed to close clarification.' ) );
            return;
        }

        wp_send_json_success( array( 'message' => 'Clarification closed successfully.' ) );
    }

    /**
     * AJAX: Mark clarification/case as resolved (Fix #13 / #26)
     * - Sets clarification(s) for the item to closed
     * - Inserts into n88_rfq_case_resolutions to clear Action Required for operator and for supplier/designer when no other pending alerts
     * - Fires clarification_resolved event: item_id, bid_id (nullable), actor_user_id, timestamp
     */
    public function ajax_mark_clarification_resolved() {
        check_ajax_referer( 'n88_mark_clarification_resolved', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );

        if ( ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Operator access required.' ) );
            return;
        }

        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;
        if ( $bid_id === 0 ) {
            $bid_id = null;
        }

        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
            return;
        }

        global $wpdb;
        $clarifications_table = $wpdb->prefix . 'n88_rfq_clarifications';
        $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';

        // 1) Set all clarifications for this item to closed (covers both item-level and bid-level threads)
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$clarifications_table}'" ) === $clarifications_table ) {
            $wpdb->query( $wpdb->prepare(
                "UPDATE {$clarifications_table} SET status = 'closed' WHERE item_id = %d",
                $item_id
            ) );
        }

        // 2) Ensure table exists (upgrade may not have run yet)
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) !== $resolutions_table ) {
            // Table missing: still close clarifications and fire event; Action Required will clear when table is created on next upgrade
            do_action( 'clarification_resolved', array(
                'item_id'       => $item_id,
                'bid_id'        => $bid_id,
                'actor_user_id' => $current_user->ID,
                'timestamp'     => current_time( 'mysql' ),
            ) );
            wp_send_json_success( array( 'message' => 'Clarification marked resolved. Case resolutions table not yet created; please upgrade the plugin.' ) );
            return;
        }

        // 3) Insert resolution: designer thread = (item_id, NULL); supplier thread = (item_id, bid_id). When resolving a payment case (has bid_id), insert both so operator/supplier and designer all clear.
        $wpdb->query( $wpdb->prepare(
            "INSERT INTO {$resolutions_table} (item_id, bid_id, actor_user_id, resolved_at) VALUES (%d, NULL, %d, %s)",
            $item_id,
            $current_user->ID,
            current_time( 'mysql' )
        ) );
        if ( $bid_id !== null ) {
            $wpdb->insert(
                $resolutions_table,
                array(
                    'item_id'        => $item_id,
                    'bid_id'         => $bid_id,
                    'actor_user_id'  => $current_user->ID,
                    'resolved_at'    => current_time( 'mysql' ),
                ),
                array( '%d', '%d', '%d', '%s' )
            );
        }

        // 4) Fire event
        do_action( 'clarification_resolved', array(
            'item_id'       => $item_id,
            'bid_id'        => $bid_id,
            'actor_user_id' => $current_user->ID,
            'timestamp'     => current_time( 'mysql' ),
        ) );

        wp_send_json_success( array( 'message' => 'Marked resolved. Action Required cleared for this case.' ) );
    }

    /**
     * AJAX: Supplier confirms that operator's reply clarified their question.
     * Inserts into n88_rfq_case_resolutions (actor = supplier) so operator knows; optionally closes clarifications.
     */
    public function ajax_supplier_confirm_clarification() {
        check_ajax_referer( 'n88_supplier_confirm_clarification', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        if ( ! in_array( 'n88_supplier_admin', $current_user->roles, true ) ) {
            wp_send_json_error( array( 'message' => 'Access denied. Supplier only.' ) );
            return;
        }

        $item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
        $bid_id = isset( $_POST['bid_id'] ) ? absint( $_POST['bid_id'] ) : 0;
        if ( $bid_id === 0 ) {
            $bid_id = null;
        }
        if ( ! $item_id ) {
            wp_send_json_error( array( 'message' => 'Invalid item ID.' ) );
            return;
        }

        global $wpdb;
        $messages_table = $wpdb->prefix . 'n88_item_messages';
        $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
        $clarifications_table = $wpdb->prefix . 'n88_rfq_clarifications';

        // Ensure supplier is part of this thread (their messages exist for this item)
        $supplier_in_thread = $wpdb->get_var( $wpdb->prepare(
            "SELECT 1 FROM {$messages_table} WHERE item_id = %d AND thread_type = 'supplier_operator' AND supplier_id = %d LIMIT 1",
            $item_id,
            $current_user->ID
        ) );
        if ( ! $supplier_in_thread ) {
            wp_send_json_error( array( 'message' => 'Access denied. You do not have messages for this item.' ) );
            return;
        }

        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) !== $resolutions_table ) {
            wp_send_json_error( array( 'message' => 'System not ready. Please try again later.' ) );
            return;
        }

        // Insert new resolution each time (allows "Mark as Clarified" again after supplier sends new msg and operator replies)
        $inserted = $wpdb->insert(
            $resolutions_table,
            array(
                'item_id'        => $item_id,
                'bid_id'         => $bid_id,
                'actor_user_id'  => $current_user->ID,
                'resolved_at'    => current_time( 'mysql' ),
            ),
            array( '%d', '%d', '%d', '%s' )
        );
        if ( ! $inserted ) {
            wp_send_json_error( array( 'message' => 'Could not save. Please try again.' ) );
            return;
        }

        // Close clarifications for this item so operator queue can clear
        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$clarifications_table}'" ) === $clarifications_table ) {
            $wpdb->query( $wpdb->prepare(
                "UPDATE {$clarifications_table} SET status = 'closed' WHERE item_id = %d",
                $item_id
            ) );
        }

        do_action( 'clarification_resolved', array(
            'item_id'       => $item_id,
            'bid_id'        => $bid_id,
            'actor_user_id' => $current_user->ID,
            'timestamp'     => current_time( 'mysql' ),
        ) );

        wp_send_json_success( array( 'message' => 'Marked as clarified. Operator will be notified.' ) );
    }

    /**
     * AJAX: Upload payment receipt (JPG/PDF) for a prototype payment.
     * Designer (payment's designer_user_id) can upload. Operator views in Mark Payment Received modal.
     */
    public function ajax_upload_payment_receipt() {
        check_ajax_referer( 'n88_upload_payment_receipt', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        if ( ! $payment_id ) {
            wp_send_json_error( array( 'message' => 'Invalid payment ID.' ) );
            return;
        }

        $file = isset( $_FILES['receipt_file'] ) ? $_FILES['receipt_file'] : null;
        if ( ! $file || empty( $file['tmp_name'] ) || ! empty( $file['error'] ) ) {
            wp_send_json_error( array( 'message' => 'No file or upload error. Please choose a JPG or PDF.' ) );
            return;
        }

        global $wpdb;
        $payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $receipts_table = $wpdb->prefix . 'n88_prototype_payment_receipts';

        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, designer_user_id FROM {$payments_table} WHERE id = %d",
            $payment_id
        ), ARRAY_A );

        if ( ! $payment ) {
            wp_send_json_error( array( 'message' => 'Payment not found.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_designer = (int) $payment['designer_user_id'] === (int) $current_user->ID;
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        if ( ! $is_designer && ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied. Only the designer or operator can upload a receipt.' ) );
            return;
        }

        $mime = isset( $file['type'] ) ? sanitize_text_field( $file['type'] ) : '';
        $allowed = array( 'application/pdf', 'image/jpeg', 'image/jpg', 'image/pjpeg' );
        if ( ! in_array( $mime, $allowed, true ) ) {
            wp_send_json_error( array( 'message' => 'Only JPG and PDF are allowed.' ) );
            return;
        }

        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$receipts_table}'" ) !== $receipts_table ) {
            wp_send_json_error( array( 'message' => 'Receipts table not ready. Please upgrade the plugin.' ) );
            return;
        }

        require_once ABSPATH . 'wp-admin/includes/file.php';
        require_once ABSPATH . 'wp-admin/includes/image.php';
        require_once ABSPATH . 'wp-admin/includes/media.php';

        $upload = wp_handle_upload( $file, array( 'test_form' => false ) );
        if ( empty( $upload['file'] ) || empty( $upload['url'] ) ) {
            wp_send_json_error( array( 'message' => 'Upload failed. Try another file.' ) );
            return;
        }

        $attachment = array(
            'post_mime_type' => $upload['type'],
            'post_title'     => sanitize_file_name( wp_basename( $upload['file'] ) ),
            'post_content'   => '',
            'post_status'    => 'inherit',
        );
        $attach_id = wp_insert_attachment( $attachment, $upload['file'] );
        if ( ! $attach_id ) {
            wp_send_json_error( array( 'message' => 'Failed to save file.' ) );
            return;
        }

        $attach_data = wp_generate_attachment_metadata( $attach_id, $upload['file'] );
        if ( ! is_wp_error( $attach_data ) ) {
            wp_update_attachment_metadata( $attach_id, $attach_data );
        }

        $file_name = isset( $file['name'] ) ? sanitize_file_name( $file['name'] ) : wp_basename( $upload['file'] );
        $message = isset( $_POST['receipt_message'] ) ? sanitize_textarea_field( wp_unslash( $_POST['receipt_message'] ) ) : '';
        if ( strlen( $message ) > 500 ) {
            $message = substr( $message, 0, 500 );
        }
        $receipt_cols = array(
            'payment_id'    => $payment_id,
            'attachment_id' => $attach_id,
            'file_name'     => $file_name,
            'uploaded_by'   => $current_user->ID,
            'uploaded_at'   => current_time( 'mysql' ),
        );
        $receipt_fmts = array( '%d', '%d', '%s', '%d', '%s' );
        $receipts_cols = $wpdb->get_col( "DESCRIBE {$receipts_table}" );
        if ( is_array( $receipts_cols ) && in_array( 'message', $receipts_cols, true ) ) {
            $receipt_cols['message'] = $message;
            $receipt_fmts[] = '%s';
        }
        $wpdb->insert( $receipts_table, $receipt_cols, $receipt_fmts );

        $url = wp_get_attachment_url( $attach_id );
        if ( ! $url ) {
            $url = $upload['url'];
        }

        wp_send_json_success( array(
            'attachment_id' => $attach_id,
            'file_name'     => $file_name,
            'url'           => $url,
        ) );
    }

    /**
     * AJAX: Get payment receipts for a prototype payment.
     * Designer (own payment) or operator can call.
     */
    public function ajax_get_payment_receipts() {
        check_ajax_referer( 'n88_get_payment_receipts', '_ajax_nonce' );

        if ( ! is_user_logged_in() ) {
            wp_send_json_error( array( 'message' => 'Authentication required.' ) );
            return;
        }

        $payment_id = isset( $_POST['payment_id'] ) ? absint( $_POST['payment_id'] ) : 0;
        if ( ! $payment_id ) {
            wp_send_json_error( array( 'message' => 'Invalid payment ID.' ) );
            return;
        }

        global $wpdb;
        $payments_table = $wpdb->prefix . 'n88_prototype_payments';
        $receipts_table = $wpdb->prefix . 'n88_prototype_payment_receipts';

        $payment = $wpdb->get_row( $wpdb->prepare(
            "SELECT id, designer_user_id FROM {$payments_table} WHERE id = %d",
            $payment_id
        ), ARRAY_A );

        if ( ! $payment ) {
            wp_send_json_error( array( 'message' => 'Payment not found.' ) );
            return;
        }

        $current_user = wp_get_current_user();
        $is_designer = (int) $payment['designer_user_id'] === (int) $current_user->ID;
        $is_operator = in_array( 'n88_system_operator', $current_user->roles, true );
        if ( ! $is_designer && ! $is_operator ) {
            wp_send_json_error( array( 'message' => 'Access denied.' ) );
            return;
        }

        if ( $wpdb->get_var( "SHOW TABLES LIKE '{$receipts_table}'" ) !== $receipts_table ) {
            wp_send_json_success( array( 'receipts' => array() ) );
            return;
        }

        $has_message_col = $wpdb->get_var( "SHOW TABLES LIKE '{$receipts_table}'" ) === $receipts_table
            && in_array( 'message', (array) $wpdb->get_col( "DESCRIBE {$receipts_table}" ), true );
        $sel = $has_message_col ? "r.id, r.attachment_id, r.file_name, r.uploaded_at, r.message" : "r.id, r.attachment_id, r.file_name, r.uploaded_at";
        $rows = $wpdb->get_results( $wpdb->prepare(
            "SELECT {$sel}
             FROM {$receipts_table} r
             WHERE r.payment_id = %d
             ORDER BY r.uploaded_at DESC",
            $payment_id
        ), ARRAY_A );

        $receipts = array();
        foreach ( $rows as $r ) {
            $url = wp_get_attachment_url( (int) $r['attachment_id'] );
            $entry = array(
                'id'            => (int) $r['id'],
                'attachment_id' => (int) $r['attachment_id'],
                'file_name'     => $r['file_name'],
                'url'           => $url ?: '',
                'uploaded_at'   => $r['uploaded_at'],
            );
            if ( $has_message_col && isset( $r['message'] ) && $r['message'] !== '' ) {
                $entry['message'] = $r['message'];
            }
            $receipts[] = $entry;
        }

        wp_send_json_success( array( 'receipts' => $receipts ) );
    }
}

// .....