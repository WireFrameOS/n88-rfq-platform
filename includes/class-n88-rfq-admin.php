<?php

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Admin-facing dashboard scaffolding.
 * Developer: build admin menus + pages here to match Figma/admin designs.
 */
class N88_RFQ_Admin {

    public function __construct() {
        add_action( 'admin_menu', array( $this, 'register_menus' ) );
        add_action( 'admin_menu', array( $this, 'modify_board_menu_url' ), 999 ); // Run after menus are registered
    }

    public function render_notifications_center() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }

        global $wpdb;
        $table_notifications = $wpdb->prefix . 'project_notifications';
        $table_projects      = $wpdb->prefix . 'projects';
        $table_users         = $wpdb->users;

        $status = isset( $_GET['status'] ) ? sanitize_text_field( $_GET['status'] ) : 'all';
        $type   = isset( $_GET['notification_type'] ) ? sanitize_text_field( $_GET['notification_type'] ) : '';
        $limit  = isset( $_GET['limit'] ) ? max( 10, min( 500, intval( $_GET['limit'] ) ) ) : 100;

        $admin_users = get_users( array( 'role' => 'administrator', 'fields' => 'ID' ) );
        $admin_ids = array_map( 'intval', $admin_users );

        $where = array( '1=1' );
        if ( 'unread' === $status ) {
            $where[] = 'n.is_read = 0';
        } elseif ( 'read' === $status ) {
            $where[] = 'n.is_read = 1';
        }

        $prepare_values = array();

        if ( ! empty( $admin_ids ) ) {
            $placeholders = implode( ',', array_fill( 0, count( $admin_ids ), '%d' ) );
            $where[] = "n.user_id IN ( {$placeholders} )";
            $prepare_values = array_merge( $prepare_values, $admin_ids );
        }

        if ( ! empty( $type ) ) {
            $where[] = 'n.notification_type = %s';
            $prepare_values[] = $type;
        }

        $where_sql = implode( ' AND ', $where );

        $query = "
            SELECT n.*, p.project_name, p.user_id AS project_owner_id,
                   recipient.display_name AS recipient_name,
                   owner.display_name AS owner_name
            FROM {$table_notifications} n
            LEFT JOIN {$table_projects} p ON n.project_id = p.id
            LEFT JOIN {$table_users} recipient ON n.user_id = recipient.ID
            LEFT JOIN {$table_users} owner ON p.user_id = owner.ID
            WHERE {$where_sql}
            ORDER BY n.created_at DESC
            LIMIT %d
        ";

        $prepare_values[] = $limit;
        $notifications = $wpdb->get_results( $wpdb->prepare( $query, $prepare_values ) );

        // Table name is safe (from $wpdb->prefix), but we validate it contains only safe characters
        $table_notifications_safe = preg_replace( '/[^a-zA-Z0-9_]/', '', $table_notifications );
        $notification_types = $wpdb->get_col( "SELECT DISTINCT notification_type FROM {$table_notifications_safe} ORDER BY notification_type ASC" );
        ?>
        <div class="wrap n88-admin-notifications">
            <h1><?php esc_html_e( 'Notifications Center', 'n88-rfq' ); ?></h1>

            <form method="get" class="n88-filters">
                <input type="hidden" name="page" value="n88-rfq-notifications" />
                <label>
                    <span><?php esc_html_e( 'Status', 'n88-rfq' ); ?></span>
                    <select name="status">
                        <option value="all" <?php selected( $status, 'all' ); ?>><?php esc_html_e( 'All', 'n88-rfq' ); ?></option>
                        <option value="unread" <?php selected( $status, 'unread' ); ?>><?php esc_html_e( 'Unread', 'n88-rfq' ); ?></option>
                        <option value="read" <?php selected( $status, 'read' ); ?>><?php esc_html_e( 'Read', 'n88-rfq' ); ?></option>
                    </select>
                </label>

                <label>
                    <span><?php esc_html_e( 'Type', 'n88-rfq' ); ?></span>
                    <select name="notification_type">
                        <option value=""><?php esc_html_e( 'All Types', 'n88-rfq' ); ?></option>
                        <?php foreach ( $notification_types as $notif_type ) : ?>
                            <option value="<?php echo esc_attr( $notif_type ); ?>" <?php selected( $type, $notif_type ); ?>>
                                <?php echo esc_html( ucwords( str_replace( '_', ' ', $notif_type ) ) ); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </label>

                <label>
                    <span><?php esc_html_e( 'Limit', 'n88-rfq' ); ?></span>
                    <input type="number" name="limit" value="<?php echo esc_attr( $limit ); ?>" min="10" max="500" />
                </label>

                <button class="button button-primary"><?php esc_html_e( 'Filter', 'n88-rfq' ); ?></button>
            </form>

            <table class="widefat fixed striped n88-notifications-table">
                <thead>
                    <tr>
                        <th><?php esc_html_e( 'Date', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Project', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Recipient', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Type', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Message', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Status', 'n88-rfq' ); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if ( empty( $notifications ) ) : ?>
                        <tr>
                            <td colspan="6" style="text-align:center;"><?php esc_html_e( 'No notifications found for the selected filters.', 'n88-rfq' ); ?></td>
                        </tr>
                    <?php else : ?>
                        <?php foreach ( $notifications as $notification ) : ?>
                            <tr>
                                <td>
                                    <strong><?php echo esc_html( date_i18n( get_option( 'date_format' ), strtotime( $notification->created_at ) ) ); ?></strong>
                                    <div class="description"><?php echo esc_html( date_i18n( get_option( 'time_format' ), strtotime( $notification->created_at ) ) ); ?></div>
                                </td>
                                <td>
                                    <?php if ( $notification->project_id ) : ?>
                                        <a href="<?php echo esc_url( admin_url( 'admin.php?page=n88-rfq-projects&project_id=' . $notification->project_id ) ); ?>">
                                            <?php echo esc_html( $notification->project_name ?: __( 'Unknown Project', 'n88-rfq' ) ); ?>
                                        </a>
                                        <?php if ( $notification->owner_name ) : ?>
                                            <div class="description"><?php printf( esc_html__( 'Owner: %s', 'n88-rfq' ), esc_html( $notification->owner_name ) ); ?></div>
                                        <?php endif; ?>
                                    <?php else : ?>
                                        <em><?php esc_html_e( 'General', 'n88-rfq' ); ?></em>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?php echo esc_html( $notification->recipient_name ?: __( 'Unknown user', 'n88-rfq' ) ); ?>
                                    <div class="description"><?php printf( esc_html__( 'User ID: %d', 'n88-rfq' ), (int) $notification->user_id ); ?></div>
                                </td>
                                <td>
                                    <span class="n88-type-badge"><?php echo esc_html( ucwords( str_replace( '_', ' ', $notification->notification_type ) ) ); ?></span>
                                </td>
                                <td><?php echo esc_html( $notification->message ); ?></td>
                                <td>
                                    <?php if ( $notification->is_read ) : ?>
                                        <span class="status-read"><?php esc_html_e( 'Read', 'n88-rfq' ); ?></span>
                                    <?php else : ?>
                                        <span class="status-unread"><?php esc_html_e( 'Unread', 'n88-rfq' ); ?></span>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>

        <style>
            .n88-admin-notifications .n88-filters {
                display: flex;
                gap: 20px;
                align-items: flex-end;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            .n88-admin-notifications .n88-filters label {
                display: flex;
                flex-direction: column;
                font-weight: 600;
            }
            .n88-notifications-table .description {
                color: #666;
                font-size: 12px;
            }
            .n88-type-badge {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 999px;
                background: #eef2ff;
                color: #3730a3;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .status-read,
            .status-unread {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-weight: 600;
            }
            .status-read::before,
            .status-unread::before {
                content: '';
                width: 8px;
                height: 8px;
                border-radius: 50%;
                display: inline-block;
            }
            .status-read {
                color: #2e7d32;
            }
            .status-read::before {
                background: #2e7d32;
            }
            .status-unread {
                color: #c62828;
            }
            .status-unread::before {
                background: #c62828;
            }
        </style>
        <?php
    }

    public function register_menus() {
        // Allow both administrators and designers to access menus
        $capability = $this->get_plugin_capability();
        
        add_menu_page(
            __( 'NorthEightyEight RFQ', 'n88-rfq' ),
            'N88 RFQ',
            $capability,
            'n88-rfq-dashboard',
            array( $this, 'render_main_dashboard' ),
            'dashicons-feedback',
            26
        );

        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Projects', 'n88-rfq' ),
            __( 'Projects', 'n88-rfq' ),
            $capability,
            'n88-rfq-projects',
            array( $this, 'render_projects_list' )
        );

        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Quotes', 'n88-rfq' ),
            __( 'Quotes', 'n88-rfq' ),
            $capability,
            'n88-rfq-quotes',
            array( $this, 'render_quotes_manager' )
        );

        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Notifications', 'n88-rfq' ),
            __( 'Notifications', 'n88-rfq' ),
            $capability,
            'n88-rfq-notifications',
            array( $this, 'render_notifications_center' )
        );

        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Comments', 'n88-rfq' ),
            __( 'Comments', 'n88-rfq' ),
            $capability,
            'n88-rfq-comments',
            array( $this, 'render_comments_hub' )
        );

        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Audit Trail', 'n88-rfq' ),
            __( 'Audit Trail', 'n88-rfq' ),
            $capability,
            'n88-rfq-audit',
            array( $this, 'render_audit_trail' )
        );

        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Content Manager', 'n88-rfq' ),
            __( 'Content Manager', 'n88-rfq' ),
            $capability,
            'n88-rfq-content',
            array( $this, 'render_content_manager' )
        );

        // Milestone 1.1: Test page for Items & Boards (temporary for testing)
        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Items & Boards (Test)', 'n88-rfq' ),
            __( 'Items & Boards', 'n88-rfq' ),
            $capability,
            'n88-rfq-items-boards-test',
            array( $this, 'render_items_boards_test' )
        );

        // Milestone 1.3.4a: Board Demo Harness (testing only)
        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Board', 'n88-rfq' ),
            __( 'Board', 'n88-rfq' ),
            $capability,
            'n88-rfq-board-demo',
            array( $this, 'render_board_demo' )
        );

  

        // Phase 1.2.3: Material Bank
        add_submenu_page(
            'n88-rfq-dashboard',
            __( 'Material Bank', 'n88-rfq' ),
            __( 'Material Bank', 'n88-rfq' ),
            $capability,
            'n88-rfq-materials',
            array( $this, 'render_material_bank' )
        );

        // Commit 2.2.1: Role Management (only for system operators)
        if ( current_user_can( 'n88_view_global_queue' ) || current_user_can( 'manage_options' ) ) {
            add_submenu_page(
                'n88-rfq-dashboard',
                __( 'Role Management', 'n88-rfq' ),
                __( 'Role Management', 'n88-rfq' ),
                'manage_options',
                'n88-rfq-role-management',
                array( $this, 'render_role_management' )
            );
        }
    }

    /**
     * Modify Board menu URL for designers to include their board_id using JavaScript
     * This avoids WordPress permission issues with modified menu slugs
     */
    public function modify_board_menu_url() {
        $current_user = wp_get_current_user();
        if ( $current_user && ( in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true ) ) ) {
            $user_id = get_current_user_id();
            $designer_board = $this->get_designer_board( $user_id );
            
            if ( $designer_board ) {
                // Add JavaScript to modify the menu link after page loads
                add_action( 'admin_footer', function() use ( $designer_board ) {
                    ?>
                    <script>
                    (function() {
                        function modifyBoardLink() {
                            // Find the Board menu link in the admin sidebar
                            // Try multiple selectors to find the menu item
                            var selectors = [
                                '#toplevel_page_n88-rfq-dashboard a[href*="page=n88-rfq-board-demo"]',
                                '#toplevel_page_n88-rfq-dashboard .wp-submenu a[href*="page=n88-rfq-board-demo"]',
                                'a[href*="page=n88-rfq-board-demo"]'
                            ];
                            
                            for (var s = 0; s < selectors.length; s++) {
                                var links = document.querySelectorAll(selectors[s]);
                                for (var i = 0; i < links.length; i++) {
                                    var link = links[i];
                                    if (link.href && link.href.indexOf('page=n88-rfq-board-demo') !== -1) {
                                        // Modify the href to include board_id
                                        var url = new URL(link.href);
                                        url.searchParams.set('board_id', '<?php echo absint( $designer_board->id ); ?>');
                                        link.href = url.toString();
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Wait for menu to be rendered
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', modifyBoardLink);
                        } else {
                            modifyBoardLink();
                        }
                        
                        // Also try after a short delay in case menu loads asynchronously
                        setTimeout(modifyBoardLink, 500);
                    })();
                    </script>
                    <?php
                });
            }
        }
    }

    /**
     * Get capability required for plugin access
     * Allows both administrators and designers
     */
    private function get_plugin_capability() {
        $current_user = wp_get_current_user();
        if ( $current_user && ( in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true ) ) ) {
            return 'read';
        }
        return 'manage_options';
    }

    /**
     * Check if current user has access to plugin pages
     * Allows administrators, system operators, and designers
     */
    private function check_plugin_access() {
        if ( current_user_can( 'manage_options' ) ) {
            return true;
        }
        $current_user = wp_get_current_user();
        if ( $current_user ) {
            // Allow designers
            if ( in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true ) ) {
            return true;
            }
            // Allow system operators
            if ( in_array( 'n88_system_operator', $current_user->roles, true ) ) {
                return true;
            }
        }
        return false;
    }

    public function render_main_dashboard() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }
        
        // Check if user is designer and has items
        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $user_id = get_current_user_id();
        $has_items = false;
        
        if ( $is_designer ) {
            global $wpdb;
            $items_table = $wpdb->prefix . 'n88_items';
            $item_count = $wpdb->get_var(
                $wpdb->prepare(
                    "SELECT COUNT(*) FROM {$items_table} WHERE owner_user_id = %d AND deleted_at IS NULL",
                    $user_id
                )
            );
            $has_items = $item_count > 0;
        }
        
        ?>
        <div class="wrap">
            <h1>NorthEightyEight RFQ</h1>
            <div style="text-align: center; margin: 50px 0;">
                <a href="<?php echo esc_url( admin_url( 'admin.php?page=n88-rfq-items-boards-test' ) ); ?>" 
                   class="button button-primary button-large" 
                   style="padding: 15px 30px; font-size: 16px; text-decoration: none; display: inline-block;">
                    <?php echo $has_items ? 'Create your items' : 'Add your First Item'; ?>
                </a>
            </div>
            <?php if ( ! $is_designer ) : ?>
                <p>TODO: Implement cards and metrics per design.</p>
            <?php endif; ?>
        </div>
        <?php
    }

    public function render_projects_list() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }
        echo '<div class="wrap"><h1>Projects</h1><p>TODO: Implement filters, table, and status chips.</p></div>';
    }

    /**
     * Render quotes manager page
     */
    public function render_quotes_manager() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }
        global $wpdb;

        $action = isset( $_GET['action'] ) ? sanitize_text_field( $_GET['action'] ) : 'list';
        $project_id = isset( $_GET['project_id'] ) ? intval( $_GET['project_id'] ) : 0;

        ?>
        <div class="wrap">
            <h1>Quote Manager</h1>

            <?php if ( $action === 'list' ) : ?>
                <p>Manage quotes for all projects.</p>
                <table class="wp-list-table widefat fixed striped">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Sent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $projects_table = $wpdb->prefix . 'projects';
                        $quotes_table = $wpdb->prefix . 'project_quotes';

                        // Show ALL projects (draft and submitted) - admin can upload quotes for any
                        // Table names are safe (from $wpdb->prefix), but we validate them
                        $projects_table_safe = preg_replace( '/[^a-zA-Z0-9_]/', '', $projects_table );
                        $quotes_table_safe = preg_replace( '/[^a-zA-Z0-9_]/', '', $quotes_table );
                        $projects = $wpdb->get_results(
                            $wpdb->prepare(
                                "SELECT p.id, p.project_name, p.status, p.created_at as project_created, q.id as quote_id, q.quote_status, q.created_at as quote_created, q.sent_at
                                FROM {$projects_table_safe} p
                                LEFT JOIN {$quotes_table_safe} q ON p.id = q.project_id
                                ORDER BY p.created_at DESC
                                LIMIT %d",
                                50
                            )
                        );
                        
                        // Fetch client update flags for all projects
                        $project_ids = array_map( function( $p ) { return (int) $p->id; }, $projects );
                        $client_updates_map = array();
                        if ( ! empty( $project_ids ) ) {
                            $meta_table = $wpdb->prefix . 'project_metadata';
                            // Table name is safe (from $wpdb->prefix), but we validate it
                            $meta_table_safe = preg_replace( '/[^a-zA-Z0-9_]/', '', $meta_table );
                            // Use prepare() with placeholders for project IDs
                            $placeholders = implode( ',', array_fill( 0, count( $project_ids ), '%d' ) );
                            $prepare_values = array_merge( array( 'n88_has_client_updates', '1' ), $project_ids );
                            $update_rows = $wpdb->get_results(
                                $wpdb->prepare(
                                "SELECT project_id, meta_value 
                                    FROM {$meta_table_safe} 
                                    WHERE meta_key = %s 
                                    AND meta_value = %s
                                    AND project_id IN ({$placeholders})",
                                    $prepare_values
                                )
                            );
                            foreach ( $update_rows as $row ) {
                                $client_updates_map[ $row->project_id ] = true;
                            }
                        }

                        if ( empty( $projects ) ) {
                            echo '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">No projects found</td></tr>';
                        }

                        foreach ( $projects as $project ) {
                            // Show project status
                            $project_status = ( $project->status == 1 ) ? 'Submitted' : 'Draft';
                            $status_badge_color = ( $project->status == 1 ) ? '#4CAF50' : '#FF9800';
                            ?>
                            <tr>
                                <td>
                                    <?php echo esc_html( $project->project_name ); ?> <span style="color: #999; font-size: 12px;">(<?php echo esc_html( $project_status ); ?>)</span>
                                    <?php if ( ! empty( $client_updates_map[ $project->id ] ) ) : ?>
                                        <span style="background: #ff5252; color: #fff; padding: 3px 8px; border-radius: 999px; font-weight: 600; font-size: 11px; letter-spacing: 0.5px; margin-left: 8px;">NEW UPDATES</span>
                                        <span style="background: #ffe0b2; color: #bf360c; padding: 3px 8px; border-radius: 999px; font-weight: 600; font-size: 11px; margin-left: 4px;">Updated by Client</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?php if ( $project->quote_id ) : ?>
                                        <span class="badge" style="background: <?php echo ( $project->quote_status === 'sent' || $project->quote_status === 'quote_updated' ) ? ( $project->quote_status === 'quote_updated' ? '#ff9800' : '#4caf50' ) : '#ff9800'; ?>; color: white; padding: 4px 8px; border-radius: 3px;">
                                            <?php 
                                            if ( $project->quote_status === 'quote_updated' ) {
                                                echo 'Quote Updated';
                                            } elseif ( $project->quote_status === 'sent' ) {
                                                echo 'Quote Sent';
                                            } else {
                                                echo esc_html( ucfirst( $project->quote_status ) );
                                            }
                                            ?>
                                        </span>
                                    <?php else : ?>
                                        <span class="badge" style="background: #999; color: white; padding: 4px 8px; border-radius: 3px;">No Quote</span>
                                    <?php endif; ?>
                                </td>
                                <td><?php echo $project->quote_id ? esc_html( date_i18n( get_option( 'date_format' ), strtotime( $project->quote_created ) ) ) : '—'; ?></td>
                                <td><?php echo $project->sent_at ? esc_html( date_i18n( get_option( 'date_format' ), strtotime( $project->sent_at ) ) ) : '—'; ?></td>
                                <td>
                                    <a href="<?php echo add_query_arg( array( 'action' => 'edit', 'project_id' => $project->id ) ); ?>" class="button">Manage</a>
                                </td>
                            </tr>
                            <?php
                        }
                        ?>
                    </tbody>
                </table>

            <?php elseif ( $action === 'edit' && $project_id ) : ?>
                <h2>Manage Quote for Project</h2>
                <?php
                $projects_class = new N88_RFQ_Projects();
                $project = $projects_class->get_project_admin( $project_id );

                if ( ! $project ) {
                    echo '<p>Project not found.</p>';
                    return;
                }

                // Handle clearing of client-updated flag (mark as viewed)
                if ( isset( $_POST['n88_clear_updates'] ) && check_admin_referer( 'n88_clear_updates' ) ) {
                    $clear_project_id = isset( $_POST['project_id'] ) ? intval( $_POST['project_id'] ) : $project_id;
                    if ( $clear_project_id ) {
                        $projects_class->save_project_metadata( $clear_project_id, array(
                            'n88_has_client_updates' => '0',
                            'n88_client_updates_viewed' => '1',
                            'n88_client_updates_viewed_at' => current_time( 'mysql' ),
                            'n88_client_updates_viewed_by' => (string) get_current_user_id(),
                        ) );
                        // Refresh project data immediately
                        $project = $projects_class->get_project_admin( $clear_project_id );
                        // Redirect to refresh the page and show updated state
                        wp_redirect( admin_url( 'admin.php?page=n88-rfq-quotes&action=edit&project_id=' . $clear_project_id . '&updated=1' ) );
                        exit;
                    }
                }

                // Handle quote upload with pricing
                if ( ( isset( $_POST['n88_upload_quote'] ) || isset( $_POST['n88_send_quote'] ) ) && check_admin_referer( 'n88_upload_quote' ) ) {
                    if ( ! empty( $_FILES['quote_file']['name'] ) ) {
                        $client_message = isset( $_POST['client_message'] ) ? sanitize_textarea_field( $_POST['client_message'] ) : '';
                        $should_send = isset( $_POST['n88_send_quote'] );
                        
                        $quote_id = N88_RFQ_Quotes::upload_quote( array(
                            'project_id' => $project_id,
                            'user_id' => get_current_user_id(),
                            'admin_notes' => isset( $_POST['admin_notes'] ) ? sanitize_textarea_field( $_POST['admin_notes'] ) : '',
                            'client_message' => $client_message,
                            'quote_file' => $_FILES['quote_file'],
                            'labor_cost' => isset( $_POST['labor_cost'] ) ? (float) $_POST['labor_cost'] : 0,
                            'materials_cost' => isset( $_POST['materials_cost'] ) ? (float) $_POST['materials_cost'] : 0,
                            'overhead_cost' => isset( $_POST['overhead_cost'] ) ? (float) $_POST['overhead_cost'] : 0,
                            'margin_percentage' => isset( $_POST['margin_percentage'] ) ? (float) $_POST['margin_percentage'] : 0,
                            'shipping_zone' => isset( $_POST['shipping_zone'] ) ? sanitize_text_field( $_POST['shipping_zone'] ) : '',
                        ) );

                        if ( $quote_id ) {
                            if ( $should_send ) {
                                // Send quote to client
                                if ( N88_RFQ_Quotes::send_quote( $quote_id, get_current_user_id() ) ) {
                                    echo '<div class="notice notice-success"><p>Quote uploaded and sent to client successfully!</p></div>';
                                } else {
                                    echo '<div class="notice notice-warning"><p>Quote uploaded but failed to send. You can send it manually from the quote details.</p></div>';
                                }
                            } else {
                                echo '<div class="notice notice-success"><p>Quote saved as draft successfully!</p></div>';
                            }
                        } else {
                            echo '<div class="notice notice-error"><p>Failed to upload quote.</p></div>';
                        }
                    } else {
                        echo '<div class="notice notice-error"><p>Please select a quote file to upload.</p></div>';
                    }
                }

                // Handle instant pricing calculation (AJAX or form submission)
                if ( isset( $_POST['n88_calculate_pricing'] ) && check_admin_referer( 'n88_calculate_pricing' ) ) {
                    $labor_cost = isset( $_POST['labor_cost'] ) ? (float) $_POST['labor_cost'] : 0;
                    $materials_cost = isset( $_POST['materials_cost'] ) ? (float) $_POST['materials_cost'] : 0;
                    $overhead_cost = isset( $_POST['overhead_cost'] ) ? (float) $_POST['overhead_cost'] : 0;
                    $margin_percentage = isset( $_POST['margin_percentage'] ) ? (float) $_POST['margin_percentage'] : 0;
                    $shipping_zone = isset( $_POST['shipping_zone'] ) ? sanitize_text_field( $_POST['shipping_zone'] ) : '';

                    if ( class_exists( 'N88_RFQ_Pricing' ) ) {
                        $pricing_result = N88_RFQ_Pricing::calculate_project_pricing(
                            $project_id,
                            $labor_cost,
                            $materials_cost,
                            $overhead_cost,
                            $margin_percentage,
                            $shipping_zone
                        );

                        if ( $pricing_result ) {
                            $calculated_pricing = $pricing_result;
                        }
                    }
                }

                // Show success message if redirected after marking as viewed
                if ( isset( $_GET['updated'] ) && $_GET['updated'] == '1' ) {
                    echo '<div class="notice notice-success is-dismissible"><p>Client updates have been marked as reviewed.</p></div>';
                }

                // Get existing quotes
                $quotes = N88_RFQ_Quotes::get_project_quotes( $project_id );
                $latest_quote = $quotes ? $quotes[0] : null;
                ?>

                <?php
                $has_client_updates = ! empty( $project['metadata']['n88_has_client_updates'] ) && '1' === $project['metadata']['n88_has_client_updates'];
                $client_updates_viewed = ! empty( $project['metadata']['n88_client_updates_viewed'] ) && '1' === $project['metadata']['n88_client_updates_viewed'];
                $last_client_update = $project['metadata']['n88_last_client_update'] ?? '';
                $last_client_update_by = $project['metadata']['n88_last_client_update_by'] ?? '';
                $last_client_updater = '';
                if ( $last_client_update_by ) {
                    $client_user = get_userdata( (int) $last_client_update_by );
                    $last_client_updater = $client_user ? $client_user->display_name : '';
                }
                ?>

                <!-- Client Updates Highlight Section (Show prominently at top if not viewed) -->
                <?php if ( $has_client_updates && ! $client_updates_viewed ) : ?>
                    <?php
                    // Get project items to show what was changed
                    $items_json = $projects_class->get_project_metadata( $project_id, 'n88_repeater_raw' );
                    $items = ! empty( $items_json ) ? json_decode( $items_json, true ) : array();
                    ?>
                    <div style="margin: 20px 0; padding: 25px; background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%); border: 3px solid #ff9800; border-radius: 8px; box-shadow: 0 4px 12px rgba(255,152,0,0.3); position: relative;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h3 style="margin: 0 0 10px 0; color: #bf360c; font-size: 20px; display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 32px;">⚠️</span>
                                    <span>Client Updated Items - Review Required</span>
                                </h3>
                                <p style="margin: 0; color: #856404; font-size: 15px; font-weight: 500;">
                                    <?php if ( $last_client_updater ) : ?>
                                        Updated by: <strong><?php echo esc_html( $last_client_updater ); ?></strong>
                                    <?php endif; ?>
                                    <?php if ( $last_client_update ) : ?>
                                        on <?php echo esc_html( date_i18n( get_option( 'date_format' ) . ' ' . get_option( 'time_format' ), strtotime( $last_client_update ) ) ); ?>
                                    <?php endif; ?>
                                </p>
                            </div>
                            <form method="post" style="margin: 0;">
                                <?php wp_nonce_field( 'n88_clear_updates' ); ?>
                                <input type="hidden" name="project_id" value="<?php echo esc_attr( $project_id ); ?>">
                                <button type="submit" name="n88_clear_updates" value="1" class="button button-primary" style="background: #ff9800; border-color: #f57c00; color: #fff; font-weight: 700; padding: 10px 20px; font-size: 14px; box-shadow: 0 2px 8px rgba(255,152,0,0.4);">✓ Mark as Viewed</button>
                            </form>
                        </div>
                        
                        <?php if ( ! empty( $items ) ) : ?>
                            <div style="background: white; border-radius: 6px; padding: 20px; margin-top: 15px; border: 2px solid #ff9800;">
                                <h4 style="margin: 0 0 15px 0; color: #bf360c; font-size: 16px; font-weight: 700;">Updated Items (<?php echo count( $items ); ?>):</h4>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                        <thead>
                                            <tr style="background: #fff3cd; border-bottom: 2px solid #ff9800;">
                                                <th style="padding: 12px; text-align: left; font-weight: 700; color: #856404;">Item #</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 700; color: #856404;">Material</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 700; color: #856404;">Dimensions (L×D×H)</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 700; color: #856404;">Quantity</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 700; color: #856404;">Construction Notes</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 700; color: #856404;">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php foreach ( $items as $index => $item ) : 
                                                $item_num = $index + 1;
                                                
                                                // Handle dimensions
                                                $length = $item['length_in'] ?? '';
                                                $depth = $item['depth_in'] ?? '';
                                                $height = $item['height_in'] ?? '';
                                                if ( isset( $item['dimensions'] ) && is_array( $item['dimensions'] ) ) {
                                                    $length = $item['dimensions']['length'] ?? $length;
                                                    $depth = $item['dimensions']['depth'] ?? $depth;
                                                    $height = $item['dimensions']['height'] ?? $height;
                                                }
                                                
                                                // Handle primary material
                                                $primary_material = $item['primary_material'] ?? '';
                                                if ( isset( $item['materials'] ) && is_array( $item['materials'] ) ) {
                                                    $primary_material = implode( ', ', $item['materials'] );
                                                }
                                            ?>
                                                <tr style="border-bottom: 1px solid #eee; background: <?php echo ( $index % 2 === 0 ) ? '#fff' : '#fffbf0'; ?>;">
                                                    <td style="padding: 12px; font-weight: 700; color: #ff9800; font-size: 16px;">#<?php echo esc_html( $item_num ); ?></td>
                                                    <td style="padding: 12px;"><?php echo esc_html( $primary_material ?: '—' ); ?></td>
                                                    <td style="padding: 12px; font-weight: 600;"><?php echo esc_html( $length . '×' . $depth . '×' . $height ); ?></td>
                                                    <td style="padding: 12px; font-weight: 600;"><?php echo esc_html( $item['quantity'] ?? '—' ); ?></td>
                                                    <td style="padding: 12px; color: #666;"><?php echo nl2br( esc_html( $item['construction_notes'] ?? '—' ) ); ?></td>
                                                    <td style="padding: 12px; color: #666; max-width: 200px;"><?php echo esc_html( $item['notes'] ?? '—' ); ?></td>
                                                </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        <?php else : ?>
                            <div style="background: white; border-radius: 6px; padding: 20px; margin-top: 15px; text-align: center; color: #856404;">
                                <p style="margin: 0;">No items found in this project.</p>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>

                <div style="background: white; padding: 20px; border-radius: 5px; margin: 20px 0; position: relative;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <h3 style="margin: 0;"><?php echo esc_html( $project['project_name'] ); ?></h3>
                        <?php if ( $has_client_updates ) : ?>
                            <span style="background: #ff5252; color: #fff; padding: 4px 10px; border-radius: 999px; font-weight: 600; font-size: 12px; letter-spacing: 0.5px;">NEW UPDATES</span>
                            <span style="background: #ffe0b2; color: #bf360c; padding: 4px 10px; border-radius: 999px; font-weight: 600; font-size: 12px;">Updated by Client</span>
                        <?php endif; ?>
                    </div>
                    <p><strong>Client:</strong> <?php echo esc_html( $project['metadata']['n88_company_name'] ?? 'N/A' ); ?></p>
                    <p><strong>Contact:</strong> <?php echo esc_html( $project['metadata']['n88_contact_name'] ?? 'N/A' ); ?></p>
                    <?php if ( $has_client_updates && $client_updates_viewed ) : ?>
                        <p style="margin-top: 10px; background: #e8f5e9; padding: 10px; border-radius: 4px; color: #2e7d32;">
                            <strong>✓ Client updates were reviewed on:</strong>
                            <?php
                                $viewed_at = $project['metadata']['n88_client_updates_viewed_at'] ?? '';
                                $viewed_by = $project['metadata']['n88_client_updates_viewed_by'] ?? '';
                                if ( $viewed_by ) {
                                    $viewer = get_userdata( (int) $viewed_by );
                                    if ( $viewer ) {
                                        echo esc_html( $viewer->display_name );
                                    }
                                }
                                if ( $viewed_at ) {
                                    echo ' • ' . esc_html( date_i18n( get_option( 'date_format' ) . ' ' . get_option( 'time_format' ), strtotime( $viewed_at ) ) );
                                }
                            ?>
                        </p>
                    <?php endif; ?>
                </div>

                <?php if ( $latest_quote ) : ?>
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 5px; margin: 20px 0; position: relative;">
                        <h3>Current Quote</h3>
                        <?php if ( $has_client_updates ) : ?>
                            <div style="margin-bottom: 20px; padding: 15px; background: #fff8e1; border-left: 4px solid #ff9800; border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                                    <span style="background: #ff5252; color: #fff; padding: 6px 12px; border-radius: 999px; font-weight: 700; font-size: 13px; letter-spacing: 0.5px;">NEW UPDATES</span>
                                    <span style="background: #ffe0b2; color: #bf360c; padding: 6px 12px; border-radius: 999px; font-weight: 700; font-size: 13px;">Updated by Client</span>
                                </div>
                                <?php if ( $last_client_update ) : ?>
                                    <p style="margin: 8px 0 0 0; color: #856404; font-size: 14px;">
                                        <strong>Latest Client Update:</strong>
                                        <?php
                                            if ( $last_client_updater ) {
                                                echo esc_html( $last_client_updater ) . ' • ';
                                            }
                                            echo esc_html( date_i18n( get_option( 'date_format' ) . ' ' . get_option( 'time_format' ), strtotime( $last_client_update ) ) );
                                        ?>
                                    </p>
                                <?php endif; ?>
                                <form method="post" style="margin-top: 12px;">
                                    <?php wp_nonce_field( 'n88_clear_updates' ); ?>
                                    <input type="hidden" name="project_id" value="<?php echo esc_attr( $project_id ); ?>">
                                    <button type="submit" name="n88_clear_updates" value="1" class="button button-primary">Mark Client Updates as Reviewed</button>
                                </form>
                            </div>
                        <?php endif; ?>
                        <p><strong>Status:</strong> 
                            <?php 
                            $status_display = $latest_quote->quote_status;
                            if ( $status_display === 'quote_updated' ) {
                                echo '<span style="color: #ff9800; font-weight: bold;">Quote Updated</span>';
                            } elseif ( $status_display === 'sent' ) {
                                echo '<span style="color: #4caf50; font-weight: bold;">Quote Sent</span>';
                            } else {
                                echo esc_html( ucfirst( $status_display ) );
                            }
                            ?>
                        </p>
                        <p><strong>Created:</strong> <?php echo esc_html( date_i18n( get_option( 'date_format' ) . ' ' . get_option( 'time_format' ), strtotime( $latest_quote->created_at ) ) ); ?></p>
                        <?php if ( $latest_quote->sent_at ) : ?>
                            <p><strong>Sent:</strong> <?php echo esc_html( date_i18n( get_option( 'date_format' ) . ' ' . get_option( 'time_format' ), strtotime( $latest_quote->sent_at ) ) ); ?></p>
                        <?php endif; ?>
                        <?php
                        $quote_formatted = N88_RFQ_Quotes::format_quote( $latest_quote );
                        ?>
                        <p><a href="<?php echo esc_url( $quote_formatted['quote_file_url'] ); ?>" class="button button-primary">Download Quote</a></p>

                            <?php
                        $has_pricing = (
                            ! empty( $quote_formatted['unit_price'] ) ||
                            ! empty( $quote_formatted['total_price'] ) ||
                            ! empty( $quote_formatted['lead_time'] ) ||
                            ! empty( $quote_formatted['cbm_volume'] )
                        );
                        ?>

                        <?php if ( $has_pricing ) : ?>
                            <div class="n88-pricing-summary-container" style="margin-top: 20px; padding: 15px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">
                                <h4 style="margin-top: 0; color: #007cba;">Pricing Summary</h4>
                                <div class="n88-pricing-summary-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                                    <?php if ( ! empty( $quote_formatted['unit_price'] ) ) : ?>
                                        <div style="padding: 10px; background: #f0f7ff; border-radius: 4px;">
                                            <div style="font-size: 12px; color: #666;">Unit Price</div>
                                            <div class="n88-unit-price" style="font-size: 20px; font-weight: bold; color: #007cba;">$<?php echo number_format( $quote_formatted['unit_price'], 2 ); ?></div>
                                        </div>
                                    <?php endif; ?>
                                    <?php if ( ! empty( $quote_formatted['total_price'] ) ) : ?>
                                        <div style="padding: 10px; background: #f0f7ff; border-radius: 4px;">
                                            <div style="font-size: 12px; color: #666;">Total Price</div>
                                            <div class="n88-total-price" style="font-size: 20px; font-weight: bold; color: #4caf50;">$<?php echo number_format( $quote_formatted['total_price'], 2 ); ?></div>
                                        </div>
                                    <?php endif; ?>
                                    <?php if ( ! empty( $quote_formatted['lead_time'] ) ) : ?>
                                        <div style="padding: 10px; background: #fff8e1; border-radius: 4px;">
                                            <div style="font-size: 12px; color: #666;">Lead Time</div>
                                            <div class="n88-lead-time" style="font-size: 16px; font-weight: bold; color: #ff9800;"><?php echo esc_html( $quote_formatted['lead_time'] ); ?></div>
                                        </div>
                                    <?php endif; ?>
                                    <?php if ( ! empty( $quote_formatted['cbm_volume'] ) ) : ?>
                                        <div style="padding: 10px; background: #f9f9f9; border-radius: 4px;">
                                            <div style="font-size: 12px; color: #666;">Total Volume</div>
                                            <div class="n88-cbm-volume" style="font-size: 16px; font-weight: bold; color: #333;"><?php echo number_format( $quote_formatted['cbm_volume'], 4 ); ?> m³</div>
                                        </div>
                                    <?php endif; ?>
                                </div>

                                <?php if ( ! empty( $quote_formatted['volume_rules_applied'] ) ) : ?>
                                    <div class="n88-volume-rules" style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                                        <strong style="color: #856404;">Volume Rules Applied:</strong>
                                        <ul style="margin: 8px 0 0 20px; color: #856404;">
                                            <?php foreach ( $quote_formatted['volume_rules_applied'] as $rule ) : ?>
                                                <li><?php echo esc_html( $rule ); ?></li>
                                            <?php endforeach; ?>
                                        </ul>
                                    </div>
                                <?php endif; ?>

                                <?php if ( $quote_formatted['labor_cost'] || $quote_formatted['materials_cost'] || $quote_formatted['overhead_cost'] ) : ?>
                                    <div style="margin-top: 15px; padding: 12px; background: #f9f9f9; border-radius: 4px;">
                                        <strong>Cost Breakdown:</strong>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; font-size: 14px;">
                                            <?php if ( $quote_formatted['labor_cost'] ) : ?>
                                                <div>Labor: $<?php echo number_format( $quote_formatted['labor_cost'], 2 ); ?></div>
                                            <?php endif; ?>
                                            <?php if ( $quote_formatted['materials_cost'] ) : ?>
                                                <div>Materials: $<?php echo number_format( $quote_formatted['materials_cost'], 2 ); ?></div>
                                            <?php endif; ?>
                                            <?php if ( $quote_formatted['overhead_cost'] ) : ?>
                                                <div>Overhead: $<?php echo number_format( $quote_formatted['overhead_cost'], 2 ); ?></div>
                                            <?php endif; ?>
                                            <?php if ( $quote_formatted['margin_percentage'] ) : ?>
                                                <div>Margin: <?php echo number_format( $quote_formatted['margin_percentage'], 2 ); ?>%</div>
                                            <?php endif; ?>
                                            <?php if ( ! empty( $quote_formatted['shipping_zone'] ) ) : ?>
                                                <div>Shipping Zone: <?php echo esc_html( ucfirst( $quote_formatted['shipping_zone'] ) ); ?></div>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                <?php endif; ?>
                            </div>
                        <?php endif; ?>

                        <!-- Editable Quote Form - All fields shown with saved values -->
                        <div style="background: #fff; padding: 20px; border-radius: 5px; margin: 20px 0; border: 1px solid #ddd;">
                            <?php if ( $latest_quote->quote_status === 'sent' ) : ?>
                                <p class="description" style="margin-bottom: 20px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4caf50; color: #2e7d32;">
                                    <strong>✓ Quote was sent on <?php echo esc_html( date_i18n( get_option( 'date_format' ) . ' ' . get_option( 'time_format' ), strtotime( $latest_quote->sent_at ) ) ); ?>.</strong> 
                                    You can update any fields below and resend the updated quote to the client.
                                </p>
                            <?php endif; ?>
                            <?php
                            if ( isset( $_POST['n88_update_quote'] ) && check_admin_referer( 'n88_update_quote' ) ) {
                                $update_data = array();
                                
                                // Handle file upload if provided
                                if ( ! empty( $_FILES['quote_file']['tmp_name'] ) ) {
                                    $uploaded_file_path = N88_RFQ_Quotes::handle_quote_file_upload( $_FILES['quote_file'], $project_id, $latest_quote->id );
                                    if ( $uploaded_file_path ) {
                                        $update_data['quote_file_path'] = $uploaded_file_path;
                                    }
                                }
                                
                                if ( isset( $_POST['admin_notes'] ) ) {
                                    $update_data['admin_notes'] = sanitize_textarea_field( $_POST['admin_notes'] );
                                }
                                
                                // Always include client_message if the form is being submitted (even if empty)
                                // Textareas are always in POST, even if empty, so we can safely check and save
                                $update_data['client_message'] = isset( $_POST['client_message'] ) ? sanitize_textarea_field( $_POST['client_message'] ) : '';
                                
                                // Handle project items update (when quote is sent)
                                if ( isset( $_POST['project_items'] ) && is_array( $_POST['project_items'] ) && in_array( $latest_quote->quote_status, array( 'sent', 'quote_updated', 'quoted' ), true ) ) {
                                    $updated_items = array();
                                    $items_json = $projects_class->get_project_metadata( $project_id, 'n88_repeater_raw' );
                                    $current_items = ! empty( $items_json ) ? json_decode( $items_json, true ) : array();
                                    
                                    foreach ( $_POST['project_items'] as $index => $item_data ) {
                                        if ( isset( $current_items[ $index ] ) ) {
                                            $item = $current_items[ $index ];
                                            
                                            // Update dimensions
                                            if ( isset( $item_data['dimensions_length'] ) ) {
                                                $item['length_in'] = sanitize_text_field( $item_data['dimensions_length'] );
                                                if ( isset( $item['dimensions'] ) ) {
                                                    $item['dimensions']['length'] = $item['length_in'];
                                                }
                                            }
                                            if ( isset( $item_data['dimensions_depth'] ) ) {
                                                $item['depth_in'] = sanitize_text_field( $item_data['dimensions_depth'] );
                                                if ( isset( $item['dimensions'] ) ) {
                                                    $item['dimensions']['depth'] = $item['depth_in'];
                                                }
                                            }
                                            if ( isset( $item_data['dimensions_height'] ) ) {
                                                $item['height_in'] = sanitize_text_field( $item_data['dimensions_height'] );
                                                if ( isset( $item['dimensions'] ) ) {
                                                    $item['dimensions']['height'] = $item['height_in'];
                                                }
                                            }
                                            
                                            // Update other fields
                                            if ( isset( $item_data['quantity'] ) ) {
                                                $item['quantity'] = intval( $item_data['quantity'] );
                                            }
                                            if ( isset( $item_data['primary_material'] ) ) {
                                                $item['primary_material'] = sanitize_text_field( $item_data['primary_material'] );
                                                if ( isset( $item['materials'] ) ) {
                                                    $item['materials']['primary'] = $item['primary_material'];
                                                }
                                            }
                                            if ( isset( $item_data['finishes'] ) ) {
                                                $item['finishes'] = sanitize_text_field( $item_data['finishes'] );
                                            }
                                            if ( isset( $item_data['construction_notes'] ) ) {
                                                $item['construction_notes'] = sanitize_textarea_field( $item_data['construction_notes'] );
                                            }
                                            
                                            $updated_items[] = $item;
                                        }
                                    }
                                    
                                    // Save updated items
                                    if ( ! empty( $updated_items ) ) {
                                        $projects_class->save_project_metadata( $project_id, array(
                                            'n88_repeater_raw' => wp_json_encode( $updated_items ),
                                        ) );
                                    }
                                }
                                
                                // Handle quote items update
                                if ( isset( $_POST['quote_items'] ) && is_array( $_POST['quote_items'] ) ) {
                                    $quote_items = array();
                                    foreach ( $_POST['quote_items'] as $item_data ) {
                                        $unit_price = isset( $item_data['unit_price'] ) ? (float) $item_data['unit_price'] : 0;
                                        $quantity = isset( $item_data['quantity'] ) ? (int) $item_data['quantity'] : 0;
                                        $total_price = isset( $item_data['total_price'] ) ? (float) $item_data['total_price'] : ( $unit_price * $quantity );
                                        
                                        $quote_items[] = array(
                                            'item_id' => isset( $item_data['item_id'] ) ? sanitize_text_field( $item_data['item_id'] ) : '',
                                            'unit_price' => $unit_price,
                                            'quantity' => $quantity,
                                            'total_price' => $total_price,
                                            'dimensions' => isset( $item_data['dimensions'] ) ? sanitize_text_field( $item_data['dimensions'] ) : '',
                                            'material' => isset( $item_data['material'] ) ? sanitize_text_field( $item_data['material'] ) : '',
                                            'notes' => isset( $item_data['notes'] ) ? sanitize_textarea_field( $item_data['notes'] ) : '',
                                        );
                                    }
                                    $update_data['quote_items'] = wp_json_encode( $quote_items );
                                }
                                
                                if ( isset( $_POST['labor_cost'] ) || isset( $_POST['materials_cost'] ) || isset( $_POST['overhead_cost'] ) ) {
                                    $update_data['labor_cost'] = isset( $_POST['labor_cost'] ) ? (float) $_POST['labor_cost'] : $latest_quote->labor_cost ?? 0;
                                    $update_data['materials_cost'] = isset( $_POST['materials_cost'] ) ? (float) $_POST['materials_cost'] : $latest_quote->materials_cost ?? 0;
                                    $update_data['overhead_cost'] = isset( $_POST['overhead_cost'] ) ? (float) $_POST['overhead_cost'] : $latest_quote->overhead_cost ?? 0;
                                    $update_data['margin_percentage'] = isset( $_POST['margin_percentage'] ) ? (float) $_POST['margin_percentage'] : $latest_quote->margin_percentage ?? 0;
                                    $update_data['shipping_zone'] = isset( $_POST['shipping_zone'] ) ? sanitize_text_field( $_POST['shipping_zone'] ) : ( $latest_quote->shipping_zone ?? '' );
                                    
                                    // Recalculate pricing
                                    if ( class_exists( 'N88_RFQ_Pricing' ) ) {
                                        $pricing_result = N88_RFQ_Pricing::calculate_project_pricing(
                                            $project_id,
                                            $update_data['labor_cost'],
                                            $update_data['materials_cost'],
                                            $update_data['overhead_cost'],
                                            $update_data['margin_percentage'],
                                            $update_data['shipping_zone']
                                        );
                                        
                                        if ( $pricing_result ) {
                                            $update_data['unit_price'] = $pricing_result['final_unit_price'];
                                            $update_data['total_price'] = $pricing_result['total_price'];
                                            $update_data['lead_time'] = $pricing_result['lead_time'];
                                            $update_data['cbm_volume'] = $pricing_result['total_cbm'];
                                            $update_data['volume_rules_applied'] = wp_json_encode( $pricing_result['volume_rules_applied'] );
                                        }
                                    }
                                }
                                
                                // Check if we should also send the quote
                                $should_send = isset( $_POST['n88_update_and_send'] ) && $_POST['n88_update_and_send'] === '1';
                                
                                // If quote was already sent and we're updating it, change status to quote_updated
                                // This should happen regardless of what fields are being updated
                                // Check for 'sent', 'quote_updated', or 'quoted' status
                                if ( in_array( $latest_quote->quote_status, array( 'sent', 'quote_updated', 'quoted' ), true ) ) {
                                    // Always set status to quote_updated if updating an already-sent quote
                                    $update_data['quote_status'] = 'quote_updated';
                                }
                                
                                if ( ! empty( $update_data ) ) {
                                    if ( N88_RFQ_Quotes::update_quote( $latest_quote->id, $update_data ) ) {
                                        // Refresh quote data after update
                                        $latest_quote = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}project_quotes WHERE id = %d", $latest_quote->id ) );
                                        $quote_formatted = N88_RFQ_Quotes::format_quote( $latest_quote );
                                        
                                        // Track admin updates
                                        $projects_class->save_project_metadata( $project_id, array(
                                            'n88_has_admin_updates' => '1',
                                            'n88_last_admin_update' => current_time( 'mysql' ),
                                            'n88_last_admin_update_by' => (string) get_current_user_id(),
                                        ) );

                                        // If send was requested, send the quote but preserve quote_updated status
                                        if ( $should_send ) {
                                            // Update status to quote_updated before sending if it was already sent
                                            if ( in_array( $latest_quote->quote_status, array( 'sent', 'quote_updated', 'quoted' ), true ) ) {
                                                $wpdb->update(
                                                    $wpdb->prefix . 'project_quotes',
                                                    array( 'quote_status' => 'quote_updated' ),
                                                    array( 'id' => $latest_quote->id ),
                                                    array( '%s' ),
                                                    array( '%d' )
                                                );
                                            }
                                if ( N88_RFQ_Quotes::send_quote( $latest_quote->id, get_current_user_id() ) ) {
                                                echo '<div class="notice notice-success"><p>Quote updated and sent to client successfully! Client has been notified.</p></div>';
                                                // Refresh quote data after sending
                                                $latest_quote = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}project_quotes WHERE id = %d", $latest_quote->id ) );
                                                $quote_formatted = N88_RFQ_Quotes::format_quote( $latest_quote );
                                            } else {
                                                echo '<div class="notice notice-warning"><p>Quote updated successfully, but failed to send. Please try sending again.</p></div>';
                                            }
                                        } else {
                                            // Just notify client of update
                                            if ( class_exists( 'N88_RFQ_Notifications' ) ) {
                                                $project = $projects_class->get_project_admin( $project_id );
                                                if ( $project && ! empty( $project['user_id'] ) ) {
                                                    N88_RFQ_Notifications::create_notification(
                                                        $project_id,
                                                        $project['user_id'],
                                                        'quote_updated_by_admin',
                                                        'Admin updated your quote. Please review the changes.',
                                                        $latest_quote->id
                                                    );
                                                }
                                            }
                                            echo '<div class="notice notice-success"><p>Quote updated successfully! Status changed to "Quote Updated". Client has been notified.</p></div>';
                                        }
                                    } else {
                                        echo '<div class="notice notice-error"><p>Failed to update quote. Please try again.</p></div>';
                                    }
                                } elseif ( $should_send ) {
                                    // If no updates but send was requested, just send
                                    if ( N88_RFQ_Quotes::send_quote( $latest_quote->id, get_current_user_id() ) ) {
                                        echo '<div class="notice notice-success"><p>Quote sent to client successfully!</p></div>';
                                        // Refresh quote data
                                        $latest_quote = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}project_quotes WHERE id = %d", $latest_quote->id ) );
                                        $quote_formatted = N88_RFQ_Quotes::format_quote( $latest_quote );
                                    }
                                }
                            }
                            ?>
                            <form method="post" enctype="multipart/form-data" id="n88-edit-quote-form">
                                <?php wp_nonce_field( 'n88_update_quote' ); ?>
                                <table class="form-table">
                                    <tr>
                                        <th scope="row"><label for="edit_admin_notes">Internal Notes</label></th>
                                        <td>
                                            <textarea name="admin_notes" id="edit_admin_notes" rows="4" cols="60"><?php echo esc_textarea( $latest_quote->admin_notes ?? '' ); ?></textarea>
                                            <p class="description">Internal notes visible only to admins.</p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row"><label for="edit_client_message">Important Message to Client</label></th>
                                        <td>
                                            <textarea name="client_message" id="edit_client_message" rows="4" cols="60" placeholder="Add an important note or message for the client..."><?php echo esc_textarea( $latest_quote->client_message ?? '' ); ?></textarea>
                                            <p class="description">This message will be visible to the client on the quote.</p>
                                        </td>
                                    </tr>
                                    <?php if ( N88_RFQ_Quotes::quote_table_supports_pricing() ) : ?>
                                        <tr>
                                            <th scope="row"><label>Pricing</label></th>
                                            <td>
                                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                                    <div>
                                                        <label for="edit_labor_cost">Labor Cost</label>
                                                        <input type="number" name="labor_cost" id="edit_labor_cost" step="0.01" value="<?php echo esc_attr( $latest_quote->labor_cost ?? 0 ); ?>" style="width: 100%;">
                                                    </div>
                                                    <div>
                                                        <label for="edit_materials_cost">Materials Cost</label>
                                                        <input type="number" name="materials_cost" id="edit_materials_cost" step="0.01" value="<?php echo esc_attr( $latest_quote->materials_cost ?? 0 ); ?>" style="width: 100%;">
                                                    </div>
                                                    <div>
                                                        <label for="edit_overhead_cost">Overhead Cost</label>
                                                        <input type="number" name="overhead_cost" id="edit_overhead_cost" step="0.01" value="<?php echo esc_attr( $latest_quote->overhead_cost ?? 0 ); ?>" style="width: 100%;">
                                                    </div>
                                                    <div>
                                                        <label for="edit_margin_percentage">Margin %</label>
                                                        <input type="number" name="margin_percentage" id="edit_margin_percentage" step="0.01" value="<?php echo esc_attr( $latest_quote->margin_percentage ?? 0 ); ?>" style="width: 100%;">
                                                    </div>
                                                    <div>
                                                        <label for="edit_shipping_zone">Shipping Zone</label>
                                                        <select name="shipping_zone" id="edit_shipping_zone" style="width: 100%;">
                                                            <option value="domestic" <?php selected( $latest_quote->shipping_zone ?? '', 'domestic' ); ?>>Domestic</option>
                                                            <option value="international" <?php selected( $latest_quote->shipping_zone ?? '', 'international' ); ?>>International</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                        <?php endif; ?>
                                    <tr>
                                        <th scope="row"><label for="edit_quote_file">Update Quote File (Optional)</label></th>
                                        <td>
                                            <?php if ( ! empty( $latest_quote->quote_file_path ) ) : ?>
                                                <p style="margin: 0 0 10px 0;">
                                                    <strong>Current file:</strong> 
                                                    <a href="<?php echo esc_url( wp_get_upload_dir()['baseurl'] . '/' . $latest_quote->quote_file_path ); ?>" target="_blank" style="color: #007cba;">
                                                        <?php echo esc_html( basename( $latest_quote->quote_file_path ) ); ?>
                                                    </a>
                                                </p>
                                            <?php endif; ?>
                                            <input type="file" name="quote_file" id="edit_quote_file" accept=".pdf,.jpg,.jpeg,.png,.dwg">
                                            <p class="description">Upload a new quote file (PDF, JPG, PNG, or DWG). Leave empty to keep the current file.</p>
                                        </td>
                                    </tr>
                                </table>
                                
                                <!-- Quote Items Table (Editable) -->
                                <?php
                                // Get quote items if they exist, otherwise use project items
                                $quote_items_json = $latest_quote->quote_items ?? '';
                                $quote_items = ! empty( $quote_items_json ) ? json_decode( $quote_items_json, true ) : array();
                                
                                // If no quote items, initialize from project items
                                if ( empty( $quote_items ) && ! empty( $items ) ) {
                                    foreach ( $items as $index => $item ) {
                                        $length = isset( $item['length_in'] ) ? $item['length_in'] : ( $item['dimensions']['length'] ?? '' );
                                        $depth  = isset( $item['depth_in'] ) ? $item['depth_in'] : ( $item['dimensions']['depth'] ?? '' );
                                        $height = isset( $item['height_in'] ) ? $item['height_in'] : ( $item['dimensions']['height'] ?? '' );
                                        $quote_items[] = array(
                                            'item_id' => 'item_' . $index,
                                            'unit_price' => 0,
                                            'quantity' => $item['quantity'] ?? 0,
                                            'total_price' => 0,
                                            'dimensions' => trim( sprintf( '%s × %s × %s', $length, $depth, $height ) ),
                                            'material' => $item['primary_material'] ?? $item['materials']['primary'] ?? '',
                                            'notes' => $item['notes'] ?? '',
                                        );
                                    }
                                }
                                ?>
                                
                                <?php if ( ! empty( $quote_items ) || ! empty( $items ) ) : ?>
                                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                                        <h4 style="margin-top: 0;">Quote Items Table (Editable)</h4>
                                        <p class="description">Edit pricing, dimensions, and notes for each item. Changes will be saved to the quote.</p>
                                        <div style="overflow-x: auto; margin-top: 15px;">
                                            <table class="widefat fixed" id="n88-quote-items-table" style="min-width: 1000px;">
                                                <thead>
                                                    <tr style="background: #f5f5f5;">
                                                        <th style="width: 50px; padding: 10px;">#</th>
                                                        <th style="padding: 10px;">Item ID</th>
                                                        <th style="padding: 10px;">Dimensions</th>
                                                        <th style="padding: 10px;">Material</th>
                                                        <th style="padding: 10px;">Quantity</th>
                                                        <th style="padding: 10px;">Unit Price ($)</th>
                                                        <th style="padding: 10px;">Total Price ($)</th>
                                                        <th style="padding: 10px;">Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <?php 
                                                    $display_items = ! empty( $quote_items ) ? $quote_items : array();
                                                    if ( empty( $display_items ) && ! empty( $items ) ) {
                                                        foreach ( $items as $index => $item ) {
                                                            $length = isset( $item['length_in'] ) ? $item['length_in'] : ( $item['dimensions']['length'] ?? '' );
                                                            $depth  = isset( $item['depth_in'] ) ? $item['depth_in'] : ( $item['dimensions']['depth'] ?? '' );
                                                            $height = isset( $item['height_in'] ) ? $item['height_in'] : ( $item['dimensions']['height'] ?? '' );
                                                            $display_items[] = array(
                                                                'item_id' => 'item_' . $index,
                                                                'unit_price' => 0,
                                                                'quantity' => $item['quantity'] ?? 0,
                                                                'total_price' => 0,
                                                                'dimensions' => trim( sprintf( '%s × %s × %s', $length, $depth, $height ) ),
                                                                'material' => $item['primary_material'] ?? $item['materials']['primary'] ?? '',
                                                                'notes' => $item['notes'] ?? '',
                                                            );
                                                        }
                                                    }
                                                    foreach ( $display_items as $index => $quote_item ) : 
                                                    ?>
                                                        <tr class="n88-quote-item-row">
                                                            <td style="padding: 10px; text-align: center; font-weight: bold;"><?php echo esc_html( $index + 1 ); ?></td>
                                                            <td style="padding: 10px;">
                                                                <input type="hidden" name="quote_items[<?php echo esc_attr( $index ); ?>][item_id]" value="<?php echo esc_attr( $quote_item['item_id'] ?? 'item_' . $index ); ?>">
                                                                <span style="font-weight: 600;"><?php echo esc_html( $quote_item['item_id'] ?? 'item_' . $index ); ?></span>
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <input type="text" name="quote_items[<?php echo esc_attr( $index ); ?>][dimensions]" value="<?php echo esc_attr( $quote_item['dimensions'] ?? '' ); ?>" class="regular-text" placeholder="L × D × H" style="width: 100%;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <input type="text" name="quote_items[<?php echo esc_attr( $index ); ?>][material]" value="<?php echo esc_attr( $quote_item['material'] ?? '' ); ?>" class="regular-text" style="width: 100%;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <input type="number" name="quote_items[<?php echo esc_attr( $index ); ?>][quantity]" value="<?php echo esc_attr( $quote_item['quantity'] ?? 0 ); ?>" class="n88-quote-qty" min="0" step="1" style="width: 80px;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <input type="number" name="quote_items[<?php echo esc_attr( $index ); ?>][unit_price]" value="<?php echo esc_attr( $quote_item['unit_price'] ?? 0 ); ?>" class="n88-quote-unit-price" min="0" step="0.01" style="width: 100px;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <input type="number" name="quote_items[<?php echo esc_attr( $index ); ?>][total_price]" value="<?php echo esc_attr( $quote_item['total_price'] ?? 0 ); ?>" class="n88-quote-total-price" min="0" step="0.01" readonly style="width: 100px; background: #f5f5f5;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <textarea name="quote_items[<?php echo esc_attr( $index ); ?>][notes]" rows="2" class="regular-text" style="width: 100%; resize: vertical;"><?php echo esc_textarea( $quote_item['notes'] ?? '' ); ?></textarea>
                                                            </td>
                                                        </tr>
                                                    <?php endforeach; ?>
                                                </tbody>
                                            </table>
                                        </div>
                                        <p class="description" style="margin-top: 10px;">💡 <strong>Tip:</strong> Unit Price × Quantity = Total Price (auto-calculated)</p>
                    </div>
                <?php endif; ?>

                                <!-- Project Items Table (Editable) - Inside form when quote is sent -->
                                <?php
                                // Get project items for editing
                                $items_json = $projects_class->get_project_metadata( $project_id, 'n88_repeater_raw' );
                                $items = ! empty( $items_json ) ? json_decode( $items_json, true ) : array();
                                ?>
                                
                                <?php if ( ! empty( $items ) && ( $latest_quote->quote_status === 'sent' || $latest_quote->quote_status === 'quote_updated' ) ) : ?>
                                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                                        <h4 style="margin-top: 0;">Project Items (<?php echo count( $items ); ?>) - Editable</h4>
                                        <p class="description">Edit any field in the project items. Changes will be saved when you update the quote.</p>
                                        <div style="overflow-x: auto; margin-top: 15px;">
                                            <table class="widefat fixed" style="min-width: 800px; background: white;">
                                                <thead>
                                                    <tr style="background: #f5f5f5;">
                                                        <th style="width: 50px; padding: 10px;">#</th>
                                                        <th style="padding: 10px;">Dimensions (L × D × H)</th>
                                                        <th style="padding: 10px;">Qty</th>
                                                        <th style="padding: 10px;">Primary Material</th>
                                                        <th style="padding: 10px;">Finishes</th>
                                                        <th style="padding: 10px;">Construction Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <?php foreach ( $items as $index => $item ) : 
                                                        $length = isset( $item['length_in'] ) ? $item['length_in'] : ( $item['dimensions']['length'] ?? '' );
                                                        $depth  = isset( $item['depth_in'] ) ? $item['depth_in'] : ( $item['dimensions']['depth'] ?? '' );
                                                        $height = isset( $item['height_in'] ) ? $item['height_in'] : ( $item['dimensions']['height'] ?? '' );
                                                    ?>
                                                        <tr>
                                                            <td style="padding: 10px; text-align: center; font-weight: bold;"><?php echo esc_html( $index + 1 ); ?></td>
                                                            <td style="padding: 10px;">
                                                                <input type="text" name="project_items[<?php echo esc_attr( $index ); ?>][dimensions_length]" value="<?php echo esc_attr( $length ); ?>" placeholder="Length" style="width: 80px; margin-right: 5px;">
                                                                <span>×</span>
                                                                <input type="text" name="project_items[<?php echo esc_attr( $index ); ?>][dimensions_depth]" value="<?php echo esc_attr( $depth ); ?>" placeholder="Depth" style="width: 80px; margin: 0 5px;">
                                                                <span>×</span>
                                                                <input type="text" name="project_items[<?php echo esc_attr( $index ); ?>][dimensions_height]" value="<?php echo esc_attr( $height ); ?>" placeholder="Height" style="width: 80px; margin-left: 5px;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <input type="number" name="project_items[<?php echo esc_attr( $index ); ?>][quantity]" value="<?php echo esc_attr( $item['quantity'] ?? 0 ); ?>" min="0" step="1" style="width: 80px;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <input type="text" name="project_items[<?php echo esc_attr( $index ); ?>][primary_material]" value="<?php echo esc_attr( $item['primary_material'] ?? $item['materials']['primary'] ?? '' ); ?>" class="regular-text" style="width: 100%;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <input type="text" name="project_items[<?php echo esc_attr( $index ); ?>][finishes]" value="<?php echo esc_attr( $item['finishes'] ?? '' ); ?>" class="regular-text" style="width: 100%;">
                                                            </td>
                                                            <td style="padding: 10px;">
                                                                <textarea name="project_items[<?php echo esc_attr( $index ); ?>][construction_notes]" rows="2" class="regular-text" style="width: 100%; resize: vertical;"><?php echo esc_textarea( $item['construction_notes'] ?? '' ); ?></textarea>
                                                            </td>
                                                        </tr>
                                                    <?php endforeach; ?>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                <?php endif; ?>

                                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                    <button type="submit" name="n88_update_quote" value="1" class="button button-primary" style="padding: 10px 20px; font-size: 14px;">
                                        💾 Update Quote
                                    </button>
                                    <button type="submit" name="n88_update_and_send" value="1" class="button button-success" style="padding: 10px 20px; font-size: 14px; background: #4caf50; border-color: #45a049;">
                                        📤 Update & Send to Client
                                    </button>
                                    <p class="description" style="margin: 0; color: #666;">
                                        Click "Update Quote" to save changes, or "Update & Send to Client" to save and send immediately with notifications.
                                    </p>
                                  
                                    <?php if ( N88_RFQ_Quotes::quote_table_supports_pricing() ) : ?>
                                        <button type="button" id="n88-recalculate-pricing" class="button" style="background: #ff9800; border-color: #f57c00; color: white; padding: 10px 20px; font-size: 14px;">
                                            🧮 Recalculate Pricing
                                        </button>
                                    <?php endif; ?>
                                </div>
                            </form>
                            
                            <!-- Handle Update & Send -->
                            <?php
                            if ( isset( $_POST['n88_update_and_send_quote'] ) && check_admin_referer( 'n88_update_quote' ) ) {
                                // First update the quote (same logic as n88_update_quote)
                                $update_data = array();
                                
                                // Handle file upload if provided
                                if ( ! empty( $_FILES['quote_file']['tmp_name'] ) ) {
                                    $uploaded_file_path = N88_RFQ_Quotes::handle_quote_file_upload( $_FILES['quote_file'], $project_id, $latest_quote->id );
                                    if ( $uploaded_file_path ) {
                                        $update_data['quote_file_path'] = $uploaded_file_path;
                                    }
                                }
                                
                                if ( isset( $_POST['admin_notes'] ) ) {
                                    $update_data['admin_notes'] = sanitize_textarea_field( $_POST['admin_notes'] );
                                }
                                
                                // Always include client_message if the form is being submitted (even if empty)
                                // Textareas are always in POST, even if empty, so we can safely check and save
                                $update_data['client_message'] = isset( $_POST['client_message'] ) ? sanitize_textarea_field( $_POST['client_message'] ) : '';
                                
                                // Handle quote items update
                                if ( isset( $_POST['quote_items'] ) && is_array( $_POST['quote_items'] ) ) {
                                    $quote_items = array();
                                    foreach ( $_POST['quote_items'] as $item_data ) {
                                        $unit_price = isset( $item_data['unit_price'] ) ? (float) $item_data['unit_price'] : 0;
                                        $quantity = isset( $item_data['quantity'] ) ? (int) $item_data['quantity'] : 0;
                                        $total_price = isset( $item_data['total_price'] ) ? (float) $item_data['total_price'] : ( $unit_price * $quantity );
                                        
                                        $quote_items[] = array(
                                            'item_id' => isset( $item_data['item_id'] ) ? sanitize_text_field( $item_data['item_id'] ) : '',
                                            'unit_price' => $unit_price,
                                            'quantity' => $quantity,
                                            'total_price' => $total_price,
                                            'dimensions' => isset( $item_data['dimensions'] ) ? sanitize_text_field( $item_data['dimensions'] ) : '',
                                            'material' => isset( $item_data['material'] ) ? sanitize_text_field( $item_data['material'] ) : '',
                                            'notes' => isset( $item_data['notes'] ) ? sanitize_textarea_field( $item_data['notes'] ) : '',
                                        );
                                    }
                                    $update_data['quote_items'] = wp_json_encode( $quote_items );
                                }
                                
                                if ( isset( $_POST['labor_cost'] ) || isset( $_POST['materials_cost'] ) || isset( $_POST['overhead_cost'] ) ) {
                                    $update_data['labor_cost'] = isset( $_POST['labor_cost'] ) ? (float) $_POST['labor_cost'] : $latest_quote->labor_cost ?? 0;
                                    $update_data['materials_cost'] = isset( $_POST['materials_cost'] ) ? (float) $_POST['materials_cost'] : $latest_quote->materials_cost ?? 0;
                                    $update_data['overhead_cost'] = isset( $_POST['overhead_cost'] ) ? (float) $_POST['overhead_cost'] : $latest_quote->overhead_cost ?? 0;
                                    $update_data['margin_percentage'] = isset( $_POST['margin_percentage'] ) ? (float) $_POST['margin_percentage'] : $latest_quote->margin_percentage ?? 0;
                                    $update_data['shipping_zone'] = isset( $_POST['shipping_zone'] ) ? sanitize_text_field( $_POST['shipping_zone'] ) : ( $latest_quote->shipping_zone ?? '' );
                                    
                                    // Recalculate pricing
                                    if ( class_exists( 'N88_RFQ_Pricing' ) ) {
                                        $pricing_result = N88_RFQ_Pricing::calculate_project_pricing(
                                            $project_id,
                                            $update_data['labor_cost'],
                                            $update_data['materials_cost'],
                                            $update_data['overhead_cost'],
                                            $update_data['margin_percentage'],
                                            $update_data['shipping_zone']
                                        );
                                        
                                        if ( $pricing_result ) {
                                            $update_data['unit_price'] = $pricing_result['final_unit_price'];
                                            $update_data['total_price'] = $pricing_result['total_price'];
                                            $update_data['lead_time'] = $pricing_result['lead_time'];
                                            $update_data['cbm_volume'] = $pricing_result['total_cbm'];
                                            $update_data['volume_rules_applied'] = wp_json_encode( $pricing_result['volume_rules_applied'] );
                                        }
                                    }
                                }
                                
                                // If quote was already sent and we're updating it, change status to quote_updated
                                // This should happen regardless of what fields are being updated
                                // Check for 'sent', 'quote_updated', or 'quoted' status
                                if ( in_array( $latest_quote->quote_status, array( 'sent', 'quote_updated', 'quoted' ), true ) ) {
                                    // Always set status to quote_updated if updating an already-sent quote
                                    $update_data['quote_status'] = 'quote_updated';
                                }
                                
                                // Update the quote
                                if ( ! empty( $update_data ) ) {
                                    N88_RFQ_Quotes::update_quote( $latest_quote->id, $update_data );
                                }
                                
                                // Refresh quote data
                                $latest_quote = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}project_quotes WHERE id = %d", $latest_quote->id ) );
                                
                                // Then send the quote - but preserve the quote_updated status if we just set it
                                $preserve_status = ! empty( $update_data['quote_status'] ) && $update_data['quote_status'] === 'quote_updated';
                                if ( N88_RFQ_Quotes::send_quote( $latest_quote->id, get_current_user_id(), $preserve_status ) ) {
                                    // Track admin updates
                                    $projects_class->save_project_metadata( $project_id, array(
                                        'n88_has_admin_updates' => '1',
                                        'n88_last_admin_update' => current_time( 'mysql' ),
                                        'n88_last_admin_update_by' => (string) get_current_user_id(),
                                    ) );

                                    // Notify client
                                    if ( class_exists( 'N88_RFQ_Notifications' ) ) {
                                        $project = $projects_class->get_project_admin( $project_id );
                                        if ( $project && ! empty( $project['user_id'] ) ) {
                                            N88_RFQ_Notifications::create_notification(
                                                $project_id,
                                                $project['user_id'],
                                                'quote_updated_by_admin',
                                                'Admin updated and resent your quote. Please review the changes.',
                                                $latest_quote->id
                                            );
                                        }
                                    }

                                    echo '<div class="notice notice-success"><p>Quote updated and sent successfully! Client has been notified.</p></div>';
                                    // Refresh quote data again
                                    $latest_quote = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}project_quotes WHERE id = %d", $latest_quote->id ) );
                                    $quote_formatted = N88_RFQ_Quotes::format_quote( $latest_quote );
                                }
                            }
                            ?>
                            
                            <script type="text/javascript">
                            (function($) {
                                'use strict';
                                
                                // Auto-calculate total price (unit_price × quantity)
                                $(document).on('input', '.n88-quote-unit-price, .n88-quote-qty', function() {
                                    var $row = $(this).closest('tr');
                                    var unitPrice = parseFloat($row.find('.n88-quote-unit-price').val()) || 0;
                                    var quantity = parseInt($row.find('.n88-quote-qty').val()) || 0;
                                    var totalPrice = unitPrice * quantity;
                                    $row.find('.n88-quote-total-price').val(totalPrice.toFixed(2));
                                });
                                
                                // Initialize totals on page load
                                $(document).ready(function() {
                                    $('.n88-quote-item-row').each(function() {
                                        var $row = $(this);
                                        var unitPrice = parseFloat($row.find('.n88-quote-unit-price').val()) || 0;
                                        var quantity = parseInt($row.find('.n88-quote-qty').val()) || 0;
                                        var totalPrice = unitPrice * quantity;
                                        $row.find('.n88-quote-total-price').val(totalPrice.toFixed(2));
                                    });
                                });
                                
                                // Handle Recalculate Pricing button
                                $('#n88-recalculate-pricing').on('click', function(e) {
                                    e.preventDefault();
                                    var $button = $(this);
                                    var originalText = $button.html();
                                    
                                    // Disable button and show loading
                                    $button.prop('disabled', true).html('⏳ Calculating...');
                                    
                                    // Get pricing values from form
                                    var projectId = <?php echo intval( $project_id ); ?>;
                                    var laborCost = parseFloat($('#edit_labor_cost').val()) || 0;
                                    var materialsCost = parseFloat($('#edit_materials_cost').val()) || 0;
                                    var overheadCost = parseFloat($('#edit_overhead_cost').val()) || 0;
                                    var marginPercentage = parseFloat($('#edit_margin_percentage').val()) || 0;
                                    var shippingZone = $('#edit_shipping_zone').val() || '';
                                    
                                    // Make AJAX call to recalculate pricing
                                    $.ajax({
                                        url: typeof ajaxurl !== 'undefined' ? ajaxurl : '<?php echo admin_url( 'admin-ajax.php' ); ?>',
                                        type: 'POST',
                                        data: {
                                            action: 'n88_calculate_pricing',
                                            nonce: '<?php echo esc_js( N88_RFQ_Helpers::create_ajax_nonce() ); ?>',
                                            project_id: projectId,
                                            labor_cost: laborCost,
                                            materials_cost: materialsCost,
                                            overhead_cost: overheadCost,
                                            margin_percentage: marginPercentage,
                                            shipping_zone: shippingZone
                                        },
                                        success: function(response) {
                                            if (response.success && response.data) {
                                                var pricing = response.data;
                                                
                                                // Update Pricing Summary section dynamically
                                                var $pricingSummary = $('.n88-pricing-summary-container');
                                                if ($pricingSummary.length > 0) {
                                                    // Update existing values
                                                    $pricingSummary.find('.n88-unit-price').text('$' + pricing.final_unit_price.toFixed(2));
                                                    $pricingSummary.find('.n88-total-price').text('$' + pricing.total_price.toFixed(2));
                                                    $pricingSummary.find('.n88-lead-time').text(pricing.lead_time || 'N/A');
                                                    $pricingSummary.find('.n88-cbm-volume').text(pricing.total_cbm.toFixed(4) + ' m³');
                                                    
                                                    // Update volume rules if they exist
                                                    var $volumeRules = $pricingSummary.find('.n88-volume-rules');
                                                    if (pricing.volume_rules_applied && pricing.volume_rules_applied.length > 0) {
                                                        if ($volumeRules.length === 0) {
                                                            $volumeRules = $('<div class="n88-volume-rules" style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;"></div>');
                                                            $pricingSummary.append($volumeRules);
                                                        }
                                                        var rulesHtml = '<strong style="color: #856404;">Volume Rules Applied:</strong><ul style="margin: 8px 0 0 20px; color: #856404;">';
                                                        pricing.volume_rules_applied.forEach(function(rule) {
                                                            rulesHtml += '<li>' + rule + '</li>';
                                                        });
                                                        rulesHtml += '</ul>';
                                                        $volumeRules.html(rulesHtml);
                                                    } else if ($volumeRules.length > 0) {
                                                        $volumeRules.remove();
                                                    }
                                                    
                                                    // Add visual feedback
                                                    $pricingSummary.css('border', '2px solid #4caf50');
                                                    setTimeout(function() {
                                                        $pricingSummary.css('border', '1px solid #e0e0e0');
                                                    }, 2000);
                                                }
                                                
                                                // Show success message
                                                var message = 'Pricing recalculated successfully!\n\n' +
                                                    'Unit Price: $' + pricing.final_unit_price.toFixed(2) + '\n' +
                                                    'Total Price: $' + pricing.total_price.toFixed(2) + '\n' +
                                                    'Total CBM: ' + pricing.total_cbm.toFixed(4) + ' m³\n' +
                                                    'Lead Time: ' + (pricing.lead_time || 'N/A') + '\n\n' +
                                                    'Click "Update Quote" to save these calculated values to the quote.';
                                                
                                                alert(message);
                                                
                                                // The pricing will be automatically recalculated and saved when the form is submitted
                                                // because the server-side code recalculates based on the form values
                                            } else {
                                                alert('Error: ' + (response.data || 'Failed to calculate pricing. Please check your inputs.'));
                                            }
                                        },
                                        error: function(xhr, status, error) {
                                            console.error('Pricing calculation error:', error);
                                            alert('Network error. Please check your connection and try again.');
                                        },
                                        complete: function() {
                                            // Re-enable button
                                            $button.prop('disabled', false).html(originalText);
                                        }
                                    });
                                });
                            })(jQuery);
                            </script>
                        </div>
                    </div>
                <?php endif; ?>


                <!-- Phase 2B: Instant Pricing Calculator - Hidden when quote is sent -->
                <?php if ( ! $latest_quote || ( $latest_quote->quote_status !== 'sent' && $latest_quote->quote_status !== 'quote_updated' ) ) : ?>
                <div style="background: white; padding: 20px; border-radius: 5px; margin: 20px 0; border: 2px solid #007cba;">
                    <h3 style="color: #007cba; margin-top: 0;">💡 Instant Pricing Calculator</h3>
                    <form method="post" id="n88-pricing-form">
                        <?php wp_nonce_field( 'n88_calculate_pricing' ); ?>
                        <table class="form-table">
                            <tr>
                                <th scope="row"><label for="labor_cost">Labor Cost (per unit)</label></th>
                                <td>
                                    <input type="number" step="0.01" name="labor_cost" id="labor_cost" value="<?php echo isset( $calculated_pricing ) ? esc_attr( $calculated_pricing['labor_cost'] ) : ''; ?>" placeholder="0.00" style="width: 200px;">
                                    <span class="description">Cost of labor per item</span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="materials_cost">Materials Cost (per unit)</label></th>
                                <td>
                                    <input type="number" step="0.01" name="materials_cost" id="materials_cost" value="<?php echo isset( $calculated_pricing ) ? esc_attr( $calculated_pricing['materials_cost'] ) : ''; ?>" placeholder="0.00" style="width: 200px;">
                                    <span class="description">Cost of materials per item</span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="overhead_cost">Overhead Cost (per unit)</label></th>
                                <td>
                                    <input type="number" step="0.01" name="overhead_cost" id="overhead_cost" value="<?php echo isset( $calculated_pricing ) ? esc_attr( $calculated_pricing['overhead_cost'] ) : ''; ?>" placeholder="0.00" style="width: 200px;">
                                    <span class="description">Overhead expenses per item</span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="margin_percentage">Margin %</label></th>
                                <td>
                                    <input type="number" step="0.01" name="margin_percentage" id="margin_percentage" value="<?php echo isset( $calculated_pricing ) ? esc_attr( $calculated_pricing['margin_percentage'] ) : '15'; ?>" placeholder="15.00" style="width: 200px;">
                                    <span class="description">Profit margin percentage (e.g., 15 for 15%)</span>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="shipping_zone">Shipping Zone</label></th>
                                <td>
                                    <select name="shipping_zone" id="shipping_zone" style="width: 200px;">
                                        <option value="">Select Zone</option>
                                        <option value="domestic" <?php echo ( isset( $calculated_pricing ) && $calculated_pricing['shipping_zone'] === 'domestic' ) ? 'selected' : ''; ?>>Domestic</option>
                                        <option value="international" <?php echo ( isset( $calculated_pricing ) && $calculated_pricing['shipping_zone'] === 'international' ) ? 'selected' : ''; ?>>International</option>
                                        <option value="express" <?php echo ( isset( $calculated_pricing ) && $calculated_pricing['shipping_zone'] === 'express' ) ? 'selected' : ''; ?>>Express</option>
                                        <option value="local" <?php echo ( isset( $calculated_pricing ) && $calculated_pricing['shipping_zone'] === 'local' ) ? 'selected' : ''; ?>>Local</option>
                                    </select>
                                </td>
                            </tr>
                        </table>
                        <button type="submit" name="n88_calculate_pricing" value="1" class="button button-primary">Calculate Pricing</button>
                    </form>

                    <?php if ( isset( $calculated_pricing ) ) : ?>
                        <div style="background: #f0f7ff; padding: 20px; border-radius: 5px; margin-top: 20px; border-left: 4px solid #007cba;">
                            <h4 style="margin-top: 0; color: #007cba;">📊 Calculated Pricing</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Base Unit Price:</strong></td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">$<?php echo number_format( $calculated_pricing['base_unit_price'], 2 ); ?></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Final Unit Price:</strong></td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right; font-size: 18px; font-weight: bold; color: #007cba;">$<?php echo number_format( $calculated_pricing['final_unit_price'], 2 ); ?></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Total Quantity:</strong></td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;"><?php echo number_format( $calculated_pricing['total_quantity'] ); ?> units</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Total CBM:</strong></td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;"><?php echo number_format( $calculated_pricing['total_cbm'], 4 ); ?> m³</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Total Price:</strong></td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right; font-size: 20px; font-weight: bold; color: #4caf50;">$<?php echo number_format( $calculated_pricing['total_price'], 2 ); ?></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Lead Time:</strong></td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;"><?php echo esc_html( $calculated_pricing['lead_time'] ); ?></td>
                                </tr>
                                <?php if ( ! empty( $calculated_pricing['volume_rules_applied'] ) ) : ?>
                                    <tr>
                                        <td colspan="2" style="padding: 8px; border-top: 2px solid #007cba; padding-top: 15px;">
                                            <strong>Volume Rules Applied:</strong>
                                            <ul style="margin: 10px 0 0 20px;">
                                                <?php foreach ( $calculated_pricing['volume_rules_applied'] as $rule ) : ?>
                                                    <li><?php echo esc_html( $rule ); ?></li>
                                                <?php endforeach; ?>
                                            </ul>
                                        </td>
                                    </tr>
                                <?php endif; ?>
                            </table>
                        </div>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>

                <!-- Upload Quote & Send to Client - Hidden when quote is sent -->
                <?php if ( ! $latest_quote || ( $latest_quote->quote_status !== 'sent' && $latest_quote->quote_status !== 'quote_updated' ) ) : ?>
                <div style="background: white; padding: 20px; border-radius: 5px; margin: 20px 0; border: 1px solid #ddd;">
                    <h3>Upload Quote & Send to Client</h3>
                    <p class="description">Upload a quote PDF, add internal notes (admin only), and send a message to the client.</p>
                    <form method="post" enctype="multipart/form-data">
                        <?php wp_nonce_field( 'n88_upload_quote' ); ?>
                        <table class="form-table">
                            <tr>
                                <th scope="row"><label for="quote_file">Upload Quote PDF <span style="color: red;">*</span></label></th>
                                <td>
                                    <input type="file" name="quote_file" id="quote_file" accept=".pdf,.jpg,.jpeg,.png" required>
                                    <p class="description">Required: PDF, JPG, or PNG file containing the quote.</p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="optional_attachments">Optional Attachments</label></th>
                                <td>
                                    <input type="file" name="optional_attachments[]" id="optional_attachments" multiple accept=".pdf,.jpg,.jpeg,.png,.dwg,.doc,.docx">
                                    <p class="description">Additional files: drawings, alternates, shipping details, etc.</p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="admin_notes">Internal Notes (Admin Only)</label></th>
                                <td>
                                    <textarea name="admin_notes" id="admin_notes" rows="5" cols="60" placeholder="Private notes for internal use only. Not visible to client."></textarea>
                                    <p class="description">These notes are only visible to administrators and will not be shown to the client.</p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="client_message">Short Message to Client</label></th>
                                <td>
                                    <textarea name="client_message" id="client_message" rows="4" cols="60" placeholder="e.g., We included 2 fabric options in this quote."></textarea>
                                    <p class="description">This message will be visible to the client when they view the quote.</p>
                                </td>
                            </tr>
                            <?php if ( isset( $calculated_pricing ) ) : ?>
                                <!-- Include calculated pricing in form -->
                                <input type="hidden" name="labor_cost" value="<?php echo esc_attr( $calculated_pricing['labor_cost'] ); ?>">
                                <input type="hidden" name="materials_cost" value="<?php echo esc_attr( $calculated_pricing['materials_cost'] ); ?>">
                                <input type="hidden" name="overhead_cost" value="<?php echo esc_attr( $calculated_pricing['overhead_cost'] ); ?>">
                                <input type="hidden" name="margin_percentage" value="<?php echo esc_attr( $calculated_pricing['margin_percentage'] ); ?>">
                                <input type="hidden" name="shipping_zone" value="<?php echo esc_attr( $calculated_pricing['shipping_zone'] ); ?>">
                            <?php endif; ?>
                        </table>
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button type="submit" name="n88_upload_quote" value="1" class="button button-secondary">Save as Draft</button>
                            <button type="submit" name="n88_send_quote" value="1" class="button button-primary">Send Quote to Client</button>
                        </div>
                    </form>
                </div>
                <?php endif; ?>

                <!-- Project Items (Read-only display when quote not sent) -->
                <?php if ( ! empty( $items ) && ( ! $latest_quote || ( $latest_quote->quote_status !== 'sent' && $latest_quote->quote_status !== 'quote_updated' ) ) ) : ?>
                <div style="background: white; padding: 20px; border-radius: 5px; margin: 20px 0; border: 1px solid #ddd;">
                        <h3 style="margin-top: 0;">Project Items (<?php echo count( $items ); ?>)</h3>
                        <div style="overflow-x: auto;">
                            <table class="widefat fixed striped" style="min-width: 700px;">
                                <thead>
                                    <tr>
                                        <th style="width: 60px;">#</th>
                                        <th>Dimensions (L × D × H)</th>
                                        <th>Qty</th>
                                        <th>Primary Material</th>
                                        <th>Finishes</th>
                                        <th style="width: 30%;">Construction Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ( $items as $index => $item ) : ?>
                                        <tr>
                                            <td><?php echo esc_html( $index + 1 ); ?></td>
                                            <td>
                                                <?php
                                                $length = isset( $item['length_in'] ) ? $item['length_in'] : ( $item['dimensions']['length'] ?? '' );
                                                $depth  = isset( $item['depth_in'] ) ? $item['depth_in'] : ( $item['dimensions']['depth'] ?? '' );
                                                $height = isset( $item['height_in'] ) ? $item['height_in'] : ( $item['dimensions']['height'] ?? '' );
                                                echo esc_html( trim( sprintf( '%s × %s × %s', $length, $depth, $height ) ) );
                                                ?>
                                            </td>
                                            <td><?php echo esc_html( $item['quantity'] ?? 0 ); ?></td>
                                            <td><?php echo esc_html( $item['primary_material'] ?? $item['materials']['primary'] ?? '' ); ?></td>
                                            <td><?php echo esc_html( $item['finishes'] ?? '' ); ?></td>
                                            <td><?php echo nl2br( esc_html( $item['construction_notes'] ?? '' ) ); ?></td>
                                        </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                <?php endif; ?>

                <p><a href="<?php echo remove_query_arg( array( 'action', 'project_id' ) ); ?>" class="button">Back to Quotes</a></p>

            <?php endif; ?>
        </div>
        <?php
    }

    /**
     * Render audit trail page
     */
    public function render_audit_trail() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }
        global $wpdb;

        $action = isset( $_GET['action'] ) ? sanitize_text_field( $_GET['action'] ) : 'list';
        $project_id = isset( $_GET['project_id'] ) ? intval( $_GET['project_id'] ) : 0;

        ?>
        <div class="wrap">
            <h1>Audit Trail</h1>

            <?php if ( $action === 'list' || ! $project_id ) : ?>
                <p>View all system activity and changes.</p>
                <table class="wp-list-table widefat fixed striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Field</th>
                            <th>Old Value</th>
                            <th>New Value</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $audit_table = $wpdb->prefix . 'project_audit';

                        $audits = $wpdb->get_results(
                            "SELECT * FROM {$audit_table} ORDER BY created_at DESC LIMIT 100"
                        );

                        foreach ( $audits as $audit ) {
                            $formatted = N88_RFQ_Audit::format_audit( $audit );
                            ?>
                            <tr>
                                <td><?php echo esc_html( $formatted['created_at'] ); ?></td>
                                <td><?php echo esc_html( $formatted['user_name'] ); ?></td>
                                <td><?php echo esc_html( N88_RFQ_Audit::get_action_label( $formatted['action'] ) ); ?></td>
                                <td><?php echo esc_html( $formatted['field_name'] ); ?></td>
                                <td><code><?php echo esc_html( substr( $formatted['old_value'], 0, 50 ) ); ?></code></td>
                                <td><code><?php echo esc_html( substr( $formatted['new_value'], 0, 50 ) ); ?></code></td>
                                <td><?php echo esc_html( $formatted['ip_address'] ); ?></td>
                            </tr>
                            <?php
                        }
                        ?>
                    </tbody>
                </table>

            <?php endif; ?>
        </div>
        <?php
    }

    public function render_content_manager() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }
        echo '<div class="wrap"><h1>Content Manager</h1><p>TODO: Implement video upload and library per design.</p></div>';
    }

    /**
     * Render Material Bank admin page
     * 
     * Phase 1.2.3: Material Bank Core
     */
    public function render_material_bank() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }

        global $wpdb;
        $materials_table = $wpdb->prefix . 'n88_materials';
        
        // Get all non-deleted materials
        $materials = $wpdb->get_results(
            "SELECT * FROM {$materials_table} WHERE deleted_at IS NULL ORDER BY created_at DESC"
        );

        ?>
        <div class="wrap">
            <h1>Material Bank</h1>
            <p>Manage materials for the RFQ platform. Materials can be attached to items by designers.</p>
            
            <h2>Materials List</h2>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Material Code</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if ( empty( $materials ) ) : ?>
                        <tr>
                            <td colspan="7">No materials found.</td>
                        </tr>
                    <?php else : ?>
                        <?php foreach ( $materials as $material ) : ?>
                            <tr>
                                <td><?php echo esc_html( $material->id ); ?></td>
                                <td><strong><?php echo esc_html( $material->name ); ?></strong></td>
                                <td><?php echo esc_html( $material->category ?: '—' ); ?></td>
                                <td><?php echo esc_html( $material->material_code ?: '—' ); ?></td>
                                <td>
                                    <?php if ( $material->is_active == 1 ) : ?>
                                        <span style="color: green;">Active</span>
                                    <?php else : ?>
                                        <span style="color: red;">Inactive</span>
                                    <?php endif; ?>
                                </td>
                                <td><?php echo esc_html( $material->created_at ); ?></td>
                                <td>
                                    <a href="#" class="button button-small edit-material" data-id="<?php echo esc_attr( $material->id ); ?>">Edit</a>
                                    <?php if ( $material->is_active == 1 ) : ?>
                                        <a href="#" class="button button-small deactivate-material" data-id="<?php echo esc_attr( $material->id ); ?>">Deactivate</a>
                                    <?php else : ?>
                                        <a href="#" class="button button-small activate-material" data-id="<?php echo esc_attr( $material->id ); ?>">Activate</a>
                                    <?php endif; ?>
                                    <a href="#" class="button button-small delete-material" data-id="<?php echo esc_attr( $material->id ); ?>">Delete</a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
            
            <h2>Add New Material</h2>
            <form id="create-material-form">
                <table class="form-table">
                    <tr>
                        <th><label for="material_name">Name *</label></th>
                        <td><input type="text" id="material_name" name="name" class="regular-text" required /></td>
                    </tr>
                    <tr>
                        <th><label for="material_description">Description</label></th>
                        <td><textarea id="material_description" name="description" class="large-text" rows="3"></textarea></td>
                    </tr>
                    <tr>
                        <th><label for="material_category">Category</label></th>
                        <td><input type="text" id="material_category" name="category" class="regular-text" /></td>
                    </tr>
                    <tr>
                        <th><label for="material_code">Material Code</label></th>
                        <td><input type="text" id="material_code" name="material_code" class="regular-text" /></td>
                    </tr>
                    <tr>
                        <th><label for="material_notes">Notes</label></th>
                        <td><textarea id="material_notes" name="notes" class="large-text" rows="3"></textarea></td>
                    </tr>
                </table>
                <?php wp_nonce_field( 'n88-rfq-nonce', 'nonce' ); ?>
                <p class="submit">
                    <button type="submit" class="button button-primary">Create Material</button>
                </p>
            </form>
        </div>
        
        <script>
        jQuery(document).ready(function($) {
            // Create material
            $('#create-material-form').on('submit', function(e) {
                e.preventDefault();
                var formData = $(this).serialize();
                $.ajax({
                    url: ajaxurl,
                    type: 'POST',
                    data: formData + '&action=n88_create_material',
                    success: function(response) {
                        if (response.success) {
                            alert('Material created successfully!');
                            location.reload();
                        } else {
                            alert('Error: ' + (response.data.message || 'Unknown error'));
                        }
                    }
                });
            });
            
            // Edit, activate, deactivate, delete handlers would go here
            // (Simplified for Phase 1.2.3 - full UI can be added later)
        });
        </script>
        <?php
    }

    /**
     * Render role management page (Commit 2.2.1)
     */
    public function render_role_management() {
        // Check if user has permission
        if ( ! current_user_can( 'n88_view_global_queue' ) && ! current_user_can( 'manage_options' ) ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ), 'Access Denied', array( 'response' => 403 ) );
        }

        // Handle role assignment
        if ( isset( $_POST['assign_role'] ) && check_admin_referer( 'n88_assign_role' ) ) {
            $user_id = isset( $_POST['user_id'] ) ? absint( $_POST['user_id'] ) : 0;
            $new_role = isset( $_POST['new_role'] ) ? sanitize_text_field( wp_unslash( $_POST['new_role'] ) ) : '';
            
            $allowed_roles = array( 'n88_designer', 'n88_supplier_admin', 'n88_system_operator' );
            
            if ( $user_id > 0 && in_array( $new_role, $allowed_roles, true ) ) {
                $user = new WP_User( $user_id );
                // Remove all custom roles first
                foreach ( $allowed_roles as $role ) {
                    $user->remove_role( $role );
                }
                // Also remove legacy designer role
                $user->remove_role( 'designer' );
                // Assign new role
                $user->add_role( $new_role );
                
                echo '<div class="notice notice-success"><p>Role assigned successfully!</p></div>';
            } else {
                echo '<div class="notice notice-error"><p>Invalid user or role.</p></div>';
            }
        }

        // Get all users
        $users = get_users( array( 'number' => 100 ) );
        $allowed_roles = array(
            'n88_designer' => 'Designer',
            'n88_supplier_admin' => 'Supplier Admin',
            'n88_system_operator' => 'System Operator',
        );

        ?>
        <div class="wrap">
            <h1>Role Management</h1>
            <p>Assign roles to users. This tool is for testing and managing user roles.</p>
            
            <h2>Assign Role to User</h2>
            <form method="post" action="">
                <?php wp_nonce_field( 'n88_assign_role' ); ?>
                <table class="form-table">
                    <tr>
                        <th><label for="user_id">User</label></th>
                        <td>
                            <select name="user_id" id="user_id" required>
                                <option value="">Select a user...</option>
                                <?php foreach ( $users as $user ) : ?>
                                    <option value="<?php echo esc_attr( $user->ID ); ?>">
                                        <?php echo esc_html( $user->display_name ); ?> (<?php echo esc_html( $user->user_login ); ?>)
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th><label for="new_role">Role</label></th>
                        <td>
                            <select name="new_role" id="new_role" required>
                                <option value="">Select a role...</option>
                                <?php foreach ( $allowed_roles as $role_key => $role_label ) : ?>
                                    <option value="<?php echo esc_attr( $role_key ); ?>">
                                        <?php echo esc_html( $role_label ); ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </td>
                    </tr>
                </table>
                <p class="submit">
                    <input type="submit" name="assign_role" class="button button-primary" value="Assign Role" />
                </p>
            </form>

            <h2>Current User Roles</h2>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Username</th>
                        <th>Display Name</th>
                        <th>Email</th>
                        <th>Current Roles</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if ( empty( $users ) ) : ?>
                        <tr>
                            <td colspan="5">No users found.</td>
                        </tr>
                    <?php else : ?>
                        <?php foreach ( $users as $user ) : ?>
                            <tr>
                                <td><?php echo esc_html( $user->ID ); ?></td>
                                <td><strong><?php echo esc_html( $user->user_login ); ?></strong></td>
                                <td><?php echo esc_html( $user->display_name ); ?></td>
                                <td><?php echo esc_html( $user->user_email ); ?></td>
                                <td>
                                    <?php
                                    $user_roles = $user->roles;
                                    $custom_roles = array_intersect( $user_roles, array_keys( $allowed_roles ) );
                                    if ( ! empty( $custom_roles ) ) {
                                        echo esc_html( implode( ', ', $custom_roles ) );
                                    } else {
                                        echo '<em>' . esc_html( implode( ', ', $user_roles ) ) . '</em>';
                                    }
                                    ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
        <?php
    }

    public function render_comments_hub() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }

        global $wpdb;

        $table_comments = $wpdb->prefix . 'project_comments';
        $table_projects = $wpdb->prefix . 'projects';
        $table_users    = $wpdb->users;

        $status_filter = isset( $_GET['status'] ) ? sanitize_text_field( $_GET['status'] ) : 'all';
        $project_id    = isset( $_GET['project_id'] ) ? intval( $_GET['project_id'] ) : 0;
        $search_term   = isset( $_GET['s'] ) ? sanitize_text_field( $_GET['s'] ) : '';

        $where = array( '1=1' );
        $values = array();

        if ( 'unread' === $status_filter ) {
            $where[] = 'n88_meta.needs_review = 1';
        }

        if ( $project_id > 0 ) {
            $where[] = 'c.project_id = %d';
            $values[] = $project_id;
        }

        if ( ! empty( $search_term ) ) {
            $where[] = '(c.comment_text LIKE %s OR p.project_name LIKE %s)';
            $values[] = '%' . $wpdb->esc_like( $search_term ) . '%';
            $values[] = '%' . $wpdb->esc_like( $search_term ) . '%';
        }

        if ( ! empty( $admin_ids ) ) {
            $placeholders_admin = implode( ',', array_fill( 0, count( $admin_ids ), '%d' ) );
            $where[] = "c.user_id NOT IN ( {$placeholders_admin} )";
            $values = array_merge( $values, $admin_ids );
        }

        $where_sql = implode( ' AND ', $where );

        $query = "
            SELECT c.*, p.project_name, u.display_name AS author_name
            FROM {$table_comments} c
            LEFT JOIN {$table_projects} p ON c.project_id = p.id
            LEFT JOIN {$table_users} u ON c.user_id = u.ID
            LEFT JOIN (
                SELECT project_id, meta_value AS needs_review
                FROM {$wpdb->prefix}project_metadata
                WHERE meta_key = 'n88_has_client_updates'
            ) n88_meta ON n88_meta.project_id = c.project_id
            WHERE {$where_sql}
            ORDER BY c.created_at DESC
            LIMIT 200
        ";

        $comments = $wpdb->get_results( $wpdb->prepare( $query, $values ) );

        if ( isset( $_POST['n88_admin_reply'], $_POST['original_comment_id'] ) && check_admin_referer( 'n88_admin_reply_action' ) ) {
            $parent_id = intval( $_POST['original_comment_id'] );
            $project_id = intval( $_POST['reply_project_id'] );
            $item_id = sanitize_text_field( $_POST['reply_item_id'] ?? '' );
            $video_id = sanitize_text_field( $_POST['reply_video_id'] ?? '' );
            $reply_text = sanitize_textarea_field( $_POST['reply_text'] ?? '' );

            if ( $project_id && ! empty( $reply_text ) ) {
                $comment_id = N88_RFQ_Comments::add_comment( array(
                    'project_id' => $project_id,
                    'item_id'    => $item_id ?: null,
                    'video_id'   => $video_id ?: null,
                    'user_id'    => get_current_user_id(),
                    'comment_text'=> $reply_text,
                    'is_urgent'  => ! empty( $_POST['reply_urgent'] ),
                    'parent_comment_id' => $parent_id,
                ) );

                if ( $comment_id ) {
                    echo '<div class="notice notice-success"><p>' . esc_html__( 'Reply posted successfully.', 'n88-rfq' ) . '</p></div>';
                } else {
                    echo '<div class="notice notice-error"><p>' . esc_html__( 'Failed to post reply. Please try again.', 'n88-rfq' ) . '</p></div>';
                }
            }
        }

        // Table name is safe (from $wpdb->prefix), but we validate it contains only safe characters
        $table_projects_safe = preg_replace( '/[^a-zA-Z0-9_]/', '', $table_projects );
        $projects = $wpdb->get_results( $wpdb->prepare( "SELECT id, project_name FROM {$table_projects_safe} ORDER BY project_name ASC LIMIT %d", 200 ) );
        ?>
        <div class="wrap n88-admin-comments">
            <h1><?php esc_html_e( 'Comments Hub', 'n88-rfq' ); ?></h1>

            <form method="get" class="n88-filters">
                <input type="hidden" name="page" value="n88-rfq-comments" />
                <label>
                    <span><?php esc_html_e( 'Project', 'n88-rfq' ); ?></span>
                    <select name="project_id">
                        <option value="0"><?php esc_html_e( 'All Projects', 'n88-rfq' ); ?></option>
                        <?php foreach ( $projects as $project ) : ?>
                            <option value="<?php echo esc_attr( $project->id ); ?>" <?php selected( $project_id, $project->id ); ?>>
                                <?php echo esc_html( $project->project_name ); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </label>
                <label>
                    <span><?php esc_html_e( 'Status', 'n88-rfq' ); ?></span>
                    <select name="status">
                        <option value="all" <?php selected( $status_filter, 'all' ); ?>><?php esc_html_e( 'All', 'n88-rfq' ); ?></option>
                        <option value="unread" <?php selected( $status_filter, 'unread' ); ?>><?php esc_html_e( 'Needs Review', 'n88-rfq' ); ?></option>
                    </select>
                </label>
                <label>
                    <span><?php esc_html_e( 'Search', 'n88-rfq' ); ?></span>
                    <input type="search" name="s" value="<?php echo esc_attr( $search_term ); ?>" placeholder="<?php esc_attr_e( 'Search text…', 'n88-rfq' ); ?>" />
                </label>
                <button class="button button-primary"><?php esc_html_e( 'Apply', 'n88-rfq' ); ?></button>
            </form>

            <table class="widefat fixed striped">
                <thead>
                    <tr>
                        <th><?php esc_html_e( 'Date', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Project', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Author', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Comment', 'n88-rfq' ); ?></th>
                        <th><?php esc_html_e( 'Actions', 'n88-rfq' ); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if ( empty( $comments ) ) : ?>
                        <tr>
                            <td colspan="5"><?php esc_html_e( 'No comments found.', 'n88-rfq' ); ?></td>
                        </tr>
                    <?php else : ?>
                        <?php foreach ( $comments as $comment ) : ?>
                            <tr>
                                <td><?php echo esc_html( date_i18n( get_option( 'date_format' ) . ' ' . get_option( 'time_format' ), strtotime( $comment->created_at ) ) ); ?></td>
                                <td>
                                    <a href="<?php echo esc_url( home_url( '/project-detail/?project_id=' . $comment->project_id ) ); ?>" target="_blank">
                                        <?php echo esc_html( $comment->project_name ?: __( 'Unknown project', 'n88-rfq' ) ); ?>
                                    </a>
                                </td>
                                <td>
                                    <?php echo esc_html( $comment->author_name ?: __( 'Unknown user', 'n88-rfq' ) ); ?>
                                    <div class="description">
                                        <?php echo esc_html( $comment->item_id ?: __( 'Project level', 'n88-rfq' ) ); ?>
                                    </div>
                                </td>
                                <td>
                                    <?php echo wp_kses_post( wp_trim_words( $comment->comment_text, 30, '…' ) ); ?>
                                </td>
                                <td>
                                    <button type="button" class="button button-secondary n88-admin-reply-toggle" data-comment-id="<?php echo esc_attr( $comment->id ); ?>">
                                        <?php esc_html_e( 'Reply', 'n88-rfq' ); ?>
                                    </button>
                                    <div class="n88-admin-reply-panel" id="n88-admin-reply-<?php echo esc_attr( $comment->id ); ?>" style="display:none; margin-top:10px;">
                                        <form method="post">
                                            <?php wp_nonce_field( 'n88_admin_reply_action' ); ?>
                                            <input type="hidden" name="page" value="n88-rfq-comments" />
                                            <input type="hidden" name="original_comment_id" value="<?php echo esc_attr( $comment->id ); ?>" />
                                            <input type="hidden" name="reply_project_id" value="<?php echo esc_attr( $comment->project_id ); ?>" />
                                            <input type="hidden" name="reply_item_id" value="<?php echo esc_attr( $comment->item_id ); ?>" />
                                            <input type="hidden" name="reply_video_id" value="<?php echo esc_attr( $comment->video_id ); ?>" />
                                            <textarea name="reply_text" rows="3" style="width:100%;" placeholder="<?php esc_attr_e( 'Type your reply…', 'n88-rfq' ); ?>"></textarea>
                                            <label style="display:inline-flex; align-items:center; gap:6px; margin-top:6px;">
                                                <input type="checkbox" name="reply_urgent" value="1" />
                                                <?php esc_html_e( 'Mark as urgent', 'n88-rfq' ); ?>
                                            </label>
                                            <div style="margin-top:8px;">
                                                <button type="submit" name="n88_admin_reply" class="button button-primary"><?php esc_html_e( 'Send Reply', 'n88-rfq' ); ?></button>
                                                <button type="button" class="button n88-admin-reply-cancel"><?php esc_html_e( 'Cancel', 'n88-rfq' ); ?></button>
                                            </div>
                                        </form>
                                    </div>
                                </td>
                            </tr>
        <style>
            .n88-admin-reply-panel textarea {
                resize: vertical;
            }
        </style>
        <script>
            document.addEventListener('click', function(e) {
                const toggleBtn = e.target.closest('.n88-admin-reply-toggle');
                if (toggleBtn) {
                    e.preventDefault();
                    const panel = document.getElementById('n88-admin-reply-' + toggleBtn.dataset.commentId);
                    if (panel) {
                        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    }
                }

                const cancelBtn = e.target.closest('.n88-admin-reply-cancel');
                if (cancelBtn) {
                    e.preventDefault();
                    const panel = cancelBtn.closest('.n88-admin-reply-panel');
                    if (panel) {
                        panel.style.display = 'none';
                    }
                }
            });
        </script>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
        <style>
            .n88-admin-comments .n88-filters {
                display: flex;
                gap: 20px;
                flex-wrap: wrap;
                align-items: flex-end;
                margin-bottom: 20px;
            }
            .n88-admin-comments .n88-filters label {
                display: flex;
                flex-direction: column;
                font-weight: 600;
            }
        </style>
        <?php
    }

    /**
     * Render Items & Boards Test Page (Milestone 1.1)
     * 
     * Temporary test interface for Milestone 1.1 endpoints.
     * This is NOT a production UI - only for testing the foundation.
     */
    /**
     * Get designer's board (designers can only have 1 board)
     */
    private function get_designer_board( $user_id ) {
        global $wpdb;
        $boards_table = $wpdb->prefix . 'n88_boards';
        return $wpdb->get_row(
            $wpdb->prepare(
                "SELECT * FROM {$boards_table} WHERE owner_user_id = %d AND deleted_at IS NULL ORDER BY created_at ASC LIMIT 1",
                $user_id
            )
        );
    }

    public function render_items_boards_test() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }

        // Enqueue WordPress media library for image uploader
        wp_enqueue_media();

        // Enqueue HEIC conversion library for preview support
        wp_enqueue_script( 'heic2any', 'https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js', array(), '0.0.4', true );

        // Get nonce for AJAX requests
        $nonce = wp_create_nonce( 'n88-rfq-nonce' );
        
        // Debug: Log nonce creation
        error_log( 'N88 Items Page: Nonce created - Length: ' . strlen( $nonce ) . ', Action: n88-rfq-nonce' );
        
        // Commit 2.5.2: Enqueue jQuery and localize script for nonce (for room loading)
        wp_enqueue_script( 'jquery' );
        
        // Check if user is designer
        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );
        $user_id = get_current_user_id();
        $designer_board = $is_designer ? $this->get_designer_board( $user_id ) : null;
        $has_board = $designer_board !== null;
        
        ?>
        <div class="wrap n88-items-boards-test">
            <h1>Create Workspace</h1>
            
            <?php if ( $is_designer && $has_board ) : ?>
                <div class="notice notice-success" style="margin: 20px 0;">
                    <p><strong>Your workspace board has been created! Now create items for your board.</strong></p>
                </div>
            <?php endif; ?>

            <?php if ( $is_designer && ! $has_board ) : ?>
                <!-- Designer without board: Show only board creation form -->
                <div style="max-width: 600px; margin: 20px auto;">
                    <div style="border: 1px solid #ccc; padding: 20px; border-radius: 4px;">
                        <h2>Create Your Workspace</h2>
                        <form id="n88-create-board-form">
                            <table class="form-table">
                                <tr>
                                    <th><label for="board-name">Workspace Name *</label></th>
                                    <td><input type="text" id="board-name" name="name" required style="width: 100%;" /></td>
                                </tr>
                                <tr>
                                    <th><label for="board-description">Description</label></th>
                                    <td><textarea id="board-description" name="description" rows="3" style="width: 100%;"></textarea></td>
                                </tr>
                            </table>
                            <p class="submit">
                                <button type="submit" class="button button-primary">Create Workspace</button>
                            </p>
                            <div id="create-board-result" style="margin-top: 10px;"></div>
                        </form>
                    </div>
                </div>
            <?php else : ?>
                <!-- Designer with board OR Admin: Show item creation form -->
                <div style="max-width: 800px; margin: 20px auto;">
                    <div style="border: 1px solid #ccc; padding: 20px; border-radius: 4px;">
                        <h2>Add an Item</h2>
                    <form id="n88-create-item-form">
                        <table class="form-table">
                            <tr>
                                <th><label for="item-title">Title *</label></th>
                                <td><input type="text" id="item-title" name="title" required style="width: 100%;" /></td>
                            </tr>
                            <tr>
                                <th><label for="item-description">Description (tell us what you're sourcing)</label></th>
                                <td><textarea id="item-description" name="description" rows="3" style="width: 100%;"></textarea></td>
                            </tr>
                            <tr>
                                <th><label for="item-type">Category</label></th>
                                <td>
                                    <select id="item-type" name="item_type" style="width: 100%;">
                                        <option value="">-- Select Category --</option>
                                        <option value="Indoor Furniture">Indoor Furniture</option>
                                        <option value="Sofas & Seating (Indoor)">Sofas & Seating (Indoor)</option>
                                        <option value="Chairs & Armchairs (Indoor)">Chairs & Armchairs (Indoor)</option>
                                        <option value="Dining Tables (Indoor)">Dining Tables (Indoor)</option>
                                        <option value="Cabinetry / Millwork (Custom)">Cabinetry / Millwork (Custom)</option>
                                        <option value="Casegoods (Beds, Nightstands, Desks, Consoles)">Casegoods (Beds, Nightstands, Desks, Consoles)</option>
                                        <option value="Outdoor Furniture">Outdoor Furniture</option>
                                        <option value="Outdoor Seating">Outdoor Seating</option>
                                        <option value="Outdoor Dining Sets">Outdoor Dining Sets</option>
                                        <option value="Outdoor Loungers & Daybeds">Outdoor Loungers & Daybeds</option>
                                        <option value="Pool Furniture">Pool Furniture</option>
                                        <option value="Lighting">Lighting</option>
                                        <option value="Decorative Lighting">Decorative Lighting</option>
                                        <option value="Architectural Lighting">Architectural Lighting</option>
                                        <option value="Electrical / LED Components">Electrical / LED Components</option>
                                        <option value="Bathroom Fixtures">Bathroom Fixtures</option>
                                        <option value="Kitchen Fixtures">Kitchen Fixtures</option>
                                        <option value="Faucets / Hardware (Plumbing)">Faucets / Hardware (Plumbing)</option>
                                        <option value="Sinks / Basins">Sinks / Basins</option>
                                        <option value="Shower Systems / Accessories">Shower Systems / Accessories</option>
                                        <option value="Marble / Stone">Marble / Stone</option>
                                        <option value="Granite">Granite</option>
                                        <option value="Quartz">Quartz</option>
                                        <option value="Porcelain / Ceramic Slabs">Porcelain / Ceramic Slabs</option>
                                        <option value="Tile (Wall / Floor)">Tile (Wall / Floor)</option>
                                        <option value="Terrazzo">Terrazzo</option>
                                        <option value="Rugs / Carpets">Rugs / Carpets</option>
                                        <option value="Drapery">Drapery</option>
                                        <option value="Window Treatments / Shades">Window Treatments / Shades</option>
                                        <option value="Wallcoverings">Wallcoverings</option>
                                        <option value="Acoustic Panels">Acoustic Panels</option>
                                        <option value="Mirrors">Mirrors</option>
                                        <option value="Artwork">Artwork</option>
                                        <option value="Decorative Accessories">Decorative Accessories</option>
                                        <option value="Planters">Planters</option>
                                        <option value="Sculptural Objects">Sculptural Objects</option>
                                        <option value="Railings">Railings</option>
                                        <option value="Screens / Louvers">Screens / Louvers</option>
                                        <option value="Pergola / Shade Components">Pergola / Shade Components</option>
                                        <option value="Facade Materials">Facade Materials</option>
                                        <option value="Material Sample Kit">Material Sample Kit</option>
                                        <option value="Fabric Sample">Fabric Sample</option>
                                        <option value="Custom Sourcing / Not Listed">Custom Sourcing / Not Listed</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th><label>Quantity</label></th>
                                <td>
                                    <input type="number" id="item-quantity" name="quantity" min="1" value="1" style="width: 100px;" />
                                    <p class="description">Quantity for this item</p>
                                </td>
                            </tr>
                            <tr>
                                <th><label>Dimensions (provide ideal dimensions when applicable)</label></th>
                                <td>
                                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                        <div>
                                            <label for="item-width" style="display: block; font-size: 11px; margin-bottom: 4px;">Width</label>
                                            <input type="number" id="item-width" name="width" step="0.01" style="width: 80px;" placeholder="W" />
                                        </div>
                                        <div>
                                            <label for="item-depth" style="display: block; font-size: 11px; margin-bottom: 4px;">Depth</label>
                                            <input type="number" id="item-depth" name="depth" step="0.01" style="width: 80px;" placeholder="D" />
                                        </div>
                                        <div>
                                            <label for="item-height" style="display: block; font-size: 11px; margin-bottom: 4px;">Height</label>
                                            <input type="number" id="item-height" name="height" step="0.01" style="width: 80px;" placeholder="H" />
                                        </div>
                                        <div>
                                            <label for="item-dimension-unit" style="display: block; font-size: 11px; margin-bottom: 4px;">Unit</label>
                                            <select id="item-dimension-unit" name="dimension_unit" style="width: 60px;">
                                                <option value="in" selected>in</option>
                                                <option value="cm">cm</option>
                                                <option value="mm">mm</option>
                                                <option value="m">m</option>
                                            </select>
                                        </div>
                                    </div>
                                    <p class="description">Optional: Enter dimensions (W × D × H)</p>
                                </td>
                            </tr>
                            <tr>
                                <th><label for="item-image-url">Image</label></th>
                                <td>
                                    <input type="hidden" id="item-image-id" name="image_id" />
                                    <input type="file" id="item-image-file" accept="image/*,.heic,.heif" style="margin-bottom: 10px;" />
                                    <!-- <input type="url" id="item-image-url" name="image_url" placeholder="Or enter image URL (optional)" style="width: 100%; margin-bottom: 10px;" /> -->
                                    <button type="button" id="item-image-remove-btn" class="button" style="display: none;">Remove</button>
                                    <div id="item-image-preview" style="margin-top: 10px; max-width: 200px; display: none;">
                                        <img id="item-image-preview-img" src="" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 4px;" />
                                    </div>
                                    <p class="description">Upload an image from your device</p>
                                </td>
                            </tr>
                            <tr>
                                <th><label for="item-size">Default Size</label></th>
                                <td>
                                    <select id="item-size" name="size" style="width: 100%;">
                                        <option value="S">S (160×200px)</option>
                                        <option value="D">D (200×250px)</option>
                                        <option value="L" selected>L (280×350px) - Default</option>
                                        <option value="XL">XL (360×450px)</option>
                                    </select>
                                    <p class="description">Default size when item is added to a board</p>
                                </td>
                            </tr>
                            <?php if ( ! $is_designer || ! $has_board ) : ?>
                            <tr>
                                <th><label for="item-board">Add to Board (Optional)</label></th>
                                <td>
                                    <select id="item-board" name="board_id" style="width: 100%;">
                                        <option value="">-- Select a Board --</option>
                                        <?php
                                        // Fetch user's boards
                                        global $wpdb;
                                        $user_id = get_current_user_id();
                                        $boards_table = $wpdb->prefix . 'n88_boards';
                                        $user_boards = $wpdb->get_results(
                                            $wpdb->prepare(
                                                "SELECT id, name FROM {$boards_table} 
                                                 WHERE owner_user_id = %d 
                                                 AND deleted_at IS NULL 
                                                 ORDER BY name ASC",
                                                $user_id
                                            )
                                        );
                                        foreach ( $user_boards as $board ) {
                                            echo '<option value="' . esc_attr( $board->id ) . '">' . esc_html( $board->name ) . ' (ID: ' . esc_html( $board->id ) . ')</option>';
                                        }
                                        ?>
                                    </select>
                                    <p class="description">Optionally add this item to a board immediately after creation</p>
                                </td>
                            </tr>
                            <?php else : ?>
                            <input type="hidden" id="item-board" name="board_id" value="<?php echo esc_attr( $designer_board->id ); ?>" />
                            <?php endif; ?>
                            
                            <!-- Commit 2.5.2: Project and Room selectors -->
                            <?php if ( $is_designer && $has_board ) : ?>
                            <?php
                            // Get projects for this board
                            global $wpdb;
                            $projects_table = $wpdb->prefix . 'n88_projects';
                            $board_projects = $wpdb->get_results(
                                $wpdb->prepare(
                                    "SELECT id, name FROM {$projects_table}
                                     WHERE board_id = %d AND deleted_at IS NULL
                                     ORDER BY created_at ASC",
                                    $designer_board->id
                                )
                            );
                            ?>
                            <tr>
                                <th><label for="item-project">Project (Optional)</label></th>
                                <td>
                                    <select id="item-project" name="project_id" style="width: 100%;">
                                        <option value="">-- No Project --</option>
                                        <?php foreach ( $board_projects as $project ) : ?>
                                            <option value="<?php echo esc_attr( $project->id ); ?>"><?php echo esc_html( $project->name ); ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                    <p class="description">Select a project to organize this item</p>
                                </td>
                            </tr>
                            <tr id="item-room-row" style="display: none;">
                                <th><label for="item-room">Room (Optional)</label></th>
                                <td>
                                    <select id="item-room" name="room_id" style="width: 100%;">
                                        <option value="">-- Select Room --</option>
                                    </select>
                                    <p class="description">Select a room within the project</p>
                                </td>
                            </tr>
                            <?php endif; ?>
                        </table>
                        <p class="submit">
                            <button type="submit" class="button button-primary">Add Item</button>
                        </p>
                        <div id="create-item-result" style="margin-top: 10px;"></div>
                    </form>
                </div>
                
                <!-- Commit 2.5.2: Ensure nonce is available immediately for room loading -->
                <script type="text/javascript">
                // Set nonce immediately (before jQuery ready) for room loading
                (function() {
                    var nonceValue = '<?php echo esc_js( $nonce ); ?>';
                    var ajaxUrlValue = '<?php echo esc_js( admin_url( 'admin-ajax.php' ) ); ?>';
                    
                    if (typeof window.n88ItemsNonce === 'undefined') {
                        window.n88ItemsNonce = {
                            nonce: nonceValue,
                            ajaxUrl: ajaxUrlValue
                        };
                    }
                    
                    // Debug: Log nonce setup
                    console.log('N88 Items Nonce Setup:', {
                        nonceLength: nonceValue.length,
                        nonceValue: nonceValue.substring(0, 10) + '...',
                        ajaxUrl: ajaxUrlValue,
                        windowObject: !!window.n88ItemsNonce
                    });
                })();
                </script>
                
                <?php if ( ! $is_designer ) : ?>
                    <!-- Admin: Show board creation form too -->
                    <div style="border: 1px solid #ccc; padding: 20px; border-radius: 4px; margin-top: 20px;">
                        <h2>Create Board</h2>
                        <form id="n88-create-board-form">
                            <table class="form-table">
                                <tr>
                                    <th><label for="board-name">Name *</label></th>
                                    <td><input type="text" id="board-name" name="name" required style="width: 100%;" /></td>
                                </tr>
                                <tr>
                                    <th><label for="board-description">Description</label></th>
                                    <td><textarea id="board-description" name="description" rows="3" style="width: 100%;"></textarea></td>
                                </tr>
                            </table>
                            <p class="submit">
                                <button type="submit" class="button button-primary">Create Board</button>
                            </p>
                            <div id="create-board-result" style="margin-top: 10px;"></div>
                        </form>
                    </div>
                <?php endif; ?>
                </div>
            <?php endif; ?>

            <!-- Update Item Form - COMMENTED OUT FOR NOW -->
            <?php /*
            <div style="border: 1px solid #ccc; padding: 20px; border-radius: 4px; margin-top: 20px;">
                <h2>Update Item</h2>
                <form id="n88-update-item-form">
                    <table class="form-table">
                        <tr>
                            <th><label for="update-item-id">Item ID *</label></th>
                            <td><input type="number" id="update-item-id" name="item_id" required style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="update-item-title">Title</label></th>
                            <td><input type="text" id="update-item-title" name="title" style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="update-item-description">Description</label></th>
                            <td><textarea id="update-item-description" name="description" rows="3" style="width: 100%;"></textarea></td>
                        </tr>
                        <tr>
                            <th><label for="update-item-status">Status</label></th>
                            <td>
                                <select id="update-item-status" name="status" style="width: 100%;">
                                    <option value="">-- No Change --</option>
                                    <option value="draft">Draft</option>
                                    <option value="active">Active</option>
                                    <option value="archived">Archived</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th><label for="update-item-type">Item Type</label></th>
                            <td>
                                <select id="update-item-type" name="item_type" style="width: 100%;">
                                    <option value="">-- No Change --</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="lighting">Lighting</option>
                                    <option value="accessory">Accessory</option>
                                    <option value="art">Art</option>
                                    <option value="other">Other</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <p class="submit">
                        <button type="submit" class="button button-primary">Update Item</button>
                    </p>
                    <div id="update-item-result" style="margin-top: 10px;"></div>
                </form>
            </div>
            */ ?>

            <!-- Add Item to Board Form - HIDDEN FOR NOW -->
            <!--
            <div style="border: 1px solid #ccc; padding: 20px; border-radius: 4px; margin-top: 20px;">
                <h2>Add Item to Board</h2>
                <form id="n88-add-item-to-board-form">
                    <table class="form-table">
                        <tr>
                            <th><label for="add-board-id">Board ID *</label></th>
                            <td><input type="number" id="add-board-id" name="board_id" required style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="add-item-id">Item ID *</label></th>
                            <td><input type="number" id="add-item-id" name="item_id" required style="width: 100%;" /></td>
                        </tr>
                    </table>
                    <p class="submit">
                        <button type="submit" class="button button-primary">Add Item to Board</button>
                    </p>
                    <div id="add-item-to-board-result" style="margin-top: 10px;"></div>
                </form>
            </div>
            -->

            <!-- Update Board Layout Form - COMMENTED OUT FOR NOW -->
            <?php /*
            <div style="border: 1px solid #ccc; padding: 20px; border-radius: 4px; margin-top: 20px;">
                <h2>Update Board Layout</h2>
                <form id="n88-update-board-layout-form">
                    <table class="form-table">
                        <tr>
                            <th><label for="layout-board-id">Board ID *</label></th>
                            <td><input type="number" id="layout-board-id" name="board_id" required style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="layout-item-id">Item ID *</label></th>
                            <td><input type="number" id="layout-item-id" name="item_id" required style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="layout-position-x">Position X</label></th>
                            <td><input type="number" step="0.01" id="layout-position-x" name="position_x" value="0" style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="layout-position-y">Position Y</label></th>
                            <td><input type="number" step="0.01" id="layout-position-y" name="position_y" value="0" style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="layout-position-z">Position Z</label></th>
                            <td><input type="number" id="layout-position-z" name="position_z" value="0" style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="layout-size-width">Size Width</label></th>
                            <td><input type="number" step="0.01" id="layout-size-width" name="size_width" style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="layout-size-height">Size Height</label></th>
                            <td><input type="number" step="0.01" id="layout-size-height" name="size_height" style="width: 100%;" /></td>
                        </tr>
                        <tr>
                            <th><label for="layout-view-mode">View Mode</label></th>
                            <td>
                                <select id="layout-view-mode" name="view_mode" style="width: 100%;">
                                    <option value="grid">Grid</option>
                                    <option value="list">List</option>
                                    <option value="3d">3D</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <p class="submit">
                        <button type="submit" class="button button-primary">Update Layout</button>
                    </p>
                    <div id="update-board-layout-result" style="margin-top: 10px;"></div>
                </form>
            </div>
            */ ?>

            <script type="text/javascript">
            jQuery(document).ready(function($) {
                // Commit 2.5.2: Setup nonce for room loading (if not already set)
                if (typeof window.n88ItemsNonce === 'undefined') {
                    window.n88ItemsNonce = {
                        nonce: '<?php echo esc_js( $nonce ); ?>',
                        ajaxUrl: '<?php echo esc_js( admin_url( 'admin-ajax.php' ) ); ?>'
                    };
                }
                var nonce = '<?php echo esc_js( $nonce ); ?>';
                var ajaxurl = '<?php echo esc_js( admin_url( 'admin-ajax.php' ) ); ?>';
                
                // Handle file input for item image - Commit 2.3.5.3: Fix image upload bug
                // Added HEIC support for preview
                $('#item-image-file').on('change', function(e) {
                    var file = e.target.files[0];
                    if (file) {
                        var fileName = file.name.toLowerCase();
                        // Check if it's an image (including HEIC) by MIME type or extension
                        var isImage = file.type.startsWith('image/') || 
                                     fileName.endsWith('.heic') || 
                                     fileName.endsWith('.heif');
                        var isHeic = fileName.endsWith('.heic') || fileName.endsWith('.heif');
                        
                        if (isImage) {
                            // Show preview container immediately
                            $('#item-image-preview').show();
                            $('#item-image-remove-btn').show();
                            
                            // For HEIC files, convert to JPEG for preview using heic2any library
                            if (isHeic) {
                                // Show loading message
                                var loadingHtml = '<div style="padding: 20px; text-align: center; background: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; max-width: 200px;">' +
                                    '<div style="font-size: 12px; color: #666;">Converting HEIC image...</div>' +
                                    '<div style="font-size: 11px; color: #999; margin-top: 4px;">' + file.name + '</div>' +
                                    '</div>';
                                $('#item-image-preview').html(loadingHtml);
                                
                                // Check if heic2any is available
                                if (typeof heic2any !== 'undefined') {
                                    // Convert HEIC to blob
                                    heic2any({
                                        blob: file,
                                        toType: 'image/jpeg',
                                        quality: 0.92
                                    }).then(function(conversionResult) {
                                        // heic2any returns an array, get the first result
                                        var blob = conversionResult;
                                        if (Array.isArray(blob)) {
                                            blob = blob[0];
                                        }
                                        
                                        // Create object URL from converted blob
                                        var objectUrl = URL.createObjectURL(blob);
                                        
                                        // Display the converted image
                                        // Restore the img element structure with converted image
                                        var imgElement = '<img id="item-image-preview-img" src="' + objectUrl + '" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 4px;" />';
                                        $('#item-image-preview').html(imgElement);
                                        
                                        // Add error handler to the new img element
                                        var img = $('#item-image-preview-img');
                                        img.on('load', function() {
                                            // Clean up object URL after image loads (optional, can keep for preview)
                                            // URL.revokeObjectURL(objectUrl); // Keep URL for preview display
                                        });
                                        img.on('error', function() {
                                            // If image fails to load, show placeholder
                                            URL.revokeObjectURL(objectUrl);
                                            var previewHtml = '<div style="padding: 20px; text-align: center; background: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; max-width: 200px;">' +
                                                '<div style="font-size: 12px; color: #666;">HEIC Image Selected</div>' +
                                                '<div style="font-size: 11px; color: #999; margin-top: 4px; word-break: break-all;">' + file.name + '</div>' +
                                                '</div>';
                                            $('#item-image-preview').html(previewHtml);
                                        });
                                    }).catch(function(error) {
                                        console.error('Error converting HEIC:', error);
                                        // Show placeholder on conversion error
                                        var previewHtml = '<div style="padding: 20px; text-align: center; background: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; max-width: 200px;">' +
                                            '<div style="font-size: 12px; color: #666;">HEIC Image Selected</div>' +
                                            '<div style="font-size: 11px; color: #999; margin-top: 4px; word-break: break-all;">' + file.name + '</div>' +
                                            '<div style="font-size: 10px; color: #999; margin-top: 8px;">File will upload correctly</div>' +
                                            '</div>';
                                        $('#item-image-preview').html(previewHtml);
                                    });
                                } else {
                                    // heic2any not loaded, show placeholder
                                    var previewHtml = '<div style="padding: 20px; text-align: center; background: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; max-width: 200px;">' +
                                        '<div style="font-size: 12px; color: #666;">HEIC Image Selected</div>' +
                                        '<div style="font-size: 11px; color: #999; margin-top: 4px; word-break: break-all;">' + file.name + '</div>' +
                                        '<div style="font-size: 10px; color: #999; margin-top: 8px;">File will upload correctly</div>' +
                                        '</div>';
                                    $('#item-image-preview').html(previewHtml);
                                }
                            } else {
                                // For regular images, use FileReader to show preview
                                var reader = new FileReader();
                                reader.onload = function(event) {
                                    var img = $('#item-image-preview-img');
                                    img.attr('src', event.target.result);
                                    img.show();
                                };
                                reader.onerror = function(error) {
                                    console.error('Error reading file:', error);
                                    // Show placeholder on read error
                                    var previewHtml = '<div style="padding: 20px; text-align: center; background: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; max-width: 200px;">' +
                                        '<div style="font-size: 12px; color: #666;">Image Preview</div>' +
                                        '<div style="font-size: 11px; color: #999; margin-top: 4px; word-break: break-all;">' + file.name + '</div>' +
                                        '</div>';
                                    $('#item-image-preview').html(previewHtml);
                        };
                        reader.readAsDataURL(file);
                            }
                            
                        // Clear any existing image_id or image_url to ensure file is uploaded
                        $('#item-image-id').val('');
                        $('#item-image-url').val('');
                        }
                    }
                });
                
                // Remove image button
                $('#item-image-remove-btn').on('click', function(e) {
                    e.preventDefault();
                    $('#item-image-id').val('');
                    $('#item-image-url').val('');
                    $('#item-image-file').val('');
                    $('#item-image-preview').hide();
                    $('#item-image-remove-btn').hide();
                });
                
                // Commit 2.3.5.1: CBM calculation for Add Item form
                function updateCBMDisplay() {
                    var width = parseFloat($('#item-width').val()) || 0;
                    var depth = parseFloat($('#item-depth').val()) || 0;
                    var height = parseFloat($('#item-height').val()) || 0;
                    var unit = $('#item-dimension-unit').val() || 'in';
                    var quantity = parseInt($('#item-quantity').val()) || 0;
                    
                    // Commit 2.3.5.3: CBM calculation removed from display (kept in background for later use)
                    // CBM calculations still run but are not displayed to avoid distracting the designer
                }
                
                // Show preview if URL is manually entered
                $('#item-image-url').on('blur', function() {
                    var url = $(this).val();
                    if (url) {
                        $('#item-image-preview-img').attr('src', url);
                        $('#item-image-preview').show();
                        $('#item-image-remove-btn').show();
                    } else {
                        $('#item-image-preview').hide();
                        $('#item-image-remove-btn').hide();
                    }
                });

                // Commit 2.5.2: Load rooms when project is selected
                $('#item-project').on('change', function() {
                    var projectId = $(this).val();
                    var $roomRow = $('#item-room-row');
                    var $roomSelect = $('#item-room');
                    
                    if (!projectId || projectId === '') {
                        $roomRow.hide();
                        $roomSelect.html('<option value="">-- Select Room --</option>');
                        return;
                    }
                    
                    // Show room selector
                    $roomRow.show();
                    $roomSelect.html('<option value="">Loading rooms...</option>');
                    
                    // Get nonce - prioritize window.n88ItemsNonce (set at page load)
                    var roomNonce = '';
                    
                    // Debug: Log available nonce sources
                    console.log('Room loading: Checking nonce sources...', {
                        n88ItemsNonce: window.n88ItemsNonce,
                        localNonce: typeof nonce !== 'undefined' ? nonce : 'undefined',
                        n88BoardNonce: window.n88BoardNonce,
                        n88BoardData: window.n88BoardData,
                        n88: window.n88
                    });
                    
                    // Try multiple sources in order of priority
                    if (window.n88ItemsNonce && window.n88ItemsNonce.nonce) {
                        roomNonce = window.n88ItemsNonce.nonce;
                        console.log('Room loading: Using n88ItemsNonce.nonce');
                    } else if (typeof nonce !== 'undefined' && nonce) {
                        // Local nonce variable from jQuery ready scope
                        roomNonce = nonce;
                        console.log('Room loading: Using local nonce variable');
                    } else if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                        roomNonce = window.n88BoardNonce.nonce;
                        console.log('Room loading: Using n88BoardNonce.nonce');
                    } else if (window.n88BoardData && window.n88BoardData.nonce) {
                        roomNonce = window.n88BoardData.nonce;
                        console.log('Room loading: Using n88BoardData.nonce');
                    } else if (window.n88 && window.n88.nonce) {
                        roomNonce = window.n88.nonce;
                        console.log('Room loading: Using window.n88.nonce');
                    }
                    
                    if (!roomNonce) {
                        $roomSelect.html('<option value="">Error: Security token missing. Please refresh the page.</option>');
                        console.error('Room loading: Nonce not found. Debug info:', {
                            n88ItemsNonce_exists: !!window.n88ItemsNonce,
                            n88ItemsNonce_nonce: window.n88ItemsNonce ? window.n88ItemsNonce.nonce : 'N/A',
                            localNonce_defined: typeof nonce !== 'undefined',
                            localNonce_value: typeof nonce !== 'undefined' ? nonce : 'N/A',
                            n88BoardNonce: !!window.n88BoardNonce,
                            n88BoardData: !!window.n88BoardData,
                            n88: !!window.n88
                        });
                        return;
                    }
                    
                    console.log('Room loading: Nonce found, making AJAX request with project_id:', projectId);
                    
                    // Load rooms via AJAX
                    var ajaxUrl = (typeof ajaxurl !== 'undefined' && ajaxurl) 
                                || (window.n88BoardData && window.n88BoardData.ajaxUrl) 
                                || (window.n88ItemsNonce && window.n88ItemsNonce.ajaxUrl)
                                || (window.n88 && window.n88.ajaxUrl) 
                                || '/wp-admin/admin-ajax.php';
                    
                    // Debug: Log what we're sending
                    console.log('Room loading: Sending AJAX request:', {
                        url: ajaxUrl,
                        action: 'n88_get_project_rooms',
                        project_id: projectId,
                        nonce_length: roomNonce ? roomNonce.length : 0,
                        nonce_preview: roomNonce ? roomNonce.substring(0, 10) + '...' : 'empty'
                    });
                    
                    $.ajax({
                        url: ajaxUrl,
                        type: 'GET',
                        data: {
                            action: 'n88_get_project_rooms',
                            project_id: projectId,
                            nonce: roomNonce
                        },
                        success: function(response) {
                            console.log('Room loading: AJAX response:', response);
                            if (response.success && response.data && response.data.rooms) {
                                var options = '<option value="">-- Select Room --</option>';
                                response.data.rooms.forEach(function(room) {
                                    options += '<option value="' + room.id + '">' + room.name + '</option>';
                                });
                                $roomSelect.html(options);
                            } else {
                                var errorMsg = response.data && response.data.message ? response.data.message : 'No rooms found';
                                $roomSelect.html('<option value="">' + errorMsg + '</option>');
                                console.error('Room loading: Error response:', response);
                                
                                // If it's a security error, show helpful message
                                if (errorMsg.toLowerCase().indexOf('security') !== -1 || errorMsg.toLowerCase().indexOf('nonce') !== -1) {
                                    console.error('Room loading: Security error detected. Nonce used:', roomNonce ? 'yes (' + roomNonce.length + ' chars)' : 'no');
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Room loading: AJAX error:', {
                                status: status,
                                error: error,
                                responseText: xhr.responseText,
                                statusCode: xhr.status,
                                requestData: {
                                    action: 'n88_get_project_rooms',
                                    project_id: projectId,
                                    nonce_sent: !!roomNonce
                                }
                            });
                            
                            // Try to parse error response
                            try {
                                var errorResponse = JSON.parse(xhr.responseText);
                                if (errorResponse.data && errorResponse.data.message) {
                                    $roomSelect.html('<option value="">Error: ' + errorResponse.data.message + '</option>');
                                } else {
                                    $roomSelect.html('<option value="">Error loading rooms. Check console for details.</option>');
                                }
                            } catch(e) {
                                $roomSelect.html('<option value="">Error loading rooms. Check console for details.</option>');
                            }
                        }
                    });
                });
                
                // Create Item
                $('#n88-create-item-form').on('submit', function(e) {
                    e.preventDefault();
                    var $result = $('#create-item-result');
                    var $submitBtn = $('#n88-create-item-form button[type="submit"]');
                    
                    // Show loader and disable button
                    $result.html('<p style="color: #666;"><span class="spinner is-active" style="float: none; margin: 0 5px 0 0;"></span>Adding item...</p>');
                    $submitBtn.prop('disabled', true).text('Adding...');

                    var boardId = $('#item-board').val();
                    <?php if ( $is_designer && $has_board ) : ?>
                    // For designers, always use their board
                    boardId = '<?php echo esc_js( $designer_board->id ); ?>';
                    <?php endif; ?>

                    // Store boardId for redirect
                    var redirectBoardId = boardId;

                    // Helper function to convert data URL to blob
                    function dataURLtoBlob(dataurl) {
                        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                        while(n--){
                            u8arr[n] = bstr.charCodeAt(n);
                        }
                        return new Blob([u8arr], {type:mime});
                    }
                    
                    // Always use 'active' status
                    var formData = new FormData();
                    formData.append('action', 'n88_create_item');
                    formData.append('nonce', nonce);
                    formData.append('title', $('#item-title').val());
                    formData.append('description', $('#item-description').val());
                    formData.append('item_type', $('#item-type').val());
                    formData.append('status', 'active'); // Always active
                    formData.append('size', $('#item-size').val());
                    
                    // Commit 2.5.2: Add project_id and room_id if selected
                    var projectId = $('#item-project').val();
                    var roomId = $('#item-room').val();
                    if (projectId && projectId !== '') {
                        formData.append('project_id', projectId);
                    }
                    if (roomId && roomId !== '') {
                        formData.append('room_id', roomId);
                    }
                    formData.append('board_id', boardId);
                    
                    // Commit 2.3.5.1: Add dimensions and quantity
                    var quantity = $('#item-quantity').val();
                    if (quantity) {
                        formData.append('quantity', quantity);
                    }
                    var width = $('#item-width').val();
                    var depth = $('#item-depth').val();
                    var height = $('#item-height').val();
                    var dimensionUnit = $('#item-dimension-unit').val() || 'in';
                    if (width || depth || height) {
                        formData.append('dims', JSON.stringify({
                            w: width ? parseFloat(width) : null,
                            d: depth ? parseFloat(depth) : null,
                            h: height ? parseFloat(height) : null,
                            unit: dimensionUnit
                        }));
                    }
                    
                    // Handle image: prefer file upload, fallback to URL
                    // Commit 2.3.5.3: Fix image upload - always check file input first
                    var imageFileInput = $('#item-image-file')[0];
                    var imageFile = imageFileInput && imageFileInput.files && imageFileInput.files.length > 0 ? imageFileInput.files[0] : null;
                    var imageUrl = $('#item-image-url').val();
                    var imageId = $('#item-image-id').val();
                    
                    if (imageFile) {
                        // Upload file directly (preferred method)
                        formData.append('image_file', imageFile);
                    } else if (imageId && parseInt(imageId) > 0) {
                        // Use existing attachment ID if available
                        formData.append('image_id', imageId);
                    } else if (imageUrl && !imageUrl.startsWith('data:')) {
                        // Use URL if provided and not a data URL
                        formData.append('image_url', imageUrl);
                    } else if (imageUrl && imageUrl.startsWith('data:')) {
                        // Convert data URL to blob and upload (fallback)
                        var blob = dataURLtoBlob(imageUrl);
                        formData.append('image_file', blob, 'item-image.png');
                    }

                    $.ajax({
                        url: ajaxurl,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                // Use board_id from response if available, otherwise use the one we sent
                                if (response.data.board_id) {
                                    redirectBoardId = response.data.board_id;
                                }
                                
                                <?php if ( $is_designer && $has_board ) : ?>
                                // Redirect to board page; if project selected go to that project; if room selected go to that room
                                if (redirectBoardId) {
                                    var baseUrl = '<?php echo esc_js( admin_url( 'admin.php' ) ); ?>';
                                    var params = new URLSearchParams();
                                    params.set('page', 'n88-rfq-board-demo');
                                    params.set('board_id', String(parseInt(redirectBoardId)));
                                    params.set('item_added', '1');
                                    if (projectId && projectId !== '') {
                                        params.set('project_id', String(projectId));
                                    }
                                    if (roomId && roomId !== '') {
                                        params.set('room_id', String(roomId));
                                    }
                                    window.location.href = baseUrl + '?' + params.toString();
                                } else {
                                    // Fallback: show success message if no board ID
                                    $result.html('<p style="color: green;">✓ Item created successfully! ID: ' + response.data.item_id + '</p>');
                                    $submitBtn.prop('disabled', false).text('Add Item');
                                }
                                <?php else : ?>
                                // Reset form for non-designers
                                $result.html('<p style="color: green;">✓ Item created! ID: ' + response.data.item_id + '</p>');
                                $('#n88-create-item-form')[0].reset();
                                $('#item-image-preview').hide();
                                $('#item-image-remove-btn').hide();
                                $submitBtn.prop('disabled', false).text('Add Item');
                                <?php endif; ?>
                            } else {
                                $result.html('<p style="color: red;">✗ Error: ' + (response.data.message || 'Unknown error') + '</p>');
                                $submitBtn.prop('disabled', false).text('Add Item');
                            }
                        },
                        error: function() {
                            $result.html('<p style="color: red;">✗ AJAX request failed. Please try again.</p>');
                            $submitBtn.prop('disabled', false).text('Add Item');
                        }
                    });
                });

                // Create Board
                $('#n88-create-board-form').on('submit', function(e) {
                    e.preventDefault();
                    var $result = $('#create-board-result');
                    $result.html('<p>Creating...</p>');

                    $.ajax({
                        url: ajaxurl,
                        type: 'POST',
                        data: {
                            action: 'n88_create_board',
                            nonce: nonce,
                            name: $('#board-name').val(),
                            description: $('#board-description').val(),
                            view_mode: 'grid' // Default view mode (view mode option hidden)
                        },
                        success: function(response) {
                            if (response.success) {
                                $result.html('<p style="color: green;">✓ Board created! ID: ' + response.data.board_id + '</p>');
                                // For designers, reload page to show item form
                                <?php if ( $is_designer ) : ?>
                                setTimeout(function() {
                                    window.location.reload();
                                }, 1000);
                                <?php endif; ?>
                            } else {
                                $result.html('<p style="color: red;">✗ Error: ' + (response.data.message || 'Unknown error') + '</p>');
                            }
                        },
                        error: function() {
                            $result.html('<p style="color: red;">✗ AJAX request failed</p>');
                        }
                    });
                });

                // Update Item - COMMENTED OUT FOR NOW
                /*
                $('#n88-update-item-form').on('submit', function(e) {
                    e.preventDefault();
                    var $result = $('#update-item-result');
                    $result.html('<p>Updating...</p>');

                    var data = {
                        action: 'n88_update_item',
                        nonce: nonce,
                        item_id: $('#update-item-id').val()
                    };

                    if ($('#update-item-title').val()) data.title = $('#update-item-title').val();
                    if ($('#update-item-description').val()) data.description = $('#update-item-description').val();
                    if ($('#update-item-status').val()) data.status = $('#update-item-status').val();
                    if ($('#update-item-type').val()) data.item_type = $('#update-item-type').val();

                    $.ajax({
                        url: ajaxurl,
                        type: 'POST',
                        data: data,
                        success: function(response) {
                            if (response.success) {
                                $result.html('<p style="color: green;">✓ Item updated! Changed fields: ' + (response.data.changed_fields || []).join(', ') + '</p>');
                            } else {
                                $result.html('<p style="color: red;">✗ Error: ' + (response.data.message || 'Unknown error') + '</p>');
                            }
                        },
                        error: function() {
                            $result.html('<p style="color: red;">✗ AJAX request failed</p>');
                        }
                    });
                });
                */

                // Add Item to Board
                $('#n88-add-item-to-board-form').on('submit', function(e) {
                    e.preventDefault();
                    var $result = $('#add-item-to-board-result');
                    $result.html('<p>Adding...</p>');

                    $.ajax({
                        url: ajaxurl,
                        type: 'POST',
                        data: {
                            action: 'n88_add_item_to_board',
                            nonce: nonce,
                            board_id: $('#add-board-id').val(),
                            item_id: $('#add-item-id').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                $result.html('<p style="color: green;">✓ Item added to board!</p>');
                            } else {
                                $result.html('<p style="color: red;">✗ Error: ' + (response.data.message || 'Unknown error') + '</p>');
                            }
                        },
                        error: function() {
                            $result.html('<p style="color: red;">✗ AJAX request failed</p>');
                        }
                    });
                });

                // Update Board Layout - COMMENTED OUT FOR NOW
                /*
                $('#n88-update-board-layout-form').on('submit', function(e) {
                    e.preventDefault();
                    var $result = $('#update-board-layout-result');
                    $result.html('<p>Updating...</p>');

                    var data = {
                        action: 'n88_update_board_layout',
                        nonce: nonce,
                        board_id: $('#layout-board-id').val(),
                        item_id: $('#layout-item-id').val(),
                        position_x: $('#layout-position-x').val(),
                        position_y: $('#layout-position-y').val(),
                        position_z: $('#layout-position-z').val(),
                        view_mode: $('#layout-view-mode').val()
                    };

                    if ($('#layout-size-width').val()) data.size_width = $('#layout-size-width').val();
                    if ($('#layout-size-height').val()) data.size_height = $('#layout-size-height').val();

                    $.ajax({
                        url: ajaxurl,
                        type: 'POST',
                        data: data,
                        success: function(response) {
                            if (response.success) {
                                $result.html('<p style="color: green;">✓ Layout updated!</p>');
                            } else {
                                $result.html('<p style="color: red;">✗ Error: ' + (response.data.message || 'Unknown error') + '</p>');
                            }
                        },
                        error: function() {
                            $result.html('<p style="color: red;">✗ AJAX request failed</p>');
                        }
                    });
                });
                */
            });
            </script>
        </div>
        <?php
    }

    /**
     * Render Board Demo page (Milestone 1.3.4a - Testing Only)
     * 
     * Demo harness for testing board interactions without API calls.
     */
    public function render_board_demo() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }

        $user_id = get_current_user_id();
        $current_user = wp_get_current_user();
        $is_designer = in_array( 'n88_designer', $current_user->roles, true ) || in_array( 'designer', $current_user->roles, true );

        // Hide admin bar for this page - Forcefully hide with multiple methods
        add_action( 'admin_head', function() {
            echo '<style>
                #wpadminbar { display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important; position: absolute !important; top: -9999px !important; left: -9999px !important; width: 0 !important; }
                html { margin-top: 0 !important; padding-top: 0 !important; }
                body.admin-bar { margin-top: 0 !important; padding-top: 0 !important; }
                body.admin-bar #wpadminbar { display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important; position: absolute !important; top: -9999px !important; left: -9999px !important; width: 0 !important; }
                *[id*="wpadminbar"] { display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; }
            </style>';
        }, 999 );
        
        // Also add JavaScript to forcefully remove admin bar - Run immediately and continuously
        add_action( 'admin_footer', function() {
            echo '<script>
                (function() {
                    try {
                        function forceHideAdminBar() {
                            try {
                                // Remove admin bar element completely if it exists
                                var adminBar = document.getElementById("wpadminbar");
                                if (adminBar && adminBar.parentNode) {
                                    adminBar.remove();
                                }
                                // Remove admin-bar class from body
                                if (document.body && document.body.classList && document.body.classList.contains("admin-bar")) {
                                    document.body.classList.remove("admin-bar");
                                }
                                // Force margin/padding to 0
                                if (document.documentElement) {
                                    document.documentElement.style.marginTop = "0";
                                    document.documentElement.style.paddingTop = "0";
                                }
                                if (document.body) {
                                    document.body.style.marginTop = "0";
                                    document.body.style.paddingTop = "0";
                                }
                            } catch (e) {
                                // Silently fail to prevent breaking the page
                            }
                        }
                        // Run immediately
                        forceHideAdminBar();
                        // Run on DOM ready
                        if (document.readyState === "loading") {
                            document.addEventListener("DOMContentLoaded", forceHideAdminBar);
                        } else {
                            forceHideAdminBar();
                        }
                        // Run a few times to catch late-loading elements (reduced frequency)
                        setTimeout(forceHideAdminBar, 100);
                        setTimeout(forceHideAdminBar, 500);
                        setTimeout(forceHideAdminBar, 1000);
                        // Watch only for admin bar specifically (more targeted)
                        if (typeof MutationObserver !== "undefined") {
                            var observer = new MutationObserver(function(mutations) {
                                try {
                                    var adminBar = document.getElementById("wpadminbar");
                                    if (adminBar && adminBar.parentNode) {
                                        adminBar.remove();
                                        if (document.body && document.body.classList) {
                                            document.body.classList.remove("admin-bar");
                                        }
                                    }
                                } catch (e) {
                                    // Silently fail
                                }
                            });
                            // Only observe body for admin bar, not the entire subtree
                            if (document.body) {
                                observer.observe(document.body, { 
                                    childList: true, 
                                    subtree: false,
                                    attributes: false
                                });
                            }
                        }
                    } catch (e) {
                        // Silently fail to prevent breaking the page
                    }
                })();
            </script>';
        }, 999 );

        // If designer and no board_id in URL, redirect to their board
        if ( $is_designer && ! isset( $_GET['board_id'] ) ) {
            $designer_board = $this->get_designer_board( $user_id );
            if ( $designer_board ) {
                wp_safe_redirect( admin_url( 'admin.php?page=n88-rfq-board-demo&board_id=' . $designer_board->id ) );
                exit;
            }
        }

        // Enqueue WordPress media library for image uploader
        wp_enqueue_media();

        // Check if board_id parameter exists - if yes, load real board; if no, use demo seed items
        $board_id = isset( $_GET['board_id'] ) ? absint( $_GET['board_id'] ) : 0;
        $items = array();
        $is_real_board = false;
        $board_name = 'Demo Board';
        $board = null; // Initialize board variable

        // If board_id provided, load real board items
        if ( $board_id > 0 ) {
            $board = N88_Authorization::get_board_for_user( $board_id, $user_id );
            if ( $board ) {
                $is_real_board = true;
                $board_name = $board->name;
                
                // Fetch board layout
                $layout_data = null;
                if ( ! empty( $board->latest_layout_json ) ) {
                    $layout_data = json_decode( $board->latest_layout_json, true );
                    if ( json_last_error() !== JSON_ERROR_NONE || ! is_array( $layout_data ) ) {
                        $layout_data = null;
                    }
                }

                // Fetch items from database
                global $wpdb;
                $board_items_table = $wpdb->prefix . 'n88_board_items';
                $items_table = $wpdb->prefix . 'n88_items';
                
                // Check if meta_json column exists, and try to add it if it doesn't
                $items_table_safe = preg_replace( '/[^a-zA-Z0-9_]/', '', $items_table );
                $items_columns = $wpdb->get_col( "DESCRIBE {$items_table_safe}" );
                $has_meta_json = in_array( 'meta_json', $items_columns, true );
                
                // If column doesn't exist, try to add it automatically
                if ( ! $has_meta_json ) {
                    $alter_result = $wpdb->query( "ALTER TABLE {$items_table_safe} ADD COLUMN meta_json LONGTEXT NULL AFTER primary_image_id" );
                    if ( $alter_result !== false ) {
                        $has_meta_json = true;
                        error_log('Successfully added meta_json column to items table');
                    } else {
                        error_log('Failed to add meta_json column: ' . $wpdb->last_error);
                    }
                }
                
                // Always try to select meta_json - if column doesn't exist, query will fail gracefully
                // But we check first to avoid errors
                $select_fields = "bi.item_id, i.id, i.title, i.description, i.item_type, i.status, i.primary_image_id";
                if ( $has_meta_json ) {
                    $select_fields .= ", i.meta_json";
                } else {
                    // Column doesn't exist - log warning
                    error_log('WARNING: meta_json column does not exist in items table. Size preferences will not be saved/loaded.');
                    error_log('Please run the migration to add meta_json column, or deactivate/reactivate the plugin.');
                }
                
                // Add a comprehensive cache flush to ensure fresh data (for both new items and deleted items)
                // This is critical when redirecting immediately after item creation or deletion
                wp_cache_flush();
                
                // Also clear the query cache specifically for wpdb
                if ( isset( $wpdb->query_cache ) ) {
                    $wpdb->query_cache = array();
                }
                
                // Check if this is a redirect after item creation (item_added parameter)
                $is_after_item_creation = isset( $_GET['item_added'] ) && $_GET['item_added'] == '1';
                
                // DEBUG: Log if this is after item creation
                if ( $is_after_item_creation ) {
                    error_log('=== PHP: FETCHING BOARD ITEMS AFTER ITEM CREATION ===');
                    error_log('PHP: Board ID: ' . $board_id);
                    error_log('PHP: User ID: ' . $user_id);
                }
                
                // Clear cache for fresh data
                wp_cache_flush();
                if ( isset( $wpdb->query_cache ) ) {
                    $wpdb->query_cache = array();
                }
                
                // Query board items - MUST filter removed_at IS NULL to exclude deleted items
                // Commit 2.5.2: Filter by project_id and room_id if selected
                $project_id = isset( $_GET['project_id'] ) ? absint( $_GET['project_id'] ) : 0;
                $room_id = isset( $_GET['room_id'] ) ? absint( $_GET['room_id'] ) : 0;
                
                // If this is after item creation, log the query for debugging
                if ( $is_after_item_creation ) {
                    error_log('PHP: Cache cleared, now querying database...');
                }
                
                // Build query with optional project and room filters
                if ( $project_id > 0 ) {
                    // Show items for selected project
                    if ( $room_id > 0 ) {
                        // Fix 3: Filter by specific room
                        $board_items = $wpdb->get_results(
                            $wpdb->prepare(
                                "SELECT {$select_fields}
                                 FROM {$board_items_table} bi
                                 INNER JOIN {$items_table} i ON bi.item_id = i.id
                                 WHERE bi.board_id = %d 
                                 AND i.project_id = %d
                                 AND i.room_id = %d
                                 AND bi.removed_at IS NULL
                                 AND i.deleted_at IS NULL
                                 ORDER BY bi.added_at ASC",
                                $board_id,
                                $project_id,
                                $room_id
                            )
                        );
                    } else {
                        // Show all items for project (all rooms)
                        $board_items = $wpdb->get_results(
                            $wpdb->prepare(
                                "SELECT {$select_fields}
                                 FROM {$board_items_table} bi
                                 INNER JOIN {$items_table} i ON bi.item_id = i.id
                                 WHERE bi.board_id = %d 
                                 AND i.project_id = %d
                                 AND bi.removed_at IS NULL
                                 AND i.deleted_at IS NULL
                                 ORDER BY bi.added_at ASC",
                                $board_id,
                                $project_id
                            )
                        );
                    }
                } else {
                    // Fix 1: Show only items WITHOUT project (exclude project items from main board)
                    $board_items = $wpdb->get_results(
                        $wpdb->prepare(
                            "SELECT {$select_fields}
                             FROM {$board_items_table} bi
                             INNER JOIN {$items_table} i ON bi.item_id = i.id
                             WHERE bi.board_id = %d 
                             AND (i.project_id IS NULL OR i.project_id = 0)
                             AND bi.removed_at IS NULL
                             AND i.deleted_at IS NULL
                             ORDER BY bi.added_at ASC",
                            $board_id
                        )
                    );
                }
                
                // Log results if after item creation
                if ( $is_after_item_creation ) {
                    error_log('PHP: Board items found: ' . count( $board_items ));
                    if ( count( $board_items ) > 0 ) {
                        error_log('PHP: First item ID: ' . $board_items[0]->item_id);
                        error_log('PHP: Last item ID: ' . $board_items[ count( $board_items ) - 1 ]->item_id);
                        error_log('PHP: Items will be passed to JavaScript as initialItems');
                    } else {
                        error_log('PHP: WARNING: No items found after item creation redirect!');
                        error_log('PHP: This might cause empty page - items may not be committed yet');
                    }
                    error_log('PHP: === END FETCHING BOARD ITEMS ===');
                }
                
                // Debug: Log board items count and meta_json status
                error_log('Board items fetched from database: ' . count( $board_items ));
                error_log('meta_json column exists: ' . ( $has_meta_json ? 'YES' : 'NO' ));
                if ( count( $board_items ) > 0 ) {
                    error_log('First board item ID: ' . $board_items[0]->item_id);
                    error_log('Last board item ID: ' . $board_items[ count( $board_items ) - 1 ]->item_id);
                    // Check if first item has meta_json
                    if ( $has_meta_json && isset( $board_items[0]->meta_json ) ) {
                        error_log('First item meta_json: ' . substr( $board_items[0]->meta_json, 0, 100 ));
                        $test_meta = json_decode( $board_items[0]->meta_json, true );
                        if ( is_array( $test_meta ) ) {
                            error_log('First item default_size: ' . ( isset( $test_meta['default_size'] ) ? $test_meta['default_size'] : 'NOT SET' ) );
                        }
                    } else {
                        error_log('First item meta_json: NOT AVAILABLE (column missing or empty)');
                    }
                }

                // Default size presets
                $CARD_SIZES = array(
                    'S' => array( 'w' => 160, 'h' => 200 ),
                    'D' => array( 'w' => 200, 'h' => 250 ),
                    'L' => array( 'w' => 280, 'h' => 350 ),
                    'XL' => array( 'w' => 360, 'h' => 450 ),
                );

                // Build items array by merging layout data with board items
                $layout_items_map = array();
                if ( $layout_data && isset( $layout_data['items'] ) && is_array( $layout_data['items'] ) ) {
                    foreach ( $layout_data['items'] as $layout_item ) {
                        $item_id_from_layout = str_replace( 'item-', '', $layout_item['id'] );
                        // Ensure numeric key for consistent matching
                        $layout_items_map[ intval( $item_id_from_layout ) ] = $layout_item;
                    }
                }
                
                // Debug: Log layout items count
                error_log('Layout items count: ' . count( $layout_items_map ));
                if ( ! empty( $layout_items_map ) ) {
                    error_log('Layout item IDs: ' . implode( ', ', array_keys( $layout_items_map ) ) );
                }

                $z_index = 1;
                $items_count_before = count( $items );
                $processed_item_ids = array(); // Track processed items to prevent duplicates
                foreach ( $board_items as $board_item ) {
                    // Prevent duplicate items
                    $item_id = intval( $board_item->item_id );
                    if ( in_array( $item_id, $processed_item_ids, true ) ) {
                        error_log('WARNING: Duplicate item ID ' . $item_id . ' detected, skipping...');
                        continue;
                    }
                    $processed_item_ids[] = $item_id;
                    $item_id = intval( $board_item->item_id ); // Ensure numeric for consistent matching
                    $item_id_string = 'item-' . $item_id;
                    
                    // Get image URL from primary_image_id
                    $image_url = '';
                    if ( ! empty( $board_item->primary_image_id ) ) {
                        $image_url = wp_get_attachment_image_url( $board_item->primary_image_id, 'full' );
                        if ( ! $image_url ) {
                            $image_url = wp_get_attachment_url( $board_item->primary_image_id );
                        }
                    }
                    
                    // Parse meta_json to extract all item facts
                    $item_meta = array();
                    if ( ! empty( $board_item->meta_json ) ) {
                        $decoded_meta = json_decode( $board_item->meta_json, true );
                        if ( is_array( $decoded_meta ) ) {
                            $item_meta = $decoded_meta;
                        }
                    }
                    
                    if ( isset( $layout_items_map[ $item_id ] ) ) {
                        $layout_item = $layout_items_map[ $item_id ];
                        // Get sizeKey from layout, but if not present, try to get from meta_json
                        $layout_size_key = isset( $layout_item['sizeKey'] ) ? sanitize_text_field( $layout_item['sizeKey'] ) : null;
                        // Always try to read meta_json for default_size, even if column check might have failed
                        if ( ! $layout_size_key && isset( $item_meta['default_size'] ) ) {
                            $meta_size = sanitize_text_field( $item_meta['default_size'] );
                            if ( in_array( $meta_size, array( 'S', 'D', 'L', 'XL' ), true ) ) {
                                $layout_size_key = $meta_size;
                                // Debug: Log when using default_size from meta_json
                                error_log('Item ' . $item_id . ' - Using default_size from meta_json: ' . $layout_size_key . ' (layout had no sizeKey)');
                            }
                        }
                        if ( ! $layout_size_key ) {
                            $layout_size_key = 'D';
                            error_log('Item ' . $item_id . ' - No sizeKey found, defaulting to D');
                        }
                        
                        // Debug: Log final sizeKey being used
                        error_log('Item ' . $item_id . ' - Final sizeKey: ' . $layout_size_key);
                        
                        // Always use sizeKey dimensions to ensure consistency with preset sizes
                        // This ensures that if default_size was set during creation, it's respected
                        $item_width = $CARD_SIZES[ $layout_size_key ]['w'];
                        $item_height = $CARD_SIZES[ $layout_size_key ]['h'];
                        
                        // Extract item facts from meta_json
                        $item_dims = isset( $item_meta['dims'] ) && is_array( $item_meta['dims'] ) ? $item_meta['dims'] : null;
                        $item_dims_cm = isset( $item_meta['dims_cm'] ) && is_array( $item_meta['dims_cm'] ) ? $item_meta['dims_cm'] : null;
                        $item_cbm = isset( $item_meta['cbm'] ) ? floatval( $item_meta['cbm'] ) : null;
                        $item_sourcing_type = isset( $item_meta['sourcing_type'] ) ? sanitize_text_field( $item_meta['sourcing_type'] ) : null;
                        $item_timeline_type = isset( $item_meta['timeline_type'] ) ? sanitize_text_field( $item_meta['timeline_type'] ) : null;
                        $item_inspiration = isset( $item_meta['inspiration'] ) && is_array( $item_meta['inspiration'] ) ? $item_meta['inspiration'] : array();
                        // Extract quantity and notes from meta_json
                        $item_quantity = isset( $item_meta['quantity'] ) ? intval( $item_meta['quantity'] ) : null;
                        $item_smart_alternatives_note = isset( $item_meta['smart_alternatives_note'] ) ? sanitize_textarea_field( $item_meta['smart_alternatives_note'] ) : '';
                        $item_delivery_country = isset( $item_meta['delivery_country'] ) ? sanitize_text_field( $item_meta['delivery_country'] ) : '';
                        $item_delivery_postal = isset( $item_meta['delivery_postal'] ) ? sanitize_text_field( $item_meta['delivery_postal'] ) : '';
                        $item_smart_alternatives = isset( $item_meta['smart_alternatives'] ) ? (bool) $item_meta['smart_alternatives'] : null;
                        
                        // Check RFQ status
                        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
                        $has_rfq = $wpdb->get_var( $wpdb->prepare(
                            "SELECT COUNT(*) FROM {$rfq_routes_table} 
                             WHERE item_id = %d 
                             AND status IN ('queued', 'sent', 'viewed', 'bid_submitted')",
                            $item_id
                        ) ) > 0;
                        
                        // Get current RFQ revision from item meta
                        $rfq_revision_current = isset( $item_meta['rfq_revision_current'] ) ? $item_meta['rfq_revision_current'] : null;
                        
                        // Check bid count - only count valid bids (status = 'submitted' and matching current revision)
                        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
                        $valid_bid_count = 0;
                        
                        if ( $rfq_revision_current !== null ) {
                            // Count bids matching current revision
                            // Check if bids table has rfq_revision_at_submit column
                            $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
                            $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
                            
                            if ( $has_revision_column ) {
                                $valid_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                    "SELECT COUNT(*) FROM {$item_bids_table} 
                                     WHERE item_id = %d 
                                     AND status = 'submitted'
                                     AND rfq_revision_at_submit = %s",
                                    $item_id,
                                    $rfq_revision_current
                                ) ) );
                            } else {
                                // Fallback: count all submitted bids if revision column doesn't exist
                                $valid_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                    "SELECT COUNT(*) FROM {$item_bids_table} 
                                     WHERE item_id = %d 
                                     AND status = 'submitted'",
                                    $item_id
                                ) ) );
                            }
                        } else {
                            // No revision tracking - count all submitted bids
                            $valid_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                "SELECT COUNT(*) FROM {$item_bids_table} 
                                 WHERE item_id = %d 
                                 AND status = 'submitted'",
                                $item_id
                            ) ) );
                        }
                        
                        $bid_count = $valid_bid_count; // For backward compatibility
                        $has_bids = $valid_bid_count > 0;
                        
                        // Check if revision changed (dimensions/quantity changed after RFQ)
                        $revision_changed = false;
                        if ( $has_rfq && isset( $item_meta['revision_changed'] ) ) {
                            $revision_changed = (bool) $item_meta['revision_changed'];
                        }
                        
                        // Check if there are stale bids (has_warning flag)
                        // Warning should show if there are bids with old revision or NULL revision
                        // IMPORTANT: Check for stale bids even if no valid bids exist (for Standby status)
                        // Also check for withdrawn bids - if all bids are withdrawn, show Standby instead of RFQ Sent
                        $has_warning = false;
                        if ( $has_rfq && $rfq_revision_current !== null ) {
                            $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
                            $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
                            
                            if ( $has_revision_column ) {
                                // Check if there are any stale bids (revision < current or NULL)
                                $stale_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                    "SELECT COUNT(*) FROM {$item_bids_table} 
                                     WHERE item_id = %d 
                                     AND status = 'submitted'
                                     AND (rfq_revision_at_submit IS NULL OR rfq_revision_at_submit < %d)",
                                    $item_id,
                                    $rfq_revision_current
                                ) ) );
                                
                                // Show warning if there are stale bids (regardless of valid bid count)
                                $has_warning = $stale_bid_count > 0;
                            }
                        }
                        
                        // If no valid bids but there are withdrawn bids, set has_warning to show Standby
                        if ( ! $has_bids && $has_rfq ) {
                            $withdrawn_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                "SELECT COUNT(*) FROM {$item_bids_table} 
                                 WHERE item_id = %d 
                                 AND status = 'withdrawn'",
                                $item_id
                            ) ) );
                            
                            // If there are withdrawn bids but no submitted bids, show Standby
                            if ( $withdrawn_bid_count > 0 ) {
                                $has_warning = true;
                            }
                        }
                        
                        // Check award_set from item meta or status
                        $award_set = false;
                        if ( isset( $item_meta['award_set'] ) ) {
                            $award_set = (bool) $item_meta['award_set'];
                        } else if ( isset( $board_item->status ) && $board_item->status === 'awarded' ) {
                            $award_set = true;
                        }
                        
                        // Commit 2.4.1: Check if any bid is awarded for this item
                        // Check both bids table and item meta_json for awarded status
                        $has_awarded_bid = intval( $wpdb->get_var( $wpdb->prepare(
                            "SELECT COUNT(*) FROM {$item_bids_table} 
                             WHERE item_id = %d 
                             AND status = 'awarded'",
                            $item_id
                        ) ) ) > 0;
                        
                        // Also check item meta_json for awarded status (more reliable)
                        if ( ! $has_awarded_bid && isset( $item_meta['item_status'] ) && $item_meta['item_status'] === 'Awarded' ) {
                            $has_awarded_bid = true;
                        }
                        if ( ! $has_awarded_bid && isset( $item_meta['awarded_bid_snapshot'] ) ) {
                            $has_awarded_bid = true;
                        }
                        
                        // Check for unread operator messages (designer_operator thread)
                        // Action Required: Show when operator has sent messages that designer hasn't replied to
                        $messages_table = $wpdb->prefix . 'n88_item_messages';
                        $unread_operator_messages = 0;
                        $has_unread_operator_messages = false;
                        
                        // Check if messages table exists
                        $messages_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$messages_table}'" ) === $messages_table;
                        if ( $messages_table_exists ) {
                            // Count unread operator messages (operator messages with no designer reply after them)
                            $unread_operator_messages = intval( $wpdb->get_var( $wpdb->prepare(
                                "SELECT COUNT(DISTINCT m.message_id)
                                FROM {$messages_table} m
                                WHERE m.item_id = %d
                                AND m.thread_type = 'designer_operator'
                                AND m.sender_role = 'operator'
                                AND NOT EXISTS (
                                    SELECT 1 FROM {$messages_table} m2
                                    WHERE m2.item_id = m.item_id
                                    AND m2.thread_type = 'designer_operator'
                                    AND m2.sender_role = 'designer'
                                    AND m2.created_at > m.created_at
                                )",
                                $item_id
                            ) ) );
                            $has_unread_operator_messages = $unread_operator_messages > 0;
                            // Fix #13/#26: If operator marked resolved (designer thread), clear Action Required
                            if ( $has_unread_operator_messages ) {
                                $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
                                if ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) === $resolutions_table ) {
                                    $resolved = $wpdb->get_var( $wpdb->prepare(
                                        "SELECT 1 FROM {$resolutions_table} WHERE item_id = %d AND bid_id IS NULL LIMIT 1",
                                        $item_id
                                    ) );
                                    if ( $resolved ) {
                                        $has_unread_operator_messages = false;
                                        $unread_operator_messages = 0;
                                    }
                                }
                            }
                        }
                        
                        // Commit 2.3.9.1C: Check for prototype payment status
                        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
                        $prototype_payment_status = null;
                        $has_prototype_payment = false;
                        
                        // Check if prototype payments table exists
                        $prototype_payments_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table;
                        if ( $prototype_payments_table_exists ) {
                            // Get the most recent prototype payment for this item and designer
                            $prototype_payment = $wpdb->get_row( $wpdb->prepare(
                                "SELECT status 
                                FROM {$prototype_payments_table}
                                WHERE item_id = %d
                                AND designer_user_id = %d
                                ORDER BY created_at DESC
                                LIMIT 1",
                                $item_id,
                                $current_user->ID
                            ), ARRAY_A );
                            
                            if ( $prototype_payment ) {
                                $has_prototype_payment = true;
                                $prototype_payment_status = $prototype_payment['status'];
                            }
                        }
                        
                        $items[] = array(
                            'id' => $item_id_string,
                            'x' => isset( $layout_item['x'] ) ? floatval( $layout_item['x'] ) : 50 + ( count( $items ) * 250 ),
                            'y' => isset( $layout_item['y'] ) ? floatval( $layout_item['y'] ) : 50,
                            'z' => isset( $layout_item['z'] ) ? intval( $layout_item['z'] ) : $z_index++,
                            'width' => $item_width,
                            'height' => $item_height,
                            'sizeKey' => $layout_size_key,
                            'displayMode' => isset( $layout_item['displayMode'] ) ? sanitize_text_field( $layout_item['displayMode'] ) : 'photo_only',
                            'title' => isset( $board_item->title ) ? wp_strip_all_tags( sanitize_text_field( $board_item->title ) ) : '',
                            'description' => isset( $board_item->description ) ? wp_strip_all_tags( sanitize_textarea_field( $board_item->description ) ) : '',
                            'item_type' => isset( $board_item->item_type ) ? sanitize_text_field( $board_item->item_type ) : '',
                            'imageUrl' => $image_url ? esc_url_raw( $image_url ) : '',
                            // Add item facts from meta_json
                            'dims' => $item_dims,
                            'dims_cm' => $item_dims_cm,
                            'cbm' => $item_cbm,
                            'sourcing_type' => $item_sourcing_type,
                            'timeline_type' => $item_timeline_type,
                            'inspiration' => $item_inspiration,
                            // Add quantity and notes from meta_json
                            'quantity' => $item_quantity,
                            'smart_alternatives_note' => $item_smart_alternatives_note,
                            'delivery_country' => $item_delivery_country,
                            'delivery_postal' => $item_delivery_postal,
                            'smart_alternatives' => $item_smart_alternatives,
                            // RFQ and bid status fields
                            'has_rfq' => $has_rfq,
                            'has_bids' => $has_bids,
                            'bid_count' => $bid_count,
                            'bids_count' => $bid_count,
                            'valid_bid_count' => $valid_bid_count,
                            'rfq_revision_current' => $rfq_revision_current,
                            'revision_changed' => $revision_changed,
                            'has_warning' => $has_warning,
                            'award_set' => $award_set,
                            'has_awarded_bid' => $has_awarded_bid, // Commit 2.4.1: Flag if any bid is awarded
                            // Action Required: Unread operator messages
                            'has_unread_operator_messages' => $has_unread_operator_messages,
                            'unread_operator_messages' => $unread_operator_messages,
                            // Commit 2.3.9.1C: Prototype payment status
                            'has_prototype_payment' => $has_prototype_payment,
                            'prototype_payment_status' => $prototype_payment_status,
                            // Also add meta object for backward compatibility
                            'meta' => $item_meta,
                        );
                    } else {
                        // New item - no layout data yet, use defaults from item meta_json
                        $default_size = 'L';
                        // Always try to read meta_json, even if column check might have failed
                        if ( ! empty( $item_meta ) ) {
                            error_log('Item ' . $item_id . ' - Parsed meta_json: ' . print_r( $item_meta, true ));
                            if ( isset( $item_meta['default_size'] ) ) {
                                $meta_size = sanitize_text_field( $item_meta['default_size'] );
                                error_log('Item ' . $item_id . ' - Found default_size in meta: ' . $meta_size);
                                if ( in_array( $meta_size, array( 'S', 'D', 'L', 'XL' ), true ) ) {
                                    $default_size = $meta_size;
                                    error_log('Item ' . $item_id . ' - Using default_size: ' . $default_size);
                                } else {
                                    error_log('Item ' . $item_id . ' - Invalid default_size value: ' . $meta_size);
                                }
                            } else {
                                error_log('Item ' . $item_id . ' - default_size key not found in meta_json');
                            }
                            // Also check for image_url in meta if primary_image_id is empty
                            if ( empty( $image_url ) && isset( $item_meta['image_url'] ) ) {
                                $image_url = esc_url_raw( $item_meta['image_url'] );
                            }
                        } else {
                            if ( ! $has_meta_json ) {
                                error_log('Item ' . $item_id . ' - meta_json column does not exist in database');
                            } else {
                                error_log('Item ' . $item_id . ' - meta_json is empty or null for this item');
                            }
                            error_log('Item ' . $item_id . ' - Using default size D (fallback)');
                        }
                        
                        // Extract item facts from meta_json
                        $item_dims = isset( $item_meta['dims'] ) && is_array( $item_meta['dims'] ) ? $item_meta['dims'] : null;
                        $item_dims_cm = isset( $item_meta['dims_cm'] ) && is_array( $item_meta['dims_cm'] ) ? $item_meta['dims_cm'] : null;
                        $item_cbm = isset( $item_meta['cbm'] ) ? floatval( $item_meta['cbm'] ) : null;
                        $item_sourcing_type = isset( $item_meta['sourcing_type'] ) ? sanitize_text_field( $item_meta['sourcing_type'] ) : null;
                        $item_timeline_type = isset( $item_meta['timeline_type'] ) ? sanitize_text_field( $item_meta['timeline_type'] ) : null;
                        $item_inspiration = isset( $item_meta['inspiration'] ) && is_array( $item_meta['inspiration'] ) ? $item_meta['inspiration'] : array();
                        // Extract quantity and notes from meta_json
                        $item_quantity = isset( $item_meta['quantity'] ) ? intval( $item_meta['quantity'] ) : null;
                        $item_smart_alternatives_note = isset( $item_meta['smart_alternatives_note'] ) ? sanitize_textarea_field( $item_meta['smart_alternatives_note'] ) : '';
                        $item_delivery_country = isset( $item_meta['delivery_country'] ) ? sanitize_text_field( $item_meta['delivery_country'] ) : '';
                        $item_delivery_postal = isset( $item_meta['delivery_postal'] ) ? sanitize_text_field( $item_meta['delivery_postal'] ) : '';
                        $item_smart_alternatives = isset( $item_meta['smart_alternatives'] ) ? (bool) $item_meta['smart_alternatives'] : null;
                        
                        // Check RFQ status
                        $rfq_routes_table = $wpdb->prefix . 'n88_rfq_routes';
                        $has_rfq = $wpdb->get_var( $wpdb->prepare(
                            "SELECT COUNT(*) FROM {$rfq_routes_table} 
                             WHERE item_id = %d 
                             AND status IN ('queued', 'sent', 'viewed', 'bid_submitted')",
                            $item_id
                        ) ) > 0;
                        
                        // Get current RFQ revision from item meta
                        $rfq_revision_current = isset( $item_meta['rfq_revision_current'] ) ? $item_meta['rfq_revision_current'] : null;
                        
                        // Check bid count - only count valid bids (status = 'submitted' and matching current revision)
                        $item_bids_table = $wpdb->prefix . 'n88_item_bids';
                        $valid_bid_count = 0;
                        
                        if ( $rfq_revision_current !== null ) {
                            // Count bids matching current revision
                            $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
                            $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
                            
                            if ( $has_revision_column ) {
                                $valid_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                    "SELECT COUNT(*) FROM {$item_bids_table} 
                                     WHERE item_id = %d 
                                     AND status = 'submitted'
                                     AND rfq_revision_at_submit = %s",
                                    $item_id,
                                    $rfq_revision_current
                                ) ) );
                            } else {
                                $valid_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                    "SELECT COUNT(*) FROM {$item_bids_table} 
                                     WHERE item_id = %d 
                                     AND status = 'submitted'",
                                    $item_id
                                ) ) );
                            }
                        } else {
                            $valid_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                "SELECT COUNT(*) FROM {$item_bids_table} 
                                 WHERE item_id = %d 
                                 AND status = 'submitted'",
                                $item_id
                            ) ) );
                        }
                        
                        $bid_count = $valid_bid_count;
                        $has_bids = $valid_bid_count > 0;
                        
                        // Check if revision changed
                        $revision_changed = false;
                        if ( $has_rfq && isset( $item_meta['revision_changed'] ) ) {
                            $revision_changed = (bool) $item_meta['revision_changed'];
                        }
                        
                        // Check if there are stale bids (has_warning flag)
                        // Warning should show if there are bids with old revision or NULL revision
                        // Also check for withdrawn bids - if all bids are withdrawn, show Standby instead of RFQ Sent
                        $has_warning = false;
                        if ( $has_rfq && $has_bids && $rfq_revision_current !== null ) {
                            $bids_columns = $wpdb->get_col( "DESCRIBE {$item_bids_table}" );
                            $has_revision_column = in_array( 'rfq_revision_at_submit', $bids_columns, true );
                            
                            if ( $has_revision_column ) {
                                // Check if there are any stale bids (revision < current or NULL)
                                $stale_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                    "SELECT COUNT(*) FROM {$item_bids_table} 
                                     WHERE item_id = %d 
                                     AND status = 'submitted'
                                     AND (rfq_revision_at_submit IS NULL OR rfq_revision_at_submit < %d)",
                                    $item_id,
                                    $rfq_revision_current
                                ) ) );
                                
                                // Show warning only if there are stale bids
                                $has_warning = $stale_bid_count > 0;
                            }
                        }
                        
                        // If no valid bids but there are withdrawn bids, set has_warning to show Standby
                        if ( ! $has_bids && $has_rfq ) {
                            $withdrawn_bid_count = intval( $wpdb->get_var( $wpdb->prepare(
                                "SELECT COUNT(*) FROM {$item_bids_table} 
                                 WHERE item_id = %d 
                                 AND status = 'withdrawn'",
                                $item_id
                            ) ) );
                            
                            // If there are withdrawn bids but no submitted bids, show Standby
                            if ( $withdrawn_bid_count > 0 ) {
                                $has_warning = true;
                            }
                        }
                        
                        // Check award_set from item meta or status
                        $award_set = false;
                        if ( isset( $item_meta['award_set'] ) ) {
                            $award_set = (bool) $item_meta['award_set'];
                        } else if ( isset( $board_item->status ) && $board_item->status === 'awarded' ) {
                            $award_set = true;
                        }
                        
                        // Commit 2.4.1: Check if any bid is awarded for this item
                        // Check both bids table and item meta_json for awarded status
                        $has_awarded_bid = intval( $wpdb->get_var( $wpdb->prepare(
                            "SELECT COUNT(*) FROM {$item_bids_table} 
                             WHERE item_id = %d 
                             AND status = 'awarded'",
                            $item_id
                        ) ) ) > 0;
                        
                        // Also check item meta_json for awarded status (more reliable)
                        if ( ! $has_awarded_bid && isset( $item_meta['item_status'] ) && $item_meta['item_status'] === 'Awarded' ) {
                            $has_awarded_bid = true;
                        }
                        if ( ! $has_awarded_bid && isset( $item_meta['awarded_bid_snapshot'] ) ) {
                            $has_awarded_bid = true;
                        }
                        
                        // Check for unread operator messages (designer_operator thread)
                        // Action Required: Show when operator has sent messages that designer hasn't replied to
                        $messages_table = $wpdb->prefix . 'n88_item_messages';
                        $unread_operator_messages = 0;
                        $has_unread_operator_messages = false;
                        
                        // Check if messages table exists
                        $messages_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$messages_table}'" ) === $messages_table;
                        if ( $messages_table_exists ) {
                            // Count unread operator messages (operator messages with no designer reply after them)
                            $unread_operator_messages = intval( $wpdb->get_var( $wpdb->prepare(
                                "SELECT COUNT(DISTINCT m.message_id)
                                FROM {$messages_table} m
                                WHERE m.item_id = %d
                                AND m.thread_type = 'designer_operator'
                                AND m.sender_role = 'operator'
                                AND NOT EXISTS (
                                    SELECT 1 FROM {$messages_table} m2
                                    WHERE m2.item_id = m.item_id
                                    AND m2.thread_type = 'designer_operator'
                                    AND m2.sender_role = 'designer'
                                    AND m2.created_at > m.created_at
                                )",
                                $item_id
                            ) ) );
                            $has_unread_operator_messages = $unread_operator_messages > 0;
                            // Fix #13/#26: If operator marked resolved (designer thread), clear Action Required
                            if ( $has_unread_operator_messages ) {
                                $resolutions_table = $wpdb->prefix . 'n88_rfq_case_resolutions';
                                if ( $wpdb->get_var( "SHOW TABLES LIKE '{$resolutions_table}'" ) === $resolutions_table ) {
                                    $resolved = $wpdb->get_var( $wpdb->prepare(
                                        "SELECT 1 FROM {$resolutions_table} WHERE item_id = %d AND bid_id IS NULL LIMIT 1",
                                        $item_id
                                    ) );
                                    if ( $resolved ) {
                                        $has_unread_operator_messages = false;
                                        $unread_operator_messages = 0;
                                    }
                                }
                            }
                        }
                        
                        // Commit 2.3.9.1C: Check for prototype payment status
                        $prototype_payments_table = $wpdb->prefix . 'n88_prototype_payments';
                        $prototype_payment_status = null;
                        $has_prototype_payment = false;
                        
                        // Check if prototype payments table exists
                        $prototype_payments_table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$prototype_payments_table}'" ) === $prototype_payments_table;
                        if ( $prototype_payments_table_exists ) {
                            // Get the most recent prototype payment for this item and designer
                            $prototype_payment = $wpdb->get_row( $wpdb->prepare(
                                "SELECT status 
                                FROM {$prototype_payments_table}
                                WHERE item_id = %d
                                AND designer_user_id = %d
                                ORDER BY created_at DESC
                                LIMIT 1",
                                $item_id,
                                $current_user->ID
                            ), ARRAY_A );
                            
                            if ( $prototype_payment ) {
                                $has_prototype_payment = true;
                                $prototype_payment_status = $prototype_payment['status'];
                            }
                        }
                        
                        // Calculate position for new items - arrange in grid side-by-side
                        // Items will be arranged horizontally, wrapping to new rows as needed
                        $item_spacing = 20; // Space between items
                        $start_x = 20;
                        $start_y = 20;
                        $current_index = count( $items ); // Index of this new item
                        
                        // Calculate position based on actual item size
                        $item_width_for_spacing = $CARD_SIZES[ $default_size ]['w'];
                        $item_height_for_spacing = $CARD_SIZES[ $default_size ]['h'];
                        
                        // Calculate how many items can fit per row based on viewport width
                        // Use a reasonable viewport width (e.g., 1400px) for initial calculation
                        // Items will extend horizontally and scroll
                        $viewport_width = 1400; // Approximate viewport width
                        $available_width = $viewport_width - ( $start_x * 2 );
                        $items_per_row_calc = max( 1, floor( ( $available_width + $item_spacing ) / ( $item_width_for_spacing + $item_spacing ) ) );
                        
                        // Calculate row and column for this item
                        $row = intval( $current_index / $items_per_row_calc );
                        $col = $current_index % $items_per_row_calc;
                        
                        // Position items side-by-side in grid
                        $item_x = $start_x + ( $col * ( $item_width_for_spacing + $item_spacing ) );
                        $item_y = $start_y + ( $row * ( $item_height_for_spacing + $item_spacing ) );
                        
                        $items[] = array(
                            'id' => $item_id_string,
                            'x' => $item_x,
                            'y' => $item_y,
                            'z' => $z_index++,
                            'width' => $CARD_SIZES[ $default_size ]['w'],
                            'height' => $CARD_SIZES[ $default_size ]['h'],
                            'sizeKey' => $default_size,
                            'displayMode' => 'photo_only',
                            'title' => isset( $board_item->title ) ? wp_strip_all_tags( sanitize_text_field( $board_item->title ) ) : '',
                            'description' => isset( $board_item->description ) ? wp_strip_all_tags( sanitize_textarea_field( $board_item->description ) ) : '',
                            'item_type' => isset( $board_item->item_type ) ? sanitize_text_field( $board_item->item_type ) : '',
                            'imageUrl' => $image_url ? esc_url_raw( $image_url ) : '',
                            // Add item facts from meta_json
                            'dims' => $item_dims,
                            'dims_cm' => $item_dims_cm,
                            'cbm' => $item_cbm,
                            'sourcing_type' => $item_sourcing_type,
                            'timeline_type' => $item_timeline_type,
                            'inspiration' => $item_inspiration,
                            // Add quantity and notes from meta_json
                            'quantity' => $item_quantity,
                            'smart_alternatives_note' => $item_smart_alternatives_note,
                            'delivery_country' => $item_delivery_country,
                            'delivery_postal' => $item_delivery_postal,
                            'smart_alternatives' => $item_smart_alternatives,
                            // RFQ and bid status fields
                            'has_rfq' => $has_rfq,
                            'has_bids' => $has_bids,
                            'bid_count' => $bid_count,
                            'bids_count' => $bid_count,
                            'valid_bid_count' => $valid_bid_count,
                            'rfq_revision_current' => $rfq_revision_current,
                            'revision_changed' => $revision_changed,
                            'award_set' => $award_set,
                            'has_awarded_bid' => $has_awarded_bid, // Commit 2.4.1: Flag if any bid is awarded
                            // Action Required: Unread operator messages
                            'has_unread_operator_messages' => $has_unread_operator_messages,
                            'unread_operator_messages' => $unread_operator_messages,
                            // Commit 2.3.9.1C: Prototype payment status
                            'has_prototype_payment' => $has_prototype_payment,
                            'prototype_payment_status' => $prototype_payment_status,
                            // Also add meta object for backward compatibility
                            'meta' => $item_meta,
                        );
                        
                        error_log('Item ' . $item_id . ' - New item positioned at (' . $item_x . ', ' . $item_y . ') with size: ' . $default_size);
                        error_log('Item ' . $item_id . ' - Loaded quantity: ' . ( $item_quantity !== null ? $item_quantity : 'null' ) . ', notes: ' . substr( $item_smart_alternatives_note, 0, 50 ) );
                    }
                }
                
                // Debug: Log final items count
                error_log('Items array count after processing: ' . count( $items ));
                error_log('Board items count from database: ' . count( $board_items ));
                if ( count( $items ) !== count( $board_items ) ) {
                    error_log('WARNING: Items count mismatch! Board items: ' . count( $board_items ) . ', Items array: ' . count( $items ));
                    // Log which items are missing
                    $items_ids = array_map( function( $item ) {
                        return str_replace( 'item-', '', $item['id'] );
                    }, $items );
                    $board_items_ids = array_map( function( $board_item ) {
                        return $board_item->item_id;
                    }, $board_items );
                    $missing_ids = array_diff( $board_items_ids, $items_ids );
                    if ( ! empty( $missing_ids ) ) {
                        error_log('Missing item IDs: ' . implode( ', ', $missing_ids ) );
                    }
                }
            }
        }

        // Hardcoded 20 items seed data with image URLs (for demo mode)
        $image_urls = array(
            'https://dev.forgemetrix.com/wp-content/uploads/2025/12/image-14.jpg',
            'https://dev.forgemetrix.com/wp-content/uploads/2025/12/WechatIMG519.jpg',
            'https://dev.forgemetrix.com/wp-content/uploads/2025/12/WechatIMG518.jpg',
            'https://dev.forgemetrix.com/wp-content/uploads/2025/12/WechatIMG517.jpg',
        );
        // Image URL for first 4 items
        $first_four_image = 'https://dev.forgemetrix.com/wp-content/uploads/2025/12/2e1c4e1ad3b84c7a2b2e404ec941e5d5.jpeg';
        $seed_items = array(
            array( 'id' => 'item-1', 'x' => 50, 'y' => 50, 'z' => 1, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $first_four_image, 'item_type' => 'furniture', 'title' => 'Demo Chair 1', 'description' => 'Optional short note' ),
            array( 'id' => 'item-2', 'x' => 300, 'y' => 50, 'z' => 2, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $first_four_image, 'item_type' => 'furniture', 'title' => 'Demo Chair 2', 'description' => 'Optional short note' ),
            array( 'id' => 'item-3', 'x' => 550, 'y' => 50, 'z' => 3, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $first_four_image, 'item_type' => 'lighting', 'title' => 'Demo Lamp 1', 'description' => 'Optional short note' ),
            array( 'id' => 'item-4', 'x' => 800, 'y' => 50, 'z' => 4, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $first_four_image, 'item_type' => 'furniture', 'title' => 'Demo Chair 3', 'description' => 'Optional short note' ),
            array( 'id' => 'item-5', 'x' => 1050, 'y' => 50, 'z' => 5, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $image_urls[0] ),
            array( 'id' => 'item-6', 'x' => 50, 'y' => 350, 'z' => 6, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $image_urls[1] ),
            array( 'id' => 'item-7', 'x' => 300, 'y' => 350, 'z' => 7, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $image_urls[2] ),
            array( 'id' => 'item-8', 'x' => 550, 'y' => 350, 'z' => 8, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $image_urls[3] ),
            array( 'id' => 'item-9', 'x' => 800, 'y' => 350, 'z' => 9, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $image_urls[0] ),
            array( 'id' => 'item-10', 'x' => 1050, 'y' => 350, 'z' => 10, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $image_urls[1] ),
            array( 'id' => 'item-11', 'x' => 50, 'y' => 650, 'z' => 11, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $image_urls[2] ),
            array( 'id' => 'item-12', 'x' => 300, 'y' => 650, 'z' => 12, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $image_urls[3] ),
            array( 'id' => 'item-13', 'x' => 550, 'y' => 650, 'z' => 13, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $image_urls[0] ),
            array( 'id' => 'item-14', 'x' => 800, 'y' => 650, 'z' => 14, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $image_urls[1] ),
            array( 'id' => 'item-15', 'x' => 1050, 'y' => 650, 'z' => 15, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $image_urls[2] ),
            array( 'id' => 'item-16', 'x' => 50, 'y' => 950, 'z' => 16, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $image_urls[3] ),
            array( 'id' => 'item-17', 'x' => 300, 'y' => 950, 'z' => 17, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $image_urls[0] ),
            array( 'id' => 'item-18', 'x' => 550, 'y' => 950, 'z' => 18, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $image_urls[1] ),
            array( 'id' => 'item-19', 'x' => 800, 'y' => 950, 'z' => 19, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'photo_only', 'imageUrl' => $image_urls[2] ),
            array( 'id' => 'item-20', 'x' => 1050, 'y' => 950, 'z' => 20, 'width' => 200, 'height' => 250, 'sizeKey' => 'D', 'displayMode' => 'full', 'imageUrl' => $image_urls[3] ),
        );

        // Enqueue dependencies from CDN
        wp_enqueue_script( 'react', 'https://unpkg.com/react@18/umd/react.production.min.js', array(), '18.2.0', false );
        wp_enqueue_script( 'react-dom', 'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js', array( 'react' ), '18.2.0', false );
        wp_enqueue_script( 'framer-motion', 'https://unpkg.com/framer-motion@10/dist/framer-motion.js', array( 'react', 'react-dom' ), '10.16.0', false );
        // Use Zustand 3.x which has better UMD support
        // Load in footer to ensure React is available first
        wp_enqueue_script( 'zustand', 'https://unpkg.com/zustand@3.7.2/umd/index.production.js', array( 'react' ), '3.7.2', true );

        // Enqueue our store AFTER Zustand loads
        // Add cache busting and ensure proper load order
        $plugin_url = N88_RFQ_PLUGIN_URL;
        // Use version with timestamp for cache busting to ensure fresh load in new tabs
        $cache_buster = time();
        wp_enqueue_script( 'n88-board-store', $plugin_url . 'assets/js/stores/useBoardStore.js', array( 'zustand', 'react' ), N88_RFQ_VERSION . '.' . $cache_buster, true );
        
        // Milestone 1.3.5: Enqueue debounced save hook
        wp_enqueue_script( 'n88-debounced-save', $plugin_url . 'assets/js/hooks/useDebouncedSave.js', array( 'n88-board-store', 'react' ), N88_RFQ_VERSION . '.' . $cache_buster, true );
        
        // Note: JSX files are not enqueued - we use inline React.createElement code instead
        // This avoids ES6 module import errors in WordPress
        
        // Note: Resize-related global watchdog code has been removed in 1.3.6
        // Size presets (S/D/L/XL) replace free-form resize, eliminating stuck-state issues
        
        // Localize script for AJAX URL and nonce
        wp_localize_script( 'n88-debounced-save', 'n88BoardNonce', array(
            'nonce' => wp_create_nonce( 'n88-rfq-nonce' ), // Commit 2.3.9.1B: Fixed to match endpoint expectation
            'nonce_get_item_rfq_state' => wp_create_nonce( 'n88_get_item_rfq_state' ),
            'nonce_submit_rfq' => wp_create_nonce( 'n88_submit_rfq' ),
            'nonce_submit_supplier_bid' => wp_create_nonce( 'n88_submit_supplier_bid' ),
            'nonce_withdraw_supplier_bid' => wp_create_nonce( 'n88_withdraw_supplier_bid' ),
            'nonce_get_supplier_item_details' => wp_create_nonce( 'n88_get_supplier_item_details' ),
            'nonce_get_keywords' => wp_create_nonce( 'n88_get_keywords' ), // Commit 2.3.9.1B: For CAD prototype keyword selection
            // Commit 2.3.9.1C-a: Item Messages nonces
            'nonce_get_item_messages' => wp_create_nonce( 'n88_get_item_messages' ),
            'nonce_send_item_message' => wp_create_nonce( 'n88_send_item_message' ),
            // Commit 2.3.9.2A: CAD workflow v1 nonces (designer actions)
            'nonce_request_cad_revision' => wp_create_nonce( 'n88_request_cad_revision' ),
            'nonce_approve_cad' => wp_create_nonce( 'n88_approve_cad' ),
            // Commit 2.3.9.2B-D: Prototype review nonces
            'nonce_get_keyword_phrases' => wp_create_nonce( 'n88_get_keyword_phrases' ),
            'nonce_approve_prototype' => wp_create_nonce( 'n88_approve_prototype' ),
            'nonce_request_prototype_changes' => wp_create_nonce( 'n88_request_prototype_changes' ),
            // Commit 2.4.1: Award bid nonce
            'nonce_award_bid' => wp_create_nonce( 'n88_award_bid' ),
            // Commit 2.6.1: Invite team member nonce
            'nonce_invite_team_member' => wp_create_nonce( 'n88_invite_team_member' ),
            // Payment receipt (designer upload JPG/PDF in Payment Instructions modal)
            'nonce_upload_payment_receipt' => wp_create_nonce( 'n88_upload_payment_receipt' ),
            'nonce_get_payment_receipts' => wp_create_nonce( 'n88_get_payment_receipts' ),
        ) );
        
        // Commit 2.6.1: Check if current user is view-only team member
        $is_view_only = N88_RFQ_Auth::is_view_only_team_member( $user_id );
        
        // Localize script for board data (AJAX URL and nonce for item modal)
        wp_localize_script( 'n88-debounced-save', 'n88BoardData', array(
            'ajaxUrl' => admin_url( 'admin-ajax.php' ),
            'nonce' => wp_create_nonce( 'n88_get_item_rfq_state' ),
            'boardName' => $board_name,
            'isViewOnly' => $is_view_only, // Commit 2.6.1: View-only flag for team members
        ) );
        ?>
        <style>
            /* Hide sidebar menu for designer board page */
            body.n88-board-page #adminmenuwrap,
            body.n88-board-page #adminmenuback,
            body.n88-board-page #adminmenu {
                display: none !important;
            }
            
            body.n88-board-page #wpcontent {
                margin-left: 0px !important;
            }
            #wpcontent{
                margin-left: 0px !important;
            }
            /* Prevent body scrolling - board is fixed workspace */
            body.n88-board-page {
                overflow: hidden !important;
                height: 100vh !important;
            }
            
            /* K) Forceful scroll lock when modal is open */
            body.n88-modal-open,
            html.n88-modal-open {
                overflow: hidden !important;
                height: 100% !important;
                position: fixed !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            body.n88-modal-open #n88-board-canvas-container,
            body.n88-modal-open #wpcontent,
            body.n88-modal-open #wpbody-content,
            body.n88-modal-open .wrap {
                overflow: hidden !important;
                position: fixed !important;
            }
            
            /* Remove page scrollbar - only canvas should scroll */
            body.n88-board-page #wpcontent,
            body.n88-board-page #wpbody-content,
            body.n88-board-page .wrap {
                overflow: hidden !important;
                height: 100vh !important;
            }
            
            /* Sticky header - behind modal when modal is open */
            #n88-board-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background-color: #fff;
                z-index: 1000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            /* K) Modal should cover full page height, header visible behind */
            body.n88-modal-open #n88-board-header {
                z-index: 999999 !important; /* Behind modal (modal is 10000000) */
            }
            
            /* K) Ensure modal covers full viewport height from top to bottom */
            body.n88-modal-open [style*="z-index: 10000000"] {
                top: 0 !important;
                bottom: 0 !important;
                height: 100vh !important;
                min-height: 100vh !important;
                max-height: 100vh !important;
            }
            
            /* K) Hide scrollbar inside modal but keep scrolling functionality */
            .n88-modal-scroll-content {
                scrollbar-width: none !important; /* Firefox */
                -ms-overflow-style: none !important; /* IE/Edge */
            }
            
            .n88-modal-scroll-content::-webkit-scrollbar {
                display: none !important; /* Chrome/Safari */
                width: 0 !important;
                height: 0 !important;
            }
            
            /* Board canvas container - relative positioning with proper scrolling */
            #n88-board-canvas-container {
                position: relative !important;
                top: 180px !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                overflow-x: hidden !important;
                overflow-y: auto !important;
                background-color: #f5f5f5 !important;
                z-index: 1 !important;
                width: 100% !important;
                height: calc(100vh - 200px) !important;
                scroll-behavior: smooth !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* Fix 2: Add extra top spacing when project is selected (rooms section visible) */
            body.n88-board-page.has-project-selected #n88-board-canvas-container {
                top: 290px !important;
                height: calc(100vh - 300px) !important;
            }
            
            /* Board canvas root - expands to fit all items */
            #n88-board-demo-root {
                position: relative !important;
                min-width: 100% !important;
                min-height: 100% !important;
                width: 100% !important;
                height: 100% !important;
                overflow: visible !important;
                display: block !important;
            }
            
            /* Ensure the React-rendered canvas div is visible */
            #n88-board-demo-root > div {
                position: relative !important;
                overflow: visible !important;
                width: 100% !important;
                min-height: 100% !important;
                height: 100% !important;
                display: block !important;
                visibility: visible !important;
            }
            
            /* Prevent page scroll when interacting with board items */
            #n88-board-canvas-container * {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Prevent body scroll when clicking items */
            body.n88-board-page {
                overflow-y: auto !important;
            }
            
            /* Prevent auto-scroll on item click - items should not cause page scroll */
            #n88-board-demo-root [style*="position: absolute"],
            #n88-board-demo-root [style*="position:absolute"] {
                touch-action: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Ensure items are part of canvas and don't trigger page scroll */
            #n88-board-canvas-container {
                contain: layout style paint;
            }
        </style>
        
        <div class="wrap">
            <!-- Sticky Header -->
            <div id="n88-board-header">
            <!-- Top Bar -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #ddd;">
                <div style="font-size: 16px; font-weight: 500; color: #333;">
                        WireFrame OS / Workspace
                </div>
                <div style="position: relative;">
                    <div id="n88-profile-dropdown-trigger" style="font-size: 14px; color: #666; cursor: pointer; padding: 6px 12px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f0f0';" onmouseout="this.style.backgroundColor='transparent';">
                        <?php echo esc_html( $current_user->display_name ); ?> ▼
                    </div>
                        <div id="n88-profile-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 150px; z-index: 1001;">
                        <a href="<?php echo esc_url( wp_logout_url( home_url( '/login/' ) ) ); ?>" style="display: block; padding: 10px 16px; color: #dc3545; text-decoration: none; font-size: 14px;" onmouseover="this.style.backgroundColor='#f8f8f8';" onmouseout="this.style.backgroundColor='transparent';">
                            Logout
                        </a>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs Row - Project dropdown and search left-aligned after Firm Board -->
                <div style="display: flex; align-items: center; gap: 20px; padding: 10px 20px; border-bottom: 1px solid #ddd;">
                    <?php
                    // Check if current user owns the board being viewed
                    $is_own_board = false;
                    if ( $is_real_board && isset( $board ) && isset( $board->owner_user_id ) ) {
                        $is_own_board = ( intval( $board->owner_user_id ) === intval( $user_id ) );
                    }
                    // Determine active button:
                    // - If viewing own board: "My Board" is active
                    // - If viewing owner's board (team member): "Firm Board (View-Only)" is active
                    // - If demo board: "My Board" is active by default
                    $my_board_active = $is_own_board || ! $is_real_board;
                    $firm_board_active = ! $is_own_board && $is_real_board;
                    ?>
                    <span style="margin-right: 10px; padding: 8px 15px; background-color: <?php echo $my_board_active ? '#0073aa' : '#f0f0f0'; ?>; color: <?php echo $my_board_active ? '#fff' : '#666'; ?>; border-radius: 4px; font-size: 14px; cursor: pointer;">
                        My Board
                    </span>
                    <span style="margin-right: 10px; padding: 8px 15px; background-color: <?php echo $firm_board_active ? '#0073aa' : '#f0f0f0'; ?>; color: <?php echo $firm_board_active ? '#fff' : '#666'; ?>; border-radius: 4px; font-size: 14px; cursor: pointer;">
                        Firm Board (View-Only)
                    </span>
                    <!-- K) Project dropdown and search left-aligned right after Firm Board -->
                    <div style="display: flex; align-items: center; gap: 10px; margin-left: 10px;">
                        <span style="font-size: 14px; color: #666;">Project:</span>
                        <select id="n88-project-selector" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-width: 200px; cursor: pointer;">
                            <option value="">All Items (No Project)</option>
                            <?php
                            // Load projects for this board
                            if ( $is_real_board && isset( $board_id ) && $board_id > 0 ) {
                                global $wpdb;
                                $projects_table = $wpdb->prefix . 'n88_projects';
                                
                                // Check if table exists
                                $table_exists = $wpdb->get_var( $wpdb->prepare( "SHOW TABLES LIKE %s", $projects_table ) ) === $projects_table;
                                
                                if ( $table_exists ) {
                                    $projects = $wpdb->get_results(
                                        $wpdb->prepare(
                                            "SELECT id, name, status FROM {$projects_table}
                                             WHERE board_id = %d AND deleted_at IS NULL
                                             ORDER BY created_at ASC",
                                            $board_id
                                        ),
                                        OBJECT
                                    );
                                    
                                    // Debug: Log if no projects found
                                    if ( empty( $projects ) ) {
                                        error_log( 'N88 Projects: No projects found for board_id=' . $board_id );
                                    } else {
                                        error_log( 'N88 Projects: Found ' . count( $projects ) . ' projects for board_id=' . $board_id );
                                    }
                                    
                                    if ( $projects && count( $projects ) > 0 ) {
                                        foreach ( $projects as $project ) {
                                            $selected = isset( $_GET['project_id'] ) && intval( $_GET['project_id'] ) === intval( $project->id ) ? 'selected' : '';
                                            echo '<option value="' . esc_attr( $project->id ) . '" ' . $selected . '>' . esc_html( $project->name ) . '</option>';
                                        }
                                    }
                                } else {
                                    error_log( 'N88 Projects: Table does not exist: ' . $projects_table );
                                }
                            } else {
                                error_log( 'N88 Projects: Conditions not met - is_real_board=' . ( $is_real_board ? 'true' : 'false' ) . ', board_id=' . ( isset( $board_id ) ? $board_id : 'not set' ) );
                            }
                            ?>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 14px; color: #666;">Search:</span>
                        <input type="text" id="n88-board-search" placeholder="Search items…" style="width: 300px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>
                </div>
                
                <!-- K) Controls Row - Create Project and Add Item buttons left-aligned -->
                <div style="display: flex; align-items: center; gap: 10px; padding: 15px 20px; border-bottom: 1px solid #ddd;">
                    <?php 
                    // Commit 2.6.1: Check if user is view-only team member
                    $is_view_only_team = N88_RFQ_Auth::is_view_only_team_member( $user_id );
                    // Hide buttons if: user is view-only team member OR viewing someone else's board (not their own)
                    $should_hide_buttons = $is_view_only_team || ( $is_real_board && ! $is_own_board );
                    ?>
                    <?php if ( ! $should_hide_buttons ) : ?>
                        <button id="n88-create-project-btn" style="padding: 8px 16px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 500;">
                            + Create Project
                        </button>
                        <?php if ( $is_real_board ) : ?>
                            <a href="<?php echo esc_url( admin_url( 'admin.php?page=n88-rfq-items-boards-test' ) ); ?>" 
                               style="padding: 8px 16px; background-color: #000; color: #fff; text-decoration: none; border: none; border-radius: 4px; font-size: 14px; display: inline-block; font-weight: 500;">
                                + Add Item
                            </a>
                            <!-- Commit 2.6.1: Invite Team Member Button -->
                            <button id="n88-invite-team-member-btn" style="padding: 8px 16px; background-color: #4caf50; color: #fff; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 500;">
                                + Invite Team Member
                            </button>
                        <?php endif; ?>
                    <?php else : ?>
                        <span style="padding: 8px 16px; color: #666; font-size: 14px; font-weight: 500;">View-Only Mode</span>
                    <?php endif; ?>
                </div>
                
                <!-- Commit 2.5.2: Rooms Section (shown when project is selected) -->
                <?php
                $selected_project_id = isset( $_GET['project_id'] ) ? absint( $_GET['project_id'] ) : 0;
                $project_rooms = array();
                if ( $selected_project_id > 0 && $is_real_board ) {
                    global $wpdb;
                    $rooms_table = $wpdb->prefix . 'n88_project_rooms';
                    $project_rooms = $wpdb->get_results(
                        $wpdb->prepare(
                            "SELECT id, name, description, display_order
                             FROM {$rooms_table}
                             WHERE project_id = %d AND deleted_at IS NULL
                             ORDER BY display_order ASC, created_at ASC",
                            $selected_project_id
                        ),
                        ARRAY_A
                    );
                }
                ?>
                <?php if ( $selected_project_id > 0 && ! $should_hide_buttons ) : ?>
                <div id="n88-rooms-section" style="padding: 15px 20px; border-bottom: 1px solid #ddd; background-color: #f9f9f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #333;">Rooms</h3>
                        <button id="n88-create-room-btn" style="padding: 6px 12px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
                            + Add Room
                        </button>
                    </div>
                    <!-- Fix 3: Rooms as switchable tabs -->
                    <?php
                    $selected_room_id = isset( $_GET['room_id'] ) ? absint( $_GET['room_id'] ) : 0;
                    $all_items_active = $selected_room_id === 0 ? 'background-color: #0073aa; color: #fff;' : 'background-color: #f0f0f0; color: #666;';
                    ?>
                    <div id="n88-rooms-tabs" style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                        <button class="n88-room-tab" data-room-id="0" style="padding: 8px 16px; <?php echo $all_items_active; ?> border: none; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">
                            All Items
                        </button>
                        <?php if ( ! empty( $project_rooms ) ) : ?>
                            <?php foreach ( $project_rooms as $room ) : ?>
                                <?php
                                $room_active = ( $selected_room_id > 0 && intval( $selected_room_id ) === intval( $room['id'] ) ) ? 'background-color: #0073aa; color: #fff;' : 'background-color: #f0f0f0; color: #666;';
                                ?>
                                <button class="n88-room-tab" data-room-id="<?php echo esc_attr( $room['id'] ); ?>" style="padding: 8px 16px; <?php echo $room_active; ?> border: none; border-radius: 4px; font-size: 13px; cursor: pointer; position: relative;">
                                    <span class="n88-room-name"><?php echo esc_html( $room['name'] ); ?></span>
                                    <span class="n88-room-actions" style="margin-left: 8px; display: inline-flex; gap: 4px;">
                                        <button class="n88-edit-room-btn" data-room-id="<?php echo esc_attr( $room['id'] ); ?>" data-room-name="<?php echo esc_attr( $room['name'] ); ?>" style="padding: 2px 6px; background: #fff; border: 1px solid #ddd; border-radius: 2px; cursor: pointer; font-size: 10px;" title="Edit">✎</button>
                                        <button class="n88-delete-room-btn" data-room-id="<?php echo esc_attr( $room['id'] ); ?>" style="padding: 2px 6px; background: #ff4444; color: #fff; border: none; border-radius: 2px; cursor: pointer; font-size: 10px;" title="Delete">×</button>
                                    </span>
                                </button>
                            <?php endforeach; ?>
                        <?php else : ?>
                            <p style="color: #666; font-size: 14px; margin: 0; width: 100%;">No rooms yet. Click "+ Add Room" to create one.</p>
                        <?php endif; ?>
                    </div>
                </div>
                <?php endif; ?>
            </div>
            
            <script>
            (function() {
                // Fix 2: Add body class when project is selected (for top spacing)
                var urlParams = new URLSearchParams(window.location.search);
                var projectId = urlParams.get('project_id');
                if (projectId && projectId !== '0') {
                    document.body.classList.add('has-project-selected');
                }
                
                var trigger = document.getElementById('n88-profile-dropdown-trigger');
                var dropdown = document.getElementById('n88-profile-dropdown');
                
                if (trigger && dropdown) {
                    trigger.addEventListener('click', function(e) {
                        e.stopPropagation();
                        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', function(e) {
                        if (!trigger.contains(e.target) && !dropdown.contains(e.target)) {
                            dropdown.style.display = 'none';
                        }
                    });
                }
                
                // Commit 2.5.2: Create Project button handler
                var createProjectBtn = document.getElementById('n88-create-project-btn');
                if (createProjectBtn) {
                    createProjectBtn.addEventListener('click', function() {
                        var projectName = prompt('Enter project name:');
                        if (!projectName || !projectName.trim()) {
                            return;
                        }
                        
                        projectName = projectName.trim();
                        
                        // Get nonce and board_id
                        var nonce = '';
                        if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                            nonce = window.n88BoardNonce.nonce;
                        } else if (window.n88BoardData && window.n88BoardData.nonce) {
                            nonce = window.n88BoardData.nonce;
                        }
                        
                        if (!nonce) {
                            alert('Security token missing. Please refresh the page and try again.');
                            return;
                        }
                        
                        // Get board_id from URL
                        var urlParams = new URLSearchParams(window.location.search);
                        var boardId = urlParams.get('board_id') || 0;
                        
                        if (!boardId || boardId === '0') {
                            alert('Board ID not found. Please refresh the page and try again.');
                            return;
                        }
                        
                        // Disable button during request
                        createProjectBtn.disabled = true;
                        createProjectBtn.textContent = 'Creating...';
                        
                        var formData = new FormData();
                        formData.append('action', 'n88_create_board_project');
                        formData.append('board_id', boardId);
                        formData.append('name', projectName);
                        formData.append('_ajax_nonce', nonce);
                        
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            createProjectBtn.disabled = false;
                            createProjectBtn.textContent = '+ Create Project';
                            
                            if (data.success) {
                                alert('Project created successfully!');
                                // Redirect to the new project board (same board_id + project_id) when user clicks OK
                                var newProjectId = data.data && data.data.project_id ? data.data.project_id : null;
                                if (newProjectId) {
                                    var cur = new URLSearchParams(window.location.search);
                                    cur.set('project_id', String(newProjectId));
                                    cur.delete('room_id');
                                    window.location.search = cur.toString();
                                } else {
                                    window.location.reload();
                                }
                            } else {
                                alert('Error: ' + (data.data.message || 'Failed to create project'));
                            }
                        })
                        .catch(function(error) {
                            createProjectBtn.disabled = false;
                            createProjectBtn.textContent = '+ Create Project';
                            console.error('Error creating project:', error);
                            alert('An error occurred. Please try again.');
                        });
                    });
                }
                
                // Commit 2.5.2: Project selector change handler
                var projectSelector = document.getElementById('n88-project-selector');
                if (projectSelector) {
                    projectSelector.addEventListener('change', function() {
                        var projectId = this.value;
                        var urlParams = new URLSearchParams(window.location.search);
                        
                        if (projectId) {
                            urlParams.set('project_id', projectId);
                            // Remove room_id when switching projects
                            urlParams.delete('room_id');
                            // Add body class for spacing
                            document.body.classList.add('has-project-selected');
                        } else {
                            urlParams.delete('project_id');
                            urlParams.delete('room_id');
                            // Remove body class
                            document.body.classList.remove('has-project-selected');
                        }
                        
                        // Reload page with project filter
                        window.location.search = urlParams.toString();
                    });
                }
                
                // Fix 3: Room tab switching handler
                var roomTabs = document.querySelectorAll('.n88-room-tab');
                roomTabs.forEach(function(tab) {
                    tab.addEventListener('click', function(e) {
                        // Don't trigger if clicking edit/delete buttons
                        if (e.target.classList.contains('n88-edit-room-btn') || e.target.classList.contains('n88-delete-room-btn')) {
                            return;
                        }
                        
                        var roomId = this.getAttribute('data-room-id');
                        var urlParams = new URLSearchParams(window.location.search);
                        
                        // Update active tab styling
                        roomTabs.forEach(function(t) {
                            if (t.getAttribute('data-room-id') === roomId) {
                                t.style.backgroundColor = '#0073aa';
                                t.style.color = '#fff';
                            } else {
                                t.style.backgroundColor = '#f0f0f0';
                                t.style.color = '#666';
                            }
                        });
                        
                        // Update URL with room filter
                        if (roomId && roomId !== '0') {
                            urlParams.set('room_id', roomId);
                        } else {
                            urlParams.delete('room_id');
                        }
                        
                        // Reload page with room filter
                        window.location.search = urlParams.toString();
                    });
                });
                
                // Set active room tab on page load
                var urlParams = new URLSearchParams(window.location.search);
                var selectedRoomId = urlParams.get('room_id') || '0';
                roomTabs.forEach(function(tab) {
                    var tabRoomId = tab.getAttribute('data-room-id');
                    if (tabRoomId === selectedRoomId) {
                        tab.style.backgroundColor = '#0073aa';
                        tab.style.color = '#fff';
                    } else {
                        tab.style.backgroundColor = '#f0f0f0';
                        tab.style.color = '#666';
                    }
                });
                
                // Commit 2.5.2: Rooms Management Handlers
                var createRoomBtn = document.getElementById('n88-create-room-btn');
                if (createRoomBtn) {
                    createRoomBtn.addEventListener('click', function() {
                        var roomName = prompt('Enter room name (e.g., Bedroom, Kitchen, Living Room):');
                        if (!roomName || !roomName.trim()) {
                            return;
                        }
                        
                        roomName = roomName.trim();
                        
                        // Get nonce and project_id
                        var nonce = '';
                        if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                            nonce = window.n88BoardNonce.nonce;
                        } else if (window.n88BoardData && window.n88BoardData.nonce) {
                            nonce = window.n88BoardData.nonce;
                        }
                        
                        if (!nonce) {
                            alert('Security token missing. Please refresh the page and try again.');
                            return;
                        }
                        
                        var urlParams = new URLSearchParams(window.location.search);
                        var projectId = urlParams.get('project_id') || 0;
                        
                        if (!projectId || projectId === '0') {
                            alert('Please select a project first.');
                            return;
                        }
                        
                        // Disable button during request
                        createRoomBtn.disabled = true;
                        createRoomBtn.textContent = 'Creating...';
                        
                        var formData = new FormData();
                        formData.append('action', 'n88_create_project_room');
                        formData.append('project_id', projectId);
                        formData.append('name', roomName);
                        formData.append('_ajax_nonce', nonce);
                        
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            createRoomBtn.disabled = false;
                            createRoomBtn.textContent = '+ Add Room';
                            
                            if (data.success) {
                                alert('Room created successfully!');
                                // Redirect to the new room (keep board_id, project_id; set room_id) when user clicks OK
                                var newRoomId = data.data && data.data.room_id ? data.data.room_id : null;
                                if (newRoomId) {
                                    var cur = new URLSearchParams(window.location.search);
                                    cur.set('room_id', String(newRoomId));
                                    window.location.search = cur.toString();
                                } else {
                                    window.location.reload();
                                }
                            } else {
                                alert('Error: ' + (data.data.message || 'Failed to create room'));
                            }
                        })
                        .catch(function(error) {
                            createRoomBtn.disabled = false;
                            createRoomBtn.textContent = '+ Add Room';
                            console.error('Error creating room:', error);
                            alert('An error occurred. Please try again.');
                        });
                    });
                }
                
                // Edit Room handlers
                var editRoomBtns = document.querySelectorAll('.n88-edit-room-btn');
                editRoomBtns.forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var roomId = this.getAttribute('data-room-id');
                        var currentName = this.getAttribute('data-room-name');
                        var newName = prompt('Enter new room name:', currentName);
                        
                        if (!newName || !newName.trim() || newName === currentName) {
                            return;
                        }
                        
                        newName = newName.trim();
                        
                        // Get nonce
                        var nonce = '';
                        if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                            nonce = window.n88BoardNonce.nonce;
                        } else if (window.n88BoardData && window.n88BoardData.nonce) {
                            nonce = window.n88BoardData.nonce;
                        }
                        
                        if (!nonce) {
                            alert('Security token missing. Please refresh the page and try again.');
                            return;
                        }
                        
                        var formData = new FormData();
                        formData.append('action', 'n88_update_project_room');
                        formData.append('room_id', roomId);
                        formData.append('name', newName);
                        formData.append('_ajax_nonce', nonce);
                        
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.success) {
                                alert('Room updated successfully!');
                                window.location.reload();
                            } else {
                                alert('Error: ' + (data.data.message || 'Failed to update room'));
                            }
                        })
                        .catch(function(error) {
                            console.error('Error updating room:', error);
                            alert('An error occurred. Please try again.');
                        });
                    });
                });
                
                // Delete Room handlers
                var deleteRoomBtns = document.querySelectorAll('.n88-delete-room-btn');
                deleteRoomBtns.forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var roomId = this.getAttribute('data-room-id');
                        
                        if (!confirm('Are you sure you want to delete this room? Items in this room will not be deleted, but they will be unassigned from the room.')) {
                            return;
                        }
                        
                        // Get nonce
                        var nonce = '';
                        if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                            nonce = window.n88BoardNonce.nonce;
                        } else if (window.n88BoardData && window.n88BoardData.nonce) {
                            nonce = window.n88BoardData.nonce;
                        }
                        
                        if (!nonce) {
                            alert('Security token missing. Please refresh the page and try again.');
                            return;
                        }
                        
                        var formData = new FormData();
                        formData.append('action', 'n88_delete_project_room');
                        formData.append('room_id', roomId);
                        formData.append('_ajax_nonce', nonce);
                        
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.success) {
                                alert('Room deleted successfully!');
                                window.location.reload();
                            } else {
                                alert('Error: ' + (data.data.message || 'Failed to delete room'));
                            }
                        })
                        .catch(function(error) {
                            console.error('Error deleting room:', error);
                            alert('An error occurred. Please try again.');
                        });
                    });
                });
                
                // Commit 2.6.1: Invite Team Member button handler
                var inviteTeamMemberBtn = document.getElementById('n88-invite-team-member-btn');
                if (inviteTeamMemberBtn) {
                    inviteTeamMemberBtn.addEventListener('click', function() {
                        var email = prompt('Enter email address to invite:');
                        if (!email || !email.trim()) {
                            return;
                        }
                        
                        email = email.trim();
                        
                        // Basic email validation
                        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            alert('Please enter a valid email address.');
                            return;
                        }
                        
                        // Get nonce
                        var nonce = '';
                        if (window.n88BoardNonce && window.n88BoardNonce.nonce_invite_team_member) {
                            nonce = window.n88BoardNonce.nonce_invite_team_member;
                        } else if (window.n88BoardData && window.n88BoardData.nonce) {
                            nonce = window.n88BoardData.nonce;
                        }
                        
                        if (!nonce) {
                            alert('Security token missing. Please refresh the page and try again.');
                            return;
                        }
                        
                        // Disable button during request
                        inviteTeamMemberBtn.disabled = true;
                        inviteTeamMemberBtn.textContent = 'Sending...';
                        
                        var formData = new FormData();
                        formData.append('action', 'n88_invite_team_member');
                        formData.append('email', email);
                        formData.append('_ajax_nonce', nonce);
                        
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            inviteTeamMemberBtn.disabled = false;
                            inviteTeamMemberBtn.textContent = '+ Invite Team Member';
                            
                            if (data.success) {
                                alert('Invitation sent successfully to ' + email + '!');
                            } else {
                                alert('Error: ' + (data.data && data.data.message ? data.data.message : 'Failed to send invitation.'));
                            }
                        })
                        .catch(function(error) {
                            inviteTeamMemberBtn.disabled = false;
                            inviteTeamMemberBtn.textContent = '+ Invite Team Member';
                            console.error('Error inviting team member:', error);
                            alert('Error sending invitation. Please try again.');
                        });
                    });
                }
                
                // Add body class to prevent scrolling
                if (document.body) {
                    document.body.classList.add('n88-board-page');
                }
                
                // SIMPLE: Just prevent focus from causing scroll - this is the main issue
                var canvasContainer = document.getElementById('n88-board-canvas-container');
                if (canvasContainer) {
                    // CRITICAL: Prevent focus from scrolling - buttons/inputs cause scroll jumps
                    canvasContainer.addEventListener('focusin', function(e) {
                        // Prevent any focus from causing scroll
                        e.preventDefault();
                        e.stopPropagation();
                    }, true);
                    
                    // Prevent wheel events from scrolling page when over canvas
                    canvasContainer.addEventListener('wheel', function(e) {
                        var isAtTop = canvasContainer.scrollTop <= 0;
                        var isAtBottom = canvasContainer.scrollTop >= canvasContainer.scrollHeight - canvasContainer.clientHeight - 1;
                        
                        if (!isAtTop && !isAtBottom) {
                            e.stopPropagation();
                        }
                    }, { passive: false });
                }
                
                // Completely disable page scroll - only canvas should scroll
                window.addEventListener('scroll', function(e) {
                    // Prevent page scroll, only allow canvas scroll
                    if (window.pageYOffset > 0) {
                        window.scrollTo(0, 0);
                    }
                }, { passive: false });
                
                // Lock page scroll on load
                setTimeout(function() {
                    window.scrollTo(0, 0);
                    document.documentElement.scrollTop = 0;
                    document.body.scrollTop = 0;
                }, 100);
            })();
            </script>
            
            <!-- Board Canvas Container - Fixed height, horizontal scroll only -->
            <div id="n88-board-canvas-container">
                <div id="n88-board-demo-root"></div>
            </div>
            
            <script>
            // Ensure board container expands to fit all items horizontally
            (function() {
                function updateBoardContainerWidth() {
                    var container = document.getElementById('n88-board-canvas-container');
                    var root = document.getElementById('n88-board-demo-root');
                    if (!container || !root) {
                        console.log('Board container or root not found');
                        return;
                    }
                    
                    // Wait for items to render, then calculate max width
                    setTimeout(function() {
                        // Try multiple selectors to find items
                        var items = root.querySelectorAll('[style*="position: absolute"], [style*="position:absolute"]');
                        if (items.length === 0) {
                            // Try finding items by checking all children
                            var allChildren = root.querySelectorAll('*');
                            items = Array.from(allChildren).filter(function(el) {
                                var style = window.getComputedStyle(el);
                                return style.position === 'absolute';
                            });
                        }
                        
                        console.log('Found items for width calculation:', items.length);
                        
                        var maxX = 0;
                        var maxY = 0;
                        
                        items.forEach(function(item) {
                            var style = window.getComputedStyle(item);
                            var left = parseFloat(style.left) || 0;
                            var top = parseFloat(style.top) || 0;
                            var width = parseFloat(style.width) || 0;
                            var height = parseFloat(style.height) || 0;
                            var totalX = left + width;
                            var totalY = top + height;
                            if (totalX > maxX) {
                                maxX = totalX;
                            }
                            if (totalY > maxY) {
                                maxY = totalY;
                            }
                        });
                        
                        // Set minimum width and height to accommodate all items with padding
                        if (maxX > 0) {
                            root.style.minWidth = Math.max(maxX + 100, window.innerWidth) + 'px';
                            console.log('Set root minWidth to:', root.style.minWidth);
                        }
                        if (maxY > 0) {
                            root.style.minHeight = Math.max(maxY + 100, window.innerHeight - 200) + 'px';
                            console.log('Set root minHeight to:', root.style.minHeight);
                        }
                    }, 1500); // Wait 1.5 seconds for React to render items
                }
                
                // Run on load and after a delay to catch React-rendered items
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', updateBoardContainerWidth);
                } else {
                    updateBoardContainerWidth();
                }
                
                // Also run after React renders (check periodically)
                var checkInterval = setInterval(function() {
                    var root = document.getElementById('n88-board-demo-root');
                    var container = document.getElementById('n88-board-canvas-container');
                    if (root && container) {
                        var hasChildren = root.children.length > 0;
                        var hasAbsoluteItems = root.querySelectorAll('[style*="position: absolute"], [style*="position:absolute"], [style*="transform"]').length > 0;
                        
                        console.log('Checking board render - children:', root.children.length, 'absolute items:', hasAbsoluteItems);
                        
                        if (hasChildren || hasAbsoluteItems) {
                            updateBoardContainerWidth();
                            clearInterval(checkInterval);
                            
                            // Debug: Log container and root dimensions
                            console.log('Container dimensions:', {
                                width: container.offsetWidth,
                                height: container.offsetHeight,
                                scrollWidth: container.scrollWidth,
                                scrollHeight: container.scrollHeight
                            });
                            console.log('Root dimensions:', {
                                width: root.offsetWidth,
                                height: root.offsetHeight,
                                scrollWidth: root.scrollWidth,
                                scrollHeight: root.scrollHeight
                            });
                        }
                    }
                }, 500);
                
                // Clear interval after 15 seconds
                setTimeout(function() {
                    clearInterval(checkInterval);
                }, 15000);
                
            })();
            </script>
            
            <?php if ( isset( $_GET['item_added'] ) && $_GET['item_added'] == '1' ) : ?>
                <div id="n88-item-added-toast" class="notice notice-success is-dismissible" style="margin: 20px 0; position: relative;">
                    <p><strong>✓ Item added successfully!</strong> The item has been added to your board.</p>
                </div>
                <script>
                // Auto-dismiss toast after 5 seconds
                setTimeout(function() {
                    var toast = document.getElementById('n88-item-added-toast');
                    if (toast) {
                        toast.style.transition = 'opacity 0.5s';
                        toast.style.opacity = '0';
                        setTimeout(function() {
                            toast.remove();
                            // Remove item_added parameter from URL without reload
                            if (window.history && window.history.replaceState) {
                                var url = new URL(window.location);
                                url.searchParams.delete('item_added');
                                window.history.replaceState({}, '', url);
                            }
                        }, 500);
                    }
                }, 5000);
                </script>
            <?php endif; ?>
            
            <!-- Board Canvas Container - Fixed height, horizontal scroll only -->
            <div id="n88-board-canvas-container">
            <div id="n88-board-demo-root"></div>
            </div>
            <div id="n88-board-demo-debug" style="position: fixed; bottom: 10px; right: 10px; background: #fff; padding: 10px; border: 1px solid #ccc; z-index: 9999; font-size: 12px; max-width: 300px;">
                <div>Loading...</div>
            </div>
        </div>
        <!-- Verify Zustand loads correctly -->
        <script>
        console.log('Checking Zustand before store loads...');
        if (typeof window.zustand !== 'undefined') {
            console.log('Zustand found:', window.zustand);
            console.log('Zustand keys:', Object.keys(window.zustand));
        } else {
            console.warn('Zustand not found yet, will check again after scripts load');
        }
        </script>
        <!-- Commit 2.3.4: RFQ Submission Modal - Define function GLOBALLY before React loads -->
        <script>
        // Define the function GLOBALLY immediately (BEFORE React components load)
        // This MUST be defined outside any IIFE and before React renders
        (function() {
            // Create modal HTML
            var modalHTML = '<div id="n88-rfq-submission-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 20000; overflow-y: auto;"><div id="n88-rfq-submission-modal-content" style="position: relative; max-width: 600px; margin: 50px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh;"></div></div>';
            
            // Initialize modal HTML when DOM is ready
            function initRfqModalHTML() {
                if (!document.getElementById('n88-rfq-submission-modal')) {
                    if (document.body) {
                        document.body.insertAdjacentHTML('beforeend', modalHTML);
                    } else {
                        setTimeout(initRfqModalHTML, 100);
                    }
                }
            }
            
            // Initialize immediately if DOM is ready, otherwise wait
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initRfqModalHTML);
            } else {
                initRfqModalHTML();
            }
            
            // Define the function GLOBALLY (assign to window)
            window.openRfqSubmissionModal = function(itemIds) {
            console.log('openRfqSubmissionModal called with items:', itemIds);
            if (!Array.isArray(itemIds) || itemIds.length === 0) {
                alert('No items selected.');
                return;
            }
            
            // Ensure modal HTML exists
            var modal = document.getElementById('n88-rfq-submission-modal');
            var modalContent = document.getElementById('n88-rfq-submission-modal-content');
            
            if (!modal || !modalContent) {
                // Initialize modal HTML if not exists
                var modalHTML = '<div id="n88-rfq-submission-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 20000; overflow-y: auto;"><div id="n88-rfq-submission-modal-content" style="position: relative; max-width: 600px; margin: 50px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh;"></div></div>';
                if (document.body) {
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    modal = document.getElementById('n88-rfq-submission-modal');
                    modalContent = document.getElementById('n88-rfq-submission-modal-content');
                } else {
                    setTimeout(function() { window.openRfqSubmissionModal(itemIds); }, 100);
                    return;
                }
            }
            
            if (!modal || !modalContent) {
                console.error('RFQ modal elements not found');
                return;
            }
            
            // Show loading message first
            var loadingHTML = '<div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background-color: #fff;">' +
                '<h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #333;">Request Quote' + (itemIds.length > 1 ? 's' : '') + '</h2>' +
                '<button onclick="closeRfqSubmissionModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #666; line-height: 1;">×</button>' +
                '</div>' +
                '<div style="flex: 1; overflow-y: auto; padding: 60px 20px; background-color: #fff; text-align: center;">' +
                '<div style="font-size: 16px; color: #666;">Loading...</div>' +
                '</div>';

            modalContent.innerHTML = loadingHTML;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Build form HTML directly (full implementation)
            var formHTML = '<div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background-color: #fff;">' +
                '<h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #333;">Request Quote' + (itemIds.length > 1 ? 's' : '') + '</h2>' +
                '<button onclick="closeRfqSubmissionModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #666; line-height: 1;">×</button>' +
                '</div>' +
                '<div style="flex: 1; overflow-y: auto; padding: 20px; background-color: #fff;">' +
                '<form id="n88-rfq-submission-form" onsubmit="return submitRfqForm(event);">' +
                '<input type="hidden" name="item_ids" value=\'' + JSON.stringify(itemIds) + '\' />' +
                '<div id="n88-rfq-items-container"></div>' +
                '<div style="margin-top: 0px; padding-top: 0px; border-top: 0px solid #e0e0e0;">' +
                '<h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #333;">Invite Makers</h3>' +
                '<p style="margin: 0 0 12px 0; font-size: 13px; color: #666;">Enter existing maker username(s) or email address(es). Press Enter or click Add to create a chip. (1-5 invites)</p>' +
                '<div style="display: flex; gap: 8px; margin-bottom: 12px;">' +
                '<input type="text" id="n88-invite-supplier-input" placeholder="Username or email" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" onkeypress="if(event.key===\'Enter\'){event.preventDefault();addInvitedSupplierChip();}" />' +
                '<button type="button" onclick="addInvitedSupplierChip()" style="padding: 10px 20px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; white-space: nowrap;">Add</button>' +
                '</div>' +
                '<div id="n88-invited-suppliers-chips" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; min-height: 32px;"></div>' +
                '<input type="hidden" id="n88-invited-suppliers-json" name="invited_suppliers" value="[]" />' +
                '<div id="n88-invite-supplier-error" style="font-size: 12px; color: #d32f2f; margin-top: 4px; display: none;"></div>' +
                '</div>' +
                '<div style="margin-top: 24px;">' +
                '<label style="display: flex; align-items: center; cursor: pointer;">' +
                '<input type="checkbox" id="n88-allow-system-invites" name="allow_system_invites" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;" onchange="updateSystemInvitesMessage()" />' +
                '<span style="font-size: 14px; font-weight: 500; color: #333;">Let WireFrame (OS) source makers for this request</span>' +
                '</label>' +
                '<div style="margin-top: 8px; font-size: 13px; color: #666; padding-left: 26px;">If enabled, Wireframe (OS) will find qualified makers based on your item and keywords.</div>' +
                '<div id="n88-system-invites-message" style="margin-top: 8px; font-size: 13px; color: #666; padding-left: 26px; display: none;"></div>' +
                '</div>' +
                '<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">' +
                '<button type="submit" id="n88-submit-rfq-btn" style="width: 100%; padding: 12px 24px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">Submit RFQ</button>' +
                '<div id="n88-rfq-errors" style="margin-top: 12px; color: #d32f2f; font-size: 13px; display: none;"></div>' +
                '</div>' +
                '</form>' +
                '</div>';

            // Load items first, then show form once items are ready
            var itemsLoaded = 0;
            var totalItems = itemIds.length;
            var loadedItems = [];
            
            if (totalItems === 0) {
                modalContent.innerHTML = '<div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background-color: #fff;">' +
                    '<h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #333;">Request Quote</h2>' +
                    '<button onclick="closeRfqSubmissionModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #666; line-height: 1;">×</button>' +
                    '</div>' +
                    '<div style="flex: 1; overflow-y: auto; padding: 60px 20px; background-color: #fff; text-align: center;">' +
                    '<div style="font-size: 16px; color: #d32f2f;">No items selected.</div>' +
                    '</div>';
                return;
            }
            
            // Function to show form once all items are loaded
            function showFormWithItems() {
                modalContent.innerHTML = formHTML;
                
                // Insert loaded items into container
                var container = document.getElementById('n88-rfq-items-container');
                if (container) {
                    container.innerHTML = '';
                    loadedItems.forEach(function(itemHTML) {
                        container.insertAdjacentHTML('beforeend', itemHTML);
                    });
                    
                    // Add delivery country change listeners
                    var countrySelects = container.querySelectorAll('select[name="delivery_country[]"]');
                    countrySelects.forEach(function(select) {
                        select.addEventListener('change', function() {
                            var itemForm = select.closest('.n88-rfq-item-form');
                            var itemId = itemForm ? itemForm.getAttribute('data-item-id') : '';
                            var country = select.value.toUpperCase();
                            var postalInput = itemForm ? itemForm.querySelector('input[name="delivery_postal[]"]') : null;
                            var noteDiv = document.getElementById('n88-delivery-note-' + itemId);
                            if (country === 'US' || country === 'CA') {
                                if (postalInput) postalInput.required = true;
                                if (noteDiv) {
                                    noteDiv.style.display = 'block';
                                    noteDiv.textContent = 'ZIP/postal code is required for US and Canada.';
                                }
                            } else {
                                if (postalInput) postalInput.required = false;
                                if (noteDiv && country.length > 0) {
                                    noteDiv.style.display = 'block';
                                    noteDiv.textContent = 'We are not able to calculate an instant shipping estimate for this delivery location yet, but our team can get back to you with a shipping range within 24 hours.';
                                } else if (noteDiv) {
                                    noteDiv.style.display = 'none';
                                }
                            }
                        });
                    });
                }
                
                // Update system invites message if function available
                if (window.updateSystemInvitesMessage) {
                    setTimeout(function() { window.updateSystemInvitesMessage(); }, 100);
                }
            }
            
            // Load all items first
            itemIds.forEach(function(itemId) {
                            // Extract numeric ID from "item-87" format
                            var numericId = itemId;
                            if (typeof itemId === 'string' && itemId.indexOf('item-') === 0) {
                                numericId = itemId.replace('item-', '');
                            }
                            
                            // Fetch item details to get images
                            var formData = new FormData();
                            formData.append('action', 'n88_get_supplier_item_details');
                            formData.append('item_id', numericId);
                            formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_supplier_item_details' ); ?>');
                            
                            fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                                method: 'POST',
                                body: formData
                            })
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                var item = data.success ? data.data : null;
                                
                                // Get primary image URL
                                var primaryImageUrl = item ? (item.primary_image_url || item.image_url || '') : '';
                                
                                // Get inspiration images
                                var inspirationImages = item ? (item.inspiration_images || item.reference_images || []) : [];
                                
                                // Filter and prepare valid reference images
                                var validReferenceImages = [];
                                if (inspirationImages && inspirationImages.length > 0) {
                                    inspirationImages.forEach(function(img) {
                                        var imgUrl = '';
                                        var fullUrl = '';
                                        
                                        if (typeof img === 'string') {
                                            imgUrl = img;
                                            fullUrl = img;
                                        } else if (typeof img === 'object') {
                                            imgUrl = img.url || img.thumbnail || img.thumb_url || '';
                                            fullUrl = img.full_url || img.url || img.thumbnail || img.thumb_url || '';
                                        }
                                        
                                        if (imgUrl && imgUrl.trim() !== '' && (imgUrl.startsWith('http://') || imgUrl.startsWith('https://'))) {
                                            validReferenceImages.push({
                                                url: imgUrl,
                                                fullUrl: fullUrl || imgUrl
                                            });
                                        }
                                    });
                                }
                                
                                // Build image gallery layout: left reference images, center main image, right reference images
                                // Always show the gallery box
                                var imageGalleryHTML = '';
                                
                                // Split reference images into left and right
                                var leftImages = [];
                                var rightImages = [];
                                validReferenceImages.forEach(function(img, index) {
                                    if (index % 2 === 0) {
                                        leftImages.push(img);
                                    } else {
                                        rightImages.push(img);
                                    }
                                });
                                
                                // Build left column (reference images)
                                var leftColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                                if (leftImages.length > 0) {
                                    leftImages.forEach(function(img, index) {
                                        var imgId = 'n88-rfq-ref-left-' + numericId + '-' + index;
                                        leftColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                                            '<img id="' + imgId + '" ' +
                                            'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                                            'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                                            'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                                            'style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s; background-color: #000;" ' +
                                            'onmouseover="this.style.borderColor=\'#0073aa\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,115,170,0.3)\';" ' +
                                            'onmouseout="this.style.borderColor=\'#ddd\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                            'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\');if(url&&url.trim()){try{window.open(url,\'_blank\',\'noopener,noreferrer\');}catch(err){console.error(\'Error opening image:\',err);}}else{console.error(\'No URL found for image\');}})(this);" ' +
                                            'title="Click to view full size" ' +
                                            'alt="Reference photo" />' +
                                            '</div>';
                                    });
                                }
                                leftColumnHTML += '</div>';
                                
                                // Build center column (main image)
                                var centerColumnHTML = '<div style="flex: 1; display: flex; align-items: center; justify-content: center; min-height: 300px; padding: 0 20px; max-width: 500px;">';
                                if (primaryImageUrl) {
                                    centerColumnHTML += '<img src="' + primaryImageUrl.replace(/"/g, '&quot;') + '" ' +
                                        'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23f0f0f0\' width=\'400\' height=\'300\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'14\'%3EItem Image%3C/text%3E%3C/svg%3E\';" ' +
                                        'style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 4px; border: 1px solid #e0e0e0; object-fit: contain; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" ' +
                                        'alt="Item main image" />';
                                } else {
                                    centerColumnHTML += '<div style="width: 100%; height: 300px; background-color: #f0f0f0; border-radius: 4px; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999;">No main image available</div>';
                                }
                                centerColumnHTML += '</div>';
                                
                                // Build right column (reference images)
                                var rightColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                                if (rightImages.length > 0) {
                                    rightImages.forEach(function(img, index) {
                                        var imgId = 'n88-rfq-ref-right-' + numericId + '-' + index;
                                        rightColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                                            '<img id="' + imgId + '" ' +
                                            'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                                            'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                                            'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                                            'style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s; background-color: #000;" ' +
                                            'onmouseover="this.style.borderColor=\'#0073aa\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,115,170,0.3)\';" ' +
                                            'onmouseout="this.style.borderColor=\'#ddd\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                            'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\');if(url&&url.trim()){try{window.open(url,\'_blank\',\'noopener,noreferrer\');}catch(err){console.error(\'Error opening image:\',err);}}else{console.error(\'No URL found for image\');}})(this);" ' +
                                            'title="Click to view full size" ' +
                                            'alt="Reference photo" />' +
                                            '</div>';
                                    });
                                }
                                rightColumnHTML += '</div>';
                                
                                // Always combine into gallery layout (box always visible)
                                imageGalleryHTML = '<div style="margin-bottom: 24px; display: flex; gap: 16px; align-items: flex-start; justify-content: center; padding: 16px; background-color: #fafafa; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                    leftColumnHTML +
                                    centerColumnHTML +
                                    rightColumnHTML +
                                    '</div>';
                                
                                var itemHTML = '<div class="n88-rfq-item-form" data-item-id="' + numericId + '" style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e0e0e0;">' +
                                    '<h4 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #333;">Item #' + numericId + '</h4>' +
                                    
                                    // Image gallery: left reference images, center main image, right reference images
                                    imageGalleryHTML +
                                    
                                '<div style="margin-bottom: 16px;">' +
                                '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Quantity <span style="color: #d32f2f;">*</span></label>' +
                                '<input type="number" name="quantity[]" min="1" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />' +
                                '</div>' +
                                '<div style="margin-bottom: 16px;">' +
                                '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Dimensions <span style="color: #d32f2f;">*</span></label>' +
                                '<div style="display: flex; gap: 8px; align-items: center; max-width: 50%;">' +
                                '<input type="number" name="width[]" step="0.01" min="0.01" placeholder="Width" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100px;" />' +
                                '<input type="number" name="depth[]" step="0.01" min="0.01" placeholder="Depth" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100px;" />' +
                                '<input type="number" name="height[]" step="0.01" min="0.01" placeholder="Height" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100px;" />' +
                                '<select name="dimension_unit[]" required style="flex: 0 0 80px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;     width: 100px;">' +
                                '<option value="in">Inches</option>' +
                                '<option value="cm">Centimeters</option>' +
                                '</select>' +
                                '</div>' +
                                '</div>' +
                                '<div style="margin-bottom: 16px;">' +
                                '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Delivery Country <span style="color: #d32f2f;">*</span></label>' +
                                '<select name="delivery_country[]" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">' +
                                '<option value="">Select Country</option>' +
                                '<option value="US">USA</option>' +
                                '<option value="CA">CAN</option>' +
                                '<option value="CN">CHINA</option>' +
                                '<option value="VN">VIETNAM</option>' +
                                '<option value="EU">EUROPE</option>' +
                                '<option value="AF">AFRICA</option>' +
                                '</select>' +
                                '</div>' +
                                '<div style="margin-bottom: 16px;">' +
                                '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">ZIP/Postal Code</label>' +
                                '<input type="text" name="delivery_postal[]" placeholder="Required for US/CA" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />' +
                                '<div id="n88-delivery-note-' + numericId + '" style="margin-top: 8px; font-size: 12px; color: #666; display: none;"></div>' +
                                '</div>' +
                                '</div>';
                            
                            // Store item HTML instead of inserting immediately
                            loadedItems.push(itemHTML);
                            itemsLoaded++;
                            
                            // Show form once all items are loaded
                            if (itemsLoaded >= totalItems) {
                                showFormWithItems();
                            }
                        })
                        .catch(function(error) {
                            console.error('Error fetching item details:', error);
                            itemsLoaded++;
                            // Show form even if some items failed
                            if (itemsLoaded >= totalItems) {
                                showFormWithItems();
                            }
                        });
            });
            };
            
            // Expose loadItemForms function globally so it can be called from openRfqSubmissionModal
            window._loadRfqItemForms = function(itemIds) {
                var container = document.getElementById('n88-rfq-items-container');
                if (!container) return;
                
                container.innerHTML = '';
                itemIds.forEach(function(itemId) {
                    // Extract numeric ID from "item-87" format
                    var numericId = itemId;
                    if (typeof itemId === 'string' && itemId.indexOf('item-') === 0) {
                        numericId = itemId.replace('item-', '');
                    }
                    
                    // Fetch item details to get images
                    var formData = new FormData();
                    formData.append('action', 'n88_get_supplier_item_details');
                    formData.append('item_id', numericId);
                    formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_supplier_item_details' ); ?>');
                    
                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        var item = data.success ? data.data : null;
                        
                        // Get primary image URL
                        var primaryImageUrl = item ? (item.primary_image_url || item.image_url || '') : '';
                        
                        // Get inspiration images
                        var inspirationImages = item ? (item.inspiration_images || item.reference_images || []) : [];
                        
                        // Filter and prepare valid reference images
                        var validReferenceImages = [];
                        if (inspirationImages && inspirationImages.length > 0) {
                            inspirationImages.forEach(function(img) {
                                var imgUrl = '';
                                var fullUrl = '';
                                
                                if (typeof img === 'string') {
                                    imgUrl = img;
                                    fullUrl = img;
                                } else if (typeof img === 'object') {
                                    imgUrl = img.url || img.thumbnail || img.thumb_url || '';
                                    fullUrl = img.full_url || img.url || img.thumbnail || img.thumb_url || '';
                                }
                                
                                if (imgUrl && imgUrl.trim() !== '' && (imgUrl.startsWith('http://') || imgUrl.startsWith('https://'))) {
                                    validReferenceImages.push({
                                        url: imgUrl,
                                        fullUrl: fullUrl || imgUrl
                                    });
                                }
                            });
                        }
                        
                        // Build image gallery layout: left reference images, center main image, right reference images
                        var imageGalleryHTML = '';
                        if (primaryImageUrl || validReferenceImages.length > 0) {
                            // Split reference images into left and right
                            var leftImages = [];
                            var rightImages = [];
                            validReferenceImages.forEach(function(img, index) {
                                if (index % 2 === 0) {
                                    leftImages.push(img);
                                } else {
                                    rightImages.push(img);
                                }
                            });
                            
                            // Build left column (reference images)
                            var leftColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                            if (leftImages.length > 0) {
                                leftImages.forEach(function(img, index) {
                                    var imgId = 'n88-rfq-ref-left-' + numericId + '-' + index;
                                    leftColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                                        '<img id="' + imgId + '" ' +
                                        'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                                        'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                                        'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                                        'style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s; background-color: #000;" ' +
                                        'onmouseover="this.style.borderColor=\'#0073aa\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,115,170,0.3)\';" ' +
                                        'onmouseout="this.style.borderColor=\'#ddd\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                        'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\');if(url&&url.trim()){try{window.open(url,\'_blank\',\'noopener,noreferrer\');}catch(err){console.error(\'Error opening image:\',err);}}else{console.error(\'No URL found for image\');}})(this);" ' +
                                        'title="Click to view full size" ' +
                                        'alt="Reference photo" />' +
                                        '</div>';
                                });
                            } else {
                                leftColumnHTML += '<div style="width: 100px; height: 100px; background-color: #000; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 11px; text-align: center; padding: 4px;">reference photo</div>';
                            }
                            leftColumnHTML += '</div>';
                            
                            // Build center column (main image)
                            var centerColumnHTML = '<div style="flex: 1; display: flex; align-items: center; justify-content: center; min-height: 300px; padding: 0 20px; max-width: 500px;">';
                            if (primaryImageUrl) {
                                centerColumnHTML += '<img src="' + primaryImageUrl.replace(/"/g, '&quot;') + '" ' +
                                    'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23f0f0f0\' width=\'400\' height=\'300\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'14\'%3EItem Image%3C/text%3E%3C/svg%3E\';" ' +
                                    'style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 4px; border: 1px solid #e0e0e0; object-fit: contain; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" ' +
                                    'alt="Item main image" />';
                            } else {
                                centerColumnHTML += '<div style="width: 100%; height: 300px; background-color: #f0f0f0; border-radius: 4px; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999;">No main image available</div>';
                            }
                            centerColumnHTML += '</div>';
                            
                            // Build right column (reference images)
                            var rightColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                            if (rightImages.length > 0) {
                                rightImages.forEach(function(img, index) {
                                    var imgId = 'n88-rfq-ref-right-' + numericId + '-' + index;
                                    rightColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                                        '<img id="' + imgId + '" ' +
                                        'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                                        'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                                        'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                                        'style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s; background-color: #000;" ' +
                                        'onmouseover="this.style.borderColor=\'#0073aa\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,115,170,0.3)\';" ' +
                                        'onmouseout="this.style.borderColor=\'#ddd\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                        'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\');if(url&&url.trim()){try{window.open(url,\'_blank\',\'noopener,noreferrer\');}catch(err){console.error(\'Error opening image:\',err);}}else{console.error(\'No URL found for image\');}})(this);" ' +
                                        'title="Click to view full size" ' +
                                        'alt="Reference photo" />' +
                                        '</div>';
                                });
                            } else {
                                rightColumnHTML += '<div style="width: 100px; height: 100px; background-color: #000; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 11px; text-align: center; padding: 4px;">reference photo</div>';
                            }
                            rightColumnHTML += '</div>';
                            
                            // Combine into gallery layout
                            imageGalleryHTML = '<div style="margin-bottom: 24px; display: flex; gap: 16px; align-items: flex-start; justify-content: center; padding: 16px; background-color: #fafafa; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                leftColumnHTML +
                                centerColumnHTML +
                                rightColumnHTML +
                                '</div>';
                        }
                        
                        var itemHTML = '<div class="n88-rfq-item-form" data-item-id="' + numericId + '" style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e0e0e0;">' +
                            '<h4 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #333;">Item #' + numericId + '</h4>' +
                            
                            // Image gallery: left reference images, center main image, right reference images
                            imageGalleryHTML +
                            
                            '<div style="margin-bottom: 16px;">' +
                            '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Quantity <span style="color: #d32f2f;">*</span></label>' +
                            '<input type="number" name="quantity[]" min="1" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />' +
                            '</div>' +
                            '<div style="margin-bottom: 16px;">' +
                            '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Dimensions <span style="color: #d32f2f;">*</span></label>' +
                            '<div style="display: flex; gap: 8px; align-items: center; max-width: 50%;">' +
                            '<input type="number" name="width[]" step="0.01" min="0.01" placeholder="Width" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100px;" />' +
                            '<input type="number" name="depth[]" step="0.01" min="0.01" placeholder="Depth" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100px;" />' +
                            '<input type="number" name="height[]" step="0.01" min="0.01" placeholder="Height" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100px;" />' +
                            '<select name="dimension_unit[]" required style="flex: 0 0 80px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; width: 100px;">' +
                            '<option value="in">Inches</option>' +
                            '<option value="cm">Centimeters</option>' +
                            '</select>' +
                            '</div>' +
                            '</div>' +
                            '<div style="margin-bottom: 16px;">' +
                            '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Delivery Country <span style="color: #d32f2f;">*</span></label>' +
                            '<select name="delivery_country[]" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">' +
                            '<option value="">Select Country</option>' +
                            '<option value="USA">USA</option>' +
                            '<option value="CAN">CAN</option>' +
                            '<option value="CHINA">CHINA</option>' +
                            '<option value="VIETNAM">VIETNAM</option>' +
                            '<option value="EUROPE">EUROPE</option>' +
                            '<option value="AFRICA">AFRICA</option>' +
                            '</select>' +
                            '</div>' +
                            '<div style="margin-bottom: 16px;">' +
                            '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">ZIP/Postal Code</label>' +
                            '<input type="text" name="delivery_postal[]" placeholder="Required for USA/CAN" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />' +
                            '<div id="n88-delivery-note-' + numericId + '" style="margin-top: 8px; font-size: 12px; color: #666; display: none;"></div>' +
                            '</div>' +
                            '</div>';
                        container.insertAdjacentHTML('beforeend', itemHTML);
                        
                        // Add delivery country change listeners
                        var countrySelects = container.querySelectorAll('select[name="delivery_country[]"]');
                        countrySelects.forEach(function(select) {
                            select.addEventListener('change', function() {
                                var itemForm = select.closest('.n88-rfq-item-form');
                                var itemId = itemForm ? itemForm.getAttribute('data-item-id') : '';
                                var country = select.value.toUpperCase();
                                var postalInput = itemForm ? itemForm.querySelector('input[name="delivery_postal[]"]') : null;
                                var noteDiv = document.getElementById('n88-delivery-note-' + itemId);
                                if (country === 'USA' || country === 'CAN') {
                                    if (postalInput) postalInput.required = true;
                                    if (noteDiv) {
                                        noteDiv.style.display = 'block';
                                        noteDiv.textContent = 'ZIP/postal code is required for US and Canada.';
                                    }
                                } else {
                                    if (postalInput) postalInput.required = false;
                                    if (noteDiv && country.length > 0) {
                                        noteDiv.style.display = 'block';
                                        noteDiv.textContent = 'We are not able to calculate an instant shipping estimate for this delivery location yet, but our team can get back to you with a shipping range within 24 hours.';
                                    } else if (noteDiv) {
                                        noteDiv.style.display = 'none';
                                    }
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.error('Error fetching item details:', error);
                    });
                });
            };
            
            // Define close modal function globally
            window.closeRfqSubmissionModal = function() {
                var modal = document.getElementById('n88-rfq-submission-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            };
            
            // Define update system invites message function globally
            window.updateSystemInvitesMessage = function() {
                var checkbox = document.getElementById('n88-allow-system-invites');
                var messageDiv = document.getElementById('n88-system-invites-message');
                var invitedSuppliersJson = document.getElementById('n88-invited-suppliers-json');
                
                if (!checkbox || !messageDiv) return;
                
                var invitedCount = 0;
                if (invitedSuppliersJson && invitedSuppliersJson.value) {
                    try {
                        var invited = JSON.parse(invitedSuppliersJson.value);
                        invitedCount = Array.isArray(invited) ? invited.length : 0;
                    } catch(e) {
                        invitedCount = 0;
                    }
                }

                if (checkbox.checked) {
                    if (invitedCount > 0) {
                        // Toggle ON + supplier email(s) entered
                        messageDiv.style.display = 'block';
                        messageDiv.textContent = 'Your invited maker(s) will receive this request first. WireFrame (OS) will invite additional makers after 24 hours.';
                    } else {
                        // Toggle ON + NO supplier email entered - hide confirmation message
                        messageDiv.style.display = 'none';
                    }
                } else {
                    // Toggle OFF (email empty or filled) - hide confirmation message
                    messageDiv.style.display = 'none';
                }
            };
            
            // Add invited supplier chip
            window.addInvitedSupplierChip = function() {
                var input = document.getElementById('n88-invite-supplier-input');
                var chipsContainer = document.getElementById('n88-invited-suppliers-chips');
                var hiddenInput = document.getElementById('n88-invited-suppliers-json');
                var errorDiv = document.getElementById('n88-invite-supplier-error');
                
                if (!input || !chipsContainer || !hiddenInput) return;
                
                var value = input.value.trim();
                if (!value) return;
                
                // Get current chips
                var currentChips = [];
                try {
                    currentChips = JSON.parse(hiddenInput.value);
                } catch(e) {
                    currentChips = [];
                }
                
                // Check max limit (5)
                if (currentChips.length >= 5) {
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = 'Maximum 5 invited makers allowed.';
                    }
                    return;
                }
                
                // Check for duplicates
                if (currentChips.indexOf(value) !== -1) {
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = 'This supplier is already added.';
                    }
                    return;
                }
                
                // Add chip
                currentChips.push(value);
                hiddenInput.value = JSON.stringify(currentChips);
                
                // Create chip element
                var chip = document.createElement('div');
                chip.style.cssText = 'display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 16px; font-size: 13px; color: #1976d2;';
                chip.innerHTML = '<span>' + value + '</span>' +
                    '<button type="button" onclick="removeInvitedSupplierChip(\'' + value.replace(/'/g, "\\'") + '\')" style="background: none; border: none; color: #1976d2; cursor: pointer; font-size: 16px; line-height: 1; padding: 0; margin-left: 4px; font-weight: bold;">×</button>';
                
                chipsContainer.appendChild(chip);
                input.value = '';
                if (errorDiv) errorDiv.style.display = 'none';
                
                // Update message
                updateSystemInvitesMessage();
            };
            
            // Remove invited supplier chip
            window.removeInvitedSupplierChip = function(value) {
                var chipsContainer = document.getElementById('n88-invited-suppliers-chips');
                var hiddenInput = document.getElementById('n88-invited-suppliers-json');
                
                if (!chipsContainer || !hiddenInput) return;
                
                var currentChips = [];
                try {
                    currentChips = JSON.parse(hiddenInput.value);
                } catch(e) {
                    currentChips = [];
                }
                
                var index = currentChips.indexOf(value);
                if (index !== -1) {
                    currentChips.splice(index, 1);
                    hiddenInput.value = JSON.stringify(currentChips);
                    
                    // Remove chip element
                    var chips = chipsContainer.querySelectorAll('div');
                    chips.forEach(function(chip) {
                        if (chip.textContent.indexOf(value) !== -1) {
                            chip.remove();
                        }
                    });
                    
                    // Update message
                    updateSystemInvitesMessage();
                }
            };
            
            // Supplier Bid Button Management Helper (Commit 2.3.5.5)
            window.updateSupplierBidButton = function(itemId, state) {
                // state can be: 'validate', 'validating', 'submit', 'submitting'
                var validateBtn = document.getElementById('n88-validate-bid-btn-embedded-' + itemId);
                var submitBtn = document.getElementById('n88-submit-bid-btn-embedded-' + itemId);
                
                if (!validateBtn) return;
                
                switch(state) {
                    case 'validate':
                        // Initial state - show validate button
                        validateBtn.innerHTML = '[ Validate Bid ]';
                        validateBtn.disabled = false;
                        validateBtn.style.cursor = 'pointer';
                        validateBtn.style.opacity = '1';
                        if (submitBtn) {
                            submitBtn.style.display = 'none';
                        }
                        break;
                        
                    case 'validating':
                        // During validation
                        validateBtn.innerHTML = '[ Validating... ]';
                        validateBtn.disabled = true;
                        validateBtn.style.cursor = 'not-allowed';
                        validateBtn.style.opacity = '0.6';
                        break;
                        
                    case 'submit':
                        // After successful validation - show submit button
                        validateBtn.innerHTML = '[ Submit Bid ]';
                        validateBtn.disabled = false;
                        validateBtn.style.cursor = 'pointer';
                        validateBtn.style.opacity = '1';
                        validateBtn.style.backgroundColor = '#00ff00';
                        validateBtn.style.color = '#000';
                        break;
                        
                    case 'submitting':
                        // During submission
                        validateBtn.innerHTML = '[ Submitting... ]';
                        validateBtn.disabled = true;
                        validateBtn.style.cursor = 'not-allowed';
                        validateBtn.style.opacity = '0.6';
                        break;
                }
            };
            
            // Define submit form function globally (full implementation)
            window.submitRfqForm = function(e) {
                e.preventDefault();

                var form = document.getElementById('n88-rfq-submission-form');
                var submitBtn = document.getElementById('n88-submit-rfq-btn');
                var errorsDiv = document.getElementById('n88-rfq-errors');
                
                if (!form || !submitBtn) return false;
                
                var itemIdsJson = form.querySelector('input[name="item_ids"]');
                if (!itemIdsJson) {
                    console.error('Item IDs not found in form');
                    return false;
                }
                var itemIds = JSON.parse(itemIdsJson.value);

                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                if (errorsDiv) errorsDiv.style.display = 'none';

                // Collect form data
                var items = [];
                var itemForms = form.querySelectorAll('.n88-rfq-item-form');
                itemForms.forEach(function(itemForm, index) {
                    var itemId = parseInt(itemForm.getAttribute('data-item-id'));
                    var quantity = parseInt(itemForm.querySelector('input[name="quantity[]"]').value);
                    var width = parseFloat(itemForm.querySelector('input[name="width[]"]').value);
                    var depth = parseFloat(itemForm.querySelector('input[name="depth[]"]').value);
                    var height = parseFloat(itemForm.querySelector('input[name="height[]"]').value);
                    var dimensionUnit = itemForm.querySelector('select[name="dimension_unit[]"]').value;
                    var deliveryCountrySelect = itemForm.querySelector('select[name="delivery_country[]"]');
                    var deliveryCountry = deliveryCountrySelect ? deliveryCountrySelect.value.toUpperCase().trim() : '';
                    var deliveryPostal = itemForm.querySelector('input[name="delivery_postal[]"]').value.trim();

                    items.push({
                        item_id: itemId,
                        quantity: quantity,
                        width: width,
                        depth: depth,
                        height: height,
                        dimension_unit: dimensionUnit,
                        delivery_country: deliveryCountry,
                        delivery_postal: deliveryPostal,
                    });
                });

                // Get invited suppliers (chips)
                var invitedSuppliersJson = document.getElementById('n88-invited-suppliers-json');
                var allowSystemInvites = document.getElementById('n88-allow-system-invites');
                
                if (!allowSystemInvites) {
                    console.error('System invites checkbox not found');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit RFQ';
                    return false;
                }
                
                var invitedSuppliers = [];
                if (invitedSuppliersJson && invitedSuppliersJson.value) {
                    try {
                        invitedSuppliers = JSON.parse(invitedSuppliersJson.value);
                        if (!Array.isArray(invitedSuppliers)) invitedSuppliers = [];
                    } catch(e) {
                        invitedSuppliers = [];
                    }
                }
                
                // Debug: Log invited suppliers
                console.log('Invited suppliers being sent:', invitedSuppliers);
                
                var allowSystemInvitesValue = allowSystemInvites.checked;
                
                // Debug: Log toggle state
                console.log('Allow system invites:', allowSystemInvitesValue);

                // Validate: Case D - No invited suppliers + toggle OFF
                if (invitedSuppliers.length === 0 && !allowSystemInvitesValue) {
                    if (errorsDiv) {
                        errorsDiv.style.display = 'block';
                        errorsDiv.textContent = 'Invite at least one maker or allow the system to invite makers.';
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit RFQ';
                    return false;
                }

                // Submit via AJAX
                var formData = new FormData();
                formData.append('action', 'n88_submit_rfq');
                formData.append('items', JSON.stringify(items));
                formData.append('invited_suppliers', JSON.stringify(invitedSuppliers));
                formData.append('allow_system_invites', allowSystemInvitesValue ? '1' : '0');
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_submit_rfq' ); ?>');

                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.success) {
                        alert(data.data.message || 'RFQ submitted successfully!');
                        window.closeRfqSubmissionModal();
                        // Optionally reload page or refresh queue
                        if (window.location.href.indexOf('admin.php') > -1) {
                            window.location.reload();
                        }
                    } else {
                        if (errorsDiv) {
                            errorsDiv.style.display = 'block';
                            if (data.data && data.data.errors) {
                                var errorMessages = [];
                                for (var key in data.data.errors) {
                                    errorMessages.push(data.data.errors[key]);
                                }
                                errorsDiv.textContent = errorMessages.join(' ');
                            } else {
                                errorsDiv.textContent = data.data && data.data.message ? data.data.message : 'An error occurred. Please try again.';
                            }
                        }
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit RFQ';
                    }
                })
                .catch(function(error) {
                    console.error('RFQ submission error:', error);
                    if (errorsDiv) {
                        errorsDiv.style.display = 'block';
                        errorsDiv.textContent = 'Network error. Please try again.';
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit RFQ';
                });

                return false;
            };
            
            console.log('RFQ submission modal function initialized globally');
            console.log('window.openRfqSubmissionModal is:', typeof window.openRfqSubmissionModal);
            console.log('window.closeRfqSubmissionModal is:', typeof window.closeRfqSubmissionModal);
            
            // Verify functions are available
            if (typeof window.openRfqSubmissionModal === 'function') {
                console.log('✓ openRfqSubmissionModal is available');
            } else {
                console.error('✗ openRfqSubmissionModal is NOT available!');
            }
            if (typeof window.closeRfqSubmissionModal === 'function') {
                console.log('✓ closeRfqSubmissionModal is available');
            } else {
                console.error('✗ closeRfqSubmissionModal is NOT available!');
            }
        })();
        </script>
        <script>
        (function() { 
            function updateDebug(msg) {
                const debugEl = document.getElementById('n88-board-demo-debug');
                if (debugEl) debugEl.innerHTML = '<div>' + msg + '</div>';
            }
            
            // Ensure DOM is ready before initializing (critical for new tabs)
            function startInitialization() {
                // Wait for DOM to be ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        // Wait a bit more for scripts to load, especially in new tabs
                        setTimeout(initializeBoard, 300);
                    });
                } else {
                    // DOM already ready - wait a bit for scripts to load
                    setTimeout(initializeBoard, 300);
                }
                
                // Also try when window fully loads (backup for new tabs)
                window.addEventListener('load', function() {
                    setTimeout(function() {
                        // Check if board is already initialized
                        var rootEl = document.getElementById('n88-board-demo-root');
                        if (rootEl && !rootEl.hasChildNodes()) {
                            console.log('Window loaded but board not initialized - retrying...');
                            initializeBoard();
                        }
                    }, 500);
                });
            }
            
            function initializeBoard() {
                // Start checking for dependencies
                var checkCount = 0;
                var maxChecks = 100; // 10 seconds max (increased from 5 seconds for new tabs)
                var boardInitialized = false;
                var checkInterval = setInterval(function() {
                    checkCount++;
                    if (initBoard()) {
                        boardInitialized = true;
                        clearInterval(checkInterval);
                        // Hide debug after 3 seconds
                        setTimeout(function() {
                            var debugEl = document.getElementById('n88-board-demo-debug');
                            if (debugEl) debugEl.style.display = 'none';
                        }, 3000);
                    } else if (checkCount >= maxChecks) {
                        clearInterval(checkInterval);
                        updateDebug('ERROR: Timeout waiting for dependencies. Reloading page...');
                        // Reload page if scripts don't load after 10 seconds (for new tabs)
                        setTimeout(function() {
                            window.location.reload();
                        }, 1000);
                    }
                }, 100);
                
                // Also try to initialize when window is fully loaded (critical for new tabs)
                window.addEventListener('load', function() {
                    // Wait a bit more for scripts to load in new tabs
                    setTimeout(function() {
                        if (!boardInitialized) {
                            console.log('Window loaded - retrying board initialization...');
                            if (initBoard()) {
                                boardInitialized = true;
                                clearInterval(checkInterval);
                            } else {
                                // If still not initialized after window load, wait a bit more
                                setTimeout(function() {
                                    if (!boardInitialized && initBoard()) {
                                        boardInitialized = true;
                                        clearInterval(checkInterval);
                                    }
                                }, 1000);
                            }
                        }
                    }, 500);
                });
            }

            function initBoard() {
                // Prevent multiple initialization attempts
                if (window._n88BoardInitialized) {
                    return true;
                }
                
                // Check all dependencies
                if (typeof window.React === 'undefined') {
                    updateDebug('Waiting for React...');
                    return false;
                }
                if (typeof window.ReactDOM === 'undefined') {
                    updateDebug('Waiting for ReactDOM...');
                    return false;
                }
                // Framer Motion can expose as window.motion or window.framerMotion
                // Check multiple possible locations
                var framerMotion = window.motion || window.framerMotion || window.Motion || (window.framer && window.framer.motion);
                if (!framerMotion) {
                    updateDebug('Waiting for Framer Motion... (checking window.motion, window.framerMotion, window.Motion)');
                    console.log('Framer Motion check - window.motion:', window.motion);
                    console.log('Framer Motion check - window.framerMotion:', window.framerMotion);
                    console.log('Framer Motion check - window.Motion:', window.Motion);
                    console.log('Framer Motion check - window.framer:', window.framer);
                    return false;
                }
                // Zustand might expose as window.zustand or window.zustand.default
                var zustandModule = window.zustand;
                if (!zustandModule) {
                    updateDebug('Waiting for Zustand... (checking window.zustand)');
                    return false;
                }
                // Check if create function exists (Zustand 3.x format)
                // Zustand 3.7.2 exposes as {__esModule: true, default: createFunction}
                var hasCreate = (zustandModule.create && typeof zustandModule.create === 'function') ||
                               (zustandModule.default && typeof zustandModule.default === 'function') ||
                               (zustandModule.default && zustandModule.default.create && typeof zustandModule.default.create === 'function');
                if (!hasCreate) {
                    updateDebug('Waiting for Zustand create function...');
                    console.log('Zustand module:', zustandModule);
                    console.log('Zustand.default:', zustandModule.default);
                    console.log('Zustand.default type:', typeof zustandModule.default);
                    return false;
                }
                if (typeof window.N88StudioOS === 'undefined' || typeof window.N88StudioOS.useBoardStore === 'undefined') {
                    updateDebug('Waiting for useBoardStore...');
                    return false;
                }
                
                if (typeof window.N88StudioOS.useDebouncedSave === 'undefined') {
                    updateDebug('Waiting for useDebouncedSave...');
                    return false;
                }

                updateDebug('All dependencies loaded!');

                const React = window.React;
                const ReactDOM = window.ReactDOM;
                
                // Extract motion components - Framer Motion UMD exposes as an object
                var motion, AnimatePresence, useMotionValue;
                console.log('Framer Motion structure:', framerMotion);
                console.log('Framer Motion type:', typeof framerMotion);
                console.log('Framer Motion keys:', framerMotion ? Object.keys(framerMotion) : 'null');
                
                if (typeof framerMotion === 'object' && framerMotion !== null) {
                    // Check if it's the motion object itself or contains motion
                    if (framerMotion.motion) {
                        motion = framerMotion.motion;
                        AnimatePresence = framerMotion.AnimatePresence || framerMotion.motion.AnimatePresence;
                        useMotionValue = framerMotion.useMotionValue || framerMotion.motion.useMotionValue;
                    } else if (typeof framerMotion === 'function') {
                        // Direct function export
                        motion = framerMotion;
                        AnimatePresence = window.AnimatePresence || framerMotion.AnimatePresence;
                        useMotionValue = window.useMotionValue || framerMotion.useMotionValue;
                    } else {
                        // Try to use it directly
                        motion = framerMotion;
                        AnimatePresence = framerMotion.AnimatePresence || window.AnimatePresence;
                        useMotionValue = framerMotion.useMotionValue || window.useMotionValue;
                    }
                } else {
                    motion = framerMotion;
                    AnimatePresence = window.AnimatePresence;
                    useMotionValue = window.useMotionValue;
                }
                
                console.log('Extracted motion:', motion);
                console.log('Extracted AnimatePresence:', AnimatePresence);
                console.log('Extracted useMotionValue:', useMotionValue);
                
                if (!motion || !AnimatePresence || !useMotionValue) {
                    updateDebug('ERROR: Missing Framer Motion components. motion=' + !!motion + ', AnimatePresence=' + !!AnimatePresence + ', useMotionValue=' + !!useMotionValue);
                    return false;
                }
                
                const useBoardStore = window.N88StudioOS.useBoardStore;
                const useDebouncedSave = window.N88StudioOS.useDebouncedSave;

                // Items: either real board items or seed items
                const initialItems = <?php 
                    if ( $is_real_board ) {
                        echo wp_json_encode( $items );
                    } else {
                        echo wp_json_encode( $seed_items );
                    }
                ?>;
                
                // Debug: Log initial items to verify title and sizeKey
                console.log('Initial items loaded:', initialItems.length);
                console.log('Initial items array:', initialItems);
                if (initialItems.length > 0) {
                    console.log('First item sample:', initialItems[0]);
                    console.log('First item has title:', initialItems[0].title);
                    console.log('First item has sizeKey:', initialItems[0].sizeKey);
                    console.log('Last item sample:', initialItems[initialItems.length - 1]);
                    // Log all item IDs
                    console.log('All item IDs:', initialItems.map(function(item) { return item.id; }));
                }
                
                // Board ID: real board ID or 0 for demo mode
                const testBoardId = <?php echo $is_real_board ? absint( $board_id ) : 0; ?>;
                
                // Check if this is a redirect after item creation (for showing success message)
                var urlParams = new URLSearchParams(window.location.search);
                var isAfterItemCreation = urlParams.get('item_added') === '1';
                
                console.log('=== BOARD PAGE DEBUG INFO ===');
                console.log('URL:', window.location.href);
                console.log('isAfterItemCreation:', isAfterItemCreation);
                console.log('testBoardId:', testBoardId);
                console.log('initialItems.length:', initialItems.length);
                console.log('document.readyState:', document.readyState);
                
                // Success message is shown via PHP toast notification above
                // No auto-reload needed - page loads directly with fresh items from server
                
                // User ID for welcome modal (get from WordPress)
                const currentUserId = <?php echo get_current_user_id(); ?>;
                const currentUserName = <?php 
                    $current_user = wp_get_current_user();
                    echo wp_json_encode( $current_user->display_name ? $current_user->display_name : 'User' );
                ?>;
                
                // Expose userId to window for debugging
                window.currentUserId = currentUserId;
                if (window.N88StudioOS) {
                    window.N88StudioOS.currentUserId = currentUserId;
                    window.N88StudioOS.currentUser = window.N88StudioOS.currentUser || {};
                    window.N88StudioOS.currentUser.display_name = currentUserName;
                }
                
                // Concierge data (placeholder for now - can be replaced with actual data source)
                const conciergeData = <?php 
                    // TODO: Replace with actual concierge data source if available
                    // For now, use placeholder
                    echo wp_json_encode( array(
                        'name' => 'Message System Operator',
                        'avatarUrl' => '',
                    ) );
                ?>;
                
                // LocalStorage key for demo mode persistence
                const DEMO_STORAGE_KEY = 'n88_board_demo_layout';
                
                // Debounce timer for localStorage saves (demo mode)
                var localStorageSaveTimer = null;

                // Initialize store
                const store = useBoardStore.getState();
                
                // For demo mode (boardId = 0), try to load from localStorage first
                if (testBoardId === 0) {
                    try {
                        const savedData = localStorage.getItem(DEMO_STORAGE_KEY);
                        if (savedData) {
                            const parsed = JSON.parse(savedData);
                            if (parsed && Array.isArray(parsed.items) && parsed.items.length > 0) {
                                const validItems = parsed.items.filter(function(item) {
                                    return item && item.id && typeof item.x === 'number' && typeof item.y === 'number';
                                });
                                if (validItems.length > 0) {
                                    // Merge saved layout data with initial items to preserve title, description, imageUrl, sizeKey
                                    const mergedItems = validItems.map(function(savedItem) {
                                        const initialItem = initialItems.find(function(initItem) {
                                            return initItem.id === savedItem.id;
                                        });
                                        if (initialItem) {
                                            // Preserve layout data from saved item, but keep metadata from initial item
                                            return {
                                                ...initialItem, // Start with initial item (has title, description, imageUrl, sizeKey)
                                                ...savedItem,   // Override with saved layout data (x, y, z, width, height, displayMode)
                                                // Explicitly preserve title, description, imageUrl, sizeKey from initial item
                                                title: initialItem.title || savedItem.title || '',
                                                description: initialItem.description || savedItem.description || '',
                                                imageUrl: initialItem.imageUrl || savedItem.imageUrl || '',
                                                sizeKey: savedItem.sizeKey || initialItem.sizeKey || 'D',
                                            };
                                        }
                                        return savedItem;
                                    });
                                    store.setItems(mergedItems);
                                    console.log('Loaded ' + mergedItems.length + ' items from localStorage (merged with initial data)');
                                } else {
                                    store.setItems(initialItems);
                                }
                            } else {
                                store.setItems(initialItems);
                            }
                        } else {
                            store.setItems(initialItems);
                        }
                    } catch (e) {
                        console.warn('Failed to load from localStorage:', e);
                        store.setItems(initialItems);
                    }
                } else {
                    // Real board - use items directly (no localStorage)
                    store.setItems(initialItems);
                }

                // Locked size presets (DO NOT CHANGE)
                const CARD_SIZES = {
                    S: { w: 160, h: 200 },
                    D: { w: 200, h: 250 }, // CURRENT DEFAULT — LOCKED
                    L: { w: 280, h: 350 },
                    XL: { w: 360, h: 450 },
                };

                // BoardItem Component (Size Presets Only - 1.3.6)
                var BoardItem = function(props) {
                    var item = props.item;
                    var onLayoutChanged = props.onLayoutChanged;
                    var _modalHandlers = props._modalHandlers; // Modal handlers from wrapper
                    
                    var bringToFront = useBoardStore(function(state) { return state.bringToFront; });
                    var updateLayout = useBoardStore(function(state) { return state.updateLayout; });
                    
                    // Local state to track if card is expanded (showing details)
                    var _expandedState = React.useState(item.displayMode === 'full');
                    var isExpanded = _expandedState[0];
                    var setIsExpanded = _expandedState[1];
                    
                    // Phase 2.1.1: Local state to track if price was requested (frontend only, no persistence)
                    var _priceState = React.useState(false);
                    var priceRequested = _priceState[0];
                    var setPriceRequested = _priceState[1];
                    
                    // Modal state for ItemDetailModal
                    var _modalState = React.useState(false);
                    var isModalOpen = _modalState[0];
                    var setIsModalOpen = _modalState[1];
                    
                    var x = useMotionValue(item.x);
                    var y = useMotionValue(item.y);

                    React.useEffect(function() {
                        x.set(item.x);
                        y.set(item.y);
                    }, [item.x, item.y]);

                    // Sync expanded state with displayMode
                    React.useEffect(function() {
                        setIsExpanded(item.displayMode === 'full');
                    }, [item.displayMode]);
                    
                    // Cleanup cooldown timer on unmount
                    React.useEffect(function() {
                        return function() {
                            if (dragCooldownTimerRef.current) {
                                clearTimeout(dragCooldownTimerRef.current);
                            }
                        };
                    }, []);

                    // Determine current size preset based on item dimensions
                    // Prefer sizeKey if available (for forward compatibility), otherwise match by dimensions
                    var getCurrentSize = function() {
                        // If sizeKey exists and is valid, use it
                        if (item.sizeKey && CARD_SIZES[item.sizeKey]) {
                            return item.sizeKey;
                        }
                        
                        // Fallback: match by dimensions (for backward compatibility)
                        var width = item.width;
                        var height = item.height;
                        for (var size in CARD_SIZES) {
                            var dims = CARD_SIZES[size];
                            if (Math.abs(width - dims.w) < 1 && Math.abs(height - dims.h) < 1) {
                                return size;
                            }
                        }
                        // Default to L if no match found
                        return 'L';
                    };

                    var currentSize = getCurrentSize();
                    
                    // Calculate z-index: XL and L items should appear above others
                    // Use item.z as base, but add extra boost for XL and L sizes
                    var calculatedZIndex = (currentSize === 'XL' || currentSize === 'L') ? item.z + 1000 : item.z;

                    // Calculate item status based on available data
                    var getItemStatus = function() {
                        // Priority 1: Action Required (unread operator messages) - highest priority
                        var hasUnreadOperatorMessages = item.has_unread_operator_messages === true || item.has_unread_operator_messages === 'true' || item.has_unread_operator_messages === 1;
                        if (hasUnreadOperatorMessages) {
                            return { text: 'Action Required', color: '#ff0000', dot: '#ff0000' };
                        }
                        
                        // Priority 2: Awaiting Payment (prototype payment requested) - Commit 2.3.9.1C
                        var hasPrototypePayment = item.has_prototype_payment === true || item.has_prototype_payment === 'true' || item.has_prototype_payment === 1;
                        var prototypePaymentStatus = item.prototype_payment_status || null;
                        if (hasPrototypePayment && prototypePaymentStatus === 'requested') {
                            return { text: 'Awaiting Payment', color: '#ff8800', dot: '#ff8800' };
                        }
                        
                        // Priority 3: Check if any bid is awarded (Commit 2.4.1)
                        var hasAwardedBid = item.has_awarded_bid === true || item.has_awarded_bid === 'true' || item.has_awarded_bid === 1 || item.has_awarded_bid === '1';
                        // Also check item meta_json for awarded status (fallback)
                        if (!hasAwardedBid && item.meta && item.meta.item_status === 'Awarded') {
                            hasAwardedBid = true;
                        }
                        if (!hasAwardedBid && item.meta && item.meta.awarded_bid_snapshot) {
                            hasAwardedBid = true;
                        }
                        if (hasAwardedBid) {
                            return { text: 'Awarded', color: '#00ff00', dot: '#00ff00' };
                        }
                        
                        // Priority 4: Check if item has award_set (In Production)
                        if (item.award_set === true || item.award_set === 'true' || item.award_set === 1 || item.award_set === '1') {
                            return { text: 'In Production', color: '#4caf50', dot: '#4caf50' };
                        }
                        
                        // Get valid bid count - only bids with status = 'submitted' and matching current revision
                        // For now, we'll use bid_count from backend which should already filter valid bids
                        var validBidCount = 0;
                        if (item.valid_bid_count !== undefined && item.valid_bid_count !== null) {
                            validBidCount = parseInt(item.valid_bid_count, 10);
                        } else if (item.bid_count !== undefined && item.bid_count !== null) {
                            validBidCount = parseInt(item.bid_count, 10);
                        } else if (item.bids_count !== undefined && item.bids_count !== null) {
                            validBidCount = parseInt(item.bids_count, 10);
                        } else if (item.bids && Array.isArray(item.bids)) {
                            // Filter valid bids: status = 'submitted' and rfq_revision_at_submit matches current
                            var currentRevision = item.rfq_revision_current || item.meta?.rfq_revision_current || null;
                            validBidCount = item.bids.filter(function(bid) {
                                if (bid.status !== 'submitted') return false;
                                if (currentRevision !== null) {
                                    var bidRevision = bid.rfq_revision_at_submit || bid.meta?.rfq_revision_at_submit;
                                    return bidRevision === currentRevision;
                                }
                                return true; // If no revision tracking, count all submitted bids
                            }).length;
                        }
                        if (isNaN(validBidCount)) validBidCount = 0;
                        
                        var hasValidBids = validBidCount > 0;
                        
                        // Check if RFQ is active for current revision
                        var isRfqActive = false;
                        if (item.has_rfq === true || item.has_rfq === 'true' || item.has_rfq === 1 || item.has_rfq === '1') {
                            isRfqActive = true;
                        } else if (item.rfq_status === 'sent' || item.rfq_status === 'submitted' || item.rfq_status === 'Sent' || item.rfq_status === 'Submitted') {
                            isRfqActive = true;
                        } else if (item.rfq_id || item.rfqId || (item.meta && item.meta.rfq_id)) {
                            isRfqActive = true;
                        }
                        
                        // Check if there are stale bids (has_warning flag indicates stale bids exist)
                        // This is more reliable than revision_changed flag
                        var hasStaleBids = item.has_warning === true || item.has_warning === 'true' || item.has_warning === 1;
                        
                        // Priority 2: If has valid bids for current revision, show "Proposals Received"
                        // This takes priority - if supplier resubmitted, we have valid bids
                        if (hasValidBids) {
                            return { text: 'Proposals Received (' + validBidCount + ')', color: '#2196f3', dot: '#2196f3' };
                        }
                        
                        // Priority 3: If no valid bids but stale bids exist (specs changed after proposals received), show Standby
                        // This means specs changed but supplier hasn't resubmitted yet
                        if (hasStaleBids && isRfqActive) {
                            // No valid bids for current revision but old bids exist - show Standby until supplier resubmits
                            return { text: 'Standby', color: '#999', dot: '#999' };
                        }
                        
                        // Priority 4: If RFQ is active but no valid bids yet
                        // E) This handles: All valid bids withdrawn + routes exist + RFQ still open → "RFQ Sent"
                        // Otherwise (no routes or RFQ closed) → falls through to "Standby"
                        if (isRfqActive) {
                            return { text: 'RFQ Sent', color: '#ff9800', dot: '#ff9800' };
                        }
                        
                        // Priority 5: Check if item has meaningful details filled by designer
                        var hasItemDetails = false;
                        if (item.title && item.title.trim() && item.title.trim() !== 'Item ' + item.id && item.title.trim() !== 'New Item') {
                            hasItemDetails = true;
                        } else if (item.description && item.description.trim() && item.description.trim().length > 10) {
                            hasItemDetails = true;
                        } else if (item.notes && item.notes.trim() && item.notes.trim().length > 10) {
                            hasItemDetails = true;
                        } else if (item.materials && (Array.isArray(item.materials) ? item.materials.length > 0 : item.materials.trim())) {
                            hasItemDetails = true;
                        } else if (item.meta) {
                            if ((item.meta.title && item.meta.title.trim() && item.meta.title.trim() !== 'Item ' + item.id) ||
                                (item.meta.description && item.meta.description.trim() && item.meta.description.trim().length > 10)) {
                                hasItemDetails = true;
                            }
                        }
                        
                        // Priority 6: If has details but no RFQ was ever sent, show Standby
                        // Also show Standby for new items (no details, no RFQ)
                        if (hasItemDetails && !isRfqActive) {
                            return { text: 'Standby', color: '#999', dot: '#999' };
                        }
                        
                        // Priority 7: Default for new items (Standby) - no details, no RFQ
                        return { text: 'Standby', color: '#999', dot: '#999' };
                    };

                    var itemStatus = getItemStatus();
                    
                    // HIGH APPROACH: Cooldown period after drag - block clicks for 2 seconds after drag ends
                    var _isDraggingState = React.useState(false);
                    var isDragging = _isDraggingState[0];
                    var setIsDragging = _isDraggingState[1];
                    
                    var _cooldownState = React.useState(false);
                    var dragCooldownActive = _cooldownState[0];
                    var setDragCooldownActive = _cooldownState[1];
                    
                    var dragCooldownTimerRef = React.useRef(null);

                    // Handle size preset selection
                    var handleSizeChange = function(size, e) {
                        if (e) {
                            e.stopPropagation();
                            e.preventDefault();
                        }
                        
                        var newSize = CARD_SIZES[size];
                        if (!newSize) return;

                        // Update layout with exact preset dimensions and sizeKey
                        updateLayout(item.id, {
                            width: newSize.w,
                            height: newSize.h,
                            sizeKey: size, // Save sizeKey for forward compatibility
                        });

                        // Trigger layout changed callback (triggers debounced save)
                        if (onLayoutChanged) {
                            onLayoutChanged({
                                id: item.id,
                                x: item.x,
                                y: item.y,
                                width: newSize.w,
                                height: newSize.h,
                                sizeKey: size,
                                displayMode: item.displayMode,
                            });
                        }
                    };

                    var handlePointerDown = function(e) {
                        // Prevent page scroll only
                        if (e && e.stopPropagation) {
                            e.stopPropagation();
                        }
                        
                        // Bring item to front on pointer down (click or drag start)
                        // Compute maxZ accounting for L/XL boost (they get +1000 to calculated z-index)
                        var currentItems = window.N88StudioOS.useBoardStore.getState().items;
                        
                        // Calculate max calculated z-index considering L/XL boost
                        var maxCalculatedZ = Math.max.apply(Math, currentItems.map(function(i) {
                            var baseZ = i.z || 0;
                            // Determine size for this item (same logic as getCurrentSize)
                            var itemSize = 'L';
                            if (i.sizeKey && CARD_SIZES[i.sizeKey]) {
                                itemSize = i.sizeKey;
                            } else {
                                // Fallback: match by dimensions
                                var width = i.width;
                                var height = i.height;
                                for (var size in CARD_SIZES) {
                                    var dims = CARD_SIZES[size];
                                    if (Math.abs(width - dims.w) < 1 && Math.abs(height - dims.h) < 1) {
                                        itemSize = size;
                                        break;
                                    }
                                }
                            }
                            // Apply same boost as calculatedZIndex
                            return (itemSize === 'XL' || itemSize === 'L') ? baseZ + 1000 : baseZ;
                        }).concat([0]));
                        
                        // Get current item's calculated z-index
                        var currentCalculatedZ = calculatedZIndex;
                        
                        // Only update if not already at max (compare calculated z-indexes)
                        if (currentCalculatedZ !== maxCalculatedZ) {
                            // Calculate what base z value we need to set
                            var newZ;
                            if (currentSize === 'XL' || currentSize === 'L') {
                                // For L/XL: newZ + 1000 should be > maxCalculatedZ
                                var maxBaseZ = Math.max.apply(Math, currentItems.map(function(i) { return i.z || 0; }).concat([0]));
                                newZ = Math.max(maxBaseZ + 1, maxCalculatedZ - 1000 + 1);
                            } else {
                                // For regular items: newZ should be > maxCalculatedZ
                                var maxBaseZ = Math.max.apply(Math, currentItems.map(function(i) { return i.z || 0; }).concat([0]));
                                newZ = Math.max(maxBaseZ + 1, maxCalculatedZ + 1);
                            }
                            
                            // Update z via updateLayout (triggers state update)
                            updateLayout(item.id, { z: newZ });
                            
                            // Trigger save with updated z-index so stacking order persists
                            if (onLayoutChanged) {
                                onLayoutChanged({
                                    id: item.id,
                                    x: item.x,
                                    y: item.y,
                                    z: newZ,
                                    width: item.width,
                                    height: item.height,
                                    displayMode: item.displayMode,
                                });
                            }
                        }
                    };

                    var handleDragStart = function(e) {
                        // Don't prevent default - allow dragging
                        // Only stop propagation to prevent page scroll
                        if (e && e.stopPropagation) {
                            e.stopPropagation();
                        }
                        
                        // HIGH APPROACH: Mark that drag is in progress - BLOCK ALL CLICKS
                        setIsDragging(true);
                        setDragCooldownActive(true); // Start blocking immediately
                        
                        // Clear any existing cooldown timer
                        if (dragCooldownTimerRef.current) {
                            clearTimeout(dragCooldownTimerRef.current);
                            dragCooldownTimerRef.current = null;
                        }
                        
                        // Bring to front on drag start (same as pointer down)
                        handlePointerDown(e);
                    };

                    var handleDragEnd = function(event, info) {
                        // Check if item was actually dragged (moved more than a few pixels)
                        var dragDistance = Math.sqrt(Math.pow(info.delta.x, 2) + Math.pow(info.delta.y, 2));
                        
                        // Reset isDragging flag - drag has ended
                        setIsDragging(false);
                        
                        // HIGH APPROACH: If drag distance is significant, start 2-second cooldown period
                        // During cooldown, ALL clicks are blocked to prevent modal opening
                        if (dragDistance > 5) {
                            // Significant drag occurred - start 2 second cooldown
                            setDragCooldownActive(true);
                            
                            // Clear any existing timer
                            if (dragCooldownTimerRef.current) {
                                clearTimeout(dragCooldownTimerRef.current);
                            }
                            
                            // After 2 seconds, allow clicks again
                            dragCooldownTimerRef.current = setTimeout(function() {
                                setDragCooldownActive(false);
                                dragCooldownTimerRef.current = null;
                            }, 2000); // 2 seconds cooldown period
                        } else {
                            // Very small movement - might be accidental, allow clicks immediately
                            setDragCooldownActive(false);
                            if (dragCooldownTimerRef.current) {
                                clearTimeout(dragCooldownTimerRef.current);
                                dragCooldownTimerRef.current = null;
                            }
                        }
                        
                        var newX = x.get();
                        var newY = y.get();
                        
                        // Get current z-index from store (may have changed via bringToFront)
                        var currentItems = window.N88StudioOS.useBoardStore.getState().items;
                        var currentItem = currentItems.find(function(i) { return i.id === item.id; });
                        var currentZ = currentItem ? currentItem.z : item.z;
                        
                        updateLayout(item.id, { x: newX, y: newY });
                        if (onLayoutChanged) {
                            onLayoutChanged({ 
                                id: item.id, 
                                x: newX, 
                                y: newY, 
                                z: currentZ,
                                width: item.width, 
                                height: item.height, 
                                displayMode: item.displayMode 
                            });
                        }
                    };
                    
                    // HIGH APPROACH: Handle click on image area - check cooldown period
                    var handleImageClick = function(e) {
                        // Don't open modal if clicking on interactive elements (buttons, etc.)
                        if (e.target.closest('button')) {
                            return;
                        }
                        
                        // HIGH APPROACH: If in cooldown period or currently dragging, BLOCK modal completely
                        if (dragCooldownActive || isDragging) {
                            if (e && e.preventDefault) {
                                e.preventDefault();
                            }
                            if (e && e.stopPropagation) {
                                e.stopPropagation();
                            }
                            return; // Exit immediately - don't allow modal
                        }
                        
                        // If not in cooldown and not dragging, allow click to open modal
                        setTimeout(function() {
                            // Final check: verify still not in cooldown or dragging
                            if (!dragCooldownActive && !isDragging) {
                                if (_modalHandlers && _modalHandlers.open) {
                                    _modalHandlers.open();
                                } else if (typeof setIsModalOpen === 'function') {
                                    setIsModalOpen(true);
                                }
                            }
                        }, 100);
                    };

                    return React.createElement(motion.div, {
                        layoutId: 'board-item-' + item.id,
                        style: { position: 'absolute', x: x, y: y, width: item.width, height: item.height, zIndex: calculatedZIndex, cursor: 'grab', overflow: 'visible' },
                        drag: true,
                        dragMomentum: false,
                        onPointerDown: handlePointerDown,
                        onDragStart: handleDragStart,
                        onDragEnd: handleDragEnd,
                        whileDrag: { cursor: 'grabbing', scale: 1.05 },
                        transition: { layout: { duration: 0.3, ease: 'easeOut' } },
                        dragConstraints: false,
                        dragElastic: 0,
                        onClick: function(e) {
                            // Prevent page scroll on click
                            if (e) {
                                e.stopPropagation();
                            }
                        },
                        onMouseDown: function(e) {
                            // Prevent page scroll on mouse down
                            if (e) {
                                e.stopPropagation();
                            }
                        }
                    }, React.createElement('div', {
                        style: { 
                            width: '100%', 
                            height: '100%', 
                            backgroundColor: '#ffffff', 
                            border: '1px solid #e0e0e0', 
                            borderRadius: '8px', 
                            overflow: 'visible', 
                            boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)', 
                            position: 'relative',
                            display: 'flex',
                            flexDirection: 'column',
                            boxSizing: 'border-box',
                            cursor: 'pointer'
                        }
                    }, 
                    // Photo Section - 75% of card
                    React.createElement('div', {
                        onClick: handleImageClick,
                        style: { 
                            width: '100%', 
                            flex: '0 0 75%',
                            minHeight: 0,
                            backgroundColor: '#e0e0e0', 
                            backgroundImage: item.imageUrl ? 'url(' + item.imageUrl + ')' : 'none',
                            backgroundSize: 'cover',
                            backgroundPosition: 'center',
                            backgroundRepeat: 'no-repeat',
                            position: 'relative',
                            boxSizing: 'border-box',
                            overflow: 'hidden',
                            borderTopLeftRadius: '8px',
                            borderTopRightRadius: '8px',
                            cursor: 'pointer'
                        }
                    }, 
                    !item.imageUrl ? React.createElement('div', { style: { textAlign: 'center', position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', backgroundColor: 'rgba(255,255,255,0.8)', padding: '4px 8px', borderRadius: '4px' } }, item.title || ('Item ' + item.id)) : null,
                    // Delete button - always visible
                    React.createElement('button', {
                        onClick: function(e) {
                            e.stopPropagation();
                            e.preventDefault();
                            if (window.confirm('Are you sure you want to delete this item?')) {
                                var boardId = props.boardId || 0;
                                if (!boardId || boardId === 0) {
                                    alert('Cannot delete item: Board ID is missing.');
                                    return;
                                }
                                
                                // Extract numeric ID from item.id (handles both "item-5" and "5" formats)
                                var itemId = item.id;
                                if (typeof itemId === 'string' && itemId.indexOf('item-') === 0) {
                                    itemId = parseInt(itemId.replace('item-', ''), 10);
                                } else if (typeof itemId === 'string') {
                                    itemId = parseInt(itemId, 10);
                                }
                                
                                if (isNaN(itemId) || itemId <= 0) {
                                    alert('Invalid item ID. Cannot delete item.');
                                    return;
                                }
                                
                                fetch(window.n88BoardData && window.n88BoardData.ajaxUrl ? window.n88BoardData.ajaxUrl : '/wp-admin/admin-ajax.php', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: new URLSearchParams({
                                        action: 'n88_remove_item_from_board',
                                        board_id: boardId,
                                        item_id: itemId,
                                        nonce: window.n88BoardData && window.n88BoardData.nonce ? window.n88BoardData.nonce : '',
                                    }),
                                }).then(function(response) {
                                    return response.json();
                                }).then(function(data) {
                                    if (data.success) {
                                        // Remove item from store - use the item_id from response for accurate matching
                                        var deletedItemId = data.data && data.data.item_id ? parseInt(data.data.item_id, 10) : null;
                                        var currentItems = window.N88StudioOS.useBoardStore.getState().items;
                                        
                                        // If we have the deleted item ID from response, use it; otherwise fall back to item.id
                                        var itemIdToRemove = deletedItemId || itemId;
                                        
                                        // Filter out the deleted item by comparing numeric IDs
                                        var updatedItems = currentItems.filter(function(i) {
                                            // Extract numeric ID from item.id (handles "item-5", "5", or 5)
                                            var currentNumericId = null;
                                            if (typeof i.id === 'string' && i.id.indexOf('item-') === 0) {
                                                currentNumericId = parseInt(i.id.replace('item-', ''), 10);
                                            } else if (typeof i.id === 'string') {
                                                currentNumericId = parseInt(i.id, 10);
                                            } else {
                                                currentNumericId = parseInt(i.id, 10);
                                            }
                                            
                                            // Compare with deleted item ID
                                            return currentNumericId !== itemIdToRemove;
                                        });
                                        
                                        // Update store with filtered items
                                        window.N88StudioOS.useBoardStore.getState().setItems(updatedItems);
                                        
                                        // Update item count display immediately
                                        var countElement = document.querySelector('span[data-item-count]');
                                        if (countElement) {
                                            countElement.textContent = updatedItems.length;
                                        }
                                        
                                        // Force a re-render by triggering layout update
                                        if (typeof onLayoutChanged === 'function') {
                                            onLayoutChanged();
                                        }
                                    } else {
                                        alert(data.data && data.data.message ? data.data.message : 'Failed to delete item. Please try again.');
                                    }
                                }).catch(function(error) {
                                    console.error('Error deleting item:', error);
                                    alert('An error occurred while deleting the item. Please try again.');
                                });
                            }
                        },
                        style: {
                            position: 'absolute',
                            top: '10px',
                            right: '10px',
                            width: '24px',
                            height: '24px',
                            padding: 0,
                            fontSize: '16px',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            backgroundColor: '#d32f2f',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '50%',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.3)',
                            transition: 'all 0.2s',
                            zIndex: 20,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            lineHeight: '1',
                        },
                        onMouseEnter: function(e) {
                            e.target.style.backgroundColor = '#b71c1c';
                            e.target.style.transform = 'scale(1.1)';
                        },
                        onMouseLeave: function(e) {
                            e.target.style.backgroundColor = '#d32f2f';
                            e.target.style.transform = 'scale(1)';
                        },
                        title: 'Delete item'
                    }, '×')
                    )
                    ,
                    // Status Strip - 25% of card, below the image
                    React.createElement('div', {
                        style: {
                            width: '100%',
                            flex: '0 0 25%',
                            backgroundColor: '#ffffff',
                            borderTop: '1px solid #e0e0e0',
                            padding: (currentSize === 'S' || currentSize === 'D') ? '6px 8px' : '8px 12px',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '6px',
                            boxSizing: 'border-box',
                            minHeight: 0,
                            overflow: 'visible',
                            position: 'relative',
                            borderBottomLeftRadius: '8px',
                            borderBottomRightRadius: '8px'
                        }
                    },
                        // Status Text with Dot
                        React.createElement('div', {
                            style: {
                                display: 'flex',
                                flexDirection: 'row',
                                alignItems: 'center',
                                gap: '6px',
                                fontSize: (currentSize === 'S' || currentSize === 'D') ? '9px' : '10px',
                                color: '#333'
                            }
                        },
                            React.createElement('span', {
                                style: {
                                    width: '8px',
                                    height: '8px',
                                    borderRadius: '50%',
                                    backgroundColor: itemStatus.dot,
                                    display: 'inline-block',
                                    flexShrink: 0
                                }
                            }),
                            React.createElement('span', {
                                style: {
                                    fontWeight: 500,
                                    lineHeight: '1.2',
                                    wordBreak: 'break-word',
                                    whiteSpace: 'nowrap',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis'
                                }
                            }, itemStatus.text),
                            // Action Required Indicator (if needed)
                            item.action_required ? React.createElement('span', {
                                style: {
                                    fontSize: '10px',
                                    color: '#ff9800',
                                    marginLeft: '4px',
                                    flexShrink: 0
                                },
                                title: 'Action Required'
                            }, '⚠') : null
                        ),
                        // Sizes Button Row - Show all sizes inline
                        React.createElement('div', {
                            style: {
                                display: 'flex',
                                gap: '4px',
                                alignItems: 'center'
                            },
                            'data-sizes-container': true
                        }, ['S', 'D', 'L', 'XL'].map(function(size) {
                            return React.createElement('button', {
                                key: size,
                                onClick: function(e) {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    handleSizeChange(size, e);
                                },
                                style: {
                                    padding: (currentSize === 'S' || currentSize === 'D') ? '3px 6px' : '4px 8px',
                                    fontSize: (currentSize === 'S' || currentSize === 'D') ? '9px' : '10px',
                                    fontWeight: currentSize === size ? 'bold' : 'normal',
                                    cursor: 'pointer',
                                    backgroundColor: currentSize === size ? '#0073aa' : '#f0f0f0',
                                    color: currentSize === size ? '#fff' : '#333',
                                    border: '1px solid ' + (currentSize === size ? '#0073aa' : '#ccc'),
                                    borderRadius: '3px',
                                    transition: 'all 0.2s',
                                    minWidth: (currentSize === 'S' || currentSize === 'D') ? '24px' : '28px',
                                    flex: 1
                                },
                                onMouseEnter: function(e) {
                                    if (currentSize !== size) {
                                        e.target.style.backgroundColor = '#e0e0e0';
                                    }
                                },
                                onMouseLeave: function(e) {
                                    if (currentSize !== size) {
                                        e.target.style.backgroundColor = '#f0f0f0';
                                    }
                                },
                                title: 'Set size to ' + size
                            }, size);
                        }))
                    )
                )
                );

                };

                // Commit 1.3.8: Item Detail Modal Component (full inline version)
                // Helper functions for computation
                /**
                 * Normalize dimensions to cm
                 */
                var normalizeToCm = function(value, unit) {
                    if (!value || isNaN(value)) return null;
                    var num = parseFloat(value);
                    switch (unit) {
                        case 'mm': return num / 10;
                        case 'cm': return num;
                        case 'm': return num * 100;
                        case 'in': return num * 2.54;
                        default: return num;
                    }
                };
                
                /**
                 * Calculate CBM (Cubic Meters) - per unit
                 * Formula: (W_cm × D_cm × H_cm) / 1,000,000
                 * This is equivalent to:
                 * - Inches: (W × D × H) / 61023.7441
                 * - Centimeters: (W × D × H) / 1,000,000
                 * - Millimeters: (W × D × H) / 1,000,000,000
                 * - Meters: W × D × H
                 */
                var calculateCBM = function(wCm, dCm, hCm) {
                    if (!wCm || !dCm || !hCm) return null;
                    // Convert cm to meters, then calculate volume
                    var wM = wCm / 100;
                    var dM = dCm / 100;
                    var hM = hCm / 100;
                    // Calculate CBM and round to 3 decimal places
                    return Math.round((wM * dM * hM) * 1000) / 1000;
                };
                
                /**
                 * Calculate Total CBM (item_cbm × quantity)
                 * Formula: total_cbm = item_cbm × quantity
                 * Returns value rounded to 3 decimal places
                 */
                var calculateTotalCBM = function(itemCbm, quantity) {
                    if (!itemCbm || itemCbm === null || itemCbm === undefined) return null;
                    if (!quantity || quantity === null || quantity === undefined || quantity === '' || quantity === 0) return null;
                    var qty = parseInt(quantity);
                    if (isNaN(qty) || qty <= 0) return null;
                    // Calculate total CBM and round to 3 decimal places
                    return Math.round((itemCbm * qty) * 1000) / 1000;
                };
                
                var inferSourcingType = function(category, description) {
                    var furnitureCategories = ['sofa', 'chair', 'table', 'desk', 'cabinet', 'shelf', 'bed', 'furniture'];
                    var sourcingCategories = ['electronics', 'hardware', 'fixture', 'lighting', 'appliance'];
                    
                    var catLower = (category || '').toLowerCase();
                    var descLower = (description || '').toLowerCase();
                    
                    // Check category match
                    for (var i = 0; i < furnitureCategories.length; i++) {
                        if (catLower.indexOf(furnitureCategories[i]) !== -1) {
                            return 'furniture';
                        }
                    }
                    for (var j = 0; j < sourcingCategories.length; j++) {
                        if (catLower.indexOf(sourcingCategories[j]) !== -1) {
                            return 'global_sourcing';
                        }
                    }
                    
                    // Keyword scan in description
                    var furnitureKeywords = ['furniture', 'upholstery', 'cushion', 'fabric', 'wood', 'metal frame'];
                    var sourcingKeywords = ['electronic', 'component', 'hardware', 'fixture', 'bulb', 'led'];
                    
                    for (var k = 0; k < furnitureKeywords.length; k++) {
                        if (descLower.indexOf(furnitureKeywords[k]) !== -1) {
                            return 'furniture';
                        }
                    }
                    for (var l = 0; l < sourcingKeywords.length; l++) {
                        if (descLower.indexOf(sourcingKeywords[l]) !== -1) {
                            return 'global_sourcing';
                        }
                    }
                    
                    // Default to furniture
                    return 'furniture';
                };
                
                var assignTimelineType = function(sourcingType) {
                    return sourcingType === 'furniture' ? 'furniture_6_step' : 'sourcing_4_step';
                };
                
                // Bid Item Component for inline version
                // Commit 2.3.6: Bid Comparison Matrix Component - Read-only matrix view
                var BidComparisonMatrixInline = function(matrixProps) {
                    var bids = matrixProps.bids;
                    var darkBorder = matrixProps.darkBorder;
                    var greenAccent = matrixProps.greenAccent;
                    var darkText = matrixProps.darkText || '#d3d3d3';
                    var darkBg = matrixProps.darkBg || '#000000';
                    var onImageClick = matrixProps.onImageClick;
                    var smartAlternativesEnabled = matrixProps.smartAlternativesEnabled || false;
                    var itemId = matrixProps.itemId || null; // Commit 2.4.1: Item ID for award bid action
                    
                    // Order bids by created_at ASC (already ordered from backend, but ensure stability)
                    var orderedBids = bids.slice().sort(function(a, b) {
                        var dateA = new Date(a.created_at || 0);
                        var dateB = new Date(b.created_at || 0);
                        return dateA - dateB;
                    });
                    
                    // Track expanded state per bid column
                    var _expandedSmartAltState = React.useState({});
                    var expandedSmartAltByBidId = _expandedSmartAltState[0];
                    var setExpandedSmartAltByBidId = _expandedSmartAltState[1];
                    
                    var toggleSmartAltExpanded = function(bidId) {
                        setExpandedSmartAltByBidId(function(prev) {
                            var next = {};
                            for (var key in prev) {
                                next[key] = prev[key];
                            }
                            next[bidId] = !prev[bidId];
                            return next;
                        });
                    };
                    
                    // Helper to get supplier label (A, B, C, etc.)
                    var getSupplierLabel = function(idx) {
                        return String.fromCharCode(65 + idx);
                    };
                    
                    // Helper to render media (videos + photos)
                    var renderMedia = function(bid, compact) {
                        if (compact === undefined) compact = false;
                        var videoLinksByProvider = bid.video_links_by_provider || {
                            youtube: [],
                            vimeo: [],
                            loom: [],
                        };
                        var allVideos = [
                            ...(videoLinksByProvider.youtube || []).slice(0, 3).map(function(u) { return { provider: 'YouTube', url: u }; }),
                            ...(videoLinksByProvider.vimeo || []).slice(0, 3).map(function(u) { return { provider: 'Vimeo', url: u }; }),
                            ...(videoLinksByProvider.loom || []).slice(0, 3).map(function(u) { return { provider: 'Loom', url: u }; }),
                        ].slice(0, 3);
                        var photos = bid.photo_urls || [];
                        var hasMedia = allVideos.length > 0 || photos.length > 0;
                        
                        if (!hasMedia) {
                            return null;
                        }
                        
                        return React.createElement('div', {
                            style: { display: 'flex', flexDirection: 'column', gap: compact ? '2px' : '4px' }
                        },
                            allVideos.length > 0 ? React.createElement('div', {
                                    style: { display: 'flex', flexDirection: 'column', gap: '2px' }
                                },
                                allVideos.map(function(video, idx) {
                                        return React.createElement('a', {
                                        key: 'video-' + idx,
                                        href: video.url,
                                            target: '_blank',
                                            rel: 'noopener noreferrer',
                                        style: { fontSize: compact ? '10px' : '11px', color: greenAccent, textDecoration: 'none' },
                                            onClick: function(e) { e.stopPropagation(); }
                                    }, '[' + video.provider + ' ►]');
                                })
                            ) : null,
                            photos.length > 0 ? React.createElement('div', {
                                style: { display: 'flex', flexWrap: 'wrap', gap: '4px', marginTop: allVideos.length > 0 ? '2px' : '0' }
                                },
                                    photos.slice(0, 3).map(function(url, idx) {
                                        return React.createElement('img', {
                                            key: 'photo-' + idx,
                                            src: url,
                                            alt: '',
                                            onClick: function(e) {
                                                e.stopPropagation();
                                                if (onImageClick) {
                                                    onImageClick(url);
                                                } else {
                                                    window.open(url, '_blank');
                                                }
                                            },
                                            style: {
                                            width: compact ? '28px' : '32px',
                                            height: compact ? '28px' : '32px',
                                                objectFit: 'cover',
                                                cursor: 'pointer',
                                                border: '1px solid ' + darkBorder,
                                                borderRadius: '2px',
                                            }
                                        });
                                    })
                            ) : null
                        );
                    };
                    
                    // Helper to format prototype
                    var formatPrototype = function(bid) {
                        var parts = [];
                        if (bid.prototype_commitment) {
                            parts.push('YES');
                        } else {
                            parts.push('NO');
                        }
                        if (bid.prototype_timeline) {
                            parts.push(bid.prototype_timeline);
                        }
                        if (bid.prototype_cost !== null) {
                            parts.push('$' + bid.prototype_cost);
                        }
                        return parts.length > 0 ? parts.join(' · ') : '—';
                    };
                    
                    // Helper to format Smart Alternatives
                    var formatSmartAlt = function(bid) {
                        var sa = bid.smart_alternatives_suggestion;
                        if (!sa || typeof sa !== 'object') {
                            return '—';
                        }
                        // Check for data using correct field names (comparison_points, not comparisons)
                        var hasData = sa.from || sa.to || sa.category || (sa.comparison_points && sa.comparison_points.length > 0) || (sa.comparisons && sa.comparisons.length > 0);
                        if (!hasData) {
                            return '—';
                        }
                        var parts = [];
                        
                        // Format category
                        var categoryLabels = {
                            'material': 'Material',
                            'finish': 'Finish',
                            'hardware': 'Hardware',
                            'dimensions': 'Dimensions',
                            'construction': 'Construction Method',
                            'packaging': 'Packaging'
                        };
                        if (sa.category) {
                            parts.push(categoryLabels[sa.category] || sa.category.charAt(0).toUpperCase() + sa.category.slice(1));
                        }
                        
                        // Format From → To
                        if (sa.from && sa.to) {
                            var formatLabel = function(str) {
                                if (!str) return '';
                                var labels = {
                                    'solid-wood': 'Solid Wood', 'plywood': 'Plywood', 'mdf': 'MDF',
                                    'metal': 'Metal', 'plastic': 'Plastic', 'glass': 'Glass',
                                    'fabric': 'Fabric', 'leather': 'Leather', 'other': 'Other'
                                };
                                return labels[str] || str.split('-').map(function(word) {
                                    return word.charAt(0).toUpperCase() + word.slice(1);
                                }).join(' ');
                            };
                            parts.push(formatLabel(sa.from) + ' → ' + formatLabel(sa.to));
                        }
                        
                        // Format comparison points
                        var comparisonLabels = {
                            'cost-reduction': 'Cost Reduction',
                            'faster-production': 'Faster Production',
                            'better-durability': 'Better Durability',
                            'easier-sourcing': 'Easier Sourcing',
                            'lighter-weight': 'Lighter Weight',
                            'eco-friendly': 'Eco-Friendly'
                        };
                        var comparisonPoints = sa.comparison_points || sa.comparisons || [];
                        if (Array.isArray(comparisonPoints) && comparisonPoints.length > 0) {
                            var formattedComparisons = comparisonPoints.map(function(cp) {
                                return comparisonLabels[cp] || cp;
                            }).join(', ');
                            parts.push('(' + formattedComparisons + ')');
                        }
                        
                        // Format impacts
                        if (sa.price_impact || sa.lead_time_impact) {
                            var impacts = [];
                            if (sa.price_impact) {
                                if (sa.price_impact.indexOf('reduces') !== -1) {
                                    impacts.push('-' + sa.price_impact.replace('reduces-', '').replace('-', '-') + '% price');
                                } else if (sa.price_impact.indexOf('increases') !== -1) {
                                    impacts.push('+' + sa.price_impact.replace('increases-', '').replace('-', '-') + '% price');
                                } else if (sa.price_impact === 'similar') {
                                    impacts.push('same price');
                                }
                            }
                            if (sa.lead_time_impact) {
                                if (sa.lead_time_impact.indexOf('reduces') !== -1) {
                                    impacts.push('-' + sa.lead_time_impact.replace('reduces-', '') + ' LT');
                                } else if (sa.lead_time_impact.indexOf('increases') !== -1) {
                                    impacts.push('+' + sa.lead_time_impact.replace('increases-', '') + ' LT');
                                } else if (sa.lead_time_impact === 'similar') {
                                    impacts.push('same LT');
                                }
                            }
                            if (impacts.length > 0) {
                                parts.push(impacts.join(' | '));
                            }
                        }
                        return parts.length > 0 ? parts.join(' · ') : '—';
                    };
                    
                    if (orderedBids.length === 0) {
                        return null;
                    }
                    
                    // Single bid: Show compact detail box
                    if (orderedBids.length === 1) {
                        var bid = orderedBids[0];
                        var media = renderMedia(bid, true);
                    
                    return React.createElement('div', {
                        style: {
                                border: '1px solid ' + darkBorder,
                                borderRadius: '4px',
                                backgroundColor: '#111111',
                                padding: '12px',
                            }
                        },
                            React.createElement('div', {
                                style: { fontSize: '13px', fontWeight: '600', marginBottom: '10px', color: darkText }
                            }, 'Supplier A'),
                            React.createElement('div', {
                                style: { display: 'flex', flexDirection: 'column', gap: '8px' }
                            },
                                media ? React.createElement('div', null,
                                    React.createElement('div', {
                                        style: { fontSize: '10px', color: darkText, marginBottom: '4px', opacity: 0.7 }
                                    }, 'Media'),
                                    media
                                ) : null,
                                React.createElement('div', null,
                                    React.createElement('div', {
                                        style: { fontSize: '10px', color: darkText, marginBottom: '2px', opacity: 0.7 }
                                    }, 'Prototype'),
                                    React.createElement('div', {
                                        style: { fontSize: '11px', color: greenAccent }
                                    }, formatPrototype(bid))
                                ),
                                bid.production_lead_time ? React.createElement('div', null,
                                    React.createElement('div', {
                                        style: { fontSize: '10px', color: darkText, marginBottom: '2px', opacity: 0.7 }
                                    }, 'Production Lead Time'),
                                    React.createElement('div', {
                                        style: { fontSize: '11px', color: greenAccent }
                                    }, bid.production_lead_time)
                                ) : null,
                                bid.unit_price !== null ? React.createElement('div', null,
                                    React.createElement('div', {
                                        style: { fontSize: '10px', color: darkText, marginBottom: '2px', opacity: 0.7 }
                                    }, 'Unit Price'),
                                    React.createElement('div', {
                                        style: { fontSize: '11px', color: greenAccent }
                                    }, '$' + bid.unit_price),
                                    bid.total_price && bid.item_quantity && bid.item_quantity > 1 ? React.createElement('div', {
                                        style: { fontSize: '9px', color: darkText, marginTop: '2px', opacity: 0.7 }
                                    }, 'Total: $' + parseFloat(bid.total_price).toFixed(2) + ' (' + bid.unit_price + ' × ' + bid.item_quantity + ')') : null
                                ) : null,
                                (bid.delivery_cost_usd != null && bid.delivery_cost_usd !== '' && (typeof bid.delivery_cost_usd === 'number' || !isNaN(parseFloat(bid.delivery_cost_usd)))) ? React.createElement('div', null,
                                    React.createElement('div', {
                                        style: { fontSize: '10px', color: darkText, marginBottom: '2px', opacity: 0.7 }
                                    }, 'Door-to-Door Delivery'),
                                    React.createElement('div', {
                                        style: { fontSize: '11px', color: greenAccent }
                                    }, '$' + parseFloat(bid.delivery_cost_usd).toFixed(2)),
                                    bid.delivery_shipping_mode ? React.createElement('div', {
                                        style: { fontSize: '9px', color: darkText, marginTop: '2px', opacity: 0.6 }
                                    }, 'Mode: ' + (bid.delivery_shipping_mode === 'LCL' ? 'LCL' : bid.delivery_shipping_mode === 'FCL_20' ? '20\' Container' : bid.delivery_shipping_mode === 'FCL_40HQ' ? '40\' HQ Container' : bid.delivery_shipping_mode)) : null
                                ) : null,
                                // Commit 2.4.1: Award Bid Button
                                bid.can_award && !bid.is_awarded && !bid.is_declined ? React.createElement('div', {
                                    style: { marginTop: '12px', marginBottom: '8px' }
                                },
                                    React.createElement('button', {
                                        onClick: function() {
                                            if (!window.confirm('Are you sure you want to award this bid? All other bids will be declined.')) {
                                                return;
                                            }
                                            
                                            var ajaxUrl = window.n88BoardData && window.n88BoardData.ajaxUrl ? window.n88BoardData.ajaxUrl : (window.n88 && window.n88.ajaxUrl ? window.n88.ajaxUrl : '/wp-admin/admin-ajax.php');
                                            var nonce = '';
                                            if (window.n88BoardNonce && window.n88BoardNonce.nonce_award_bid) {
                                                nonce = window.n88BoardNonce.nonce_award_bid;
                                            } else if (window.n88BoardData && window.n88BoardData.nonce) {
                                                nonce = window.n88BoardData.nonce;
                                            } else if (window.n88 && window.n88.nonce) {
                                                nonce = window.n88.nonce;
                                            }
                                            
                                            if (!nonce) {
                                                alert('Security token missing. Please refresh the page and try again.');
                                                return;
                                            }
                                            
                                            var formData = new FormData();
                                            formData.append('action', 'n88_award_bid');
                                            formData.append('item_id', itemId);
                                            formData.append('bid_id', bid.bid_id);
                                            formData.append('_ajax_nonce', nonce);
                                            
                                            fetch(ajaxUrl, {
                                                method: 'POST',
                                                body: formData
                                            })
                                            .then(function(response) {
                                                return response.json();
                                            })
                                            .then(function(data) {
                                                if (data.success) {
                                                    alert('Bid awarded successfully!');
                                                    window.location.reload();
                                                } else {
                                                    alert('Error: ' + (data.data && data.data.message ? data.data.message : 'Failed to award bid'));
                                                }
                                            })
                                            .catch(function(error) {
                                                console.error('Error awarding bid:', error);
                                                alert('Error awarding bid. Please try again.');
                                            });
                                        },
                                        style: {
                                            padding: '10px 20px',
                                            backgroundColor: '#00ff00',
                                            color: '#000',
                                            border: 'none',
                                            borderRadius: '4px',
                                            fontSize: '12px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            fontFamily: 'monospace',
                                            width: '100%',
                                        },
                                        onMouseOver: function(e) {
                                            e.target.style.backgroundColor = '#00cc00';
                                        },
                                        onMouseOut: function(e) {
                                            e.target.style.backgroundColor = '#00ff00';
                                        }
                                    }, '[ Award Bid ]')
                                ) : null,
                                // Commit 2.4.1: Awarded Status Badge
                                bid.is_awarded ? React.createElement('div', {
                                    style: {
                                        marginTop: '12px',
                                        marginBottom: '8px',
                                        padding: '10px',
                                        backgroundColor: '#003300',
                                        border: '1px solid #00ff00',
                                        borderRadius: '4px',
                                        fontSize: '12px',
                                        color: '#00ff00',
                                        fontWeight: '600',
                                        textAlign: 'center',
                                    }
                                }, '✓ Bid Awarded') : null,
                                // Commit 2.4.1: Declined Status
                                bid.is_declined ? React.createElement('div', {
                                    style: {
                                        marginTop: '12px',
                                        marginBottom: '8px',
                                        padding: '10px',
                                        backgroundColor: '#330000',
                                        border: '1px solid #ff6666',
                                        borderRadius: '4px',
                                        fontSize: '12px',
                                        color: '#ff6666',
                                        textAlign: 'center',
                                    }
                                }, 'Bid Declined') : null,
                                (function() {
                                    if (!smartAlternativesEnabled) return null;
                                    var sa = bid.smart_alternatives_suggestion;
                                    var hasNote = bid.bid_smart_alternatives_note && bid.bid_smart_alternatives_note.trim();
                                    var hasDetails = sa && (sa.category || sa.from || sa.to || (sa.comparison_points && sa.comparison_points.length > 0));
                                    var hasContent = hasNote || hasDetails;
                                    if (!hasContent) return null;
                                    
                                    var _smartAltExpandedState = React.useState(false);
                                    var isSmartAltExpanded = _smartAltExpandedState[0];
                                    var setIsSmartAltExpanded = _smartAltExpandedState[1];
                                    
                                    var formatFullDetails = function() {
                                        var parts = [];
                                        if (sa) {
                                            var categoryLabels = {
                                                'material': 'Material',
                                                'finish': 'Finish',
                                                'hardware': 'Hardware',
                                                'dimensions': 'Dimensions',
                                                'construction': 'Construction Method',
                                                'packaging': 'Packaging'
                                            };
                                            if (sa.category) {
                                                parts.push('Category: ' + (categoryLabels[sa.category] || sa.category));
                                            }
                                            if (sa.from && sa.to) {
                                                var formatLabel = function(str) {
                                                    if (!str) return '';
                                                    var labels = {
                                                        'solid-wood': 'Solid Wood', 'plywood': 'Plywood', 'mdf': 'MDF',
                                                        'metal': 'Metal', 'plastic': 'Plastic', 'glass': 'Glass',
                                                        'fabric': 'Fabric', 'leather': 'Leather', 'other': 'Other'
                                                    };
                                                    return labels[str] || str.split('-').map(function(word) {
                                                        return word.charAt(0).toUpperCase() + word.slice(1);
                                                    }).join(' ');
                                                };
                                                parts.push('From: ' + formatLabel(sa.from) + ' → To: ' + formatLabel(sa.to));
                                            }
                                            if (sa.comparison_points && sa.comparison_points.length > 0) {
                                                var comparisonLabels = {
                                                    'cost-reduction': 'Cost Reduction',
                                                    'faster-production': 'Faster Production',
                                                    'better-durability': 'Better Durability',
                                                    'easier-sourcing': 'Easier Sourcing',
                                                    'lighter-weight': 'Lighter Weight',
                                                    'eco-friendly': 'Eco-Friendly'
                                                };
                                                var comparisons = sa.comparison_points.map(function(cp) {
                                                    return comparisonLabels[cp] || cp;
                                                }).join(', ');
                                                parts.push('Comparison Points: ' + comparisons);
                                            }
                                            if (sa.price_impact) {
                                                var priceLabels = {
                                                    'reduces-10-20': 'Reduces 10-20%',
                                                    'reduces-20-30': 'Reduces 20-30%',
                                                    'reduces-30-plus': 'Reduces 30%+',
                                                    'similar': 'Similar Price',
                                                    'increases-10-20': 'Increases 10-20%',
                                                    'increases-20-plus': 'Increases 20%+'
                                                };
                                                parts.push('Price Impact: ' + (priceLabels[sa.price_impact] || sa.price_impact));
                                            }
                                            if (sa.lead_time_impact) {
                                                var leadTimeLabels = {
                                                    'reduces-1-2w': 'Reduces 1-2 weeks',
                                                    'reduces-2-4w': 'Reduces 2-4 weeks',
                                                    'reduces-4w-plus': 'Reduces 4+ weeks',
                                                    'similar': 'Similar Lead Time',
                                                    'increases-1-2w': 'Increases 1-2 weeks',
                                                    'increases-2w-plus': 'Increases 2+ weeks'
                                                };
                                                parts.push('Lead Time Impact: ' + (leadTimeLabels[sa.lead_time_impact] || sa.lead_time_impact));
                                            }
                                        }
                                        if (hasNote) {
                                            parts.push('Note: ' + bid.bid_smart_alternatives_note);
                                        }
                                        return parts.join('\n');
                                    };
                                    
                                    var fullDetails = formatFullDetails();
                                    var previewText = hasNote ? bid.bid_smart_alternatives_note : (sa ? formatSmartAlt(bid) : '');
                                    var previewLength = 100;
                                    var showPreview = previewText && previewText.length > previewLength && !isSmartAltExpanded;
                                    
                                    return React.createElement('div', null,
                                        React.createElement('div', {
                                            style: { fontSize: '10px', color: darkText, marginBottom: '2px', opacity: 0.7 }
                                        }, 'Smart Alternatives'),
                                        isSmartAltExpanded ? React.createElement('div', null,
                                            React.createElement('div', {
                                                style: {
                                                    fontSize: '11px',
                                                    color: darkText,
                                                    whiteSpace: 'pre-wrap',
                                                    lineHeight: '1.4',
                                                    marginBottom: '4px',
                                                    padding: '6px',
                                                    backgroundColor: '#0a0a0a',
                                                    borderRadius: '2px'
                                                }
                                            }, fullDetails),
                                            React.createElement('button', {
                                                onClick: function(e) {
                                                    e.stopPropagation();
                                                    setIsSmartAltExpanded(false);
                                                },
                                                style: {
                                                    background: 'none',
                                                    border: 'none',
                                                    color: greenAccent,
                                                    cursor: 'pointer',
                                                    fontSize: '10px',
                                                    padding: '2px 0',
                                                    textDecoration: 'underline',
                                                }
                                            }, 'Less')
                                        ) : React.createElement('div', null,
                                            React.createElement('div', {
                                                style: { fontSize: '11px', color: greenAccent, marginBottom: '4px' }
                                            }, showPreview ? (previewText.substring(0, previewLength) + '...') : previewText),
                                            React.createElement('button', {
                                                onClick: function(e) {
                                                    e.stopPropagation();
                                                    setIsSmartAltExpanded(true);
                                                },
                                                style: {
                                                    background: 'none',
                                                    border: 'none',
                                                    color: greenAccent,
                                                    cursor: 'pointer',
                                                    fontSize: '10px',
                                                    padding: '2px 0',
                                                    textDecoration: 'underline',
                                                }
                                            }, 'More')
                                        )
                                    );
                                })()
                            )
                        );
                    }
                    
                    // Multiple bids: Show comparison table with 3 columns max
                    var maxBids = Math.min(orderedBids.length, 3);
                    var displayBids = orderedBids.slice(0, maxBids);
                    var labelWidth = '140px';
                    
                    return React.createElement('div', {
                        style: {
                            border: '1px solid ' + darkBorder,
                            borderRadius: '4px',
                            overflow: 'hidden',
                            backgroundColor: '#111111',
                        }
                    },
                        // Table Header
                        React.createElement('div', {
                            style: {
                                display: 'grid',
                                gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                borderBottom: '1px solid ' + darkBorder,
                                backgroundColor: '#0a0a0a',
                            }
                        },
                            React.createElement('div', {
                                style: {
                                    padding: '6px 10px',
                                    borderRight: '1px solid ' + darkBorder,
                                    fontSize: '10px',
                                    color: darkText,
                                }
                            }),
                            displayBids.map(function(bid, idx) {
                                return React.createElement('div', {
                                    key: bid.bid_id,
                                    style: {
                                        padding: '6px 10px',
                                        textAlign: 'center',
                                        borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                        fontSize: '11px',
                                        fontWeight: '600',
                                    }
                                }, 'Supplier ' + getSupplierLabel(idx));
                            })
                        ),
                        // Table Body
                        React.createElement('div', null,
                            // Media Row
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                    gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                    borderBottom: '1px solid ' + darkBorder,
                                }
                            },
                                React.createElement('div', {
                                    style: {
                                        padding: '6px 10px',
                                        borderRight: '1px solid ' + darkBorder,
                                        fontSize: '10px',
                                        color: darkText,
                                        backgroundColor: '#0a0a0a',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }
                                }, 'Media'),
                                displayBids.map(function(bid, idx) {
                                    var media = renderMedia(bid, true);
                                    return React.createElement('div', {
                                        key: 'media-' + bid.bid_id,
                                        style: {
                                            padding: '6px 10px',
                                            borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                            fontSize: '10px',
                                        }
                                    }, media || React.createElement('span', { style: { color: darkText } }, '—'));
                                })
                            ),
                            // Prototype Row
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                    gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                    borderBottom: '1px solid ' + darkBorder,
                                }
                            },
                                React.createElement('div', {
                                    style: {
                                        padding: '6px 10px',
                                        borderRight: '1px solid ' + darkBorder,
                                        fontSize: '10px',
                                        color: darkText,
                                        backgroundColor: '#0a0a0a',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }
                                }, 'Prototype'),
                                displayBids.map(function(bid, idx) {
                                return React.createElement('div', {
                                    key: 'prototype-' + bid.bid_id,
                                    style: {
                                            padding: '6px 10px',
                                            borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                            fontSize: '10px',
                                    }
                                },
                                        React.createElement('span', { style: { color: greenAccent } }, formatPrototype(bid))
                                );
                            })
                            ),
                            // Production Lead Time Row
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                    gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                    borderBottom: '1px solid ' + darkBorder,
                                }
                            },
                                React.createElement('div', {
                                    style: {
                                        padding: '6px 10px',
                                        borderRight: '1px solid ' + darkBorder,
                                        fontSize: '10px',
                                        color: darkText,
                                        backgroundColor: '#0a0a0a',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }
                                }, 'Production Timeline'),
                                displayBids.map(function(bid, idx) {
                                    return React.createElement('div', {
                                        key: 'leadtime-' + bid.bid_id,
                                        style: {
                                            padding: '6px 10px',
                                            borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                            fontSize: '10px',
                                            textAlign: 'center',
                                        }
                                    },
                                        bid.production_lead_time ? React.createElement('span', {
                                            style: { color: greenAccent }
                                        }, bid.production_lead_time) : React.createElement('span', {
                                            style: { color: darkText }
                                        }, '—')
                                    );
                                })
                            ),
                            // Unit Price Row
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                    gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                    borderBottom: '1px solid ' + darkBorder,
                                }
                            },
                                React.createElement('div', {
                                    style: {
                                        padding: '6px 10px',
                                        borderRight: '1px solid ' + darkBorder,
                                        fontSize: '10px',
                                        color: darkText,
                                        backgroundColor: '#0a0a0a',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }
                                }, 'Unit Price'),
                                displayBids.map(function(bid, idx) {
                                    return React.createElement('div', {
                                        key: 'price-' + bid.bid_id,
                                        style: {
                                            padding: '6px 10px',
                                            borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                            fontSize: '10px',
                                            textAlign: 'center',
                                        }
                                    },
                                        bid.unit_price !== null ? React.createElement('div', {
                                            style: { display: 'flex', flexDirection: 'column', gap: '2px' }
                                        },
                                            React.createElement('span', {
                                                style: { color: greenAccent }
                                            }, '$' + bid.unit_price),
                                            bid.total_price && bid.item_quantity && bid.item_quantity > 1 ? React.createElement('span', {
                                                style: { color: darkText, fontSize: '9px', opacity: 0.7 }
                                            }, 'Total: $' + parseFloat(bid.total_price).toFixed(2)) : null
                                        ) : React.createElement('span', {
                                            style: { color: darkText }
                                        }, '—')
                                    );
                                })
                            ),
                            // Door-to-Door Delivery Row (Commit 2.3.10)
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                    gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                    borderBottom: '1px solid ' + darkBorder,
                                }
                            },
                                React.createElement('div', {
                                    style: {
                                        padding: '6px 10px',
                                        borderRight: '1px solid ' + darkBorder,
                                        fontSize: '10px',
                                        color: darkText,
                                        backgroundColor: '#0a0a0a',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }
                                }, 'Door-to-Door Delivery'),
                                displayBids.map(function(bid, idx) {
                                    var hasDelivery = bid.delivery_cost_usd != null && bid.delivery_cost_usd !== '' && (typeof bid.delivery_cost_usd === 'number' || !isNaN(parseFloat(bid.delivery_cost_usd)));
                                    var modeLabel = '';
                                    if (bid.delivery_shipping_mode) {
                                        if (bid.delivery_shipping_mode === 'LCL') {
                                            modeLabel = 'LCL';
                                        } else if (bid.delivery_shipping_mode === 'FCL_20') {
                                            modeLabel = '20\' Container';
                                        } else if (bid.delivery_shipping_mode === 'FCL_40HQ') {
                                            modeLabel = '40\' HQ Container';
                                        }
                                    }
                                    return React.createElement('div', {
                                        key: 'delivery-' + bid.bid_id,
                                        style: {
                                            padding: '6px 10px',
                                            borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                            fontSize: '10px',
                                            textAlign: 'center',
                                        }
                                    },
                                        hasDelivery ? React.createElement('div', {
                                            style: { display: 'flex', flexDirection: 'column', gap: '2px' }
                                        },
                                            React.createElement('span', {
                                                style: { color: greenAccent }
                                            }, '$' + parseFloat(bid.delivery_cost_usd).toFixed(2)),
                                            modeLabel ? React.createElement('span', {
                                                style: { color: darkText, fontSize: '9px', opacity: 0.6 }
                                            }, modeLabel) : null
                                        ) : React.createElement('span', {
                                            style: { color: darkText }
                                        }, '—')
                                    );
                                })
                            ),
                            // Commit 2.4.1: Award Bid Row
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                    gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                    borderBottom: '1px solid ' + darkBorder,
                                }
                            },
                                React.createElement('div', {
                                    style: {
                                        padding: '6px 10px',
                                        borderRight: '1px solid ' + darkBorder,
                                        fontSize: '10px',
                                        color: darkText,
                                        backgroundColor: '#0a0a0a',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }
                                }, 'Award Bid'),
                                displayBids.map(function(bid, idx) {
                                    if (bid.is_awarded) {
                                        return React.createElement('div', {
                                            key: 'award-' + bid.bid_id,
                                            style: {
                                                padding: '6px 10px',
                                                borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                                fontSize: '10px',
                                                textAlign: 'center',
                                            }
                                        },
                                            React.createElement('div', {
                                                style: {
                                                    padding: '4px 8px',
                                                    backgroundColor: '#003300',
                                                    border: '1px solid #00ff00',
                                                    borderRadius: '4px',
                                                    color: '#00ff00',
                                                    fontSize: '9px',
                                                    fontWeight: '600',
                                                    display: 'inline-block',
                                                }
                                            }, '✓ Awarded')
                                        );
                                    } else if (bid.is_declined) {
                                        return React.createElement('div', {
                                            key: 'award-' + bid.bid_id,
                                            style: {
                                                padding: '6px 10px',
                                                borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                                fontSize: '10px',
                                                textAlign: 'center',
                                            }
                                        },
                                            React.createElement('div', {
                                                style: {
                                                    padding: '4px 8px',
                                                    backgroundColor: '#330000',
                                                    border: '1px solid #ff6666',
                                                    borderRadius: '4px',
                                                    color: '#ff6666',
                                                    fontSize: '9px',
                                                    display: 'inline-block',
                                                }
                                            }, 'Declined')
                                        );
                                    } else if (bid.can_award) {
                                        return React.createElement('div', {
                                            key: 'award-' + bid.bid_id,
                                            style: {
                                                padding: '6px 10px',
                                                borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                                fontSize: '10px',
                                                textAlign: 'center',
                                            }
                                        },
                                            React.createElement('button', {
                                                onClick: function() {
                                                    if (!window.confirm('Are you sure you want to award this bid? All other bids will be declined.')) {
                                                        return;
                                                    }
                                                    
                                                    var ajaxUrl = window.n88BoardData && window.n88BoardData.ajaxUrl ? window.n88BoardData.ajaxUrl : (window.n88 && window.n88.ajaxUrl ? window.n88.ajaxUrl : '/wp-admin/admin-ajax.php');
                                                    var nonce = '';
                                                    if (window.n88BoardNonce && window.n88BoardNonce.nonce_award_bid) {
                                                        nonce = window.n88BoardNonce.nonce_award_bid;
                                                    } else if (window.n88BoardData && window.n88BoardData.nonce) {
                                                        nonce = window.n88BoardData.nonce;
                                                    } else if (window.n88 && window.n88.nonce) {
                                                        nonce = window.n88.nonce;
                                                    }
                                                    
                                                    if (!nonce) {
                                                        alert('Security token missing. Please refresh the page and try again.');
                                                        return;
                                                    }
                                                    
                                                    var formData = new FormData();
                                                    formData.append('action', 'n88_award_bid');
                                                    formData.append('item_id', itemId);
                                                    formData.append('bid_id', bid.bid_id);
                                                    formData.append('_ajax_nonce', nonce);
                                                    
                                                    fetch(ajaxUrl, {
                                                        method: 'POST',
                                                        body: formData
                                                    })
                                                    .then(function(response) {
                                                        return response.json();
                                                    })
                                                    .then(function(data) {
                                                        if (data.success) {
                                                            alert('Bid awarded successfully!');
                                                            // Refresh the page
                                                            window.location.reload();
                                                        } else {
                                                            alert('Error: ' + (data.data && data.data.message ? data.data.message : 'Failed to award bid'));
                                                        }
                                                    })
                                                    .catch(function(error) {
                                                        console.error('Error awarding bid:', error);
                                                        alert('Error awarding bid. Please try again.');
                                                    });
                                                },
                                                style: {
                                                    padding: '6px 12px',
                                                    backgroundColor: '#00ff00',
                                                    color: '#000',
                                                    border: 'none',
                                                    borderRadius: '4px',
                                                    fontSize: '9px',
                                                    fontWeight: '600',
                                                    cursor: 'pointer',
                                                    fontFamily: 'monospace',
                                                },
                                                onMouseOver: function(e) {
                                                    e.target.style.backgroundColor = '#00cc00';
                                                },
                                                onMouseOut: function(e) {
                                                    e.target.style.backgroundColor = '#00ff00';
                                                }
                                            }, 'Award')
                                        );
                                    } else {
                                        return React.createElement('div', {
                                            key: 'award-' + bid.bid_id,
                                            style: {
                                                padding: '6px 10px',
                                                borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                                fontSize: '10px',
                                                textAlign: 'center',
                                            }
                                        },
                                            React.createElement('span', {
                                                style: { color: darkText, fontSize: '9px' }
                                            }, bid.has_prototype_request && bid.prototype_status !== 'approved' ? 'Prototype Pending' : '—')
                                        );
                                    }
                                })
                            ),
                            // Smart Alternatives Rows - Only show if enabled
                            smartAlternativesEnabled ? React.createElement(React.Fragment, null,
                                // Smart Alt Summary Row
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                        gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                    borderBottom: '1px solid ' + darkBorder,
                                }
                            },
                                    React.createElement('div', {
                                        style: {
                                            padding: '6px 10px',
                                            borderRight: '1px solid ' + darkBorder,
                                            fontSize: '10px',
                                            color: darkText,
                                            backgroundColor: '#0a0a0a',
                                            display: 'flex',
                                            alignItems: 'center',
                                        }
                                    }, 'Smart Alt'),
                                    displayBids.map(function(bid, idx) {
                                        var sa = bid.smart_alternatives_suggestion;
                                        var hasSmartAltData = sa && (sa.category || sa.from || sa.to || (sa.comparison_points && sa.comparison_points.length > 0));
                                    return React.createElement('div', {
                                            key: 'smalt-' + bid.bid_id,
                                        style: {
                                                padding: '6px 10px',
                                                borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                                fontSize: '10px',
                                        }
                                    },
                                            hasSmartAltData ? React.createElement('span', { style: { color: greenAccent } }, formatSmartAlt(bid)) : React.createElement('span', { style: { color: darkText } }, '—')
                                    );
                                })
                            ),
                                // Smart Alt Notes Row (Expandable)
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                        gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                    borderBottom: '1px solid ' + darkBorder,
                                }
                            },
                                    React.createElement('div', {
                                        style: {
                                            padding: '6px 10px',
                                            borderRight: '1px solid ' + darkBorder,
                                            fontSize: '10px',
                                            color: darkText,
                                            backgroundColor: '#0a0a0a',
                                            display: 'flex',
                                            alignItems: 'center',
                                        }
                                    }, 'Smart Alt Notes'),
                                    displayBids.map(function(bid, idx) {
                                        var sa = bid.smart_alternatives_suggestion;
                                        var hasNote = bid.bid_smart_alternatives_note && bid.bid_smart_alternatives_note.trim();
                                        var hasDetails = sa && (sa.category || sa.from || sa.to || (sa.comparison_points && sa.comparison_points.length > 0));
                                        var hasContent = hasNote || hasDetails;
                                        var isExpanded = expandedSmartAltByBidId[bid.bid_id] || false;
                                        
                                        // Format full details
                                        var formatFullDetails = function() {
                                            if (!hasContent) return null;
                                            var parts = [];
                                            
                                            if (sa) {
                                                var categoryLabels = {
                                                    'material': 'Material',
                                                    'finish': 'Finish',
                                                    'hardware': 'Hardware',
                                                    'dimensions': 'Dimensions',
                                                    'construction': 'Construction Method',
                                                    'packaging': 'Packaging'
                                                };
                                                
                                                if (sa.category) {
                                                    parts.push('Category: ' + (categoryLabels[sa.category] || sa.category));
                                                }
                                                
                                                if (sa.from && sa.to) {
                                                    var formatLabel = function(str) {
                                                        if (!str) return '';
                                                        var labels = {
                                                            'solid-wood': 'Solid Wood', 'plywood': 'Plywood', 'mdf': 'MDF',
                                                            'metal': 'Metal', 'plastic': 'Plastic', 'glass': 'Glass',
                                                            'fabric': 'Fabric', 'leather': 'Leather', 'other': 'Other'
                                                        };
                                                        return labels[str] || str.split('-').map(function(word) {
                                                            return word.charAt(0).toUpperCase() + word.slice(1);
                                                        }).join(' ');
                                                    };
                                                    parts.push('From: ' + formatLabel(sa.from) + ' → To: ' + formatLabel(sa.to));
                                                }
                                                
                                                if (sa.comparison_points && sa.comparison_points.length > 0) {
                                                    var comparisonLabels = {
                                                        'cost-reduction': 'Cost Reduction',
                                                        'faster-production': 'Faster Production',
                                                        'better-durability': 'Better Durability',
                                                        'easier-sourcing': 'Easier Sourcing',
                                                        'lighter-weight': 'Lighter Weight',
                                                        'eco-friendly': 'Eco-Friendly'
                                                    };
                                                    var comparisons = sa.comparison_points.map(function(cp) {
                                                        return comparisonLabels[cp] || cp;
                                                    }).join(', ');
                                                    parts.push('Comparison Points: ' + comparisons);
                                                }
                                                
                                                if (sa.price_impact) {
                                                    var priceLabels = {
                                                        'reduces-10-20': 'Reduces 10-20%',
                                                        'reduces-20-30': 'Reduces 20-30%',
                                                        'reduces-30-plus': 'Reduces 30%+',
                                                        'similar': 'Similar Price',
                                                        'increases-10-20': 'Increases 10-20%',
                                                        'increases-20-plus': 'Increases 20%+'
                                                    };
                                                    parts.push('Price Impact: ' + (priceLabels[sa.price_impact] || sa.price_impact));
                                                }
                                                
                                                if (sa.lead_time_impact) {
                                                    var leadTimeLabels = {
                                                        'reduces-1-2w': 'Reduces 1-2 weeks',
                                                        'reduces-2-4w': 'Reduces 2-4 weeks',
                                                        'reduces-4w-plus': 'Reduces 4+ weeks',
                                                        'similar': 'Similar Lead Time',
                                                        'increases-1-2w': 'Increases 1-2 weeks',
                                                        'increases-2w-plus': 'Increases 2+ weeks'
                                                    };
                                                    parts.push('Lead Time Impact: ' + (leadTimeLabels[sa.lead_time_impact] || sa.lead_time_impact));
                                                }
                                            }
                                            
                                            if (hasNote) {
                                                parts.push('Note: ' + bid.bid_smart_alternatives_note);
                                            }
                                            
                                            return parts.join('\n');
                                        };
                                        
                                        var fullDetails = formatFullDetails();
                                        var previewText = hasNote ? bid.bid_smart_alternatives_note : (sa ? formatSmartAlt(bid) : '');
                                        var previewLength = 100;
                                        var showPreview = previewText && previewText.length > previewLength && !isExpanded;
                                        
                                    return React.createElement('div', {
                                            key: 'smalt-notes-' + bid.bid_id,
                                        style: {
                                                padding: '6px 10px',
                                                borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                                fontSize: '10px',
                                            }
                                        },
                                            hasContent ? React.createElement('div', null,
                                                isExpanded ? React.createElement('div', null,
                                                    React.createElement('div', {
                                                        style: {
                                                            whiteSpace: 'pre-wrap',
                                            color: darkText,
                                                            lineHeight: '1.4',
                                                            marginBottom: '4px'
                                        }
                                                    }, fullDetails),
                                                    React.createElement('button', {
                                                        onClick: function(e) {
                                                            e.stopPropagation();
                                                            toggleSmartAltExpanded(bid.bid_id);
                                                        },
                                                        style: {
                                                            background: 'none',
                                                            border: 'none',
                                                            color: greenAccent,
                                                            cursor: 'pointer',
                                                            fontSize: '9px',
                                                            padding: '2px 0',
                                                            textDecoration: 'underline',
                                                        }
                                                    }, 'Less')
                                                ) : React.createElement('div', null,
                                                    React.createElement('div', {
                                                        style: { color: darkText, marginBottom: '4px' }
                                                    }, showPreview ? (previewText.substring(0, previewLength) + '...') : previewText),
                                                    React.createElement('button', {
                                                        onClick: function(e) {
                                                            e.stopPropagation();
                                                            toggleSmartAltExpanded(bid.bid_id);
                                                        },
                                                        style: {
                                                            background: 'none',
                                                            border: 'none',
                                                            color: greenAccent,
                                                            cursor: 'pointer',
                                                            fontSize: '9px',
                                                            padding: '2px 0',
                                                            textDecoration: 'underline',
                                                        }
                                                    }, 'More')
                                                )
                                            ) : React.createElement('span', { style: { color: darkText } }, '—')
                                        );
                                    })
                                )
                            ) : null,
                            // Landed Shipping Costs Row
                            React.createElement('div', {
                                style: {
                                    display: 'grid',
                                    gridTemplateColumns: labelWidth + ' repeat(' + maxBids + ', 1fr)',
                                }
                            },
                                React.createElement('div', {
                                    style: {
                                        padding: '6px 10px',
                                        borderRight: '1px solid ' + darkBorder,
                                        fontSize: '10px',
                                        color: darkText,
                                        backgroundColor: '#0a0a0a',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }
                                }, 'Landed Shipping Costs'),
                                displayBids.map(function(bid, idx) {
                                    return React.createElement('div', {
                                        key: 'landed-' + bid.bid_id,
                                        style: {
                                            padding: '6px 10px',
                                            borderRight: idx < maxBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                                            fontSize: '10px',
                                            textAlign: 'center',
                                        }
                                    },
                                        React.createElement('span', { style: { color: darkText } }, '—')
                                    );
                                })
                            )
                        )
                    );
                };
                
                var BidItemInline = function(bidProps) {
                    var bid = bidProps.bid;
                    var idx = bidProps.idx;
                    var totalBids = bidProps.totalBids;
                    var darkBorder = bidProps.darkBorder;
                    var greenAccent = bidProps.greenAccent;
                    var darkText = bidProps.darkText || '#d3d3d3';
                    
                    var supplierLabel = String.fromCharCode(65 + idx);
                    var _expandedProviderState = React.useState(null);
                    var expandedProvider = _expandedProviderState[0];
                    var setExpandedProvider = _expandedProviderState[1];
                    
                    var videoLinksByProvider = bid.video_links_by_provider || {
                        youtube: [],
                        vimeo: [],
                        loom: [],
                    };
                    
                    var totalVideos = (videoLinksByProvider.youtube ? videoLinksByProvider.youtube.length : 0) + 
                                     (videoLinksByProvider.vimeo ? videoLinksByProvider.vimeo.length : 0) + 
                                     (videoLinksByProvider.loom ? videoLinksByProvider.loom.length : 0);
                    
                    return React.createElement('div', {
                        style: {
                            marginBottom: idx < totalBids - 1 ? '16px' : '0',
                            paddingBottom: idx < totalBids - 1 ? '16px' : '0',
                            borderBottom: idx < totalBids - 1 ? ('1px solid ' + darkBorder) : 'none',
                        }
                    },
                        React.createElement('div', {
                            style: { fontSize: '14px', fontWeight: '600', marginBottom: '12px' }
                        }, 'Supplier ' + supplierLabel),
                        
                        // Video Links by Provider
                        totalVideos > 0 ? React.createElement('div', {
                            style: { marginBottom: '12px' }
                        },
                            React.createElement('div', {
                                style: { fontSize: '12px', fontWeight: '600', marginBottom: '8px' }
                            }, 'Video Links (' + totalVideos + ')'),
                            React.createElement('div', {
                                style: { display: 'flex', flexDirection: 'column', gap: '4px' }
                            },
                                // YouTube Tab
                                videoLinksByProvider.youtube && videoLinksByProvider.youtube.length > 0 ? React.createElement('div', null,
                                    React.createElement('div', {
                                        onClick: function() {
                                            setExpandedProvider(expandedProvider === 'youtube' ? null : 'youtube');
                                        },
                                        style: {
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: '6px 8px',
                                            backgroundColor: '#1a1a1a',
                                            border: '1px solid ' + darkBorder,
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            fontSize: '11px',
                                            marginBottom: expandedProvider === 'youtube' ? '4px' : '0',
                                        }
                                    },
                                        React.createElement('span', null, 'YouTube (' + videoLinksByProvider.youtube.length + ')'),
                                        React.createElement('span', null, expandedProvider === 'youtube' ? '▼' : '▶')
                                    ),
                                    expandedProvider === 'youtube' ? React.createElement('div', {
                                        style: { padding: '8px', backgroundColor: '#0a0a0a', border: '1px solid ' + darkBorder, borderRadius: '4px' }
                                    },
                                        videoLinksByProvider.youtube.map(function(link, linkIdx) {
                                            return React.createElement('div', {
                                                key: linkIdx,
                                                style: { marginBottom: '4px' }
                                            },
                                                React.createElement('a', {
                                                    href: link,
                                                    target: '_blank',
                                                    rel: 'noopener noreferrer',
                                                    style: { fontSize: '11px', color: greenAccent, textDecoration: 'none' }
                                                }, link)
                                            );
                                        })
                                    ) : null
                                ) : null,
                                
                                // Vimeo Tab
                                videoLinksByProvider.vimeo && videoLinksByProvider.vimeo.length > 0 ? React.createElement('div', null,
                                    React.createElement('div', {
                                        onClick: function() {
                                            setExpandedProvider(expandedProvider === 'vimeo' ? null : 'vimeo');
                                        },
                                        style: {
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: '6px 8px',
                                            backgroundColor: '#1a1a1a',
                                            border: '1px solid ' + darkBorder,
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            fontSize: '11px',
                                            marginBottom: expandedProvider === 'vimeo' ? '4px' : '0',
                                        }
                                    },
                                        React.createElement('span', null, 'Vimeo (' + videoLinksByProvider.vimeo.length + ')'),
                                        React.createElement('span', null, expandedProvider === 'vimeo' ? '▼' : '▶')
                                    ),
                                    expandedProvider === 'vimeo' ? React.createElement('div', {
                                        style: { padding: '8px', backgroundColor: '#0a0a0a', border: '1px solid ' + darkBorder, borderRadius: '4px' }
                                    },
                                        videoLinksByProvider.vimeo.map(function(link, linkIdx) {
                                            return React.createElement('div', {
                                                key: linkIdx,
                                                style: { marginBottom: '4px' }
                                            },
                                                React.createElement('a', {
                                                    href: link,
                                                    target: '_blank',
                                                    rel: 'noopener noreferrer',
                                                    style: { fontSize: '11px', color: greenAccent, textDecoration: 'none' }
                                                }, link)
                                            );
                                        })
                                    ) : null
                                ) : null,
                                
                                // Loom Tab
                                videoLinksByProvider.loom && videoLinksByProvider.loom.length > 0 ? React.createElement('div', null,
                                    React.createElement('div', {
                                        onClick: function() {
                                            setExpandedProvider(expandedProvider === 'loom' ? null : 'loom');
                                        },
                                        style: {
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: '6px 8px',
                                            backgroundColor: '#1a1a1a',
                                            border: '1px solid ' + darkBorder,
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            fontSize: '11px',
                                            marginBottom: expandedProvider === 'loom' ? '4px' : '0',
                                        }
                                    },
                                        React.createElement('span', null, 'Loom (' + videoLinksByProvider.loom.length + ')'),
                                        React.createElement('span', null, expandedProvider === 'loom' ? '▼' : '▶')
                                    ),
                                    expandedProvider === 'loom' ? React.createElement('div', {
                                        style: { padding: '8px', backgroundColor: '#0a0a0a', border: '1px solid ' + darkBorder, borderRadius: '4px' }
                                    },
                                        videoLinksByProvider.loom.map(function(link, linkIdx) {
                                            return React.createElement('div', {
                                                key: linkIdx,
                                                style: { marginBottom: '4px' }
                                            },
                                                React.createElement('a', {
                                                    href: link,
                                                    target: '_blank',
                                                    rel: 'noopener noreferrer',
                                                    style: { fontSize: '11px', color: greenAccent, textDecoration: 'none' }
                                                }, link)
                                            );
                                        })
                                    ) : null
                                ) : null
                            )
                        ) : null,
                        
                        bid.prototype_timeline ? React.createElement('div', {
                            style: { marginBottom: '8px', fontSize: '12px' }
                        }, 'Prototype Timeline: ', React.createElement('span', {
                            style: { color: greenAccent }
                        }, bid.prototype_timeline)) : null,
                        bid.prototype_cost !== null ? React.createElement('div', {
                            style: { marginBottom: '8px', fontSize: '12px' }
                        }, 'Prototype Cost: ', React.createElement('span', {
                            style: { color: greenAccent }
                        }, '$' + bid.prototype_cost)) : null,
                        bid.production_lead_time ? React.createElement('div', {
                            style: { marginBottom: '8px', fontSize: '12px' }
                        }, 'Production Lead Time: ', React.createElement('span', {
                            style: { color: greenAccent }
                        }, bid.production_lead_time)) : null,
                        bid.unit_price !== null ? React.createElement('div', {
                            style: { marginBottom: '8px', fontSize: '12px' }
                        }, 'Unit Price: ', React.createElement('span', {
                            style: { color: greenAccent }
                        }, '$' + bid.unit_price)) : null,
                        
                        // Smart Alternatives per bid (read-only)
                        React.createElement('div', {
                            style: { marginTop: '12px', paddingTop: '12px', borderTop: '1px solid ' + darkBorder }
                        },
                            React.createElement('div', {
                                style: { fontSize: '12px', fontWeight: '600', marginBottom: '6px' }
                            }, 'Smart Alternatives:'),
                            React.createElement('div', {
                                style: { fontSize: '11px', color: darkText, marginBottom: '4px' }
                            }, 'Status: ', bid.smart_alternatives_enabled ? React.createElement('span', {
                                style: { color: greenAccent }
                            }, 'Enabled') : React.createElement('span', {
                                style: { color: '#999' }
                            }, 'Disabled')),
                            bid.smart_alternatives_note && bid.smart_alternatives_note.trim() ? React.createElement('div', {
                                style: { fontSize: '11px', color: darkText, marginTop: '4px', padding: '6px', backgroundColor: '#0a0a0a', borderRadius: '4px', whiteSpace: 'pre-wrap' }
                            }, bid.smart_alternatives_note) : null
                        )
                    );
                };
                
                var ItemDetailModalInline = function(props) {
                    var item = props.item;
                    var isOpen = props.isOpen;
                    var onClose = props.onClose;
                    var onSave = props.onSave;
                    var boardId = props.boardId;
                    
                    // Get updateLayout from store (if available)
                    var updateLayout = null;
                    if (typeof useBoardStore !== 'undefined') {
                        try {
                            updateLayout = useBoardStore(function(state) { return state.updateLayout; });
                        } catch (e) {
                            console.warn('Could not get updateLayout from store:', e);
                        }
                    }
                    
                    // Get item ID - extract numeric ID from "item-87" format or use direct ID
                    var getItemId = function() {
                        var id = item.id || item.item_id || '';
                        if (typeof id === 'string' && id.indexOf('item-') === 0) {
                            return parseInt(id.replace('item-', ''), 10);
                        } else if (typeof id === 'string') {
                            return parseInt(id, 10);
                        } else if (typeof id === 'number') {
                            return id;
                        }
                        return null;
                    };
                    var itemId = getItemId();
                    
                    // Item state (RFQ and bids)
                    var _itemStateState = React.useState({
                        has_rfq: false,
                        has_bids: false,
                        bids: [],
                        loading: true,
                        has_unread_operator_messages: false,
                        unread_operator_messages: 0,
                        has_prototype_payment: false,
                        prototype_payment_id: null,
                        prototype_payment_bid_id: null,
                        prototype_payment_supplier_id: null,
                        prototype_payment_status: null,
                        prototype_payment_total_due: null,
                        cad_status: null,
                        cad_revision_rounds_included: null,
                        cad_revision_rounds_used: null,
                        cad_approved_at: null,
                        cad_approved_version: null,
                        cad_released_to_supplier_at: null,
                        cad_current_version: null,
                        prototype_status: null,
                        prototype_current_version: null,
                        prototype_approved_version: null,
                        prototype_submission: null,
                        direction_keyword_ids: null,
                    });
                    var itemState = _itemStateState[0];
                    var setItemState = _itemStateState[1];
                    
                    // Payment Instructions Modal State
                    var _showPaymentInstructionsState = React.useState(false);
                    var showPaymentInstructions = _showPaymentInstructionsState[0];
                    var setShowPaymentInstructions = _showPaymentInstructionsState[1];
                    var _paymentReceiptsState = React.useState([]);
                    var paymentReceipts = _paymentReceiptsState[0];
                    var setPaymentReceipts = _paymentReceiptsState[1];
                    var _paymentReceiptsLoadingState = React.useState(false);
                    var paymentReceiptsLoading = _paymentReceiptsLoadingState[0];
                    var setPaymentReceiptsLoading = _paymentReceiptsLoadingState[1];
                    var _paymentReceiptUploadingState = React.useState(false);
                    var paymentReceiptUploading = _paymentReceiptUploadingState[0];
                    var setPaymentReceiptUploading = _paymentReceiptUploadingState[1];
                    
                    // Commit 2.3.9.2B-D: Prototype section state
                    var _prototypeSectionExpandedState = React.useState(false);
                    var prototypeSectionExpanded = _prototypeSectionExpandedState[0];
                    var setPrototypeSectionExpanded = _prototypeSectionExpandedState[1];
                    var _showRequestChangesModalState = React.useState(false);
                    var showRequestChangesModal = _showRequestChangesModalState[0];
                    var setShowRequestChangesModal = _showRequestChangesModalState[1];
                    var _feedbackPacketState = React.useState({});
                    var feedbackPacket = _feedbackPacketState[0];
                    var setFeedbackPacket = _feedbackPacketState[1];
                    var _availablePhrasesState = React.useState({});
                    var availablePhrases = _availablePhrasesState[0];
                    var setAvailablePhrases = _availablePhrasesState[1];
                    var _keywordNamesState = React.useState({});
                    var keywordNames = _keywordNamesState[0];
                    var setKeywordNames = _keywordNamesState[1];
                    var _totalPhrasesSelectedState = React.useState(0);
                    var totalPhrasesSelected = _totalPhrasesSelectedState[0];
                    var setTotalPhrasesSelected = _totalPhrasesSelectedState[1];
                    
                    // Form state
                    var _categoryState = React.useState(item.item_type || item.category || '');
                    var category = _categoryState[0];
                    var setCategory = _categoryState[1];
                    
                    var _descriptionState = React.useState(item.description || '');
                    var description = _descriptionState[0];
                    var setDescription = _descriptionState[1];
                    
                    var _quantityState = React.useState(
                        item.quantity ? String(item.quantity) : 
                        (item.meta && item.meta.quantity ? String(item.meta.quantity) : '')
                    );
                    var quantity = _quantityState[0];
                    var setQuantity = _quantityState[1];
                    
                    var _widthState = React.useState(item.dims && item.dims.w ? String(item.dims.w) : '');
                    var width = _widthState[0];
                    var setWidth = _widthState[1];
                    
                    var _depthState = React.useState(item.dims && item.dims.d ? String(item.dims.d) : '');
                    var depth = _depthState[0];
                    var setDepth = _depthState[1];
                    
                    var _heightState = React.useState(item.dims && item.dims.h ? String(item.dims.h) : '');
                    var height = _heightState[0];
                    var setHeight = _heightState[1];
                    
                    var _unitState = React.useState(item.dims && item.dims.unit ? item.dims.unit : 'in');
                    var unit = _unitState[0];
                    var setUnit = _unitState[1];
                    
                    // Delivery state
                    var _deliveryCountryState = React.useState(item.delivery_country || (item.meta && item.meta.delivery_country) || '');
                    var deliveryCountry = _deliveryCountryState[0];
                    var setDeliveryCountry = _deliveryCountryState[1];
                    
                    var _deliveryPostalState = React.useState(item.delivery_postal || (item.meta && item.meta.delivery_postal) || '');
                    var deliveryPostal = _deliveryPostalState[0];
                    var setDeliveryPostal = _deliveryPostalState[1];
                    
                    // Smart Alternatives state
                    var _smartAlternativesEnabledState = React.useState(
                        item.smart_alternatives !== undefined ? item.smart_alternatives : 
                        ((item.meta && item.meta.smart_alternatives !== undefined) ? item.meta.smart_alternatives : true)
                    );
                    var smartAlternativesEnabled = _smartAlternativesEnabledState[0];
                    var setSmartAlternativesEnabled = _smartAlternativesEnabledState[1];
                    
                    var _smartAlternativesNoteState = React.useState(
                        item.smart_alternatives_note || (item.meta && item.meta.smart_alternatives_note) || ''
                    );
                    var smartAlternativesNote = _smartAlternativesNoteState[0];
                    var setSmartAlternativesNote = _smartAlternativesNoteState[1];
                    
                    // RFQ form expansion state
                    var _showRfqFormState = React.useState(false);
                    var showRfqForm = _showRfqFormState[0];
                    var setShowRfqForm = _showRfqFormState[1];
                    
                    // Invite Makers state
                    var _invitedSuppliersState = React.useState([]);
                    var invitedSuppliers = _invitedSuppliersState[0];
                    var setInvitedSuppliers = _invitedSuppliersState[1];
                    
                    var _inviteSupplierInputState = React.useState('');
                    var inviteSupplierInput = _inviteSupplierInputState[0];
                    var setInviteSupplierInput = _inviteSupplierInputState[1];
                    
                    var _allowSystemInvitesState = React.useState(false);
                    var allowSystemInvites = _allowSystemInvitesState[0];
                    var setAllowSystemInvites = _allowSystemInvitesState[1];
                    
                    var _isSubmittingRfqState = React.useState(false);
                    var isSubmittingRfq = _isSubmittingRfqState[0];
                    var setIsSubmittingRfq = _isSubmittingRfqState[1];
                    
                    var _rfqErrorState = React.useState('');
                    var rfqError = _rfqErrorState[0];
                    var setRfqError = _rfqErrorState[1];
                    
                    // BIDS section expansion state
                    var _bidsExpandedState = React.useState(false);
                    var bidsExpanded = _bidsExpandedState[0];
                    var setBidsExpanded = _bidsExpandedState[1];
                    
                    // CAD Prototype Request form state (Commit 2.3.9.1B)
                    var _showCadPrototypeFormState = React.useState(false);
                    var showCadPrototypeForm = _showCadPrototypeFormState[0];
                    var setShowCadPrototypeForm = _showCadPrototypeFormState[1];
                    
                    var _selectedBidIdState = React.useState(null);
                    var selectedBidId = _selectedBidIdState[0];
                    var setSelectedBidId = _selectedBidIdState[1];
                    
                    var _selectedKeywordsState = React.useState([]);
                    var selectedKeywords = _selectedKeywordsState[0];
                    var setSelectedKeywords = _selectedKeywordsState[1];
                    
                    var _prototypeNoteState = React.useState('');
                    var prototypeNote = _prototypeNoteState[0];
                    var setPrototypeNote = _prototypeNoteState[1];
                    
                    var _availableKeywordsState = React.useState([]);
                    var availableKeywords = _availableKeywordsState[0];
                    var setAvailableKeywords = _availableKeywordsState[1];
                    
                    var _isLoadingKeywordsState = React.useState(false);
                    var isLoadingKeywords = _isLoadingKeywordsState[0];
                    var setIsLoadingKeywords = _isLoadingKeywordsState[1];
                    
                    var _isSubmittingCadPrototypeState = React.useState(false);
                    var isSubmittingCadPrototype = _isSubmittingCadPrototypeState[0];
                    var setIsSubmittingCadPrototype = _isSubmittingCadPrototypeState[1];
                    
                    var _cadPrototypeErrorState = React.useState('');
                    var cadPrototypeError = _cadPrototypeErrorState[0];
                    var setCadPrototypeError = _cadPrototypeErrorState[1];
                    
                    var _cadPrototypeSuccessState = React.useState(false);
                    var cadPrototypeSuccess = _cadPrototypeSuccessState[0];
                    var setCadPrototypeSuccess = _cadPrototypeSuccessState[1];
                    
                    // Commit 2.3.9.1C-a: Designer message operator state
                    var _showDesignerMessageFormState = React.useState(false);
                    var showDesignerMessageForm = _showDesignerMessageFormState[0];
                    var setShowDesignerMessageForm = _showDesignerMessageFormState[1];
                    
                    var _designerMessagesState = React.useState([]);
                    var designerMessages = _designerMessagesState[0];
                    var setDesignerMessages = _designerMessagesState[1];
                    
                    var _isLoadingDesignerMessagesState = React.useState(false);
                    var isLoadingDesignerMessages = _isLoadingDesignerMessagesState[0];
                    var setIsLoadingDesignerMessages = _isLoadingDesignerMessagesState[1];
                    
                    var _designerMessageTextState = React.useState('');
                    var designerMessageText = _designerMessageTextState[0];
                    var setDesignerMessageText = _designerMessageTextState[1];
                    
                    var _designerMessageCategoryState = React.useState('');
                    var designerMessageCategory = _designerMessageCategoryState[0];
                    var setDesignerMessageCategory = _designerMessageCategoryState[1];
                    
                    var _isSendingDesignerMessageState = React.useState(false);
                    var isSendingDesignerMessage = _isSendingDesignerMessageState[0];
                    var setIsSendingDesignerMessage = _isSendingDesignerMessageState[1];
                    
                    // Commit 2.3.9.1C-B: Clarifications state
                    var _clarificationsState = React.useState([]);
                    var clarifications = _clarificationsState[0];
                    var setClarifications = _clarificationsState[1];
                    var _isLoadingClarificationsState = React.useState(false);
                    var isLoadingClarifications = _isLoadingClarificationsState[0];
                    var setIsLoadingClarifications = _isLoadingClarificationsState[1];
                    var _showClarificationBannerState = React.useState(false);
                    var showClarificationBanner = _showClarificationBannerState[0];
                    var setShowClarificationBanner = _showClarificationBannerState[1];
                    
                    // Image lightbox state
                    var _lightboxImageState = React.useState(null);
                    var lightboxImage = _lightboxImageState[0];
                    var setLightboxImage = _lightboxImageState[1];
                    
                    // Helper function to validate inspiration items
                    var validateInspirationItem = function(insp) {
                        if (!insp || typeof insp !== 'object') return false;
                        var hasId = insp.id && Number.isInteger(Number(insp.id)) && Number(insp.id) > 0;
                        var url = insp.url ? String(insp.url).trim() : '';
                        var hasValidUrl = url && 
                            url.length > 0 &&
                            (url.startsWith('http://') || url.startsWith('https://')) && 
                            !url.startsWith('data:');
                        return hasId || hasValidUrl;
                    };
                    
                    // Filter initial inspiration to only include valid items
                    var initialInspiration = (item.inspiration || []).filter(validateInspirationItem);
                    var _inspirationState = React.useState(initialInspiration);
                    var inspiration = _inspirationState[0];
                    var setInspiration = _inspirationState[1];
                    
                    var _isSavingState = React.useState(false);
                    var isSaving = _isSavingState[0];
                    var setIsSaving = _isSavingState[1];
                    
                    // Commit 2.3.5.1: Warning banner state for post-RFQ dims/qty changes
                    var _showWarningBannerState = React.useState(false);
                    var showWarningBanner = _showWarningBannerState[0];
                    var setShowWarningBanner = _showWarningBannerState[1];
                    
                    var _isUploadingInspirationState = React.useState(false);
                    var isUploadingInspiration = _isUploadingInspirationState[0];
                    var setIsUploadingInspiration = _isUploadingInspirationState[1];
                    
                    // Active tab state
                    var _activeTabState = React.useState('details');
                    var activeTab = _activeTabState[0];
                    var setActiveTab = _activeTabState[1];
                    // When designer requests CAD revision or approves CAD, keep tab on Mission Spec (details) instead of switching to Proposals
                    var skipNextTabSwitchFromCadActionRef = React.useRef(false);
                    
                    // Auto-select tab based on state; when Action Required (unread operator messages): Mission Spec, Message Operator stays collapsed
                    React.useEffect(function() {
                        if (itemState.loading) return;
                        // After designer requests CAD revision or approves CAD, stay on Mission Spec (details); don't switch to Proposals
                        if (skipNextTabSwitchFromCadActionRef.current) {
                            skipNextTabSwitchFromCadActionRef.current = false;
                            return;
                        }
                        if (itemState.has_unread_operator_messages) {
                            setActiveTab('details'); // Mission Spec
                            setShowDesignerMessageForm(false); // Do NOT auto-open Message Operator; designer opens when ready
                            return;
                        }
                        if (itemState.has_bids && itemState.bids && itemState.bids.length > 0) {
                            setActiveTab('bids'); // Auto-select bids tab in State C
                        } else if (itemState.has_rfq) {
                            setActiveTab('rfq'); // Auto-select RFQ tab in State B
                        } else {
                            setActiveTab('details'); // Default to details tab in State A
                        }
                    }, [itemState.has_rfq, itemState.has_bids, itemState.loading, itemState.has_unread_operator_messages]);
                    
                    // Auto-select first bid when form opens with single bid (Commit 2.3.9.1B)
                    React.useEffect(function() {
                        if (showCadPrototypeForm && !selectedBidId && itemState.bids && itemState.bids.length === 1) {
                            setSelectedBidId(itemState.bids[0].bid_id);
                        }
                    }, [showCadPrototypeForm, itemState.bids, selectedBidId]);
                    
                    // Load keywords when bid is selected (Commit 2.3.9.1B)
                    React.useEffect(function() {
                        if (!showCadPrototypeForm || !selectedBidId || !category) {
                            return;
                        }

                        var loadKeywordsForCategory = function() {
                            setIsLoadingKeywords(true);
                            setAvailableKeywords([]);

                            try {
                                var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                                // Get nonce for n88_get_keywords action
                                var nonce = '';
                                if (window.n88BoardNonce && window.n88BoardNonce.nonce_get_keywords) {
                                    nonce = window.n88BoardNonce.nonce_get_keywords;
                                } else if (window.n88BoardData && window.n88BoardData.nonce) {
                                    nonce = window.n88BoardData.nonce;
                                } else if (window.n88 && window.n88.nonce) {
                                    nonce = window.n88.nonce;
                                } else if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                                    nonce = window.n88BoardNonce.nonce;
                                }
                                
                                if (!nonce) {
                                    console.error('Nonce not found for n88_get_keywords_by_category');
                                    setAvailableKeywords([]);
                                    setIsLoadingKeywords(false);
                                    return;
                                }
                                
                                // Use category name to fetch keywords (endpoint now accepts category_name)
                                var formData = new FormData();
                                formData.append('action', 'n88_get_keywords_by_category');
                                formData.append('category_name', category);
                                formData.append('_ajax_nonce', nonce);

                                fetch(ajaxUrl, {
                                    method: 'POST',
                                    body: formData,
                                })
                                .then(function(response) { return response.json(); })
                                .then(function(data) {
                                    if (data.success && data.data && data.data.keywords) {
                                        setAvailableKeywords(data.data.keywords);
                                    } else {
                                        console.error('Failed to load keywords:', data.message);
                                        setAvailableKeywords([]);
                                    }
                                })
                                .catch(function(error) {
                                    console.error('Error loading keywords:', error);
                                    setAvailableKeywords([]);
                                })
                                .finally(function() {
                                    setIsLoadingKeywords(false);
                                });
                            } catch (error) {
                                console.error('Error loading keywords:', error);
                                setAvailableKeywords([]);
                                setIsLoadingKeywords(false);
                            }
                        };

                        loadKeywordsForCategory();
                    }, [showCadPrototypeForm, selectedBidId, category]);
                    
                    // Commit 2.3.9.1C-a: Load Designer Messages
                    var loadDesignerMessages = React.useCallback(function() {
                        if (!itemId) return;
                        
                        setIsLoadingDesignerMessages(true);
                        try {
                            var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                            var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_get_item_messages) || (window.n88BoardNonce && window.n88BoardNonce.nonce) || (window.n88BoardData && window.n88BoardData.nonce) || (window.n88 && window.n88.nonce) || '';
                            
                            if (!nonce) {
                                console.error('Nonce not found for n88_get_item_messages');
                                setIsLoadingDesignerMessages(false);
                                return;
                            }
                            
                            var formData = new FormData();
                            formData.append('action', 'n88_get_item_messages');
                            formData.append('item_id', String(itemId));
                            formData.append('thread_type', 'designer_operator');
                            formData.append('_ajax_nonce', nonce);
                            
                            fetch(ajaxUrl, {
                                method: 'POST',
                                body: formData,
                            })
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                if (data.success && data.data && data.data.messages) {
                                    setDesignerMessages(data.data.messages);
                                } else {
                                    setDesignerMessages([]);
                                }
                            })
                            .catch(function(error) {
                                console.error('Error loading designer messages:', error);
                                setDesignerMessages([]);
                            })
                            .finally(function() {
                                setIsLoadingDesignerMessages(false);
                            });
                        } catch (error) {
                            console.error('Error loading designer messages:', error);
                            setDesignerMessages([]);
                            setIsLoadingDesignerMessages(false);
                        }
                    }, [itemId]);
                    
                    // Commit 2.3.9.1C-a: Send Designer Message
                    var sendDesignerMessage = React.useCallback(function(e) {
                        e.preventDefault();
                        
                        if (!itemId || !designerMessageText.trim()) {
                            alert('Please enter a message.');
                            return;
                        }
                        
                        setIsSendingDesignerMessage(true);
                        try {
                            var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                            var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_send_item_message) || (window.n88BoardNonce && window.n88BoardNonce.nonce) || (window.n88BoardData && window.n88BoardData.nonce) || (window.n88 && window.n88.nonce) || '';
                            
                            if (!nonce) {
                                console.error('Nonce not found for n88_send_item_message');
                                setIsSendingDesignerMessage(false);
                                return;
                            }
                            
                            var formData = new FormData();
                            formData.append('action', 'n88_send_item_message');
                            formData.append('item_id', String(itemId));
                            formData.append('thread_type', 'designer_operator');
                            formData.append('message_text', designerMessageText.trim());
                            formData.append('category', designerMessageCategory || '');
                            formData.append('_ajax_nonce', nonce);
                            
                            fetch(ajaxUrl, {
                                method: 'POST',
                                body: formData,
                            })
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                if (data.success) {
                                    setDesignerMessageText('');
                                    setDesignerMessageCategory('');
                                    loadDesignerMessages();
                                    // Refresh item state to update unread operator messages count
                                    fetchItemState();
                                } else {
                                    alert('Error: ' + (data.data && data.data.message ? data.data.message : 'Failed to send message. Please try again.'));
                                }
                            })
                            .catch(function(error) {
                                console.error('Error sending designer message:', error);
                                alert('An error occurred. Please try again.');
                            })
                            .finally(function() {
                                setIsSendingDesignerMessage(false);
                            });
                        } catch (error) {
                            console.error('Error sending designer message:', error);
                            alert('An error occurred. Please try again.');
                            setIsSendingDesignerMessage(false);
                        }
                    }, [itemId, designerMessageText, designerMessageCategory, loadDesignerMessages]);
                    
                    // Auto-scroll to bottom when messages load or new message is sent
                    React.useEffect(function() {
                        if (showDesignerMessageForm && designerMessages.length > 0) {
                            setTimeout(function() {
                                var container = document.getElementById('n88-designer-messages-container-admin');
                                if (container) {
                                    container.scrollTop = container.scrollHeight;
                                }
                            }, 100);
                        }
                    }, [showDesignerMessageForm, designerMessages]);
                    
                    // Commit 2.3.9.2A: CAD workflow actions state
                    var _isCadActionBusyState = React.useState(false);
                    var isCadActionBusy = _isCadActionBusyState[0];
                    var setIsCadActionBusy = _isCadActionBusyState[1];
                    var _revisionFilesState = React.useState([]);
                    var revisionFiles = _revisionFilesState[0];
                    var setRevisionFiles = _revisionFilesState[1];
                    var _showRevisionUploadState = React.useState(false);
                    var showRevisionUpload = _showRevisionUploadState[0];
                    var setShowRevisionUpload = _showRevisionUploadState[1];
                    
                    // Fetch item RFQ/bid state when modal opens
                    var fetchItemState = function() {
                        if (!itemId || isNaN(itemId) || itemId <= 0) {
                            console.error('Invalid item ID for fetchItemState:', itemId);
                            setItemState(function(prev) {
                                    return { has_rfq: false, has_bids: false, bids: [], loading: false, has_unread_operator_messages: false, unread_operator_messages: 0, has_prototype_payment: false, prototype_payment_id: null, prototype_payment_bid_id: null, prototype_payment_supplier_id: null, prototype_payment_status: null, prototype_payment_total_due: null, cad_status: null, cad_revision_rounds_included: null, cad_revision_rounds_used: null, cad_approved_at: null, cad_approved_version: null, cad_released_to_supplier_at: null, cad_current_version: null, prototype_status: null, prototype_current_version: null, prototype_approved_version: null, prototype_submission: null, direction_keyword_ids: null };
                            });
                            return;
                        }
                        
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || 
                                     (window.n88 && window.n88.ajaxUrl) || 
                                     (typeof ajaxurl !== 'undefined' ? ajaxurl : '<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>');
                        // Try multiple nonce sources - prioritize nonce_get_item_rfq_state
                        var nonce = '';
                        if (window.n88BoardNonce && window.n88BoardNonce.nonce_get_item_rfq_state) {
                            nonce = window.n88BoardNonce.nonce_get_item_rfq_state;
                        } else if (window.n88BoardData && window.n88BoardData.nonce) {
                            nonce = window.n88BoardData.nonce;
                        } else if (window.n88 && window.n88.nonce) {
                            nonce = window.n88.nonce;
                        } else if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                            nonce = window.n88BoardNonce.nonce;
                        } else {
                            nonce = '<?php echo esc_js( wp_create_nonce( 'n88_get_item_rfq_state' ) ); ?>';
                        }
                        
                        if (!nonce) {
                            console.error('Nonce not found for fetchItemState');
                            setItemState(function(prev) {
                                    return { has_rfq: false, has_bids: false, bids: [], loading: false, has_unread_operator_messages: false, unread_operator_messages: 0, has_prototype_payment: false, prototype_payment_id: null, prototype_payment_bid_id: null, prototype_payment_supplier_id: null, prototype_payment_status: null, prototype_payment_total_due: null, cad_status: null, cad_revision_rounds_included: null, cad_revision_rounds_used: null, cad_approved_at: null, cad_approved_version: null, cad_released_to_supplier_at: null, cad_current_version: null, prototype_status: null, prototype_current_version: null, prototype_approved_version: null, prototype_submission: null, direction_keyword_ids: null };
                            });
                            return;
                        }
                        
                        var formData = new FormData();
                        formData.append('action', 'n88_get_item_rfq_state');
                        formData.append('item_id', String(itemId));
                        formData.append('_ajax_nonce', nonce);
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData,
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.success) {
                                setItemState({
                                    has_rfq: data.data.has_rfq || false,
                                    has_bids: data.data.has_bids || false,
                                    bids: data.data.bids || [],
                                    rfq_revision_current: data.data.rfq_revision_current || null,
                                    revision_changed: data.data.revision_changed || false,
                                    has_unread_operator_messages: data.data.has_unread_operator_messages || false,
                                    unread_operator_messages: data.data.unread_operator_messages || 0,
                                    has_prototype_payment: data.data.has_prototype_payment || false,
                                    prototype_payment_id: data.data.prototype_payment_id || null,
                                    prototype_payment_bid_id: data.data.prototype_payment_bid_id || null,
                                    prototype_payment_supplier_id: data.data.prototype_payment_supplier_id || null,
                                    prototype_payment_status: data.data.prototype_payment_status || null,
                                    prototype_payment_total_due: data.data.prototype_payment_total_due || null,
                                    cad_status: data.data.cad_status || null,
                                    cad_revision_rounds_included: (data.data.cad_revision_rounds_included !== undefined && data.data.cad_revision_rounds_included !== null) ? data.data.cad_revision_rounds_included : null,
                                    cad_revision_rounds_used: (data.data.cad_revision_rounds_used !== undefined && data.data.cad_revision_rounds_used !== null) ? data.data.cad_revision_rounds_used : null,
                                    cad_approved_at: data.data.cad_approved_at || null,
                                    cad_approved_version: (data.data.cad_approved_version !== undefined && data.data.cad_approved_version !== null) ? data.data.cad_approved_version : null,
                                    cad_released_to_supplier_at: data.data.cad_released_to_supplier_at || null,
                                    cad_current_version: (data.data.cad_current_version !== undefined && data.data.cad_current_version !== null) ? data.data.cad_current_version : null,
                                    prototype_status: data.data.prototype_status || null,
                                    prototype_current_version: (data.data.prototype_current_version !== undefined && data.data.prototype_current_version !== null) ? data.data.prototype_current_version : null,
                                    prototype_approved_version: (data.data.prototype_approved_version !== undefined && data.data.prototype_approved_version !== null) ? data.data.prototype_approved_version : null,
                                    prototype_submission: data.data.prototype_submission || null,
                                    direction_keyword_ids: data.data.direction_keyword_ids || null,
                                    loading: false,
                                });
                                // When all bids withdrawn: item is State A; reset Launch Brief to show "Request Quote" (fresh form)
                                if ( (data.data.has_rfq === false || !data.data.has_rfq) && (data.data.has_bids === false || !data.data.has_bids) ) {
                                    setShowRfqForm(false);
                                }
                            } else {
                                console.error('Failed to fetch item state:', data.message);
                                setItemState(function(prev) {
                                    return { has_rfq: false, has_bids: false, bids: [], loading: false, has_unread_operator_messages: false, unread_operator_messages: 0, has_prototype_payment: false, prototype_payment_id: null, prototype_payment_bid_id: null, prototype_payment_supplier_id: null, prototype_payment_status: null, prototype_payment_total_due: null, cad_status: null, cad_revision_rounds_included: null, cad_revision_rounds_used: null, cad_approved_at: null, cad_approved_version: null, cad_released_to_supplier_at: null, cad_current_version: null };
                                });
                            }
                        })
                        .catch(function(error) {
                            console.error('Error fetching item state:', error);
                                setItemState(function(prev) {
                                    return { has_rfq: false, has_bids: false, bids: [], loading: false, has_unread_operator_messages: false, unread_operator_messages: 0, has_prototype_payment: false, prototype_payment_id: null, prototype_payment_bid_id: null, prototype_payment_supplier_id: null, prototype_payment_status: null, prototype_payment_total_due: null, cad_status: null, cad_revision_rounds_included: null, cad_revision_rounds_used: null, cad_approved_at: null, cad_approved_version: null, cad_released_to_supplier_at: null, cad_current_version: null, prototype_status: null, prototype_current_version: null, prototype_approved_version: null, prototype_submission: null, direction_keyword_ids: null };
                            });
                        });
                    };
                    
                    // Fetch item state when modal opens; reset Message Operator to collapsed to avoid carry-over from previous item
                    React.useEffect(function() {
                        if (isOpen && itemId && itemId > 0) {
                            setShowDesignerMessageForm(false);
                            fetchItemState();
                        }
                    }, [isOpen, itemId]);
                    
                    // Commit 2.3.9.2A: Designer CAD actions (Request Revision / Approve CAD) - defined after fetchItemState
                    var requestCadRevision = React.useCallback(function(files) {
                        if (!itemId || !itemState.prototype_payment_id) return;
                        files = files || [];
                        if (files.length === 0) {
                            alert('Please upload at least one file for the revision request.');
                            return;
                        }
                        if (!window.confirm('Request a CAD revision with ' + files.length + ' file(s)? This will increment the revision round counter.')) return;
                        
                        setIsCadActionBusy(true);
                        try {
                            var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                            var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_request_cad_revision) || '';
                            if (!nonce) {
                                alert('Nonce missing for CAD revision request.');
                                setIsCadActionBusy(false);
                                return;
                            }
                            
                            var formData = new FormData();
                            formData.append('action', 'n88_request_cad_revision');
                            formData.append('payment_id', String(itemState.prototype_payment_id));
                            formData.append('item_id', String(itemId));
                            formData.append('_ajax_nonce', nonce);
                            
                            // Append files
                            files.forEach(function(file) {
                                formData.append('revision_files[]', file);
                            });
                            
                            fetch(ajaxUrl, { method: 'POST', body: formData })
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                if (data.success) {
                                    setShowRevisionUpload(false);
                                    setRevisionFiles([]);
                                    if (loadDesignerMessages) loadDesignerMessages();
                                    fetchItemState();
                                } else {
                                    alert('Error: ' + (data.data && data.data.message ? data.data.message : 'Failed to request revision.'));
                                }
                            })
                            .catch(function(err) {
                                console.error('Error requesting CAD revision:', err);
                                alert('An error occurred. Please try again.');
                            })
                            .finally(function() {
                                setIsCadActionBusy(false);
                            });
                        } catch (err) {
                            console.error('Error requesting CAD revision:', err);
                            alert('An error occurred. Please try again.');
                            setIsCadActionBusy(false);
                        }
                    }, [itemId, itemState.prototype_payment_id, loadDesignerMessages, fetchItemState]);
                    
                    var approveCad = React.useCallback(function() {
                        if (!itemId || !itemState.prototype_payment_id) return;
                        if (!window.confirm('Approve the current CAD version? This will lock the approved version for release.')) return;
                        
                        setIsCadActionBusy(true);
                        try {
                            var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                            var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_approve_cad) || '';
                            if (!nonce) {
                                alert('Nonce missing for CAD approval.');
                                setIsCadActionBusy(false);
                                return;
                            }
                            
                            var formData = new FormData();
                            formData.append('action', 'n88_approve_cad');
                            formData.append('payment_id', String(itemState.prototype_payment_id));
                            formData.append('item_id', String(itemId));
                            formData.append('_ajax_nonce', nonce);
                            
                            fetch(ajaxUrl, { method: 'POST', body: formData })
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                if (data.success) {
                                    if (loadDesignerMessages) loadDesignerMessages();
                                    skipNextTabSwitchFromCadActionRef.current = true; // stay on Mission Spec after approve CAD
                                    fetchItemState();
                                } else {
                                    alert('Error: ' + (data.data && data.data.message ? data.data.message : 'Failed to approve CAD.'));
                                }
                            })
                            .catch(function(err) {
                                console.error('Error approving CAD:', err);
                                alert('An error occurred. Please try again.');
                            })
                            .finally(function() {
                                setIsCadActionBusy(false);
                            });
                        } catch (err) {
                            console.error('Error approving CAD:', err);
                            alert('An error occurred. Please try again.');
                            setIsCadActionBusy(false);
                        }
                    }, [itemId, itemState.prototype_payment_id, loadDesignerMessages]);
                    
                    // Fetch payment receipts when Payment Instructions modal opens
                    var fetchPaymentReceipts = function() {
                        var pid = itemState.prototype_payment_id;
                        if (!pid) return;
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || window.ajaxurl || '/wp-admin/admin-ajax.php';
                        var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_get_payment_receipts) || '';
                        if (!nonce) return;
                        setPaymentReceiptsLoading(true);
                        var fd = new FormData();
                        fd.append('action', 'n88_get_payment_receipts');
                        fd.append('payment_id', String(pid));
                        fd.append('_ajax_nonce', nonce);
                        fetch(ajaxUrl, { method: 'POST', body: fd })
                            .then(function(r) { return r.json(); })
                            .then(function(d) {
                                if (d.success && d.data && d.data.receipts && Array.isArray(d.data.receipts)) {
                                    setPaymentReceipts(d.data.receipts);
                                } else {
                                    setPaymentReceipts([]);
                                }
                            })
                            .catch(function() { setPaymentReceipts([]); })
                            .finally(function() { setPaymentReceiptsLoading(false); });
                    };
                    React.useEffect(function() {
                        if (showPaymentInstructions && itemState.prototype_payment_id) {
                            fetchPaymentReceipts();
                        } else if (!showPaymentInstructions) {
                            setPaymentReceipts([]);
                        }
                    }, [showPaymentInstructions, itemState.prototype_payment_id]);
                    
                    // Auto-expand "Payment Confirmed" / "View Prototype Videos" when supplier has submitted videos
                    React.useEffect(function() {
                        if (itemState.prototype_submission && itemState.prototype_submission.links && itemState.prototype_submission.links.length > 0) {
                            setPrototypeSectionExpanded(true);
                        }
                    }, [itemState.prototype_submission]);
                    
                    var handlePaymentReceiptUpload = function(e) {
                        var file = e.target && e.target.files && e.target.files[0];
                        if (!file) return;
                        var pid = itemState.prototype_payment_id;
                        if (!pid) return;
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || window.ajaxurl || '/wp-admin/admin-ajax.php';
                        var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_upload_payment_receipt) || '';
                        if (!nonce) { alert('Upload not available.'); e.target.value = ''; return; }
                        var ok = /\.(jpe?g|pdf)$/i.test(file.name) || ['image/jpeg','image/jpg','application/pdf'].indexOf(file.type) !== -1;
                        if (!ok) { alert('Only JPG and PDF are allowed.'); e.target.value = ''; return; }
                        setPaymentReceiptUploading(true);
                        var fd = new FormData();
                        fd.append('action', 'n88_upload_payment_receipt');
                        fd.append('payment_id', String(pid));
                        fd.append('receipt_file', file);
                        fd.append('_ajax_nonce', nonce);
                        fetch(ajaxUrl, { method: 'POST', body: fd })
                            .then(function(r) { return r.json(); })
                            .then(function(d) {
                                if (d.success) { fetchPaymentReceipts(); } else { alert(d.data && d.data.message ? d.data.message : 'Upload failed.'); }
                            })
                            .catch(function() { alert('Upload failed.'); })
                            .finally(function() { setPaymentReceiptUploading(false); e.target.value = ''; });
                    };
                    
                    // Update inspiration when item changes (if modal is reopened with different item)
                    React.useEffect(function() {
                        var validInspiration = (item.inspiration || []).filter(validateInspirationItem);
                        setInspiration(validInspiration);
                    }, [item.id]);
                    
                    // Computed values (read-only) - initialize from saved item data
                    var _computedState = React.useState({
                        dimsCm: item.dims_cm || null,
                        cbm: item.cbm || null,
                        sourcingType: item.sourcing_type || null,
                        timelineType: item.timeline_type || null,
                    });
                    var computedValues = _computedState[0];
                    var setComputedValues = _computedState[1];
                    
                    // Prevent body scroll when modal is open
                    React.useEffect(function() {
                        if (isOpen) {
                            document.body.style.overflow = 'hidden';
                        } else {
                            document.body.style.overflow = '';
                        }
                        // Cleanup: restore scroll when component unmounts
                        return function() {
                            document.body.style.overflow = '';
                        };
                    }, [isOpen]);
                    
                    // Recompute when dimensions change
                    React.useEffect(function() {
                        // If all dimensions are entered, compute CBM
                        if (width && depth && height) {
                            var wCm = normalizeToCm(width, unit);
                            var dCm = normalizeToCm(depth, unit);
                            var hCm = normalizeToCm(height, unit);
                            
                            if (wCm && dCm && hCm) {
                                var cbm = calculateCBM(wCm, dCm, hCm);
                                var sourcingType = inferSourcingType(category, description);
                                var timelineType = assignTimelineType(sourcingType);
                                
                                setComputedValues({
                                    dimsCm: { w_cm: wCm, d_cm: dCm, h_cm: hCm },
                                    cbm: cbm,
                                    sourcingType: sourcingType,
                                    timelineType: timelineType,
                                });
                            } else {
                                // Dimensions entered but normalization failed
                                var sourcingType = inferSourcingType(category, description);
                                var timelineType = assignTimelineType(sourcingType);
                                setComputedValues({
                                    dimsCm: null,
                                    cbm: null,
                                    sourcingType: sourcingType,
                                    timelineType: timelineType,
                                });
                            }
                        } else {
                            // Not all dimensions entered - preserve saved computed values if they exist
                            // This ensures saved CBM is displayed even if user hasn't entered dimensions yet
                            var sourcingType = inferSourcingType(category, description);
                            var timelineType = assignTimelineType(sourcingType);
                            setComputedValues(function(prev) {
                                return {
                                    dimsCm: prev.dimsCm || item.dims_cm || null,
                                    cbm: (prev.cbm !== null && prev.cbm !== undefined) ? prev.cbm : ((item.cbm !== null && item.cbm !== undefined) ? item.cbm : null),
                                    sourcingType: sourcingType,
                                    timelineType: timelineType,
                                };
                            });
                        }
                    }, [width, depth, height, unit, category, description]);
                    
                    // Determine current state
                    var currentState = (function() {
                        if (itemState.loading) return 'loading';
                        if (itemState.has_bids) return 'C'; // State C: Proposals received
                        if (itemState.has_rfq) return 'B'; // State B: RFQ sent, no bids
                        return 'A'; // State A: Before RFQ
                    })();
                    
                    // Check if fields should be editable
                    // Lock after CAD/Prototype request submitted (permanent): lock Brief/RFQ and hide Update/Save
                    var isLockedAwaitingPayment = !!itemState.has_prototype_payment;
                    var isEditable = currentState === 'A' && !isLockedAwaitingPayment;
                    
                    // Format dimensions for display
                    var formatDimensions = function() {
                        if (!width || !depth || !height) return null;
                        var w = parseFloat(width);
                        var d = parseFloat(depth);
                        var h = parseFloat(height);
                        if (isNaN(w) || isNaN(d) || isNaN(h)) return null;
                        var unitStr = unit === 'in' ? '"' : unit;
                        return w + unitStr + 'W × ' + d + unitStr + 'D × ' + h + unitStr + 'H';
                    };
                    
                    // Format delivery for display
                    var formatDelivery = function() {
                        if (!deliveryCountry) return null;
                        var parts = [deliveryCountry];
                        if (deliveryPostal) parts.push(deliveryPostal);
                        return parts.join(' ');
                    };
                    
                    // Shipping validation message state
                    var _shippingMessageState = React.useState('');
                    var shippingMessage = _shippingMessageState[0];
                    var setShippingMessage = _shippingMessageState[1];
                    
                    // Update shipping message when delivery country changes
                    React.useEffect(function() {
                        if (!deliveryCountry) {
                            setShippingMessage('');
                            return;
                        }
                        
                        var country = deliveryCountry.toUpperCase();
                        if (country === 'US' || country === 'CA') {
                            if (!deliveryPostal) {
                                setShippingMessage('ZIP/postal code is required for US and Canada.');
                            } else {
                                setShippingMessage('');
                            }
                        } else if (country) {
                            setShippingMessage('We are not able to calculate an instant shipping estimate for this delivery location yet, but our team can get back to you with a shipping range within 24 hours.');
                        } else {
                            setShippingMessage('');
                        }
                    }, [deliveryCountry, deliveryPostal]);
                    
                    // System invites message state
                    var _systemInvitesMessageState = React.useState('');
                    var systemInvitesMessage = _systemInvitesMessageState[0];
                    var setSystemInvitesMessage = _systemInvitesMessageState[1];
                    
                    // Update system invites message
                    var updateSystemInvitesMessage = function() {
                        if (allowSystemInvites) {
                            if (invitedSuppliers.length > 0) {
                                setSystemInvitesMessage('We\'ll invite 2 additional makers in 24 hours.');
                            } else {
                                setSystemInvitesMessage('We will send your request on your behalf.');
                            }
                        } else {
                            setSystemInvitesMessage('');
                        }
                    };
                    
                    React.useEffect(function() {
                        updateSystemInvitesMessage();
                    }, [allowSystemInvites, invitedSuppliers.length]);
                    
                    // Add invited supplier chip
                    var addInvitedSupplierChip = function() {
                        var value = inviteSupplierInput.trim();
                        if (!value) return;
                        
                        if (invitedSuppliers.length >= 5) {
                            setRfqError('Maximum 5 invited makers allowed.');
                            return;
                        }
                        
                        if (invitedSuppliers.indexOf(value) !== -1) {
                            setRfqError('This supplier is already added.');
                            return;
                        }
                        
                        setInvitedSuppliers(invitedSuppliers.concat([value]));
                        setInviteSupplierInput('');
                        setRfqError('');
                        
                        // Update system invites message if checkbox is checked
                        if (allowSystemInvites) {
                            setSystemInvitesMessage('');
                        }
                    };
                    
                    // Remove invited supplier chip
                    var removeInvitedSupplierChip = function(value) {
                        var newSuppliers = invitedSuppliers.filter(function(s) { return s !== value; });
                        setInvitedSuppliers(newSuppliers);
                        
                        // Update system invites message if checkbox is checked
                        if (allowSystemInvites) {
                            if (newSuppliers.length > 0) {
                                setSystemInvitesMessage('');
                            } else {
                                setSystemInvitesMessage('We will send your request on your behalf.');
                            }
                        }
                    };
                    
                    // Handle RFQ submission
                    var handleSubmitRfq = function(e) {
                        if (e) e.preventDefault();
                        
                        // Validate
                        if (invitedSuppliers.length === 0 && !allowSystemInvites) {
                            setRfqError('Invite at least one maker or allow the system to invite makers.');
                            return;
                        }
                        
                        // Validate required fields
                        if (!quantity || !deliveryCountry) {
                            setRfqError('Please fill in all required fields (Quantity, Delivery Country).');
                            return;
                        }
                        
                        // Validate item ID
                        if (!itemId || isNaN(itemId) || itemId <= 0) {
                            setRfqError('Invalid item ID. Please refresh the page and try again.');
                            setIsSubmittingRfq(false);
                            return;
                        }
                        
                        setIsSubmittingRfq(true);
                        setRfqError('');
                        
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || 
                                     (window.n88 && window.n88.ajaxUrl) || 
                                     (typeof ajaxurl !== 'undefined' ? ajaxurl : '<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>');
                        var nonce = '';
                        if (window.n88BoardNonce && window.n88BoardNonce.nonce_submit_rfq) {
                            nonce = window.n88BoardNonce.nonce_submit_rfq;
                        } else if (window.n88BoardData && window.n88BoardData.nonce) {
                            nonce = window.n88BoardData.nonce;
                        } else if (window.n88 && window.n88.nonce) {
                            nonce = window.n88.nonce;
                        } else if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                            nonce = window.n88BoardNonce.nonce;
                        } else {
                            nonce = '<?php echo esc_js( wp_create_nonce( 'n88_submit_rfq' ) ); ?>';
                        }
                        
                        if (!nonce) {
                            console.error('Nonce not found. Available:', {
                                n88BoardNonce: window.n88BoardNonce,
                                n88BoardData: window.n88BoardData,
                                n88: window.n88
                            });
                            setRfqError('Security token missing. Please refresh the page and try again.');
                            setIsSubmittingRfq(false);
                            return;
                        }
                        
                        var items = [{
                            item_id: itemId,
                            quantity: parseInt(quantity),
                            width: parseFloat(width),
                            depth: parseFloat(depth),
                            height: parseFloat(height),
                            dimension_unit: unit,
                            delivery_country: deliveryCountry.toUpperCase().trim(),
                            delivery_postal: deliveryPostal.trim(),
                        }];
                        
                        var formData = new FormData();
                        formData.append('action', 'n88_submit_rfq');
                        formData.append('items', JSON.stringify(items));
                        formData.append('invited_suppliers', JSON.stringify(invitedSuppliers));
                        formData.append('allow_system_invites', allowSystemInvites ? '1' : '0');
                        formData.append('_ajax_nonce', nonce);
                        
                        fetch(ajaxUrl, {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.success) {
                                // Save item facts (quantity, dimensions, delivery, notes) to item meta_json
                                try {
                                    // Validate and filter inspiration images
                                    var validInspiration = inspiration.filter(function(insp) {
                                        if (!insp || typeof insp !== 'object') return false;
                                        var hasId = insp.id && Number.isInteger(Number(insp.id)) && Number(insp.id) > 0;
                                        var url = insp.url ? String(insp.url).trim() : '';
                                        var hasValidUrl = url && 
                                            url.length > 0 &&
                                            (url.startsWith('http://') || url.startsWith('https://')) && 
                                            !url.startsWith('data:');
                                        return hasId || hasValidUrl;
                                    }).map(function(insp) {
                                        var url = insp.url ? String(insp.url).trim() : '';
                                        var hasValidUrl = url && (url.startsWith('http://') || url.startsWith('https://'));
                                        
                                        return {
                                            type: insp.type || 'image',
                                            id: (insp.id && Number.isInteger(Number(insp.id)) && Number(insp.id) > 0) ? Number(insp.id) : null,
                                            url: hasValidUrl ? url : '',
                                            title: insp.title || insp.filename || 'Reference image',
                                        };
                                    });
                                    
                                    var dimsCm = computedValues.dimsCm;
                                    
                                    // Process quantity - ensure it's always included if it has a value
                                    var qtyValue = null;
                                    if (quantity !== '' && quantity !== null && quantity !== undefined) {
                                        var parsedQty = parseInt(quantity);
                                        if (!isNaN(parsedQty) && parsedQty >= 0) {
                                            qtyValue = parsedQty;
                                        }
                                    }
                                    
                                    // Process notes - always include, even if empty
                                    var notesValue = smartAlternativesNote || '';
                                    
                                    var payload = {
                                        category: category,
                                        description: description,
                                        quantity: qtyValue,
                                        dims: {
                                            w: width ? parseFloat(width) : null,
                                            d: depth ? parseFloat(depth) : null,
                                            h: height ? parseFloat(height) : null,
                                            unit: unit,
                                        },
                                        dims_cm: dimsCm,
                                        cbm: computedValues.cbm,
                                        sourcing_type: computedValues.sourcingType,
                                        timeline_type: computedValues.timelineType,
                                        inspiration: validInspiration,
                                        smart_alternatives: smartAlternativesEnabled,
                                        smart_alternatives_note: notesValue,
                                        delivery_country: deliveryCountry,
                                        delivery_postal: deliveryPostal,
                                    };
                                    
                                    // Log payload for debugging
                                    console.log('ItemDetailModal (admin.php) - Saving item facts after RFQ:', {
                                        itemId: item.id,
                                        quantity: qtyValue,
                                        quantityRaw: quantity,
                                        smart_alternatives_note: notesValue,
                                        payload: payload
                                    });
                                    
                                    // Call onSave callback to save item facts
                                    if (onSave) {
                                        var itemIdNum = item.id;
                                        if (typeof itemIdNum === 'string' && itemIdNum.indexOf('item-') === 0) {
                                            itemIdNum = parseInt(itemIdNum.replace('item-', ''), 10);
                                        } else if (typeof itemIdNum === 'string') {
                                            itemIdNum = parseInt(itemIdNum, 10);
                                        }
                                        if (!isNaN(itemIdNum) && itemIdNum > 0) {
                                            onSave(itemIdNum, payload).catch(function(saveError) {
                                                console.error('Error saving item facts after RFQ submission:', saveError);
                                                // Don't block RFQ submission if save fails, just log it
                                            });
                                        }
                                    }
                                } catch (saveError) {
                                    console.error('Error saving item facts after RFQ submission:', saveError);
                                    // Don't block RFQ submission if save fails, just log it
                                }
                                
                                alert(data.data.message || 'RFQ submitted successfully!');
                                setShowRfqForm(false);
                                // Optimistically update state to State B immediately
                                setItemState(function(prev) {
                                    return {
                                        has_rfq: true,
                                        has_bids: false,
                                        bids: [],
                                        loading: false,
                                    };
                                });
                                // Update board item in store to reflect RFQ sent status
                                if (window.N88StudioOS && window.N88StudioOS.useBoardStore) {
                                    var store = window.N88StudioOS.useBoardStore.getState();
                                    var currentItems = store.items || [];
                                    var updatedItems = currentItems.map(function(storeItem) {
                                        if (storeItem.id === item.id || storeItem.id === 'item-' + itemId || storeItem.id === itemId) {
                                            // Update item with RFQ status
                                            return Object.assign({}, storeItem, {
                                                has_rfq: true,
                                                has_bids: false,
                                                bid_count: 0,
                                                valid_bid_count: 0,
                                                revision_changed: false
                                            });
                                        }
                                        return storeItem;
                                    });
                                    store.setItems(updatedItems);
                                }
                                // Then refresh from server to get actual state
                                fetchItemState();
                                // Close modal after update
                                if (onClose) {
                                    setTimeout(function() {
                                        onClose();
                                    }, 100);
                                }
                            } else {
                                if (data.data && data.data.errors) {
                                    var errorMessages = [];
                                    for (var key in data.data.errors) {
                                        errorMessages.push(data.data.errors[key]);
                                    }
                                    setRfqError(errorMessages.join(' '));
                                } else {
                                    setRfqError(data.data && data.data.message ? data.data.message : 'An error occurred. Please try again.');
                                }
                            }
                        })
                        .catch(function(error) {
                            console.error('RFQ submission error:', error);
                            setRfqError('Network error. Please try again.');
                        })
                        .finally(function() {
                            setIsSubmittingRfq(false);
                        });
                    };
                    
                    // Handle save
                    var handleSave = function() {
                        // Prevent save if uploads are in progress
                        if (typeof isUploadingInspiration !== 'undefined' && isUploadingInspiration) {
                            alert('Please wait for image uploads to complete before saving.');
                            return;
                        }
                        
                        // Dimensions and quantity are always editable (State B and C)
                        // No blocking - allow saving in all states
                        
                        setIsSaving(true);
                        
                        try {
                            // Validate and filter inspiration images - only keep ones with valid attachment IDs or URLs
                            var validInspiration = inspiration.filter(function(insp) {
                                if (!insp || typeof insp !== 'object') {
                                    console.warn('Filtering out invalid inspiration image (not an object):', insp);
                                    return false;
                                }
                                
                                // Must have either an attachment ID or a valid URL (not base64 data URL)
                                var hasId = insp.id && Number.isInteger(Number(insp.id)) && Number(insp.id) > 0;
                                var url = insp.url ? String(insp.url).trim() : '';
                                var hasValidUrl = url && 
                                    url.length > 0 &&
                                    (url.startsWith('http://') || url.startsWith('https://')) && 
                                    !url.startsWith('data:');
                                
                                if (!hasId && !hasValidUrl) {
                                    console.warn('Filtering out invalid inspiration image (no valid ID or URL):', insp);
                                    return false;
                                }
                                
                                return true;
                            }).map(function(insp) {
                                // Normalize inspiration item structure - only include valid data
                                var url = insp.url ? String(insp.url).trim() : '';
                                var hasValidUrl = url && (url.startsWith('http://') || url.startsWith('https://'));
                                
                                return {
                                    type: insp.type || 'image',
                                    id: (insp.id && Number.isInteger(Number(insp.id)) && Number(insp.id) > 0) ? Number(insp.id) : null,
                                    url: hasValidUrl ? url : '',
                                    title: insp.title || insp.filename || 'Reference image',
                                };
                            });
                            
                            console.log('Saving inspiration images:', validInspiration.length, 'valid images out of', inspiration.length, 'total');
                            
                            // Double-check: if we filtered out images, warn user
                            if (inspiration.length > 0 && validInspiration.length === 0) {
                                alert('Warning: All inspiration images were invalid and will not be saved. Please re-upload them.');
                                setIsSaving(false);
                                return;
                            }
                            
                            // Prepare payload
                            var dimsCm = computedValues.dimsCm;
                            // Process quantity - ensure it's always included if it has a value
                            var qtyValue = null;
                            if (quantity !== '' && quantity !== null && quantity !== undefined) {
                                var parsedQty = parseInt(quantity);
                                if (!isNaN(parsedQty) && parsedQty >= 0) {
                                    qtyValue = parsedQty;
                                }
                            }
                            
                            // Process notes - always include, even if empty
                            var notesValue = smartAlternativesNote || '';
                            
                            var payload = {
                                category: category,
                                description: description,
                                quantity: qtyValue,
                                dims: {
                                    w: width ? parseFloat(width) : null,
                                    d: depth ? parseFloat(depth) : null,
                                    h: height ? parseFloat(height) : null,
                                    unit: unit,
                                },
                                dims_cm: dimsCm,
                                cbm: computedValues.cbm,
                                sourcing_type: computedValues.sourcingType,
                                timeline_type: computedValues.timelineType,
                                inspiration: validInspiration,
                                smart_alternatives: smartAlternativesEnabled,
                                smart_alternatives_note: notesValue,
                                delivery_country: deliveryCountry,
                                delivery_postal: deliveryPostal,
                            };
                            
                            // Log payload for debugging
                            console.log('ItemDetailModal (admin.php) - Saving item facts:', {
                                itemId: item.id,
                                quantity: qtyValue,
                                quantityRaw: quantity,
                                smart_alternatives_note: notesValue,
                                payload: payload
                            });
                            
                            // Call onSave callback (handles AJAX and event logging)
                            if (onSave) {
                                // Extract numeric ID from item.id (handles both "item-5" and "5" formats)
                                var itemIdNum = item.id;
                                if (typeof itemIdNum === 'string' && itemIdNum.indexOf('item-') === 0) {
                                    itemIdNum = parseInt(itemIdNum.replace('item-', ''), 10);
                                } else if (typeof itemIdNum === 'string') {
                                    itemIdNum = parseInt(itemIdNum, 10);
                                }
                                if (isNaN(itemIdNum)) {
                                    throw new Error('Invalid item ID');
                                }
                                onSave(itemIdNum, payload).then(function(response) {
                                    // Commit 2.3.5.1: Show warning banner only if: RFQ exists AND bids exist AND dims/qty changed
                                    if (response && response.has_warning && itemState.has_rfq && itemState.has_bids) {
                                        setShowWarningBanner(true);
                                        // Auto-hide after 10 seconds
                                        setTimeout(function() {
                                            setShowWarningBanner(false);
                                        }, 10000);
                                    }
                                    // Commit 2.3.5.3: Close modal after save
                                    setIsSaving(false);
                                    if (onClose) {
                                        onClose();
                                    }
                                }).catch(function(error) {
                                    console.error('Error saving item facts:', error);
                                    alert('Failed to save item facts. Please try again.');
                                    setIsSaving(false);
                                });
                            } else {
                                setIsSaving(false);
                            }
                        } catch (error) {
                            console.error('Error saving item facts:', error);
                            alert('Failed to save item facts. Please try again.');
                            setIsSaving(false);
                        }
                    };
                    
                    // Handle update dimensions and quantity only (after RFQ is submitted)
                    var handleUpdateDimensions = function() {
                        // Prevent update if uploads are in progress
                        if (typeof isUploadingInspiration !== 'undefined' && isUploadingInspiration) {
                            alert('Please wait for image uploads to complete before updating.');
                            return;
                        }
                        
                        setIsSaving(true);
                        
                        try {
                            // Check if computedValues exists, otherwise calculate dims_cm and cbm
                            var dimsCm = null;
                            var cbmValue = null;
                            
                            if (typeof computedValues !== 'undefined' && computedValues) {
                                dimsCm = computedValues.dimsCm;
                                cbmValue = computedValues.cbm;
                            } else {
                                // Calculate dims_cm if not available
                                if (width && depth && height && unit) {
                                    var w = parseFloat(width);
                                    var d = parseFloat(depth);
                                    var h = parseFloat(height);
                                    if (!isNaN(w) && !isNaN(d) && !isNaN(h)) {
                                        if (unit === 'cm') {
                                            dimsCm = { w: w, d: d, h: h };
                                        } else if (unit === 'm') {
                                            dimsCm = { w: w * 100, d: d * 100, h: h * 100 };
                                        } else if (unit === 'in') {
                                            dimsCm = { w: w * 2.54, d: d * 2.54, h: h * 2.54 };
                                        }
                                    }
                                }
                                
                                // Calculate CBM if dims_cm is available
                                if (dimsCm && dimsCm.w && dimsCm.d && dimsCm.h) {
                                    var w_m = dimsCm.w / 100;
                                    var d_m = dimsCm.d / 100;
                                    var h_m = dimsCm.h / 100;
                                    var item_cbm = w_m * d_m * h_m;
                                    var qty = quantity ? parseInt(quantity) : 1;
                                    if (!isNaN(qty) && qty > 0) {
                                        cbmValue = Math.round(item_cbm * qty * 1000) / 1000;
                                    }
                                }
                            }
                            
                            // Process quantity
                            var qtyValue = null;
                            if (quantity !== '' && quantity !== null && quantity !== undefined) {
                                var parsedQty = parseInt(quantity);
                                if (!isNaN(parsedQty) && parsedQty >= 0) {
                                    qtyValue = parsedQty;
                                }
                            }
                            
                            // Only update dimensions and quantity
                            // Build payload - only include fields that have values
                            var payload = {};
                            
                            // Always include quantity (even if null, to clear it)
                            payload.quantity = qtyValue;
                            
                            // Include dims if at least one dimension is provided
                            if (width || depth || height) {
                                payload.dims = {
                                    w: width ? parseFloat(width) : null,
                                    d: depth ? parseFloat(depth) : null,
                                    h: height ? parseFloat(height) : null,
                                    unit: unit || 'in',
                                };
                            }
                            
                            // Only include dims_cm if it's calculated
                            if (dimsCm && typeof dimsCm === 'object') {
                                payload.dims_cm = dimsCm;
                            }
                            
                            // Only include cbm if it's calculated
                            if (cbmValue !== null && cbmValue !== undefined && !isNaN(cbmValue)) {
                                payload.cbm = cbmValue;
                            }
                            
                            console.log('ItemDetailModal (admin.php) - Updating dimensions (handleUpdateDimensions):', {
                                itemId: item.id,
                                quantity: qtyValue,
                                payload: payload
                            });
                            
                            // Update layout (if available - it's optional)
                            // updateLayout is from useBoardStore and may not always be available
                            // The backend save will update the item, so layout update is optional
                            try {
                                if (typeof updateLayout !== 'undefined' && updateLayout && typeof updateLayout === 'function') {
                                    updateLayout(item.id, payload);
                                }
                            } catch (layoutError) {
                                console.warn('Could not update layout (non-critical):', layoutError);
                                // Non-critical error - continue with save
                            }
                            
                            // Call onSave callback (handles AJAX and event logging)
                            if (onSave && typeof onSave === 'function') {
                                var itemIdNum = item.id;
                                if (typeof itemIdNum === 'string' && itemIdNum.indexOf('item-') === 0) {
                                    itemIdNum = parseInt(itemIdNum.replace('item-', ''), 10);
                                } else if (typeof itemIdNum === 'string') {
                                    itemIdNum = parseInt(itemIdNum, 10);
                                }
                                if (isNaN(itemIdNum) || itemIdNum <= 0) {
                                    throw new Error('Invalid item ID: ' + item.id);
                                }
                                
                                console.log('Calling onSave with itemId:', itemIdNum, 'payload:', payload);
                                
                                var savePromise = onSave(itemIdNum, payload);
                                if (savePromise && typeof savePromise.then === 'function') {
                                    savePromise.then(function(response) {
                                        console.log('onSave response:', response);
                                        // Show warning banner if dims/qty changed and bids exist
                                        if (response && response.has_warning && itemState && itemState.has_rfq && itemState.has_bids) {
                                            if (typeof setShowWarningBanner === 'function') {
                                                setShowWarningBanner(true);
                                                setTimeout(function() {
                                                    setShowWarningBanner(false);
                                                }, 10000);
                                            }
                                        }
                                        setIsSaving(false);
                                        alert('Dimensions and quantity updated successfully.');
                                    }).catch(function(error) {
                                        console.error('Error updating dimensions (catch):', error);
                                        var errorMessage = 'Failed to update dimensions.';
                                        if (error && error.message) {
                                            errorMessage += ' ' + error.message;
                                        } else if (error && typeof error === 'string') {
                                            errorMessage += ' ' + error;
                                        }
                                        console.error('Full error object:', error);
                                        alert(errorMessage);
                                        setIsSaving(false);
                                    });
                                } else {
                                    console.error('onSave did not return a promise');
                                    setIsSaving(false);
                                    alert('Error: Save function did not return a promise.');
                                }
                            } else {
                                console.error('onSave is not a function:', typeof onSave);
                                setIsSaving(false);
                                alert('Error: Save function not available.');
                            }
                        } catch (error) {
                            console.error('Error updating dimensions:', error);
                            alert('Failed to update dimensions. Please try again.');
                            setIsSaving(false);
                        }
                    };
                    
                    // Handle inspiration image/PDF upload via file input - upload to WordPress media library
                    // Commit 2.3.5.3: Allow both images and PDFs for inspiration section
                    var handleInspirationFileChange = function(e) {
                        var files = e.target.files;
                        if (!files || files.length === 0) return;
                        
                        // Commit 2.3.5.3: Allow both images and PDFs
                        // Added HEIC support - check by MIME type or file extension
                        var validFiles = Array.from(files).filter(function(file) {
                            var fileName = file.name.toLowerCase();
                            var isImage = file.type.startsWith('image/') || 
                                        fileName.endsWith('.heic') || 
                                        fileName.endsWith('.heif');
                            var isPdf = file.type === 'application/pdf' || fileName.endsWith('.pdf');
                            return isImage || isPdf;
                        });
                        
                        if (validFiles.length === 0) {
                            alert('Please select image or PDF files only.');
                            e.target.value = '';
                            return;
                        }
                        
                        // Separate images (including HEIC) and PDFs
                        var imageFiles = validFiles.filter(function(file) {
                            var fileName = file.name.toLowerCase();
                            return file.type.startsWith('image/') || 
                                   fileName.endsWith('.heic') || 
                                   fileName.endsWith('.heif');
                        });
                        var pdfFiles = validFiles.filter(function(file) {
                            return file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                        });
                        
                        // Get AJAX URL and nonce
                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || 
                                     (typeof ajaxurl !== 'undefined' ? ajaxurl : '<?php echo esc_js( admin_url( 'admin-ajax.php' ) ); ?>');
                        var nonce = (window.n88BoardData && window.n88BoardData.nonce) || 
                                   '<?php echo esc_js( N88_RFQ_Helpers::create_ajax_nonce() ); ?>';
                        
                        if (!nonce) {
                            console.error('Nonce not found. Available:', {
                                n88BoardData: window.n88BoardData,
                                ajaxurl: typeof ajaxurl !== 'undefined' ? ajaxurl : 'undefined'
                            });
                            alert('Security token missing. Please refresh the page and try again.');
                            e.target.value = '';
                            return;
                        }
                        
                        // Set uploading state
                        setIsUploadingInspiration(true);
                        
                        console.log('Uploading inspiration files: ' + imageFiles.length + ' images, ' + pdfFiles.length + ' PDFs');
                        
                        // Initialize upload promise arrays
                        var imageUploadPromises = [];
                        var pdfUploadPromises = [];
                        
                        // Handle case where there are no files to upload
                        if (imageFiles.length === 0 && pdfFiles.length === 0) {
                            setIsUploadingInspiration(false);
                            e.target.value = '';
                            return;
                        }
                        
                        // Upload images to WordPress media library
                        if (imageFiles.length > 0) {
                            imageUploadPromises = imageFiles.map(function(file) {
                            return new Promise(function(resolve, reject) {
                                var formData = new FormData();
                                formData.append('action', 'n88_upload_inspiration_image');
                                formData.append('inspiration_image', file);
                                formData.append('nonce', nonce);
                                
                                console.log('Uploading file: ' + file.name + ', Size: ' + file.size + ', Type: ' + file.type);
                                
                                fetch(ajaxUrl, {
                                    method: 'POST',
                                    body: formData,
                                })
                                .then(function(response) {
                                    if (!response.ok) {
                                        throw new Error('HTTP error! status: ' + response.status);
                                    }
                                    return response.json();
                                })
                                .then(function(data) {
                                    console.log('Upload response:', data);
                                    
                                    // Strict validation: must have success, data, id (numeric > 0), and url (non-empty string)
                                    if (data.success && 
                                        data.data && 
                                        data.data.id && 
                                        Number.isInteger(Number(data.data.id)) && 
                                        Number(data.data.id) > 0 &&
                                        data.data.url && 
                                        typeof data.data.url === 'string' && 
                                        data.data.url.trim().length > 0 &&
                                        (data.data.url.startsWith('http://') || data.data.url.startsWith('https://'))) {
                                        console.log('Image uploaded successfully:', {
                                            id: data.data.id,
                                            url: data.data.url,
                                            title: data.data.title
                                        });
                                        resolve({
                                            type: 'image',
                                            url: data.data.url.trim(),
                                            id: Number(data.data.id),
                                            title: data.data.title || data.data.filename || file.name,
                                        });
                                    } else {
                                        var errorMsg = (data.data && data.data.message) || 'Upload failed - missing or invalid data';
                                        console.error('Failed to upload image:', errorMsg, {
                                            success: data.success,
                                            hasData: !!data.data,
                                            hasId: !!(data.data && data.data.id),
                                            idValue: data.data ? data.data.id : 'no data',
                                            hasUrl: !!(data.data && data.data.url),
                                            urlValue: data.data && data.data.url ? (data.data.url.substring(0, 50) + '...') : 'missing',
                                        });
                                        alert('Failed to upload ' + file.name + ': ' + errorMsg);
                                        resolve(null);
                                    }
                                })
                                .catch(function(error) {
                                    console.error('Error uploading image:', error);
                                    alert('Error uploading ' + file.name + ': ' + error.message);
                                    resolve(null);
                                });
                            });
                        });
                        }
                        
                        // Upload PDFs (Commit 2.3.5.3: PDF support for sketch drawings)
                        if (pdfFiles.length > 0) {
                            pdfUploadPromises = pdfFiles.map(function(file) {
                            return new Promise(function(resolve, reject) {
                                var formData = new FormData();
                                formData.append('action', 'n88_upload_inspiration_image');
                                formData.append('inspiration_image', file);
                                formData.append('nonce', nonce);
                                
                                console.log('Uploading PDF: ' + file.name + ', Size: ' + file.size + ', Type: ' + file.type);
                                
                                fetch(ajaxUrl, {
                                    method: 'POST',
                                    body: formData,
                                })
                                .then(function(response) {
                                    if (!response.ok) {
                                        throw new Error('HTTP error! status: ' + response.status);
                                    }
                                    return response.json();
                                })
                                .then(function(data) {
                                    console.log('PDF upload response:', data);
                                    
                                    if (data.success && 
                                        data.data && 
                                        data.data.id && 
                                        Number.isInteger(Number(data.data.id)) && 
                                        Number(data.data.id) > 0 &&
                                        data.data.url && 
                                        typeof data.data.url === 'string' && 
                                        data.data.url.trim().length > 0 &&
                                        (data.data.url.startsWith('http://') || data.data.url.startsWith('https://'))) {
                                        console.log('PDF uploaded successfully:', {
                                            id: data.data.id,
                                            url: data.data.url,
                                            title: data.data.title
                                        });
                                        resolve({
                                            type: 'pdf',
                                            url: data.data.url.trim(),
                                            id: Number(data.data.id),
                                            title: data.data.title || data.data.filename || file.name,
                                        });
                                    } else {
                                        var errorMsg = (data.data && data.data.message) || 'Upload failed - missing or invalid data';
                                        console.error('Failed to upload PDF:', errorMsg);
                                        alert('Failed to upload ' + file.name + ': ' + errorMsg);
                                        resolve(null);
                                    }
                                })
                                .catch(function(error) {
                                    console.error('Error uploading PDF:', error);
                                    alert('Error uploading ' + file.name + ': ' + error.message);
                                    resolve(null);
                                });
                            });
                        });
                        }
                        
                        // Wait for all uploads to complete (images + PDFs)
                        var allUploadPromises = imageUploadPromises.concat(pdfUploadPromises);
                        if (allUploadPromises.length === 0) {
                            setIsUploadingInspiration(false);
                            e.target.value = '';
                            return;
                        }
                        Promise.all(allUploadPromises).then(function(allUploaded) {
                            // Filter out failed uploads - only add files with valid IDs and URLs
                            var validFiles = allUploaded.filter(function(file) {
                                if (!file || typeof file !== 'object') return false;
                                var hasId = file.id && Number.isInteger(Number(file.id)) && Number(file.id) > 0;
                                var url = file.url ? String(file.url).trim() : '';
                                var hasUrl = url && 
                                    url.length > 0 &&
                                    (url.startsWith('http://') || url.startsWith('https://')) && 
                                    !url.startsWith('data:');
                                var isValid = hasId && hasUrl;
                                if (!isValid) {
                                    console.warn('Filtering out invalid uploaded file:', file);
                                }
                                return isValid;
                            });
                            
                            if (validFiles.length > 0) {
                                console.log('Adding ' + validFiles.length + ' files to inspiration array');
                                setInspiration(function(prev) {
                                    return prev.concat(validFiles);
                                });
                            } else {
                                console.warn('No files were successfully uploaded');
                                if (allUploaded.length > 0) {
                                    alert('No files were successfully uploaded. Please try again.');
                                } else if (imageFiles.length > 0 || pdfFiles.length > 0) {
                                    alert('Failed to upload files. Please check your connection and try again.');
                                }
                            }
                            
                            // Reset uploading state
                            setIsUploadingInspiration(false);
                            
                            // Reset input
                            e.target.value = '';
                        }).catch(function(error) {
                            console.error('Error during upload process:', error);
                            alert('Error uploading images: ' + error.message);
                            setIsUploadingInspiration(false);
                            e.target.value = '';
                        });
                    };
                    
                    if (!isOpen) return null;
                    
                    // Dark theme colors (matching wireframes)
                    var darkBg = '#000000';
                    var darkText = '#d3d3d3';
                    var greenAccent = '#00ff00';
                    var darkBorder = '#333333';
                    
                    // Use ReactDOM.createPortal to render modal outside canvas container
                    // Build children array for Fragment
                    var fragmentChildren = [
                        // Backdrop
                        React.createElement('div', {
                            onClick: onClose,
                            style: {
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                // backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                zIndex: 9999999,
                            }
                        }),
                        // Modal - Full screen with 50px margin on all sides
                        React.createElement('div', {
                            onClick: function(e) { e.stopPropagation(); },
                            style: {
                                position: 'fixed',
                                top: '0px',
                                left: '0px',
                                right: '0px',
                                bottom: '0px',
                                backgroundColor: darkBg,
                                color: darkText,
                                fontFamily: 'monospace',
                                zIndex: 10000000,
                                display: 'flex',
                                flexDirection: 'column',
                                overflow: 'hidden',
                                border: '1px solid ' + darkBorder,
                                borderRadius: '8px',
                                margin: '20px',
                                padding: 0,

                            }
                        },
                            // Header with Board/Item info (left) and Action Dropdown + Close (right)
                            React.createElement('div', {
                                style: {
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    padding: '16px 20px',
                                    borderBottom: '1px solid ' + darkBorder,
                                    flexShrink: 0,
                                }
                            },
                                // Board Name and Item ID - Left
                                React.createElement('div', {
                                    style: {
                                        fontSize: '12px',
                                        color: darkText,
                                        fontFamily: 'monospace',
                                        display: 'flex',
                                        alignItems: 'center',
                                    }
                                },
                                    React.createElement('span', null, 'Board : '),
                                    React.createElement('span', { style: { color: greenAccent } }, (window.n88BoardData && window.n88BoardData.boardName) || 'Demo Board'),
                                    React.createElement('span', { style: { margin: '0 8px' } }, ' / '),
                                    React.createElement('span', null, 'Item '),
                                    React.createElement('span', { style: { color: greenAccent } }, itemId ? String(itemId) : (item.id ? (typeof item.id === 'string' && item.id.indexOf('item-') === 0 ? item.id.replace('item-', '') : String(item.id)) : 'N/A'))
                                ),
                                // Action Dropdown + Close Button - Right
                                React.createElement('div', {
                                    style: {
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px',
                                    }
                                },
                                    // Action Dropdown (read-only)
                                    React.createElement('div', {
                                        style: { position: 'relative' }
                                    },
                                        React.createElement('button', {
                                            style: {
                                                background: '#111111',
                                                border: '1px solid ' + darkBorder,
                                                color: darkText,
                                                fontSize: '12px',
                                                padding: '8px 16px',
                                                cursor: 'pointer',
                                                fontFamily: 'monospace',
                                                borderRadius: '4px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '8px',
                                            },
                                            disabled: true
                                        },
                                            'Add to Project',
                                            React.createElement('span', { style: { fontSize: '10px' } }, '▼')
                                        )
                                    ),
                                    // Close Button - Right
                                    React.createElement('button', {
                                        onClick: onClose,
                                        style: {
                                            background: 'none',
                                            border: 'none',
                                            color: darkText,
                                            fontSize: '24px',
                                            cursor: 'pointer',
                                            padding: '0',
                                            width: '32px',
                                            height: '32px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontFamily: 'monospace',
                                        }
                                    }, '×')
                                )
                            ),
                            // Main Content - Two Columns
                            React.createElement('div', {
                                style: {
                                    display: 'flex',
                                    flex: 1,
                                    overflow: 'hidden',
                                }
                            },
                                // Left Column - Images
                                React.createElement('div', {
                                    style: {
                                        width: '50%',
                                        borderRight: '1px solid ' + darkBorder,
                                        padding: '20px',
                                        overflowY: 'auto',
                                        scrollbarWidth: 'none',
                                        msOverflowStyle: 'none',
                                    },
                                    className: 'n88-modal-scroll-content'
                                },
                                    // Main Image
                                    (item.imageUrl || item.image_url || item.primary_image_url) ? React.createElement('div', {
                                        style: { marginBottom: '16px' }
                                    },
                                        React.createElement('div', {
                                            style: {
                                                border: '1px solid ' + darkBorder,
                                                borderRadius: '4px',
                                                padding: '12px',
                                                backgroundColor: '#111111',
                                                minHeight: '200px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                cursor: 'pointer',
                                            },
                                            onClick: function() {
                                                setLightboxImage(item.imageUrl || item.image_url || item.primary_image_url);
                                            }
                                        },
                                            React.createElement('img', {
                                                src: item.imageUrl || item.image_url || item.primary_image_url,
                                                alt: 'Primary',
                                                style: {
                                                    maxWidth: '100%',
                                                    maxHeight: '300px',
                                                    objectFit: 'contain',
                                                    borderRadius: '4px',
                                                }
                                            })
                                        )
                                    ) : null,
                                    // Inspiration / References / Sketch Drawings (State A only - editable)
                                    isEditable && currentState === 'A' ? React.createElement('div', null,
                                        React.createElement('div', {
                                            style: { marginBottom: '4px', fontSize: '12px', fontWeight: '600' }
                                        }, 'Inspiration / References / Sketch Drawings'),
                                        React.createElement('div', {
                                            style: { marginBottom: '8px', fontSize: '11px', color: '#999' }
                                        }, 'These images are helpful when you\'re ready to request a quote. They will be used as reference materials by suppliers to price accurately.'),
                                        React.createElement('div', {
                                            style: {
                                                display: 'flex',
                                                gap: '8px',
                                                flexWrap: 'wrap',
                                                marginBottom: '8px',
                                            }
                                        },
                                            inspiration.map(function(insp, idx) {
                                                return React.createElement('div', {
                                                    key: idx,
                                                    style: {
                                                        width: '80px',
                                                        height: '80px',
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        backgroundColor: '#111111',
                                                        position: 'relative',
                                                        overflow: 'hidden',
                                                        cursor: 'pointer',
                                                    },
                                                    onClick: function() {
                                                        if (insp.url) {
                                                            if (insp.type === 'pdf' || (typeof insp.url === 'string' && insp.url.toLowerCase().endsWith('.pdf'))) {
                                                                window.open(insp.url, '_blank');
                                                            } else {
                                                                setLightboxImage(insp.url);
                                                            }
                                                        }
                                                    }
                                                },
                                                    insp.url ? (
                                                        (insp.type === 'pdf' || (typeof insp.url === 'string' && insp.url.toLowerCase().endsWith('.pdf'))) ? 
                                                        React.createElement('div', {
                                                            style: {
                                                                width: '100%',
                                                                height: '100%',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center',
                                                                backgroundColor: '#222',
                                                                borderRadius: '4px',
                                                                flexDirection: 'column',
                                                                gap: '4px',
                                                            }
                                                        },
                                                            React.createElement('div', { style: { fontSize: '24px' } }, '📄'),
                                                            React.createElement('div', { style: { fontSize: '8px', color: '#999' } }, 'PDF')
                                                        ) :
                                                        React.createElement('img', {
                                                            src: insp.url,
                                                            alt: insp.title || 'Reference',
                                                            style: {
                                                                width: '100%',
                                                                height: '100%',
                                                                objectFit: 'cover',
                                                                borderRadius: '4px',
                                                            }
                                                        })
                                                    ) : React.createElement('div', {
                                                        style: { fontSize: '10px', color: '#666' }
                                                    }, '[ img ]'),
                                                    React.createElement('button', {
                                                        onClick: function(e) {
                                                            e.stopPropagation();
                                                            setInspiration(inspiration.filter(function(_, i) { return i !== idx; }));
                                                        },
                                                        style: {
                                                            position: 'absolute',
                                                            top: '4px',
                                                            right: '4px',
                                                            background: '#ff0000',
                                                            color: '#fff',
                                                            border: 'none',
                                                            borderRadius: '50%',
                                                            width: '20px',
                                                            height: '20px',
                                                            cursor: 'pointer',
                                                            fontSize: '12px',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            padding: 0,
                                                        }
                                                    }, '×')
                                                );
                                            })
                                        )
                                    ) : null,
                                    // Reference Images (State B only - read-only)
                                    currentState === 'B' && inspiration && inspiration.length > 0 ? React.createElement('div', null,
                                        React.createElement('div', {
                                            style: { marginBottom: '12px', fontSize: '12px', color: darkText, opacity: 0.7 }
                                        }, 'Reference Images'),
                                        React.createElement('div', {
                                            style: {
                                                display: 'flex',
                                                gap: '8px',
                                                flexWrap: 'wrap',
                                            }
                                        },
                                            inspiration.map(function(insp, idx) {
                                                return React.createElement('div', {
                                                    key: idx,
                                                    style: {
                                                        width: '80px',
                                                        height: '80px',
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        backgroundColor: '#111111',
                                                        position: 'relative',
                                                        overflow: 'hidden',
                                                        cursor: 'pointer',
                                                    },
                                                    onClick: function() {
                                                        if (insp.url) {
                                                            if (insp.type === 'pdf' || (typeof insp.url === 'string' && insp.url.toLowerCase().endsWith('.pdf'))) {
                                                                window.open(insp.url, '_blank');
                                                            } else {
                                                                setLightboxImage(insp.url);
                                                            }
                                                        }
                                                    }
                                                },
                                                    insp.url ? (
                                                        (insp.type === 'pdf' || (typeof insp.url === 'string' && insp.url.toLowerCase().endsWith('.pdf'))) ? 
                                                        React.createElement('div', {
                                                            style: {
                                                                width: '100%',
                                                                height: '100%',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center',
                                                                backgroundColor: '#222',
                                                                borderRadius: '4px',
                                                                flexDirection: 'column',
                                                                gap: '4px',
                                                            }
                                                        },
                                                            React.createElement('div', { style: { fontSize: '24px' } }, '📄'),
                                                            React.createElement('div', { style: { fontSize: '8px', color: '#999' } }, 'PDF')
                                                        ) :
                                                        React.createElement('img', {
                                                            src: insp.url,
                                                            alt: insp.title || 'Reference',
                                                            style: {
                                                                width: '100%',
                                                                height: '100%',
                                                                objectFit: 'cover',
                                                                borderRadius: '4px',
                                                            }
                                                        })
                                                    ) : React.createElement('div', {
                                                        style: { fontSize: '10px', color: '#666' }
                                                    }, '[ img ]')
                                                );
                                            })
                                        )
                                    ) : null
                                ),
                                // Right Column - Tabs
                                React.createElement('div', {
                                    style: {
                                        width: '50%',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        overflow: 'hidden',
                                    }
                                },
                                    // Tabs Header
                                    React.createElement('div', {
                                        style: {
                                            display: 'flex',
                                            borderBottom: '1px solid ' + darkBorder,
                                            flexShrink: 0,
                                        }
                                    },
                                        React.createElement('button', {
                                            onClick: function() { setActiveTab('details'); },
                                            style: {
                                                flex: 1,
                                                padding: '12px 16px',
                                                background: activeTab === 'details' ? '#111111' : 'transparent',
                                                border: 'none',
                                                borderBottom: activeTab === 'details' ? '2px solid ' + greenAccent : 'none',
                                                color: activeTab === 'details' ? greenAccent : darkText,
                                                fontSize: '12px',
                                                fontWeight: activeTab === 'details' ? '600' : '400',
                                                cursor: 'pointer',
                                                fontFamily: 'monospace',
                                            }
                                        }, 'The Mission Spec'),
                                        React.createElement('button', {
                                            onClick: function() { setActiveTab('rfq'); },
                                            style: {
                                                flex: 1,
                                                padding: '12px 16px',
                                                background: activeTab === 'rfq' ? '#111111' : 'transparent',
                                                border: 'none',
                                                borderBottom: activeTab === 'rfq' ? '2px solid ' + greenAccent : 'none',
                                                color: activeTab === 'rfq' ? greenAccent : darkText,
                                                fontSize: '12px',
                                                fontWeight: activeTab === 'rfq' ? '600' : '400',
                                                cursor: 'pointer',
                                                fontFamily: 'monospace',
                                            }
                                        }, 'Launch Brief'),
                                        React.createElement('button', {
                                            onClick: function() { setActiveTab('timeline'); },
                                            style: {
                                                flex: 1,
                                                padding: '12px 16px',
                                                background: activeTab === 'timeline' ? '#111111' : 'transparent',
                                                border: 'none',
                                                borderBottom: activeTab === 'timeline' ? '2px solid ' + greenAccent : 'none',
                                                color: activeTab === 'timeline' ? greenAccent : darkText,
                                                fontSize: '12px',
                                                fontWeight: activeTab === 'timeline' ? '600' : '400',
                                                cursor: 'pointer',
                                                fontFamily: 'monospace',
                                            }
                                        }, 'The Workflow'),
                                        itemState.has_bids && itemState.bids && itemState.bids.length > 0 ? React.createElement('button', {
                                            onClick: function() { setActiveTab('bids'); },
                                            style: {
                                                flex: 1,
                                                padding: '12px 16px',
                                                background: activeTab === 'bids' ? '#111111' : 'transparent',
                                                border: 'none',
                                                borderBottom: activeTab === 'bids' ? '2px solid ' + greenAccent : 'none',
                                                color: activeTab === 'bids' ? greenAccent : darkText,
                                                fontSize: '12px',
                                                fontWeight: activeTab === 'bids' ? '600' : '400',
                                                cursor: 'pointer',
                                                fontFamily: 'monospace',
                                            }
                                        }, 'Proposals Received (' + itemState.bids.length + ')') : null
                                    ),
                                    // Tab Content
                                    React.createElement('div', {
                                        style: {
                                            flex: 1,
                                            overflowY: 'auto',
                                            padding: '20px',
                                            scrollbarWidth: 'none',
                                            msOverflowStyle: 'none',
                                        },
                                        className: 'n88-modal-scroll-content'
                                    },
                                        // Tab 1: The Mission Spec
                                        activeTab === 'details' ? React.createElement('div', null,
                                            // Action Required Banner - Show when operator has sent messages
                                            itemState.has_unread_operator_messages ? React.createElement('div', {
                                                style: {
                                                    marginBottom: '24px',
                                                    padding: '16px',
                                                    backgroundColor: '#330000',
                                                    border: '2px solid #ff0000',
                                                    borderRadius: '4px',
                                                }
                                            },
                                            React.createElement('div', {
                                                style: {
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        color: '#ff0000',
                                                        marginBottom: '8px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px',
                                                    }
                                                },
                                                    React.createElement('span', null, '⚠️'),
                                                    React.createElement('span', null, 'Action Required')
                                                ),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        color: '#ff6666',
                                                        lineHeight: '1.5',
                                                    }
                                                }, 'You have ' + (itemState.unread_operator_messages || 0) + ' unread message' + (itemState.unread_operator_messages !== 1 ? 's' : '') + ' from the operator. Please review and respond.')
                                            ) : null,
                                            
                                            // Commit 2.3.9.1C-a: Message Operator Section - allow CAD flow too
                                            (itemState.has_rfq || itemState.has_prototype_payment) ? React.createElement('div', {
                                                style: {
                                                    marginBottom: '24px',
                                                }
                                            },
                                                !showDesignerMessageForm ? React.createElement('button', {
                                                    onClick: function() {
                                                        setShowDesignerMessageForm(true);
                                                        loadDesignerMessages();
                                                    },
                                                    style: {
                                                        width: '100%',
                                                        padding: '12px',
                                                        backgroundColor: '#111111',
                                                        border: '1px solid ' + darkBorder,
                                                    borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '14px',
                                                        fontFamily: 'monospace',
                                                        cursor: 'pointer',
                                                        fontWeight: '600',
                                                    },
                                                    onMouseOver: function(e) { e.target.style.backgroundColor = '#1a1a1a'; },
                                                    onMouseOut: function(e) { e.target.style.backgroundColor = '#111111'; }
                                                }, 'Message Operator') : React.createElement('div', {
                                                    style: {
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        padding: '16px',
                                                        backgroundColor: '#111111',
                                                    }
                                                },
                                                    React.createElement('div', {
                                                        style: {
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            marginBottom: '16px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '14px',
                                                                fontWeight: '600',
                                                                color: darkText,
                                                            }
                                                        }, 'Message Operator'),
                                                        React.createElement('button', {
                                                            onClick: function() { setShowDesignerMessageForm(false); },
                                                            style: {
                                                                background: 'none',
                                                                border: 'none',
                                                                color: darkText,
                                                                fontSize: '20px',
                                                                cursor: 'pointer',
                                                                padding: '0',
                                                                width: '24px',
                                                                height: '24px',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center',
                                                            }
                                                        }, '×')
                                                    ),
                                                    // WhatsApp-Style Chat Messages
                                                    React.createElement('div', {
                                                        id: 'n88-designer-messages-container-admin',
                                                        style: {
                                                            height: '400px',
                                                            overflowY: 'auto',
                                                            padding: '16px',
                                                            backgroundColor: '#0a0a0a',
                                                            borderRadius: '4px',
                                                            marginBottom: '12px',
                                                            border: '1px solid ' + darkBorder,
                                                            display: 'flex',
                                                            flexDirection: 'column',
                                                        }
                                                    },
                                                        // CAD Review - inside chat area when CAD received from operator
                                                        itemState.has_prototype_payment &&
                                                            itemState.prototype_payment_status === 'marked_received' &&
                                                            itemState.cad_current_version &&
                                                            Number(itemState.cad_current_version) > 0 &&
                                                            (itemState.cad_status === 'uploaded' || itemState.cad_status === 'revision_requested' || itemState.cad_status === 'approved') ? React.createElement('div', {
                                                            style: {
                                                                marginBottom: '12px',
                                                                padding: '16px',
                                                                backgroundColor: '#0a0a14',
                                                                border: '1px solid #333',
                                                                borderRadius: '4px',
                                                                flexShrink: 0,
                                                            }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '14px', fontWeight: '700', color: '#66aaff', marginBottom: '10px' }
                                                            }, 'CAD Review'),
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', color: '#ccc', marginBottom: '10px', lineHeight: '1.5' }
                                                            },
                                                                React.createElement('span', null, 'Current CAD: '),
                                                                React.createElement('span', { style: { color: '#fff', fontWeight: 700 } }, 'v' + itemState.cad_current_version),
                                                                itemState.cad_status === 'approved' && itemState.cad_approved_version ? React.createElement('span', {
                                                                    style: { marginLeft: '10px', color: '#00ff00' }
                                                                }, '✓ Approved (v' + itemState.cad_approved_version + ')') : null
                                                            ),
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', color: '#ccc', marginBottom: '12px' }
                                                            },
                                                                React.createElement('span', null, 'Rounds Used: '),
                                                                React.createElement('span', { style: { color: '#fff' } }, itemState.cad_revision_rounds_used || 0),
                                                                React.createElement('span', null, ' of '),
                                                                React.createElement('span', { style: { color: '#fff' } }, itemState.cad_revision_rounds_included || 0),
                                                                ((itemState.cad_revision_rounds_included || 0) > 0 && (itemState.cad_revision_rounds_used || 0) >= (itemState.cad_revision_rounds_included || 0)) ? React.createElement('span', {
                                                                    style: { marginLeft: '10px', color: '#ffaa00' }
                                                                }, 'Additional fee required (future commit)') : null
                                                            ),
                                                            itemState.cad_status !== 'approved' ? (
                                                                !showRevisionUpload ? React.createElement('div', {
                                                                    style: { display: 'flex', gap: '10px' }
                                                                },
                                                                    React.createElement('button', {
                                                                        type: 'button',
                                                                        onClick: function() { setShowRevisionUpload(true); },
                                                                        disabled: isCadActionBusy,
                                                                        style: {
                                                                            flex: 1,
                                                                            padding: '10px 12px',
                                                                            backgroundColor: '#111111',
                                                                            border: '1px solid #666',
                                                                            borderRadius: '4px',
                                                                            color: '#fff',
                                                                            fontFamily: 'monospace',
                                                                            fontSize: '12px',
                                                                            cursor: isCadActionBusy ? 'not-allowed' : 'pointer',
                                                                            opacity: isCadActionBusy ? 0.6 : 1,
                                                                        }
                                                                    }, 'Request Revision'),
                                                                    React.createElement('button', {
                                                                        type: 'button',
                                                                        onClick: approveCad,
                                                                        disabled: isCadActionBusy,
                                                                        style: {
                                                                            flex: 1,
                                                                            padding: '10px 12px',
                                                                            backgroundColor: '#003300',
                                                                            border: '1px solid #00ff00',
                                                                            borderRadius: '4px',
                                                                            color: '#00ff00',
                                                                            fontFamily: 'monospace',
                                                                            fontSize: '12px',
                                                                            fontWeight: 700,
                                                                            cursor: isCadActionBusy ? 'not-allowed' : 'pointer',
                                                                            opacity: isCadActionBusy ? 0.6 : 1,
                                                                        }
                                                                    }, 'Approve CAD')
                                                                ) : React.createElement('div', {
                                                                    style: {
                                                                        padding: '12px',
                                                                        backgroundColor: '#0a0a0a',
                                                                        border: '1px solid #333',
                                                                        borderRadius: '4px',
                                                                    }
                                                                },
                                                                    React.createElement('div', {
                                                                        style: { fontSize: '12px', fontWeight: '600', color: '#fff', marginBottom: '8px' }
                                                                    }, 'Upload Files for Revision Request'),
                                                                    React.createElement('div', {
                                                                        onDrop: function(e) {
                                                                            e.preventDefault();
                                                                            var files = Array.from(e.dataTransfer.files).filter(function(f) {
                                                                                return f.type === 'application/pdf' || f.type.indexOf('image/') === 0;
                                                                            });
                                                                            setRevisionFiles(function(prev) { return prev.concat(files); });
                                                                        },
                                                                        onDragOver: function(e) { e.preventDefault(); },
                                                                        onClick: function() {
                                                                            var input = document.createElement('input');
                                                                            input.type = 'file';
                                                                            input.multiple = true;
                                                                            input.accept = '.pdf,.jpg,.jpeg,.png';
                                                                            input.onchange = function(e) {
                                                                                var files = Array.from(e.target.files || []).filter(function(f) {
                                                                                    return f.type === 'application/pdf' || f.type.indexOf('image/') === 0;
                                                                                });
                                                                                setRevisionFiles(function(prev) { return prev.concat(files); });
                                                                            };
                                                                            input.click();
                                                                        },
                                                                        style: {
                                                                            border: '2px dashed #666',
                                                                            padding: '20px',
                                                                            textAlign: 'center',
                                                                            marginBottom: '12px',
                                                                            cursor: 'pointer',
                                                                            color: '#999',
                                                                            fontSize: '11px',
                                                                        }
                                                                    }, 'Drag & Drop Files (PDF, JPG, PNG) or Click to Upload'),
                                                                    revisionFiles.length > 0 ? React.createElement('div', {
                                                                        style: { marginBottom: '12px' }
                                                                    }, revisionFiles.map(function(file, idx) {
                                                                        return React.createElement('div', {
                                                                            key: idx,
                                                                            style: {
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                justifyContent: 'space-between',
                                                                                padding: '6px 10px',
                                                                                backgroundColor: '#1a1a1a',
                                                                                border: '1px solid #333',
                                                                                borderRadius: '4px',
                                                                                marginBottom: '6px',
                                                                                fontSize: '11px',
                                                                                color: '#fff',
                                                                            }
                                                                        },
                                                                            React.createElement('span', null, file.name),
                                                                            React.createElement('button', {
                                                                                type: 'button',
                                                                                onClick: function() {
                                                                                    setRevisionFiles(function(prev) {
                                                                                        return prev.filter(function(_, i) { return i !== idx; });
                                                                                    });
                                                                                },
                                                                                style: {
                                                                                    background: 'none',
                                                                                    border: 'none',
                                                                                    color: '#ff6666',
                                                                                    cursor: 'pointer',
                                                                                    fontSize: '14px',
                                                                                    padding: '0 4px',
                                                                                }
                                                                            }, '×')
                                                                        );
                                                                    })) : null,
                                                                    React.createElement('div', {
                                                                        style: { display: 'flex', gap: '8px' }
                                                                    },
                                                                        React.createElement('button', {
                                                                            type: 'button',
                                                                            onClick: function() {
                                                                                setShowRevisionUpload(false);
                                                                                setRevisionFiles([]);
                                                                            },
                                                                            style: {
                                                                                flex: 1,
                                                                                padding: '8px 12px',
                                                                                backgroundColor: '#333',
                                                                                border: '1px solid #666',
                                                                                borderRadius: '4px',
                                                                                color: '#fff',
                                                                                fontFamily: 'monospace',
                                                                                fontSize: '11px',
                                                                                cursor: 'pointer',
                                                                            }
                                                                        }, 'Cancel'),
                                                                        React.createElement('button', {
                                                                            type: 'button',
                                                                            onClick: function() { requestCadRevision(revisionFiles); },
                                                                            disabled: isCadActionBusy || revisionFiles.length === 0,
                                                                            style: {
                                                                                flex: 1,
                                                                                padding: '8px 12px',
                                                                                backgroundColor: revisionFiles.length === 0 ? '#333' : '#111111',
                                                                                border: '1px solid #666',
                                                                                borderRadius: '4px',
                                                                                color: '#fff',
                                                                                fontFamily: 'monospace',
                                                                                fontSize: '11px',
                                                                                cursor: revisionFiles.length === 0 ? 'not-allowed' : 'pointer',
                                                                                opacity: revisionFiles.length === 0 ? 0.5 : 1,
                                                                            }
                                                                        }, isCadActionBusy ? 'Requesting...' : 'Request Revision')
                                                                    )
                                                                )
                                                            ) : null
                                                        ) : null,
                                                        isLoadingDesignerMessages ? React.createElement('div', {
                                                            style: {
                                                                textAlign: 'center',
                                                                color: '#666',
                                                                fontSize: '12px',
                                                                padding: '20px',
                                                                margin: 'auto',
                                                            }
                                                        }, 'Loading conversation...') : designerMessages.length === 0 ? React.createElement('div', {
                                                            style: {
                                                                textAlign: 'center',
                                                                color: '#666',
                                                                fontSize: '12px',
                                                                padding: '20px',
                                                                margin: 'auto',
                                                            }
                                                        }, 'No messages yet. Start the conversation!') : (function() {
                                                            // Sort messages chronologically
                                                            var sortedMessages = designerMessages.slice().sort(function(a, b) {
                                                                return new Date(a.created_at) - new Date(b.created_at);
                                                            });
                                                            return sortedMessages.map(function(msg, idx) {
                                                                var isDesigner = msg.sender_role === 'designer';
                                                                var senderName = isDesigner ? 'You' : 'Operator';
                                                                
                                                                var date = new Date(msg.created_at);
                                                                var dateStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                                                var rawText = msg.message_text || '';

                                                                // Commit 2.3.9.2A: Render CAD upload messages and revision request messages with clickable file cards
                                                                var isCadUploadMessage = !isDesigner &&
                                                                    rawText.indexOf('CAD v') !== -1 &&
                                                                    rawText.indexOf('uploaded') !== -1 &&
                                                                    rawText.indexOf('Files:') !== -1;
                                                                
                                                                var isRevisionRequestMessage = isDesigner &&
                                                                    rawText.indexOf('Revision requested') !== -1 &&
                                                                    rawText.indexOf('Files:') !== -1;

                                                                var renderedText = rawText;
                                                                var cadFiles = [];

                                                                if (isCadUploadMessage || isRevisionRequestMessage) {
                                                                    var lines = rawText.split('\n');
                                                                    var filesStartIndex = -1;
                                                                    for (var li = 0; li < lines.length; li++) {
                                                                        if ((lines[li] || '').trim() === 'Files:') {
                                                                            filesStartIndex = li;
                                                                            break;
                                                                        }
                                                                    }
                                                                    if (filesStartIndex >= 0) {
                                                                        renderedText = lines.slice(0, filesStartIndex).join('\n');
                                                                        var fileLines = lines.slice(filesStartIndex + 1);
                                                                        for (var fi = 0; fi < fileLines.length; fi++) {
                                                                            var line = (fileLines[fi] || '').trim();
                                                                            // Parse: "- filename.ext: https://..."
                                                                            if (line.indexOf('- ') === 0) {
                                                                                var withoutDash = line.slice(2);
                                                                                var sepIdx = withoutDash.indexOf(': ');
                                                                                if (sepIdx > 0) {
                                                                                    var fileName = withoutDash.slice(0, sepIdx).trim();
                                                                                    var fileUrl = withoutDash.slice(sepIdx + 2).trim();
                                                                                    if (fileUrl.indexOf('http://') === 0 || fileUrl.indexOf('https://') === 0) {
                                                                                        var ext = '';
                                                                                        if (fileName.indexOf('.') !== -1) {
                                                                                            ext = fileName.split('.').pop().toLowerCase();
                                                                                        }
                                                                                        cadFiles.push({ name: fileName, url: fileUrl, ext: ext });
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                
                                                                return React.createElement('div', {
                                                                    key: idx,
                                                                    style: {
                                                                        marginBottom: '12px',
                                                                        display: 'flex',
                                                                        justifyContent: isDesigner ? 'flex-end' : 'flex-start',
                                                                        width: '100%',
                                                                    }
                                                                },
                                                                    React.createElement('div', {
                                                                        style: {
                                                                            maxWidth: '75%',
                                                                            padding: '10px 14px',
                                                                            backgroundColor: isDesigner ? '#1a1a1a' : '#0a0a0a',
                                                                            border: '1px solid ' + (isDesigner ? greenAccent : '#333'),
                                                                            borderRadius: isDesigner ? '12px 12px 4px 12px' : '12px 12px 12px 4px',
                                                                            fontSize: '12px',
                                                                            color: '#fff',
                                                                            wordWrap: 'break-word',
                                                                            whiteSpace: 'pre-wrap',
                                                                        }
                                                                    },
                                                                        React.createElement('div', {
                                                                            style: {
                                                                                fontSize: '10px',
                                                                                fontWeight: '600',
                                                                                color: isDesigner ? greenAccent : '#00aa00',
                                                                                marginBottom: '4px',
                                                                            }
                                                                        }, senderName),
                                                                        React.createElement('div', {
                                                                            style: {
                                                                                fontSize: '12px',
                                                                                lineHeight: '1.4',
                                                                                marginBottom: '4px',
                                                                            }
                                                                        },
                                                                            React.createElement('div', null, renderedText),
                                                                            ((isCadUploadMessage || isRevisionRequestMessage) && cadFiles.length > 0) ? React.createElement('div', {
                                                                                style: {
                                                                                    marginTop: '12px',
                                                                                    paddingTop: '12px',
                                                                                    borderTop: '1px solid #333',
                                                                                    display: 'flex',
                                                                                    flexDirection: 'column',
                                                                                    gap: '8px',
                                                                                }
                                                                            }, cadFiles.map(function(file, fidx) {
                                                                                var isPdf = file.ext === 'pdf';
                                                                                var isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].indexOf(file.ext) !== -1;
                                                                                var icon = isPdf ? '📄' : (isImage ? '🖼️' : '📎');

                                                                                return React.createElement('a', {
                                                                                    key: fidx,
                                                                                    href: file.url,
                                                                                    target: '_blank',
                                                                                    rel: 'noopener noreferrer',
                                                                                    style: {
                                                                                        display: 'flex',
                                                                                        alignItems: 'center',
                                                                                        gap: '10px',
                                                                                        padding: '8px 12px',
                                                                                        backgroundColor: '#1a1a1a',
                                                                                        border: '1px solid #333',
                                                                                        borderRadius: '4px',
                                                                                        textDecoration: 'none',
                                                                                        color: '#fff',
                                                                                        cursor: 'pointer',
                                                                                    }
                                                                                }, 
                                                                                    React.createElement('span', { style: { fontSize: '18px', width: '24px', textAlign: 'center' } }, icon),
                                                                                    React.createElement('span', { style: { flex: 1, fontSize: '11px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, file.name),
                                                                                    React.createElement('span', { style: { fontSize: '10px', color: greenAccent } }, 'Open →')
                                                                                );
                                                                            })) : null
                                                                        ),
                                                                        React.createElement('div', {
                                                                            style: {
                                                                                fontSize: '9px',
                                                                                color: '#666',
                                                                                textAlign: 'right',
                                                                            }
                                                                        }, dateStr)
                                                                    )
                                                                );
                                                            });
                                                        })()
                                                    ),
                                                    // Message Input at Bottom
                                                    React.createElement('form', {
                                                        onSubmit: sendDesignerMessage,
                                                        style: {
                                                            display: 'flex',
                                                            gap: '8px',
                                                            alignItems: 'flex-end',
                                                        }
                                                    },
                                                        React.createElement('textarea', {
                                                            value: designerMessageText,
                                                            onChange: function(e) { setDesignerMessageText(e.target.value); },
                                                            required: true,
                                                            rows: 2,
                                                            style: {
                                                                flex: 1,
                                                                padding: '10px 12px',
                                                                backgroundColor: '#000',
                                                                color: '#fff',
                                                                border: '1px solid ' + darkBorder,
                                                                borderRadius: '20px',
                                                        fontFamily: 'monospace',
                                                                fontSize: '12px',
                                                                resize: 'none',
                                                                minHeight: '40px',
                                                                maxHeight: '100px',
                                                            },
                                                            placeholder: 'Type your message here...',
                                                            onKeyDown: function(e) {
                                                                if (e.key === 'Enter' && !e.shiftKey) {
                                                                    e.preventDefault();
                                                                    if (designerMessageText.trim()) {
                                                                        sendDesignerMessage(e);
                                                                    }
                                                                }
                                                            }
                                                        }),
                                                        React.createElement('button', {
                                                            type: 'submit',
                                                            disabled: isSendingDesignerMessage || !designerMessageText.trim(),
                                                            style: {
                                                                padding: '10px 20px',
                                                                backgroundColor: (isSendingDesignerMessage || !designerMessageText.trim()) ? '#333' : greenAccent,
                                                                color: (isSendingDesignerMessage || !designerMessageText.trim()) ? '#666' : '#000',
                                                                border: 'none',
                                                                borderRadius: '20px',
                                                                fontFamily: 'monospace',
                                                                fontSize: '12px',
                                                                fontWeight: '600',
                                                                cursor: (isSendingDesignerMessage || !designerMessageText.trim()) ? 'not-allowed' : 'pointer',
                                                                whiteSpace: 'nowrap',
                                                            },
                                                            onMouseOver: function(e) {
                                                                if (!isSendingDesignerMessage && designerMessageText.trim()) {
                                                                    e.target.style.backgroundColor = '#00cc00';
                                                                }
                                                            },
                                                            onMouseOut: function(e) {
                                                                if (!isSendingDesignerMessage && designerMessageText.trim()) {
                                                                    e.target.style.backgroundColor = greenAccent;
                                                                }
                                                            }
                                                        }, isSendingDesignerMessage ? 'Sending...' : 'Send')
                                                    )
                                                )
                                            ) : null,
                                            // Item Title
                                            React.createElement('div', {
                                                style: { fontSize: '16px', fontWeight: '600', marginBottom: '20px' }
                                            }, item.title || item.description || 'Untitled Item'),
                                            // RFQ Sent Status Indicator moved to Launch Brief tab
                                            // Editable fields section - State A only
                                            currentState !== 'C' && isEditable && currentState === 'A' ? React.createElement(React.Fragment, null,
                                                // Description
                                                React.createElement('div', {
                                                    style: { marginBottom: '24px' }
                                                },
                                                    React.createElement('label', {
                                                        style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                                    }, 'Description (tell us what you\'re sourcing)'),
                                                    React.createElement('textarea', {
                                                        value: description,
                                                        onChange: function(e) { setDescription(e.target.value); },
                                                        placeholder: 'Item description',
                                                        rows: 3,
                                                        style: {
                                                            width: '100%',
                                                            padding: '8px',
                                                            backgroundColor: darkBg,
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                            color: darkText,
                                                            fontSize: '12px',
                                                            fontFamily: 'monospace',
                                                            resize: 'vertical',
                                                        }
                                                    })
                                                ),
                                                // Category
                                                React.createElement('div', {
                                                    style: { marginBottom: '24px' }
                                                },
                                                    React.createElement('label', {
                                                        style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                                    }, 'Category'),
                                                    React.createElement('select', {
                                                        value: category,
                                                        onChange: function(e) { setCategory(e.target.value); },
                                                        style: {
                                                            width: '100%',
                                                            padding: '8px',
                                                            backgroundColor: darkBg,
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                            color: darkText,
                                                            fontSize: '12px',
                                                            fontFamily: 'monospace',
                                                        }
                                                    },
                                                        React.createElement('option', { value: '' }, '-- Select Category --'),
                                                        React.createElement('option', { value: 'Indoor Furniture' }, 'Indoor Furniture'),
                                                        React.createElement('option', { value: 'Sofas & Seating (Indoor)' }, 'Sofas & Seating (Indoor)'),
                                                        React.createElement('option', { value: 'Chairs & Armchairs (Indoor)' }, 'Chairs & Armchairs (Indoor)'),
                                                        React.createElement('option', { value: 'Dining Tables (Indoor)' }, 'Dining Tables (Indoor)'),
                                                        React.createElement('option', { value: 'Cabinetry / Millwork (Custom)' }, 'Cabinetry / Millwork (Custom)'),
                                                        React.createElement('option', { value: 'Casegoods (Beds, Nightstands, Desks, Consoles)' }, 'Casegoods (Beds, Nightstands, Desks, Consoles)'),
                                                        React.createElement('option', { value: 'Outdoor Furniture' }, 'Outdoor Furniture'),
                                                        React.createElement('option', { value: 'Outdoor Seating' }, 'Outdoor Seating'),
                                                        React.createElement('option', { value: 'Outdoor Dining Sets' }, 'Outdoor Dining Sets'),
                                                        React.createElement('option', { value: 'Outdoor Loungers & Daybeds' }, 'Outdoor Loungers & Daybeds'),
                                                        React.createElement('option', { value: 'Pool Furniture' }, 'Pool Furniture'),
                                                        React.createElement('option', { value: 'Lighting' }, 'Lighting'),
                                                        React.createElement('option', { value: 'Decorative Lighting' }, 'Decorative Lighting'),
                                                        React.createElement('option', { value: 'Architectural Lighting' }, 'Architectural Lighting'),
                                                        React.createElement('option', { value: 'Electrical / LED Components' }, 'Electrical / LED Components'),
                                                        React.createElement('option', { value: 'Bathroom Fixtures' }, 'Bathroom Fixtures'),
                                                        React.createElement('option', { value: 'Kitchen Fixtures' }, 'Kitchen Fixtures'),
                                                        React.createElement('option', { value: 'Faucets / Hardware (Plumbing)' }, 'Faucets / Hardware (Plumbing)'),
                                                        React.createElement('option', { value: 'Sinks / Basins' }, 'Sinks / Basins'),
                                                        React.createElement('option', { value: 'Shower Systems / Accessories' }, 'Shower Systems / Accessories'),
                                                        React.createElement('option', { value: 'Marble / Stone' }, 'Marble / Stone'),
                                                        React.createElement('option', { value: 'Granite' }, 'Granite'),
                                                        React.createElement('option', { value: 'Quartz' }, 'Quartz'),
                                                        React.createElement('option', { value: 'Porcelain / Ceramic Slabs' }, 'Porcelain / Ceramic Slabs'),
                                                        React.createElement('option', { value: 'Tile (Wall / Floor)' }, 'Tile (Wall / Floor)'),
                                                        React.createElement('option', { value: 'Terrazzo' }, 'Terrazzo'),
                                                        React.createElement('option', { value: 'Rugs / Carpets' }, 'Rugs / Carpets'),
                                                        React.createElement('option', { value: 'Drapery' }, 'Drapery'),
                                                        React.createElement('option', { value: 'Window Treatments / Shades' }, 'Window Treatments / Shades'),
                                                        React.createElement('option', { value: 'Wallcoverings' }, 'Wallcoverings'),
                                                        React.createElement('option', { value: 'Acoustic Panels' }, 'Acoustic Panels'),
                                                        React.createElement('option', { value: 'Mirrors' }, 'Mirrors'),
                                                        React.createElement('option', { value: 'Artwork' }, 'Artwork'),
                                                        React.createElement('option', { value: 'Decorative Accessories' }, 'Decorative Accessories'),
                                                        React.createElement('option', { value: 'Planters' }, 'Planters'),
                                                        React.createElement('option', { value: 'Sculptural Objects' }, 'Sculptural Objects'),
                                                        React.createElement('option', { value: 'Railings' }, 'Railings'),
                                                        React.createElement('option', { value: 'Screens / Louvers' }, 'Screens / Louvers'),
                                                        React.createElement('option', { value: 'Pergola / Shade Components' }, 'Pergola / Shade Components'),
                                                        React.createElement('option', { value: 'Facade Materials' }, 'Facade Materials'),
                                                        React.createElement('option', { value: 'Material Sample Kit' }, 'Material Sample Kit'),
                                                        React.createElement('option', { value: 'Fabric Sample' }, 'Fabric Sample'),
                                                        React.createElement('option', { value: 'Custom Sourcing / Not Listed' }, 'Custom Sourcing / Not Listed')
                                                    )
                                                )
                                            ) : (currentState === 'B' || currentState === 'C') ? (
                                                // State B and C: Show complete The Mission Spec box
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('div', {
                                                        style: {
                                                            marginBottom: '24px',
                                                            padding: '16px',
                                                            backgroundColor: '#111111',
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                        }
                                                    },
                                                        React.createElement('div', {
                                                            style: {
                                                                fontSize: '14px',
                                                                fontWeight: '600',
                                                                marginBottom: '16px',
                                                                color: darkText,
                                                                borderBottom: '1px solid ' + darkBorder,
                                                                paddingBottom: '8px'
                                                            }
                                                        }, 'The Mission Spec'),
                                                        // Name/Title
                                                        (item.title || item.description) ? React.createElement('div', {
                                                            style: { marginBottom: '12px' }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', marginBottom: '4px', color: darkText, opacity: 0.7 }
                                                            }, 'Name:'),
                                                            React.createElement('div', {
                                                                style: { fontSize: '13px', color: greenAccent, fontWeight: '500' }
                                                            }, item.title || item.description || 'Untitled Item')
                                                        ) : null,
                                                        // Description
                                                        description ? React.createElement('div', {
                                                            style: { marginBottom: '12px' }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', marginBottom: '4px', color: darkText, opacity: 0.7 }
                                                            }, 'Description:'),
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', color: darkText, lineHeight: '1.6' }
                                                            }, description)
                                                        ) : null,
                                                        // Category
                                                        category ? React.createElement('div', {
                                                            style: { marginBottom: '12px' }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', marginBottom: '4px', color: darkText, opacity: 0.7 }
                                                            }, 'Category:'),
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', color: greenAccent }
                                                            }, category)
                                                        ) : null,
                                                        // Timeline Type
                                                        (function() {
                                                            var timelineType = null;
                                                            if (category) {
                                                                var categoryLower = category.toLowerCase();
                                                                var sixStepCategories = ['indoor furniture', 'sofas & seating (indoor)', 'chairs & armchairs (indoor)', 'dining tables (indoor)', 'cabinetry / millwork (custom)', 'casegoods (beds, nightstands, desks, consoles)', 'outdoor furniture', 'outdoor seating', 'outdoor dining sets', 'outdoor loungers & daybeds', 'pool furniture'];
                                                                var fourStepCategories = ['lighting'];
                                                                if (sixStepCategories.some(function(cat) { return categoryLower.indexOf(cat.toLowerCase()) !== -1; })) {
                                                                    timelineType = 'The Workflow';
                                                                } else if (fourStepCategories.some(function(cat) { return categoryLower.indexOf(cat.toLowerCase()) !== -1; })) {
                                                                    timelineType = '4-Step Timeline';
                                                                } else if (categoryLower.indexOf('furniture') !== -1 || categoryLower.indexOf('sofa') !== -1 || categoryLower.indexOf('chair') !== -1 || categoryLower.indexOf('table') !== -1 || categoryLower.indexOf('bed') !== -1 || categoryLower.indexOf('cabinet') !== -1) {
                                                                    timelineType = 'The Workflow';
                                                                } else {
                                                                    timelineType = '4-Step Timeline';
                                                                }
                                                            }
                                                            return timelineType ? React.createElement('div', {
                                                                style: { marginBottom: '12px' }
                                                            },
                                                                React.createElement('div', {
                                                                    style: { fontSize: '12px', marginBottom: '4px', color: darkText, opacity: 0.7 }
                                                                }, 'Timeline Type:'),
                                                                React.createElement('div', {
                                                                    style: { fontSize: '12px', color: greenAccent }
                                                                }, timelineType)
                                                            ) : null;
                                                        })(),
                                                        // Quantity
                                                        quantity ? React.createElement('div', {
                                                            style: { marginBottom: '12px' }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', marginBottom: '4px', color: darkText, opacity: 0.7 }
                                                            }, 'Quantity:'),
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', color: greenAccent }
                                                            }, quantity)
                                                        ) : null,
                                                        // Dimensions
                                                        formatDimensions() ? React.createElement('div', {
                                                            style: { marginBottom: '12px' }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', marginBottom: '4px', color: darkText, opacity: 0.7 }
                                                            }, 'Dimensions:'),
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', color: greenAccent }
                                                            }, formatDimensions())
                                                        ) : null,
                                                        // Notes for suppliers
                                                        smartAlternativesNote ? React.createElement('div', {
                                                            style: { marginBottom: '0' }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', marginBottom: '4px', color: darkText, opacity: 0.7 }
                                                            }, 'Notes for suppliers:'),
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', color: darkText, lineHeight: '1.6' }
                                                            }, smartAlternativesNote)
                                                        ) : null
                                                    )
                                                )
                                            ) : null
                                        ) : null,
                                        // Tab 2: Launch Brief
                                        activeTab === 'rfq' ? React.createElement('div', null,
                                            // RFQ Sent Status Indicator (State B Only)
                                            currentState === 'B' ? React.createElement('div', {
                                                style: {
                                                    marginBottom: '20px',
                                                    padding: '12px 16px',
                                                    backgroundColor: 'rgba(0, 128, 0, 0.08)',
                                                    border: '1px solid rgba(0, 128, 0, 0.2)',
                                                    borderRadius: '4px',
                                                    textAlign: 'center',
                                                    opacity: 0.7,
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '14px',
                                                        fontWeight: '500',
                                                        color: 'rgba(0, 180, 0, 0.6)',
                                                        fontFamily: 'monospace',
                                                    }
                                                }, 'RFQ request sent — waiting to hear back')
                                            ) : null,
                                            // Request Quote Button / RFQ Form (State A only)
                                            currentState === 'A' ? React.createElement('div', {
                                                style: { marginBottom: '24px' }
                                            },
                                    !showRfqForm ? React.createElement('button', {
                                        onClick: function() { setShowRfqForm(true); },
                                            style: {
                                                width: '100%',
                                            padding: '12px',
                                            backgroundColor: '#111111',
                                            border: '1px solid ' + darkBorder,
                                                borderRadius: '4px',
                                            color: darkText,
                                                fontSize: '14px',
                                            fontFamily: 'monospace',
                                            cursor: 'pointer',
                                            fontWeight: '600',
                                            }
                                    }, 'Request Quote') : React.createElement('div', {
                                            style: {
                                            border: '1px solid ' + darkBorder,
                                            borderRadius: '4px',
                                            padding: '16px',
                                            backgroundColor: '#111111',
                                        }
                                        },
                                    React.createElement('div', {
                                                style: {
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                marginBottom: '16px',
                                            }
                                        },
                                            React.createElement('div', {
                                                style: { fontSize: '14px', fontWeight: '600' }
                                            }, 'Request Quote'),
                                        React.createElement('button', {
                                                onClick: function() { setShowRfqForm(false); },
                                        style: {
                                                    background: 'none',
                                                    border: 'none',
                                                    color: darkText,
                                                    fontSize: '20px',
                                                    cursor: 'pointer',
                                                    padding: '0',
                                                    width: '24px',
                                                    height: '24px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                }
                                            }, '×')
                                        ),
                                        // RFQ Form Fields
                                    // Dimensions
                                        React.createElement('div', {
                                            style: { marginBottom: '12px' }
                                        },
                                        React.createElement('label', {
                                                style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                        }, 'Dimensions (provide ideal dimensions when applicable)'),
                                        React.createElement('div', {
                                                style: { display: 'grid', gridTemplateColumns: '80px 80px 80px auto', gap: '8px' }
                                        },
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: width,
                                                    onChange: function(e) { setWidth(e.target.value); },
                                                    placeholder: 'W',
                                                    step: '0.01',
                                                    style: {
                                                        padding: '8px',
                                                        backgroundColor: darkBg,
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                                    }
                                                }),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: depth,
                                                    onChange: function(e) { setDepth(e.target.value); },
                                                    placeholder: 'D',
                                                    step: '0.01',
                                                    style: {
                                                        padding: '8px',
                                                        backgroundColor: darkBg,
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                                    }
                                                }),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: height,
                                                    onChange: function(e) { setHeight(e.target.value); },
                                                    placeholder: 'H',
                                                    step: '0.01',
                                                    style: {
                                                        padding: '8px',
                                                        backgroundColor: darkBg,
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                                    }
                                                }),
                                                React.createElement('select', {
                                                    value: unit,
                                                    onChange: function(e) { setUnit(e.target.value); },
                                                    style: {
                                                        padding: '8px',
                                                        backgroundColor: darkBg,
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                                    }
                                                },
                                                    React.createElement('option', { value: 'in' }, 'in'),
                                                    React.createElement('option', { value: 'cm' }, 'cm'),
                                                    React.createElement('option', { value: 'mm' }, 'mm'),
                                                    React.createElement('option', { value: 'm' }, 'm')
                                    )
                                ),
                                            // Commit 2.3.5.3: CBM calculation removed from display (kept in background for later use)
                                            null
                                        ),
                                        // Quantity
                                        React.createElement('div', {
                                            style: { marginBottom: '12px' }
                                        },
                                        React.createElement('label', {
                                                style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                            }, 'Quantity'),
                                            React.createElement('input', {
                                                type: 'number',
                                                value: quantity,
                                                onChange: function(e) { setQuantity(e.target.value); },
                                                min: '1',
                                            style: {
                                                    width: '100%',
                                                    padding: '8px',
                                                    backgroundColor: darkBg,
                                                    border: '1px solid ' + darkBorder,
                                                borderRadius: '4px',
                                                    color: darkText,
                                                    fontSize: '12px',
                                                    fontFamily: 'monospace',
                                            }
                                            }),
                                            // Commit 2.3.5.3: CBM calculation removed from display (kept in background for later use)
                                            null
                                        ),
                                        // Delivery Country
                                        React.createElement('div', {
                                            style: { marginBottom: '12px' }
                                        },
                                            React.createElement('label', {
                                                style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                            }, 'Delivery Country'),
                                            React.createElement('select', {
                                                value: deliveryCountry,
                                                onChange: function(e) { setDeliveryCountry(e.target.value); },
                                            style: {
                                                    width: '100%',
                                                    padding: '8px',
                                                    backgroundColor: darkBg,
                                                    border: '1px solid ' + darkBorder,
                                                borderRadius: '4px',
                                                    color: darkText,
                                                    fontSize: '12px',
                                                    fontFamily: 'monospace',
                                                }
                                            },
                                                React.createElement('option', { value: '' }, 'Select Country'),
                                                React.createElement('option', { value: 'US' }, 'US'),
                                                React.createElement('option', { value: 'CA' }, 'CA'),
                                                React.createElement('option', { value: 'CN' }, 'CN'),
                                                React.createElement('option', { value: 'VN' }, 'VN'),
                                                React.createElement('option', { value: 'EU' }, 'EU')
                                            )
                                    ),
                                        // ZIP/Postal Code
                                        React.createElement('div', {
                                            style: { marginBottom: '12px' }
                                        },
                                        React.createElement('label', {
                                                style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                            }, 'ZIP/Postal Code'),
                                            React.createElement('input', {
                                                type: 'text',
                                                value: deliveryPostal,
                                                onChange: function(e) { setDeliveryPostal(e.target.value); },
                                                placeholder: 'Required for US/CA',
                                            style: {
                                                    width: '100%',
                                                    padding: '8px',
                                                    backgroundColor: darkBg,
                                                    border: '1px solid ' + darkBorder,
                                                borderRadius: '4px',
                                                    color: darkText,
                                                    fontSize: '12px',
                                                    fontFamily: 'monospace',
                                            }
                                            }),
                                            shippingMessage ? React.createElement('div', {
                                            style: {
                                                    marginTop: '8px',
                                                    fontSize: '11px',
                                                    color: ((deliveryCountry && (deliveryCountry.toUpperCase() === 'US' || deliveryCountry.toUpperCase() === 'CA')) && !deliveryPostal) ? '#ff0000' : '#999',
                                                }
                                            }, shippingMessage) : null
                                        ),
                                        // SMART ALTERNATIVES Section
                                        React.createElement('div', {
                                            style: { marginBottom: '12px' }
                                        },
                                            React.createElement('div', {
                                                style: { marginBottom: '12px', fontSize: '12px', fontWeight: '600' }
                                            }, 'SMART ALTERNATIVES (Optional)'),
                                            React.createElement('div', {
                                                style: { marginBottom: '12px', fontSize: '12px' }
                                            }, 'Are you open to comparable options?'),
                                            React.createElement('div', {
                                                style: { marginBottom: '12px' }
                                            },
                                                React.createElement('label', {
                                            style: {
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px',
                                                        cursor: 'pointer',
                                                        marginBottom: '8px',
                                                    }
                                                },
                                                    React.createElement('input', {
                                                        type: 'radio',
                                                        name: 'smart_alternatives',
                                                        checked: smartAlternativesEnabled,
                                                        onChange: function() { setSmartAlternativesEnabled(true); },
                                            style: {
                                                            width: '16px',
                                                            height: '16px',
                                                            cursor: 'pointer',
                                            }
                                                    }),
                                                    React.createElement('span', {
                                                        style: { fontSize: '12px' }
                                                    }, 'Yes — show me comparable options')
                                                ),
                                        React.createElement('label', {
                                            style: {
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px',
                                                        cursor: 'pointer',
                                            }
                                                },
                                                    React.createElement('input', {
                                                        type: 'radio',
                                                        name: 'smart_alternatives',
                                                        checked: !smartAlternativesEnabled,
                                                        onChange: function() { setSmartAlternativesEnabled(false); },
                                                        style: {
                                                            width: '16px',
                                                            height: '16px',
                                                            cursor: 'pointer',
                                                        }
                                                    }),
                                                    React.createElement('span', {
                                                        style: { fontSize: '12px' }
                                                    }, 'No — proceed as specified')
                                                )
                                            ),
                                            React.createElement('div', {
                                        style: {
                                                    display: 'flex',
                                                    alignItems: 'flex-start',
                                                    gap: '8px',
                                                    marginBottom: '12px',
                                                    fontSize: '11px',
                                                    color: '#999',
                                                }
                                            },
                                                React.createElement('span', { style: { fontSize: '14px' } }, 'i'),
                                                React.createElement('span', null, 'Suppliers may suggest equivalent materials or construction methods. No contact info is shared.')
                                            ),
                                            React.createElement('div', {
                                                style: { marginBottom: '8px', fontSize: '12px' }
                                            }, 'Notes for suppliers (optional)'),
                                            React.createElement('textarea', {
                                                value: smartAlternativesNote,
                                                onChange: function(e) {
                                                    var val = e.target.value;
                                                    if (val.length <= 240) {
                                                        setSmartAlternativesNote(val);
                                                    }
                                                },
                                                placeholder: '[ Open to outdoor durability options ]',
                                                maxLength: 240,
                                        style: {
                                            width: '100%',
                                                    minHeight: '60px',
                                                    padding: '8px',
                                                    backgroundColor: darkBg,
                                                    border: '1px solid ' + darkBorder,
                                            borderRadius: '4px',
                                                    color: darkText,
                                                    fontSize: '12px',
                                                    fontFamily: 'monospace',
                                                    resize: 'vertical',
                                                }
                                            }),
                                            React.createElement('div', {
                                                style: { fontSize: '10px', color: '#666', marginTop: '4px' }
                                            }, '(' + smartAlternativesNote.length + ' chars • filtered)')
                                        ),
                                        // Inspiration / References / Sketch Drawings
                                        React.createElement('div', {
                                            style: { marginBottom: '12px' }
                                        },
                                            React.createElement('div', {
                                                style: { marginBottom: '4px', fontSize: '12px', fontWeight: '600' }
                                            }, 'Inspiration / References / Sketch Drawings'),
                                            React.createElement('div', {
                                                style: { marginBottom: '8px', fontSize: '11px', color: '#999' }
                                            }, 'Visible to suppliers while bidding.'),
                                            React.createElement('div', {
                                                style: {
                                            display: 'flex',
                                                    gap: '8px',
                                                    marginBottom: '8px',
                                            flexWrap: 'wrap',
                                        }
                                    },
                                        inspiration.map(function(insp, idx) {
                                                    return React.createElement('div', {
                                                        key: idx,
                                                        style: {
                                                            width: '80px',
                                                    height: '80px',
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                            backgroundColor: '#111111',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            cursor: 'pointer',
                                                    position: 'relative',
                                                        },
                                                        onClick: function() {
                                                            if (insp.url) {
                                                                // Commit 2.3.5.4: PDFs open in new tab, images use lightbox
                                                                if (insp.type === 'pdf' || (typeof insp.url === 'string' && insp.url.toLowerCase().endsWith('.pdf'))) {
                                                                    window.open(insp.url, '_blank');
                                                                } else {
                                                                    setLightboxImage(insp.url);
                                                                }
                                                            }
                                            }
                                            },
                                                insp.url ? (
                                                    (insp.type === 'pdf' || (typeof insp.url === 'string' && insp.url.toLowerCase().endsWith('.pdf'))) ? 
                                                    React.createElement('div', {
                                                        style: {
                                                            width: '100%',
                                                            height: '100%',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            backgroundColor: '#222',
                                                            borderRadius: '4px',
                                                            flexDirection: 'column',
                                                            gap: '4px',
                                                        }
                                                    }, 
                                                        React.createElement('div', { style: { fontSize: '24px' } }, '📄'),
                                                        React.createElement('div', { style: { fontSize: '8px', color: '#999' } }, 'PDF')
                                                    ) :
                                                    React.createElement('img', {
                                                        src: insp.url,
                                                        alt: insp.title || 'Reference',
                                                        style: {
                                                            width: '100%',
                                                            height: '100%',
                                                            objectFit: 'cover',
                                                            borderRadius: '4px',
                                                        }
                                                    })
                                                ) : React.createElement('div', {
                                                    style: { fontSize: '10px', color: '#666' }
                                                }, '[ img ]'),
                                                React.createElement('button', {
                                                            onClick: function(e) {
                                                                e.stopPropagation();
                                                                setInspiration(inspiration.filter(function(_, i) { return i !== idx; }));
                                                    },
                                                    style: {
                                                        position: 'absolute',
                                                                top: '4px',
                                                                right: '4px',
                                                                background: '#ff0000',
                                                        color: '#fff',
                                                        border: 'none',
                                                        borderRadius: '50%',
                                                                width: '20px',
                                                                height: '20px',
                                                        cursor: 'pointer',
                                                                fontSize: '12px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                                padding: 0,
                                                    }
                                                }, '×')
                                            );
                                                }),
                                                React.createElement('button', {
                                                    onClick: function() {
                                                        var input = document.getElementById('inspiration-file-input');
                                                        if (input) input.click();
                                                    },
                                                    disabled: isUploadingInspiration,
                                        style: {
                                                        width: '80px',
                                                        height: '80px',
                                                        border: '1px solid ' + darkBorder,
                                            borderRadius: '4px',
                                                        backgroundColor: '#111111',
                                                        color: darkText,
                                                        cursor: isUploadingInspiration ? 'not-allowed' : 'pointer',
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                                }
                                                }, isUploadingInspiration ? '...' : '[+ Add]')
                                    ),
                                    React.createElement('input', {
                                        type: 'file',
                                                id: 'inspiration-file-input',
                                        accept: 'image/*,.pdf,application/pdf,.heic,.heif',
                                        multiple: true,
                                        onChange: handleInspirationFileChange,
                                                style: { display: 'none' },
                                                disabled: isUploadingInspiration
                                            }),
                                            React.createElement('div', {
                                                style: { fontSize: '10px', color: '#666', marginTop: '4px' }
                                            }, '(visible to suppliers • no downloads)')
                                        ),
                                        // Invite Makers
                                        React.createElement('div', {
                                            style: { marginBottom: '12px' }
                                        },
                                            React.createElement('div', {
                                                style: { fontSize: '12px', fontWeight: '600', marginBottom: '8px' }
                                            }, 'Invite Makers'),
                                            React.createElement('div', {
                                                style: { fontSize: '11px', color: '#999', marginBottom: '8px' }
                                            }, 'Enter existing maker username(s) or email address(es). Press Enter or click Add. (1-5 invites)'),
                                            React.createElement('div', {
                                                style: { display: 'flex', gap: '8px', marginBottom: '8px' }
                                            },
                                                React.createElement('input', {
                                                    type: 'text',
                                                    value: inviteSupplierInput,
                                                    onChange: function(e) { setInviteSupplierInput(e.target.value); },
                                                    onKeyPress: function(e) {
                                                        if (e.key === 'Enter') {
                                                            e.preventDefault();
                                                            addInvitedSupplierChip();
                                                        }
                                                    },
                                                    placeholder: 'Username or email',
                                            style: {
                                                flex: 1,
                                                        padding: '8px',
                                                        backgroundColor: darkBg,
                                                        border: '1px solid ' + darkBorder,
                                                borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                            }
                                                }),
                                        React.createElement('button', {
                                            type: 'button',
                                                    onClick: addInvitedSupplierChip,
                                        style: {
                                            padding: '8px 16px',
                                                        backgroundColor: '#111111',
                                                        border: '1px solid ' + darkBorder,
                                            borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                                cursor: 'pointer',
                                                        whiteSpace: 'nowrap',
                                        }
                                                }, 'Add')
                                ),
                                            React.createElement('div', {
                                        style: {
                                                    display: 'flex',
                                                    flexWrap: 'wrap',
                                                    gap: '8px',
                                                    marginBottom: '8px',
                                                    minHeight: '32px',
                                        }
                                            },
                                                invitedSuppliers.map(function(supplier, idx) {
                                                    return React.createElement('div', {
                                                        key: idx,
                                                        style: {
                                                            display: 'inline-flex',
                                                            alignItems: 'center',
                                                            gap: '6px',
                                                            padding: '6px 12px',
                                                            backgroundColor: '#111111',
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '16px',
                                                            fontSize: '12px',
                                                            color: greenAccent,
                                                            fontFamily: 'monospace',
                                                        }
                                    },
                                                        React.createElement('span', null, supplier),
                                        React.createElement('button', {
                                            type: 'button',
                                                            onClick: function() { removeInvitedSupplierChip(supplier); },
                                                            style: {
                                                                background: 'none',
                                                                border: 'none',
                                                                color: darkText,
                                                                cursor: 'pointer',
                                                                fontSize: '16px',
                                                                lineHeight: 1,
                                                                padding: 0,
                                                                marginLeft: '4px',
                                                                fontWeight: 'bold',
                                            }
                                                        }, '×')
                                                    );
                                                })
                                            ),
                                            rfqError && invitedSuppliers.length === 0 ? React.createElement('div', {
                                                style: { fontSize: '11px', color: '#ff0000', marginTop: '4px' }
                                            }, rfqError) : null
                                        ),
                                        React.createElement('div', {
                                            style: { marginBottom: '12px' }
                                        },
                                                React.createElement('label', {
                                            style: {
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px',
                                                cursor: 'pointer',
                                            }
                                                },
                                                    React.createElement('input', {
                                                        type: 'checkbox',
                                                        checked: allowSystemInvites,
                                                        onChange: function(e) {
                                                            setAllowSystemInvites(e.target.checked);
                                                            // Update message immediately
                                                            setTimeout(function() {
                                                                if (e.target.checked) {
                                                                    if (invitedSuppliers.length > 0) {
                                                                        setSystemInvitesMessage('We\'ll invite 2 additional makers in 24 hours.');
                                                    } else {
                                                                        setSystemInvitesMessage('We will send your request on your behalf.');
                                                            }
                                                        } else {
                                                                    setSystemInvitesMessage('');
                                                                }
                                                            }, 0);
                                                        },
                                                        style: {
                                                            width: '18px',
                                                            height: '18px',
                                                            cursor: 'pointer',
                                                        }
                                                    }),
                                                    React.createElement('span', {
                                                        style: { fontSize: '12px', fontFamily: 'monospace' }
                                                    }, 'Let WireFrame (OS) source makers for this request')
                                                ),
                                    React.createElement('div', {
                                                    style: { marginTop: '8px', fontSize: '11px', color: '#999', paddingLeft: '26px' }
                                                }, 'If enabled, Wireframe (OS) will find qualified makers based on your item and keywords.'),
                                                systemInvitesMessage ? React.createElement('div', {
                                                    style: { marginTop: '8px', fontSize: '11px', color: '#999', paddingLeft: '26px' }
                                                }, systemInvitesMessage) : null
                                            ),
                                        rfqError ? React.createElement('div', {
                                        style: {
                                                marginBottom: '12px',
                                                padding: '8px',
                                                backgroundColor: '#330000',
                                                border: '1px solid #ff0000',
                                                borderRadius: '4px',
                                                fontSize: '11px',
                                                color: '#ff0000',
                                                    }
                                        }, rfqError) : null,
                                        React.createElement('button', {
                                            onClick: handleSubmitRfq,
                                            disabled: isSubmittingRfq,
                                            style: {
                                                width: '100%',
                                            padding: '12px',
                                                backgroundColor: greenAccent,
                                                border: 'none',
                                                borderRadius: '4px',
                                                color: darkBg,
                                                fontSize: '14px',
                                                fontFamily: 'monospace',
                                                cursor: isSubmittingRfq ? 'not-allowed' : 'pointer',
                                                fontWeight: '600',
                                                opacity: isSubmittingRfq ? 0.6 : 1,
                                            }
                                        }, isSubmittingRfq ? 'Submitting...' : 'Submit RFQ'),
                                        // Instructional microcopy
                                        React.createElement('div', {
                                            style: {
                                                marginTop: '12px',
                                                fontSize: '11px',
                                                color: '#999',
                                                textAlign: 'center',
                                                fontFamily: 'monospace',
                                            }
                                        }, 'Edit RFQ details and click Update.')
                                    )
                                ) : null,
                                // State B and C: Quantity, Dimensions, and Notes for suppliers - Inside Launch Brief tab
                                (currentState === 'B' || currentState === 'C') ? React.createElement(React.Fragment, null,
                                    // Commit 2.3.5.1: Warning Banner - Show if dims/qty changed after RFQ with bids
                                    (showWarningBanner && itemState.has_rfq && itemState.has_bids) ? React.createElement('div', {
                                        style: {
                                            marginTop: '24px',
                                            marginBottom: '16px',
                                            padding: '12px',
                                            backgroundColor: '#330000',
                                            border: '1px solid #ff0000',
                                            borderRadius: '4px',
                                            fontSize: '12px',
                                            color: '#ff0000',
                                        }
                                    }, '⚠️ Dims/Qty changed after RFQ. Existing bids may reflect previous values.') : null,
                                    // Redirected warning - Show if item is redirected and bids are available
                                    (currentState === 'C' && item.redirected && itemState.bids && itemState.bids.length > 0) ? React.createElement('div', {
                                        style: {
                                            marginTop: '24px',
                                            marginBottom: '16px',
                                            padding: '12px',
                                            backgroundColor: '#331100',
                                            border: '1px solid #ff8800',
                                            borderRadius: '4px',
                                            fontSize: '12px',
                                            color: '#ff8800',
                                        }
                                    }, '⚠️ This item has been redirected. Existing bids may reflect previous routing.') : null,
                                    // Quantity, Dimensions, and Notes for suppliers - Editable in State B/C
                                    React.createElement('div', {
                                        style: { marginTop: '24px', marginBottom: '24px' }
                                    },
                                        React.createElement('div', {
                                            style: {
                                                border: '1px solid ' + darkBorder,
                                                borderRadius: '4px',
                                                padding: '12px',
                                                backgroundColor: '#111111',
                                            }
                                        },
                                            // Quantity
                                            React.createElement('div', {
                                                style: { marginBottom: '12px' }
                                            },
                                                React.createElement('label', {
                                                    style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                                }, 'Quantity'),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    value: quantity,
                                                    onChange: function(e) { setQuantity(e.target.value); },
                                                    min: '1',
                                                    placeholder: '1',
                                                    disabled: isLockedAwaitingPayment,
                                                    style: {
                                                        width: '100%',
                                                        padding: '8px',
                                                        backgroundColor: darkBg,
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                                    }
                                                }),
                                                // Commit 2.3.5.3: CBM calculation removed from display (kept in background for later use)
                                                null
                                            ),
                                            // Dimensions
                                            React.createElement('div', {
                                                style: { marginBottom: '12px' }
                                            },
                                                React.createElement('label', {
                                                    style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                                }, 'Dimensions'),
                                                React.createElement('div', {
                                                    style: { display: 'grid', gridTemplateColumns: '80px 80px 80px auto', gap: '8px' }
                                                },
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: width,
                                                        onChange: function(e) { setWidth(e.target.value); },
                                                        placeholder: 'W',
                                                        step: '0.01',
                                                        disabled: isLockedAwaitingPayment,
                                                        style: {
                                                            padding: '8px',
                                                            backgroundColor: darkBg,
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                            color: darkText,
                                                            fontSize: '12px',
                                                            fontFamily: 'monospace',
                                                        }
                                                    }),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: depth,
                                                        onChange: function(e) { setDepth(e.target.value); },
                                                        placeholder: 'D',
                                                        step: '0.01',
                                                        disabled: isLockedAwaitingPayment,
                                                        style: {
                                                            padding: '8px',
                                                            backgroundColor: darkBg,
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                            color: darkText,
                                                            fontSize: '12px',
                                                            fontFamily: 'monospace',
                                                        }
                                                    }),
                                                    React.createElement('input', {
                                                        type: 'number',
                                                        value: height,
                                                        onChange: function(e) { setHeight(e.target.value); },
                                                        placeholder: 'H',
                                                        step: '0.01',
                                                        disabled: isLockedAwaitingPayment,
                                                        style: {
                                                            padding: '8px',
                                                            backgroundColor: darkBg,
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                            color: darkText,
                                                            fontSize: '12px',
                                                            fontFamily: 'monospace',
                                                        }
                                                    }),
                                                    React.createElement('select', {
                                                        value: unit,
                                                        onChange: function(e) { setUnit(e.target.value); },
                                                        disabled: isLockedAwaitingPayment,
                                                        style: {
                                                            padding: '8px',
                                                            backgroundColor: darkBg,
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                            color: darkText,
                                                            fontSize: '12px',
                                                            fontFamily: 'monospace',
                                                        }
                                                    },
                                                        React.createElement('option', { value: 'in' }, 'in'),
                                                        React.createElement('option', { value: 'cm' }, 'cm'),
                                                        React.createElement('option', { value: 'mm' }, 'mm'),
                                                        React.createElement('option', { value: 'm' }, 'm')
                                                    )
                                                ),
                                                // Commit 2.3.5.3: CBM calculation removed from display (kept in background for later use)
                                                null
                                            ),
                                            // Notes for suppliers
                                            React.createElement('div', {
                                                style: { marginBottom: '0' }
                                            },
                                                React.createElement('label', {
                                                    style: { display: 'block', fontSize: '12px', marginBottom: '4px' }
                                                }, 'Notes for suppliers (optional)'),
                                                React.createElement('textarea', {
                                                    value: smartAlternativesNote,
                                                    onChange: function(e) {
                                                        var val = e.target.value;
                                                        if (val.length <= 240) {
                                                            setSmartAlternativesNote(val);
                                                        }
                                                    },
                                                    placeholder: '[ Add notes for suppliers ]',
                                                    maxLength: 240,
                                                    disabled: isLockedAwaitingPayment,
                                                    style: {
                                                        width: '100%',
                                                        minHeight: '60px',
                                                        padding: '8px',
                                                        backgroundColor: darkBg,
                                                        border: '1px solid ' + darkBorder,
                                                        borderRadius: '4px',
                                                        color: darkText,
                                                        fontSize: '12px',
                                                        fontFamily: 'monospace',
                                                        resize: 'vertical',
                                                    }
                                                }),
                                                React.createElement('div', {
                                                    style: { fontSize: '10px', color: '#666', marginTop: '4px' }
                                                }, '(' + smartAlternativesNote.length + ' chars • filtered)')
                                            )
                                        ),
                                        // Instructional microcopy - Outside the box; hide when locked awaiting payment
                                        !isLockedAwaitingPayment ? React.createElement('div', {
                                            style: {
                                                marginTop: '12px',
                                                fontSize: '11px',
                                                color: '#999',
                                                textAlign: 'center',
                                                fontFamily: 'monospace',
                                            }
                                        }, 'Edit RFQ details and click Update.') : null
                                    )
                                ) : null
                            ) : null,
                                        // Tab 3: Proposals
                                        activeTab === 'bids' ? React.createElement('div', null,
                                            // Commit 2.3.9.1C: Payment Required Banner
                                            itemState.has_prototype_payment && itemState.prototype_payment_status === 'requested' ? React.createElement('div', {
                                                style: {
                                                    marginBottom: '24px',
                                                    padding: '20px',
                                                    backgroundColor: '#331100',
                                                    border: '2px solid #ff8800',
                                                    borderRadius: '4px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '16px',
                                                        fontWeight: '600',
                                                        color: '#ff8800',
                                                        marginBottom: '12px',
                                                    }
                                                }, 'Payment Required — Prototype & CAD Not Started'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '13px',
                                                        color: '#ffaa66',
                                                        marginBottom: '16px',
                                                        lineHeight: '1.5',
                                                    }
                                                }, 'Your prototype request has been submitted. CAD drafting and prototype work will begin only after payment is received.'),
                                                React.createElement('div', {
                                                    style: {
                                                        marginBottom: '12px',
                                                        padding: '12px',
                                                        backgroundColor: '#1a0a00',
                                                        borderRadius: '4px',
                                                        border: '1px solid #ff8800',
                                                    }
                                                },
                                                    React.createElement('div', {
                                                        style: {
                                                            fontSize: '14px',
                                                            fontWeight: '600',
                                                            color: '#fff',
                                                            marginBottom: '8px',
                                                        }
                                                    }, 'Amount Due: $' + (itemState.prototype_payment_total_due ? itemState.prototype_payment_total_due.toFixed(2) : '0.00')),
                                                    React.createElement('div', {
                                                        style: {
                                                            fontSize: '12px',
                                                            color: '#ffaa66',
                                                        }
                                                    }, 'Payment Methods: Wire / ACH / Zelle')
                                                ),
                                                React.createElement('button', {
                                                    onClick: function() { setShowPaymentInstructions(true); },
                                                    style: {
                                                        padding: '10px 20px',
                                                        backgroundColor: '#ff8800',
                                                        color: '#000',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        fontFamily: 'monospace',
                                                        fontSize: '12px',
                                                        fontWeight: '600',
                                                        cursor: 'pointer',
                                                    },
                                                    onMouseOver: function(e) { e.target.style.backgroundColor = '#ff9900'; },
                                                    onMouseOut: function(e) { e.target.style.backgroundColor = '#ff8800'; }
                                                }, '[ View Payment Instructions ]')
                                            ) : null,
                                            // Commit 2.3.9.2B-D: Prototype Section (Expandable)
                                            itemState.has_prototype_payment && itemState.prototype_payment_status === 'marked_received' ? React.createElement('div', {
                                                style: {
                                                    marginBottom: '24px',
                                                    border: '2px solid #00ff00',
                                                    borderRadius: '4px',
                                                    overflow: 'hidden',
                                                }
                                            },
                                                // Header - Always Visible
                                                React.createElement('div', {
                                                    onClick: function() { setPrototypeSectionExpanded(!prototypeSectionExpanded); },
                                                    style: {
                                                        padding: '20px',
                                                        backgroundColor: '#003300',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                    }
                                                },
                                                    React.createElement('div', null,
                                                        React.createElement('div', {
                                                            style: {
                                                                fontSize: '16px',
                                                                fontWeight: '600',
                                                                color: '#00ff00',
                                                                marginBottom: '4px',
                                                            }
                                                        }, (itemState.prototype_submission && itemState.prototype_submission.links && itemState.prototype_submission.links.length > 0) ? 'View Prototype Videos' : 'Payment Confirmed'),
                                                        React.createElement('div', {
                                                            style: {
                                                                fontSize: '13px',
                                                                color: '#00cc00',
                                                                lineHeight: '1.5',
                                                            }
                                                        }, (itemState.prototype_submission && itemState.prototype_submission.links && itemState.prototype_submission.links.length > 0) ? 'Supplier has submitted prototype video(s).' : 'CAD drafting has begun.')
                                                    ),
                                                    React.createElement('div', {
                                                        style: {
                                                            fontSize: '20px',
                                                            color: '#00ff00',
                                                            fontWeight: 'bold',
                                                        }
                                                    }, prototypeSectionExpanded ? '−' : '+')
                                                ),
                                                // Expandable Content - Prototype Review
                                                prototypeSectionExpanded ? React.createElement('div', {
                                                    style: {
                                                        padding: '20px',
                                                        backgroundColor: '#001100',
                                                        borderTop: '1px solid #00ff00',
                                                    }
                                                },
                                                    // Prototype Video Header
                                                    React.createElement('div', {
                                                        style: {
                                                            fontSize: '18px',
                                                            fontWeight: '600',
                                                            color: '#00ff00',
                                                            marginBottom: '16px',
                                                        }
                                                    }, 'Prototype Video'),
                                                    // Status Badge
                                                    itemState.prototype_status ? React.createElement('div', {
                                                        style: {
                                                            display: 'inline-block',
                                                            padding: '6px 12px',
                                                            backgroundColor: itemState.prototype_status === 'approved' ? '#003300' : 
                                                                           itemState.prototype_status === 'changes_requested' ? '#331100' : '#001133',
                                                            border: '1px solid ' + (itemState.prototype_status === 'approved' ? '#00ff00' : 
                                                                                   itemState.prototype_status === 'changes_requested' ? '#ff8800' : '#66aaff'),
                                                            borderRadius: '4px',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            color: itemState.prototype_status === 'approved' ? '#00ff00' : 
                                                                   itemState.prototype_status === 'changes_requested' ? '#ff8800' : '#66aaff',
                                                            marginBottom: '16px',
                                                        }
                                                    }, itemState.prototype_status === 'approved' ? 'Approved' : 
                                                       itemState.prototype_status === 'changes_requested' ? 'Changes Requested' : 
                                                       itemState.prototype_status === 'submitted' ? ('Submitted (v' + (itemState.prototype_current_version || 0) + ')') : 
                                                       'Not Submitted') : null,
                                                    // Video Links
                                                    itemState.prototype_submission && itemState.prototype_submission.links && itemState.prototype_submission.links.length > 0 ? React.createElement('div', {
                                                        style: {
                                                            marginBottom: '16px',
                                                        }
                                                    },
                                                        React.createElement('div', {
                                                            style: {
                                                                fontSize: '13px',
                                                                fontWeight: '600',
                                                                color: '#ccc',
                                                                marginBottom: '8px',
                                                            }
                                                        }, 'Video Links (v' + itemState.prototype_submission.version + '):'),
                                                        itemState.prototype_submission.links.map(function(link, idx) {
                                                            return React.createElement('div', {
                                                                key: idx,
                                                                style: {
                                                                    marginBottom: '8px',
                                                                    padding: '10px',
                                                                    backgroundColor: '#000',
                                                                    border: '1px solid #333',
                                                                    borderRadius: '4px',
                                                                }
                                                            },
                                                                React.createElement('a', {
                                                                    href: link.url,
                                                                    target: '_blank',
                                                                    rel: 'noopener noreferrer',
                                                                    style: {
                                                                        color: '#66aaff',
                                                                        textDecoration: 'none',
                                                                        fontSize: '12px',
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        gap: '8px',
                                                                    }
                                                                },
                                                                    React.createElement('span', {
                                                                        style: { fontWeight: '600', textTransform: 'capitalize' }
                                                                    }, link.provider + ':'),
                                                                    React.createElement('span', {
                                                                        style: { flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }
                                                                    }, link.url),
                                                                    React.createElement('span', {
                                                                        style: { fontSize: '10px', color: '#888' }
                                                                    }, 'Open →')
                                                                )
                                                            );
                                                        }),
                                                        itemState.prototype_submission.created_at ? React.createElement('div', {
                                                            style: {
                                                                fontSize: '11px',
                                                                color: '#888',
                                                                marginTop: '8px',
                                                            }
                                                        }, 'Submitted: ' + new Date(itemState.prototype_submission.created_at).toLocaleString()) : null
                                                    ) : null,
                                                    // Action Buttons
                                                    itemState.prototype_status === 'submitted' ? React.createElement('div', {
                                                        style: {
                                                            display: 'flex',
                                                            gap: '12px',
                                                            marginTop: '16px',
                                                        }
                                                    },
                                                        React.createElement('button', {
                                                            onClick: function() {
                                                                // Fetch keyword names and phrases before opening modal
                                                                if (itemState.direction_keyword_ids && itemState.direction_keyword_ids.length > 0) {
                                                                    var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                                                                    var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_get_keyword_phrases) || (window.n88BoardNonce && window.n88BoardNonce.nonce) || '';
                                                                    if (!nonce) {
                                                                        alert('Nonce missing for keyword phrases.');
                                                                        return;
                                                                    }
                                                                    var formData = new FormData();
                                                                    formData.append('action', 'n88_get_keyword_phrases');
                                                                    formData.append('keyword_ids', JSON.stringify(itemState.direction_keyword_ids));
                                                                    formData.append('_ajax_nonce', nonce);
                                                                    fetch(ajaxUrl, { method: 'POST', body: formData })
                                                                    .then(function(res) { return res.json(); })
                                                                    .then(function(data) {
                                                                            if (data.success && data.data) {
                                                                                // Ensure keyword_ids are numbers for consistent access
                                                                                var phrasesByKeyword = {};
                                                                                if (data.data.phrases_by_keyword) {
                                                                                    Object.keys(data.data.phrases_by_keyword).forEach(function(kid) {
                                                                                        phrasesByKeyword[parseInt(kid)] = data.data.phrases_by_keyword[kid];
                                                                                    });
                                                                                }
                                                                                setAvailablePhrases(phrasesByKeyword);
                                                                                
                                                                                var keywordNamesObj = {};
                                                                                if (data.data.keyword_names) {
                                                                                    Object.keys(data.data.keyword_names).forEach(function(kid) {
                                                                                        keywordNamesObj[parseInt(kid)] = data.data.keyword_names[kid];
                                                                                    });
                                                                                }
                                                                                setKeywordNames(keywordNamesObj);
                                                                                // Initialize feedback packet with all keywords set to 'satisfied'
                                                                                var initialPacket = {};
                                                                                itemState.direction_keyword_ids.forEach(function(kid) {
                                                                                    initialPacket[parseInt(kid)] = { status: 'satisfied', severity: null, phrase_ids: [] };
                                                                                });
                                                                                setFeedbackPacket(initialPacket);
                                                                            setTotalPhrasesSelected(0);
                                                                            setShowRequestChangesModal(true);
                                                                        } else {
                                                                            alert('Failed to load keyword data');
                                                                        }
                                                                    })
                                                                    .catch(function(error) {
                                                                        console.error('Error fetching keyword data:', error);
                                                                        alert('Error loading keyword data');
                                                                    });
                                                                } else {
                                                                    setShowRequestChangesModal(true);
                                                                }
                                                            },
                                                            style: {
                                                                padding: '10px 20px',
                                                                backgroundColor: '#331100',
                                                                border: '1px solid #ff8800',
                                                                borderRadius: '4px',
                                                                color: '#ff8800',
                                                                fontSize: '13px',
                                                                fontWeight: '600',
                                                                cursor: 'pointer',
                                                                fontFamily: 'monospace',
                                                            }
                                                        }, 'Request Changes'),
                                                        React.createElement('button', {
                                                            onClick: function() {
                                                                if (!window.confirm('Approve prototype version ' + itemState.prototype_current_version + '?')) return;
                                                                var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                                                                var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_approve_prototype) || (window.n88BoardNonce && window.n88BoardNonce.nonce) || '';
                                                                if (!nonce) {
                                                                    alert('Nonce missing for prototype approval.');
                                                                    return;
                                                                }
                                                                var formData = new FormData();
                                                                formData.append('action', 'n88_approve_prototype');
                                                                formData.append('payment_id', String(itemState.prototype_payment_id));
                                                                formData.append('item_id', String(itemId));
                                                                formData.append('bid_id', String(itemState.prototype_payment_bid_id));
                                                                formData.append('version', String(itemState.prototype_current_version));
                                                                formData.append('_ajax_nonce', nonce);
                                                                fetch(ajaxUrl, { method: 'POST', body: formData })
                                                                .then(function(res) { return res.json(); })
                                                                .then(function(data) {
                                                                    if (data.success) {
                                                                        fetchItemState();
                                                                        setPrototypeSectionExpanded(true);
                                                                    } else {
                                                                        alert(data.data && data.data.message ? data.data.message : 'Failed to approve prototype');
                                                                    }
                                                                })
                                                                .catch(function(error) {
                                                                    console.error('Error approving prototype:', error);
                                                                    alert('Error approving prototype');
                                                                });
                                                            },
                                                            style: {
                                                                padding: '10px 20px',
                                                                backgroundColor: '#003300',
                                                                border: '1px solid #00ff00',
                                                                borderRadius: '4px',
                                                                color: '#00ff00',
                                                                fontSize: '13px',
                                                                fontWeight: '600',
                                                                cursor: 'pointer',
                                                                fontFamily: 'monospace',
                                                            }
                                                        }, 'Approve Prototype')
                                                    ) : null,
                                                    itemState.prototype_status === 'changes_requested' ? React.createElement('div', {
                                                        style: {
                                                            fontSize: '12px',
                                                            color: '#ff8800',
                                                            marginTop: '12px',
                                                        }
                                                    }, 'Changes have been requested. Waiting for supplier to submit updated version.') : null,
                                                    itemState.prototype_status === 'approved' ? React.createElement('div', {
                                                        style: {
                                                            fontSize: '12px',
                                                            color: '#00ff00',
                                                            marginTop: '12px',
                                                        }
                                                    }, '✓ Prototype approved (v' + (itemState.prototype_approved_version || itemState.prototype_current_version) + ')') : null
                                                ) : null
                                            ) : null,
                                            // Commit 2.3.9.2B-D: Request Changes Modal
                                            showRequestChangesModal && itemState.direction_keyword_ids && itemState.direction_keyword_ids.length > 0 ? React.createElement('div', {
                                                style: {
                                                    position: 'fixed',
                                                    top: 0,
                                                    left: 0,
                                                    right: 0,
                                                    bottom: 0,
                                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                                    zIndex: 10000,
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    padding: '20px',
                                                },
                                                onClick: function() { setShowRequestChangesModal(false); }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        backgroundColor: '#000',
                                                        border: '2px solid #ff8800',
                                                        borderRadius: '8px',
                                                        padding: '24px',
                                                        maxWidth: '800px',
                                                        maxHeight: '90vh',
                                                        overflowY: 'auto',
                                                        width: '100%',
                                                    },
                                                    onClick: function(e) { e.stopPropagation(); }
                                                },
                                                    React.createElement('div', {
                                                        style: {
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            marginBottom: '20px',
                                                        }
                                                    },
                                                        React.createElement('h2', {
                                                            style: {
                                                                fontSize: '18px',
                                                                fontWeight: '600',
                                                                color: '#ff8800',
                                                                margin: 0,
                                                            }
                                                        }, 'Request Changes - Feedback Packet'),
                                                        React.createElement('button', {
                                                            onClick: function() { setShowRequestChangesModal(false); },
                                                            style: {
                                                                background: 'none',
                                                                border: 'none',
                                                                color: '#fff',
                                                                fontSize: '24px',
                                                                cursor: 'pointer',
                                                                padding: '0',
                                                                width: '30px',
                                                                height: '30px',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center',
                                                            }
                                                        }, '×')
                                                    ),
                                                    React.createElement('div', {
                                                        style: {
                                                            fontSize: '12px',
                                                            color: '#aaa',
                                                            marginBottom: '20px',
                                                        }
                                                    }, 'Review each keyword and select status. For keywords needing adjustment, select up to 3 phrases. Maximum 18 phrases total.'),
                                                    // Keyword Checklist
                                                    React.createElement('div', {
                                                        style: {
                                                            marginBottom: '20px',
                                                        }
                                                    },
                                                        itemState.direction_keyword_ids.map(function(keywordId) {
                                                            var keywordIdNum = parseInt(keywordId);
                                                            var keywordData = feedbackPacket[keywordIdNum] || { status: 'satisfied', severity: null, phrase_ids: [] };
                                                            var phrases = availablePhrases[keywordIdNum] || [];
                                                            return React.createElement('div', {
                                                                key: keywordIdNum,
                                                                style: {
                                                                    marginBottom: '16px',
                                                                    padding: '16px',
                                                                    backgroundColor: '#111',
                                                                    border: '1px solid #333',
                                                                    borderRadius: '4px',
                                                                }
                                                            },
                                                                React.createElement('div', {
                                                                    style: {
                                                                        fontSize: '14px',
                                                                        fontWeight: '600',
                                                                        color: '#fff',
                                                                        marginBottom: '12px',
                                                                    }
                                                                    }, keywordNames[keywordIdNum] || ('Keyword ID: ' + keywordIdNum)),
                                                                // Status Selection
                                                                React.createElement('div', {
                                                                    style: {
                                                                        display: 'flex',
                                                                        gap: '12px',
                                                                        marginBottom: '12px',
                                                                    }
                                                                },
                                                                    ['satisfied', 'needs_adjustment', 'not_addressed'].map(function(status) {
                                                                        return React.createElement('label', {
                                                                            key: status,
                                                                            style: {
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                gap: '6px',
                                                                                cursor: 'pointer',
                                                                                fontSize: '12px',
                                                                                color: '#ccc',
                                                                            }
                                                                        },
                                                                            React.createElement('input', {
                                                                                type: 'radio',
                                                                                name: 'keyword_' + keywordIdNum + '_status',
                                                                                value: status,
                                                                                checked: keywordData.status === status,
                                                                                onChange: function() {
                                                                                    var newPacket = Object.assign({}, feedbackPacket);
                                                                                    newPacket[keywordIdNum] = {
                                                                                        status: status,
                                                                                        severity: status === 'not_addressed' ? 'must_fix' : status === 'needs_adjustment' ? 'should_fix' : null,
                                                                                        phrase_ids: status === 'satisfied' ? [] : keywordData.phrase_ids,
                                                                                    };
                                                                                    setFeedbackPacket(newPacket);
                                                                                    // Always fetch phrases if not already loaded when status changes to needs_adjustment or not_addressed
                                                                                    if (status !== 'satisfied' && (!availablePhrases[keywordIdNum] || availablePhrases[keywordIdNum].length === 0)) {
                                                                                        var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                                                                                        var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_get_keyword_phrases) || (window.n88BoardNonce && window.n88BoardNonce.nonce) || (window.n88BoardData && window.n88BoardData.nonce) || (window.n88 && window.n88.nonce) || '';
                                                                                        var formData = new FormData();
                                                                                        formData.append('action', 'n88_get_keyword_phrases');
                                                                                        formData.append('keyword_ids', JSON.stringify([keywordIdNum]));
                                                                                        formData.append('_ajax_nonce', nonce);
                                                                                        fetch(ajaxUrl, { method: 'POST', body: formData })
                                                                                        .then(function(res) { return res.json(); })
                                                                                        .then(function(data) {
                                                                                            if (data.success && data.data && data.data.phrases_by_keyword) {
                                                                                                // Ensure keyword_id is a number for consistent access
                                                                                                var phrasesByKeyword = {};
                                                                                                Object.keys(data.data.phrases_by_keyword).forEach(function(kid) {
                                                                                                    phrasesByKeyword[parseInt(kid)] = data.data.phrases_by_keyword[kid];
                                                                                                });
                                                                                                setAvailablePhrases(Object.assign({}, availablePhrases, phrasesByKeyword));
                                                                                                if (data.data.keyword_names) {
                                                                                                    var keywordNamesObj = {};
                                                                                                    Object.keys(data.data.keyword_names).forEach(function(kid) {
                                                                                                        keywordNamesObj[parseInt(kid)] = data.data.keyword_names[kid];
                                                                                                    });
                                                                                                    setKeywordNames(Object.assign({}, keywordNames, keywordNamesObj));
                                                                                                }
                                                                                            } else {
                                                                                                console.error('Failed to load phrases:', data.data ? data.data.message : 'Unknown error', data);
                                                                                            }
                                                                                        })
                                                                                        .catch(function(error) {
                                                                                            console.error('Error fetching phrases:', error);
                                                                                        });
                                                                                    }
                                                                                },
                                                                                style: { cursor: 'pointer' }
                                                                            }),
                                                                            React.createElement('span', null,
                                                                                status === 'satisfied' ? '✅ Satisfied' : 
                                                                                status === 'needs_adjustment' ? '⚠️ Needs Adjustment' : 
                                                                                '❌ Not Addressed'
                                                                            )
                                                                        );
                                                                    })
                                                                ),
                                                                // Phrase Selection (only if not satisfied)
                                                                keywordData.status !== 'satisfied' ? (
                                                                    phrases && phrases.length > 0 ? React.createElement(React.Fragment, null,
                                                                    React.createElement('div', {
                                                                        style: {
                                                                            fontSize: '12px',
                                                                            color: '#aaa',
                                                                            marginBottom: '8px',
                                                                        }
                                                                    }, 'Select up to 3 phrases:'),
                                                                    React.createElement('div', {
                                                                        style: {
                                                                            display: 'flex',
                                                                            flexDirection: 'column',
                                                                            gap: '6px',
                                                                        }
                                                                    },
                                                                        phrases.map(function(phrase) {
                                                                            return React.createElement('label', {
                                                                                key: phrase.phrase_id,
                                                                                style: {
                                                                                    display: 'flex',
                                                                                    alignItems: 'center',
                                                                                    gap: '8px',
                                                                                    cursor: keywordData.phrase_ids.length < 3 || keywordData.phrase_ids.indexOf(phrase.phrase_id) !== -1 ? 'pointer' : 'not-allowed',
                                                                                    fontSize: '11px',
                                                                                    color: '#ccc',
                                                                                    padding: '6px',
                                                                                    backgroundColor: keywordData.phrase_ids.indexOf(phrase.phrase_id) !== -1 ? '#331100' : 'transparent',
                                                                                    border: '1px solid ' + (keywordData.phrase_ids.indexOf(phrase.phrase_id) !== -1 ? '#ff8800' : '#333'),
                                                                                    borderRadius: '4px',
                                                                                }
                                                                            },
                                                                                React.createElement('input', {
                                                                                    type: 'checkbox',
                                                                                    checked: keywordData.phrase_ids.indexOf(phrase.phrase_id) !== -1,
                                                                                    onChange: function(e) {
                                                                                        var newPacket = Object.assign({}, feedbackPacket);
                                                                                        var currentPhraseIds = keywordData.phrase_ids || [];
                                                                                        if (e.target.checked) {
                                                                                            if (currentPhraseIds.length < 3) {
                                                                                                newPacket[keywordIdNum] = {
                                                                                                    status: keywordData.status,
                                                                                                    severity: keywordData.severity,
                                                                                                    phrase_ids: currentPhraseIds.concat([phrase.phrase_id]),
                                                                                                };
                                                                                                setTotalPhrasesSelected(totalPhrasesSelected + 1);
                                                                                            }
                                                                                        } else {
                                                                                            newPacket[keywordIdNum] = {
                                                                                                status: keywordData.status,
                                                                                                severity: keywordData.severity,
                                                                                                phrase_ids: currentPhraseIds.filter(function(id) { return id !== phrase.phrase_id; }),
                                                                                            };
                                                                                            setTotalPhrasesSelected(Math.max(0, totalPhrasesSelected - 1));
                                                                                        }
                                                                                        setFeedbackPacket(newPacket);
                                                                                    },
                                                                                    disabled: keywordData.phrase_ids.indexOf(phrase.phrase_id) === -1 && keywordData.phrase_ids.length >= 3,
                                                                                }),
                                                                                React.createElement('span', null, phrase.phrase_text)
                                                                            );
                                                                        })
                                                                    ),
                                                                    // Severity Selection
                                                                    React.createElement('div', {
                                                                        style: {
                                                                            marginTop: '12px',
                                                                        }
                                                                    },
                                                                        React.createElement('div', {
                                                                            style: {
                                                                                fontSize: '12px',
                                                                                color: '#aaa',
                                                                                marginBottom: '6px',
                                                                            }
                                                                        }, 'Severity:'),
                                                                        React.createElement('select', {
                                                                            value: keywordData.severity || (keywordData.status === 'not_addressed' ? 'must_fix' : 'should_fix'),
                                                                            onChange: function(e) {
                                                                                var newPacket = Object.assign({}, feedbackPacket);
                                                                                newPacket[keywordIdNum] = {
                                                                                    status: keywordData.status,
                                                                                    severity: e.target.value,
                                                                                    phrase_ids: keywordData.phrase_ids,
                                                                                };
                                                                                setFeedbackPacket(newPacket);
                                                                            },
                                                                            style: {
                                                                                padding: '6px 12px',
                                                                                backgroundColor: '#000',
                                                                                color: '#fff',
                                                                                border: '1px solid #333',
                                                                                borderRadius: '4px',
                                                                                fontSize: '12px',
                                                                                fontFamily: 'monospace',
                                                                            }
                                                                        },
                                                                            React.createElement('option', { value: 'must_fix' }, 'Must Fix'),
                                                                            React.createElement('option', { value: 'should_fix' }, 'Should Fix'),
                                                                            React.createElement('option', { value: 'optional' }, 'Optional')
                                                                        )
                                                                    )
                                                                    ) : React.createElement('div', {
                                                                        style: {
                                                                            fontSize: '11px',
                                                                            color: '#888',
                                                                            fontStyle: 'italic',
                                                                            padding: '8px',
                                                                            backgroundColor: '#0a0a0a',
                                                                            border: '1px solid #333',
                                                                            borderRadius: '4px',
                                                                        }
                                                                    }, 'Loading phrases...')
                                                                ) : null
                                                            );
                                                        })
                                                    ),
                                                    // Total Phrases Counter
                                                    React.createElement('div', {
                                                        style: {
                                                            fontSize: '12px',
                                                            color: totalPhrasesSelected > 18 ? '#ff6666' : '#aaa',
                                                            marginBottom: '20px',
                                                            textAlign: 'right',
                                                        }
                                                    }, 'Total Phrases Selected: ' + totalPhrasesSelected + ' / 18'),
                                                    // Submit Button
                                                    React.createElement('div', {
                                                        style: {
                                                            display: 'flex',
                                                            gap: '12px',
                                                            justifyContent: 'flex-end',
                                                        }
                                                    },
                                                        React.createElement('button', {
                                                            onClick: function() {
                                                                setShowRequestChangesModal(false);
                                                                setFeedbackPacket({});
                                                                setTotalPhrasesSelected(0);
                                                            },
                                                            style: {
                                                                padding: '10px 20px',
                                                                backgroundColor: '#333',
                                                                border: '1px solid #666',
                                                                borderRadius: '4px',
                                                                color: '#ccc',
                                                                fontSize: '13px',
                                                                fontWeight: '600',
                                                                cursor: 'pointer',
                                                                fontFamily: 'monospace',
                                                            }
                                                        }, 'Cancel'),
                                                        React.createElement('button', {
                                                            onClick: function() {
                                                                if (totalPhrasesSelected > 18) {
                                                                    alert('Maximum 18 phrases allowed.');
                                                                    return;
                                                                }
                                                                var ajaxUrl = (window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php';
                                                                var nonce = (window.n88BoardNonce && window.n88BoardNonce.nonce_request_prototype_changes) || (window.n88BoardNonce && window.n88BoardNonce.nonce) || '';
                                                                if (!nonce) {
                                                                    alert('Nonce missing for request changes.');
                                                                    return;
                                                                }
                                                                var formData = new FormData();
                                                                formData.append('action', 'n88_request_prototype_changes');
                                                                formData.append('payment_id', String(itemState.prototype_payment_id));
                                                                formData.append('item_id', String(itemId));
                                                                formData.append('bid_id', String(itemState.prototype_payment_bid_id));
                                                                formData.append('submission_version', String(itemState.prototype_current_version));
                                                                formData.append('feedback_packet', JSON.stringify(feedbackPacket));
                                                                formData.append('_ajax_nonce', nonce);
                                                                fetch(ajaxUrl, { method: 'POST', body: formData })
                                                                .then(function(res) { return res.json(); })
                                                                .then(function(data) {
                                                                    if (data.success) {
                                                                        setShowRequestChangesModal(false);
                                                                        setFeedbackPacket({});
                                                                        setTotalPhrasesSelected(0);
                                                                        fetchItemState();
                                                                        setPrototypeSectionExpanded(true);
                                                                    } else {
                                                                        alert(data.data && data.data.message ? data.data.message : 'Failed to request changes');
                                                                    }
                                                                })
                                                                .catch(function(error) {
                                                                    console.error('Error requesting changes:', error);
                                                                    alert('Error requesting changes');
                                                                });
                                                            },
                                                            disabled: totalPhrasesSelected > 18,
                                                            style: {
                                                                padding: '10px 20px',
                                                                backgroundColor: totalPhrasesSelected > 18 ? '#333' : '#331100',
                                                                border: '1px solid ' + (totalPhrasesSelected > 18 ? '#666' : '#ff8800'),
                                                                borderRadius: '4px',
                                                                color: totalPhrasesSelected > 18 ? '#666' : '#ff8800',
                                                                fontSize: '13px',
                                                                fontWeight: '600',
                                                                cursor: totalPhrasesSelected > 18 ? 'not-allowed' : 'pointer',
                                                                fontFamily: 'monospace',
                                                            }
                                                        }, 'Submit Feedback Packet')
                                                    )
                                                )
                                            ) : null,
                                            // Bids Content - Only show if bids exist
                                            itemState.has_bids && itemState.bids && itemState.bids.length > 0 ? React.createElement('div', {
                                                style: { marginBottom: '24px' },
                                                onClick: function(e) { e.stopPropagation(); }
                                            },
                                                React.createElement('div', {
                                                    onClick: function(e) {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        setBidsExpanded(!bidsExpanded);
                                                    },
                                                    style: {
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        cursor: 'pointer',
                                                        marginBottom: bidsExpanded ? '12px' : '0',
                                                    }
                                                },
                                                    React.createElement('div', {
                                                        style: { fontSize: '14px', fontWeight: '600' }
                                                    }, 'Proposals'),
                                                    React.createElement('span', {
                                                        style: { fontSize: '12px', color: darkText, cursor: 'pointer' },
                                                        onClick: function(e) {
                                                            e.preventDefault();
                                                            e.stopPropagation();
                                                            setBidsExpanded(!bidsExpanded);
                                                        }
                                                    }, bidsExpanded ? '▼' : '▶')
                                                ),
                                                !bidsExpanded ? React.createElement('div', {
                                                    style: { fontSize: '12px', color: darkText, marginTop: '8px' }
                                                }, itemState.bids.length + ' Proposal' + (itemState.bids.length !== 1 ? 's' : '') + ' received') : null,
                                                // Commit 2.3.6: Expanded BIDS Matrix View
                                                bidsExpanded ? React.createElement(React.Fragment, null,
                                                    React.createElement(BidComparisonMatrixInline, {
                                                        bids: itemState.bids,
                                                        darkBorder: darkBorder,
                                                        greenAccent: greenAccent,
                                                        darkText: darkText,
                                                        darkBg: darkBg,
                                                        onImageClick: setLightboxImage,
                                                        smartAlternativesEnabled: smartAlternativesEnabled,
                                                        itemId: itemId // Commit 2.4.1: Pass itemId for award bid action
                                                    }),
                                                    // Commit 2.3.9.1B: Request CAD + Prototype Video Button/Form
                                                    !showCadPrototypeForm ? React.createElement('div', {
                                                        style: { marginTop: '20px', textAlign: 'center' }
                                                    },
                                                        React.createElement('button', {
                                                            onClick: function() {
                                                                // Auto-select first bid if only one bid exists
                                                                if (itemState.bids && itemState.bids.length === 1) {
                                                                    setSelectedBidId(itemState.bids[0].bid_id);
                                                                }
                                                                setShowCadPrototypeForm(true);
                                                                setCadPrototypeError('');
                                                                setCadPrototypeSuccess(false);
                                                            },
                                                            style: {
                                                                padding: '12px 24px',
                                                                backgroundColor: '#111111',
                                                                border: '1px solid ' + darkBorder,
                                                                borderRadius: '4px',
                                                                color: darkText,
                                                                fontSize: '14px',
                                                                fontFamily: 'monospace',
                                                                cursor: 'pointer',
                                                                fontWeight: '600',
                                                            }
                                                        }, 'Request CAD + Prototype Video')
                                                    ) : React.createElement('div', {
                                                        id: 'cad-prototype-form-container',
                                                        style: {
                                                            marginTop: '20px',
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                            padding: '16px',
                                                            backgroundColor: '#111111',
                                                        }
                                                    },
                                                        // Header with Close Button
                                                        React.createElement('div', {
                                                            style: {
                                                                display: 'flex',
                                                                justifyContent: 'space-between',
                                                                alignItems: 'center',
                                                                marginBottom: '16px',
                                                            }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '14px', fontWeight: '600', color: darkText }
                                                            }, 'Request CAD + Prototype Video'),
                                                            React.createElement('button', {
                                                                onClick: function() {
                                                                    setShowCadPrototypeForm(false);
                                                                    setSelectedBidId(null);
                                                                    setSelectedKeywords([]);
                                                                    setPrototypeNote('');
                                                                    setCadPrototypeError('');
                                                                    setCadPrototypeSuccess(false);
                                                                },
                                                                style: {
                                                                    background: 'none',
                                                                    border: 'none',
                                                                    color: darkText,
                                                                    fontSize: '20px',
                                                                    cursor: 'pointer',
                                                                    padding: '0',
                                                                    width: '24px',
                                                                    height: '24px',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    justifyContent: 'center',
                                                                }
                                                            }, '×')
                                                        ),
                                                        // Success Message
                                                        cadPrototypeSuccess ? React.createElement('div', {
                                                            style: {
                                                                marginBottom: '16px',
                                                                padding: '12px',
                                                                backgroundColor: '#1a3a1a',
                                                                border: '1px solid ' + greenAccent,
                                                                borderRadius: '4px',
                                                                fontSize: '12px',
                                                                color: greenAccent,
                                                                lineHeight: '1.5',
                                                            }
                                                        }, 'Request submitted. Please send payment using the instructions above. We\'ll begin CAD drafting once payment is confirmed.') : null,
                                                        // Error Message
                                                        cadPrototypeError ? React.createElement('div', {
                                                            style: {
                                                                marginBottom: '16px',
                                                                padding: '12px',
                                                                backgroundColor: '#3a1a1a',
                                                                border: '1px solid #ff4444',
                                                                borderRadius: '4px',
                                                                fontSize: '12px',
                                                                color: '#ff4444',
                                                            }
                                                        }, cadPrototypeError) : null,
                                                        // Section A: Video Direction
                                                        React.createElement('div', {
                                                            style: { marginBottom: '24px' }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '13px', fontWeight: '600', marginBottom: '12px', color: darkText }
                                                            }, 'Video Direction'),
                                                            // Bid Selection (if multiple bids)
                                                            itemState.bids && itemState.bids.length > 1 ? React.createElement('div', {
                                                                style: { marginBottom: '16px' }
                                                            },
                                                                React.createElement('label', {
                                                                    style: { display: 'block', fontSize: '12px', marginBottom: '8px', color: darkText }
                                                                }, 'Select Bid ', React.createElement('span', { style: { color: '#ff4444' } }, '*')),
                                                                React.createElement('select', {
                                                                    value: selectedBidId || '',
                                                                    onChange: function(e) {
                                                                        setSelectedBidId(parseInt(e.target.value));
                                                                        setSelectedKeywords([]);
                                                                        setAvailableKeywords([]);
                                                                    },
                                                                    style: {
                                                                        width: '100%',
                                                                        padding: '8px',
                                                                        backgroundColor: darkBg,
                                                                        border: '1px solid ' + darkBorder,
                                                                        borderRadius: '4px',
                                                                        color: darkText,
                                                                        fontSize: '12px',
                                                                        fontFamily: 'monospace',
                                                                    }
                                                                },
                                                                    React.createElement('option', { value: '' }, '-- Select a bid --'),
                                                                    itemState.bids.map(function(bid) {
                                                                        return React.createElement('option', {
                                                                            key: bid.bid_id,
                                                                            value: bid.bid_id
                                                                        }, 'Bid #' + bid.bid_id + ' - ' + (bid.supplier_name || 'Supplier ' + bid.supplier_id));
                                                                    })
                                                                )
                                                            ) : null,
                                                            // Keyword Selection
                                                            React.createElement('div', {
                                                                style: { marginBottom: '16px' }
                                                            },
                                                                React.createElement('label', {
                                                                    style: { display: 'block', fontSize: '12px', marginBottom: '8px', color: darkText }
                                                                }, 'Select Keywords (3-7 required) ', React.createElement('span', { style: { color: '#ff4444' } }, '*')),
                                                                React.createElement('div', {
                                                                    style: { fontSize: '11px', color: '#999', marginBottom: '8px' }
                                                                }, 'Select between 3 and 7 keywords that describe what should be shown in the prototype video.'),
                                                                // Keyword Chips
                                                                React.createElement('div', {
                                                                    style: {
                                                                        display: 'flex',
                                                                        flexWrap: 'wrap',
                                                                        gap: '8px',
                                                                        minHeight: '60px',
                                                                        padding: '12px',
                                                                        border: '1px solid ' + darkBorder,
                                                                        borderRadius: '4px',
                                                                        backgroundColor: darkBg,
                                                                    }
                                                                },
                                                                    availableKeywords.length === 0 ? React.createElement('div', {
                                                                        style: { fontSize: '11px', color: '#999', fontStyle: 'italic' }
                                                                    }, selectedBidId ? 'Loading keywords...' : 'Please select a bid first') : availableKeywords.map(function(keyword) {
                                                                        var isSelected = selectedKeywords.indexOf(keyword.keyword_id) !== -1;
                                                                        return React.createElement('button', {
                                                                            key: keyword.keyword_id,
                                                                            type: 'button',
                                                                            onClick: function() {
                                                                                if (isSelected) {
                                                                                    setSelectedKeywords(selectedKeywords.filter(function(id) { return id !== keyword.keyword_id; }));
                                                                                } else {
                                                                                    if (selectedKeywords.length < 7) {
                                                                                        setSelectedKeywords(selectedKeywords.concat([keyword.keyword_id]));
                                                                                    }
                                                                                }
                                                                            },
                                                                            disabled: !isSelected && selectedKeywords.length >= 7,
                                                                            style: {
                                                                                padding: '6px 12px',
                                                                                backgroundColor: isSelected ? greenAccent : darkBg,
                                                                                border: '1px solid ' + (isSelected ? greenAccent : darkBorder),
                                                                                borderRadius: '20px',
                                                                                color: isSelected ? darkBg : darkText,
                                                                                fontSize: '11px',
                                                                                fontFamily: 'monospace',
                                                                                cursor: (!isSelected && selectedKeywords.length >= 7) ? 'not-allowed' : 'pointer',
                                                                                opacity: (!isSelected && selectedKeywords.length >= 7) ? 0.5 : 1,
                                                                            }
                                                                        }, keyword.keyword);
                                                                    })
                                                                ),
                                                                // Keyword Count Indicator
                                                                React.createElement('div', {
                                                                    style: {
                                                                        marginTop: '8px',
                                                                        fontSize: '11px',
                                                                        color: (selectedKeywords.length >= 3 && selectedKeywords.length <= 7) ? greenAccent : '#ff8800'
                                                                    }
                                                                }, selectedKeywords.length + ' of 3-7 keywords selected')
                                                            ),
                                                            // Note Field
                                                            React.createElement('div', {
                                                                style: { marginBottom: '16px' }
                                                            },
                                                                React.createElement('label', {
                                                                    style: { display: 'block', fontSize: '12px', marginBottom: '8px', color: darkText }
                                                                }, 'Additional Note (Optional, max 240 characters)'),
                                                                React.createElement('textarea', {
                                                                    value: prototypeNote,
                                                                    onChange: function(e) {
                                                                        if (e.target.value.length <= 240) {
                                                                            setPrototypeNote(e.target.value);
                                                                        }
                                                                    },
                                                                    placeholder: 'Add any additional instructions for the prototype video...',
                                                                    style: {
                                                                        width: '100%',
                                                                        minHeight: '80px',
                                                                        padding: '8px',
                                                                        backgroundColor: darkBg,
                                                                        border: '1px solid ' + darkBorder,
                                                                        borderRadius: '4px',
                                                                        color: darkText,
                                                                        fontSize: '12px',
                                                                        fontFamily: 'monospace',
                                                                        resize: 'vertical',
                                                                    }
                                                                }),
                                                                React.createElement('div', {
                                                                    style: { marginTop: '4px', fontSize: '11px', color: '#999', textAlign: 'right' }
                                                                }, prototypeNote.length + '/240 characters')
                                                            )
                                                        ),
                                                        // Section B: Costs & Policy
                                                        selectedBidId ? (function() {
                                                            var selectedBid = itemState.bids.find(function(b) { return b.bid_id === selectedBidId; });
                                                            var prototypeCost = selectedBid && selectedBid.prototype_cost ? selectedBid.prototype_cost : null;
                                                            var cadFee = 60.00;
                                                            var totalDue = cadFee + (prototypeCost ? parseFloat(prototypeCost) : 0);
                                                            
                                                            return React.createElement('div', {
                                                                style: {
                                                                    marginBottom: '24px',
                                                                    padding: '16px',
                                                                    backgroundColor: '#1a1a1a',
                                                                    border: '1px solid ' + darkBorder,
                                                                    borderRadius: '4px',
                                                                }
                                                            },
                                                                React.createElement('div', {
                                                                    style: { fontSize: '13px', fontWeight: '600', marginBottom: '12px', color: darkText }
                                                                }, 'Costs & Policy'),
                                                                React.createElement('div', {
                                                                    style: { fontSize: '12px', color: darkText, lineHeight: '1.8' }
                                                                },
                                                                    React.createElement('div', { style: { marginBottom: '8px' } },
                                                                        React.createElement('strong', null, 'CAD Drafting Fee:'), ' $60.00'
                                                                    ),
                                                                    React.createElement('div', { style: { marginBottom: '8px' } },
                                                                        React.createElement('strong', null, 'CAD Revisions Included:'), ' Up to 3 rounds'
                                                                    ),
                                                                    React.createElement('div', { style: { marginBottom: '8px' } },
                                                                        React.createElement('strong', null, 'Additional CAD Revisions:'), ' $25.00 per round (round 4+)'
                                                                    ),
                                                                    React.createElement('div', { style: { marginBottom: '8px' } },
                                                                        React.createElement('strong', null, 'Prototype video cost:'), ' ',
                                                                        prototypeCost ? '$' + parseFloat(prototypeCost).toFixed(2) : 'Estimate not provided'
                                                                    ),
                                                                    React.createElement('div', {
                                                                        style: {
                                                                            marginTop: '12px',
                                                                            paddingTop: '12px',
                                                                            borderTop: '1px solid ' + darkBorder,
                                                                            fontSize: '13px',
                                                                            fontWeight: '600',
                                                                            color: greenAccent,
                                                                        }
                                                                    }, 'Total due now: CAD ($60.00) + Prototype Video (' + (prototypeCost ? '$' + parseFloat(prototypeCost).toFixed(2) : '$0.00') + ') = $' + totalDue.toFixed(2))
                                                                )
                                                            );
                                                        })() : null,
                                                        // Section C: Payment Instructions
                                                        selectedBidId ? React.createElement('div', {
                                                            style: {
                                                                marginBottom: '24px',
                                                                padding: '16px',
                                                                backgroundColor: '#1a1a1a',
                                                                border: '1px solid ' + darkBorder,
                                                                borderRadius: '4px',
                                                            }
                                                        },
                                                            React.createElement('div', {
                                                                style: { fontSize: '13px', fontWeight: '600', marginBottom: '12px', color: darkText }
                                                            }, 'WireFrameOS Payment Details'),
                                                            React.createElement('div', {
                                                                style: { fontSize: '12px', color: darkText, lineHeight: '1.8', marginBottom: '12px' }
                                                            },
                                                                React.createElement('div', { style: { marginBottom: '8px' } },
                                                                    React.createElement('strong', null, 'ACH / Wire Instructions:'), React.createElement('br'),
                                                                    'Bank: [Bank Name]', React.createElement('br'),
                                                                    'Account Number: [Account Number]', React.createElement('br'),
                                                                    'Routing Number: [Routing Number]', React.createElement('br'),
                                                                    'Account Name: WireFrameOS'
                                                                ),
                                                                React.createElement('div', { style: { marginBottom: '8px' } },
                                                                    React.createElement('strong', null, 'Zelle Instructions:'), React.createElement('br'),
                                                                    'Email: payments@wireframeos.com', React.createElement('br'),
                                                                    'Phone: [Phone Number]'
                                                                ),
                                                                React.createElement('div', {
                                                                    style: {
                                                                        marginTop: '12px',
                                                                        padding: '8px',
                                                                        backgroundColor: '#2a2a2a',
                                                                        borderRadius: '4px',
                                                                        fontSize: '11px',
                                                                        fontFamily: 'monospace',
                                                                        color: greenAccent,
                                                                    }
                                                                },
                                                                    React.createElement('strong', null, 'Required Reference Line:'), ' Item #' + itemId + ' + Bid #' + selectedBidId
                                                                )
                                                            )
                                                        ) : null,
                                                        // Submit Button
                                                        React.createElement('button', {
                                                            onClick: function() {
                                                                // Validation
                                                                if (!selectedBidId) {
                                                                    setCadPrototypeError('Please select a bid.');
                                                                    return;
                                                                }
                                                                
                                                                if (selectedKeywords.length < 3 || selectedKeywords.length > 7) {
                                                                    setCadPrototypeError('Please select between 3 and 7 keywords.');
                                                                    return;
                                                                }

                                                                setIsSubmittingCadPrototype(true);
                                                                setCadPrototypeError('');
                                                                setCadPrototypeSuccess(false);

                                                                var formData = new FormData();
                                                                formData.append('action', 'n88_create_cad_prototype_request');
                                                                formData.append('item_id', itemId);
                                                                formData.append('bid_id', selectedBidId);
                                                                // Send keywords as array
                                                                selectedKeywords.forEach(function(keywordId) {
                                                                    formData.append('selected_keywords[]', keywordId);
                                                                });
                                                                formData.append('note', prototypeNote);
                                                                // Get nonce for n88-rfq-nonce action
                                                                var submitNonce = '';
                                                                if (window.n88BoardNonce && window.n88BoardNonce.nonce) {
                                                                    submitNonce = window.n88BoardNonce.nonce;
                                                                } else if (window.n88BoardData && window.n88BoardData.nonce) {
                                                                    submitNonce = window.n88BoardData.nonce;
                                                                } else if (window.n88 && window.n88.nonce) {
                                                                    submitNonce = window.n88.nonce;
                                                                }
                                                                
                                                                if (!submitNonce) {
                                                                    setCadPrototypeError('Nonce not found. Please refresh the page and try again.');
                                                                    setIsSubmittingCadPrototype(false);
                                                                    return;
                                                                }
                                                                
                                                                formData.append('nonce', submitNonce);

                                                                fetch((window.n88BoardData && window.n88BoardData.ajaxUrl) || (window.n88 && window.n88.ajaxUrl) || '/wp-admin/admin-ajax.php', {
                                                                    method: 'POST',
                                                                    body: formData,
                                                                })
                                                                .then(function(response) { return response.json(); })
                                                                .then(function(data) {
                                                                    if (data.success) {
                                                                        setCadPrototypeSuccess(true);
                                                                        setSelectedKeywords([]);
                                                                        setPrototypeNote('');
                                                                        // Lock Launch Brief immediately when CAD request is submitted
                                                                        setItemState(function(prev) { return Object.assign({}, prev, { has_prototype_payment: true, prototype_payment_status: 'requested' }); });
                                                                        // Commit 2.3.9.1C: Refresh item state to show payment banner
                                                                        fetchItemState();
                                                                        // Scroll to top of form to show success message
                                                                        setTimeout(function() {
                                                                            var formElement = document.getElementById('cad-prototype-form-container');
                                                                            if (formElement) {
                                                                                formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                                            }
                                                                        }, 100);
                                                                    } else {
                                                                        setCadPrototypeError((data.data && data.data.message) || 'Failed to create request. Please try again.');
                                                                        // Scroll to top of form to show error message
                                                                        setTimeout(function() {
                                                                            var formElement = document.getElementById('cad-prototype-form-container');
                                                                            if (formElement) {
                                                                                formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                                            }
                                                                        }, 100);
                                                                    }
                                                                })
                                                                .catch(function(error) {
                                                                    setCadPrototypeError('Error submitting request. Please try again.');
                                                                    console.error('CAD Prototype Request Error:', error);
                                                                    // Scroll to top of form to show error message
                                                                    setTimeout(function() {
                                                                        var formElement = document.getElementById('cad-prototype-form-container');
                                                                        if (formElement) {
                                                                            formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                                        }
                                                                    }, 100);
                                                                })
                                                                .finally(function() {
                                                                    setIsSubmittingCadPrototype(false);
                                                                });
                                                            },
                                                            disabled: isSubmittingCadPrototype || !selectedBidId || selectedKeywords.length < 3 || selectedKeywords.length > 7,
                                                            style: {
                                                                width: '100%',
                                                                padding: '12px',
                                                                backgroundColor: (isSubmittingCadPrototype || !selectedBidId || selectedKeywords.length < 3 || selectedKeywords.length > 7) ? '#333' : greenAccent,
                                                                border: 'none',
                                                                borderRadius: '4px',
                                                                color: (isSubmittingCadPrototype || !selectedBidId || selectedKeywords.length < 3 || selectedKeywords.length > 7) ? '#666' : darkBg,
                                                                fontSize: '14px',
                                                                fontFamily: 'monospace',
                                                                fontWeight: '600',
                                                                cursor: (isSubmittingCadPrototype || !selectedBidId || selectedKeywords.length < 3 || selectedKeywords.length > 7) ? 'not-allowed' : 'pointer',
                                                            }
                                                        }, isSubmittingCadPrototype ? 'Submitting...' : 'Submit Request')
                                                    ),
                                                    // Commit 2.3.6: Concierge + Delivery Banner
                                                    React.createElement('div', {
                                                        style: {
                                                            marginTop: '20px',
                                                            padding: '16px',
                                                            backgroundColor: '#1a1a1a',
                                                            border: '1px solid ' + darkBorder,
                                                            borderRadius: '4px',
                                                        }
                                                    },
                                                        React.createElement('div', {
                                                            style: { fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: darkText }
                                                        }, 'Proposals are in. When you\'re ready to move to prototypes or orders, sourcing agent oversight is available.'),
                                                        React.createElement('div', {
                                                            style: { fontSize: '11px', color: darkText, marginBottom: '12px', lineHeight: '1.5' }
                                                        }, 'Wireframe OS can also coordinate production follow-through and delivery so everything stays under one roof.'),
                                                        React.createElement('button', {
                                                            style: {
                                                                padding: '8px 16px',
                                                                backgroundColor: greenAccent,
                                                                border: 'none',
                                                                borderRadius: '4px',
                                                                color: darkBg,
                                                                fontSize: '12px',
                                                                fontFamily: 'monospace',
                                                                fontWeight: '600',
                                                                cursor: 'pointer',
                                                            },
                                                            title: 'Sourcing agent support becomes available when you request a prototype or proceed to order. This includes delivery coordination.',
                                                            onClick: function(e) {
                                                                e.preventDefault();
                                                                e.stopPropagation();
                                                                // Commit 2.3.6: Visual only - no action
                                                            }
                                                        }, 'Get Sourcing Agent Help')
                                                    )
                                                ) : null
                                            ) : React.createElement('div', {
                                                style: { padding: '24px', textAlign: 'center', color: darkText, fontSize: '14px' }
                                            }, 'No proposals received yet.')
                                        ) : null,
                                        // Tab 4: The Workflow (Read-only)
                                        activeTab === 'timeline' ? React.createElement('div', null,
                                            React.createElement('div', {
                                                style: {
                                                    fontSize: '16px',
                                                    fontWeight: '600',
                                                    marginBottom: '20px',
                                                    color: darkText
                                                }
                                            }, 'The Workflow'),
                                            React.createElement('div', {
                                                style: {
                                                    marginBottom: '16px',
                                                    padding: '12px',
                                                    backgroundColor: '#111111',
                                                    border: '1px solid ' + darkBorder,
                                                    borderRadius: '4px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText
                                                    }
                                                },
                                                    React.createElement('span', { style: { opacity: 0.7 } }, 'Timeline Type: '),
                                                    React.createElement('span', { style: { color: greenAccent } }, '[ Furniture 6-Step ▼ ]')
                                                ),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        color: darkText
                                                    }
                                                },
                                                    React.createElement('span', { style: { opacity: 0.7 } }, 'Status: '),
                                                    React.createElement('span', { style: { color: greenAccent } }, '[ Read-only (Phase 2) ]')
                                                )
                                            ),
                                            // Step 1: Design & Specifications
                                            React.createElement('div', {
                                                style: {
                                                    marginBottom: '16px',
                                                    padding: '12px',
                                                    backgroundColor: '#111111',
                                                    border: '1px solid ' + darkBorder,
                                                    borderRadius: '4px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        marginBottom: '12px',
                                                        color: darkText
                                                    }
                                                }, '1) Design & Specifications'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText
                                                    }
                                                },
                                                    React.createElement('span', { style: { marginRight: '8px' } }, '●'),
                                                    React.createElement('span', { style: { opacity: 0.7 } }, 'State: '),
                                                    React.createElement('span', { style: { color: greenAccent } }, 'Pending')
                                                ),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Evidence: 0'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Notes: 0')
                                            ),
                                            // Step 2: Technical Review & Documentation
                                            React.createElement('div', {
                                                style: {
                                                    marginBottom: '16px',
                                                    padding: '12px',
                                                    backgroundColor: '#111111',
                                                    border: '1px solid ' + darkBorder,
                                                    borderRadius: '4px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        marginBottom: '12px',
                                                        color: darkText
                                                    }
                                                }, '2) Technical Review & Documentation'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText
                                                    }
                                                },
                                                    React.createElement('span', { style: { marginRight: '8px' } }, '●'),
                                                    React.createElement('span', { style: { opacity: 0.7 } }, 'State: '),
                                                    React.createElement('span', { style: { color: greenAccent } }, 'Pending')
                                                ),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Evidence: 0'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Notes: 0')
                                            ),
                                            // Step 3: Pre-Production Approval
                                            React.createElement('div', {
                                                style: {
                                                    marginBottom: '16px',
                                                    padding: '12px',
                                                    backgroundColor: '#111111',
                                                    border: '1px solid ' + darkBorder,
                                                    borderRadius: '4px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        marginBottom: '12px',
                                                        color: darkText
                                                    }
                                                }, '3) Pre-Production Approval'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText
                                                    }
                                                },
                                                    React.createElement('span', { style: { marginRight: '8px' } }, '●'),
                                                    React.createElement('span', { style: { opacity: 0.7 } }, 'State: '),
                                                    React.createElement('span', { style: { color: greenAccent } }, 'Pending')
                                                ),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Prototype: [ Not requested ]'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Evidence: 0'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Notes: 0')
                                            ),
                                            // Step 4: Production / Fabrication
                                            React.createElement('div', {
                                                style: {
                                                    marginBottom: '16px',
                                                    padding: '12px',
                                                    backgroundColor: '#111111',
                                                    border: '1px solid ' + darkBorder,
                                                    borderRadius: '4px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        marginBottom: '12px',
                                                        color: darkText
                                                    }
                                                }, '4) Production / Fabrication'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText
                                                    }
                                                },
                                                    React.createElement('span', { style: { marginRight: '8px' } }, '●'),
                                                    React.createElement('span', { style: { opacity: 0.7 } }, 'State: '),
                                                    React.createElement('span', { style: { color: greenAccent } }, 'Pending')
                                                ),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Evidence: 0'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Notes: 0')
                                            ),
                                            // Step 5: Quality Review & Packing
                                            React.createElement('div', {
                                                style: {
                                                    marginBottom: '16px',
                                                    padding: '12px',
                                                    backgroundColor: '#111111',
                                                    border: '1px solid ' + darkBorder,
                                                    borderRadius: '4px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        marginBottom: '12px',
                                                        color: darkText
                                                    }
                                                }, '5) Quality Review & Packing'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText
                                                    }
                                                },
                                                    React.createElement('span', { style: { marginRight: '8px' } }, '●'),
                                                    React.createElement('span', { style: { opacity: 0.7 } }, 'State: '),
                                                    React.createElement('span', { style: { color: greenAccent } }, 'Pending')
                                                ),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Evidence: 0'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Notes: 0')
                                            ),
                                            // Step 6: Ready for Delivery
                                            React.createElement('div', {
                                                style: {
                                                    marginBottom: '16px',
                                                    padding: '12px',
                                                    backgroundColor: '#111111',
                                                    border: '1px solid ' + darkBorder,
                                                    borderRadius: '4px',
                                                }
                                            },
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        marginBottom: '12px',
                                                        color: darkText
                                                    }
                                                }, '6) Ready for Delivery'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText
                                                    }
                                                },
                                                    React.createElement('span', { style: { marginRight: '8px' } }, '●'),
                                                    React.createElement('span', { style: { opacity: 0.7 } }, 'State: '),
                                                    React.createElement('span', { style: { color: greenAccent } }, 'Pending')
                                                ),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        marginBottom: '8px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Evidence: 0'),
                                                React.createElement('div', {
                                                    style: {
                                                        fontSize: '12px',
                                                        color: darkText,
                                                        opacity: 0.7
                                                    }
                                                }, '(Future) Notes: 0')
                                            )
                                        ) : null
                                    )
                                )
                            ),
                            // Footer - Update button and Save button (State A, B, and C - dims/qty always editable); Lock Designer: hidden when awaiting payment
                            (currentState === 'A' || currentState === 'B' || currentState === 'C') && !isLockedAwaitingPayment ? React.createElement('div', {
                                style: {
                                    padding: '16px 20px',
                                    borderTop: '1px solid ' + darkBorder,
                                    display: 'flex',
                                    gap: '12px',
                                    justifyContent: 'flex-end',
                                }
                            },
                                // Show Update button only if RFQ has already been submitted (State B or C)
                                // Update button: Only updates dimensions and quantity
                                ((currentState === 'B' || currentState === 'C') || (item && item.has_rfq) || (itemState && itemState.has_rfq)) ? React.createElement('button', {
                                    onClick: handleUpdateDimensions,
                                    disabled: isSaving || isUploadingInspiration,
                                    style: {
                                        padding: '10px 20px',
                                        backgroundColor: '#111111',
                                        border: '1px solid ' + darkBorder,
                                        borderRadius: '4px',
                                        color: darkText,
                                        fontSize: '14px',
                                        fontFamily: 'monospace',
                                        cursor: (isSaving || isUploadingInspiration) ? 'not-allowed' : 'pointer',
                                        fontWeight: '600',
                                        opacity: (isSaving || isUploadingInspiration) ? 0.6 : 1,
                                    }
                                }, isUploadingInspiration ? 'Uploading...' : (isSaving ? 'Updating...' : 'Update')) : null,
                                React.createElement('button', {
                                    onClick: handleSave,
                                    disabled: isSaving || isUploadingInspiration,
                                    style: {
                                        padding: '10px 20px',
                                        backgroundColor: greenAccent,
                                        border: 'none',
                                        borderRadius: '4px',
                                        color: darkBg,
                                        fontSize: '14px',
                                        fontFamily: 'monospace',
                                        cursor: (isSaving || isUploadingInspiration) ? 'not-allowed' : 'pointer',
                                        fontWeight: '600',
                                        opacity: (isSaving || isUploadingInspiration) ? 0.6 : 1,
                                    }
                                }, (isUploadingInspiration ? 'Uploading...' : (isSaving ? 'Saving...' : 'Save for later')))
                            ) : null
                        )
                    ];
                    
                    // Add lightbox to children if it exists
                    if (lightboxImage) {
                        fragmentChildren.push(
                            React.createElement('div', {
                                onClick: function(e) {
                                    // Only close if clicking the backdrop, not the image
                                    if (e.target === e.currentTarget) {
                                        setLightboxImage(null);
                                    }
                                },
                                style: {
                                    position: 'fixed',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    backgroundColor: 'rgba(0, 0, 0, 0.95)',
                                    zIndex: 10000001,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    padding: '20px',
                                }
                            },
                                React.createElement('img', {
                                    src: lightboxImage,
                                    alt: 'Enlarged',
                                    onClick: function(e) { e.stopPropagation(); },
                                    style: {
                                        maxWidth: '90%',
                                        maxHeight: '90%',
                                        objectFit: 'contain',
                                        pointerEvents: 'auto',
                                    }
                                }),
                                React.createElement('button', {
                                    onClick: function(e) {
                                        e.stopPropagation();
                                        setLightboxImage(null);
                                    },
                                    onMouseOver: function(e) {
                                        e.currentTarget.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
                                        e.currentTarget.style.transform = 'scale(1.1)';
                                    },
                                    onMouseOut: function(e) {
                                        e.currentTarget.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                                        e.currentTarget.style.transform = 'scale(1)';
                                    },
                                    style: {
                                        position: 'absolute',
                                        top: '20px',
                                        right: '20px',
                                        background: 'rgba(0, 0, 0, 0.7)',
                                        border: '2px solid #fff',
                                        borderRadius: '50%',
                                        color: '#fff',
                                        fontSize: '28px',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        padding: '0',
                                        width: '44px',
                                        height: '44px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        lineHeight: '1',
                                        transition: 'all 0.2s',
                                        zIndex: 10000002,
                                    }
                                }, '×')
                            )
                        );
                    }
                    
                    
                    // Commit 2.3.9.1C: Payment Instructions Modal
                    if (showPaymentInstructions) {
                        fragmentChildren.push(
                            React.createElement('div', {
                                key: 'payment-instructions-modal',
                                style: {
                                    position: 'fixed',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    zIndex: 10000002,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    padding: '20px',
                                },
                                onClick: function() { setShowPaymentInstructions(false); }
                            },
                                React.createElement('div', {
                                    style: {
                                        maxWidth: '600px',
                                        width: '100%',
                                        backgroundColor: darkBg,
                                        border: '2px solid ' + greenAccent,
                                        borderRadius: '8px',
                                        padding: '24px',
                                        fontFamily: 'monospace',
                                    },
                                    onClick: function(e) { e.stopPropagation(); }
                                },
                                    React.createElement('div', {
                                        style: {
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            marginBottom: '20px',
                                            borderBottom: '1px solid ' + darkBorder,
                                            paddingBottom: '12px',
                                        }
                                    },
                                        React.createElement('h2', {
                                            style: {
                                                margin: 0,
                                                fontSize: '18px',
                                                fontWeight: '600',
                                                color: greenAccent,
                                            }
                                        }, 'Prototype & CAD Payment Instructions'),
                                        React.createElement('button', {
                                            onClick: function() { setShowPaymentInstructions(false); },
                                            style: {
                                                background: 'none',
                                                border: 'none',
                                                color: darkText,
                                                fontSize: '24px',
                                                cursor: 'pointer',
                                                padding: '0',
                                                width: '32px',
                                                height: '32px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                            }
                                        }, '×')
                                    ),
                                    React.createElement('div', {
                                        style: {
                                            fontSize: '13px',
                                            color: darkText,
                                            lineHeight: '1.6',
                                            maxHeight: '70vh',
                                            overflowY: 'auto',
                                        }
                                    },
                                        React.createElement('div', {
                                            style: {
                                                marginBottom: '16px',
                                                padding: '12px',
                                                backgroundColor: '#111111',
                                                borderRadius: '4px',
                                                border: '1px solid ' + darkBorder,
                                            }
                                        },
                                            React.createElement('div', {
                                                style: {
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: greenAccent,
                                                    marginBottom: '8px',
                                                }
                                            }, 'Amount Due: $' + (itemState.prototype_payment_total_due ? itemState.prototype_payment_total_due.toFixed(2) : '0.00'))
                                        ),
                                        React.createElement('div', {
                                            style: {
                                                marginBottom: '16px',
                                            }
                                        },
                                            React.createElement('div', {
                                                style: {
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: greenAccent,
                                                    marginBottom: '8px',
                                                }
                                            }, 'What this covers:'),
                                            React.createElement('ul', {
                                                style: {
                                                    margin: 0,
                                                    paddingLeft: '20px',
                                                    color: darkText,
                                                }
                                            },
                                                React.createElement('li', null, 'CAD drawings'),
                                                React.createElement('li', null, 'Video prototype')
                                            )
                                        ),
                                        React.createElement('div', {
                                            style: {
                                                marginBottom: '16px',
                                            }
                                        },
                                            React.createElement('div', {
                                                style: {
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: greenAccent,
                                                    marginBottom: '8px',
                                                }
                                            }, 'Payment Methods Accepted:'),
                                            React.createElement('ul', {
                                                style: {
                                                    margin: 0,
                                                    paddingLeft: '20px',
                                                    color: darkText,
                                                }
                                            },
                                                React.createElement('li', null, 'Wire'),
                                                React.createElement('li', null, 'ACH'),
                                                React.createElement('li', null, 'Zelle')
                                            )
                                        ),
                                        React.createElement('div', {
                                            style: {
                                                marginBottom: '16px',
                                                padding: '12px',
                                                backgroundColor: '#111111',
                                                borderRadius: '4px',
                                                border: '1px solid ' + darkBorder,
                                            }
                                        },
                                            React.createElement('div', {
                                                style: {
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    color: greenAccent,
                                                    marginBottom: '8px',
                                                }
                                            }, 'Instructions:'),
                                            React.createElement('ol', {
                                                style: {
                                                    margin: 0,
                                                    paddingLeft: '20px',
                                                    color: darkText,
                                                }
                                            },
                                                React.createElement('li', null, 'Send payment using one of the methods above'),
                                                React.createElement('li', null, 'Include Item #' + itemId + ' in the memo'),
                                                React.createElement('li', null, 'Once received, CAD drafting will begin automatically')
                                            )
                                        ),
                                        React.createElement('div', {
                                            style: {
                                                padding: '12px',
                                                backgroundColor: '#331100',
                                                borderRadius: '4px',
                                                border: '1px solid #ff8800',
                                            }
                                        },
                                            React.createElement('div', {
                                                style: {
                                                    fontSize: '12px',
                                                    fontWeight: '600',
                                                    color: '#ff8800',
                                                }
                                            }, 'Important:'),
                                            React.createElement('div', {
                                                style: {
                                                    fontSize: '12px',
                                                    color: '#ffaa66',
                                                    marginTop: '4px',
                                                }
                                            }, 'Work does not begin until payment is confirmed by our team.')
                                        ),
                                        React.createElement('div', {
                                            style: {
                                                marginTop: '20px',
                                                padding: '12px',
                                                backgroundColor: '#0a1a0a',
                                                borderRadius: '4px',
                                                border: '1px solid #00ff00',
                                            }
                                        },
                                            React.createElement('div', {
                                                style: { fontSize: '14px', fontWeight: '600', color: greenAccent, marginBottom: '8px' }
                                            }, 'Upload Payment Receipt'),
                                            React.createElement('div', {
                                                style: { fontSize: '12px', color: darkText, marginBottom: '10px' }
                                            }, 'JPG or PDF. Operator will review before confirming payment.'),
                                            React.createElement('input', {
                                                type: 'file',
                                                accept: '.jpg,.jpeg,.pdf',
                                                onChange: handlePaymentReceiptUpload,
                                                disabled: paymentReceiptUploading,
                                                style: { display: 'block', marginBottom: '10px', fontSize: '12px', color: '#fff' },
                                            }),
                                            paymentReceiptUploading ? React.createElement('div', { style: { fontSize: '12px', color: greenAccent, marginBottom: '8px' } }, 'Uploading…') : null,
                                            paymentReceiptsLoading ? React.createElement('div', { style: { fontSize: '12px', color: darkText, marginBottom: '8px' } }, 'Loading receipts…') : null,
                                            (!paymentReceiptsLoading && paymentReceipts.length > 0) ? React.createElement('div', { style: { marginTop: '10px' } },
                                                React.createElement('div', { style: { fontSize: '12px', fontWeight: '600', color: greenAccent, marginBottom: '6px' } }, 'Uploaded:'),
                                                React.createElement('ul', { style: { margin: 0, paddingLeft: '20px', color: darkText, fontSize: '12px' } },
                                                    paymentReceipts.map(function(r) {
                                                        return React.createElement('li', { key: r.id },
                                                            React.createElement('a', { href: r.url, target: '_blank', rel: 'noopener noreferrer', style: { color: greenAccent } }, r.file_name)
                                                        );
                                                    })
                                                )
                                            ) : null
                                        )
                                    )
                                )
                            )
                        );
                    }
                    
                    // Create Fragment with children
                    var modalContent = React.createElement.apply(null, [React.Fragment, null].concat(fragmentChildren));
                    
                    // Render modal outside canvas container using portal
                    // Use ReactDOM.createPortal if available, otherwise render normally
                    if (typeof window !== 'undefined' && window.ReactDOM && window.ReactDOM.createPortal) {
                        return window.ReactDOM.createPortal(modalContent, document.body);
                    } else {
                        // Fallback: render normally if portal not available
                        return modalContent;
                    }
                };

                // Wrap BoardItem to add modal functionality
                var BoardItemWrapper = function(props) {
                    var item = props.item;
                    var onLayoutChanged = props.onLayoutChanged;
                    var boardId = props.boardId;
                    
                    var _modalState = React.useState(false);
                    var isModalOpen = _modalState[0];
                    var setIsModalOpen = _modalState[1];
                    
                    // Create a modified BoardItem that can trigger modal
                    var boardItemProps = Object.assign({}, props);
                    // Store modal handlers in a way BoardItem can access
                    boardItemProps._modalHandlers = {
                        open: function() { 
                            setIsModalOpen(true);
                        },
                        close: function() { setIsModalOpen(false); }
                    };
                    
                    // onSave handler for ItemDetailModal
                    var handleSave = function(itemId, payload) {
                        if (boardId && boardId > 0) {
                            // Real board - save via AJAX
                            return fetch(window.n88BoardData && window.n88BoardData.ajaxUrl ? window.n88BoardData.ajaxUrl : '/wp-admin/admin-ajax.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: new URLSearchParams({
                                    action: 'n88_save_item_facts',
                                    board_id: boardId,
                                    item_id: itemId,
                                    nonce: window.n88BoardData && window.n88BoardData.nonce ? window.n88BoardData.nonce : '',
                                    payload: JSON.stringify(payload),
                                }),
                            }).then(function(response) {
                                return response.json();
                            }).then(function(data) {
                                if (!data.success) {
                                    throw new Error(data.data && data.data.message ? data.data.message : 'Failed to save item facts');
                                }
                                
                                // Update board item in store after save
                                if (window.N88StudioOS && window.N88StudioOS.useBoardStore) {
                                    var store = window.N88StudioOS.useBoardStore.getState();
                                    var currentItems = store.items || [];
                                    var updatedItems = currentItems.map(function(storeItem) {
                                        var storeItemId = storeItem.id;
                                        var itemIdStr = 'item-' + itemId;
                                        if (storeItemId === item.id || storeItemId === itemIdStr || storeItemId === itemId) {
                                            // Check if RFQ exists and revision changed (dimensions/quantity changed)
                                            var hasRfq = storeItem.has_rfq === true || storeItem.has_rfq === 'true' || storeItem.has_rfq === 1;
                                            var revisionChanged = false;
                                            
                                            // If RFQ exists and save was successful, check if revision changed
                                            if (hasRfq && data.data) {
                                                // Backend should set revision_changed if dims/qty changed
                                                revisionChanged = data.data.revision_changed === true || data.data.revision_changed === 'true' || data.data.revision_changed === 1;
                                                
                                                // Also check if has_warning (indicates dims/qty changed after RFQ with bids)
                                                if (data.data.has_warning) {
                                                    revisionChanged = true;
                                                }
                                            }
                                            
                                            // Update item with new data and revision_changed flag
                                            var updatedItem = Object.assign({}, storeItem);
                                            if (revisionChanged) {
                                                updatedItem.revision_changed = true;
                                                updatedItem.valid_bid_count = 0; // Reset valid bid count for new revision
                                                updatedItem.bid_count = 0;
                                                updatedItem.has_bids = false;
                                            }
                                            // Update other fields from payload if needed
                                            if (payload.dims) {
                                                updatedItem.dims = payload.dims;
                                            }
                                            if (payload.dims_cm) {
                                                updatedItem.dims_cm = payload.dims_cm;
                                            }
                                            if (payload.quantity !== undefined) {
                                                updatedItem.quantity = payload.quantity;
                                            }
                                            
                                            return updatedItem;
                                        }
                                        return storeItem;
                                    });
                                    store.setItems(updatedItems);
                                }
                                
                                // Commit 2.3.5.1: Return data.data to access has_warning flag
                                return data.data || data;
                            });
                        } else {
                            // Demo mode - just log
                            console.log('Demo mode: Item facts saved to store only', payload);
                            return Promise.resolve();
                        }
                    };
                    
                    return React.createElement(React.Fragment, null,
                        React.createElement(BoardItem, boardItemProps),
                        React.createElement(ItemDetailModalInline, {
                            item: item,
                            isOpen: isModalOpen,
                            onClose: function() { setIsModalOpen(false); },
                            onSave: handleSave,
                            boardId: boardId
                        })
                    );
                };

                // UnsyncedToast Component
                const UnsyncedToast = ({ unsynced, onDismiss }) => {
                    // Don't render anything if not unsynced
                    if (!unsynced) {
                        return null;
                    }
                    
                    return React.createElement(AnimatePresence, { mode: 'wait' }, React.createElement(motion.div, {
                        key: 'unsynced-toast',
                        initial: { opacity: 0, y: -20 },
                        animate: { opacity: 1, y: 0 },
                        exit: { opacity: 0, y: -20 },
                        transition: { duration: 0.2 },
                        style: {
                            position: 'fixed',
                            top: '20px',
                            right: '20px',
                            backgroundColor: '#ff9800',
                            color: '#fff',
                            padding: '12px 16px',
                            borderRadius: '4px',
                            boxShadow: '0 2px 8px rgba(0, 0, 0, 0.2)',
                            zIndex: 10000,
                            fontSize: '14px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            maxWidth: '300px',
                        },
                    }, React.createElement('span', null, '⚠️ Changes not saved'), onDismiss && React.createElement('button', {
                        onClick: onDismiss,
                        style: {
                            background: 'transparent',
                            border: 'none',
                            color: '#fff',
                            cursor: 'pointer',
                            fontSize: '18px',
                            padding: '0',
                            marginLeft: '8px',
                            lineHeight: '1',
                        },
                    }, '×')));
                };

                // ConciergeOverlay Component (inline)
                const ConciergeOverlay = function({ concierge }) {
                    var conciergeData = concierge || { name: 'Message System Operator', avatarUrl: '' };
                    return React.createElement('div', {
                        style: {
                            position: 'absolute',
                            top: '20px',
                            left: '20px',
                            zIndex: 10000,
                            pointerEvents: 'none',
                        },
                    }, React.createElement('div', {
                        style: {
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            padding: '12px 16px',
                            borderRadius: '8px',
                            boxShadow: '0 2px 8px rgba(0, 0, 0, 0.15)',
                            border: '1px solid rgba(0, 0, 0, 0.1)',
                        },
                    }, React.createElement('div', {
                        style: {
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            backgroundColor: conciergeData.avatarUrl ? 'transparent' : '#0073aa',
                            backgroundImage: conciergeData.avatarUrl ? 'url(' + conciergeData.avatarUrl + ')' : 'none',
                            backgroundSize: 'cover',
                            backgroundPosition: 'center',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: '#fff',
                            fontSize: '18px',
                            fontWeight: 'bold',
                            flexShrink: 0,
                        },
                    }, !conciergeData.avatarUrl && React.createElement('span', null, conciergeData.name.charAt(0).toUpperCase())), React.createElement('div', {
                        style: {
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#333',
                        },
                    }, conciergeData.name)));
                };

                // WelcomeModal Component (inline)
                const WelcomeModal = function({ userId, onClose }) {
                    var _a = React.useState(false), isVisible = _a[0], setIsVisible = _a[1];
                    
                    React.useEffect(function() {
                        if (!userId) return;
                        var storageKey = 'n88_welcome_modal_shown_v1_user_' + userId;
                        try {
                            var alreadyShown = localStorage.getItem(storageKey);
                            if (alreadyShown === 'true') return;
                        } catch (e) {
                            console.warn('Failed to check welcome modal flag:', e);
                            return;
                        }
                        setIsVisible(true);
                        try {
                            localStorage.setItem(storageKey, 'true');
                        } catch (e) {
                            console.warn('Failed to set welcome modal flag:', e);
                        }
                    }, [userId]);
                    
                    var handleClose = function() {
                        setIsVisible(false);
                        if (onClose) onClose();
                    };
                    
                    if (!isVisible) return null;
                    
                    return React.createElement('div', {
                        style: {
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundColor: 'rgba(0, 0, 0, 0.6)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 99999,
                            pointerEvents: 'auto',
                        },
                        onClick: function(e) {
                            if (e.target === e.currentTarget) handleClose();
                        },
                    }, React.createElement('div', {
                        style: {
                            backgroundColor: '#fff',
                            borderRadius: '8px',
                            padding: '24px',
                            maxWidth: '600px',
                            width: '90%',
                            maxHeight: '90vh',
                            overflow: 'auto',
                            boxShadow: '0 4px 20px rgba(0, 0, 0, 0.3)',
                            pointerEvents: 'auto',
                            position: 'relative',
                        },
                        onClick: function(e) { e.stopPropagation(); },
                    }, React.createElement('button', {
                        onClick: handleClose,
                        style: {
                            position: 'absolute',
                            top: '12px',
                            right: '12px',
                            background: 'transparent',
                            border: 'none',
                            fontSize: '24px',
                            cursor: 'pointer',
                            color: '#666',
                            padding: '4px 8px',
                            lineHeight: 1,
                        },
                        'aria-label': 'Close',
                    }, '×'), React.createElement('h2', {
                        style: {
                            marginTop: 0,
                            marginBottom: '16px',
                            fontSize: '24px',
                            fontWeight: 'bold',
                            color: '#333',
                        },
                    }, 'Welcome to Your Board'), React.createElement('p', {
                        style: {
                            marginBottom: '20px',
                            fontSize: '16px',
                            color: '#666',
                            lineHeight: 1.6,
                        },
                    }, 'Get started by exploring your board. Drag items to organize them, change sizes, and customize your layout.'), React.createElement('div', {
                        style: {
                            width: '100%',
                            paddingBottom: '56.25%',
                            position: 'relative',
                            backgroundColor: '#f0f0f0',
                            borderRadius: '4px',
                            marginBottom: '20px',
                            overflow: 'hidden',
                        },
                    }, React.createElement('div', {
                        style: {
                            position: 'absolute',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: '#999',
                            fontSize: '14px',
                        },
                    }, 'Video placeholder (embed video here)')), React.createElement('button', {
                        onClick: handleClose,
                        style: {
                            width: '100%',
                            padding: '12px 24px',
                            backgroundColor: '#0073aa',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '4px',
                            fontSize: '16px',
                            fontWeight: '600',
                            cursor: 'pointer',
                        },
                    }, 'Get Started')));
                };

                // BoardCanvas Component
                const BoardCanvas = function({ boardId, onLayoutChanged, userId, concierge }) {
                    var items = useBoardStore(function(state) { return state.items; });
                    
                    // Use Zustand's store getter to avoid stale closures
                    var getItems = React.useCallback(
                        function() { return window.N88StudioOS.useBoardStore.getState().items; },
                        []
                    );
                    
                    // Initialize debounced save hook (must be called unconditionally for React hooks rules)
                    // Pass boardId (can be 0 for demo mode - hook will handle it gracefully)
                    var saveHook = null;
                    if (useDebouncedSave) {
                        console.log('BoardCanvas: Initializing useDebouncedSave with boardId =', boardId);
                        saveHook = useDebouncedSave(boardId || 0, getItems);
                        console.log('BoardCanvas: saveHook initialized:', saveHook);
                    } else {
                        console.warn('BoardCanvas: useDebouncedSave is not available!');
                    }
                    
                    // Track unsynced state in component state to trigger re-renders
                    var _unsyncedState = React.useState(saveHook ? saveHook.unsynced : false);
                    var unsyncedState = _unsyncedState[0];
                    var setUnsyncedState = _unsyncedState[1];
                    
                    // Subscribe to unsynced state changes from the hook
                    // The hook's state updates don't automatically trigger parent re-renders,
                    // so we need to sync it with component state
                    React.useEffect(function() {
                        if (!saveHook) {
                            setUnsyncedState(false);
                            return;
                        }
                        
                        // Update immediately on mount
                        setUnsyncedState(saveHook.unsynced);
                        
                        // Check unsynced state periodically (every 50ms) to catch updates
                        // Read directly from saveHook each time to avoid closure issues
                        var checkInterval = setInterval(function() {
                            if (saveHook) {
                                var currentUnsynced = saveHook.unsynced;
                                // Use functional update to always get latest state
                                setUnsyncedState(function(prev) {
                                    if (prev !== currentUnsynced) {
                                        console.log('BoardCanvas: unsynced state changed from', prev, 'to', currentUnsynced);
                                        return currentUnsynced;
                                    }
                                    return prev;
                                });
                            }
                        }, 50);
                        
                        return function() {
                            clearInterval(checkInterval);
                        };
                    }, [saveHook]);
                    
                    // Handle layout changes - trigger debounced save
                    var handleLayoutChanged = function(data) {
                        if (onLayoutChanged) {
                            onLayoutChanged(data);
                        }
                        
                        // For demo mode (boardId = 0), save to localStorage with debounce
                        if (boardId === 0) {
                            // Clear existing timer
                            if (localStorageSaveTimer) {
                                clearTimeout(localStorageSaveTimer);
                            }
                            // Set new debounced save (500ms trailing edge, same as server save)
                            localStorageSaveTimer = setTimeout(function() {
                                localStorageSaveTimer = null;
                                try {
                                    var currentItems = window.N88StudioOS.useBoardStore.getState().items;
                                    localStorage.setItem(DEMO_STORAGE_KEY, JSON.stringify({
                                        items: currentItems,
                                        savedAt: new Date().toISOString()
                                    }));
                                } catch (e) {
                                    console.warn('Failed to save to localStorage:', e);
                                }
                            }, 500);
                        } else if (boardId > 0 && saveHook && saveHook.triggerSave) {
                            // Real board - trigger debounced save via hook
                            console.log('BoardCanvas: Triggering save for real board, boardId =', boardId);
                            saveHook.triggerSave();
                        }
                        // Note: For demo mode (boardId = 0), localStorage is handled above, no hook call needed
                    };
                    
                    if (!items || items.length === 0) {
                        return React.createElement('div', { style: { padding: '20px' } }, 'No items loaded. Items count: ' + (items ? items.length : 0));
                    }
                    
                    // Use relative positioning within the fixed canvas container
                    // Container handles horizontal scrolling, canvas expands to fit items
                    console.log('BoardCanvas rendering with', items ? items.length : 0, 'items');
                    if (!items || items.length === 0) {
                        console.warn('BoardCanvas: No items to render!');
                    }
                    return React.createElement(React.Fragment, null,
                        React.createElement('div', {
                            style: { 
                                position: 'relative', 
                                width: '100%', 
                                minHeight: '100%',
                                height: '100%',
                                overflow: 'visible', 
                                backgroundColor: '#f5f5f5',
                                padding: '20px',
                                zIndex: 1,
                                boxSizing: 'border-box',
                                display: 'block'
                            },
                        }, items && items.length > 0 ? items.map(function(item) {
                            console.log('Rendering item:', item.id, 'at position', item.x, item.y, 'size', item.width, 'x', item.height);
                            return React.createElement(BoardItemWrapper, { key: item.id, item: item, onLayoutChanged: handleLayoutChanged, boardId: testBoardId });
                        }) : React.createElement('div', { style: { padding: '20px', color: '#666', fontSize: '16px' } }, 'No items on board. Items count: ' + (items ? items.length : 0)), 
                        // Concierge Overlay - read-only, non-blocking
                        React.createElement(ConciergeOverlay, { concierge: conciergeData })),
                        // Welcome Modal - shown once per user
                        React.createElement(WelcomeModal, { userId: currentUserId }),
                        // UnsyncedToast removed - no longer showing "Changes not saved" notification
                        null
                    );
                };

                // Render
                const rootEl = document.getElementById('n88-board-demo-root');
                if (!rootEl) {
                    updateDebug('ERROR: Root element not found!');
                    return false;
                }

                try {
                    // Check if root already exists to avoid multiple createRoot calls
                    if (!window._n88BoardRoot) {
                        window._n88BoardRoot = ReactDOM.createRoot(rootEl);
                    }
                    
                    window._n88BoardRoot.render(React.createElement(BoardCanvas, {
                        boardId: testBoardId,
                        userId: currentUserId,
                        concierge: conciergeData,
                        onLayoutChanged: function(data) { 
                            console.log('Layout changed:', data);
                        },
                    }));
                    
                    updateDebug('Board rendered! Items: ' + initialItems.length + (testBoardId > 0 ? ' (Real board - persistence enabled)' : ' (Demo mode - localStorage)'));
                    
                    // Mark as initialized to prevent multiple calls
                    window._n88BoardInitialized = true;
                    
                    // If after item creation and still no items, check again after React renders
                    var urlParamsCheck = new URLSearchParams(window.location.search);
                    var isAfterItemCreationCheck = urlParamsCheck.get('item_added') === '1';
                    if (isAfterItemCreationCheck && initialItems.length === 0 && testBoardId > 0) {
                        // Wait for React to render, then check store
                        setTimeout(function() {
                            var storeItems = window.N88StudioOS.useBoardStore.getState().items;
                            console.log('After render check - Store items:', storeItems.length);
                            if (storeItems.length === 0) {
                                console.log('Still no items after render. Reloading page...');
                                var newUrl = window.location.pathname + '?page=n88-rfq-board-demo&board_id=' + testBoardId;
                                window.location.href = newUrl;
                            }
                        }, 3000);
                    }
                    
                    return true;
                } catch (e) {
                    updateDebug('ERROR: ' + e.message);
                    console.error('Board render error:', e);
                    return false;
                }
            }
            
            // Start initialization when DOM is ready
            startInitialization();
        })();
        </script>
        <?php
    }

    /**
     * Render Real Board Demo page - REWRITTEN
     * 
     * Shows a real board with real items from the database.
     * Items are fetched from wp_n88_board_items and merged with layout data.
     */
    public function render_real_board_demo() {
        if ( ! $this->check_plugin_access() ) {
            wp_die( __( 'You do not have permission to view this page.', 'n88-rfq' ) );
        }

        // Get board_id from URL parameter
        $board_id = isset( $_GET['board_id'] ) ? absint( $_GET['board_id'] ) : 0;

        if ( $board_id === 0 ) {
            ?>
            <div class="wrap">
                <h1>Real Board Demo</h1>
                <p><strong>Error:</strong> No board ID provided.</p>
                <p>Usage: <code>?page=n88-rfq-real-board-demo&board_id=123</code></p>
            </div>
            <?php
            return;
        }

        $user_id = get_current_user_id();

        // Verify board ownership
        $board = N88_Authorization::get_board_for_user( $board_id, $user_id );
        if ( ! $board ) {
            ?>
            <div class="wrap">
                <h1>Real Board Demo</h1>
                <p><strong>Error:</strong> Board not found or access denied.</p>
            </div>
            <?php
            return;
        }

        // Fetch board layout
        $layout_data = null;
        if ( ! empty( $board->latest_layout_json ) ) {
            $layout_data = json_decode( $board->latest_layout_json, true );
            if ( json_last_error() !== JSON_ERROR_NONE || ! is_array( $layout_data ) ) {
                $layout_data = null;
            }
        }

        // Fetch items from database
        global $wpdb;
        $board_items_table = $wpdb->prefix . 'n88_board_items';
        $items_table = $wpdb->prefix . 'n88_items';
        
        $board_items = $wpdb->get_results(
            $wpdb->prepare(
                "SELECT bi.item_id, i.id, i.title, i.description, i.item_type, i.status, i.primary_image_id
                 FROM {$board_items_table} bi
                 INNER JOIN {$items_table} i ON bi.item_id = i.id
                 WHERE bi.board_id = %d 
                 AND bi.removed_at IS NULL
                 AND i.deleted_at IS NULL
                 ORDER BY bi.added_at ASC",
                $board_id
            )
        );

        // Build items array
        $items = array();
        $layout_items_map = array();
        
        if ( $layout_data && isset( $layout_data['items'] ) && is_array( $layout_data['items'] ) ) {
            foreach ( $layout_data['items'] as $layout_item ) {
                $item_id_from_layout = str_replace( 'item-', '', $layout_item['id'] );
                $layout_items_map[ $item_id_from_layout ] = $layout_item;
            }
        }

        $CARD_SIZES = array(
            'S' => array( 'w' => 160, 'h' => 200 ),
            'D' => array( 'w' => 200, 'h' => 250 ),
            'L' => array( 'w' => 280, 'h' => 350 ),
            'XL' => array( 'w' => 360, 'h' => 450 ),
        );

        $z_index = 1;
        foreach ( $board_items as $board_item ) {
            $item_id = absint( $board_item->item_id );
            $item_id_string = 'item-' . $item_id;
            
            $image_url = '';
            if ( ! empty( $board_item->primary_image_id ) ) {
                $image_url = wp_get_attachment_image_url( $board_item->primary_image_id, 'full' );
                if ( ! $image_url ) {
                    $image_url = wp_get_attachment_url( $board_item->primary_image_id );
                }
            }
            $image_url = $image_url ? esc_url_raw( $image_url ) : '';
            
            $title = isset( $board_item->title ) ? wp_strip_all_tags( sanitize_text_field( $board_item->title ) ) : '';
            $description = isset( $board_item->description ) ? wp_strip_all_tags( sanitize_textarea_field( $board_item->description ) ) : '';
            
            if ( isset( $layout_items_map[ $item_id ] ) ) {
                $layout_item = $layout_items_map[ $item_id ];
                $items[] = array(
                    'id' => $item_id_string,
                    'x' => isset( $layout_item['x'] ) ? floatval( $layout_item['x'] ) : floatval( 50 + ( count( $items ) * 250 ) ),
                    'y' => isset( $layout_item['y'] ) ? floatval( $layout_item['y'] ) : 50.0,
                    'z' => isset( $layout_item['z'] ) ? intval( $layout_item['z'] ) : $z_index++,
                    'width' => isset( $layout_item['width'] ) ? floatval( $layout_item['width'] ) : floatval( $CARD_SIZES['D']['w'] ),
                    'height' => isset( $layout_item['height'] ) ? floatval( $layout_item['height'] ) : floatval( $CARD_SIZES['D']['h'] ),
                    'sizeKey' => isset( $layout_item['sizeKey'] ) && in_array( $layout_item['sizeKey'], array( 'S', 'D', 'L', 'XL' ), true ) ? $layout_item['sizeKey'] : 'D',
                    'displayMode' => isset( $layout_item['displayMode'] ) && in_array( $layout_item['displayMode'], array( 'photo_only', 'full' ), true ) ? $layout_item['displayMode'] : 'photo_only',
                    'title' => $title,
                    'description' => $description,
                    'imageUrl' => $image_url,
                );
            } else {
                $items[] = array(
                    'id' => $item_id_string,
                    'x' => floatval( 50 + ( count( $items ) * 250 ) ),
                    'y' => 50.0,
                    'z' => $z_index++,
                    'width' => floatval( $CARD_SIZES['D']['w'] ),
                    'height' => floatval( $CARD_SIZES['D']['h'] ),
                    'sizeKey' => 'D',
                    'displayMode' => 'photo_only',
                    'title' => $title,
                    'description' => $description,
                    'imageUrl' => $image_url,
                );
            }
        }

        // Enqueue dependencies
        wp_enqueue_script( 'react', 'https://unpkg.com/react@18/umd/react.production.min.js', array(), '18.2.0', false );
        wp_enqueue_script( 'react-dom', 'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js', array( 'react' ), '18.2.0', false );
        wp_enqueue_script( 'framer-motion', 'https://unpkg.com/framer-motion@10/dist/framer-motion.js', array( 'react', 'react-dom' ), '10.16.0', false );
        wp_enqueue_script( 'zustand', 'https://unpkg.com/zustand@3.7.2/umd/index.production.js', array( 'react' ), '3.7.2', true );

        $plugin_url = N88_RFQ_PLUGIN_URL;
        wp_enqueue_script( 'n88-board-store', $plugin_url . 'assets/js/stores/useBoardStore.js', array( 'zustand', 'react' ), N88_RFQ_VERSION . '?v=' . time(), true );
        wp_enqueue_script( 'n88-debounced-save', $plugin_url . 'assets/js/hooks/useDebouncedSave.js', array( 'n88-board-store', 'react' ), N88_RFQ_VERSION . '?v=' . time(), true );

        wp_localize_script( 'n88-debounced-save', 'n88BoardNonce', array(
            'nonce' => wp_create_nonce( 'n88-rfq-nonce' ), // Commit 2.3.9.1B: Fixed to match endpoint expectation
            'nonce_get_item_rfq_state' => wp_create_nonce( 'n88_get_item_rfq_state' ),
            'nonce_submit_rfq' => wp_create_nonce( 'n88_submit_rfq' ),
            'nonce_submit_supplier_bid' => wp_create_nonce( 'n88_submit_supplier_bid' ),
            'nonce_withdraw_supplier_bid' => wp_create_nonce( 'n88_withdraw_supplier_bid' ),
            'nonce_get_supplier_item_details' => wp_create_nonce( 'n88_get_supplier_item_details' ),
            'nonce_get_keywords' => wp_create_nonce( 'n88_get_keywords' ), // Commit 2.3.9.1B: For CAD prototype keyword selection
            // Commit 2.3.9.1C-a: Item Messages nonces
            'nonce_get_item_messages' => wp_create_nonce( 'n88_get_item_messages' ),
            'nonce_send_item_message' => wp_create_nonce( 'n88_send_item_message' ),
            // Commit 2.3.9.2A: CAD workflow nonces
            'nonce_request_cad_revision' => wp_create_nonce( 'n88_request_cad_revision' ),
            'nonce_approve_cad' => wp_create_nonce( 'n88_approve_cad' ),
            'nonce_upload_payment_receipt' => wp_create_nonce( 'n88_upload_payment_receipt' ),
            'nonce_get_payment_receipts' => wp_create_nonce( 'n88_get_payment_receipts' ),
        ) );
        ?>
        <div class="wrap">
            <h1>Real Board Demo - Board #<?php echo esc_html( $board_id ); ?></h1>
            <p><strong>Board Name:</strong> <?php echo esc_html( $board->name ); ?></p>
            <p><strong>Items on Board:</strong> <?php echo count( $items ); ?></p>
            <div id="n88-real-board-demo-root"></div>
            <div id="n88-real-board-demo-debug" style="position: fixed; bottom: 10px; right: 10px; background: #fff; padding: 10px; border: 1px solid #ccc; z-index: 9999; font-size: 12px; max-width: 300px;">
                <div>Loading...</div>
            </div>
        </div>
        <script>
        (function() {
            function updateDebug(msg) {
                const debugEl = document.getElementById('n88-real-board-demo-debug');
                if (debugEl) debugEl.innerHTML = '<div>' + msg + '</div>';
            }

            function initRealBoard() {
                if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') {
                    updateDebug('Waiting for React...');
                    return false;
                }
                
                var framerMotion = window.motion || window.framerMotion || window.Motion;
                if (!framerMotion) {
                    updateDebug('Waiting for Framer Motion...');
                    return false;
                }
                
                if (typeof window.N88StudioOS === 'undefined' || typeof window.N88StudioOS.useBoardStore === 'undefined') {
                    updateDebug('Waiting for useBoardStore...');
                    return false;
                }
                
                if (typeof window.N88StudioOS.useDebouncedSave === 'undefined') {
                    updateDebug('Waiting for useDebouncedSave...');
                    return false;
                }

                updateDebug('All dependencies loaded!');

                const React = window.React;
                const ReactDOM = window.ReactDOM;
                
                var motion = framerMotion.motion || framerMotion;
                var AnimatePresence = framerMotion.AnimatePresence || window.AnimatePresence;
                var useMotionValue = framerMotion.useMotionValue || window.useMotionValue;
                
                if (!motion || !AnimatePresence || !useMotionValue) {
                    updateDebug('ERROR: Missing Framer Motion components');
                    return false;
                }
                
                const useBoardStore = window.N88StudioOS.useBoardStore;
                const useDebouncedSave = window.N88StudioOS.useDebouncedSave;

                const realItems = <?php echo wp_json_encode( $items ); ?>;
                const realBoardId = <?php echo absint( $board_id ); ?>;
                const currentUserId = <?php echo absint( $user_id ); ?>;
                
                window.currentUserId = currentUserId;
                if (window.N88StudioOS) {
                    window.N88StudioOS.currentUserId = currentUserId;
                }
                
                const conciergeData = {
                    name: 'Message System Operator',
                    avatarUrl: ''
                };

                useBoardStore.getState().setItems(realItems);
                updateDebug('Store initialized with ' + realItems.length + ' items');

                const CARD_SIZES = {
                    S: { w: 160, h: 200 },
                    D: { w: 200, h: 250 },
                    L: { w: 280, h: 350 },
                    XL: { w: 360, h: 450 },
                };

                // Copy BoardItem component from working board demo - ensure exact match
                // [BoardItem component code will be inserted here - using exact same as board demo]

                // Copy other components from working board demo
                // [Other components will be inserted here]

                // BoardCanvas - fixed concierge prop reference
                const BoardCanvas = function(props) {
                    var boardId = props.boardId;
                    var onLayoutChanged = props.onLayoutChanged;
                    var userId = props.userId;
                    var concierge = props.concierge;
                    var items = useBoardStore(function(state) { return state.items; });
                    
                    var getItems = React.useCallback(function() {
                        return window.N88StudioOS.useBoardStore.getState().items;
                    }, []);
                    
                    // useDebouncedSave is guaranteed to exist at this point (checked in initRealBoard)
                    var saveHook = useDebouncedSave(boardId || 0, getItems);
                    var unsynced = saveHook.unsynced;
                    var triggerSave = saveHook.triggerSave;
                    var clearUnsynced = saveHook.clearUnsynced;
                    
                    var handleLayoutChanged = React.useCallback(function(data) {
                        if (onLayoutChanged) onLayoutChanged(data);
                        if (boardId && boardId > 0 && triggerSave) {
                            triggerSave();
                        }
                    }, [boardId, triggerSave, onLayoutChanged]);
                    
                    return React.createElement(React.Fragment, null,
                        React.createElement('div', {
                            style: { 
                                position: 'relative', 
                                width: '100%', 
                                minHeight: '100%',
                                height: '100%',
                                overflow: 'visible', 
                                backgroundColor: '#f5f5f5',
                                padding: '20px',
                                zIndex: 1
                            }
                        }, items && items.length > 0 ? (items || []).map(function(item) {
                            return React.createElement(BoardItemWrapper, { key: item.id, item: item, onLayoutChanged: handleLayoutChanged, boardId: testBoardId });
                        }) : React.createElement('div', { style: { padding: '20px', color: '#666' } }, 'No items on board'), 
                        React.createElement(ConciergeOverlay, { concierge: concierge })
                        ),
                        React.createElement(WelcomeModal, { userId: currentUserId }),
                        // UnsyncedToast removed - no longer showing "Changes not saved" notification
                        null
                    );
                };

                try {
                    const rootEl = document.getElementById('n88-real-board-demo-root');
                    if (!rootEl) {
                        updateDebug('ERROR: Root element not found!');
                        return false;
                    }
                    
                    // Check if root already exists to avoid multiple createRoot calls
                    if (!window._n88RealBoardRoot) {
                        window._n88RealBoardRoot = ReactDOM.createRoot(rootEl);
                    }
                    
                    window._n88RealBoardRoot.render(React.createElement(BoardCanvas, {
                        boardId: realBoardId,
                        userId: currentUserId,
                        concierge: conciergeData,
                        onLayoutChanged: function(data) {
                            console.log('Layout changed:', data);
                        }
                    }));

                    updateDebug('Board rendered! Items: ' + realItems.length);
                    return true;
                } catch (e) {
                    updateDebug('ERROR: ' + e.message);
                    console.error('Board render error:', e);
                    return false;
                }
            }

            var checkCount = 0;
            var maxChecks = 50;
            var checkInterval = setInterval(function() {
                checkCount++;
                if (initRealBoard()) {
                    clearInterval(checkInterval);
                    setTimeout(function() {
                        var debugEl = document.getElementById('n88-real-board-demo-debug');
                        if (debugEl) debugEl.style.display = 'none';
                    }, 3000);
                } else if (checkCount >= maxChecks) {
                    clearInterval(checkInterval);
                    updateDebug('ERROR: Timeout waiting for dependencies');
                }
            }, 100);
        })();

        // Commit 2.3.4: RFQ Submission Modal - Ensure function is defined here too
        // Define the function GLOBALLY if not already defined
        if (typeof window.openRfqSubmissionModal === 'undefined') {
            window.openRfqSubmissionModal = function(itemIds) {
                console.log('openRfqSubmissionModal called (from real board script) with items:', itemIds);
                if (!Array.isArray(itemIds) || itemIds.length === 0) {
                    alert('No items selected.');
                    return;
                }
                
                // Ensure modal HTML exists
                var modal = document.getElementById('n88-rfq-submission-modal');
                var modalContent = document.getElementById('n88-rfq-submission-modal-content');
                
                if (!modal || !modalContent) {
                    // Initialize modal HTML if not exists
                    var modalHTML = '<div id="n88-rfq-submission-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 20000; overflow-y: auto;"><div id="n88-rfq-submission-modal-content" style="position: relative; max-width: 600px; margin: 50px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh;"></div></div>';
                    if (document.body) {
                        document.body.insertAdjacentHTML('beforeend', modalHTML);
                        modal = document.getElementById('n88-rfq-submission-modal');
                        modalContent = document.getElementById('n88-rfq-submission-modal-content');
                    } else {
                        setTimeout(function() { window.openRfqSubmissionModal(itemIds); }, 100);
                        return;
                    }
                }
                
                if (!modal || !modalContent) {
                    console.error('RFQ modal elements not found');
                    return;
                }
                
                // Use the full implementation if available
                if (window._openRfqSubmissionModalFull) {
                    window._openRfqSubmissionModalFull(itemIds, modal, modalContent);
                    return;
                }
                
                alert('RFQ submission modal is not properly initialized. Please refresh the page.');
            };
        }
        
        (function() {
            // Create modal HTML immediately (will be added to DOM when ready)
            var modalHTML = '<div id="n88-rfq-submission-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 20000; overflow-y: auto;">' +
                '<div id="n88-rfq-submission-modal-content" style="position: relative; max-width: 600px; margin: 50px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh;">' +
                '</div>' +
                '</div>';
            
            // Initialize modal HTML when DOM is ready
            function initRfqModalHTML() {
                if (!document.getElementById('n88-rfq-submission-modal')) {
                    if (document.body) {
                        document.body.insertAdjacentHTML('beforeend', modalHTML);
                    } else {
                        // If body not ready, wait a bit and try again
                        setTimeout(initRfqModalHTML, 100);
                    }
                }
            }

            // Initialize immediately if DOM is ready, otherwise wait
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initRfqModalHTML);
            } else {
                initRfqModalHTML();
            }

            // Full implementation of RFQ submission modal (called by the global function defined earlier)
            window._openRfqSubmissionModalFull = function(itemIds, modal, modalContent) {
                if (!modal || !modalContent) {
                    modal = document.getElementById('n88-rfq-submission-modal');
                    modalContent = document.getElementById('n88-rfq-submission-modal-content');
                    if (!modal || !modalContent) return;
                }

                // Show loading message first
                var loadingHTML = '<div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background-color: #fff;">' +
                    '<h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #333;">Request Quote' + (itemIds.length > 1 ? 's' : '') + '</h2>' +
                    '<button onclick="closeRfqSubmissionModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #666; line-height: 1;">×</button>' +
                    '</div>' +
                    '<div style="flex: 1; overflow-y: auto; padding: 60px 20px; background-color: #fff; text-align: center;">' +
                    '<div style="font-size: 16px; color: #666;">Loading...</div>' +
                    '</div>';

                modalContent.innerHTML = loadingHTML;
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';

                // Build full form HTML
                var formHTML = '<div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background-color: #fff;">' +
                    '<h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #333;">Request Quote' + (itemIds.length > 1 ? 's' : '') + '</h2>' +
                    '<button onclick="closeRfqSubmissionModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #666; line-height: 1;">×</button>' +
                    '</div>' +
                    '<div style="flex: 1; overflow-y: auto; padding: 20px; background-color: #fff;">' +
                    '<form id="n88-rfq-submission-form" onsubmit="return submitRfqForm(event);">' +
                    '<input type="hidden" name="item_ids" value=\'' + JSON.stringify(itemIds) + '\' />' +
                    
                    // Items section (one form per item, or combined if same delivery)
                    '<div id="n88-rfq-items-container"></div>' +
                    
                    // Invite Supplier section
                    '<div style="margin-top: 0px; padding-top: 0px; border-top: 0px solid #e0e0e0;">' +
                    '<h3 style="margin: 0px 0px 12px 0px; font-size: 16px; font-weight: 600; color: #333;">Invite Makers</h3>' +
                    '<p style="margin: 0 0 12px 0; font-size: 13px; color: #666;">Enter existing maker username(s) or email address(es). Press Enter or click Add to create a chip. (1-5 invites)</p>' +
                    '<div style="display: flex; gap: 8px; margin-bottom: 12px;">' +
                    '<input type="text" id="n88-invite-supplier-input" placeholder="Username or email" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" onkeypress="if(event.key===\'Enter\'){event.preventDefault();addInvitedSupplierChip();}" />' +
                    '<button type="button" onclick="addInvitedSupplierChip()" style="padding: 10px 20px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; white-space: nowrap;">Add</button>' +
                    '</div>' +
                    '<div id="n88-invited-suppliers-chips" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; min-height: 32px;"></div>' +
                    '<input type="hidden" id="n88-invited-suppliers-json" name="invited_suppliers" value="[]" />' +
                    '<div id="n88-invite-supplier-error" style="font-size: 12px; color: #d32f2f; margin-top: 4px; display: none;"></div>' +
                    '</div>' +
                    
                    // System Invites toggle
                    '<div style="margin-top: 24px;">' +
                    '<label style="display: flex; align-items: center; cursor: pointer;">' +
                    '<input type="checkbox" id="n88-allow-system-invites" name="allow_system_invites" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;" onchange="updateSystemInvitesMessage()" />' +
                    '<span style="font-size: 14px; font-weight: 500; color: #333;">Let WireFrame (OS) source makers for this request</span>' +
                    '</label>' +
                    '<div style="margin-top: 8px; font-size: 13px; color: #666; padding-left: 26px;">If enabled, Wireframe (OS) will find qualified makers based on your item and keywords.</div>' +
                    '<div id="n88-system-invites-message" style="margin-top: 8px; font-size: 13px; color: #666; padding-left: 26px; display: none;"></div>' +
                    '</div>' +
                    
                    // Submit button
                    '<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">' +
                    '<button type="submit" id="n88-submit-rfq-btn" style="width: 100%; padding: 12px 24px; background-color: #0073aa; color: #fff; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">Submit RFQ</button>' +
                    '<div id="n88-rfq-errors" style="margin-top: 12px; color: #d32f2f; font-size: 13px; display: none;"></div>' +
                    '</div>' +
                    '</form>' +
                    '</div>';

                // Load items first, then show form once all items are ready
                var itemsLoaded = 0;
                var totalItems = itemIds.length;
                var loadedItems = [];
                
                if (totalItems === 0) {
                    modalContent.innerHTML = '<div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background-color: #fff;">' +
                        '<h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #333;">Request Quote</h2>' +
                        '<button onclick="closeRfqSubmissionModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #666; line-height: 1;">×</button>' +
                        '</div>' +
                        '<div style="flex: 1; overflow-y: auto; padding: 60px 20px; background-color: #fff; text-align: center;">' +
                        '<div style="font-size: 16px; color: #d32f2f;">No items selected.</div>' +
                        '</div>';
                    return;
                }
                
                // Function to show form once all items are loaded
                function showFormWithItems() {
                    modalContent.innerHTML = formHTML;
                    
                    // Insert loaded items into container
                    var container = document.getElementById('n88-rfq-items-container');
                    if (container) {
                        container.innerHTML = '';
                        loadedItems.forEach(function(itemHTML) {
                            container.insertAdjacentHTML('beforeend', itemHTML);
                        });
                        
                        // Add delivery country change listeners
                        var countrySelects = container.querySelectorAll('select[name="delivery_country[]"]');
                        countrySelects.forEach(function(select) {
                            select.addEventListener('change', function() {
                                var itemForm = select.closest('.n88-rfq-item-form');
                                var itemId = itemForm ? itemForm.getAttribute('data-item-id') : '';
                                var country = select.value.toUpperCase();
                                var postalInput = itemForm ? itemForm.querySelector('input[name="delivery_postal[]"]') : null;
                                var noteDiv = document.getElementById('n88-delivery-note-' + itemId);
                                if (country === 'USA' || country === 'CAN') {
                                    if (postalInput) postalInput.required = true;
                                    if (noteDiv) {
                                        noteDiv.style.display = 'block';
                                        noteDiv.textContent = 'ZIP/postal code is required for US and Canada.';
                                    }
                                } else {
                                    if (postalInput) postalInput.required = false;
                                    if (noteDiv && country.length > 0) {
                                        noteDiv.style.display = 'block';
                                        noteDiv.textContent = 'We are not able to calculate an instant shipping estimate for this delivery location yet, but our team can get back to you with a shipping range within 24 hours.';
                                    } else if (noteDiv) {
                                        noteDiv.style.display = 'none';
                                    }
                                }
                            });
                        });
                    }
                    
                    // Update system invites message
                    if (window.updateSystemInvitesMessage) {
                        setTimeout(function() { window.updateSystemInvitesMessage(); }, 100);
                    }
                }
                
                // Load all items first
                itemIds.forEach(function(itemId, index) {
                    // Fetch item details to get images
                    var formData = new FormData();
                    formData.append('action', 'n88_get_supplier_item_details');
                    formData.append('item_id', itemId);
                    formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_get_supplier_item_details' ); ?>');
                    
                    fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        var item = data.success ? data.data : null;
                        
                        // Get primary image URL
                        var primaryImageUrl = item ? (item.primary_image_url || item.image_url || '') : '';
                        
                        // Get inspiration images
                        var inspirationImages = item ? (item.inspiration_images || item.reference_images || []) : [];
                        
                        // Filter and prepare valid reference images
                        var validReferenceImages = [];
                        if (inspirationImages && inspirationImages.length > 0) {
                            inspirationImages.forEach(function(img) {
                                var imgUrl = '';
                                var fullUrl = '';
                                
                                if (typeof img === 'string') {
                                    imgUrl = img;
                                    fullUrl = img;
                                } else if (typeof img === 'object') {
                                    imgUrl = img.url || img.thumbnail || img.thumb_url || '';
                                    fullUrl = img.full_url || img.url || img.thumbnail || img.thumb_url || '';
                                }
                                
                                if (imgUrl && imgUrl.trim() !== '' && (imgUrl.startsWith('http://') || imgUrl.startsWith('https://'))) {
                                    validReferenceImages.push({
                                        url: imgUrl,
                                        fullUrl: fullUrl || imgUrl
                                    });
                                }
                            });
                        }
                        
                        // Build image gallery layout: left reference images, center main image, right reference images
                        // Always show the gallery box
                        var imageGalleryHTML = '';
                        
                        // Split reference images into left and right
                        var leftImages = [];
                        var rightImages = [];
                        validReferenceImages.forEach(function(img, index) {
                            if (index % 2 === 0) {
                                leftImages.push(img);
                            } else {
                                rightImages.push(img);
                            }
                        });
                        
                        // Build left column (reference images)
                        var leftColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                        if (leftImages.length > 0) {
                            leftImages.forEach(function(img, idx) {
                                var imgId = 'n88-rfq-ref-left-' + itemId + '-' + idx;
                                leftColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                                    '<img id="' + imgId + '" ' +
                                    'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                                    'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                                    'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                                    'style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s; background-color: #000;" ' +
                                    'onmouseover="this.style.borderColor=\'#0073aa\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,115,170,0.3)\';" ' +
                                    'onmouseout="this.style.borderColor=\'#ddd\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                    'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\');if(url&&url.trim()){try{window.open(url,\'_blank\',\'noopener,noreferrer\');}catch(err){console.error(\'Error opening image:\',err);}}else{console.error(\'No URL found for image\');}})(this);" ' +
                                    'title="Click to view full size" ' +
                                    'alt="Reference photo" />' +
                                    '</div>';
                            });
                        }
                        leftColumnHTML += '</div>';
                        
                        // Build center column (main image)
                        var centerColumnHTML = '<div style="flex: 1; display: flex; align-items: center; justify-content: center; min-height: 300px; padding: 0 20px; max-width: 500px;">';
                        if (primaryImageUrl) {
                            centerColumnHTML += '<img src="' + primaryImageUrl.replace(/"/g, '&quot;') + '" ' +
                                'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23f0f0f0\' width=\'400\' height=\'300\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'14\'%3EItem Image%3C/text%3E%3C/svg%3E\';" ' +
                                'style="max-width: 100%; max-height: 350px; width: auto; height: auto; border-radius: 4px; border: 1px solid #e0e0e0; object-fit: contain; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" ' +
                                'alt="Item main image" />';
                        } else {
                            centerColumnHTML += '<div style="width: 100%; height: 300px; background-color: #f0f0f0; border-radius: 4px; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999;">No main image available</div>';
                        }
                        centerColumnHTML += '</div>';
                        
                        // Build right column (reference images)
                        var rightColumnHTML = '<div style="display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; min-width: 120px;">';
                        if (rightImages.length > 0) {
                            rightImages.forEach(function(img, idx) {
                                var imgId = 'n88-rfq-ref-right-' + itemId + '-' + idx;
                                rightColumnHTML += '<div style="position: relative; width: 100px; height: 100px;">' +
                                    '<img id="' + imgId + '" ' +
                                    'src="' + img.url.replace(/"/g, '&quot;') + '" ' +
                                    'data-full-url="' + img.fullUrl.replace(/"/g, '&quot;') + '" ' +
                                    'onerror="this.onerror=null; this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23000\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23fff\' font-size=\'12\'%3Ereference photo%3C/text%3E%3C/svg%3E\';" ' +
                                    'style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s; background-color: #000;" ' +
                                    'onmouseover="this.style.borderColor=\'#0073aa\'; this.style.transform=\'scale(1.05)\'; this.style.boxShadow=\'0 2px 8px rgba(0,115,170,0.3)\';" ' +
                                    'onmouseout="this.style.borderColor=\'#ddd\'; this.style.transform=\'scale(1)\'; this.style.boxShadow=\'none\';" ' +
                                    'onclick="(function(elem){var url=elem.getAttribute(\'data-full-url\');if(url&&url.trim()){try{window.open(url,\'_blank\',\'noopener,noreferrer\');}catch(err){console.error(\'Error opening image:\',err);}}else{console.error(\'No URL found for image\');}})(this);" ' +
                                    'title="Click to view full size" ' +
                                    'alt="Reference photo" />' +
                                    '</div>';
                            });
                        }
                        rightColumnHTML += '</div>';
                        
                        // Always combine into gallery layout (box always visible)
                        imageGalleryHTML = '<div style="margin-bottom: 24px; display: flex; gap: 16px; align-items: flex-start; justify-content: center; padding: 16px; background-color: #fafafa; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                            leftColumnHTML +
                            centerColumnHTML +
                            rightColumnHTML +
                            '</div>';
                        
                        var itemHTML = '<div class="n88-rfq-item-form" data-item-id="' + itemId + '" style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e0e0e0;">' +
                            '<h4 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #333;">Item #' + itemId + '</h4>' +
                            
                            // Image gallery: left reference images, center main image, right reference images
                            imageGalleryHTML +
                            
                        // Quantity
                        '<div style="margin-bottom: 16px;">' +
                        '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Quantity <span style="color: #d32f2f;">*</span></label>' +
                        '<input type="number" name="quantity[]" min="1" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />' +
                        '</div>' +
                        
                        // Dimensions
                                '<div style="margin-bottom: 16px;">' +
                                '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Dimensions <span style="color: #d32f2f;">*</span></label>' +
                                '<div style="display: flex; gap: 8px; align-items: center; max-width: 50%;">' +
                                '<input type="number" name="width[]" step="0.01" min="0.01" placeholder="Width" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" />' +
                                '<input type="number" name="depth[]" step="0.01" min="0.01" placeholder="Depth" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" />' +
                                '<input type="number" name="height[]" step="0.01" min="0.01" placeholder="Height" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" />' +
                                '<select name="dimension_unit[]" required style="flex: 0 0 80px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">' +
                                '<option value="in">Inches</option>' +
                                '<option value="cm">Centimeters</option>' +
                                '</select>' +
                                '</div>' +
                                '</div>' +
                        
                        // Delivery
                        '<div style="margin-bottom: 16px;">' +
                        '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Delivery Country <span style="color: #d32f2f;">*</span></label>' +
                        '<select name="delivery_country[]" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">' +
                        '<option value="">Select Country</option>' +
                        '<option value="USA">USA</option>' +
                        '<option value="CAN">CAN</option>' +
                        '<option value="CHINA">CHINA</option>' +
                        '<option value="VIETNAM">VIETNAM</option>' +
                        '<option value="EUROPE">EUROPE</option>' +
                        '<option value="AFRICA">AFRICA</option>' +
                        '</select>' +
                        '</div>' +
                        
                        '<div style="margin-bottom: 16px;">' +
                        '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">ZIP/Postal Code</label>' +
                        '<input type="text" name="delivery_postal[]" placeholder="Required for USA/CAN" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />' +
                        '<div id="n88-delivery-note-' + itemId + '" style="margin-top: 8px; font-size: 12px; color: #666; display: none;"></div>' +
                        '</div>' +
                        '</div>';
                        
                        container.insertAdjacentHTML('beforeend', itemHTML);
                    })
                    .catch(function(error) {
                        console.error('Error fetching item details for item ' + itemId + ':', error);
                        // Still create the form without images
                        var itemHTML = '<div class="n88-rfq-item-form" data-item-id="' + itemId + '" style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e0e0e0;">' +
                            '<h4 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #333;">Item #' + itemId + '</h4>' +
                            
                            // Quantity
                            '<div style="margin-bottom: 16px;">' +
                            '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Quantity <span style="color: #d32f2f;">*</span></label>' +
                            '<input type="number" name="quantity[]" min="1" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />' +
                            '</div>' +
                            
                            // Dimensions
                            '<div style="margin-bottom: 16px;">' +
                            '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Dimensions <span style="color: #d32f2f;">*</span></label>' +
                            '<div style="display: flex; gap: 8px; align-items: center; max-width: 50%;">' +
                            '<input type="number" name="width[]" step="0.01" min="0.01" placeholder="Width" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" />' +
                            '<input type="number" name="depth[]" step="0.01" min="0.01" placeholder="Depth" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" />' +
                            '<input type="number" name="height[]" step="0.01" min="0.01" placeholder="Height" required style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" />' +
                            '<select name="dimension_unit[]" required style="flex: 0 0 80px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">' +
                            '<option value="in">Inches</option>' +
                            '<option value="cm">Centimeters</option>' +
                            '</select>' +
                            '</div>' +
                            '</div>' +
                            
                            // Delivery
                            '<div style="margin-bottom: 16px;">' +
                            '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">Delivery Country <span style="color: #d32f2f;">*</span></label>' +
                            '<select name="delivery_country[]" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">' +
                            '<option value="">Select Country</option>' +
                            '<option value="USA">USA</option>' +
                            '<option value="CAN">CAN</option>' +
                            '<option value="CHINA">CHINA</option>' +
                            '<option value="VIETNAM">VIETNAM</option>' +
                            '<option value="EUROPE">EUROPE</option>' +
                            '<option value="AFRICA">AFRICA</option>' +
                            '</select>' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 16px;">' +
                            '<label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333;">ZIP/Postal Code</label>' +
                            '<input type="text" name="delivery_postal[]" placeholder="Required for USA/CAN" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />' +
                            '<div id="n88-delivery-note-' + itemId + '" style="margin-top: 8px; font-size: 12px; color: #666; display: none;"></div>' +
                            '</div>' +
                            '</div>';
                        
                        container.insertAdjacentHTML('beforeend', itemHTML);
                    });
                });

                // Add delivery country change listeners
                var countrySelects = container.querySelectorAll('select[name="delivery_country[]"]');
                countrySelects.forEach(function(select) {
                    select.addEventListener('change', function() {
                        var itemForm = select.closest('.n88-rfq-item-form');
                        var itemId = itemForm ? itemForm.getAttribute('data-item-id') : '';
                        var country = select.value.toUpperCase();
                        var postalInput = itemForm ? itemForm.querySelector('input[name="delivery_postal[]"]') : null;
                        var noteDiv = document.getElementById('n88-delivery-note-' + itemId);

                        if (country === 'USA' || country === 'CAN') {
                            if (postalInput) postalInput.required = true;
                            if (noteDiv) {
                                noteDiv.style.display = 'block';
                                noteDiv.textContent = 'ZIP/postal code is required for USA and Canada.';
                            }
                        } else {
                            if (postalInput) postalInput.required = false;
                            if (noteDiv && country.length > 0) {
                                noteDiv.style.display = 'block';
                                noteDiv.textContent = "We're not able to calculate an instant shipping estimate for this delivery location yet, but our team can get back to you with a shipping range within 24 hours.";
                            } else if (noteDiv) {
                                noteDiv.style.display = 'none';
                            }
                        }
                    });
                });
            }

            // Update system invites message
            window.updateSystemInvitesMessage = function() {
                var checkbox = document.getElementById('n88-allow-system-invites');
                var messageDiv = document.getElementById('n88-system-invites-message');
                var inviteInput = document.getElementById('n88-invite-supplier');

                if (!checkbox || !messageDiv) return;

                if (checkbox.checked) {
                    messageDiv.style.display = 'block';
                    if (inviteInput && inviteInput.value.trim()) {
                        messageDiv.textContent = '';
                    } else {
                        messageDiv.textContent = 'We will send your request on your behalf.';
                    }
                } else {
                    messageDiv.style.display = 'none';
                }
            };

            // Close modal
            window.closeRfqSubmissionModal = function() {
                var modal = document.getElementById('n88-rfq-submission-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            };

            // Submit form
            window.submitRfqForm = function(e) {
                e.preventDefault();

                var form = document.getElementById('n88-rfq-submission-form');
                var submitBtn = document.getElementById('n88-submit-rfq-btn');
                var errorsDiv = document.getElementById('n88-rfq-errors');
                var itemIdsJson = form.querySelector('input[name="item_ids"]').value;
                var itemIds = JSON.parse(itemIdsJson);

                if (!form || !submitBtn) return false;

                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                errorsDiv.style.display = 'none';

                // Collect form data
                var items = [];
                var itemForms = form.querySelectorAll('.n88-rfq-item-form');
                itemForms.forEach(function(itemForm, index) {
                    var itemId = parseInt(itemForm.getAttribute('data-item-id'));
                    var quantity = parseInt(itemForm.querySelector('input[name="quantity[]"]').value);
                    var width = parseFloat(itemForm.querySelector('input[name="width[]"]').value);
                    var depth = parseFloat(itemForm.querySelector('input[name="depth[]"]').value);
                    var height = parseFloat(itemForm.querySelector('input[name="height[]"]').value);
                    var dimensionUnit = itemForm.querySelector('select[name="dimension_unit[]"]').value;
                    var deliveryCountrySelect = itemForm.querySelector('select[name="delivery_country[]"]');
                    var deliveryCountry = deliveryCountrySelect ? deliveryCountrySelect.value.toUpperCase().trim() : '';
                    var deliveryPostal = itemForm.querySelector('input[name="delivery_postal[]"]').value.trim();

                    items.push({
                        item_id: itemId,
                        quantity: quantity,
                        width: width,
                        depth: depth,
                        height: height,
                        dimension_unit: dimensionUnit,
                        delivery_country: deliveryCountry,
                        delivery_postal: deliveryPostal,
                    });
                });

                var inviteSupplier = document.getElementById('n88-invite-supplier').value.trim();
                var allowSystemInvites = document.getElementById('n88-allow-system-invites').checked;

                // Validate: Scenario B
                if (!inviteSupplier && !allowSystemInvites) {
                    errorsDiv.style.display = 'block';
                    errorsDiv.textContent = 'Please invite a maker or allow the system to invite makers.';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit RFQ';
                    return false;
                }

                // Submit via AJAX
                var formData = new FormData();
                formData.append('action', 'n88_submit_rfq');
                formData.append('items', JSON.stringify(items));
                formData.append('invite_supplier', inviteSupplier);
                formData.append('allow_system_invites', allowSystemInvites ? '1' : '0');
                formData.append('_ajax_nonce', '<?php echo wp_create_nonce( 'n88_submit_rfq' ); ?>');

                fetch('<?php echo esc_url( admin_url( 'admin-ajax.php' ) ); ?>', {
                    method: 'POST',
                    body: formData
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.success) {
                        alert(data.data.message || 'RFQ submitted successfully!');
                        closeRfqSubmissionModal();
                        // Optionally reload page or refresh queue
                        if (window.location.href.indexOf('admin.php') > -1) {
                            window.location.reload();
                        }
                    } else {
                        errorsDiv.style.display = 'block';
                        if (data.data && data.data.errors) {
                            var errorMessages = [];
                            for (var key in data.data.errors) {
                                errorMessages.push(data.data.errors[key]);
                            }
                            errorsDiv.textContent = errorMessages.join(' ');
                        } else {
                            errorsDiv.textContent = data.data && data.data.message ? data.data.message : 'An error occurred. Please try again.';
                        }
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit RFQ';
                    }
                })
                .catch(function(error) {
                    errorsDiv.style.display = 'block';
                    errorsDiv.textContent = 'Network error. Please try again.';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit RFQ';
                });

                return false;
            };

            // Close modal on backdrop click
            document.addEventListener('click', function(e) {
                var modal = document.getElementById('n88-rfq-submission-modal');
                if (modal && e.target === modal) {
                    closeRfqSubmissionModal();
                }
            });
        })();
        </script>
        <?php
    }


}

// .....